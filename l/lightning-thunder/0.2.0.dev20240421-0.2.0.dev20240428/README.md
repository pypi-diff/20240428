# Comparing `tmp/lightning_thunder-0.2.0.dev20240421.tar.gz` & `tmp/lightning_thunder-0.2.0.dev20240428.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "lightning_thunder-0.2.0.dev20240421.tar", last modified: Sun Apr 21 00:20:24 2024, max compression
+gzip compressed data, was "lightning_thunder-0.2.0.dev20240428.tar", last modified: Sun Apr 28 00:20:49 2024, max compression
```

## Comparing `lightning_thunder-0.2.0.dev20240421.tar` & `lightning_thunder-0.2.0.dev20240428.tar`

### file list

```diff
@@ -1,101 +1,101 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.926218 lightning_thunder-0.2.0.dev20240421/
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      760 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12606 2024-04-21 00:20:24.926218 lightning_thunder-0.2.0.dev20240421/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9728 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.922218 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    12606 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2438 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/not-zip-safe
--rw-r--r--   0 runner    (1001) docker     (127)      524 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        8 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.906218 lightning_thunder-0.2.0.dev20240421/requirements/
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/requirements/base.txt
--rw-r--r--   0 runner    (1001) docker     (127)       12 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/requirements/devel.txt
--rw-r--r--   0 runner    (1001) docker     (127)      485 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/requirements/docs.txt
--rw-r--r--   0 runner    (1001) docker     (127)      130 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/requirements/notebooks.txt
--rw-r--r--   0 runner    (1001) docker     (127)      864 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/requirements/test.txt
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-21 00:20:24.926218 lightning_thunder-0.2.0.dev20240421/setup.cfg
--rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.910218 lightning_thunder-0.2.0.dev20240421/thunder/
--rw-r--r--   0 runner    (1001) docker     (127)      436 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/thunder/__about__.py
--rw-r--r--   0 runner    (1001) docker     (127)    35664 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.910218 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/
--rw-r--r--   0 runner    (1001) docker     (127)   102957 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20786 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/benchmark_litgpt.py
--rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/distributed.py
--rw-r--r--   0 runner    (1001) docker     (127)     3726 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/einsum.py
--rw-r--r--   0 runner    (1001) docker     (127)    27205 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/targets.py
--rw-r--r--   0 runner    (1001) docker     (127)    11181 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/test_benchmark_litgpt.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.910218 lightning_thunder-0.2.0.dev20240421/thunder/clang/
--rw-r--r--   0 runner    (1001) docker     (127)    63815 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/clang/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/clang/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)    30802 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.914218 lightning_thunder-0.2.0.dev20240421/thunder/core/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    14981 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/baseutils.py
--rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/codeutils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/compile_data.py
--rw-r--r--   0 runner    (1001) docker     (127)     5921 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/devices.py
--rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/dtypes.py
--rw-r--r--   0 runner    (1001) docker     (127)   255602 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/interpreter.py
--rw-r--r--   0 runner    (1001) docker     (127)    54226 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/jit_ext.py
--rw-r--r--   0 runner    (1001) docker     (127)     4146 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/langctxs.py
--rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/options.py
--rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/patterns.py
--rw-r--r--   0 runner    (1001) docker     (127)   115363 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/prims.py
--rw-r--r--   0 runner    (1001) docker     (127)      629 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/profile.py
--rw-r--r--   0 runner    (1001) docker     (127)    48867 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/proxies.py
--rw-r--r--   0 runner    (1001) docker     (127)      731 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/pytree.py
--rw-r--r--   0 runner    (1001) docker     (127)    28170 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/rematerialization.py
--rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/symbol.py
--rw-r--r--   0 runner    (1001) docker     (127)    19863 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/trace.py
--rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/transform_common.py
--rw-r--r--   0 runner    (1001) docker     (127)   139748 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/transforms.py
--rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     7663 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/vjp_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.914218 lightning_thunder-0.2.0.dev20240421/thunder/cudagraphs/
--rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/cudagraphs/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.914218 lightning_thunder-0.2.0.dev20240421/thunder/distributed/
--rw-r--r--   0 runner    (1001) docker     (127)    17879 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/bucketing.py
--rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/checkpoint.py
--rw-r--r--   0 runner    (1001) docker     (127)    10906 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/prims.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.918218 lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/
--rw-r--r--   0 runner    (1001) docker     (127)      310 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8449 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/ddp.py
--rw-r--r--   0 runner    (1001) docker     (127)    28416 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/fsdp.py
--rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.918218 lightning_thunder-0.2.0.dev20240421/thunder/examine/
--rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/examine/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/examine/memory_caculation.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.922218 lightning_thunder-0.2.0.dev20240421/thunder/executors/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/apex_entropyex.py
--rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/cudnn_layernormex.py
--rw-r--r--   0 runner    (1001) docker     (127)    24903 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/cudnnex.py
--rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/data_dependent_partition.py
--rw-r--r--   0 runner    (1001) docker     (127)     1085 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/nvfuserex.py
--rw-r--r--   0 runner    (1001) docker     (127)    74208 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/nvfuserex_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/passes.py
--rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/pythonex.py
--rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/sdpaex.py
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/torch_autograd.py
--rw-r--r--   0 runner    (1001) docker     (127)     7872 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/torch_compile.py
--rw-r--r--   0 runner    (1001) docker     (127)    81988 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/torchex.py
--rw-r--r--   0 runner    (1001) docker     (127)    23242 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/transformer_engineex.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/triton_crossentropy.py
--rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/triton_crossentropy_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)      443 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/triton_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.922218 lightning_thunder-0.2.0.dev20240421/thunder/extend/
--rw-r--r--   0 runner    (1001) docker     (127)    15699 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/extend/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    17053 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/functional.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.922218 lightning_thunder-0.2.0.dev20240421/thunder/numpy/
--rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/numpy/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/numpy/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/py.typed
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.922218 lightning_thunder-0.2.0.dev20240421/thunder/torch/
--rw-r--r--   0 runner    (1001) docker     (127)   149156 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/torch/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2879 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/torch/langctx.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.709705 lightning_thunder-0.2.0.dev20240428/
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      760 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-04-28 00:20:49.709705 lightning_thunder-0.2.0.dev20240428/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9728 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.705705 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2438 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/not-zip-safe
+-rw-r--r--   0 runner    (1001) docker     (127)      538 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        8 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.689705 lightning_thunder-0.2.0.dev20240428/requirements/
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/requirements/base.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       12 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/requirements/devel.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      485 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/requirements/docs.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      130 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/requirements/notebooks.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      836 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/requirements/test.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-28 00:20:49.709705 lightning_thunder-0.2.0.dev20240428/setup.cfg
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.689705 lightning_thunder-0.2.0.dev20240428/thunder/
+-rw-r--r--   0 runner    (1001) docker     (127)      436 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/thunder/__about__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35925 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.689705 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (127)   102957 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20786 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/benchmark_litgpt.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/distributed.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3726 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/einsum.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28558 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/targets.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11181 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/test_benchmark_litgpt.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.689705 lightning_thunder-0.2.0.dev20240428/thunder/clang/
+-rw-r--r--   0 runner    (1001) docker     (127)    63993 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/clang/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/clang/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30802 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.697705 lightning_thunder-0.2.0.dev20240428/thunder/core/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14981 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/baseutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/codeutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/compile_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6058 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/devices.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/dtypes.py
+-rw-r--r--   0 runner    (1001) docker     (127)   256121 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/interpreter.py
+-rw-r--r--   0 runner    (1001) docker     (127)    57373 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/jit_ext.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4146 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/langctxs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/options.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/patterns.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118947 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/prims.py
+-rw-r--r--   0 runner    (1001) docker     (127)      629 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48867 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/proxies.py
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/pytree.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28170 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/rematerialization.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/symbol.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20436 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/trace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/transform_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)   140414 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/transforms.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7708 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/vjp_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.697705 lightning_thunder-0.2.0.dev20240428/thunder/cudagraphs/
+-rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/cudagraphs/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.697705 lightning_thunder-0.2.0.dev20240428/thunder/distributed/
+-rw-r--r--   0 runner    (1001) docker     (127)    17879 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/bucketing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/checkpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10906 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/prims.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.697705 lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/
+-rw-r--r--   0 runner    (1001) docker     (127)      310 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8449 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/ddp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28416 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/fsdp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.697705 lightning_thunder-0.2.0.dev20240428/thunder/examine/
+-rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/examine/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/examine/memory_caculation.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.701705 lightning_thunder-0.2.0.dev20240428/thunder/executors/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/apex_entropyex.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/cudnn_layernormex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24237 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/cudnnex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/data_dependent_partition.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1085 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/nvfuserex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    74208 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/nvfuserex_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/passes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/pythonex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/sdpaex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10395 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/torch_autograd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8420 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/torch_compile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    82438 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/torchex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25646 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/transformer_engineex.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/triton_crossentropy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/triton_crossentropy_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)      443 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/triton_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.701705 lightning_thunder-0.2.0.dev20240428/thunder/extend/
+-rw-r--r--   0 runner    (1001) docker     (127)    15699 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/extend/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17149 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/functional.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.705705 lightning_thunder-0.2.0.dev20240428/thunder/numpy/
+-rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/numpy/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/numpy/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/py.typed
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.705705 lightning_thunder-0.2.0.dev20240428/thunder/torch/
+-rw-r--r--   0 runner    (1001) docker     (127)   153180 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/torch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2879 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/torch/langctx.py
```

### Comparing `lightning_thunder-0.2.0.dev20240421/LICENSE` & `lightning_thunder-0.2.0.dev20240428/LICENSE`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/MANIFEST.in` & `lightning_thunder-0.2.0.dev20240428/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/PKG-INFO` & `lightning_thunder-0.2.0.dev20240428/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240421
+Version: 0.2.0.dev20240428
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -39,30 +39,31 @@
 Requires-Dist: expecttest==0.2.1; extra == "test"
 Requires-Dist: fdm==0.4.1; extra == "test"
 Requires-Dist: graphviz==0.20.1; extra == "test"
 Requires-Dist: hypothesis==6.100.0; extra == "test"
 Requires-Dist: jax; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jsonargparse; extra == "test"
+Requires-Dist: litgpt==0.3.0; extra == "test"
 Requires-Dist: numpy; extra == "test"
 Requires-Dist: pandas; extra == "test"
 Requires-Dist: pytest-cov==4.1.0; extra == "test"
 Requires-Dist: pytest-random-order==1.1.1; extra == "test"
 Requires-Dist: pytest-timeout==2.2.0; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
 Requires-Dist: pytest-xdist==3.5.0; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 Provides-Extra: notebooks
 Requires-Dist: cuda-python; extra == "notebooks"
 Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -102,27 +103,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240421
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240428
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
@@ -21,22 +21,23 @@
 Requires-Dist: coverage==7.4.4; extra == "test" Requires-Dist: einops; extra ==
 "test" Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist:
 fdm==0.4.1; extra == "test" Requires-Dist: graphviz==0.20.1; extra == "test"
 Requires-Dist: hypothesis==6.100.0; extra == "test" Requires-Dist: jax;
 (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin")
 and extra == "test" Requires-Dist: jsonargparse; extra == "test" Requires-Dist:
-numpy; extra == "test" Requires-Dist: pandas; extra == "test" Requires-Dist:
-pytest-cov==4.1.0; extra == "test" Requires-Dist: pytest-random-order==1.1.1;
-extra == "test" Requires-Dist: pytest-timeout==2.2.0; extra == "test" Requires-
-Dist: pytest-timestamper==0.0.10; extra == "test" Requires-Dist: pytest-
-xdist==3.5.0; extra == "test" Requires-Dist: pytest==8.1.1; extra == "test"
-Requires-Dist: xlsxwriter; extra == "test" Provides-Extra: notebooks Requires-
-Dist: cuda-python; extra == "notebooks" Requires-Dist: ipython[all]==8.23.0;
-extra == "notebooks"
+litgpt==0.3.0; extra == "test" Requires-Dist: numpy; extra == "test" Requires-
+Dist: pandas; extra == "test" Requires-Dist: pytest-cov==4.1.0; extra == "test"
+Requires-Dist: pytest-random-order==1.1.1; extra == "test" Requires-Dist:
+pytest-timeout==2.2.0; extra == "test" Requires-Dist: pytest-
+timestamper==0.0.10; extra == "test" Requires-Dist: pytest-xdist==3.5.0; extra
+== "test" Requires-Dist: pytest==8.1.1; extra == "test" Requires-Dist:
+xlsxwriter; extra == "test" Provides-Extra: notebooks Requires-Dist: cuda-
+python; extra == "notebooks" Requires-Dist: ipython[all]==8.23.0; extra ==
+"notebooks"
                               [Thunder][Thunder]
 
                     **Make PyTorch models Lightning fast.**
     ______________________________________________________________________
    _L_i_g_h_t_n_i_n_g_._a_i â¢ _P_e_r_f_o_r_m_a_n_c_e â¢ _G_e_t_ _s_t_a_r_t_e_d â¢ _I_n_s_t_a_l_l â¢ _E_x_a_m_p_l_e_s â¢
               _I_n_s_i_d_e_ _T_h_u_n_d_e_r â¢ _G_e_t_ _i_n_v_o_l_v_e_d_! â¢ _D_o_c_u_m_e_n_t_a_t_i_o_n
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https:
```

### Comparing `lightning_thunder-0.2.0.dev20240421/README.md` & `lightning_thunder-0.2.0.dev20240428/README.md`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/PKG-INFO` & `lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240421
+Version: 0.2.0.dev20240428
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -39,30 +39,31 @@
 Requires-Dist: expecttest==0.2.1; extra == "test"
 Requires-Dist: fdm==0.4.1; extra == "test"
 Requires-Dist: graphviz==0.20.1; extra == "test"
 Requires-Dist: hypothesis==6.100.0; extra == "test"
 Requires-Dist: jax; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jsonargparse; extra == "test"
+Requires-Dist: litgpt==0.3.0; extra == "test"
 Requires-Dist: numpy; extra == "test"
 Requires-Dist: pandas; extra == "test"
 Requires-Dist: pytest-cov==4.1.0; extra == "test"
 Requires-Dist: pytest-random-order==1.1.1; extra == "test"
 Requires-Dist: pytest-timeout==2.2.0; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
 Requires-Dist: pytest-xdist==3.5.0; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 Provides-Extra: notebooks
 Requires-Dist: cuda-python; extra == "notebooks"
 Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -102,27 +103,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240421
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240428
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
@@ -21,22 +21,23 @@
 Requires-Dist: coverage==7.4.4; extra == "test" Requires-Dist: einops; extra ==
 "test" Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist:
 fdm==0.4.1; extra == "test" Requires-Dist: graphviz==0.20.1; extra == "test"
 Requires-Dist: hypothesis==6.100.0; extra == "test" Requires-Dist: jax;
 (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin")
 and extra == "test" Requires-Dist: jsonargparse; extra == "test" Requires-Dist:
-numpy; extra == "test" Requires-Dist: pandas; extra == "test" Requires-Dist:
-pytest-cov==4.1.0; extra == "test" Requires-Dist: pytest-random-order==1.1.1;
-extra == "test" Requires-Dist: pytest-timeout==2.2.0; extra == "test" Requires-
-Dist: pytest-timestamper==0.0.10; extra == "test" Requires-Dist: pytest-
-xdist==3.5.0; extra == "test" Requires-Dist: pytest==8.1.1; extra == "test"
-Requires-Dist: xlsxwriter; extra == "test" Provides-Extra: notebooks Requires-
-Dist: cuda-python; extra == "notebooks" Requires-Dist: ipython[all]==8.23.0;
-extra == "notebooks"
+litgpt==0.3.0; extra == "test" Requires-Dist: numpy; extra == "test" Requires-
+Dist: pandas; extra == "test" Requires-Dist: pytest-cov==4.1.0; extra == "test"
+Requires-Dist: pytest-random-order==1.1.1; extra == "test" Requires-Dist:
+pytest-timeout==2.2.0; extra == "test" Requires-Dist: pytest-
+timestamper==0.0.10; extra == "test" Requires-Dist: pytest-xdist==3.5.0; extra
+== "test" Requires-Dist: pytest==8.1.1; extra == "test" Requires-Dist:
+xlsxwriter; extra == "test" Provides-Extra: notebooks Requires-Dist: cuda-
+python; extra == "notebooks" Requires-Dist: ipython[all]==8.23.0; extra ==
+"notebooks"
                               [Thunder][Thunder]
 
                     **Make PyTorch models Lightning fast.**
     ______________________________________________________________________
    _L_i_g_h_t_n_i_n_g_._a_i â¢ _P_e_r_f_o_r_m_a_n_c_e â¢ _G_e_t_ _s_t_a_r_t_e_d â¢ _I_n_s_t_a_l_l â¢ _E_x_a_m_p_l_e_s â¢
               _I_n_s_i_d_e_ _T_h_u_n_d_e_r â¢ _G_e_t_ _i_n_v_o_l_v_e_d_! â¢ _D_o_c_u_m_e_n_t_a_t_i_o_n
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https:
```

### Comparing `lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/SOURCES.txt` & `lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/requires.txt` & `lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/requires.txt`

 * *Files 25% similar despite different names*

```diff
@@ -16,14 +16,15 @@
 coverage==7.4.4
 einops
 expecttest==0.2.1
 fdm==0.4.1
 graphviz==0.20.1
 hypothesis==6.100.0
 jsonargparse
+litgpt==0.3.0
 numpy
 pandas
 pytest-cov==4.1.0
 pytest-random-order==1.1.1
 pytest-timeout==2.2.0
 pytest-timestamper==0.0.10
 pytest-xdist==3.5.0
```

### Comparing `lightning_thunder-0.2.0.dev20240421/requirements/test.txt` & `lightning_thunder-0.2.0.dev20240428/requirements/test.txt`

 * *Files 25% similar despite different names*

```diff
@@ -7,15 +7,15 @@
 pytest-timestamper ==0.0.10
 graphviz ==0.20.1
 fdm ==0.4.1
 expecttest ==0.2.1  # for test_ddp.py
 hypothesis ==6.100.0  # for test_ddp.py
 numpy  # for test_ops.py
 einops  # for test_einops.py
-litgpt @ git+https://github.com/Lightning-AI/lit-gpt@940ffc96f7214bca24aa77479bc7c33900aaef28
+litgpt==0.3.0  # for the model definition in tests and benchmarks
 absl-py # thunder/benchmarks/test_benchmark_litgpt.py
 pandas # thunder/benchmarks/test_benchmark_litgpt.py
 xlsxwriter # thunder/benchmarks/test_benchmark_litgpt.py
 jsonargparse # thunder/benchmarks/benchmark_litgpt.py
 
 # Installs JAX on Linux and MacOS
 jaxlib; sys_platform == 'linux' or sys_platform == 'darwin'  # required for jax, see https://github.com/google/jax#installation
```

### Comparing `lightning_thunder-0.2.0.dev20240421/setup.py` & `lightning_thunder-0.2.0.dev20240428/setup.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/__init__.py` & `lightning_thunder-0.2.0.dev20240428/thunder/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -174,16 +174,24 @@
 #   the file is modified then the modified version of the program will be compiled and executed, instead.
 from thunder.core.trace import _set_execution_file
 
 set_execution_callback_file = _set_execution_file
 
 
 # Translates the Python function to a thunder program using the thunder interpreter
-def _general_frontend(fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS) -> TraceResults:
-    return thunder_general_jit(fn, args, kwargs, sharp_edges=sharp_edges)
+def _general_frontend(
+    fn: Callable,
+    args: tuple[Any, ...],
+    kwargs: dict[str, Any],
+    /,
+    *,
+    record_history: bool,
+    sharp_edges: SHARP_EDGES_OPTIONS,
+) -> TraceResults:
+    return thunder_general_jit(fn, args, kwargs, sharp_edges=sharp_edges, record_history=record_history)
 
 
 class ThunderModule(pytorch.nn.Module):
     """A wrapper nn.Module subclass.
 
     This wrapper is returned by ``thunder.jit``, you would typically not
     instantiate it manually.
@@ -323,14 +331,15 @@
     langctx: None | str | Any | LanguageContext = None,
     executors: None | Sequence[Executor | str] = None,
     sharp_edges: None | SHARP_EDGES_OPTIONS | str = None,
     interpretation: None | INTERPRETATION_OPTIONS | str = None,
     cache: None | CACHE_OPTIONS | str = None,
     disable_torch_autograd: bool = False,  # TODO Revisit this UX for RC1
     additional_transforms: list | None = None,
+    record_history: bool = False,
     **compile_options,  # TODO RC1 Make this explicit -- dict of options
 ) -> Callable:
     """Just-in-time compile a callable (function or model).
 
     Args:
         fn: A :class:`~torch.nn.Module` or a function to compile.
     Keyword Args:
@@ -373,14 +382,16 @@
     #     sharp_edges = SHARP_EDGES_OPTIONS.WARN
 
     executor_lookasides = {}
     for ex in executors:
         # TODO: sharp edge if lookasides are shadowed?
         executor_lookasides.update(ex._lookasides)
 
+    assert type(record_history) is bool
+
     # TODO RC1 Refine the compile data option to remove unused options
     cd = CompileData(
         fn=fn,
         langctx=langctx,
         executors_list=executors,
         cache_option=cache,
         sharp_edges=sharp_edges,
@@ -520,15 +531,17 @@
             # Acquires the trace OR inlines the trace into an existing trace and
             #   returns the (proxied) result of the operation
             cs.last_trace_tracing_start = time.time_ns()
 
             with langctxs.langctx(cd.langctx):
                 prologue_trc: TraceCtx
                 computation_trc: TraceCtx
-                jit_results: TraceResults = interpreter(fn, args, kwargs, sharp_edges=cd.sharp_edges)
+                jit_results: TraceResults = interpreter(
+                    fn, args, kwargs, record_history=record_history, sharp_edges=cd.sharp_edges
+                )
                 prologue_trc = jit_results.prologue_trace
                 computation_trc = jit_results.computation_trace
                 epilogue_trc = jit_results.epilogue_trace
                 last_interpreter_log = jit_results.interpreter_log
 
             if epilogue_trc is not None:
                 epilogue_traces = [epilogue_trc]
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/__init__.py` & `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/benchmark_litgpt.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/distributed.py` & `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/distributed.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/einsum.py` & `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/einsum.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/targets.py` & `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/targets.py`

 * *Files 2% similar despite different names*

```diff
@@ -589,14 +589,69 @@
     setup = make_setup(bench)
     fn = executor(bench)
     fn = wrap_for_benchmark(fn)
 
     benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
 
 
+sdpa_executors = (
+    torch_executor,
+    torch_compile_executor,
+    thunder_executor,
+    *((thunder_cudnn_nvfuser_executor,) if thunder_cudnn_nvfuser_executor is not None else ()),
+)
+sdpa_executors_ids = (
+    "torch",
+    "torch.compile",
+    "thunder",
+    *(("thunder+cudnn",) if thunder_cudnn_nvfuser_executor is not None else ()),
+)
+
+
+# Sample command to run this benchmark:
+# pytest thunder/benchmarks/targets.py -k "test_litgpt_sdpa_grad" --benchmark-group-by='param:config,param:bs' --benchmark-columns='min,max,mean,stddev,median'
+@pytest.mark.parametrize(
+    "executor,",
+    sdpa_executors,
+    ids=sdpa_executors_ids,
+)
+@pytest.mark.parametrize(
+    "bs,",
+    (
+        1,
+        2,
+    ),
+    ids=("bs1", "bs2"),
+)
+@pytest.mark.parametrize(
+    "config,",
+    (
+        "Llama-2-7b-hf",
+        "Llama-2-13b-hf",
+        "Llama-2-70b-hf",
+        "Llama-3-8B",
+        "Llama-3-70B",
+    ),
+)
+def test_litgpt_sdpa_grad(benchmark, executor: Callable, bs, config):
+    bench: Benchmark = LitGPTSDPABenchmark(
+        config=config,
+        batchdims=(bs,),
+        device="cuda:0",
+        dtype=thunder.bfloat16,
+        requires_grad=True,
+    )
+
+    setup = make_setup(bench)
+    fn = thunder_fwd_bwd(bench, compile_fn=executor)
+    fn = wrap_for_benchmark(fn)
+
+    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+
+
 @pytest.mark.parametrize(
     "executor,",
     fwd_executors,
     ids=fwd_executor_ids,
 )
 def test_nanogpt_mlp_fwd(benchmark, executor: Callable):
     bench: Benchmark = NanoGPTMLPBenchmark(
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/test_benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/test_benchmark_litgpt.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/clang/__init__.py` & `lightning_thunder-0.2.0.dev20240428/thunder/clang/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -1044,14 +1044,20 @@
 def take_along_axis(a: TensorProxy, /, indices: TensorProxy, dim: int) -> TensorProxy:
     dim = utils.canonicalize_dim(a.ndim, dim)
     indices = _maybe_expand_exclude_dim(indices, a, dim)
     return prims.take_along_axis(a, indices, dim)
 
 
 @clangop()
+def gather(a: TensorProxy, /, indices: TensorProxy, dim: int) -> TensorProxy:
+    dim = utils.canonicalize_dim(a.ndim, dim)
+    return prims.gather(a, indices, dim)
+
+
+@clangop()
 def scatter_add(a: TensorProxy, /, indices: TensorProxy, value: TensorProxy, dim: int) -> TensorProxy:
     dim = utils.canonicalize_dim(a.ndim, dim)
     return prims.scatter_add(a, indices, value, dim)
 
 
 # NOTE revisit the decomposition when fuser supports index_put
 @clangop()
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/clang/langctx.py` & `lightning_thunder-0.2.0.dev20240428/thunder/clang/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/common.py` & `lightning_thunder-0.2.0.dev20240428/thunder/common.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/baseutils.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/baseutils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/codeutils.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/codeutils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/compile_data.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/compile_data.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/devices.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/devices.py`

 * *Files 2% similar despite different names*

```diff
@@ -10,21 +10,23 @@
 import torch
 import thunder.core.baseutils as baseutils
 
 
 class DeviceType(Enum):
     CPU = auto()
     CUDA = auto()
+    META = auto()
 
 
 all_devicetypes = (DeviceType.CPU, DeviceType.CUDA)
 
 _devicetype_prettyprint_map = {
     DeviceType.CPU: "cpu",
     DeviceType.CUDA: "cuda",
+    DeviceType.META: "meta",
 }
 _inverse_devicetype_prettyprint_map = {v: k for k, v in _devicetype_prettyprint_map.items()}
 
 
 def devicetype_string(devicetype: DeviceType) -> str:
     return _devicetype_prettyprint_map[devicetype]
 
@@ -48,15 +50,15 @@
     if _index is None:
         _index = index
 
     if _devicetype is DeviceType.CUDA:
         if _index is None:
             _index = 0
     else:
-        # _devicetype is DeviceType.CPU
+        # _devicetype is DeviceType.CPU, .META
         # NOTE That it's not an error to request cpu:1, but we ignore the index
         #   This is distinct from PyTorch, where `cpu:3` will have index 3, even though
         #   all cpu devices refer to the same physical device
         _index = None
 
     return _devicetype, _index
 
@@ -111,19 +113,18 @@
 
     def __hash__(self) -> int:
         return id(self)
 
     # NOTE This representation is a valid PyTorch device string, which is currently relied upon when
     #   converting Thunder devices to PyTorch devices
     def __repr__(self) -> str:
-        if self.devicetype == DeviceType.CPU:
-            return devicetype_string(self.devicetype)
-
-        # NOTE self.devicetype == DeviceType.CUDA
-        return f"{devicetype_string(self.devicetype)}:{self.index}"
+        if self.devicetype == DeviceType.CUDA:
+            return f"{devicetype_string(self.devicetype)}:{self.index}"
+        # note: self.devicetype == DeviceType.CPU, .META
+        return devicetype_string(self.devicetype)
 
     # NOTE Because devices are singleton object, this has the luxury of using "is"
     def __eq__(self, other: Device) -> bool:
         return self is other
 
 
 cpu = Device(DeviceType.CPU, None)
@@ -147,26 +148,29 @@
 def _device_from_string_helper(devicestr: str) -> tuple[DeviceType, None | int]:
     if devicestr == "cpu":
         return DeviceType.CPU, None
 
     if devicestr == "cuda":
         return DeviceType.CUDA, None
 
+    if devicestr == "meta":
+        return DeviceType.META, None
+
     devicetype, idx_str = devicestr.split(":")
     idx = int(idx_str)
 
     return _inverse_devicetype_prettyprint_map[devicetype], idx
 
 
 # Translates strings of the form "cpu" or "cuda:x" (for a valid integer x) into a Device object
 def device_from_string(devicestr: str) -> Device:
     devicetype, deviceno = _device_from_string_helper(devicestr)
 
-    if devicetype is DeviceType.CPU:
-        return cpu
+    if devicetype is not DeviceType.CUDA:
+        deviceno = None
 
     return Device(devicetype, deviceno)
 
 
 # TODO Maybe allow acquiring a tensor's device this way, too
 def to_device(x: None | str | torch.device | Device, /) -> None | Device:
     if x is None or isinstance(x, Device):
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/dtypes.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/dtypes.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/interpreter.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/interpreter.py`

 * *Files 1% similar despite different names*

```diff
@@ -449,38 +449,38 @@
         yield
     finally:
         reset_interpretercompilectx(tok)
 
 
 class LineLogItem(TypedDict):
     kind: Literal["Line"]
-    fn: Callable | CodeType
+    fn: str
     filename: str
     position: Positions | None
 
 
 class OpaqueLogItem(TypedDict):
     kind: Literal["Opaque"]
-    fn: Callable
+    fn: str
 
 
 class LookasideLogItem(TypedDict):
     kind: Literal["Lookaside"]
-    fn: Callable
+    fn: str
 
 
 class CallLogItem(TypedDict):
     kind: Literal["InterpreterCall"]
-    fn: Callable
+    fn: str
     prev_frame: str
 
 
 class ReturnLogItem(TypedDict):
     kind: Literal["InterpreterReturn"]
-    fn: Callable
+    fn: str
     is_signal: bool
     rval: type | INTERPRETER_SIGNALS
 
 
 InterpreterLogItem = (
     dis.Instruction | str | LineLogItem | OpaqueLogItem | LookasideLogItem | CallLogItem | ReturnLogItem
 )
@@ -508,15 +508,15 @@
 # _run_frame.
 # Interpreter Errors are raised wrapped in a InterpreterError exception to signal that we have run into
 # something with the Interpreter itself or how it was called.
 
 
 # The interpreter's runtime context, which tracks stack changes in Python mode
 class InterpreterRuntimeCtx:
-    def __init__(self, *, debug_log: None | StringIO = None):
+    def __init__(self, record_history: bool, debug_log: None | StringIO):
         self.frame_stack: list[InterpreterFrame] = []
         self._globals_dict: dict[str, Any] | None = None
         self._interpreter_log: list[InterpreterLogItem] = []
         self._interpreted_instructions: list[dis.Instruction] = []
         self._curexc: BaseException | None = None
         # The exception_stack mirrors the exc_info/exc_state from PyThreadState
         # exception_stack is the stack of exceptions currently being handled, we only have exceptions here
@@ -529,14 +529,15 @@
 
         self.debug_log = debug_log
         self._original_callsite: inspect.FrameInfo = inspect.stack()[2]  # [__init__, fn_, callsite, ...]
         self._prev_filename: None | str = None
         self._prev_position: Positions | None = None
         self._known_wrappers = {}
         self._proxied_values = set()
+        self._record_history = record_history
 
     def register_proxied_value(self, v):
         self._proxied_values.add(v)
 
     def cache_wrapper(self, wrapped_value: WrappedValue):
         compilectx: InterpreterCompileCtx = get_interpretercompilectx()
         # we don't know what wrapped_value does for eq, so "is not ()" is correct here but python does not like "is ()"
@@ -568,14 +569,17 @@
 
     # The operations and opaque calls encountered while interpreting
     @property
     def interp_log(self) -> list[InterpreterLogItem]:
         return self._interpreter_log
 
     def record(self, val: InterpreterLogItem, /) -> None:
+        if not self._record_history:
+            return
+
         self._interpreter_log.append(val)
 
         if self.debug_log is not None:
             self.debug_log.write(f"Appended to log: {val}" + os.linesep)
 
     def peek_interpreter_stack(self) -> InterpreterStack:
         return self.frame_stack[-1].interpreter_stack
@@ -601,68 +605,90 @@
             pf = self._pop_frame_stack()
             assert pf is frame, "Frame stack inconsistency"
 
     # TODO Instead of appending to both the log and and interpreted_instructions we could
     #   consider just appending to the log and then filtering to only instructions when
     #   interpreted_instructions is accessed
     def record_interpreted_instruction(self, inst: dis.Instruction, /) -> InterpreterRuntimeCtx:
+        if not self._record_history:
+            return self
+
         self._interpreted_instructions.append(inst)
         self.record(inst)
         return self
 
     def record_interpreter_call(self, fn: Callable) -> InterpreterRuntimeCtx:
+        if not self._record_history:
+            return self
+
         frame: InterpreterFrame | None = self.peek_frame_stack()
 
         # If frame is None, that means that this is the first call to _interpret_call, in _run_frame.
         # In that case we should also print out what line we're starting on, since
         # no line number changes have happened yet.
         if frame is not None:
-            self.record({"kind": "InterpreterCall", "fn": fn, "prev_frame": frame.qualname})
+            self.record(
+                {"kind": "InterpreterCall", "fn": extract_callable_name(unwrap(fn)), "prev_frame": frame.qualname}
+            )
         else:
             if hasattr(self._original_callsite, "positions"):
                 pos = self._original_callsite.positions
             else:
                 pos = Positions(self._original_callsite.lineno, self._original_callsite.lineno, 0, 999)
-            # self.record_position(fn, self._original_callsite.filename, pos)
+            self.record_position(fn, self._original_callsite.filename, pos)
             self.record(
                 {
                     "kind": "InterpreterCall",
-                    "fn": fn,
+                    "fn": extract_callable_name(unwrap(fn)),
                     "prev_frame": self._original_callsite.function,
                 }
             )
         return self
 
     def record_interpreter_return(self, fn: Callable, rval: Any | INTERPRETER_SIGNALS, /) -> InterpreterRuntimeCtx:
+        if not self._record_history:
+            return self
+
         is_signal: bool = isinstance(rval, INTERPRETER_SIGNALS)
         rv: type | INTERPRETER_SIGNALS = rval if is_signal else type(unwrap(rval))
-        self.record(ReturnLogItem(kind="InterpreterReturn", fn=fn, is_signal=is_signal, rval=rv))
+        self.record(
+            ReturnLogItem(kind="InterpreterReturn", fn=extract_callable_name(unwrap(fn)), is_signal=is_signal, rval=rv)
+        )
         return self
 
     def record_opaque_call(self, fn: Callable) -> InterpreterRuntimeCtx:
-        self.record(OpaqueLogItem(kind="Opaque", fn=fn))
+        if not self._record_history:
+            return self
+
+        self.record(OpaqueLogItem(kind="Opaque", fn=extract_callable_name(unwrap(fn))))
         return self
 
     def record_lookaside(self, fn: Callable) -> InterpreterRuntimeCtx:
-        self.record(LookasideLogItem(kind="Lookaside", fn=fn))
+        if not self._record_history:
+            return self
+
+        self.record(LookasideLogItem(kind="Lookaside", fn=extract_callable_name(unwrap(fn))))
         return self
 
     def record_position(
         self, fn: Callable | CodeType, filename: str, position: Positions | None, /
     ) -> InterpreterRuntimeCtx:
+        if not self._record_history:
+            return self
+
         # Only record a change in the Python line
         if filename == self._prev_filename and _positions_equal(position, self._prev_position):
             return self
 
         if position is not None and position.lineno is None:
             position = None
 
         self._prev_position = position
         self._prev_filename = filename
-        line = LineLogItem(kind="Line", fn=fn, filename=filename, position=position)
+        line = LineLogItem(kind="Line", fn=extract_callable_name(unwrap(fn)), filename=filename, position=position)
         self.record(line)
         return self
 
     def format_traceback(self):
         return os.linesep.join(f.format_with_source() for f in self.frame_stack)
 
 
@@ -5970,20 +5996,20 @@
                 assert len(a.key_wrappers) == len(
                     a.item_wrappers
                 ), f"{len(a.value)} {len(a.item_wrappers)} {len(a.key_wrappers)} {a.value} {a.item_wrappers} {fn}"
 
     return unwrap(res)
 
 
-def _interpret_call(fn: Callable | WrappedValue, /, *args, **kwargs) -> Any | INTERPRETER_SIGNALS:
+def _interpret_call(fn: Callable, /, *args, **kwargs) -> Any | INTERPRETER_SIGNALS:
     compilectx: InterpreterCompileCtx = get_interpretercompilectx()
     runtimectx: InterpreterRuntimeCtx = get_interpreterruntimectx()
 
     # TODO: Implement generics and fix WrappedValue[T] everywhere.
-    runtimectx.record_interpreter_call(fn)  # type: ignore
+    runtimectx.record_interpreter_call(fn)
     rval = _call_dispatch(compilectx, runtimectx, fn, *args, **kwargs)  # type: ignore
     if compilectx._with_provenance_tracking:
         assert isinstance(rval, (INTERPRETER_SIGNALS, WrappedValue)), f"return {rval} unexpected calling {unwrap(fn)}"
     runtimectx.record_interpreter_return(fn, rval)  # type: ignore
 
     return rval
 
@@ -6156,18 +6182,19 @@
     if isinstance(fn, functools.partialmethod):
         raise NotImplementedError(
             "functools.partialmethod objects like {fn} are not currently supported, please file an issue requesting support"
         )
 
     # (4) Handles opaque functions
     if is_opaque(fn):
-        runtimectx.record_opaque_call(fn)
-        args_ = [unwrap(a) for a in args]
+        # TODO: Deeper unwrapping?
+        args_ = tuple(unwrap(a) for a in args)
         kwargs_ = {unwrap(k): unwrap(v) for k, v in kwargs.items()}
         try:
+            runtimectx.record_opaque_call(fn)
             opaque_result: Any = fn(*args_, **kwargs_)
         except Exception as e:
             runtimectx.curexc = e
             return INTERPRETER_SIGNALS.EXCEPTION_RAISED
 
         if compilectx._with_provenance_tracking:
             pr = ProvenanceRecord(
@@ -6597,28 +6624,29 @@
     *,
     opcode_interpreter: Callable = default_opcode_interpreter,
     fn_lookaside: Callable = default_lookaside,
     callbacks: dict[INTERPRETER_CALLBACKS, Callable] = default_callbacks,
     debug_log: None | StringIO = None,
     with_provenance_tracking: bool = False,
     uncacheable_classes: list[type] | None = None,
+    record_history: bool = False,
 ) -> Callable:
     compilectx: InterpreterCompileCtx = InterpreterCompileCtx(
         opcode_interpreter=opcode_interpreter,
         fn_lookaside=fn_lookaside,
         callbacks=callbacks,
         with_provenance_tracking=with_provenance_tracking,
         uncacheable_classes=uncacheable_classes,
     )
     if hasattr(fn, "__thunder_interpreter_orig_fn"):
         fn = fn.__thunder_interpreter_orig_fn
 
     @functools.wraps(fn)
     def fn_(*args, **kwargs) -> Any:
-        runtimectx: InterpreterRuntimeCtx = InterpreterRuntimeCtx(debug_log=debug_log)
+        runtimectx: InterpreterRuntimeCtx = InterpreterRuntimeCtx(debug_log=debug_log, record_history=record_history)
 
         with interpreter_ctx(compilectx, runtimectx):
             try:
                 # we normalize the outmost function to be interpreted to take
                 # args and kwargs as arguments (not *args and **kwargs).
                 # We thus have three special INPUTs for the entry function: INPUT_ARGS, INPUT_KWARGS, INPUT_FN
                 args = wrap(
@@ -6716,69 +6744,66 @@
                 log_line = f"Instruction('{item.opname}', arg={item.arg}, argrepr={repr(item.argrepr)})"
 
             case str():
                 # Print the string as-is, indented, without colors.
                 linecolor = colors["RESET"]
                 log_line = item
 
-            case {"kind": "Line", "fn": _fn, "filename": filename, "position": position}:
+            case {"kind": "Line", "fn": fn, "filename": filename, "position": position}:
                 # LineLogItem
-                _fn = unwrap(_fn)
                 inside_inner_interpreter = interpreter_path in filename
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["YELLOW"]
                 nl = os.linesep
-                fnname = extract_callable_name(_fn)
                 if position:
-                    log_line = f"# Line {filename}:{position.lineno} in {fnname}()"
+                    log_line = f"# Line {filename}:{position.lineno} in {fn}()"
                 else:
-                    log_line = f"# {filename} in {fnname}()"
+                    log_line = f"# {filename} in {fn}()"
 
                 if not print_source_code or not position:
                     continue
 
                 first_lineno = position.lineno
                 assert first_lineno
                 linestr = linecache.getline(filename, first_lineno)
                 if linestr.endswith(os.linesep):
                     linestr = linestr[: -len(os.linesep)]
                 source_line = linestr
 
             case {"kind": "InterpreterCall", "fn": fn, "prev_frame": prev_frame}:
                 # CallLogItem
-                fn = unwrap(fn)
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["GREEN"]
                 c_indent += 1
-                log_line = f"Interpreting call to {extract_callable_name(fn)}() from {prev_frame}{'()' if not prev_frame.endswith('>') else ''}"
+                log_line = (
+                    f"Interpreting call to {fn}() from {prev_frame}{'()' if not prev_frame.endswith('>') else ''}"
+                )
 
-            case {"kind": "InterpreterReturn", "fn": fn, "is_signal": is_signal, "rval": rval}:
+            case {"kind": "InterpreterReturn", "fn": fn, "rval": rval}:
                 # ReturnLogItem
-                fn = unwrap(fn)
                 rval = unwrap(rval)
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["RED"]
                 deindent = True
+                is_signal = isinstance(rval, INTERPRETER_SIGNALS)
                 meaning = "signal" if is_signal else "value of type"
                 val = rval if is_signal else rval.__qualname__
-                log_line = f"Returning from call to {extract_callable_name(fn)}() with {meaning} {val}"
+                log_line = f"Returning from call to {fn}() with {meaning} {val}"
 
             case {"kind": "Lookaside", "fn": fn}:
                 # LookasideLogItem
-                fn = unwrap(fn)
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["BLUE"]
-                log_line = f"Lookaside to {extract_callable_name(fn)}()"
+                log_line = f"Lookaside to {fn}()"
 
             case {"kind": "Opaque", "fn": fn}:
                 # OpaqueLogItem
-                fn = unwrap(fn)
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["CYAN"]
-                log_line = f"Opaque call to {fn} with name {extract_callable_name(fn)}"
+                log_line = f"Opaque call to {fn}()"
 
             case _:
                 raise NotImplementedError(f"Unexpected log item {item}")
 
         if max_depth is None or c_indent <= max_depth:
             print_fn(f"{nl}{' ' * c_indent if indent else ''}{linecolor}{log_line}{colors['RESET']}")
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/jit_ext.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/jit_ext.py`

 * *Files 3% similar despite different names*

```diff
@@ -109,14 +109,15 @@
 # jit_ext.py implements extensions of thunder's interpreter
 #
 
 
 EXT_FLAG_IS_PROXY_DERIVED = 1
 EXT_FLAG_IS_TENSOR_PROXY = 2
 EXT_FLAG_IS_MODULE_MEMBER_DICT = 4
+EXT_FLAG_IS_MODULE = 8
 MODULE_MEMBER_DICT_ATTRS = {
     "_parameters",
     "_modules",
     "_buffers",
     "__dict__",
 }
 
@@ -436,17 +437,17 @@
     INTERPRETER_CALLBACKS.GLOBAL_CALLBACK: _minimal_global_callback,
     INTERPRETER_CALLBACKS.STORE_DEREF_CALLBACK: _minimal_store_deref_callback,
 }
 _minimal_callbacks = default_callbacks | _minimal_callbacks
 
 
 # TODO RC1 Add debug_log
-def minimal_thunder_jit(fn: Callable, /, *, sharp_edges: SHARP_EDGES_OPTIONS) -> Callable:
+def minimal_thunder_jit(fn: Callable, /, *, record_history: bool = False, sharp_edges: SHARP_EDGES_OPTIONS) -> Callable:
     ctx: MinimalCtx = MinimalCtx(sharp_edges=sharp_edges)
-    jfn = interpret(fn, fn_lookaside=_minimal_lookaside, callbacks=_minimal_callbacks)
+    jfn = interpret(fn, fn_lookaside=_minimal_lookaside, callbacks=_minimal_callbacks, record_history=record_history)
 
     def fn_(*args, **kwargs):
         try:
             tok = set_minimal_ctx(ctx)
             return jfn(*args, **kwargs)
         finally:
             reset_minimal_ctx(tok)
@@ -1047,15 +1048,17 @@
     return all(should_register_for_prologue(i) for i in pr.inputs)
 
 
 def _general_jit_wrap_callback(value):
     ctx: GeneralJitCtx = get_general_jit_ctx()
 
     uvalue = value.value
-    if isinstance(uvalue, torch.Tensor):
+    if isinstance(uvalue, torch.nn.Module):
+        value.provenance.ext_flag |= EXT_FLAG_IS_MODULE
+    elif isinstance(uvalue, torch.Tensor):
         # we always want to proxy torch.Tensor, even const
         p = ctx.proxify(value)
     elif value.provenance.inst is PseudoInst.CONSTANT:
         value.provenance.ext_flag |= EXT_FLAG_IS_PROXY_DERIVED
     elif callable(uvalue):
         pass  # we only care if it is called
     elif type(uvalue) in (tuple, list, dict, CellType, ModuleType, set):
@@ -1152,62 +1155,122 @@
         # Adds the name to the prologue trace
         if not prologue_trace.has_name(p.name):
             prologue_trace.add_name(p.name)
 
         def from_input(provenance, *, new_output=False):
             assert new_output
             if provenance.inst == PseudoInst.INPUT_ARGS:
-                param_ordering[id(p)][1].insert(0, 0)
+                param_ordering[id(pro_args_proxy)] = (pro_args_proxy, [0])
                 return pro_args_proxy
             elif provenance.inst == PseudoInst.INPUT_KWARGS:
-                param_ordering[id(p)][1].insert(0, 1)
+                param_ordering[id(pro_kwargs_proxy)] = (pro_kwargs_proxy, [1])
                 is_pure = False
                 return pro_kwargs_proxy
             elif provenance.inst == PseudoInst.INPUT_FN:
-                param_ordering[id(p)][1].insert(0, 3)
                 is_pure = False
-                name = "fn"
+                if provenance.ext_flag & EXT_FLAG_IS_MODULE:
+                    name = "module"
+                else:
+                    name = "fn"
                 output = Proxy(name=name)
+                param_ordering[id(output)] = (output, [3])
                 provenance.proxy = output
                 bsym = prims.unpack_function_obj.bind(output, output=output)
                 prologue_trace.bound_symbols.append(bsym)
                 return output
             assert False
 
         def from_load_attr(provenance, *, new_output=False):
             is_pure = False
             inputs = [from_provenance(i, new_output=True) for i in provenance.inputs]
             if new_output:
                 output = Proxy("obj")
             else:
                 output = p
-            param_ordering[id(p)][1][:0] = [math.inf, "." + str(inputs[1])]
+            param_ordering[id(output)] = (output, param_ordering[id(inputs[0])][1] + [math.inf, "." + str(inputs[1])])
             bsym = prims.unpack_attr.bind(inputs[0], inputs[1], output=output)
             prologue_trace.bound_symbols.append(bsym)
             return output
 
         def from_constant(provenance, *, new_output=False):
             if isinstance(provenance.value, (int, str)):
                 return provenance.value
             else:
                 raise NotImplementedError(f"constant of type {type(provenance.value)} {provenance.value}")
 
+        def unpack_parameter_or_buffer(provenance, *, new_output=False):
+            assert provenance.inputs[0].inputs[0].inputs[0].ext_flag & EXT_FLAG_IS_MODULE
+            typ = provenance.inputs[0].inputs[1].value
+            name = [provenance.inputs[1].value]
+            mprovenance = provenance.inputs[0].inputs[0].inputs[0]
+
+            while (
+                mprovenance.inst is PseudoInst.BINARY_SUBSCR
+                and mprovenance.inputs[1].inst is PseudoInst.CONSTANT
+                and mprovenance.inputs[0].inst is PseudoInst.LOAD_ATTR
+                and mprovenance.inputs[0].inputs[0].ext_flag & EXT_FLAG_IS_MODULE
+            ):
+                assert (
+                    mprovenance.inputs[0].inputs[1].inst is PseudoInst.CONSTANT
+                    and mprovenance.inputs[0].inputs[1].value == "_modules"
+                )
+
+                name_component = mprovenance.inputs[1].value
+                name.insert(0, name_component)
+                mprovenance = mprovenance.inputs[0].inputs[0]
+
+            root_module = from_provenance(mprovenance, new_output=True)
+            if new_output:
+                output = Proxy("")  # name? collectify?
+            else:
+                output = p
+
+            param_ordering[id(output)] = (
+                output,
+                param_ordering[id(root_module)][1]
+                + [
+                    i
+                    for name_component in name
+                    for i in (
+                        [int(name_component)] if name_component.isnumeric() else [math.inf, ("." + name_component)]
+                    )
+                ],
+            )
+
+            name = ".".join(name)
+            if typ == "_parameters":
+                bsym = prims.unpack_parameter.bind(root_module, name, output=output)
+            else:
+                bsym = prims.unpack_buffer.bind(root_module, name, output=output)
+            prologue_trace.bound_symbols.append(bsym)
+
         def from_binary_subscr(provenance, *, new_output=False):
+            # special case tensors, todo: do this via pattern matching after unpacking?
+            if (
+                provenance.inst is PseudoInst.BINARY_SUBSCR
+                and provenance.inputs[0].inst is PseudoInst.BINARY_SUBSCR
+                and provenance.inputs[1].inst is PseudoInst.CONSTANT
+                and provenance.inputs[0].inputs[1].inst is PseudoInst.CONSTANT
+                and provenance.inputs[0].inputs[1].value in {"_parameters", "_buffers"}
+                and provenance.inputs[0].inputs[0].ext_flag & EXT_FLAG_IS_MODULE_MEMBER_DICT
+            ):
+                return unpack_parameter_or_buffer(provenance, new_output=new_output)
+
             inputs = [from_provenance(i, new_output=True) for i in provenance.inputs]
             obj, idx = inputs
             if new_output:
                 output = Proxy("subscr")  # name? collectify?
             else:
                 output = p
             if isinstance(idx, (int, str)):
                 if isinstance(idx, int):
                     idx = int(idx)
                 elif isinstance(idx, str):
                     idx = str(idx)
-                param_ordering[id(p)][1][:0] = [math.inf, "[" + str(idx) + "]"]
+                param_ordering[id(output)] = (output, param_ordering[id(obj)][1] + [math.inf, "[" + str(idx) + "]"])
                 bsym = prims.unpack_getitem.bind(obj, idx, output=output)
                 prologue_trace.bound_symbols.append(bsym)
             else:
                 raise NotImplementedError(f"Unpacking from BINARY_SUBSCR with elaborate inputs {inputs=} {provenance}")
             return output
 
         def from_opaque(provenance, *, new_output=False):
@@ -1262,15 +1325,14 @@
             if unpack_fn is None:
                 raise NotImplementedError(f"Unpacking from {inst} {provenance}")
             res = unpack_fn(provenance, new_output=new_output)
             provenance.proxy = res
             return res
 
         assert isinstance(p.history, ProvenanceRecord), p.history
-        param_ordering[id(p)] = (p, [])
         with tracectx(prologue_trace):
             try:
                 from_provenance(p.history)
             except Exception as e:
                 raise NotImplementedError(f"Exception occured unpacking object from {p.history}") from e
 
         already_unpacked[id(p)] = p
@@ -1391,15 +1453,23 @@
         if pg is not None and found_pg is None:
             found_pg = pg
         elif pg is not None and pg != found_pg:
             raise NotImplementedError("jitting modules with different ProcessGroup is not supported currently.")
     return found_pg
 
 
-def thunder_general_jit(fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS) -> TraceResults:
+def thunder_general_jit(
+    fn: Callable,
+    args: tuple[Any, ...],
+    kwargs: dict[str, Any],
+    /,
+    *,
+    record_history: bool = False,
+    sharp_edges: SHARP_EDGES_OPTIONS,
+) -> TraceResults:
     # TODO: move into wrap_callback or so
     if isinstance(fn, torch.nn.parallel.DistributedDataParallel):
         raise NotImplementedError(
             f"jitting DistributedDataParallel modules is not supported compile the module and then wrap in DDP"
         )
 
     co: CACHE_OPTIONS = get_cache_option()
@@ -1428,22 +1498,22 @@
     )
     jfn = interpret(
         fn,
         fn_lookaside=general_jit_lookaside,
         callbacks=general_jit_callbacks,
         with_provenance_tracking=True,
         uncacheable_classes=(torch.Tensor, int, float, str, NoneType),
+        record_history=record_history,
     )
 
     with general_jit_ctx(ctx):
         with tracectx(computation_trace):
             result = jfn(*args, **kwargs)
             prims.python_return(result)
             process_recorded_modifications(ctx, epilogue_trace)
-
             last_interpreter_log = jfn._last_interpreter_log
 
     pro_to_comp, computation_intermediates = get_computation_inputs_and_intermediates(computation_trace)
 
     epilogue_inputs, _ = get_computation_inputs_and_intermediates(epilogue_trace)
 
     comp_to_epi = []
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/langctxs.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/langctxs.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/options.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/options.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/patterns.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/patterns.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/prims.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/prims.py`

 * *Files 2% similar despite different names*

```diff
@@ -115,14 +115,16 @@
     UNPACK_NEXT = auto()
     UNPACK_KEY = auto()
     UNPACK_SEQUENCE = auto()
     UNPACK_TRIVIAL = auto()
     UNPACK_TUPLE = auto()
     UNPACK_LIST = auto()
     UNPACK_DICT_KEY = auto()
+    UNPACK_PARAMETER = auto()
+    UNPACK_BUFFER = auto()
     CONSTRUCT_TUPLE = auto()
     PACK_SETITEM = auto()
     # TODO: UNPACK_SET
     # Utility prims
     COMMENT = auto()
     DEL = auto()
     PRINT = auto()
@@ -230,14 +232,15 @@
     SUM = auto()
     VAR = auto()
     VAR_MEAN = auto()
     ARGMAX = auto()
     ARGMIN = auto()
     TOPK = auto()
     # Scatter and gather prims (Experimental!)
+    GATHER = auto()
     INDEX_ADD = auto()
     INDEX_PUT = auto()
     SCATTER_ADD = auto()
     TAKE = auto()
     TAKE_ALONG_AXIS = auto()
     # Linear algebra prims (Mostly experimental)
     MATMUL = auto()
@@ -944,14 +947,96 @@
     "unpack_attr",
     meta=unpack_attr_meta,
     python_printer=unpack_attr_printer,
     python_impl=unpack_attr_impl,
 )
 
 
+# NOTE UNPACK_PARAMETER is intended only to be bound to directly, and not called
+def unpack_parameter_meta(o: Any, key: str) -> Any:
+    raise NotImplementedError
+
+
+def unpack_parameter_printer(
+    bsym: BoundSymbol, out_printables: Any, arg_printables: Sequence[Printable], kwarg_printables: dict[str, Printable]
+):
+    utils.check(
+        len(arg_printables) == 2,
+        lambda: f"Expected two arguments for unpack_attr but got {arg_printables}",
+        exception_type=AssertionError,
+    )
+    utils.check(
+        len(kwarg_printables) == 0,
+        lambda: f"Expected no kwargs for unpack_attr but got {kwarg_printables}",
+        exception_type=AssertionError,
+    )
+
+    # Converts printables to strings
+    origin, key = arg_printables
+    origin_str = codeutils.prettyprint(origin)
+    keystr = codeutils.prettyprint(key)
+    outstr = codeutils.prettyprint(out_printables, with_type=True, literals_as_underscores=True)
+
+    return f"{outstr} = {origin_str}.get_parameter({keystr})"
+
+
+def unpack_parameter_impl(o: Any, key: str) -> Any:
+    return o.get_parameter(key)
+
+
+unpack_parameter = make_prim(
+    PrimIDs.UNPACK_PARAMETER,
+    "unpack_parameter",
+    meta=unpack_parameter_meta,
+    python_printer=unpack_parameter_printer,
+    python_impl=unpack_parameter_impl,
+)
+
+
+# NOTE UNPACK_BUFFER is intended only to be bound to directly, and not called
+def unpack_buffer_meta(o: Any, key: str) -> Any:
+    raise NotImplementedError
+
+
+def unpack_buffer_printer(
+    bsym: BoundSymbol, out_printables: Any, arg_printables: Sequence[Printable], kwarg_printables: dict[str, Printable]
+):
+    utils.check(
+        len(arg_printables) == 2,
+        lambda: f"Expected two arguments for unpack_attr but got {arg_printables}",
+        exception_type=AssertionError,
+    )
+    utils.check(
+        len(kwarg_printables) == 0,
+        lambda: f"Expected no kwargs for unpack_attr but got {kwarg_printables}",
+        exception_type=AssertionError,
+    )
+
+    # Converts printables to strings
+    origin, key = arg_printables
+    origin_str = codeutils.prettyprint(origin)
+    keystr = codeutils.prettyprint(key)
+    outstr = codeutils.prettyprint(out_printables, with_type=True, literals_as_underscores=True)
+
+    return f"{outstr} = {origin_str}.get_buffer({keystr})"
+
+
+def unpack_buffer_impl(o: Any, key: str) -> Any:
+    return o.get_buffer(key)
+
+
+unpack_buffer = make_prim(
+    PrimIDs.UNPACK_BUFFER,
+    "unpack_buffer",
+    meta=unpack_buffer_meta,
+    python_printer=unpack_buffer_printer,
+    python_impl=unpack_buffer_impl,
+)
+
+
 # NOTE PACK_SETITEM is intended only to be bound to directly, and not called
 def pack_setitem_meta(o: Any, key: Any, value: Any) -> Any:
     raise NotImplementedError
 
 
 def pack_setitem_printer(
     bsym: BoundSymbol, out_printables: Any, arg_printables: Sequence[Printable], kwarg_printables: dict[str, Printable]
@@ -972,15 +1057,15 @@
     obj_str = codeutils.prettyprint(obj)
     key_str = codeutils.prettyprint(key)
     value_str = codeutils.prettyprint(value)
     return f"{obj_str}[{key_str}] = {value_str}"
 
 
 def pack_setitem_impl(o: Any, key: Any, v: Any) -> None:
-    o[key] = value
+    o[key] = v
     return None
 
 
 pack_setitem = make_prim(
     PrimIDs.PACK_SETITEM,
     "unpack_setitem",
     meta=pack_setitem_meta,
@@ -2994,14 +3079,37 @@
 
     return TensorProxy(like=a, shape=index.shape)
 
 
 take_along_axis = make_prim(PrimIDs.TAKE_ALONG_AXIS, "take_along_axis", meta=take_along_axis_meta)
 
 
+def gather_meta(a: TensorProxy, /, index: TensorProxy, dim: int) -> TensorProxy:
+    utils.check_type(a, TensorProxy)
+    utils.check_type(index, TensorProxy)
+    utils.check_type(dim, int)
+    utils.check_same_device(a, index)
+    utils.check(utils.is_integer_dtype(index.dtype), lambda: f"index dtype={index.dtype} was not an integer dtype")
+    utils.check(
+        index.ndim == a.ndim, lambda: f"Expected index (rank={index.ndim}) to have the same rank as a (rank={a.ndim})"
+    )
+    utils.validate_idx(a.ndim, dim)
+
+    for idx, l in enumerate(index.shape):
+        if idx != dim:
+            utils.check(
+                index.shape[idx] <= a.shape[idx],
+                lambda: f"Expected 'index' size on all dimensions to be <= 'a', except `dim`. Found dim {idx}, where 'index' has {index.shape[idx]} and 'a' has {a.shape[idx]}",
+            )
+    return TensorProxy(like=a, shape=index.shape)
+
+
+gather = make_prim(PrimIDs.GATHER, "gather", meta=gather_meta)
+
+
 def scatter_add_meta(a: TensorProxy, /, index: TensorProxy, value: TensorProxy, dim: int) -> TensorProxy:
     utils.check_type(a, TensorProxy)
     utils.check_type(index, TensorProxy)
     utils.check_type(value, TensorProxy)
     utils.check_type(dim, int)
     utils.check_same_device(a, index, value)
     utils.check_same_dtype(a, value)
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/profile.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/profile.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/proxies.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/proxies.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/pytree.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/pytree.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/rematerialization.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/rematerialization.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/symbol.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/symbol.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/trace.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/trace.py`

 * *Files 2% similar despite different names*

```diff
@@ -47,15 +47,15 @@
     def __init__(self, fn: None | Callable = None, *, prologue=None, is_prologue: bool = False):
         self.fn: None | Callable = fn
 
         self._prologue = prologue
         self._is_prologue: bool = is_prologue
 
         self.args = None
-        self.kwargs = None
+        self.kwargs = {}
 
         self.bound_symbols: list[BoundSymbolInterface] = []
         self.scopes = [self.bound_symbols]
 
         self.name_ctr = 0
         self.obj_name_ctr = 0
         self.names = set()
@@ -306,15 +306,15 @@
 
         return import_ctx
 
     # TODO Account for multi-line signatures
     # TODO issue "Add type annotations to Python function produced by traces"
     #   Consider extending the signature with type information, in particular the
     #   the type information of the return value might be interesting
-    def python(self, *, print_depth: int = 1) -> str:
+    def python(self, *, print_depth: int = 1, include_decorators: bool = True) -> str:
         token = set_tracectx(self)
 
         try:
             # Acquires ctx and imports from the BoundSymbols...
             import_ctx, call_ctx, object_ctx = self._gather_ctxs()
 
             # ... and from the signature
@@ -358,33 +358,41 @@
                     module: ModuleType = class_or_module
                     if module.__name__ == name:
                         import_str = f"import {module.__name__}"
                     else:
                         import_str = f"import {module.__name__} as {name}"
                 program.append(import_str)
 
-            program.append("from thunder.executors.torchex import no_autocast")
+            if include_decorators:
+                program.append("from thunder.executors.torchex import no_autocast")
+
             # Separates imports from the function for readability
             if len(import_ctx) > 0:
                 program.append("")
 
-            # Prints the signature and the no_grad context (for when calling torch operations)
-            program.append("@torch.no_grad()")
-            # Prints the signature and the no_autocast context
-            program.append("@no_autocast()")
-
-            # NOTE: For TransformerEngine executor, we want to wrap the generated
-            # forward function in fp8_autocast ctx manager.
-            # In future, if other executor has similar requirements, we should
-            # add a new extension point for executors
-            from thunder.executors.transformer_engineex import _is_te_linear_enabled, _get_te_wrapper_string
-
-            if self._include_te_fp8_autocast and _is_te_linear_enabled(import_ctx, object_ctx):
-                program.append(_get_te_wrapper_string())
+            if include_decorators:
+                # NOTE: For TransformerEngine executor, we want to wrap the generated
+                # forward function in fp8_autocast ctx manager.
+                # In the future, if other executor has similar requirements, we should
+                # add a new extension point for executors
+                # NOTE: For TE v1.6 onwards, `fp8_autocast` checks if `torch.is_grad_enabled` for updating
+                # the FP8 scales/inverses. So this decorator should be applied before `torch.no_grad` (so that
+                # it is in grad enabled part).
+                from thunder.executors.transformer_engineex import _is_te_linear_enabled, _get_te_wrapper_string
+
+                if self._include_te_fp8_autocast and _is_te_linear_enabled(import_ctx, object_ctx):
+                    program.append(_get_te_wrapper_string())
+
+                # Disable gradients since Thunder takes care of this (for when calling torch operations)
+                program.append("@torch.no_grad()")
+                # Disable autocast since we already generated the trace with it in consideration (for when calling torch
+                # operations)
+                program.append("@no_autocast")
 
+            # Prints the signature
             program.append(signature_str)
 
             # TODO Print objects from context
             # Prints constants (if any) upfront
             # constants = tuple(om for om in self._object_meta_map.values() if om.is_constant)
             # if len(constants) > 0:
             #     const_comment_str = f"{indent}# Initializes constants"
@@ -407,30 +415,30 @@
             return python
         finally:
             reset_tracectx(token)
 
     # Returns a Python callable that executes the trace
     # TODO issue "Create a mechanism for freezing TraceCtx objects"
     #   Create a mechanism for freezing traces and cache the compilation
-    def python_callable(self, *, global_dicts: None | dict = None) -> Callable:
+    def python_callable(self, *, global_dicts: None | dict = None, **kwargs: Any) -> Callable:
         python_str: str
 
         # Writes the program to allow it to be edited before execution
         path: None | str = _get_execution_file()
         if path is not None:
             f = open(path, "w")
-            f.write(self.python())
+            f.write(self.python(**kwargs))
             f.close()
 
             input(f"Trace written to {os.path.realpath(path)}  Press Any key to execute it")
 
             with open(path) as file:
                 python_str = file.read()
         else:
-            python_str = self.python()
+            python_str = self.python(**kwargs)
 
         ctx = self.python_ctx()
         if global_dicts is not None:
             ctx["__global_dicts"] = global_dicts
         ctx["__function_obj"] = self.fn
         ctx["thunder"] = thunder
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/transform_common.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/transform_common.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/transforms.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/transforms.py`

 * *Files 1% similar despite different names*

```diff
@@ -1696,7040 +1696,7081 @@
 000069f0: 6e64 6578 2c20 672c 2064 696d 290a 2020  ndex, g, dim).  
 00006a00: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
 00006a10: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
 00006a20: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
 00006a30: 5f67 7261 6428 7069 6473 2e54 414b 452c  _grad(pids.TAKE,
 00006a40: 205f 7461 6b65 5f70 7269 6d5f 6772 6164   _take_prim_grad
 00006a50: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
-00006a60: 6620 5f74 616b 655f 616c 6f6e 675f 6178  f _take_along_ax
-00006a70: 6973 5f70 7269 6d5f 6772 6164 2861 3a20  is_prim_grad(a: 
-00006a80: 5465 6e73 6f72 5072 6f78 792c 2069 6e64  TensorProxy, ind
-00006a90: 6578 3a20 5465 6e73 6f72 5072 6f78 792c  ex: TensorProxy,
-00006aa0: 2064 696d 3a20 696e 7429 202d 3e20 5465   dim: int) -> Te
-00006ab0: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
-00006ac0: 7764 203d 2070 7269 6d73 2e74 616b 655f  wd = prims.take_
-00006ad0: 616c 6f6e 675f 6178 6973 2861 2c20 696e  along_axis(a, in
-00006ae0: 6465 782c 2064 696d 290a 0a20 2020 2067  dex, dim)..    g
-00006af0: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
-00006b00: 0a20 2020 2023 204e 4f54 4520 496e 7465  .    # NOTE Inte
-00006b10: 6e74 696f 6e61 6c6c 7920 6e6f 7420 6361  ntionally not ca
-00006b20: 6c6c 696e 6720 7a65 726f 735f 6c69 6b65  lling zeros_like
-00006b30: 2074 6f20 6176 6f69 6420 7072 6573 6572   to avoid preser
-00006b40: 7669 6e67 2061 0a20 2020 2023 2054 4f44  ving a.    # TOD
-00006b50: 4f20 5570 6461 7465 2074 6f20 6361 6c6c  O Update to call
-00006b60: 206c 746f 7263 682e 7a65 726f 730a 2020   ltorch.zeros.  
-00006b70: 2020 7a65 726f 7320 3d20 7072 696d 732e    zeros = prims.
-00006b80: 6675 6c6c 2861 2e73 6861 7065 2c20 6669  full(a.shape, fi
-00006b90: 6c6c 5f76 616c 7565 3d30 2c20 6465 7669  ll_value=0, devi
-00006ba0: 6365 3d61 2e64 6576 6963 652c 2064 7479  ce=a.device, dty
-00006bb0: 7065 3d61 2e64 7479 7065 290a 2020 2020  pe=a.dtype).    
-00006bc0: 615f 6772 6164 203d 2070 7269 6d73 2e73  a_grad = prims.s
-00006bd0: 6361 7474 6572 5f61 6464 287a 6572 6f73  catter_add(zeros
-00006be0: 2c20 696e 6465 782c 2067 2c20 6469 6d29  , index, g, dim)
-00006bf0: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
-00006c00: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
-00006c10: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00006c20: 7465 725f 6772 6164 2870 6964 732e 5441  ter_grad(pids.TA
-00006c30: 4b45 5f41 4c4f 4e47 5f41 5849 532c 205f  KE_ALONG_AXIS, _
-00006c40: 7461 6b65 5f61 6c6f 6e67 5f61 7869 735f  take_along_axis_
-00006c50: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
-00006c60: 7263 6863 7478 0a64 6566 205f 7472 616e  rchctx.def _tran
-00006c70: 7370 6f73 655f 7072 696d 5f67 7261 6428  spose_prim_grad(
-00006c80: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
-00006c90: 7065 726d 7574 6174 696f 6e3a 2074 7570  permutation: tup
-00006ca0: 6c65 5b69 6e74 2c20 2e2e 2e5d 2920 2d3e  le[int, ...]) ->
-00006cb0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-00006cc0: 2020 6677 6420 3d20 7072 696d 732e 7472    fwd = prims.tr
-00006cd0: 616e 7370 6f73 6528 612c 2074 7570 6c65  anspose(a, tuple
-00006ce0: 2870 6572 6d75 7461 7469 6f6e 2929 0a0a  (permutation))..
-00006cf0: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
-00006d00: 2866 7764 290a 2020 2020 756e 646f 203d  (fwd).    undo =
-00006d10: 205f 6172 6773 6f72 7428 7065 726d 7574   _argsort(permut
-00006d20: 6174 696f 6e29 0a20 2020 2061 5f67 7261  ation).    a_gra
-00006d30: 6420 3d20 7072 696d 732e 7472 616e 7370  d = prims.transp
-00006d40: 6f73 6528 672c 2074 7570 6c65 2875 6e64  ose(g, tuple(und
-00006d50: 6f29 290a 2020 2020 7075 745f 6772 6164  o)).    put_grad
-00006d60: 2861 2c20 615f 6772 6164 290a 0a20 2020  (a, a_grad)..   
-00006d70: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
-00006d80: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
-00006d90: 2e54 5241 4e53 504f 5345 2c20 5f74 7261  .TRANSPOSE, _tra
-00006da0: 6e73 706f 7365 5f70 7269 6d5f 6772 6164  nspose_prim_grad
-00006db0: 290a 0a23 0a23 204d 656d 6f72 7920 6c61  )..#.# Memory la
-00006dc0: 796f 7574 206f 7065 7261 746f 7220 6772  yout operator gr
-00006dd0: 6164 730a 230a 0a0a 4074 6f72 6368 6374  ads.#...@torchct
-00006de0: 780a 6465 6620 5f73 7472 6964 655f 6f72  x.def _stride_or
-00006df0: 6465 725f 7072 696d 5f67 7261 6428 613a  der_prim_grad(a:
-00006e00: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
-00006e10: 206f 7264 6572 3a20 5365 7175 656e 6365   order: Sequence
-00006e20: 5b69 6e74 5d29 202d 3e20 5465 6e73 6f72  [int]) -> Tensor
-00006e30: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-00006e40: 2070 7269 6d73 2e73 7472 6964 655f 6f72   prims.stride_or
-00006e50: 6465 7228 612c 206f 7264 6572 290a 0a20  der(a, order).. 
-00006e60: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00006e70: 6677 6429 0a20 2020 2070 7574 5f67 7261  fwd).    put_gra
-00006e80: 6428 612c 2067 290a 0a20 2020 2072 6574  d(a, g)..    ret
-00006e90: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00006ea0: 6572 5f67 7261 6428 7069 6473 2e53 5452  er_grad(pids.STR
-00006eb0: 4944 455f 4f52 4445 522c 205f 7374 7269  IDE_ORDER, _stri
-00006ec0: 6465 5f6f 7264 6572 5f70 7269 6d5f 6772  de_order_prim_gr
-00006ed0: 6164 290a 0a0a 230a 2320 456c 656d 656e  ad)...#.# Elemen
-00006ee0: 7477 6973 6520 756e 6172 7920 6f70 6572  twise unary oper
-00006ef0: 6174 6f72 2067 7261 6473 0a23 0a40 746f  ator grads.#.@to
-00006f00: 7263 6863 7478 0a64 6566 205f 6162 735f  rchctx.def _abs_
-00006f10: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
-00006f20: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-00006f30: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
-00006f40: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-00006f50: 6677 6420 3d20 7072 696d 732e 6162 7328  fwd = prims.abs(
-00006f60: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
-00006f70: 6772 6164 2866 7764 290a 2020 2020 7075  grad(fwd).    pu
-00006f80: 745f 6772 6164 2861 2c20 6720 2a20 6c74  t_grad(a, g * lt
-00006f90: 6f72 6368 2e73 6967 6e28 6129 290a 0a20  orch.sign(a)).. 
-00006fa0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-00006fb0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00006fc0: 6473 2e41 4253 2c20 5f61 6273 5f70 7269  ds.ABS, _abs_pri
-00006fd0: 6d5f 6772 6164 290a 0a0a 6465 6620 5f63  m_grad)...def _c
-00006fe0: 6f73 5f70 7269 6d5f 6772 6164 2861 3a20  os_prim_grad(a: 
-00006ff0: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-00007000: 726f 7879 2920 2d3e 204e 756d 6265 7220  roxy) -> Number 
-00007010: 7c20 5465 6e73 6f72 5072 6f78 793a 0a20  | TensorProxy:. 
-00007020: 2020 2066 7764 203d 2070 7269 6d73 2e63     fwd = prims.c
-00007030: 6f73 2861 290a 0a20 2020 2067 203d 2067  os(a)..    g = g
-00007040: 6574 5f67 7261 6428 6677 6429 0a20 2020  et_grad(fwd).   
-00007050: 2070 7574 5f67 7261 6428 612c 2067 202a   put_grad(a, g *
-00007060: 2028 2d70 7269 6d73 2e73 696e 2861 2929   (-prims.sin(a))
-00007070: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00007080: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-00007090: 6428 7069 6473 2e43 4f53 2c20 5f63 6f73  d(pids.COS, _cos
-000070a0: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
-000070b0: 6f72 6368 6374 780a 6465 6620 5f65 7266  orchctx.def _erf
-000070c0: 5f70 7269 6d5f 6772 6164 2861 3a20 4e75  _prim_grad(a: Nu
-000070d0: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-000070e0: 7879 2920 2d3e 204e 756d 6265 7220 7c20  xy) -> Number | 
-000070f0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00007100: 2066 7764 203d 2070 7269 6d73 2e65 7266   fwd = prims.erf
-00007110: 2861 290a 0a20 2020 2067 203d 2067 6574  (a)..    g = get
-00007120: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
-00007130: 5f67 7261 6420 3d20 3220 2f20 6d61 7468  _grad = 2 / math
-00007140: 2e73 7172 7428 6d61 7468 2e70 6929 202a  .sqrt(math.pi) *
-00007150: 206c 746f 7263 682e 6578 7028 2d28 612a   ltorch.exp(-(a*
-00007160: 2a32 2929 202a 2067 0a20 2020 2070 7574  *2)) * g.    put
-00007170: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
-00007180: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00007190: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-000071a0: 2870 6964 732e 4552 462c 205f 6572 665f  (pids.ERF, _erf_
-000071b0: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
-000071c0: 7263 6863 7478 0a64 6566 205f 6578 705f  rchctx.def _exp_
-000071d0: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
-000071e0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-000071f0: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
-00007200: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-00007210: 6677 6420 3d20 7072 696d 732e 6578 7028  fwd = prims.exp(
-00007220: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
-00007230: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
-00007240: 6772 6164 203d 2067 202a 2066 7764 0a20  grad = g * fwd. 
-00007250: 2020 2070 7574 5f67 7261 6428 612c 2061     put_grad(a, a
-00007260: 5f67 7261 6429 0a0a 2020 2020 7265 7475  _grad)..    retu
-00007270: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-00007280: 725f 6772 6164 2870 6964 732e 4558 502c  r_grad(pids.EXP,
-00007290: 205f 6578 705f 7072 696d 5f67 7261 6429   _exp_prim_grad)
-000072a0: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
-000072b0: 205f 6c6f 675f 7072 696d 5f67 7261 6428   _log_prim_grad(
-000072c0: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
-000072d0: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
-000072e0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-000072f0: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00007300: 732e 6c6f 6728 6129 0a0a 2020 2020 6720  s.log(a)..    g 
-00007310: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-00007320: 2020 2020 615f 6772 6164 203d 2067 202f      a_grad = g /
-00007330: 2061 0a20 2020 2070 7574 5f67 7261 6428   a.    put_grad(
-00007340: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
-00007350: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
-00007360: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00007370: 4c4f 472c 205f 6c6f 675f 7072 696d 5f67  LOG, _log_prim_g
-00007380: 7261 6429 0a0a 0a40 746f 7263 6863 7478  rad)...@torchctx
-00007390: 0a64 6566 205f 6e65 675f 7072 696d 5f67  .def _neg_prim_g
-000073a0: 7261 6428 613a 204e 756d 6265 7220 7c20  rad(a: Number | 
-000073b0: 5465 6e73 6f72 5072 6f78 7929 202d 3e20  TensorProxy) -> 
-000073c0: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-000073d0: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
-000073e0: 7072 696d 732e 6e65 6728 6129 0a0a 2020  prims.neg(a)..  
-000073f0: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00007400: 7764 290a 2020 2020 7075 745f 6772 6164  wd).    put_grad
-00007410: 2861 2c20 2d67 290a 0a20 2020 2072 6574  (a, -g)..    ret
-00007420: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00007430: 6572 5f67 7261 6428 7069 6473 2e4e 4547  er_grad(pids.NEG
-00007440: 2c20 5f6e 6567 5f70 7269 6d5f 6772 6164  , _neg_prim_grad
-00007450: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
-00007460: 6620 5f72 7371 7274 5f70 7269 6d5f 6772  f _rsqrt_prim_gr
-00007470: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
-00007480: 656e 736f 7250 726f 7879 2c20 2f29 202d  ensorProxy, /) -
-00007490: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
-000074a0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-000074b0: 3d20 7072 696d 732e 7273 7172 7428 6129  = prims.rsqrt(a)
-000074c0: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
-000074d0: 6164 2866 7764 290a 2020 2020 2320 416e  ad(fwd).    # An
-000074e0: 2061 6c74 6572 6e61 7469 7665 2064 6572   alternative der
-000074f0: 6976 6174 696f 6e20 7573 6564 2062 7920  ivation used by 
-00007500: 4a41 5820 6973 202d 302e 3520 2a20 6720  JAX is -0.5 * g 
-00007510: 2a20 7273 7172 7428 7829 202f 2078 0a20  * rsqrt(x) / x. 
-00007520: 2020 2023 2077 6865 7265 2072 7371 7274     # where rsqrt
-00007530: 2878 2920 616e 6420 7820 6172 6520 7361  (x) and x are sa
-00007540: 7665 6420 666f 7220 7468 6520 6261 636b  ved for the back
-00007550: 7761 7264 7320 7061 7373 2e0a 2020 2020  wards pass..    
-00007560: 2320 5468 6973 2064 6572 6976 6174 696f  # This derivatio
-00007570: 6e20 7761 7320 7365 6c65 6374 6564 2062  n was selected b
-00007580: 6563 6175 7365 2069 7420 6176 6f69 6473  ecause it avoids
-00007590: 2073 6176 696e 6720 7468 6520 696e 7075   saving the inpu
-000075a0: 7420 7465 6e73 6f72 2e0a 2020 2020 615f  t tensor..    a_
-000075b0: 6772 6164 203d 202d 302e 3520 2a20 6720  grad = -0.5 * g 
-000075c0: 2a20 6677 642a 2a33 2e30 0a20 2020 2070  * fwd**3.0.    p
-000075d0: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
-000075e0: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
-000075f0: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
-00007600: 6164 2870 6964 732e 5253 5152 542c 205f  ad(pids.RSQRT, _
-00007610: 7273 7172 745f 7072 696d 5f67 7261 6429  rsqrt_prim_grad)
-00007620: 0a0a 0a64 6566 205f 7369 6e5f 7072 696d  ...def _sin_prim
-00007630: 5f67 7261 6428 613a 204e 756d 6265 7220  _grad(a: Number 
-00007640: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
-00007650: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
-00007660: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-00007670: 3d20 7072 696d 732e 7369 6e28 6129 0a0a  = prims.sin(a)..
-00007680: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
-00007690: 2866 7764 290a 2020 2020 7075 745f 6772  (fwd).    put_gr
-000076a0: 6164 2861 2c20 6720 2a20 7072 696d 732e  ad(a, g * prims.
-000076b0: 636f 7328 6129 290a 0a20 2020 2072 6574  cos(a))..    ret
-000076c0: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-000076d0: 6572 5f67 7261 6428 7069 6473 2e53 494e  er_grad(pids.SIN
-000076e0: 2c20 5f73 696e 5f70 7269 6d5f 6772 6164  , _sin_prim_grad
-000076f0: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
-00007700: 6620 5f74 616e 685f 7072 696d 5f67 7261  f _tanh_prim_gra
-00007710: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
-00007720: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
-00007730: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-00007740: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-00007750: 2070 7269 6d73 2e74 616e 6828 6129 0a0a   prims.tanh(a)..
-00007760: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
-00007770: 2866 7764 290a 2020 2020 615f 6772 6164  (fwd).    a_grad
-00007780: 203d 2067 202a 2028 3120 2d20 6677 6420   = g * (1 - fwd 
-00007790: 2a20 6677 6429 0a20 2020 2070 7574 5f67  * fwd).    put_g
-000077a0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
-000077b0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-000077c0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-000077d0: 6964 732e 5441 4e48 2c20 5f74 616e 685f  ids.TANH, _tanh_
-000077e0: 7072 696d 5f67 7261 6429 0a0a 230a 2320  prim_grad)..#.# 
-000077f0: 456c 656d 656e 7477 6973 6520 6269 6e61  Elementwise bina
-00007800: 7279 206f 7065 7261 746f 7220 6772 6164  ry operator grad
-00007810: 730a 230a 0a0a 4074 6f72 6368 6374 780a  s.#...@torchctx.
-00007820: 6465 6620 5f61 6464 5f70 7269 6d5f 6772  def _add_prim_gr
-00007830: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
-00007840: 656e 736f 7250 726f 7879 2c20 623a 204e  ensorProxy, b: N
-00007850: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-00007860: 6f78 792c 202f 2920 2d3e 204e 756d 6265  oxy, /) -> Numbe
-00007870: 7220 7c20 5465 6e73 6f72 5072 6f78 793a  r | TensorProxy:
-00007880: 0a20 2020 2066 7764 203d 2061 202b 2062  .    fwd = a + b
-00007890: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
-000078a0: 6164 2866 7764 290a 2020 2020 615f 6772  ad(fwd).    a_gr
-000078b0: 6164 203d 2067 0a20 2020 2062 5f67 7261  ad = g.    b_gra
-000078c0: 6420 3d20 670a 2020 2020 7075 745f 6772  d = g.    put_gr
-000078d0: 6164 7328 2861 2c20 6229 2c20 2861 5f67  ads((a, b), (a_g
-000078e0: 7261 642c 2062 5f67 7261 6429 290a 0a20  rad, b_grad)).. 
-000078f0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-00007900: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00007910: 6473 2e41 4444 2c20 5f61 6464 5f70 7269  ds.ADD, _add_pri
-00007920: 6d5f 6772 6164 290a 0a0a 2320 4e4f 5445  m_grad)...# NOTE
-00007930: 2054 6865 2066 6f6c 6c6f 7769 6e67 2067   The following g
-00007940: 7261 6420 6465 6669 6e69 7469 6f6e 2072  rad definition r
-00007950: 656c 6965 7320 6f6e 2074 6865 2066 6163  elies on the fac
-00007960: 7420 7468 6174 206f 6e6c 7920 696e 6578  t that only inex
-00007970: 6163 7420 6474 7970 6573 2061 7265 2064  act dtypes are d
-00007980: 6966 6665 7265 6e74 6961 626c 652c 0a23  ifferentiable,.#
-00007990: 2020 2061 6e64 2074 6f72 6368 2773 2074     and torch's t
-000079a0: 7275 6520 6469 7669 7369 6f6e 206f 7065  rue division ope
-000079b0: 7261 746f 7220 616e 6420 7468 6520 6469  rator and the di
-000079c0: 7669 7369 6f6e 2070 7269 6d69 7469 7665  vision primitive
-000079d0: 2061 6772 6565 206f 6e20 7468 6f73 6520   agree on those 
-000079e0: 7479 7065 730a 4074 6f72 6368 6374 780a  types.@torchctx.
-000079f0: 6465 6620 5f64 6976 5f70 7269 6d5f 6772  def _div_prim_gr
-00007a00: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
-00007a10: 656e 736f 7250 726f 7879 2c20 623a 204e  ensorProxy, b: N
-00007a20: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-00007a30: 6f78 792c 202f 2920 2d3e 204e 756d 6265  oxy, /) -> Numbe
-00007a40: 7220 7c20 5465 6e73 6f72 5072 6f78 793a  r | TensorProxy:
-00007a50: 0a20 2020 2066 7764 203d 2061 202f 2062  .    fwd = a / b
-00007a60: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
-00007a70: 6164 2866 7764 290a 2020 2020 615f 6772  ad(fwd).    a_gr
-00007a80: 6164 203d 2067 202f 2062 0a20 2020 2062  ad = g / b.    b
-00007a90: 5f67 7261 6420 3d20 2d67 202a 2028 2861  _grad = -g * ((a
-00007aa0: 202f 2062 2920 2f20 6229 0a20 2020 2070   / b) / b).    p
-00007ab0: 7574 5f67 7261 6473 2828 612c 2062 292c  ut_grads((a, b),
-00007ac0: 2028 615f 6772 6164 2c20 625f 6772 6164   (a_grad, b_grad
-00007ad0: 2929 0a0a 2020 2020 7265 7475 726e 2066  ))..    return f
-00007ae0: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
-00007af0: 6164 2870 6964 732e 4449 562c 205f 6469  ad(pids.DIV, _di
-00007b00: 765f 7072 696d 5f67 7261 6429 0a0a 2320  v_prim_grad)..# 
-00007b10: 436f 6d70 6172 6973 6f6e 206f 7065 7261  Comparison opera
-00007b20: 746f 7273 202d 2d20 7468 6573 6520 6372  tors -- these cr
-00007b30: 6561 7465 206e 6f20 6772 6164 2061 7373  eate no grad ass
-00007b40: 6f63 6961 7469 6f6e 730a 7265 6769 7374  ociations.regist
-00007b50: 6572 5f67 7261 6428 7069 6473 2e45 512c  er_grad(pids.EQ,
-00007b60: 2070 7269 6d73 2e65 7129 0a72 6567 6973   prims.eq).regis
-00007b70: 7465 725f 6772 6164 2870 6964 732e 4745  ter_grad(pids.GE
-00007b80: 2c20 7072 696d 732e 6765 290a 7265 6769  , prims.ge).regi
-00007b90: 7374 6572 5f67 7261 6428 7069 6473 2e4c  ster_grad(pids.L
-00007ba0: 542c 2070 7269 6d73 2e6c 7429 0a0a 0a40  T, prims.lt)...@
-00007bb0: 746f 7263 6863 7478 0a64 6566 205f 6d75  torchctx.def _mu
-00007bc0: 6c5f 7072 696d 5f67 7261 6428 613a 204e  l_prim_grad(a: N
-00007bd0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-00007be0: 6f78 792c 2062 3a20 4e75 6d62 6572 207c  oxy, b: Number |
-00007bf0: 2054 656e 736f 7250 726f 7879 2c20 2f29   TensorProxy, /)
-00007c00: 202d 3e20 4e75 6d62 6572 207c 2054 656e   -> Number | Ten
-00007c10: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
-00007c20: 6420 3d20 6120 2a20 620a 0a20 2020 2067  d = a * b..    g
-00007c30: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
-00007c40: 0a20 2020 2061 5f67 7261 6420 3d20 6220  .    a_grad = b 
-00007c50: 2a20 670a 2020 2020 625f 6772 6164 203d  * g.    b_grad =
-00007c60: 2061 202a 2067 0a20 2020 2070 7574 5f67   a * g.    put_g
-00007c70: 7261 6473 2828 612c 2062 292c 2028 615f  rads((a, b), (a_
-00007c80: 6772 6164 2c20 625f 6772 6164 2929 0a0a  grad, b_grad))..
-00007c90: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00007ca0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00007cb0: 6964 732e 4d55 4c2c 205f 6d75 6c5f 7072  ids.MUL, _mul_pr
-00007cc0: 696d 5f67 7261 6429 0a0a 0a40 746f 7263  im_grad)...@torc
-00007cd0: 6863 7478 0a64 6566 205f 7375 625f 7072  hctx.def _sub_pr
-00007ce0: 696d 5f67 7261 6428 613a 204e 756d 6265  im_grad(a: Numbe
-00007cf0: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
-00007d00: 2062 3a20 4e75 6d62 6572 207c 2054 656e   b: Number | Ten
-00007d10: 736f 7250 726f 7879 2920 2d3e 204e 756d  sorProxy) -> Num
-00007d20: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-00007d30: 793a 0a20 2020 2066 7764 203d 2061 202d  y:.    fwd = a -
-00007d40: 2062 0a0a 2020 2020 6720 3d20 6765 745f   b..    g = get_
-00007d50: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
-00007d60: 6772 6164 203d 2067 0a20 2020 2062 5f67  grad = g.    b_g
-00007d70: 7261 6420 3d20 2d67 0a20 2020 2070 7574  rad = -g.    put
-00007d80: 5f67 7261 6473 2828 612c 2062 292c 2028  _grads((a, b), (
-00007d90: 615f 6772 6164 2c20 625f 6772 6164 2929  a_grad, b_grad))
-00007da0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00007db0: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00007dc0: 2870 6964 732e 5355 422c 205f 7375 625f  (pids.SUB, _sub_
-00007dd0: 7072 696d 5f67 7261 6429 0a0a 0a23 0a23  prim_grad)...#.#
-00007de0: 2043 6f6e 6469 7469 6f6e 616c 206f 7065   Conditional ope
-00007df0: 7261 746f 7220 6772 6164 730a 230a 0a0a  rator grads.#...
-00007e00: 6465 6620 5f77 6865 7265 5f70 7269 6d5f  def _where_prim_
-00007e10: 6772 6164 2870 7265 643a 204e 756d 6265  grad(pred: Numbe
-00007e20: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
-00007e30: 2061 3a20 4e75 6d62 6572 207c 2054 656e   a: Number | Ten
-00007e40: 736f 7250 726f 7879 2c20 623a 204e 756d  sorProxy, b: Num
-00007e50: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-00007e60: 7929 202d 3e20 5465 6e73 6f72 5072 6f78  y) -> TensorProx
-00007e70: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
-00007e80: 6d73 2e77 6865 7265 2870 7265 642c 2061  ms.where(pred, a
-00007e90: 2c20 6229 0a0a 2020 2020 6720 3d20 6765  , b)..    g = ge
-00007ea0: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-00007eb0: 615f 6772 6164 203d 206c 746f 7263 682e  a_grad = ltorch.
-00007ec0: 7768 6572 6528 7072 6564 2c20 672c 2030  where(pred, g, 0
-00007ed0: 290a 2020 2020 625f 6772 6164 203d 206c  ).    b_grad = l
-00007ee0: 746f 7263 682e 7768 6572 6528 7072 6564  torch.where(pred
-00007ef0: 2c20 302c 2067 290a 2020 2020 7075 745f  , 0, g).    put_
-00007f00: 6772 6164 7328 2861 2c20 6229 2c20 2861  grads((a, b), (a
-00007f10: 5f67 7261 642c 2062 5f67 7261 6429 290a  _grad, b_grad)).
-00007f20: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
-00007f30: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
-00007f40: 7069 6473 2e57 4845 5245 2c20 5f77 6865  pids.WHERE, _whe
-00007f50: 7265 5f70 7269 6d5f 6772 6164 290a 0a23  re_prim_grad)..#
-00007f60: 0a23 2052 6564 7563 7469 6f6e 206f 7065  .# Reduction ope
-00007f70: 7261 746f 7220 6772 6164 730a 230a 0a0a  rator grads.#...
-00007f80: 2320 544f 444f 2052 6576 6965 7720 7477  # TODO Review tw
-00007f90: 6561 6b69 6e67 2067 7261 645f 6368 6f6f  eaking grad_choo
-00007fa0: 7365 725f 7075 6c6c 6261 636b 2069 6e74  ser_pullback int
-00007fb0: 6572 6661 6365 0a64 6566 205f 616d 6178  erface.def _amax
-00007fc0: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
-00007fd0: 6e73 6f72 5072 6f78 792c 202f 2c20 6469  nsorProxy, /, di
-00007fe0: 6d73 3a20 5365 7175 656e 6365 5b69 6e74  ms: Sequence[int
-00007ff0: 5d29 202d 3e20 5465 6e73 6f72 5072 6f78  ]) -> TensorProx
-00008000: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
-00008010: 6d73 2e61 6d61 7828 612c 2064 696d 7329  ms.amax(a, dims)
-00008020: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
-00008030: 6164 2866 7764 290a 2020 2020 615f 6772  ad(fwd).    a_gr
-00008040: 6164 203d 2067 7261 645f 6368 6f6f 7365  ad = grad_choose
-00008050: 725f 6261 636b 7761 7264 2866 7764 2c20  r_backward(fwd, 
-00008060: 612c 2061 2e73 6861 7065 2c20 6469 6d73  a, a.shape, dims
-00008070: 2c20 6729 0a20 2020 2070 7574 5f67 7261  , g).    put_gra
-00008080: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
-00008090: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-000080a0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-000080b0: 732e 414d 4158 2c20 5f61 6d61 785f 7072  s.AMAX, _amax_pr
-000080c0: 696d 5f67 7261 6429 0a0a 0a64 6566 205f  im_grad)...def _
-000080d0: 7375 6d5f 7072 696d 5f67 7261 6428 613a  sum_prim_grad(a:
-000080e0: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
-000080f0: 2064 696d 733a 2053 6571 7565 6e63 655b   dims: Sequence[
-00008100: 696e 745d 2920 2d3e 2054 656e 736f 7250  int]) -> TensorP
-00008110: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
-00008120: 7072 696d 732e 7375 6d28 612c 2064 696d  prims.sum(a, dim
-00008130: 7329 0a0a 2020 2020 6720 3d20 6765 745f  s)..    g = get_
-00008140: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
-00008150: 6772 6164 203d 2072 6573 746f 7265 5f72  grad = restore_r
-00008160: 6564 7563 6564 5f64 696d 7328 672c 2064  educed_dims(g, d
-00008170: 696d 732c 2061 2e73 6861 7065 290a 2020  ims, a.shape).  
-00008180: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
-00008190: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
-000081a0: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
-000081b0: 5f67 7261 6428 7069 6473 2e53 554d 2c20  _grad(pids.SUM, 
-000081c0: 5f73 756d 5f70 7269 6d5f 6772 6164 290a  _sum_prim_grad).
-000081d0: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
-000081e0: 5f74 6f70 6b5f 7072 696d 5f67 7261 6428  _topk_prim_grad(
-000081f0: 0a20 2020 2061 3a20 5465 6e73 6f72 5072  .    a: TensorPr
-00008200: 6f78 792c 202f 2c20 6b3a 2069 6e74 2c20  oxy, /, k: int, 
-00008210: 6469 6d3a 204e 6f6e 6520 7c20 696e 7420  dim: None | int 
-00008220: 3d20 4e6f 6e65 2c20 6c61 7267 6573 743a  = None, largest:
-00008230: 2062 6f6f 6c20 3d20 5472 7565 2c20 736f   bool = True, so
-00008240: 7274 6564 3a20 626f 6f6c 203d 2054 7275  rted: bool = Tru
-00008250: 652c 202a 2c20 6f75 743d 4e6f 6e65 0a29  e, *, out=None.)
-00008260: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00008270: 732e 746f 706b 2861 2c20 6b2c 2064 696d  s.topk(a, k, dim
-00008280: 2c20 6c61 7267 6573 742c 2073 6f72 7465  , largest, sorte
-00008290: 642c 206f 7574 3d6f 7574 290a 2020 2020  d, out=out).    
-000082a0: 7661 6c2c 2069 6478 203d 2066 7764 0a0a  val, idx = fwd..
-000082b0: 2020 2020 7661 6c5f 6772 6164 203d 2067      val_grad = g
-000082c0: 6574 5f67 7261 6428 7661 6c29 0a0a 2020  et_grad(val)..  
-000082d0: 2020 615f 6772 6164 203d 206c 746f 7263    a_grad = ltorc
-000082e0: 682e 7a65 726f 735f 6c69 6b65 2861 290a  h.zeros_like(a).
-000082f0: 2020 2020 2320 544f 444f 3a20 7265 706c      # TODO: repl
-00008300: 6163 6520 7769 7468 2073 6361 7474 6572  ace with scatter
-00008310: 206f 6e63 6520 7765 2068 6176 6520 6974   once we have it
-00008320: 2e0a 2020 2020 2320 7363 6174 7465 725f  ..    # scatter_
-00008330: 6164 6420 6973 2061 2070 7269 6d20 616e  add is a prim an
-00008340: 6420 6974 2072 656c 6965 7320 6f6e 2061  d it relies on a
-00008350: 746f 6d69 6320 6f70 732e 0a20 2020 2061  tomic ops..    a
-00008360: 5f67 7261 6420 3d20 6c74 6f72 6368 2e73  _grad = ltorch.s
-00008370: 6361 7474 6572 5f61 6464 2861 5f67 7261  catter_add(a_gra
-00008380: 642c 2064 696d 2c20 6964 782c 2076 616c  d, dim, idx, val
-00008390: 5f67 7261 6429 0a20 2020 2070 7574 5f67  _grad).    put_g
-000083a0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
-000083b0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-000083c0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-000083d0: 6964 732e 544f 504b 2c20 5f74 6f70 6b5f  ids.TOPK, _topk_
-000083e0: 7072 696d 5f67 7261 6429 0a0a 0a23 2054  prim_grad)...# T
-000083f0: 4f44 4f20 4669 7820 6469 7669 7369 6f6e  ODO Fix division
-00008400: 2062 7920 7a65 726f 2077 6865 6e20 6e5f   by zero when n_
-00008410: 656c 656d 5f72 6564 7563 6564 203d 3d20  elem_reduced == 
-00008420: 3020 6f72 2077 6865 6e20 6d65 616e 2e6e  0 or when mean.n
-00008430: 756d 656c 203d 3d20 300a 2320 2020 6279  umel == 0.#   by
-00008440: 2072 6574 7572 6e69 6e67 207a 6572 6f73   returning zeros
-00008450: 5f6c 696b 6528 6129 206f 7220 7369 6d69  _like(a) or simi
-00008460: 6c61 722e 0a23 2054 4f44 4f20 4669 7820  lar..# TODO Fix 
-00008470: 6772 6164 2077 6865 6e20 636f 7272 6563  grad when correc
-00008480: 7469 6f6e 203e 206e 5f65 6c65 6d5f 7265  tion > n_elem_re
-00008490: 6475 6365 642e 0a40 746f 7263 6863 7478  duced..@torchctx
-000084a0: 0a64 6566 205f 7661 725f 6d65 616e 5f70  .def _var_mean_p
-000084b0: 7269 6d5f 6772 6164 2861 3a20 5465 6e73  rim_grad(a: Tens
-000084c0: 6f72 5072 6f78 792c 202f 2c20 6469 6d73  orProxy, /, dims
-000084d0: 3a20 5365 7175 656e 6365 5b69 6e74 5d2c  : Sequence[int],
-000084e0: 202a 2c20 636f 7272 6563 7469 6f6e 3a20   *, correction: 
-000084f0: 4e75 6d62 6572 2920 2d3e 2054 656e 736f  Number) -> Tenso
-00008500: 7250 726f 7879 3a0a 2020 2020 762c 206d  rProxy:.    v, m
-00008510: 203d 2070 7269 6d73 2e76 6172 5f6d 6561   = prims.var_mea
-00008520: 6e28 612c 2064 696d 732c 2063 6f72 7265  n(a, dims, corre
-00008530: 6374 696f 6e3d 636f 7272 6563 7469 6f6e  ction=correction
-00008540: 290a 0a20 2020 2067 7620 3d20 6765 745f  )..    gv = get_
-00008550: 6772 6164 2876 290a 2020 2020 676d 203d  grad(v).    gm =
-00008560: 2067 6574 5f67 7261 6428 6d29 0a0a 2020   get_grad(m)..  
-00008570: 2020 6e5f 656c 656d 5f72 6564 7563 6564    n_elem_reduced
-00008580: 203d 2061 2e6e 756d 656c 202f 2f20 6d2e   = a.numel // m.
-00008590: 6e75 6d65 6c20 6966 2061 2e6e 756d 656c  numel if a.numel
-000085a0: 2021 3d20 3020 656c 7365 2031 0a0a 2020   != 0 else 1..  
-000085b0: 2020 2320 436f 6d70 7574 6573 206d 6561    # Computes mea
-000085c0: 6e20 6277 640a 2020 2020 6d65 616e 5f73  n bwd.    mean_s
-000085d0: 6361 6c65 203d 2031 2e30 202f 206e 5f65  cale = 1.0 / n_e
-000085e0: 6c65 6d5f 7265 6475 6365 640a 2020 2020  lem_reduced.    
-000085f0: 6d65 616e 5f67 7261 6420 3d20 6d65 616e  mean_grad = mean
-00008600: 5f73 6361 6c65 202a 2072 6573 746f 7265  _scale * restore
-00008610: 5f72 6564 7563 6564 5f64 696d 7328 676d  _reduced_dims(gm
-00008620: 2c20 6469 6d73 2c20 612e 7368 6170 6529  , dims, a.shape)
-00008630: 0a0a 2020 2020 2320 436f 6d70 7574 6573  ..    # Computes
-00008640: 2076 6172 2062 7764 0a20 2020 206e 6f72   var bwd.    nor
-00008650: 6d61 6c69 7a61 7469 6f6e 5f73 6361 6c61  malization_scala
-00008660: 7220 3d20 6e5f 656c 656d 5f72 6564 7563  r = n_elem_reduc
-00008670: 6564 202d 2063 6f72 7265 6374 696f 6e0a  ed - correction.
-00008680: 2020 2020 7265 7374 6f72 6564 5f67 7620      restored_gv 
-00008690: 3d20 7265 7374 6f72 655f 7265 6475 6365  = restore_reduce
-000086a0: 645f 6469 6d73 2867 762c 2064 696d 732c  d_dims(gv, dims,
-000086b0: 2061 2e73 6861 7065 290a 2020 2020 2320   a.shape).    # 
-000086c0: 496e 7365 7274 696e 6720 6120 636f 6e76  Inserting a conv
-000086d0: 6572 7369 6f6e 2074 6f20 7468 6520 7361  ersion to the sa
-000086e0: 6d65 2064 7479 7065 2074 6f20 6469 7361  me dtype to disa
-000086f0: 626c 6520 6e76 4675 7365 7220 6578 6563  ble nvFuser exec
-00008700: 7574 6f72 7327 730a 2020 2020 2320 626f  utors's.    # bo
-00008710: 6f6b 656e 6420 6f70 7469 6d69 7a61 7469  okend optimizati
-00008720: 6f6e 2028 6e76 5f65 6e61 626c 655f 626f  on (nv_enable_bo
-00008730: 6f6b 656e 6429 2c20 7768 6963 6820 6361  okend), which ca
-00008740: 6e20 6361 7573 6520 7468 6520 6261 636b  n cause the back
-00008750: 7761 7264 0a20 2020 2023 2070 6173 7320  ward.    # pass 
-00008760: 746f 2067 656e 6572 6174 6520 7477 6f20  to generate two 
-00008770: 6b65 726e 656c 730a 2020 2020 6d65 616e  kernels.    mean
-00008780: 5f6d 6474 7970 6520 3d20 7072 696d 732e  _mdtype = prims.
-00008790: 636f 6e76 6572 745f 656c 656d 656e 745f  convert_element_
-000087a0: 7479 7065 286d 2c20 6d2e 6474 7970 6529  type(m, m.dtype)
-000087b0: 0a20 2020 2072 6573 746f 7265 645f 6d65  .    restored_me
-000087c0: 616e 203d 2072 6573 746f 7265 5f72 6564  an = restore_red
-000087d0: 7563 6564 5f64 696d 7328 6d65 616e 5f6d  uced_dims(mean_m
-000087e0: 6474 7970 652c 2064 696d 732c 2061 2e73  dtype, dims, a.s
-000087f0: 6861 7065 290a 2020 2020 7661 725f 6772  hape).    var_gr
-00008800: 6164 203d 2028 3220 2a20 7265 7374 6f72  ad = (2 * restor
-00008810: 6564 5f67 7620 2a20 2861 202d 2072 6573  ed_gv * (a - res
-00008820: 746f 7265 645f 6d65 616e 2929 202f 206e  tored_mean)) / n
-00008830: 6f72 6d61 6c69 7a61 7469 6f6e 5f73 6361  ormalization_sca
-00008840: 6c61 720a 0a20 2020 2070 7574 5f67 7261  lar..    put_gra
-00008850: 6428 612c 206d 6561 6e5f 6772 6164 202b  d(a, mean_grad +
-00008860: 2076 6172 5f67 7261 6429 0a0a 2020 2020   var_grad)..    
-00008870: 7265 7475 726e 2076 2c20 6d0a 0a0a 7265  return v, m...re
-00008880: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
-00008890: 2e56 4152 5f4d 4541 4e2c 205f 7661 725f  .VAR_MEAN, _var_
-000088a0: 6d65 616e 5f70 7269 6d5f 6772 6164 290a  mean_prim_grad).
-000088b0: 0a0a 230a 2320 4c69 6e65 6172 2061 6c67  ..#.# Linear alg
-000088c0: 6562 7261 206f 7065 7261 746f 7220 6772  ebra operator gr
-000088d0: 6164 730a 230a 4074 6f72 6368 6374 780a  ads.#.@torchctx.
-000088e0: 6465 6620 5f6c 696e 6561 725f 7072 696d  def _linear_prim
-000088f0: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
-00008900: 726f 7879 2c20 773a 2054 656e 736f 7250  roxy, w: TensorP
-00008910: 726f 7879 2c20 6269 6173 3a20 4e6f 6e65  roxy, bias: None
-00008920: 207c 2054 656e 736f 7250 726f 7879 2920   | TensorProxy) 
-00008930: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
-00008940: 2020 2020 6677 6420 3d20 7072 696d 732e      fwd = prims.
-00008950: 6c69 6e65 6172 2861 2c20 772c 2062 6961  linear(a, w, bia
-00008960: 7329 0a0a 2020 2020 6720 3d20 6765 745f  s)..    g = get_
-00008970: 6772 6164 2866 7764 290a 0a20 2020 2066  grad(fwd)..    f
-00008980: 6972 7374 5f64 696d 203d 202d 320a 2020  irst_dim = -2.  
-00008990: 2020 6772 6164 5f61 203d 206c 746f 7263    grad_a = ltorc
-000089a0: 682e 6d61 746d 756c 2867 2e72 6573 6861  h.matmul(g.resha
-000089b0: 7065 282d 312c 2067 2e73 6861 7065 5b2d  pe(-1, g.shape[-
-000089c0: 315d 292c 2077 292e 7265 7368 6170 6528  1]), w).reshape(
-000089d0: 612e 7368 6170 6529 0a0a 2020 2020 6772  a.shape)..    gr
-000089e0: 6164 5f77 3a20 5465 6e73 6f72 5072 6f78  ad_w: TensorProx
-000089f0: 790a 2020 2020 6966 2061 2e6e 6469 6d20  y.    if a.ndim 
-00008a00: 3d3d 2031 3a0a 2020 2020 2020 2020 6772  == 1:.        gr
-00008a10: 6164 5f77 203d 206c 746f 7263 682e 6d61  ad_w = ltorch.ma
-00008a20: 746d 756c 2867 2e75 6e73 7175 6565 7a65  tmul(g.unsqueeze
-00008a30: 2866 6972 7374 5f64 696d 292e 6d54 2c20  (first_dim).mT, 
-00008a40: 612e 756e 7371 7565 657a 6528 6669 7273  a.unsqueeze(firs
-00008a50: 745f 6469 6d29 290a 2020 2020 656c 7365  t_dim)).    else
-00008a60: 3a0a 2020 2020 2020 2020 6772 6164 5f77  :.        grad_w
-00008a70: 203d 206c 746f 7263 682e 6d61 746d 756c   = ltorch.matmul
-00008a80: 2867 2e72 6573 6861 7065 282d 312c 2067  (g.reshape(-1, g
-00008a90: 2e73 6861 7065 5b2d 315d 292e 6d54 2c20  .shape[-1]).mT, 
-00008aa0: 612e 7265 7368 6170 6528 2d31 2c20 612e  a.reshape(-1, a.
-00008ab0: 7368 6170 655b 2d31 5d29 290a 0a20 2020  shape[-1]))..   
-00008ac0: 2070 7574 5f67 7261 6473 2828 612c 2077   put_grads((a, w
-00008ad0: 292c 2028 6772 6164 5f61 2c20 6772 6164  ), (grad_a, grad
-00008ae0: 5f77 2929 0a0a 2020 2020 6966 2062 6961  _w))..    if bia
-00008af0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-00008b00: 2020 2020 2020 2069 6620 672e 6e64 696d         if g.ndim
-00008b10: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
-00008b20: 2020 6772 6164 5f62 6961 7320 3d20 6c74    grad_bias = lt
-00008b30: 6f72 6368 2e73 756d 2867 2c20 7475 706c  orch.sum(g, tupl
-00008b40: 6528 7261 6e67 6528 672e 6e64 696d 202d  e(range(g.ndim -
-00008b50: 2031 2929 290a 2020 2020 2020 2020 656c   1))).        el
-00008b60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00008b70: 6772 6164 5f62 6961 7320 3d20 670a 2020  grad_bias = g.  
-00008b80: 2020 2020 2020 7075 745f 6772 6164 2862        put_grad(b
-00008b90: 6961 732c 2067 7261 645f 6269 6173 290a  ias, grad_bias).
-00008ba0: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
-00008bb0: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
-00008bc0: 7069 6473 2e4c 494e 4541 522c 205f 6c69  pids.LINEAR, _li
-00008bd0: 6e65 6172 5f70 7269 6d5f 6772 6164 290a  near_prim_grad).
-00008be0: 0a0a 2320 544f 444f 2041 6464 2065 7870  ..# TODO Add exp
-00008bf0: 6c69 6369 7420 6c74 6f72 6368 2076 7320  licit ltorch vs 
-00008c00: 636c 616e 6720 6d6f 6475 6c65 2074 6f20  clang module to 
-00008c10: 7468 6520 7465 6e73 6f72 206f 7065 7261  the tensor opera
-00008c20: 7469 6f6e 7320 6265 6c6f 770a 2320 544f  tions below.# TO
-00008c30: 444f 2063 6f75 6c64 2077 6520 6765 7420  DO could we get 
-00008c40: 7269 6420 6f66 2074 6865 2066 696e 616c  rid of the final
-00008c50: 2073 7175 6565 7a65 7320 696e 2074 6865   squeezes in the
-00008c60: 2062 2e6e 6469 6d20 3d3d 2031 2063 6173   b.ndim == 1 cas
-00008c70: 6520 616e 6420 7468 6520 612e 6e64 696d  e and the a.ndim
-00008c80: 203d 3d20 3120 6361 7365 3f0a 4074 6f72   == 1 case?.@tor
-00008c90: 6368 6374 780a 6465 6620 5f6d 6174 6d75  chctx.def _matmu
-00008ca0: 6c5f 7072 696d 5f67 7261 6428 613a 2054  l_prim_grad(a: T
-00008cb0: 656e 736f 7250 726f 7879 2c20 623a 2054  ensorProxy, b: T
-00008cc0: 656e 736f 7250 726f 7879 2c20 2f29 202d  ensorProxy, /) -
-00008cd0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-00008ce0: 2020 2066 7764 203d 2070 7269 6d73 2e6d     fwd = prims.m
-00008cf0: 6174 6d75 6c28 612c 2062 290a 2020 2020  atmul(a, b).    
-00008d00: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-00008d10: 290a 0a20 2020 206c 6173 745f 6469 6d20  )..    last_dim 
-00008d20: 3d20 282d 312c 290a 2020 2020 6669 7273  = (-1,).    firs
-00008d30: 745f 6469 6d20 3d20 282d 322c 290a 2020  t_dim = (-2,).  
-00008d40: 2020 6966 2061 2e6e 6469 6d20 3d3d 2031    if a.ndim == 1
-00008d50: 2061 6e64 2062 2e6e 6469 6d20 3d3d 2031   and b.ndim == 1
-00008d60: 3a0a 2020 2020 2020 2020 7075 745f 6772  :.        put_gr
-00008d70: 6164 7328 2861 2c20 6229 2c20 2867 202a  ads((a, b), (g *
-00008d80: 2062 2c20 6720 2a20 6129 290a 2020 2020   b, g * a)).    
-00008d90: 656c 6966 2062 2e6e 6469 6d20 3d3d 2031  elif b.ndim == 1
-00008da0: 3a0a 2020 2020 2020 2020 6761 203d 2075  :.        ga = u
-00008db0: 6e73 7175 6565 7a65 2867 2c20 6c61 7374  nsqueeze(g, last
-00008dc0: 5f64 696d 2920 4020 756e 7371 7565 657a  _dim) @ unsqueez
-00008dd0: 6528 622c 206c 6173 745f 6469 6d29 2e6d  e(b, last_dim).m
-00008de0: 540a 2020 2020 2020 2020 6762 203d 2061  T.        gb = a
-00008df0: 2e6d 5420 4020 756e 7371 7565 657a 6528  .mT @ unsqueeze(
-00008e00: 672c 206c 6173 745f 6469 6d29 0a20 2020  g, last_dim).   
-00008e10: 2020 2020 2069 6620 672e 6e64 696d 203e       if g.ndim >
-00008e20: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00008e30: 6762 203d 2073 7175 6565 7a65 2867 622c  gb = squeeze(gb,
-00008e40: 206c 6173 745f 6469 6d29 0a20 2020 2020   last_dim).     
-00008e50: 2020 2020 2020 2067 6220 3d20 6c74 6f72         gb = ltor
-00008e60: 6368 2e73 756d 2867 622c 2074 7570 6c65  ch.sum(gb, tuple
-00008e70: 2872 616e 6765 2867 622e 6e64 696d 202d  (range(gb.ndim -
-00008e80: 2031 2929 290a 2020 2020 2020 2020 7075   1))).        pu
-00008e90: 745f 6772 6164 7328 2861 2c20 6229 2c20  t_grads((a, b), 
-00008ea0: 2867 612c 2067 622e 7371 7565 657a 6528  (ga, gb.squeeze(
-00008eb0: 2929 290a 2020 2020 656c 6966 2061 2e6e  ))).    elif a.n
-00008ec0: 6469 6d20 3d3d 2031 3a0a 2020 2020 2020  dim == 1:.      
-00008ed0: 2020 6761 203d 2075 6e73 7175 6565 7a65    ga = unsqueeze
-00008ee0: 2867 2c20 6669 7273 745f 6469 6d29 2040  (g, first_dim) @
-00008ef0: 2062 2e6d 540a 2020 2020 2020 2020 6966   b.mT.        if
-00008f00: 2067 2e6e 6469 6d20 3e20 313a 0a20 2020   g.ndim > 1:.   
-00008f10: 2020 2020 2020 2020 2067 6120 3d20 6c74           ga = lt
-00008f20: 6f72 6368 2e73 756d 2867 612c 2074 7570  orch.sum(ga, tup
-00008f30: 6c65 2872 616e 6765 2867 612e 6e64 696d  le(range(ga.ndim
-00008f40: 202d 2031 2929 290a 2020 2020 2020 2020   - 1))).        
-00008f50: 6762 203d 2075 6e73 7175 6565 7a65 2861  gb = unsqueeze(a
-00008f60: 2c20 6669 7273 745f 6469 6d29 2e6d 5420  , first_dim).mT 
-00008f70: 4020 756e 7371 7565 657a 6528 672c 2066  @ unsqueeze(g, f
-00008f80: 6972 7374 5f64 696d 290a 2020 2020 2020  irst_dim).      
-00008f90: 2020 7075 745f 6772 6164 7328 2861 2c20    put_grads((a, 
-00008fa0: 6229 2c20 2867 612e 7371 7565 657a 6528  b), (ga.squeeze(
-00008fb0: 292c 2067 6229 290a 2020 2020 656c 7365  ), gb)).    else
-00008fc0: 3a0a 2020 2020 2020 2020 7075 745f 6772  :.        put_gr
-00008fd0: 6164 7328 2861 2c20 6229 2c20 2867 2040  ads((a, b), (g @
-00008fe0: 2062 2e6d 542c 2061 2e6d 5420 4020 6729   b.mT, a.mT @ g)
-00008ff0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00009000: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-00009010: 6428 7069 6473 2e4d 4154 4d55 4c2c 205f  d(pids.MATMUL, _
-00009020: 6d61 746d 756c 5f70 7269 6d5f 6772 6164  matmul_prim_grad
-00009030: 290a 0a23 0a23 204e 4e20 6f70 6572 6174  )..#.# NN operat
-00009040: 6f72 2067 7261 6473 0a23 0a0a 0a40 746f  or grads.#...@to
-00009050: 7263 6863 7478 0a64 6566 205f 656d 6265  rchctx.def _embe
-00009060: 6464 696e 675f 7072 696d 5f67 7261 6428  dding_prim_grad(
-00009070: 0a20 2020 2061 3a20 5465 6e73 6f72 5072  .    a: TensorPr
-00009080: 6f78 792c 202f 2c20 7765 6967 6874 2c20  oxy, /, weight, 
-00009090: 2a2c 2070 6164 6469 6e67 5f69 6478 3d2d  *, padding_idx=-
-000090a0: 312c 206d 6178 5f6e 6f72 6d3d 4e6f 6e65  1, max_norm=None
-000090b0: 2c20 6e6f 726d 5f74 7970 653d 322e 302c  , norm_type=2.0,
-000090c0: 2073 6361 6c65 5f67 7261 645f 6279 5f66   scale_grad_by_f
-000090d0: 7265 713d 4661 6c73 652c 2073 7061 7273  req=False, spars
-000090e0: 653d 4661 6c73 650a 2920 2d3e 2054 656e  e=False.) -> Ten
-000090f0: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
-00009100: 6420 3d20 7072 696d 732e 656d 6265 6464  d = prims.embedd
-00009110: 696e 6728 0a20 2020 2020 2020 2061 2c0a  ing(.        a,.
-00009120: 2020 2020 2020 2020 7765 6967 6874 2c0a          weight,.
-00009130: 2020 2020 2020 2020 7061 6464 696e 675f          padding_
-00009140: 6964 783d 7061 6464 696e 675f 6964 782c  idx=padding_idx,
-00009150: 0a20 2020 2020 2020 206d 6178 5f6e 6f72  .        max_nor
-00009160: 6d3d 6d61 785f 6e6f 726d 2c0a 2020 2020  m=max_norm,.    
-00009170: 2020 2020 6e6f 726d 5f74 7970 653d 6e6f      norm_type=no
-00009180: 726d 5f74 7970 652c 0a20 2020 2020 2020  rm_type,.       
-00009190: 2073 6361 6c65 5f67 7261 645f 6279 5f66   scale_grad_by_f
-000091a0: 7265 713d 7363 616c 655f 6772 6164 5f62  req=scale_grad_b
-000091b0: 795f 6672 6571 2c0a 2020 2020 2020 2020  y_freq,.        
-000091c0: 7370 6172 7365 3d73 7061 7273 652c 0a20  sparse=sparse,. 
-000091d0: 2020 2029 0a0a 2020 2020 6720 3d20 6765     )..    g = ge
-000091e0: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-000091f0: 615f 6772 6164 203d 2070 7269 6d73 2e65  a_grad = prims.e
-00009200: 6d62 6564 6469 6e67 5f62 6163 6b77 6172  mbedding_backwar
-00009210: 6428 672c 2061 2c20 7765 6967 6874 2e73  d(g, a, weight.s
-00009220: 6861 7065 5b30 5d2c 2070 6164 6469 6e67  hape[0], padding
-00009230: 5f69 6478 2c20 7363 616c 655f 6772 6164  _idx, scale_grad
-00009240: 5f62 795f 6672 6571 2c20 7370 6172 7365  _by_freq, sparse
-00009250: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
-00009260: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
-00009270: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00009280: 7374 6572 5f67 7261 6428 7069 6473 2e45  ster_grad(pids.E
-00009290: 4d42 4544 4449 4e47 2c20 5f65 6d62 6564  MBEDDING, _embed
-000092a0: 6469 6e67 5f70 7269 6d5f 6772 6164 290a  ding_prim_grad).
-000092b0: 0a23 0a23 2050 6861 6e74 6f6d 2067 7261  .#.# Phantom gra
-000092c0: 6420 7472 616e 7366 6f72 6d20 6865 6c70  d transform help
-000092d0: 6572 730a 230a 0a0a 6465 6620 5f67 6574  ers.#...def _get
-000092e0: 5f67 7261 6466 6e28 6273 796d 3a20 426f  _gradfn(bsym: Bo
-000092f0: 756e 6453 796d 626f 6c2c 202a 2c20 6578  undSymbol, *, ex
-00009300: 6563 7574 6f72 735f 6c69 7374 3a20 5365  ecutors_list: Se
-00009310: 7175 656e 6365 5b41 6e79 5d20 3d20 7475  quence[Any] = tu
-00009320: 706c 6528 2929 202d 3e20 4e6f 6e65 207c  ple()) -> None |
-00009330: 2043 616c 6c61 626c 653a 0a20 2020 2063   Callable:.    c
-00009340: 6420 3d20 6765 745f 636f 6d70 696c 655f  d = get_compile_
-00009350: 6461 7461 2829 0a20 2020 2065 7865 6375  data().    execu
-00009360: 746f 7273 5f6c 6973 7420 3d20 6364 2e65  tors_list = cd.e
-00009370: 7865 6375 746f 7273 5f6c 6973 7420 6966  xecutors_list if
-00009380: 2063 6420 6973 206e 6f74 204e 6f6e 6520   cd is not None 
-00009390: 656c 7365 2065 7865 6375 746f 7273 5f6c  else executors_l
-000093a0: 6973 740a 2020 2020 2320 4368 6563 6b73  ist.    # Checks
-000093b0: 2069 6620 7468 6520 6578 6563 7574 6f72   if the executor
-000093c0: 2077 6869 6368 2068 6173 2070 7269 6f72   which has prior
-000093d0: 6974 7920 666f 7220 7468 6973 206f 7065  ity for this ope
-000093e0: 7261 7469 6f6e 2068 6173 2061 2073 7065  ration has a spe
-000093f0: 6369 6669 6320 6772 6164 2074 7261 6e73  cific grad trans
-00009400: 666f 726d 2066 6f72 2069 740a 2020 2020  form for it.    
-00009410: 666f 7220 6578 2069 6e20 6578 6563 7574  for ex in execut
-00009420: 6f72 735f 6c69 7374 3a0a 2020 2020 2020  ors_list:.      
-00009430: 2020 6966 2065 782e 6361 6e5f 6578 6563    if ex.can_exec
-00009440: 7574 655f 6f72 5f66 7573 6528 6273 796d  ute_or_fuse(bsym
-00009450: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
-00009460: 785f 6772 6164 5f74 7261 6e73 666f 726d  x_grad_transform
-00009470: 3a20 4e6f 6e65 207c 2043 616c 6c61 626c  : None | Callabl
-00009480: 6520 3d20 6578 2e67 6574 5f67 7261 645f  e = ex.get_grad_
-00009490: 7472 616e 7366 6f72 6d28 6273 796d 2e73  transform(bsym.s
-000094a0: 796d 290a 2020 2020 2020 2020 2020 2020  ym).            
-000094b0: 6966 2065 785f 6772 6164 5f74 7261 6e73  if ex_grad_trans
-000094c0: 666f 726d 2069 7320 6e6f 7420 4e6f 6e65  form is not None
-000094d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000094e0: 2020 7265 7475 726e 2065 785f 6772 6164    return ex_grad
-000094f0: 5f74 7261 6e73 666f 726d 0a20 2020 2020  _transform.     
-00009500: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
-00009510: 2020 2320 4966 2074 6865 2065 7865 6375    # If the execu
-00009520: 746f 7220 646f 6573 6e27 7420 6465 6669  tor doesn't defi
-00009530: 6e65 2069 7473 206f 776e 2067 7261 6420  ne its own grad 
-00009540: 7472 616e 7366 6f72 6d2c 2074 6869 7320  transform, this 
-00009550: 6a75 7374 2072 6574 7572 6e73 2074 6865  just returns the
-00009560: 2064 6566 6175 6c74 2067 7261 6420 7472   default grad tr
-00009570: 616e 7366 6f72 6d20 666f 7220 7468 6520  ansform for the 
-00009580: 6273 796d 0a20 2020 2067 7261 6466 6e20  bsym.    gradfn 
-00009590: 3d20 5f67 7261 645f 666e 5f6d 6170 2e67  = _grad_fn_map.g
-000095a0: 6574 2862 7379 6d2e 7379 6d2e 6964 2c20  et(bsym.sym.id, 
-000095b0: 4e6f 6e65 290a 2020 2020 7265 7475 726e  None).    return
-000095c0: 2067 7261 6466 6e0a 0a0a 2320 5468 6520   gradfn...# The 
-000095d0: 6465 6661 756c 7420 6772 6164 2073 7065  default grad spe
-000095e0: 6369 6669 6572 2066 6f72 2074 6865 2067  cifier for the g
-000095f0: 7261 6420 7472 616e 7366 6f72 6d0a 2320  rad transform.# 
-00009600: 2020 466f 7220 6561 6368 2074 656e 736f    For each tenso
-00009610: 7220 6f75 7470 7574 2022 6f22 2072 6571  r output "o" req
-00009620: 7569 7269 6e67 2067 7261 642c 2073 7065  uiring grad, spe
-00009630: 6369 6669 6573 2061 2067 7261 6420 6f66  cifies a grad of
-00009640: 206f 6e65 735f 6c69 6b65 286f 290a 6465   ones_like(o).de
-00009650: 6620 5f67 7261 645f 7370 6563 6966 6965  f _grad_specifie
-00009660: 725f 6465 6661 756c 7428 7079 7472 6565  r_default(pytree
-00009670: 3a20 416e 7929 202d 3e20 4e6f 6e65 3a0a  : Any) -> None:.
-00009680: 2020 2020 666c 6174 732c 205f 203d 2074      flats, _ = t
-00009690: 7265 655f 666c 6174 7465 6e28 7079 7472  ree_flatten(pytr
-000096a0: 6565 290a 0a20 2020 2066 6f72 2066 2069  ee)..    for f i
-000096b0: 6e20 666c 6174 733a 0a20 2020 2020 2020  n flats:.       
-000096c0: 2069 6620 6973 696e 7374 616e 6365 2866   if isinstance(f
-000096d0: 2c20 5465 6e73 6f72 5072 6f78 7929 2061  , TensorProxy) a
-000096e0: 6e64 2066 2e72 6571 7569 7265 735f 6772  nd f.requires_gr
-000096f0: 6164 3a0a 2020 2020 2020 2020 2020 2020  ad:.            
-00009700: 2320 4e4f 5445 2054 6869 7320 7573 6573  # NOTE This uses
-00009710: 2063 6c61 6e67 2e6f 6e65 735f 6c69 6b65   clang.ones_like
-00009720: 2066 6f72 206e 6f77 2062 6563 6175 7365   for now because
-00009730: 206c 746f 7263 682e 6f6e 6573 5f6c 696b   ltorch.ones_lik
-00009740: 6520 7769 6c6c 2065 7874 656e 6420 7468  e will extend th
-00009750: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00009760: 2020 6c69 6665 7469 6d65 206f 6620 662c    lifetime of f,
-00009770: 2077 6869 6c65 2063 6c61 6e67 2e6f 6e65   while clang.one
-00009780: 735f 6c69 6b65 2077 696c 6c20 6578 7472  s_like will extr
-00009790: 6163 7420 7468 6520 6d65 7461 6461 7461  act the metadata
-000097a0: 206f 6620 6620 6174 2074 7261 6365 2074   of f at trace t
-000097b0: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
-000097c0: 7072 696d 732e 7075 745f 6772 6164 2866  prims.put_grad(f
-000097d0: 2c20 636c 616e 672e 6675 6c6c 5f6c 696b  , clang.full_lik
-000097e0: 6528 662c 2031 2e30 2929 0a0a 0a23 2054  e(f, 1.0))...# T
-000097f0: 4f44 4f20 5465 7374 2077 6974 6820 6275  ODO Test with bu
-00009800: 6666 6572 730a 6465 6620 5f67 7261 645f  ffers.def _grad_
-00009810: 6f75 745f 7370 6563 6966 6965 725f 6465  out_specifier_de
-00009820: 6661 756c 7428 7079 7472 6565 3a20 416e  fault(pytree: An
-00009830: 7929 202d 3e20 6c69 7374 5b54 656e 736f  y) -> list[Tenso
-00009840: 7250 726f 7879 5d3a 0a20 2020 2066 6c61  rProxy]:.    fla
-00009850: 7473 2c20 5f20 3d20 7472 6565 5f66 6c61  ts, _ = tree_fla
-00009860: 7474 656e 2870 7974 7265 6529 0a20 2020  tten(pytree).   
-00009870: 2067 7261 6473 203d 206c 6973 7428 5b70   grads = list([p
-00009880: 7269 6d73 2e67 6574 5f67 7261 6428 6629  rims.get_grad(f)
-00009890: 2066 6f72 2066 2069 6e20 666c 6174 7320   for f in flats 
-000098a0: 6966 2069 7369 6e73 7461 6e63 6528 662c  if isinstance(f,
-000098b0: 2054 656e 736f 7250 726f 7879 2920 616e   TensorProxy) an
-000098c0: 6420 662e 7265 7175 6972 6573 5f67 7261  d f.requires_gra
-000098d0: 645d 290a 2020 2020 7265 7475 726e 2067  d]).    return g
-000098e0: 7261 6473 0a0a 0a23 2054 4f44 4f20 466f  rads...# TODO Fo
-000098f0: 726d 616c 6c79 2064 6566 696e 6520 7468  rmally define th
-00009900: 6520 2267 7261 6469 656e 7422 206f 6620  e "gradient" of 
-00009910: 6120 7465 6e73 6f72 0a23 2054 4f44 4f20  a tensor.# TODO 
-00009920: 4966 206e 6f6e 6520 6f66 2074 6865 2069  If none of the i
-00009930: 6e70 7574 7320 746f 2061 6e20 6f70 6572  nputs to an oper
-00009940: 6174 696f 6e20 7265 7175 6972 6520 6772  ation require gr
-00009950: 6164 2c20 7468 656e 2077 6520 636f 756c  ad, then we coul
-00009960: 6420 6c65 6176 6520 7468 6174 206f 7065  d leave that ope
-00009970: 7261 7469 6f6e 2061 6c6f 6e65 0a23 2020  ration alone.#  
-00009980: 2054 6869 7320 636f 756c 6420 6163 7475   This could actu
-00009990: 616c 6c79 2069 6d70 726f 7665 2070 6572  ally improve per
-000099a0: 666f 726d 616e 6365 2069 6620 7468 6520  formance if the 
-000099b0: 6f70 6572 6174 696f 6e20 7065 7266 6f72  operation perfor
-000099c0: 6d73 2065 7874 7261 2063 6f6d 7075 7461  ms extra computa
-000099d0: 7469 6f6e 7320 696e 2069 7473 2067 7261  tions in its gra
-000099e0: 6420 7472 616e 7366 6f72 6d0a 2320 2020  d transform.#   
-000099f0: 4120 776f 726b 6172 6f75 6e64 2066 6f72  A workaround for
-00009a00: 2074 6869 7320 776f 756c 6420 6265 2066   this would be f
-00009a10: 6f72 2074 6865 206f 7065 7261 7469 6f6e  or the operation
-00009a20: 2069 7473 656c 6620 746f 2063 6865 636b   itself to check
-00009a30: 2069 6620 6974 7320 696e 7075 7420 7265   if its input re
-00009a40: 7175 6972 6573 2067 7261 6420 6f72 206e  quires grad or n
-00009a50: 6f74 0a23 2054 7261 6e73 666f 726d 7320  ot.# Transforms 
-00009a60: 6120 6675 6e63 7469 6f6e 2074 6f20 636f  a function to co
-00009a70: 6d70 7574 6520 7468 6520 2267 7261 6469  mpute the "gradi
-00009a80: 656e 7422 206f 6620 6974 7320 696e 7075  ent" of its inpu
-00009a90: 7473 2072 6571 7569 7269 6e67 2067 7261  ts requiring gra
-00009aa0: 642c 2070 6f73 7369 626c 790a 2320 2020  d, possibly.#   
-00009ab0: 6d6f 6469 6669 6564 2062 7920 7468 6520  modified by the 
-00009ac0: 6772 6164 2073 7065 6369 6669 6572 7320  grad specifiers 
-00009ad0: 2873 6565 2062 656c 6f77 292e 0a23 2054  (see below)..# T
-00009ae0: 6865 206f 7074 696f 6e61 6c20 6772 6164  he optional grad
-00009af0: 5f73 7065 6369 6669 6572 2061 7267 756d  _specifier argum
-00009b00: 656e 7420 6163 6365 7074 7320 7468 6520  ent accepts the 
-00009b10: 6675 6e63 7469 6f6e 2773 206f 7574 7075  function's outpu
-00009b20: 742c 2072 756e 7320 696e 2061 206e 6f2d  t, runs in a no-
-00009b30: 6772 6164 2063 6f6e 7465 7874 2c0a 2320  grad context,.# 
-00009b40: 2020 616e 6420 6361 6e20 7075 7420 6772    and can put gr
-00009b50: 6164 7320 2875 7369 6e67 2070 7269 6d73  ads (using prims
-00009b60: 2e70 7574 5f67 7261 6428 2929 2066 6f72  .put_grad()) for
-00009b70: 2074 656e 736f 7273 2e20 4279 2064 6566   tensors. By def
-00009b80: 6175 6c74 2c20 666f 7220 6576 6572 7920  ault, for every 
-00009b90: 7465 6e73 6f72 206f 7574 7075 7420 226f  tensor output "o
-00009ba0: 220a 2320 2020 7468 6174 2072 6571 7569  ".#   that requi
-00009bb0: 7265 7320 6772 6164 2c20 6120 6772 6164  res grad, a grad
-00009bc0: 206f 6620 6f6e 6573 5f6c 696b 6528 6f29   of ones_like(o)
-00009bd0: 2069 7320 7075 742e 0a23 2054 6865 206f   is put..# The o
-00009be0: 7074 696f 6e61 6c20 6772 6164 5f6f 7574  ptional grad_out
-00009bf0: 5f73 7065 6369 6669 6572 2061 6363 6570  _specifier accep
-00009c00: 7473 2074 6865 2066 756e 6374 696f 6e27  ts the function'
-00009c10: 7320 696e 7075 7420 616e 6420 6361 6e20  s input and can 
-00009c20: 6361 6c6c 2070 7269 6d73 2e67 6574 5f67  call prims.get_g
-00009c30: 7261 6428 2920 746f 0a23 2020 2061 6371  rad() to.#   acq
-00009c40: 7569 7265 2061 6e64 2072 6574 7572 6e20  uire and return 
-00009c50: 6772 6164 6965 6e74 7320 6173 2064 6573  gradients as des
-00009c60: 6972 6564 2e20 4279 2064 6566 6175 6c74  ired. By default
-00009c70: 2c20 7468 6520 696e 7075 7420 6973 2066  , the input is f
-00009c80: 6c61 7474 656e 6564 0a23 2020 2028 7472  lattened.#   (tr
-00009c90: 6565 5f66 6c61 7474 656e 2861 7267 732c  ee_flatten(args,
-00009ca0: 206b 7761 7267 7329 2920 616e 6420 6120   kwargs)) and a 
-00009cb0: 666c 6174 206c 6973 7420 6f66 2067 7261  flat list of gra
-00009cc0: 6473 2066 6f72 2061 6c6c 2074 656e 736f  ds for all tenso
-00009cd0: 7273 2072 6571 7569 7269 6e67 2067 7261  rs requiring gra
-00009ce0: 640a 2320 2020 616e 6420 4e6f 6e65 2066  d.#   and None f
-00009cf0: 6f72 206f 7468 6572 2069 6e70 7574 7320  or other inputs 
-00009d00: 6973 2072 6574 7572 6e65 642e 0a23 2054  is returned..# T
-00009d10: 6865 2061 6c67 6f72 6974 686d 2066 6f72  he algorithm for
-00009d20: 206d 6f64 6966 7969 6e67 2074 6865 2070   modifying the p
-00009d30: 726f 6772 616d 2068 6173 2074 6865 2066  rogram has the f
-00009d40: 6f6c 6c6f 7769 6e67 2073 7465 7073 3a0a  ollowing steps:.
-00009d50: 2320 2020 3129 2046 6c61 7474 656e 7320  #   1) Flattens 
-00009d60: 7468 6520 6f72 6967 696e 616c 2074 7261  the original tra
-00009d70: 6365 2066 6f72 2074 6865 2067 7261 6420  ce for the grad 
-00009d80: 7472 616e 7366 6f72 6d20 2d2d 2065 6e73  transform -- ens
-00009d90: 7569 6e67 2074 6861 7420 616c 6c20 746f  uing that all to
-00009da0: 702d 6c65 7665 6c20 7379 6d62 6f6c 7320  p-level symbols 
-00009db0: 6861 7665 0a23 2020 2020 2020 2061 2067  have.#       a g
-00009dc0: 7261 6420 6675 6e63 7469 6f6e 2e0a 6465  rad function..de
-00009dd0: 6620 6772 6164 280a 2020 2020 6366 6e2c  f grad(.    cfn,
-00009de0: 2067 7261 645f 7370 6563 6966 6965 723a   grad_specifier:
-00009df0: 2043 616c 6c61 626c 6520 3d20 5f67 7261   Callable = _gra
-00009e00: 645f 7370 6563 6966 6965 725f 6465 6661  d_specifier_defa
-00009e10: 756c 742c 2067 7261 645f 6f75 745f 7370  ult, grad_out_sp
-00009e20: 6563 6966 6965 723a 2043 616c 6c61 626c  ecifier: Callabl
-00009e30: 6520 3d20 5f67 7261 645f 6f75 745f 7370  e = _grad_out_sp
-00009e40: 6563 6966 6965 725f 6465 6661 756c 740a  ecifier_default.
-00009e50: 2920 2d3e 2043 616c 6c61 626c 653a 0a20  ) -> Callable:. 
-00009e60: 2020 2023 2043 7265 6174 6573 2061 2063     # Creates a c
-00009e70: 7573 746f 6d20 7472 616e 7366 6f72 6d20  ustom transform 
-00009e80: 6361 6c6c 6162 6c65 2074 6861 7420 6269  callable that bi
-00009e90: 6e64 7320 7468 6520 6164 6469 7469 6f6e  nds the addition
-00009ea0: 616c 2061 7267 756d 656e 7473 2074 6f20  al arguments to 
-00009eb0: 7468 6520 6772 6164 2074 7261 6e73 666f  the grad transfo
-00009ec0: 726d 0a20 2020 2040 6c61 6e67 6374 7828  rm.    @langctx(
-00009ed0: 4c61 6e67 7561 6765 732e 434c 414e 4729  Languages.CLANG)
-00009ee0: 0a20 2020 2064 6566 205f 6772 6164 5f74  .    def _grad_t
-00009ef0: 7261 6e73 666f 726d 2874 7263 3a20 5472  ransform(trc: Tr
-00009f00: 6163 652c 202a 2c20 6578 6563 7574 6f72  ace, *, executor
-00009f10: 735f 6c69 7374 3a20 5365 7175 656e 6365  s_list: Sequence
-00009f20: 5b41 6e79 5d29 202d 3e20 5472 6163 653a  [Any]) -> Trace:
-00009f30: 0a20 2020 2020 2020 2073 7461 7274 5f74  .        start_t
-00009f40: 696d 655f 6e73 203d 2074 696d 652e 7469  ime_ns = time.ti
-00009f50: 6d65 5f6e 7328 290a 0a20 2020 2020 2020  me_ns()..       
-00009f60: 2023 2053 5445 5020 4f4e 4520 2d2d 2046   # STEP ONE -- F
-00009f70: 6c61 7474 656e 7320 616e 6420 6463 6573  lattens and dces
-00009f80: 0a0a 2020 2020 2020 2020 2320 5265 7475  ..        # Retu
-00009f90: 726e 7320 5472 7565 2069 6620 7468 6520  rns True if the 
-00009fa0: 6273 796d 2068 6173 206e 6f20 6772 6164  bsym has no grad
-00009fb0: 2066 756e 6374 696f 6e2c 2061 6e64 2073   function, and s
-00009fc0: 6f20 6d75 7374 2062 6520 666c 6174 7465  o must be flatte
-00009fd0: 6e65 6420 666f 7220 7468 6520 6772 6164  ned for the grad
-00009fe0: 2074 7261 6e73 666f 726d 0a20 2020 2020   transform.     
-00009ff0: 2020 206e 6576 6572 5f66 6c61 7474 656e     never_flatten
-0000a000: 3a20 7365 745b 4861 7368 6162 6c65 5d20  : set[Hashable] 
-0000a010: 3d20 7b70 7269 6d73 2e50 7269 6d49 4473  = {prims.PrimIDs
-0000a020: 2e52 4554 5552 4e2c 2070 7269 6d73 2e50  .RETURN, prims.P
-0000a030: 7269 6d49 4473 2e55 4e50 4143 4b5f 5452  rimIDs.UNPACK_TR
-0000a040: 4956 4941 4c7d 0a0a 2020 2020 2020 2020  IVIAL}..        
-0000a050: 6465 6620 7368 6f75 6c64 5f66 6c61 7474  def should_flatt
-0000a060: 656e 5f66 6f72 5f67 7261 6428 6273 796d  en_for_grad(bsym
-0000a070: 3a20 426f 756e 6453 796d 626f 6c29 202d  : BoundSymbol) -
-0000a080: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
-0000a090: 2020 2020 6966 2062 7379 6d2e 7379 6d2e      if bsym.sym.
-0000a0a0: 6964 2069 6e20 6e65 7665 725f 666c 6174  id in never_flat
-0000a0b0: 7465 6e3a 0a20 2020 2020 2020 2020 2020  ten:.           
-0000a0c0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-0000a0d0: 650a 0a20 2020 2020 2020 2020 2020 2067  e..            g
-0000a0e0: 7261 6466 6e3a 204e 6f6e 6520 7c20 4361  radfn: None | Ca
-0000a0f0: 6c6c 6162 6c65 203d 205f 6765 745f 6772  llable = _get_gr
-0000a100: 6164 666e 2862 7379 6d2c 2065 7865 6375  adfn(bsym, execu
-0000a110: 746f 7273 5f6c 6973 743d 6578 6563 7574  tors_list=execut
-0000a120: 6f72 735f 6c69 7374 290a 2020 2020 2020  ors_list).      
-0000a130: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
-0000a140: 6466 6e20 6973 204e 6f6e 650a 0a20 2020  dfn is None..   
-0000a150: 2020 2020 2023 2054 4f44 4f20 5243 313a       # TODO RC1:
-0000a160: 206d 6179 6265 206d 6f76 6520 746f 2070   maybe move to p
-0000a170: 726f 6475 6365 2074 6865 7365 2061 6c77  roduce these alw
-0000a180: 6179 7320 6f6e 2063 7265 6174 696f 6e0a  ays on creation.
-0000a190: 2020 2020 2020 2020 6966 2074 7263 2e6b          if trc.k
-0000a1a0: 7761 7267 7320 6973 204e 6f6e 653a 0a20  wargs is None:. 
-0000a1b0: 2020 2020 2020 2020 2020 2074 7263 2e6b             trc.k
-0000a1c0: 7761 7267 7320 3d20 7b7d 0a20 2020 2020  wargs = {}.     
-0000a1d0: 2020 2069 6620 7472 632e 666e 2069 7320     if trc.fn is 
-0000a1e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000a1f0: 2020 7472 632e 666e 203d 2074 7263 2e70    trc.fn = trc.p
-0000a200: 7974 686f 6e5f 6361 6c6c 6162 6c65 2829  ython_callable()
-0000a210: 0a0a 2020 2020 2020 2020 6772 6164 7472  ..        gradtr
-0000a220: 6320 3d20 6672 6f6d 5f74 7261 6365 2874  c = from_trace(t
-0000a230: 7263 290a 2020 2020 2020 2020 666c 6174  rc).        flat
-0000a240: 7465 6e65 645f 6273 796d 733a 206c 6973  tened_bsyms: lis
-0000a250: 745b 426f 756e 6453 796d 626f 6c5d 203d  t[BoundSymbol] =
-0000a260: 2066 6c61 7474 656e 5f66 6f72 5f74 7261   flatten_for_tra
-0000a270: 6e73 666f 726d 2873 686f 756c 645f 666c  nsform(should_fl
-0000a280: 6174 7465 6e5f 666f 725f 6772 6164 2c20  atten_for_grad, 
-0000a290: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
-0000a2a0: 7329 0a20 2020 2020 2020 2067 7261 6474  s).        gradt
-0000a2b0: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
-0000a2c0: 203d 2066 6c61 7474 656e 6564 5f62 7379   = flattened_bsy
-0000a2d0: 6d73 0a20 2020 2020 2020 2067 7261 6474  ms.        gradt
-0000a2e0: 7263 203d 2064 6365 2867 7261 6474 7263  rc = dce(gradtrc
-0000a2f0: 290a 0a20 2020 2020 2020 2023 2053 5445  )..        # STE
-0000a300: 5020 5457 4f20 2d2d 2052 6570 6c61 6365  P TWO -- Replace
-0000a310: 7320 6f72 6967 696e 616c 2063 616c 6c73  s original calls
-0000a320: 2077 6974 6820 6772 6164 2063 616c 6c73   with grad calls
-0000a330: 0a0a 2020 2020 2020 2020 2320 4465 6669  ..        # Defi
-0000a340: 6e65 7320 7468 6520 7669 7369 746f 7220  nes the visitor 
-0000a350: 7061 7474 6572 6e20 666f 7220 7468 6520  pattern for the 
-0000a360: 6669 7273 7420 7061 7373 206f 6620 7468  first pass of th
-0000a370: 6520 6772 6164 2074 7261 6e73 666f 726d  e grad transform
-0000a380: 2c0a 2020 2020 2020 2020 2320 2020 7768  ,.        #   wh
-0000a390: 6963 6820 7377 6170 7320 426f 756e 6453  ich swaps BoundS
-0000a3a0: 796d 626f 6c73 2077 6974 6820 7468 6569  ymbols with thei
-0000a3b0: 7220 6772 6164 2066 756e 6374 696f 6e73  r grad functions
-0000a3c0: 0a20 2020 2020 2020 2064 6566 2076 6973  .        def vis
-0000a3d0: 6974 5f28 6273 796d 3a20 426f 756e 6453  it_(bsym: BoundS
-0000a3e0: 796d 626f 6c29 202d 3e20 4361 6c6c 6162  ymbol) -> Callab
-0000a3f0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-0000a400: 6772 6164 666e 3a20 4e6f 6e65 207c 2043  gradfn: None | C
-0000a410: 616c 6c61 626c 6520 3d20 5f67 6574 5f67  allable = _get_g
-0000a420: 7261 6466 6e28 6273 796d 2c20 6578 6563  radfn(bsym, exec
-0000a430: 7574 6f72 735f 6c69 7374 3d65 7865 6375  utors_list=execu
-0000a440: 746f 7273 5f6c 6973 7429 0a20 2020 2020  tors_list).     
-0000a450: 2020 2020 2020 2063 6865 636b 280a 2020         check(.  
-0000a460: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-0000a470: 6164 666e 2069 7320 6e6f 7420 4e6f 6e65  adfn is not None
-0000a480: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a490: 2020 6c61 6d62 6461 3a20 6622 4661 696c    lambda: f"Fail
-0000a4a0: 6564 2074 6f20 6669 6e64 2061 2067 7261  ed to find a gra
-0000a4b0: 6466 6e20 666f 7220 7b62 7379 6d3d 7d20  dfn for {bsym=} 
-0000a4c0: 6166 7465 7220 666c 6174 7465 6e69 6e67  after flattening
-0000a4d0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000a4e0: 2020 2065 7863 6570 7469 6f6e 5f74 7970     exception_typ
-0000a4f0: 653d 4173 7365 7274 696f 6e45 7272 6f72  e=AssertionError
-0000a500: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0000a510: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000a520: 726e 2067 7261 6466 6e0a 0a20 2020 2020  rn gradfn..     
-0000a530: 2020 2040 7772 6170 7328 7472 632e 666e     @wraps(trc.fn
-0000a540: 2e6d 6574 6120 6966 2069 7369 6e73 7461  .meta if isinsta
-0000a550: 6e63 6528 7472 632e 666e 2c20 5379 6d62  nce(trc.fn, Symb
-0000a560: 6f6c 2920 656c 7365 2074 7263 2e66 6e29  ol) else trc.fn)
-0000a570: 0a20 2020 2020 2020 2064 6566 2069 6e74  .        def int
-0000a580: 6572 7072 6574 696e 675f 666e 282a 6172  erpreting_fn(*ar
-0000a590: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
-0000a5a0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-0000a5b0: 7420 3d20 6576 616c 5f74 7261 6365 2867  t = eval_trace(g
-0000a5c0: 7261 6474 7263 2c20 2a61 7267 732c 2073  radtrc, *args, s
-0000a5d0: 796d 626f 6c5f 6d61 7070 6572 3d76 6973  ymbol_mapper=vis
-0000a5e0: 6974 5f2c 202a 2a6b 7761 7267 7329 0a20  it_, **kwargs). 
-0000a5f0: 2020 2020 2020 2020 2020 2023 2053 6574             # Set
-0000a600: 7320 6772 6164 7320 666f 7220 6f75 7470  s grads for outp
-0000a610: 7574 0a20 2020 2020 2020 2020 2020 2023  ut.            #
-0000a620: 2054 4f44 4f20 5468 6973 2065 6666 6563   TODO This effec
-0000a630: 7469 7665 6c79 2072 756e 7320 696e 2061  tively runs in a
-0000a640: 206e 6f20 6772 6164 2063 6f6e 7465 7874   no grad context
-0000a650: 202d 2d20 7368 6f75 6c64 2069 7420 7275   -- should it ru
-0000a660: 6e20 696e 2061 2067 7261 6420 636f 6e74  n in a grad cont
-0000a670: 6578 742c 0a20 2020 2020 2020 2020 2020  ext,.           
-0000a680: 2023 2020 206f 7220 7368 6f75 6c64 2074   #   or should t
-0000a690: 6865 7265 2062 6520 7468 6520 6f70 7469  here be the opti
-0000a6a0: 6f6e 2074 6f20 7275 6e20 6974 2069 6e20  on to run it in 
-0000a6b0: 6120 6772 6164 2063 6f6e 7465 7874 3f0a  a grad context?.
-0000a6c0: 2020 2020 2020 2020 2020 2020 6772 6164              grad
-0000a6d0: 5f73 7065 6369 6669 6572 2872 6573 756c  _specifier(resul
-0000a6e0: 7429 0a20 2020 2020 2020 2020 2020 2023  t).            #
-0000a6f0: 2043 6f6e 7374 7275 6374 7320 7265 7475   Constructs retu
-0000a700: 726e 2076 616c 7565 0a20 2020 2020 2020  rn value.       
-0000a710: 2020 2020 2066 6c61 745f 6772 6164 7320       flat_grads 
-0000a720: 3d20 6772 6164 5f6f 7574 5f73 7065 6369  = grad_out_speci
-0000a730: 6669 6572 2828 6172 6773 2c20 6b77 6172  fier((args, kwar
-0000a740: 6773 2929 0a20 2020 2020 2020 2020 2020  gs)).           
-0000a750: 2072 6574 7572 6e20 666c 6174 5f67 7261   return flat_gra
-0000a760: 6473 0a0a 2020 2020 2020 2020 2320 4e4f  ds..        # NO
-0000a770: 5445 2041 6674 6572 2074 6869 7320 6361  TE After this ca
-0000a780: 6c6c 2074 6865 2067 7261 6474 7263 2069  ll the gradtrc i
-0000a790: 7320 696e 7661 6c69 642c 2062 6563 6175  s invalid, becau
-0000a7a0: 7365 3a0a 2020 2020 2020 2020 2320 2020  se:.        #   
-0000a7b0: 3129 2054 6865 206e 6f6e 2d65 7865 6375  1) The non-execu
-0000a7c0: 7461 626c 6520 7075 745f 6772 6164 206f  table put_grad o
-0000a7d0: 7065 7261 7469 6f6e 7320 6172 6520 7374  perations are st
-0000a7e0: 696c 6c20 696e 2074 6865 2074 7261 6365  ill in the trace
-0000a7f0: 2c20 616e 6420 6d75 6c74 6970 6c65 2063  , and multiple c
-0000a800: 616c 6c73 2074 6f20 7075 7420 6772 6164  alls to put grad
-0000a810: 2061 7265 206e 6f74 2061 6363 756d 756c   are not accumul
-0000a820: 6174 6564 0a20 2020 2020 2020 2023 2020  ated.        #  
-0000a830: 2032 2920 5468 6520 6e6f 6e2d 6578 6563   2) The non-exec
-0000a840: 7574 6162 6c65 2067 6574 5f67 7261 6420  utable get_grad 
-0000a850: 6f70 6572 6174 696f 6e73 2061 7265 2073  operations are s
-0000a860: 7469 6c6c 2069 6e20 7468 6520 7472 6163  till in the trac
-0000a870: 652c 2061 6e64 2074 6865 7920 6d61 7920  e, and they may 
-0000a880: 7072 6f64 7563 6520 6469 6666 6572 656e  produce differen
-0000a890: 7420 7072 6f78 6965 7320 7768 656e 0a20  t proxies when. 
-0000a8a0: 2020 2020 2020 2023 2020 2020 2020 2063         #       c
-0000a8b0: 616c 6c65 6420 6f6e 2074 6865 2073 616d  alled on the sam
-0000a8c0: 6520 696e 7075 7473 0a20 2020 2020 2020  e inputs.       
-0000a8d0: 2023 2020 2033 2920 5468 6520 6f70 6572   #   3) The oper
-0000a8e0: 6174 696f 6e73 2061 7265 206e 6f74 2069  ations are not i
-0000a8f0: 6e20 6120 7661 6c69 6420 6f72 6465 720a  n a valid order.
-0000a900: 2020 2020 2020 2020 6772 6164 7472 6320          gradtrc 
-0000a910: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
-0000a920: 6528 0a20 2020 2020 2020 2020 2020 2072  e(.            r
-0000a930: 656e 616d 655f 7072 6f78 6965 733d 4661  ename_proxies=Fa
-0000a940: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-0000a950: 2075 7365 5f64 6365 3d46 616c 7365 2c0a   use_dce=False,.
-0000a960: 2020 2020 2020 2020 2928 696e 7465 7270          )(interp
-0000a970: 7265 7469 6e67 5f66 6e2c 202a 6772 6164  reting_fn, *grad
-0000a980: 7472 632e 6172 6773 2c20 2a2a 6772 6164  trc.args, **grad
-0000a990: 7472 632e 6b77 6172 6773 290a 2020 2020  trc.kwargs).    
-0000a9a0: 2020 2020 6772 6164 7472 632e 7363 6f70      gradtrc.scop
-0000a9b0: 6573 203d 205b 6772 6164 7472 632e 626f  es = [gradtrc.bo
-0000a9c0: 756e 645f 7379 6d62 6f6c 735d 0a20 2020  und_symbols].   
-0000a9d0: 2020 2020 2067 7261 6474 7263 2e5f 636f       gradtrc._co
-0000a9e0: 6d70 6c65 7465 203d 2046 616c 7365 0a0a  mplete = False..
-0000a9f0: 2020 2020 2020 2020 2320 5354 4550 2054          # STEP T
-0000aa00: 4852 4545 202d 2d20 4861 6e64 6c65 7320  HREE -- Handles 
-0000aa10: 7075 745f 6772 6164 2061 6e64 2067 6574  put_grad and get
-0000aa20: 5f67 7261 6420 6f70 6572 6174 696f 6e73  _grad operations
-0000aa30: 2061 6e64 2061 6363 756d 756c 6174 6573   and accumulates
-0000aa40: 2067 7261 6469 656e 7473 0a0a 2020 2020   gradients..    
-0000aa50: 2020 2020 2320 4163 6375 6d75 6c61 7465      # Accumulate
-0000aa60: 7320 6772 6164 6965 6e74 732c 2063 7265  s gradients, cre
-0000aa70: 6174 696e 6720 7468 6520 7072 696d 616c  ating the primal
-0000aa80: 202d 3e20 6163 6375 6d75 6c61 7465 6420   -> accumulated 
-0000aa90: 6772 6164 206d 6170 7069 6e67 0a20 2020  grad mapping.   
-0000aaa0: 2020 2020 2023 2053 6574 7320 7468 6520       # Sets the 
-0000aab0: 7472 6163 696e 6720 636f 6e74 6578 7420  tracing context 
-0000aac0: 736f 2061 6363 756d 756c 6174 696f 6e20  so accumulation 
-0000aad0: 6f70 6572 6174 696f 6e73 2061 7265 2072  operations are r
-0000aae0: 6563 6f72 6465 6420 696e 746f 2074 6865  ecorded into the
-0000aaf0: 2074 7261 6365 0a20 2020 2020 2020 2074   trace.        t
-0000ab00: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000ab10: 7472 6163 6563 7478 5f74 6f6b 203d 2073  tracectx_tok = s
-0000ab20: 6574 5f74 7261 6365 6374 7828 6772 6164  et_tracectx(grad
-0000ab30: 7472 6329 0a0a 2020 2020 2020 2020 2020  trc)..          
-0000ab40: 2020 2320 4d61 7073 2070 7269 6d61 6c73    # Maps primals
-0000ab50: 2074 6f20 7468 6569 7220 6772 6164 6965   to their gradie
-0000ab60: 6e74 7320 2877 6869 6368 2061 7265 2072  nts (which are r
-0000ab70: 6574 7572 6e65 6420 6672 6f6d 2063 616c  eturned from cal
-0000ab80: 6c69 6e67 2067 6574 5f67 7261 6420 6f6e  ling get_grad on
-0000ab90: 2074 6865 2070 7269 6d61 6c29 0a20 2020   the primal).   
-0000aba0: 2020 2020 2020 2020 2070 7269 6d61 6c73           primals
-0000abb0: 5f74 6f5f 6769 6e70 7574 5f6d 6170 3a20  _to_ginput_map: 
-0000abc0: 6469 6374 5b56 6172 6961 626c 652c 2054  dict[Variable, T
-0000abd0: 656e 736f 7250 726f 7879 5d20 3d20 7b7d  ensorProxy] = {}
-0000abe0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000abf0: 4861 6e64 6c65 7320 7075 745f 6772 6164  Handles put_grad
-0000ac00: 206f 7065 7261 7469 6f6e 730a 2020 2020   operations.    
-0000ac10: 2020 2020 2020 2020 2320 4e4f 5445 2054          # NOTE T
-0000ac20: 6869 7320 6d6f 6469 6669 6573 2061 206c  his modifies a l
-0000ac30: 6973 7420 7468 6174 2069 7320 6265 696e  ist that is bein
-0000ac40: 6720 656e 756d 6572 6174 6564 206f 7665  g enumerated ove
-0000ac50: 722c 2062 7574 2069 7427 7320 4f4b 2062  r, but it's OK b
-0000ac60: 6563 6175 7365 2077 6527 7265 206f 6e6c  ecause we're onl
-0000ac70: 790a 2020 2020 2020 2020 2020 2020 2320  y.            # 
-0000ac80: 2020 6170 7065 6e64 696e 6720 746f 2074    appending to t
-0000ac90: 6865 2065 6e64 206f 6620 7468 6520 6c69  he end of the li
-0000aca0: 7374 0a20 2020 2020 2020 2020 2020 2062  st.            b
-0000acb0: 7379 6d3a 2042 6f75 6e64 5379 6d62 6f6c  sym: BoundSymbol
-0000acc0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000acd0: 2062 7379 6d20 696e 2067 7261 6474 7263   bsym in gradtrc
-0000ace0: 2e62 6f75 6e64 5f73 796d 626f 6c73 3a0a  .bound_symbols:.
-0000acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad00: 6964 3a20 4861 7368 6162 6c65 203d 2062  id: Hashable = b
-0000ad10: 7379 6d2e 7379 6d2e 6964 0a20 2020 2020  sym.sym.id.     
-0000ad20: 2020 2020 2020 2020 2020 2069 6620 6964             if id
-0000ad30: 2069 7320 7069 6473 2e50 5554 5f47 5241   is pids.PUT_GRA
-0000ad40: 443a 0a20 2020 2020 2020 2020 2020 2020  D:.             
-0000ad50: 2020 2020 2020 2070 7269 6d61 6c3a 204e         primal: N
-0000ad60: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-0000ad70: 6f78 790a 2020 2020 2020 2020 2020 2020  oxy.            
-0000ad80: 2020 2020 2020 2020 6772 6164 3a20 4e75          grad: Nu
-0000ad90: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-0000ada0: 7879 0a20 2020 2020 2020 2020 2020 2020  xy.             
-0000adb0: 2020 2020 2020 2070 7269 6d61 6c2c 2067         primal, g
-0000adc0: 7261 6420 3d20 6273 796d 2e66 6c61 745f  rad = bsym.flat_
-0000add0: 6172 6773 0a0a 2020 2020 2020 2020 2020  args..          
-0000ade0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
-0000adf0: 2053 7570 706f 7274 2061 7574 6f67 7261   Support autogra
-0000ae00: 6420 6f6e 206e 756d 6265 7273 0a20 2020  d on numbers.   
-0000ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae20: 2023 2046 696c 7465 7273 2063 616c 6c73   # Filters calls
-0000ae30: 2074 6f20 7075 745f 6772 6164 2074 6861   to put_grad tha
-0000ae40: 7420 776f 756c 6420 7075 7420 6120 6772  t would put a gr
-0000ae50: 6164 206f 6e20 6120 6e6f 6e2d 7465 6e73  ad on a non-tens
-0000ae60: 6f72 206f 7220 6120 7465 6e73 6f72 2074  or or a tensor t
-0000ae70: 6861 7420 646f 6573 6e27 7420 7265 7175  hat doesn't requ
-0000ae80: 6972 6520 6772 6164 0a20 2020 2020 2020  ire grad.       
-0000ae90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000aea0: 6e6f 7420 6973 696e 7374 616e 6365 2870  not isinstance(p
-0000aeb0: 7269 6d61 6c2c 2054 656e 736f 7250 726f  rimal, TensorPro
-0000aec0: 7879 2920 6f72 206e 6f74 2070 7269 6d61  xy) or not prima
-0000aed0: 6c2e 7265 7175 6972 6573 5f67 7261 643a  l.requires_grad:
-0000aee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aef0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-0000af00: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-0000af10: 2020 2020 2020 2023 2054 4f44 4f20 5375         # TODO Su
-0000af20: 7070 6f72 7420 636f 6d70 6c65 7820 6175  pport complex au
-0000af30: 746f 6772 6164 0a20 2020 2020 2020 2020  tograd.         
-0000af40: 2020 2020 2020 2020 2020 2063 6865 636b             check
-0000af50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000af60: 2020 2020 2020 2020 2020 6e6f 7420 6474            not dt
-0000af70: 7970 6573 2e69 735f 636f 6d70 6c65 785f  ypes.is_complex_
-0000af80: 6474 7970 6528 6474 7970 6573 2e74 6f5f  dtype(dtypes.to_
-0000af90: 6474 7970 6528 7072 696d 616c 2929 2c0a  dtype(primal)),.
-0000afa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afb0: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-0000afc0: 6622 436f 6d70 6c65 7820 6772 6164 2069  f"Complex grad i
-0000afd0: 7320 6e6f 7420 7375 7070 6f72 7465 6420  s not supported 
-0000afe0: 7965 7422 2c0a 2020 2020 2020 2020 2020  yet",.          
-0000aff0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0000b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b010: 2076 7072 696d 616c 3a20 5661 7269 6162   vprimal: Variab
-0000b020: 6c65 203d 2076 6172 6961 626c 6569 6679  le = variableify
-0000b030: 2870 7269 6d61 6c29 0a20 2020 2020 2020  (primal).       
-0000b040: 2020 2020 2020 2020 2020 2020 2061 6363               acc
-0000b050: 756d 3a20 4e6f 6e65 207c 2054 656e 736f  um: None | Tenso
-0000b060: 7250 726f 7879 203d 2070 7269 6d61 6c73  rProxy = primals
-0000b070: 5f74 6f5f 6769 6e70 7574 5f6d 6170 2e67  _to_ginput_map.g
-0000b080: 6574 2876 7072 696d 616c 2c20 4e6f 6e65  et(vprimal, None
-0000b090: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000b0a0: 2020 2020 2020 2069 6620 6163 6375 6d20         if accum 
-0000b0b0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0d0: 2070 7269 6d61 6c73 5f74 6f5f 6769 6e70   primals_to_ginp
-0000b0e0: 7574 5f6d 6170 5b76 7072 696d 616c 5d20  ut_map[vprimal] 
-0000b0f0: 3d20 6772 6164 0a20 2020 2020 2020 2020  = grad.         
-0000b100: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000b110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b120: 2020 2020 2020 2020 2061 6363 756d 203d           accum =
-0000b130: 2061 6363 756d 202b 2067 7261 640a 2020   accum + grad.  
-0000b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b150: 2020 2020 2020 7072 696d 616c 735f 746f        primals_to
-0000b160: 5f67 696e 7075 745f 6d61 705b 7670 7269  _ginput_map[vpri
-0000b170: 6d61 6c5d 203d 2061 6363 756d 0a0a 2020  mal] = accum..  
-0000b180: 2020 2020 2020 2020 2020 2320 4861 6e64            # Hand
-0000b190: 6c65 7320 6765 745f 6772 6164 206f 7065  les get_grad ope
-0000b1a0: 7261 7469 6f6e 730a 0a20 2020 2020 2020  rations..       
-0000b1b0: 2020 2020 2023 2052 6573 6574 7320 7468       # Resets th
-0000b1c0: 6520 7377 6170 6d61 7020 666f 7220 6772  e swapmap for gr
-0000b1d0: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
-0000b1e0: 7377 6170 6d61 703a 2064 6963 745b 5661  swapmap: dict[Va
-0000b1f0: 7269 6162 6c65 2c20 5072 6f78 795d 203d  riable, Proxy] =
-0000b200: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
-0000b210: 2066 6f72 2062 7379 6d20 696e 2067 7261   for bsym in gra
-0000b220: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
-0000b230: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
-0000b240: 2020 2020 6964 3a20 4861 7368 6162 6c65      id: Hashable
-0000b250: 203d 2062 7379 6d2e 7379 6d2e 6964 0a20   = bsym.sym.id. 
-0000b260: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000b270: 6620 6964 2069 7320 7069 6473 2e47 4554  f id is pids.GET
-0000b280: 5f47 5241 443a 0a20 2020 2020 2020 2020  _GRAD:.         
-0000b290: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
-0000b2a0: 6c3a 204e 756d 6265 7220 7c20 5465 6e73  l: Number | Tens
-0000b2b0: 6f72 5072 6f78 790a 2020 2020 2020 2020  orProxy.        
-0000b2c0: 2020 2020 2020 2020 2020 2020 2870 7269              (pri
-0000b2d0: 6d61 6c2c 2920 3d20 6273 796d 2e66 6c61  mal,) = bsym.fla
-0000b2e0: 745f 6172 6773 0a20 2020 2020 2020 2020  t_args.         
-0000b2f0: 2020 2020 2020 2020 2020 2067 7261 643a             grad:
-0000b300: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-0000b310: 5072 6f78 7920 3d20 6273 796d 2e6f 7574  Proxy = bsym.out
-0000b320: 7075 740a 0a20 2020 2020 2020 2020 2020  put..           
-0000b330: 2020 2020 2020 2020 2076 7072 696d 616c           vprimal
-0000b340: 3a20 5661 7269 6162 6c65 0a20 2020 2020  : Variable.     
-0000b350: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0000b360: 6772 6164 3a20 5661 7269 6162 6c65 0a20  grad: Variable. 
-0000b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b380: 2020 2076 7072 696d 616c 2c20 7667 7261     vprimal, vgra
-0000b390: 6420 3d20 7661 7269 6162 6c65 6966 7928  d = variableify(
-0000b3a0: 7072 696d 616c 292c 2076 6172 6961 626c  primal), variabl
-0000b3b0: 6569 6679 2867 7261 6429 0a0a 2020 2020  eify(grad)..    
+00006a60: 6620 5f67 6174 6865 725f 7072 696d 5f67  f _gather_prim_g
+00006a70: 7261 6428 613a 2054 656e 736f 7250 726f  rad(a: TensorPro
+00006a80: 7879 2c20 696e 6465 783a 2054 656e 736f  xy, index: Tenso
+00006a90: 7250 726f 7879 2c20 6469 6d3a 2069 6e74  rProxy, dim: int
+00006aa0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+00006ab0: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00006ac0: 732e 6761 7468 6572 2861 2c20 696e 6465  s.gather(a, inde
+00006ad0: 782c 2064 696d 290a 0a20 2020 2067 203d  x, dim)..    g =
+00006ae0: 2067 6574 5f67 7261 6428 6677 6429 0a20   get_grad(fwd). 
+00006af0: 2020 2023 204e 4f54 4520 496e 7465 6e74     # NOTE Intent
+00006b00: 696f 6e61 6c6c 7920 6e6f 7420 6361 6c6c  ionally not call
+00006b10: 696e 6720 7a65 726f 735f 6c69 6b65 2074  ing zeros_like t
+00006b20: 6f20 6176 6f69 6420 7072 6573 6572 7669  o avoid preservi
+00006b30: 6e67 2054 656e 736f 7250 726f 7879 2061  ng TensorProxy a
+00006b40: 2e0a 2020 2020 2320 544f 444f 2055 7064  ..    # TODO Upd
+00006b50: 6174 6520 746f 2063 616c 6c20 6c74 6f72  ate to call ltor
+00006b60: 6368 2e7a 6572 6f73 0a20 2020 207a 6572  ch.zeros.    zer
+00006b70: 6f73 203d 2070 7269 6d73 2e66 756c 6c28  os = prims.full(
+00006b80: 612e 7368 6170 652c 2066 696c 6c5f 7661  a.shape, fill_va
+00006b90: 6c75 653d 302c 2064 6576 6963 653d 612e  lue=0, device=a.
+00006ba0: 6465 7669 6365 2c20 6474 7970 653d 612e  device, dtype=a.
+00006bb0: 6474 7970 6529 0a20 2020 2061 5f67 7261  dtype).    a_gra
+00006bc0: 6420 3d20 7072 696d 732e 7363 6174 7465  d = prims.scatte
+00006bd0: 725f 6164 6428 7a65 726f 732c 2069 6e64  r_add(zeros, ind
+00006be0: 6578 2c20 672c 2064 696d 290a 2020 2020  ex, g, dim).    
+00006bf0: 7075 745f 6772 6164 2861 2c20 615f 6772  put_grad(a, a_gr
+00006c00: 6164 290a 0a20 2020 2072 6574 7572 6e20  ad)..    return 
+00006c10: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+00006c20: 7261 6428 7069 6473 2e47 4154 4845 522c  rad(pids.GATHER,
+00006c30: 205f 6761 7468 6572 5f70 7269 6d5f 6772   _gather_prim_gr
+00006c40: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
+00006c50: 6465 6620 5f74 616b 655f 616c 6f6e 675f  def _take_along_
+00006c60: 6178 6973 5f70 7269 6d5f 6772 6164 2861  axis_prim_grad(a
+00006c70: 3a20 5465 6e73 6f72 5072 6f78 792c 2069  : TensorProxy, i
+00006c80: 6e64 6578 3a20 5465 6e73 6f72 5072 6f78  ndex: TensorProx
+00006c90: 792c 2064 696d 3a20 696e 7429 202d 3e20  y, dim: int) -> 
+00006ca0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00006cb0: 2066 7764 203d 2070 7269 6d73 2e74 616b   fwd = prims.tak
+00006cc0: 655f 616c 6f6e 675f 6178 6973 2861 2c20  e_along_axis(a, 
+00006cd0: 696e 6465 782c 2064 696d 290a 0a20 2020  index, dim)..   
+00006ce0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+00006cf0: 6429 0a20 2020 2023 204e 4f54 4520 496e  d).    # NOTE In
+00006d00: 7465 6e74 696f 6e61 6c6c 7920 6e6f 7420  tentionally not 
+00006d10: 6361 6c6c 696e 6720 7a65 726f 735f 6c69  calling zeros_li
+00006d20: 6b65 2074 6f20 6176 6f69 6420 7072 6573  ke to avoid pres
+00006d30: 6572 7669 6e67 2054 656e 736f 7250 726f  erving TensorPro
+00006d40: 7879 2061 2e0a 2020 2020 2320 544f 444f  xy a..    # TODO
+00006d50: 2055 7064 6174 6520 746f 2063 616c 6c20   Update to call 
+00006d60: 6c74 6f72 6368 2e7a 6572 6f73 0a20 2020  ltorch.zeros.   
+00006d70: 207a 6572 6f73 203d 2070 7269 6d73 2e66   zeros = prims.f
+00006d80: 756c 6c28 612e 7368 6170 652c 2066 696c  ull(a.shape, fil
+00006d90: 6c5f 7661 6c75 653d 302c 2064 6576 6963  l_value=0, devic
+00006da0: 653d 612e 6465 7669 6365 2c20 6474 7970  e=a.device, dtyp
+00006db0: 653d 612e 6474 7970 6529 0a20 2020 2061  e=a.dtype).    a
+00006dc0: 5f67 7261 6420 3d20 7072 696d 732e 7363  _grad = prims.sc
+00006dd0: 6174 7465 725f 6164 6428 7a65 726f 732c  atter_add(zeros,
+00006de0: 2069 6e64 6578 2c20 672c 2064 696d 290a   index, g, dim).
+00006df0: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+00006e00: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
+00006e10: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00006e20: 6572 5f67 7261 6428 7069 6473 2e54 414b  er_grad(pids.TAK
+00006e30: 455f 414c 4f4e 475f 4158 4953 2c20 5f74  E_ALONG_AXIS, _t
+00006e40: 616b 655f 616c 6f6e 675f 6178 6973 5f70  ake_along_axis_p
+00006e50: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
+00006e60: 6368 6374 780a 6465 6620 5f74 7261 6e73  chctx.def _trans
+00006e70: 706f 7365 5f70 7269 6d5f 6772 6164 2861  pose_prim_grad(a
+00006e80: 3a20 5465 6e73 6f72 5072 6f78 792c 2070  : TensorProxy, p
+00006e90: 6572 6d75 7461 7469 6f6e 3a20 7475 706c  ermutation: tupl
+00006ea0: 655b 696e 742c 202e 2e2e 5d29 202d 3e20  e[int, ...]) -> 
+00006eb0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00006ec0: 2066 7764 203d 2070 7269 6d73 2e74 7261   fwd = prims.tra
+00006ed0: 6e73 706f 7365 2861 2c20 7475 706c 6528  nspose(a, tuple(
+00006ee0: 7065 726d 7574 6174 696f 6e29 290a 0a20  permutation)).. 
+00006ef0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00006f00: 6677 6429 0a20 2020 2075 6e64 6f20 3d20  fwd).    undo = 
+00006f10: 5f61 7267 736f 7274 2870 6572 6d75 7461  _argsort(permuta
+00006f20: 7469 6f6e 290a 2020 2020 615f 6772 6164  tion).    a_grad
+00006f30: 203d 2070 7269 6d73 2e74 7261 6e73 706f   = prims.transpo
+00006f40: 7365 2867 2c20 7475 706c 6528 756e 646f  se(g, tuple(undo
+00006f50: 2929 0a20 2020 2070 7574 5f67 7261 6428  )).    put_grad(
+00006f60: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
+00006f70: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
+00006f80: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+00006f90: 5452 414e 5350 4f53 452c 205f 7472 616e  TRANSPOSE, _tran
+00006fa0: 7370 6f73 655f 7072 696d 5f67 7261 6429  spose_prim_grad)
+00006fb0: 0a0a 230a 2320 4d65 6d6f 7279 206c 6179  ..#.# Memory lay
+00006fc0: 6f75 7420 6f70 6572 6174 6f72 2067 7261  out operator gra
+00006fd0: 6473 0a23 0a0a 0a40 746f 7263 6863 7478  ds.#...@torchctx
+00006fe0: 0a64 6566 205f 7374 7269 6465 5f6f 7264  .def _stride_ord
+00006ff0: 6572 5f70 7269 6d5f 6772 6164 2861 3a20  er_prim_grad(a: 
+00007000: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
+00007010: 6f72 6465 723a 2053 6571 7565 6e63 655b  order: Sequence[
+00007020: 696e 745d 2920 2d3e 2054 656e 736f 7250  int]) -> TensorP
+00007030: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
+00007040: 7072 696d 732e 7374 7269 6465 5f6f 7264  prims.stride_ord
+00007050: 6572 2861 2c20 6f72 6465 7229 0a0a 2020  er(a, order)..  
+00007060: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
+00007070: 7764 290a 2020 2020 7075 745f 6772 6164  wd).    put_grad
+00007080: 2861 2c20 6729 0a0a 2020 2020 7265 7475  (a, g)..    retu
+00007090: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+000070a0: 725f 6772 6164 2870 6964 732e 5354 5249  r_grad(pids.STRI
+000070b0: 4445 5f4f 5244 4552 2c20 5f73 7472 6964  DE_ORDER, _strid
+000070c0: 655f 6f72 6465 725f 7072 696d 5f67 7261  e_order_prim_gra
+000070d0: 6429 0a0a 0a23 0a23 2045 6c65 6d65 6e74  d)...#.# Element
+000070e0: 7769 7365 2075 6e61 7279 206f 7065 7261  wise unary opera
+000070f0: 746f 7220 6772 6164 730a 230a 4074 6f72  tor grads.#.@tor
+00007100: 6368 6374 780a 6465 6620 5f61 6273 5f70  chctx.def _abs_p
+00007110: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
+00007120: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00007130: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
+00007140: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
+00007150: 7764 203d 2070 7269 6d73 2e61 6273 2861  wd = prims.abs(a
+00007160: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00007170: 7261 6428 6677 6429 0a20 2020 2070 7574  rad(fwd).    put
+00007180: 5f67 7261 6428 612c 2067 202a 206c 746f  _grad(a, g * lto
+00007190: 7263 682e 7369 676e 2861 2929 0a0a 2020  rch.sign(a))..  
+000071a0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+000071b0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+000071c0: 732e 4142 532c 205f 6162 735f 7072 696d  s.ABS, _abs_prim
+000071d0: 5f67 7261 6429 0a0a 0a64 6566 205f 636f  _grad)...def _co
+000071e0: 735f 7072 696d 5f67 7261 6428 613a 204e  s_prim_grad(a: N
+000071f0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00007200: 6f78 7929 202d 3e20 4e75 6d62 6572 207c  oxy) -> Number |
+00007210: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+00007220: 2020 6677 6420 3d20 7072 696d 732e 636f    fwd = prims.co
+00007230: 7328 6129 0a0a 2020 2020 6720 3d20 6765  s(a)..    g = ge
+00007240: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+00007250: 7075 745f 6772 6164 2861 2c20 6720 2a20  put_grad(a, g * 
+00007260: 282d 7072 696d 732e 7369 6e28 6129 2929  (-prims.sin(a)))
+00007270: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00007280: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00007290: 2870 6964 732e 434f 532c 205f 636f 735f  (pids.COS, _cos_
+000072a0: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
+000072b0: 7263 6863 7478 0a64 6566 205f 6572 665f  rchctx.def _erf_
+000072c0: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
+000072d0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+000072e0: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
+000072f0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00007300: 6677 6420 3d20 7072 696d 732e 6572 6628  fwd = prims.erf(
+00007310: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
+00007320: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
+00007330: 6772 6164 203d 2032 202f 206d 6174 682e  grad = 2 / math.
+00007340: 7371 7274 286d 6174 682e 7069 2920 2a20  sqrt(math.pi) * 
+00007350: 6c74 6f72 6368 2e65 7870 282d 2861 2a2a  ltorch.exp(-(a**
+00007360: 3229 2920 2a20 670a 2020 2020 7075 745f  2)) * g.    put_
+00007370: 6772 6164 2861 2c20 615f 6772 6164 290a  grad(a, a_grad).
+00007380: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
+00007390: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
+000073a0: 7069 6473 2e45 5246 2c20 5f65 7266 5f70  pids.ERF, _erf_p
+000073b0: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
+000073c0: 6368 6374 780a 6465 6620 5f65 7870 5f70  chctx.def _exp_p
+000073d0: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
+000073e0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+000073f0: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
+00007400: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
+00007410: 7764 203d 2070 7269 6d73 2e65 7870 2861  wd = prims.exp(a
+00007420: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00007430: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
+00007440: 7261 6420 3d20 6720 2a20 6677 640a 2020  rad = g * fwd.  
+00007450: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
+00007460: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
+00007470: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
+00007480: 5f67 7261 6428 7069 6473 2e45 5850 2c20  _grad(pids.EXP, 
+00007490: 5f65 7870 5f70 7269 6d5f 6772 6164 290a  _exp_prim_grad).
+000074a0: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
+000074b0: 5f6c 6f67 5f70 7269 6d5f 6772 6164 2861  _log_prim_grad(a
+000074c0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
+000074d0: 7250 726f 7879 2920 2d3e 204e 756d 6265  rProxy) -> Numbe
+000074e0: 7220 7c20 5465 6e73 6f72 5072 6f78 793a  r | TensorProxy:
+000074f0: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
+00007500: 2e6c 6f67 2861 290a 0a20 2020 2067 203d  .log(a)..    g =
+00007510: 2067 6574 5f67 7261 6428 6677 6429 0a20   get_grad(fwd). 
+00007520: 2020 2061 5f67 7261 6420 3d20 6720 2f20     a_grad = g / 
+00007530: 610a 2020 2020 7075 745f 6772 6164 2861  a.    put_grad(a
+00007540: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
+00007550: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00007560: 7374 6572 5f67 7261 6428 7069 6473 2e4c  ster_grad(pids.L
+00007570: 4f47 2c20 5f6c 6f67 5f70 7269 6d5f 6772  OG, _log_prim_gr
+00007580: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
+00007590: 6465 6620 5f6e 6567 5f70 7269 6d5f 6772  def _neg_prim_gr
+000075a0: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
+000075b0: 656e 736f 7250 726f 7879 2920 2d3e 204e  ensorProxy) -> N
+000075c0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+000075d0: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
+000075e0: 7269 6d73 2e6e 6567 2861 290a 0a20 2020  rims.neg(a)..   
+000075f0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+00007600: 6429 0a20 2020 2070 7574 5f67 7261 6428  d).    put_grad(
+00007610: 612c 202d 6729 0a0a 2020 2020 7265 7475  a, -g)..    retu
+00007620: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+00007630: 725f 6772 6164 2870 6964 732e 4e45 472c  r_grad(pids.NEG,
+00007640: 205f 6e65 675f 7072 696d 5f67 7261 6429   _neg_prim_grad)
+00007650: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+00007660: 205f 7273 7172 745f 7072 696d 5f67 7261   _rsqrt_prim_gra
+00007670: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
+00007680: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
+00007690: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+000076a0: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+000076b0: 2070 7269 6d73 2e72 7371 7274 2861 290a   prims.rsqrt(a).
+000076c0: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+000076d0: 6428 6677 6429 0a20 2020 2023 2041 6e20  d(fwd).    # An 
+000076e0: 616c 7465 726e 6174 6976 6520 6465 7269  alternative deri
+000076f0: 7661 7469 6f6e 2075 7365 6420 6279 204a  vation used by J
+00007700: 4158 2069 7320 2d30 2e35 202a 2067 202a  AX is -0.5 * g *
+00007710: 2072 7371 7274 2878 2920 2f20 780a 2020   rsqrt(x) / x.  
+00007720: 2020 2320 7768 6572 6520 7273 7172 7428    # where rsqrt(
+00007730: 7829 2061 6e64 2078 2061 7265 2073 6176  x) and x are sav
+00007740: 6564 2066 6f72 2074 6865 2062 6163 6b77  ed for the backw
+00007750: 6172 6473 2070 6173 732e 0a20 2020 2023  ards pass..    #
+00007760: 2054 6869 7320 6465 7269 7661 7469 6f6e   This derivation
+00007770: 2077 6173 2073 656c 6563 7465 6420 6265   was selected be
+00007780: 6361 7573 6520 6974 2061 766f 6964 7320  cause it avoids 
+00007790: 7361 7669 6e67 2074 6865 2069 6e70 7574  saving the input
+000077a0: 2074 656e 736f 722e 0a20 2020 2061 5f67   tensor..    a_g
+000077b0: 7261 6420 3d20 2d30 2e35 202a 2067 202a  rad = -0.5 * g *
+000077c0: 2066 7764 2a2a 332e 300a 2020 2020 7075   fwd**3.0.    pu
+000077d0: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
+000077e0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+000077f0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+00007800: 6428 7069 6473 2e52 5351 5254 2c20 5f72  d(pids.RSQRT, _r
+00007810: 7371 7274 5f70 7269 6d5f 6772 6164 290a  sqrt_prim_grad).
+00007820: 0a0a 6465 6620 5f73 696e 5f70 7269 6d5f  ..def _sin_prim_
+00007830: 6772 6164 2861 3a20 4e75 6d62 6572 207c  grad(a: Number |
+00007840: 2054 656e 736f 7250 726f 7879 2920 2d3e   TensorProxy) ->
+00007850: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00007860: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+00007870: 2070 7269 6d73 2e73 696e 2861 290a 0a20   prims.sin(a).. 
+00007880: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00007890: 6677 6429 0a20 2020 2070 7574 5f67 7261  fwd).    put_gra
+000078a0: 6428 612c 2067 202a 2070 7269 6d73 2e63  d(a, g * prims.c
+000078b0: 6f73 2861 2929 0a0a 2020 2020 7265 7475  os(a))..    retu
+000078c0: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+000078d0: 725f 6772 6164 2870 6964 732e 5349 4e2c  r_grad(pids.SIN,
+000078e0: 205f 7369 6e5f 7072 696d 5f67 7261 6429   _sin_prim_grad)
+000078f0: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+00007900: 205f 7461 6e68 5f70 7269 6d5f 6772 6164   _tanh_prim_grad
+00007910: 2861 3a20 4e75 6d62 6572 207c 2054 656e  (a: Number | Ten
+00007920: 736f 7250 726f 7879 2c20 2f29 202d 3e20  sorProxy, /) -> 
+00007930: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
+00007940: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
+00007950: 7072 696d 732e 7461 6e68 2861 290a 0a20  prims.tanh(a).. 
+00007960: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00007970: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
+00007980: 3d20 6720 2a20 2831 202d 2066 7764 202a  = g * (1 - fwd *
+00007990: 2066 7764 290a 2020 2020 7075 745f 6772   fwd).    put_gr
+000079a0: 6164 2861 2c20 615f 6772 6164 290a 0a20  ad(a, a_grad).. 
+000079b0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+000079c0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+000079d0: 6473 2e54 414e 482c 205f 7461 6e68 5f70  ds.TANH, _tanh_p
+000079e0: 7269 6d5f 6772 6164 290a 0a23 0a23 2045  rim_grad)..#.# E
+000079f0: 6c65 6d65 6e74 7769 7365 2062 696e 6172  lementwise binar
+00007a00: 7920 6f70 6572 6174 6f72 2067 7261 6473  y operator grads
+00007a10: 0a23 0a0a 0a40 746f 7263 6863 7478 0a64  .#...@torchctx.d
+00007a20: 6566 205f 6164 645f 7072 696d 5f67 7261  ef _add_prim_gra
+00007a30: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
+00007a40: 6e73 6f72 5072 6f78 792c 2062 3a20 4e75  nsorProxy, b: Nu
+00007a50: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+00007a60: 7879 2c20 2f29 202d 3e20 4e75 6d62 6572  xy, /) -> Number
+00007a70: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
+00007a80: 2020 2020 6677 6420 3d20 6120 2b20 620a      fwd = a + b.
+00007a90: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00007aa0: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
+00007ab0: 6420 3d20 670a 2020 2020 625f 6772 6164  d = g.    b_grad
+00007ac0: 203d 2067 0a20 2020 2070 7574 5f67 7261   = g.    put_gra
+00007ad0: 6473 2828 612c 2062 292c 2028 615f 6772  ds((a, b), (a_gr
+00007ae0: 6164 2c20 625f 6772 6164 2929 0a0a 2020  ad, b_grad))..  
+00007af0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+00007b00: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+00007b10: 732e 4144 442c 205f 6164 645f 7072 696d  s.ADD, _add_prim
+00007b20: 5f67 7261 6429 0a0a 0a23 204e 4f54 4520  _grad)...# NOTE 
+00007b30: 5468 6520 666f 6c6c 6f77 696e 6720 6772  The following gr
+00007b40: 6164 2064 6566 696e 6974 696f 6e20 7265  ad definition re
+00007b50: 6c69 6573 206f 6e20 7468 6520 6661 6374  lies on the fact
+00007b60: 2074 6861 7420 6f6e 6c79 2069 6e65 7861   that only inexa
+00007b70: 6374 2064 7479 7065 7320 6172 6520 6469  ct dtypes are di
+00007b80: 6666 6572 656e 7469 6162 6c65 2c0a 2320  fferentiable,.# 
+00007b90: 2020 616e 6420 746f 7263 6827 7320 7472    and torch's tr
+00007ba0: 7565 2064 6976 6973 696f 6e20 6f70 6572  ue division oper
+00007bb0: 6174 6f72 2061 6e64 2074 6865 2064 6976  ator and the div
+00007bc0: 6973 696f 6e20 7072 696d 6974 6976 6520  ision primitive 
+00007bd0: 6167 7265 6520 6f6e 2074 686f 7365 2074  agree on those t
+00007be0: 7970 6573 0a40 746f 7263 6863 7478 0a64  ypes.@torchctx.d
+00007bf0: 6566 205f 6469 765f 7072 696d 5f67 7261  ef _div_prim_gra
+00007c00: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
+00007c10: 6e73 6f72 5072 6f78 792c 2062 3a20 4e75  nsorProxy, b: Nu
+00007c20: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+00007c30: 7879 2c20 2f29 202d 3e20 4e75 6d62 6572  xy, /) -> Number
+00007c40: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
+00007c50: 2020 2020 6677 6420 3d20 6120 2f20 620a      fwd = a / b.
+00007c60: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00007c70: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
+00007c80: 6420 3d20 6720 2f20 620a 2020 2020 625f  d = g / b.    b_
+00007c90: 6772 6164 203d 202d 6720 2a20 2828 6120  grad = -g * ((a 
+00007ca0: 2f20 6229 202f 2062 290a 2020 2020 7075  / b) / b).    pu
+00007cb0: 745f 6772 6164 7328 2861 2c20 6229 2c20  t_grads((a, b), 
+00007cc0: 2861 5f67 7261 642c 2062 5f67 7261 6429  (a_grad, b_grad)
+00007cd0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+00007ce0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+00007cf0: 6428 7069 6473 2e44 4956 2c20 5f64 6976  d(pids.DIV, _div
+00007d00: 5f70 7269 6d5f 6772 6164 290a 0a23 2043  _prim_grad)..# C
+00007d10: 6f6d 7061 7269 736f 6e20 6f70 6572 6174  omparison operat
+00007d20: 6f72 7320 2d2d 2074 6865 7365 2063 7265  ors -- these cre
+00007d30: 6174 6520 6e6f 2067 7261 6420 6173 736f  ate no grad asso
+00007d40: 6369 6174 696f 6e73 0a72 6567 6973 7465  ciations.registe
+00007d50: 725f 6772 6164 2870 6964 732e 4551 2c20  r_grad(pids.EQ, 
+00007d60: 7072 696d 732e 6571 290a 7265 6769 7374  prims.eq).regist
+00007d70: 6572 5f67 7261 6428 7069 6473 2e47 452c  er_grad(pids.GE,
+00007d80: 2070 7269 6d73 2e67 6529 0a72 6567 6973   prims.ge).regis
+00007d90: 7465 725f 6772 6164 2870 6964 732e 4c54  ter_grad(pids.LT
+00007da0: 2c20 7072 696d 732e 6c74 290a 0a0a 4074  , prims.lt)...@t
+00007db0: 6f72 6368 6374 780a 6465 6620 5f6d 756c  orchctx.def _mul
+00007dc0: 5f70 7269 6d5f 6772 6164 2861 3a20 4e75  _prim_grad(a: Nu
+00007dd0: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+00007de0: 7879 2c20 623a 204e 756d 6265 7220 7c20  xy, b: Number | 
+00007df0: 5465 6e73 6f72 5072 6f78 792c 202f 2920  TensorProxy, /) 
+00007e00: 2d3e 204e 756d 6265 7220 7c20 5465 6e73  -> Number | Tens
+00007e10: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00007e20: 203d 2061 202a 2062 0a0a 2020 2020 6720   = a * b..    g 
+00007e30: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
+00007e40: 2020 2020 615f 6772 6164 203d 2062 202a      a_grad = b *
+00007e50: 2067 0a20 2020 2062 5f67 7261 6420 3d20   g.    b_grad = 
+00007e60: 6120 2a20 670a 2020 2020 7075 745f 6772  a * g.    put_gr
+00007e70: 6164 7328 2861 2c20 6229 2c20 2861 5f67  ads((a, b), (a_g
+00007e80: 7261 642c 2062 5f67 7261 6429 290a 0a20  rad, b_grad)).. 
+00007e90: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+00007ea0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+00007eb0: 6473 2e4d 554c 2c20 5f6d 756c 5f70 7269  ds.MUL, _mul_pri
+00007ec0: 6d5f 6772 6164 290a 0a0a 4074 6f72 6368  m_grad)...@torch
+00007ed0: 6374 780a 6465 6620 5f73 7562 5f70 7269  ctx.def _sub_pri
+00007ee0: 6d5f 6772 6164 2861 3a20 4e75 6d62 6572  m_grad(a: Number
+00007ef0: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
+00007f00: 623a 204e 756d 6265 7220 7c20 5465 6e73  b: Number | Tens
+00007f10: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
+00007f20: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00007f30: 3a0a 2020 2020 6677 6420 3d20 6120 2d20  :.    fwd = a - 
+00007f40: 620a 0a20 2020 2067 203d 2067 6574 5f67  b..    g = get_g
+00007f50: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
+00007f60: 7261 6420 3d20 670a 2020 2020 625f 6772  rad = g.    b_gr
+00007f70: 6164 203d 202d 670a 2020 2020 7075 745f  ad = -g.    put_
+00007f80: 6772 6164 7328 2861 2c20 6229 2c20 2861  grads((a, b), (a
+00007f90: 5f67 7261 642c 2062 5f67 7261 6429 290a  _grad, b_grad)).
+00007fa0: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
+00007fb0: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
+00007fc0: 7069 6473 2e53 5542 2c20 5f73 7562 5f70  pids.SUB, _sub_p
+00007fd0: 7269 6d5f 6772 6164 290a 0a0a 230a 2320  rim_grad)...#.# 
+00007fe0: 436f 6e64 6974 696f 6e61 6c20 6f70 6572  Conditional oper
+00007ff0: 6174 6f72 2067 7261 6473 0a23 0a0a 0a64  ator grads.#...d
+00008000: 6566 205f 7768 6572 655f 7072 696d 5f67  ef _where_prim_g
+00008010: 7261 6428 7072 6564 3a20 4e75 6d62 6572  rad(pred: Number
+00008020: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
+00008030: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
+00008040: 6f72 5072 6f78 792c 2062 3a20 4e75 6d62  orProxy, b: Numb
+00008050: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00008060: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+00008070: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00008080: 732e 7768 6572 6528 7072 6564 2c20 612c  s.where(pred, a,
+00008090: 2062 290a 0a20 2020 2067 203d 2067 6574   b)..    g = get
+000080a0: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
+000080b0: 5f67 7261 6420 3d20 6c74 6f72 6368 2e77  _grad = ltorch.w
+000080c0: 6865 7265 2870 7265 642c 2067 2c20 3029  here(pred, g, 0)
+000080d0: 0a20 2020 2062 5f67 7261 6420 3d20 6c74  .    b_grad = lt
+000080e0: 6f72 6368 2e77 6865 7265 2870 7265 642c  orch.where(pred,
+000080f0: 2030 2c20 6729 0a20 2020 2070 7574 5f67   0, g).    put_g
+00008100: 7261 6473 2828 612c 2062 292c 2028 615f  rads((a, b), (a_
+00008110: 6772 6164 2c20 625f 6772 6164 2929 0a0a  grad, b_grad))..
+00008120: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00008130: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00008140: 6964 732e 5748 4552 452c 205f 7768 6572  ids.WHERE, _wher
+00008150: 655f 7072 696d 5f67 7261 6429 0a0a 230a  e_prim_grad)..#.
+00008160: 2320 5265 6475 6374 696f 6e20 6f70 6572  # Reduction oper
+00008170: 6174 6f72 2067 7261 6473 0a23 0a0a 0a23  ator grads.#...#
+00008180: 2054 4f44 4f20 5265 7669 6577 2074 7765   TODO Review twe
+00008190: 616b 696e 6720 6772 6164 5f63 686f 6f73  aking grad_choos
+000081a0: 6572 5f70 756c 6c62 6163 6b20 696e 7465  er_pullback inte
+000081b0: 7266 6163 650a 6465 6620 5f61 6d61 785f  rface.def _amax_
+000081c0: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
+000081d0: 736f 7250 726f 7879 2c20 2f2c 2064 696d  sorProxy, /, dim
+000081e0: 733a 2053 6571 7565 6e63 655b 696e 745d  s: Sequence[int]
+000081f0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+00008200: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00008210: 732e 616d 6178 2861 2c20 6469 6d73 290a  s.amax(a, dims).
+00008220: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00008230: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
+00008240: 6420 3d20 6772 6164 5f63 686f 6f73 6572  d = grad_chooser
+00008250: 5f62 6163 6b77 6172 6428 6677 642c 2061  _backward(fwd, a
+00008260: 2c20 612e 7368 6170 652c 2064 696d 732c  , a.shape, dims,
+00008270: 2067 290a 2020 2020 7075 745f 6772 6164   g).    put_grad
+00008280: 2861 2c20 615f 6772 6164 290a 0a20 2020  (a, a_grad)..   
+00008290: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
+000082a0: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+000082b0: 2e41 4d41 582c 205f 616d 6178 5f70 7269  .AMAX, _amax_pri
+000082c0: 6d5f 6772 6164 290a 0a0a 6465 6620 5f73  m_grad)...def _s
+000082d0: 756d 5f70 7269 6d5f 6772 6164 2861 3a20  um_prim_grad(a: 
+000082e0: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
+000082f0: 6469 6d73 3a20 5365 7175 656e 6365 5b69  dims: Sequence[i
+00008300: 6e74 5d29 202d 3e20 5465 6e73 6f72 5072  nt]) -> TensorPr
+00008310: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
+00008320: 7269 6d73 2e73 756d 2861 2c20 6469 6d73  rims.sum(a, dims
+00008330: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00008340: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
+00008350: 7261 6420 3d20 7265 7374 6f72 655f 7265  rad = restore_re
+00008360: 6475 6365 645f 6469 6d73 2867 2c20 6469  duced_dims(g, di
+00008370: 6d73 2c20 612e 7368 6170 6529 0a20 2020  ms, a.shape).   
+00008380: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
+00008390: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
+000083a0: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
+000083b0: 6772 6164 2870 6964 732e 5355 4d2c 205f  grad(pids.SUM, _
+000083c0: 7375 6d5f 7072 696d 5f67 7261 6429 0a0a  sum_prim_grad)..
+000083d0: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
+000083e0: 746f 706b 5f70 7269 6d5f 6772 6164 280a  topk_prim_grad(.
+000083f0: 2020 2020 613a 2054 656e 736f 7250 726f      a: TensorPro
+00008400: 7879 2c20 2f2c 206b 3a20 696e 742c 2064  xy, /, k: int, d
+00008410: 696d 3a20 4e6f 6e65 207c 2069 6e74 203d  im: None | int =
+00008420: 204e 6f6e 652c 206c 6172 6765 7374 3a20   None, largest: 
+00008430: 626f 6f6c 203d 2054 7275 652c 2073 6f72  bool = True, sor
+00008440: 7465 643a 2062 6f6f 6c20 3d20 5472 7565  ted: bool = True
+00008450: 2c20 2a2c 206f 7574 3d4e 6f6e 650a 293a  , *, out=None.):
+00008460: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
+00008470: 2e74 6f70 6b28 612c 206b 2c20 6469 6d2c  .topk(a, k, dim,
+00008480: 206c 6172 6765 7374 2c20 736f 7274 6564   largest, sorted
+00008490: 2c20 6f75 743d 6f75 7429 0a20 2020 2076  , out=out).    v
+000084a0: 616c 2c20 6964 7820 3d20 6677 640a 0a20  al, idx = fwd.. 
+000084b0: 2020 2076 616c 5f67 7261 6420 3d20 6765     val_grad = ge
+000084c0: 745f 6772 6164 2876 616c 290a 0a20 2020  t_grad(val)..   
+000084d0: 2061 5f67 7261 6420 3d20 6c74 6f72 6368   a_grad = ltorch
+000084e0: 2e7a 6572 6f73 5f6c 696b 6528 6129 0a20  .zeros_like(a). 
+000084f0: 2020 2023 2054 4f44 4f3a 2072 6570 6c61     # TODO: repla
+00008500: 6365 2077 6974 6820 7363 6174 7465 7220  ce with scatter 
+00008510: 6f6e 6365 2077 6520 6861 7665 2069 742e  once we have it.
+00008520: 0a20 2020 2023 2073 6361 7474 6572 5f61  .    # scatter_a
+00008530: 6464 2069 7320 6120 7072 696d 2061 6e64  dd is a prim and
+00008540: 2069 7420 7265 6c69 6573 206f 6e20 6174   it relies on at
+00008550: 6f6d 6963 206f 7073 2e0a 2020 2020 615f  omic ops..    a_
+00008560: 6772 6164 203d 206c 746f 7263 682e 7363  grad = ltorch.sc
+00008570: 6174 7465 725f 6164 6428 615f 6772 6164  atter_add(a_grad
+00008580: 2c20 6469 6d2c 2069 6478 2c20 7661 6c5f  , dim, idx, val_
+00008590: 6772 6164 290a 2020 2020 7075 745f 6772  grad).    put_gr
+000085a0: 6164 2861 2c20 615f 6772 6164 290a 0a20  ad(a, a_grad).. 
+000085b0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+000085c0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+000085d0: 6473 2e54 4f50 4b2c 205f 746f 706b 5f70  ds.TOPK, _topk_p
+000085e0: 7269 6d5f 6772 6164 290a 0a0a 2320 544f  rim_grad)...# TO
+000085f0: 444f 2046 6978 2064 6976 6973 696f 6e20  DO Fix division 
+00008600: 6279 207a 6572 6f20 7768 656e 206e 5f65  by zero when n_e
+00008610: 6c65 6d5f 7265 6475 6365 6420 3d3d 2030  lem_reduced == 0
+00008620: 206f 7220 7768 656e 206d 6561 6e2e 6e75   or when mean.nu
+00008630: 6d65 6c20 3d3d 2030 0a23 2020 2062 7920  mel == 0.#   by 
+00008640: 7265 7475 726e 696e 6720 7a65 726f 735f  returning zeros_
+00008650: 6c69 6b65 2861 2920 6f72 2073 696d 696c  like(a) or simil
+00008660: 6172 2e0a 2320 544f 444f 2046 6978 2067  ar..# TODO Fix g
+00008670: 7261 6420 7768 656e 2063 6f72 7265 6374  rad when correct
+00008680: 696f 6e20 3e20 6e5f 656c 656d 5f72 6564  ion > n_elem_red
+00008690: 7563 6564 2e0a 4074 6f72 6368 6374 780a  uced..@torchctx.
+000086a0: 6465 6620 5f76 6172 5f6d 6561 6e5f 7072  def _var_mean_pr
+000086b0: 696d 5f67 7261 6428 613a 2054 656e 736f  im_grad(a: Tenso
+000086c0: 7250 726f 7879 2c20 2f2c 2064 696d 733a  rProxy, /, dims:
+000086d0: 2053 6571 7565 6e63 655b 696e 745d 2c20   Sequence[int], 
+000086e0: 2a2c 2063 6f72 7265 6374 696f 6e3a 204e  *, correction: N
+000086f0: 756d 6265 7229 202d 3e20 5465 6e73 6f72  umber) -> Tensor
+00008700: 5072 6f78 793a 0a20 2020 2076 2c20 6d20  Proxy:.    v, m 
+00008710: 3d20 7072 696d 732e 7661 725f 6d65 616e  = prims.var_mean
+00008720: 2861 2c20 6469 6d73 2c20 636f 7272 6563  (a, dims, correc
+00008730: 7469 6f6e 3d63 6f72 7265 6374 696f 6e29  tion=correction)
+00008740: 0a0a 2020 2020 6776 203d 2067 6574 5f67  ..    gv = get_g
+00008750: 7261 6428 7629 0a20 2020 2067 6d20 3d20  rad(v).    gm = 
+00008760: 6765 745f 6772 6164 286d 290a 0a20 2020  get_grad(m)..   
+00008770: 206e 5f65 6c65 6d5f 7265 6475 6365 6420   n_elem_reduced 
+00008780: 3d20 612e 6e75 6d65 6c20 2f2f 206d 2e6e  = a.numel // m.n
+00008790: 756d 656c 2069 6620 612e 6e75 6d65 6c20  umel if a.numel 
+000087a0: 213d 2030 2065 6c73 6520 310a 0a20 2020  != 0 else 1..   
+000087b0: 2023 2043 6f6d 7075 7465 7320 6d65 616e   # Computes mean
+000087c0: 2062 7764 0a20 2020 206d 6561 6e5f 7363   bwd.    mean_sc
+000087d0: 616c 6520 3d20 312e 3020 2f20 6e5f 656c  ale = 1.0 / n_el
+000087e0: 656d 5f72 6564 7563 6564 0a20 2020 206d  em_reduced.    m
+000087f0: 6561 6e5f 6772 6164 203d 206d 6561 6e5f  ean_grad = mean_
+00008800: 7363 616c 6520 2a20 7265 7374 6f72 655f  scale * restore_
+00008810: 7265 6475 6365 645f 6469 6d73 2867 6d2c  reduced_dims(gm,
+00008820: 2064 696d 732c 2061 2e73 6861 7065 290a   dims, a.shape).
+00008830: 0a20 2020 2023 2043 6f6d 7075 7465 7320  .    # Computes 
+00008840: 7661 7220 6277 640a 2020 2020 6e6f 726d  var bwd.    norm
+00008850: 616c 697a 6174 696f 6e5f 7363 616c 6172  alization_scalar
+00008860: 203d 206e 5f65 6c65 6d5f 7265 6475 6365   = n_elem_reduce
+00008870: 6420 2d20 636f 7272 6563 7469 6f6e 0a20  d - correction. 
+00008880: 2020 2072 6573 746f 7265 645f 6776 203d     restored_gv =
+00008890: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
+000088a0: 5f64 696d 7328 6776 2c20 6469 6d73 2c20  _dims(gv, dims, 
+000088b0: 612e 7368 6170 6529 0a20 2020 2023 2049  a.shape).    # I
+000088c0: 6e73 6572 7469 6e67 2061 2063 6f6e 7665  nserting a conve
+000088d0: 7273 696f 6e20 746f 2074 6865 2073 616d  rsion to the sam
+000088e0: 6520 6474 7970 6520 746f 2064 6973 6162  e dtype to disab
+000088f0: 6c65 206e 7646 7573 6572 2065 7865 6375  le nvFuser execu
+00008900: 746f 7273 2773 0a20 2020 2023 2062 6f6f  tors's.    # boo
+00008910: 6b65 6e64 206f 7074 696d 697a 6174 696f  kend optimizatio
+00008920: 6e20 286e 765f 656e 6162 6c65 5f62 6f6f  n (nv_enable_boo
+00008930: 6b65 6e64 292c 2077 6869 6368 2063 616e  kend), which can
+00008940: 2063 6175 7365 2074 6865 2062 6163 6b77   cause the backw
+00008950: 6172 640a 2020 2020 2320 7061 7373 2074  ard.    # pass t
+00008960: 6f20 6765 6e65 7261 7465 2074 776f 206b  o generate two k
+00008970: 6572 6e65 6c73 0a20 2020 206d 6561 6e5f  ernels.    mean_
+00008980: 6d64 7479 7065 203d 2070 7269 6d73 2e63  mdtype = prims.c
+00008990: 6f6e 7665 7274 5f65 6c65 6d65 6e74 5f74  onvert_element_t
+000089a0: 7970 6528 6d2c 206d 2e64 7479 7065 290a  ype(m, m.dtype).
+000089b0: 2020 2020 7265 7374 6f72 6564 5f6d 6561      restored_mea
+000089c0: 6e20 3d20 7265 7374 6f72 655f 7265 6475  n = restore_redu
+000089d0: 6365 645f 6469 6d73 286d 6561 6e5f 6d64  ced_dims(mean_md
+000089e0: 7479 7065 2c20 6469 6d73 2c20 612e 7368  type, dims, a.sh
+000089f0: 6170 6529 0a20 2020 2076 6172 5f67 7261  ape).    var_gra
+00008a00: 6420 3d20 2832 202a 2072 6573 746f 7265  d = (2 * restore
+00008a10: 645f 6776 202a 2028 6120 2d20 7265 7374  d_gv * (a - rest
+00008a20: 6f72 6564 5f6d 6561 6e29 2920 2f20 6e6f  ored_mean)) / no
+00008a30: 726d 616c 697a 6174 696f 6e5f 7363 616c  rmalization_scal
+00008a40: 6172 0a0a 2020 2020 7075 745f 6772 6164  ar..    put_grad
+00008a50: 2861 2c20 6d65 616e 5f67 7261 6420 2b20  (a, mean_grad + 
+00008a60: 7661 725f 6772 6164 290a 0a20 2020 2072  var_grad)..    r
+00008a70: 6574 7572 6e20 762c 206d 0a0a 0a72 6567  eturn v, m...reg
+00008a80: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+00008a90: 5641 525f 4d45 414e 2c20 5f76 6172 5f6d  VAR_MEAN, _var_m
+00008aa0: 6561 6e5f 7072 696d 5f67 7261 6429 0a0a  ean_prim_grad)..
+00008ab0: 0a23 0a23 204c 696e 6561 7220 616c 6765  .#.# Linear alge
+00008ac0: 6272 6120 6f70 6572 6174 6f72 2067 7261  bra operator gra
+00008ad0: 6473 0a23 0a40 746f 7263 6863 7478 0a64  ds.#.@torchctx.d
+00008ae0: 6566 205f 6c69 6e65 6172 5f70 7269 6d5f  ef _linear_prim_
+00008af0: 6772 6164 2861 3a20 5465 6e73 6f72 5072  grad(a: TensorPr
+00008b00: 6f78 792c 2077 3a20 5465 6e73 6f72 5072  oxy, w: TensorPr
+00008b10: 6f78 792c 2062 6961 733a 204e 6f6e 6520  oxy, bias: None 
+00008b20: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
+00008b30: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+00008b40: 2020 2066 7764 203d 2070 7269 6d73 2e6c     fwd = prims.l
+00008b50: 696e 6561 7228 612c 2077 2c20 6269 6173  inear(a, w, bias
+00008b60: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00008b70: 7261 6428 6677 6429 0a0a 2020 2020 6669  rad(fwd)..    fi
+00008b80: 7273 745f 6469 6d20 3d20 2d32 0a20 2020  rst_dim = -2.   
+00008b90: 2067 7261 645f 6120 3d20 6c74 6f72 6368   grad_a = ltorch
+00008ba0: 2e6d 6174 6d75 6c28 672e 7265 7368 6170  .matmul(g.reshap
+00008bb0: 6528 2d31 2c20 672e 7368 6170 655b 2d31  e(-1, g.shape[-1
+00008bc0: 5d29 2c20 7729 2e72 6573 6861 7065 2861  ]), w).reshape(a
+00008bd0: 2e73 6861 7065 290a 0a20 2020 2067 7261  .shape)..    gra
+00008be0: 645f 773a 2054 656e 736f 7250 726f 7879  d_w: TensorProxy
+00008bf0: 0a20 2020 2069 6620 612e 6e64 696d 203d  .    if a.ndim =
+00008c00: 3d20 313a 0a20 2020 2020 2020 2067 7261  = 1:.        gra
+00008c10: 645f 7720 3d20 6c74 6f72 6368 2e6d 6174  d_w = ltorch.mat
+00008c20: 6d75 6c28 672e 756e 7371 7565 657a 6528  mul(g.unsqueeze(
+00008c30: 6669 7273 745f 6469 6d29 2e6d 542c 2061  first_dim).mT, a
+00008c40: 2e75 6e73 7175 6565 7a65 2866 6972 7374  .unsqueeze(first
+00008c50: 5f64 696d 2929 0a20 2020 2065 6c73 653a  _dim)).    else:
+00008c60: 0a20 2020 2020 2020 2067 7261 645f 7720  .        grad_w 
+00008c70: 3d20 6c74 6f72 6368 2e6d 6174 6d75 6c28  = ltorch.matmul(
+00008c80: 672e 7265 7368 6170 6528 2d31 2c20 672e  g.reshape(-1, g.
+00008c90: 7368 6170 655b 2d31 5d29 2e6d 542c 2061  shape[-1]).mT, a
+00008ca0: 2e72 6573 6861 7065 282d 312c 2061 2e73  .reshape(-1, a.s
+00008cb0: 6861 7065 5b2d 315d 2929 0a0a 2020 2020  hape[-1]))..    
+00008cc0: 7075 745f 6772 6164 7328 2861 2c20 7729  put_grads((a, w)
+00008cd0: 2c20 2867 7261 645f 612c 2067 7261 645f  , (grad_a, grad_
+00008ce0: 7729 290a 0a20 2020 2069 6620 6269 6173  w))..    if bias
+00008cf0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00008d00: 2020 2020 2020 6966 2067 2e6e 6469 6d20        if g.ndim 
+00008d10: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+00008d20: 2067 7261 645f 6269 6173 203d 206c 746f   grad_bias = lto
+00008d30: 7263 682e 7375 6d28 672c 2074 7570 6c65  rch.sum(g, tuple
+00008d40: 2872 616e 6765 2867 2e6e 6469 6d20 2d20  (range(g.ndim - 
+00008d50: 3129 2929 0a20 2020 2020 2020 2065 6c73  1))).        els
+00008d60: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
+00008d70: 7261 645f 6269 6173 203d 2067 0a20 2020  rad_bias = g.   
+00008d80: 2020 2020 2070 7574 5f67 7261 6428 6269       put_grad(bi
+00008d90: 6173 2c20 6772 6164 5f62 6961 7329 0a0a  as, grad_bias)..
+00008da0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00008db0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00008dc0: 6964 732e 4c49 4e45 4152 2c20 5f6c 696e  ids.LINEAR, _lin
+00008dd0: 6561 725f 7072 696d 5f67 7261 6429 0a0a  ear_prim_grad)..
+00008de0: 0a23 2054 4f44 4f20 4164 6420 6578 706c  .# TODO Add expl
+00008df0: 6963 6974 206c 746f 7263 6820 7673 2063  icit ltorch vs c
+00008e00: 6c61 6e67 206d 6f64 756c 6520 746f 2074  lang module to t
+00008e10: 6865 2074 656e 736f 7220 6f70 6572 6174  he tensor operat
+00008e20: 696f 6e73 2062 656c 6f77 0a23 2054 4f44  ions below.# TOD
+00008e30: 4f20 636f 756c 6420 7765 2067 6574 2072  O could we get r
+00008e40: 6964 206f 6620 7468 6520 6669 6e61 6c20  id of the final 
+00008e50: 7371 7565 657a 6573 2069 6e20 7468 6520  squeezes in the 
+00008e60: 622e 6e64 696d 203d 3d20 3120 6361 7365  b.ndim == 1 case
+00008e70: 2061 6e64 2074 6865 2061 2e6e 6469 6d20   and the a.ndim 
+00008e80: 3d3d 2031 2063 6173 653f 0a40 746f 7263  == 1 case?.@torc
+00008e90: 6863 7478 0a64 6566 205f 6d61 746d 756c  hctx.def _matmul
+00008ea0: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
+00008eb0: 6e73 6f72 5072 6f78 792c 2062 3a20 5465  nsorProxy, b: Te
+00008ec0: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
+00008ed0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+00008ee0: 2020 6677 6420 3d20 7072 696d 732e 6d61    fwd = prims.ma
+00008ef0: 746d 756c 2861 2c20 6229 0a20 2020 2067  tmul(a, b).    g
+00008f00: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00008f10: 0a0a 2020 2020 6c61 7374 5f64 696d 203d  ..    last_dim =
+00008f20: 2028 2d31 2c29 0a20 2020 2066 6972 7374   (-1,).    first
+00008f30: 5f64 696d 203d 2028 2d32 2c29 0a20 2020  _dim = (-2,).   
+00008f40: 2069 6620 612e 6e64 696d 203d 3d20 3120   if a.ndim == 1 
+00008f50: 616e 6420 622e 6e64 696d 203d 3d20 313a  and b.ndim == 1:
+00008f60: 0a20 2020 2020 2020 2070 7574 5f67 7261  .        put_gra
+00008f70: 6473 2828 612c 2062 292c 2028 6720 2a20  ds((a, b), (g * 
+00008f80: 622c 2067 202a 2061 2929 0a20 2020 2065  b, g * a)).    e
+00008f90: 6c69 6620 622e 6e64 696d 203d 3d20 313a  lif b.ndim == 1:
+00008fa0: 0a20 2020 2020 2020 2067 6120 3d20 756e  .        ga = un
+00008fb0: 7371 7565 657a 6528 672c 206c 6173 745f  squeeze(g, last_
+00008fc0: 6469 6d29 2040 2075 6e73 7175 6565 7a65  dim) @ unsqueeze
+00008fd0: 2862 2c20 6c61 7374 5f64 696d 292e 6d54  (b, last_dim).mT
+00008fe0: 0a20 2020 2020 2020 2067 6220 3d20 612e  .        gb = a.
+00008ff0: 6d54 2040 2075 6e73 7175 6565 7a65 2867  mT @ unsqueeze(g
+00009000: 2c20 6c61 7374 5f64 696d 290a 2020 2020  , last_dim).    
+00009010: 2020 2020 6966 2067 2e6e 6469 6d20 3e20      if g.ndim > 
+00009020: 313a 0a20 2020 2020 2020 2020 2020 2067  1:.            g
+00009030: 6220 3d20 7371 7565 657a 6528 6762 2c20  b = squeeze(gb, 
+00009040: 6c61 7374 5f64 696d 290a 2020 2020 2020  last_dim).      
+00009050: 2020 2020 2020 6762 203d 206c 746f 7263        gb = ltorc
+00009060: 682e 7375 6d28 6762 2c20 7475 706c 6528  h.sum(gb, tuple(
+00009070: 7261 6e67 6528 6762 2e6e 6469 6d20 2d20  range(gb.ndim - 
+00009080: 3129 2929 0a20 2020 2020 2020 2070 7574  1))).        put
+00009090: 5f67 7261 6473 2828 612c 2062 292c 2028  _grads((a, b), (
+000090a0: 6761 2c20 6762 2e73 7175 6565 7a65 2829  ga, gb.squeeze()
+000090b0: 2929 0a20 2020 2065 6c69 6620 612e 6e64  )).    elif a.nd
+000090c0: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
+000090d0: 2067 6120 3d20 756e 7371 7565 657a 6528   ga = unsqueeze(
+000090e0: 672c 2066 6972 7374 5f64 696d 2920 4020  g, first_dim) @ 
+000090f0: 622e 6d54 0a20 2020 2020 2020 2069 6620  b.mT.        if 
+00009100: 672e 6e64 696d 203e 2031 3a0a 2020 2020  g.ndim > 1:.    
+00009110: 2020 2020 2020 2020 6761 203d 206c 746f          ga = lto
+00009120: 7263 682e 7375 6d28 6761 2c20 7475 706c  rch.sum(ga, tupl
+00009130: 6528 7261 6e67 6528 6761 2e6e 6469 6d20  e(range(ga.ndim 
+00009140: 2d20 3129 2929 0a20 2020 2020 2020 2067  - 1))).        g
+00009150: 6220 3d20 756e 7371 7565 657a 6528 612c  b = unsqueeze(a,
+00009160: 2066 6972 7374 5f64 696d 292e 6d54 2040   first_dim).mT @
+00009170: 2075 6e73 7175 6565 7a65 2867 2c20 6669   unsqueeze(g, fi
+00009180: 7273 745f 6469 6d29 0a20 2020 2020 2020  rst_dim).       
+00009190: 2070 7574 5f67 7261 6473 2828 612c 2062   put_grads((a, b
+000091a0: 292c 2028 6761 2e73 7175 6565 7a65 2829  ), (ga.squeeze()
+000091b0: 2c20 6762 2929 0a20 2020 2065 6c73 653a  , gb)).    else:
+000091c0: 0a20 2020 2020 2020 2070 7574 5f67 7261  .        put_gra
+000091d0: 6473 2828 612c 2062 292c 2028 6720 4020  ds((a, b), (g @ 
+000091e0: 622e 6d54 2c20 612e 6d54 2040 2067 2929  b.mT, a.mT @ g))
+000091f0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00009200: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00009210: 2870 6964 732e 4d41 544d 554c 2c20 5f6d  (pids.MATMUL, _m
+00009220: 6174 6d75 6c5f 7072 696d 5f67 7261 6429  atmul_prim_grad)
+00009230: 0a0a 230a 2320 4e4e 206f 7065 7261 746f  ..#.# NN operato
+00009240: 7220 6772 6164 730a 230a 0a0a 4074 6f72  r grads.#...@tor
+00009250: 6368 6374 780a 6465 6620 5f65 6d62 6564  chctx.def _embed
+00009260: 6469 6e67 5f70 7269 6d5f 6772 6164 280a  ding_prim_grad(.
+00009270: 2020 2020 613a 2054 656e 736f 7250 726f      a: TensorPro
+00009280: 7879 2c20 2f2c 2077 6569 6768 742c 202a  xy, /, weight, *
+00009290: 2c20 7061 6464 696e 675f 6964 783d 2d31  , padding_idx=-1
+000092a0: 2c20 6d61 785f 6e6f 726d 3d4e 6f6e 652c  , max_norm=None,
+000092b0: 206e 6f72 6d5f 7479 7065 3d32 2e30 2c20   norm_type=2.0, 
+000092c0: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
+000092d0: 6571 3d46 616c 7365 2c20 7370 6172 7365  eq=False, sparse
+000092e0: 3d46 616c 7365 0a29 202d 3e20 5465 6e73  =False.) -> Tens
+000092f0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00009300: 203d 2070 7269 6d73 2e65 6d62 6564 6469   = prims.embeddi
+00009310: 6e67 280a 2020 2020 2020 2020 612c 0a20  ng(.        a,. 
+00009320: 2020 2020 2020 2077 6569 6768 742c 0a20         weight,. 
+00009330: 2020 2020 2020 2070 6164 6469 6e67 5f69         padding_i
+00009340: 6478 3d70 6164 6469 6e67 5f69 6478 2c0a  dx=padding_idx,.
+00009350: 2020 2020 2020 2020 6d61 785f 6e6f 726d          max_norm
+00009360: 3d6d 6178 5f6e 6f72 6d2c 0a20 2020 2020  =max_norm,.     
+00009370: 2020 206e 6f72 6d5f 7479 7065 3d6e 6f72     norm_type=nor
+00009380: 6d5f 7479 7065 2c0a 2020 2020 2020 2020  m_type,.        
+00009390: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
+000093a0: 6571 3d73 6361 6c65 5f67 7261 645f 6279  eq=scale_grad_by
+000093b0: 5f66 7265 712c 0a20 2020 2020 2020 2073  _freq,.        s
+000093c0: 7061 7273 653d 7370 6172 7365 2c0a 2020  parse=sparse,.  
+000093d0: 2020 290a 0a20 2020 2067 203d 2067 6574    )..    g = get
+000093e0: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
+000093f0: 5f67 7261 6420 3d20 7072 696d 732e 656d  _grad = prims.em
+00009400: 6265 6464 696e 675f 6261 636b 7761 7264  bedding_backward
+00009410: 2867 2c20 612c 2077 6569 6768 742e 7368  (g, a, weight.sh
+00009420: 6170 655b 305d 2c20 7061 6464 696e 675f  ape[0], padding_
+00009430: 6964 782c 2073 6361 6c65 5f67 7261 645f  idx, scale_grad_
+00009440: 6279 5f66 7265 712c 2073 7061 7273 6529  by_freq, sparse)
+00009450: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
+00009460: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
+00009470: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00009480: 7465 725f 6772 6164 2870 6964 732e 454d  ter_grad(pids.EM
+00009490: 4245 4444 494e 472c 205f 656d 6265 6464  BEDDING, _embedd
+000094a0: 696e 675f 7072 696d 5f67 7261 6429 0a0a  ing_prim_grad)..
+000094b0: 230a 2320 5068 616e 746f 6d20 6772 6164  #.# Phantom grad
+000094c0: 2074 7261 6e73 666f 726d 2068 656c 7065   transform helpe
+000094d0: 7273 0a23 0a0a 0a64 6566 205f 6765 745f  rs.#...def _get_
+000094e0: 6772 6164 666e 5f61 6e64 5f65 7865 6375  gradfn_and_execu
+000094f0: 746f 7228 0a20 2020 2062 7379 6d3a 2042  tor(.    bsym: B
+00009500: 6f75 6e64 5379 6d62 6f6c 2c20 2a2c 2065  oundSymbol, *, e
+00009510: 7865 6375 746f 7273 5f6c 6973 743a 2053  xecutors_list: S
+00009520: 6571 7565 6e63 655b 416e 795d 203d 2074  equence[Any] = t
+00009530: 7570 6c65 2829 0a29 202d 3e20 7475 706c  uple().) -> tupl
+00009540: 655b 4361 6c6c 6162 6c65 207c 204e 6f6e  e[Callable | Non
+00009550: 652c 2045 7865 6375 746f 7220 7c20 4e6f  e, Executor | No
+00009560: 6e65 5d3a 0a20 2020 2063 6420 3d20 6765  ne]:.    cd = ge
+00009570: 745f 636f 6d70 696c 655f 6461 7461 2829  t_compile_data()
+00009580: 0a20 2020 2065 7865 6375 746f 7273 5f6c  .    executors_l
+00009590: 6973 7420 3d20 6364 2e65 7865 6375 746f  ist = cd.executo
+000095a0: 7273 5f6c 6973 7420 6966 2063 6420 6973  rs_list if cd is
+000095b0: 206e 6f74 204e 6f6e 6520 656c 7365 2065   not None else e
+000095c0: 7865 6375 746f 7273 5f6c 6973 740a 2020  xecutors_list.  
+000095d0: 2020 2320 4368 6563 6b73 2069 6620 7468    # Checks if th
+000095e0: 6520 6578 6563 7574 6f72 2077 6869 6368  e executor which
+000095f0: 2068 6173 2070 7269 6f72 6974 7920 666f   has priority fo
+00009600: 7220 7468 6973 206f 7065 7261 7469 6f6e  r this operation
+00009610: 2068 6173 2061 2073 7065 6369 6669 6320   has a specific 
+00009620: 6772 6164 2074 7261 6e73 666f 726d 2066  grad transform f
+00009630: 6f72 2069 740a 2020 2020 666f 7220 6578  or it.    for ex
+00009640: 2069 6e20 6578 6563 7574 6f72 735f 6c69   in executors_li
+00009650: 7374 3a0a 2020 2020 2020 2020 6966 2065  st:.        if e
+00009660: 782e 6361 6e5f 6578 6563 7574 655f 6f72  x.can_execute_or
+00009670: 5f66 7573 6528 6273 796d 293a 0a20 2020  _fuse(bsym):.   
+00009680: 2020 2020 2020 2020 2065 785f 6772 6164           ex_grad
+00009690: 5f74 7261 6e73 666f 726d 3a20 4e6f 6e65  _transform: None
+000096a0: 207c 2043 616c 6c61 626c 6520 3d20 6578   | Callable = ex
+000096b0: 2e67 6574 5f67 7261 645f 7472 616e 7366  .get_grad_transf
+000096c0: 6f72 6d28 6273 796d 2e73 796d 290a 2020  orm(bsym.sym).  
+000096d0: 2020 2020 2020 2020 2020 6966 2065 785f            if ex_
+000096e0: 6772 6164 5f74 7261 6e73 666f 726d 2069  grad_transform i
+000096f0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00009700: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00009710: 726e 2065 785f 6772 6164 5f74 7261 6e73  rn ex_grad_trans
+00009720: 666f 726d 2c20 6578 0a20 2020 2020 2020  form, ex.       
+00009730: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+00009740: 2320 4966 2074 6865 2065 7865 6375 746f  # If the executo
+00009750: 7220 646f 6573 6e27 7420 6465 6669 6e65  r doesn't define
+00009760: 2069 7473 206f 776e 2067 7261 6420 7472   its own grad tr
+00009770: 616e 7366 6f72 6d2c 2074 6869 7320 6a75  ansform, this ju
+00009780: 7374 2072 6574 7572 6e73 2074 6865 2064  st returns the d
+00009790: 6566 6175 6c74 2067 7261 6420 7472 616e  efault grad tran
+000097a0: 7366 6f72 6d20 666f 7220 7468 6520 6273  sform for the bs
+000097b0: 796d 0a20 2020 2067 7261 6466 6e20 3d20  ym.    gradfn = 
+000097c0: 5f67 7261 645f 666e 5f6d 6170 2e67 6574  _grad_fn_map.get
+000097d0: 2862 7379 6d2e 7379 6d2e 6964 2c20 4e6f  (bsym.sym.id, No
+000097e0: 6e65 290a 2020 2020 7265 7475 726e 2067  ne).    return g
+000097f0: 7261 6466 6e2c 204e 6f6e 650a 0a0a 2320  radfn, None...# 
+00009800: 5468 6520 6465 6661 756c 7420 6772 6164  The default grad
+00009810: 2073 7065 6369 6669 6572 2066 6f72 2074   specifier for t
+00009820: 6865 2067 7261 6420 7472 616e 7366 6f72  he grad transfor
+00009830: 6d0a 2320 2020 466f 7220 6561 6368 2074  m.#   For each t
+00009840: 656e 736f 7220 6f75 7470 7574 2022 6f22  ensor output "o"
+00009850: 2072 6571 7569 7269 6e67 2067 7261 642c   requiring grad,
+00009860: 2073 7065 6369 6669 6573 2061 2067 7261   specifies a gra
+00009870: 6420 6f66 206f 6e65 735f 6c69 6b65 286f  d of ones_like(o
+00009880: 290a 6465 6620 5f67 7261 645f 7370 6563  ).def _grad_spec
+00009890: 6966 6965 725f 6465 6661 756c 7428 7079  ifier_default(py
+000098a0: 7472 6565 3a20 416e 7929 202d 3e20 4e6f  tree: Any) -> No
+000098b0: 6e65 3a0a 2020 2020 666c 6174 732c 205f  ne:.    flats, _
+000098c0: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
+000098d0: 7079 7472 6565 290a 0a20 2020 2066 6f72  pytree)..    for
+000098e0: 2066 2069 6e20 666c 6174 733a 0a20 2020   f in flats:.   
+000098f0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00009900: 6365 2866 2c20 5465 6e73 6f72 5072 6f78  ce(f, TensorProx
+00009910: 7929 2061 6e64 2066 2e72 6571 7569 7265  y) and f.require
+00009920: 735f 6772 6164 3a0a 2020 2020 2020 2020  s_grad:.        
+00009930: 2020 2020 2320 4e4f 5445 2054 6869 7320      # NOTE This 
+00009940: 7573 6573 2063 6c61 6e67 2e6f 6e65 735f  uses clang.ones_
+00009950: 6c69 6b65 2066 6f72 206e 6f77 2062 6563  like for now bec
+00009960: 6175 7365 206c 746f 7263 682e 6f6e 6573  ause ltorch.ones
+00009970: 5f6c 696b 6520 7769 6c6c 2065 7874 656e  _like will exten
+00009980: 6420 7468 650a 2020 2020 2020 2020 2020  d the.          
+00009990: 2020 2320 2020 6c69 6665 7469 6d65 206f    #   lifetime o
+000099a0: 6620 662c 2077 6869 6c65 2063 6c61 6e67  f f, while clang
+000099b0: 2e6f 6e65 735f 6c69 6b65 2077 696c 6c20  .ones_like will 
+000099c0: 6578 7472 6163 7420 7468 6520 6d65 7461  extract the meta
+000099d0: 6461 7461 206f 6620 6620 6174 2074 7261  data of f at tra
+000099e0: 6365 2074 696d 650a 2020 2020 2020 2020  ce time.        
+000099f0: 2020 2020 7072 696d 732e 7075 745f 6772      prims.put_gr
+00009a00: 6164 2866 2c20 636c 616e 672e 6675 6c6c  ad(f, clang.full
+00009a10: 5f6c 696b 6528 662c 2031 2e30 2929 0a0a  _like(f, 1.0))..
+00009a20: 0a23 2054 4f44 4f20 5465 7374 2077 6974  .# TODO Test wit
+00009a30: 6820 6275 6666 6572 730a 6465 6620 5f67  h buffers.def _g
+00009a40: 7261 645f 6f75 745f 7370 6563 6966 6965  rad_out_specifie
+00009a50: 725f 6465 6661 756c 7428 7079 7472 6565  r_default(pytree
+00009a60: 3a20 416e 7929 202d 3e20 6c69 7374 5b54  : Any) -> list[T
+00009a70: 656e 736f 7250 726f 7879 5d3a 0a20 2020  ensorProxy]:.   
+00009a80: 2066 6c61 7473 2c20 5f20 3d20 7472 6565   flats, _ = tree
+00009a90: 5f66 6c61 7474 656e 2870 7974 7265 6529  _flatten(pytree)
+00009aa0: 0a20 2020 2067 7261 6473 203d 206c 6973  .    grads = lis
+00009ab0: 7428 5b70 7269 6d73 2e67 6574 5f67 7261  t([prims.get_gra
+00009ac0: 6428 6629 2066 6f72 2066 2069 6e20 666c  d(f) for f in fl
+00009ad0: 6174 7320 6966 2069 7369 6e73 7461 6e63  ats if isinstanc
+00009ae0: 6528 662c 2054 656e 736f 7250 726f 7879  e(f, TensorProxy
+00009af0: 2920 616e 6420 662e 7265 7175 6972 6573  ) and f.requires
+00009b00: 5f67 7261 645d 290a 2020 2020 7265 7475  _grad]).    retu
+00009b10: 726e 2067 7261 6473 0a0a 0a23 2054 4f44  rn grads...# TOD
+00009b20: 4f20 466f 726d 616c 6c79 2064 6566 696e  O Formally defin
+00009b30: 6520 7468 6520 2267 7261 6469 656e 7422  e the "gradient"
+00009b40: 206f 6620 6120 7465 6e73 6f72 0a23 2054   of a tensor.# T
+00009b50: 4f44 4f20 4966 206e 6f6e 6520 6f66 2074  ODO If none of t
+00009b60: 6865 2069 6e70 7574 7320 746f 2061 6e20  he inputs to an 
+00009b70: 6f70 6572 6174 696f 6e20 7265 7175 6972  operation requir
+00009b80: 6520 6772 6164 2c20 7468 656e 2077 6520  e grad, then we 
+00009b90: 636f 756c 6420 6c65 6176 6520 7468 6174  could leave that
+00009ba0: 206f 7065 7261 7469 6f6e 2061 6c6f 6e65   operation alone
+00009bb0: 0a23 2020 2054 6869 7320 636f 756c 6420  .#   This could 
+00009bc0: 6163 7475 616c 6c79 2069 6d70 726f 7665  actually improve
+00009bd0: 2070 6572 666f 726d 616e 6365 2069 6620   performance if 
+00009be0: 7468 6520 6f70 6572 6174 696f 6e20 7065  the operation pe
+00009bf0: 7266 6f72 6d73 2065 7874 7261 2063 6f6d  rforms extra com
+00009c00: 7075 7461 7469 6f6e 7320 696e 2069 7473  putations in its
+00009c10: 2067 7261 6420 7472 616e 7366 6f72 6d0a   grad transform.
+00009c20: 2320 2020 4120 776f 726b 6172 6f75 6e64  #   A workaround
+00009c30: 2066 6f72 2074 6869 7320 776f 756c 6420   for this would 
+00009c40: 6265 2066 6f72 2074 6865 206f 7065 7261  be for the opera
+00009c50: 7469 6f6e 2069 7473 656c 6620 746f 2063  tion itself to c
+00009c60: 6865 636b 2069 6620 6974 7320 696e 7075  heck if its inpu
+00009c70: 7420 7265 7175 6972 6573 2067 7261 6420  t requires grad 
+00009c80: 6f72 206e 6f74 0a23 2054 7261 6e73 666f  or not.# Transfo
+00009c90: 726d 7320 6120 6675 6e63 7469 6f6e 2074  rms a function t
+00009ca0: 6f20 636f 6d70 7574 6520 7468 6520 2267  o compute the "g
+00009cb0: 7261 6469 656e 7422 206f 6620 6974 7320  radient" of its 
+00009cc0: 696e 7075 7473 2072 6571 7569 7269 6e67  inputs requiring
+00009cd0: 2067 7261 642c 2070 6f73 7369 626c 790a   grad, possibly.
+00009ce0: 2320 2020 6d6f 6469 6669 6564 2062 7920  #   modified by 
+00009cf0: 7468 6520 6772 6164 2073 7065 6369 6669  the grad specifi
+00009d00: 6572 7320 2873 6565 2062 656c 6f77 292e  ers (see below).
+00009d10: 0a23 2054 6865 206f 7074 696f 6e61 6c20  .# The optional 
+00009d20: 6772 6164 5f73 7065 6369 6669 6572 2061  grad_specifier a
+00009d30: 7267 756d 656e 7420 6163 6365 7074 7320  rgument accepts 
+00009d40: 7468 6520 6675 6e63 7469 6f6e 2773 206f  the function's o
+00009d50: 7574 7075 742c 2072 756e 7320 696e 2061  utput, runs in a
+00009d60: 206e 6f2d 6772 6164 2063 6f6e 7465 7874   no-grad context
+00009d70: 2c0a 2320 2020 616e 6420 6361 6e20 7075  ,.#   and can pu
+00009d80: 7420 6772 6164 7320 2875 7369 6e67 2070  t grads (using p
+00009d90: 7269 6d73 2e70 7574 5f67 7261 6428 2929  rims.put_grad())
+00009da0: 2066 6f72 2074 656e 736f 7273 2e20 4279   for tensors. By
+00009db0: 2064 6566 6175 6c74 2c20 666f 7220 6576   default, for ev
+00009dc0: 6572 7920 7465 6e73 6f72 206f 7574 7075  ery tensor outpu
+00009dd0: 7420 226f 220a 2320 2020 7468 6174 2072  t "o".#   that r
+00009de0: 6571 7569 7265 7320 6772 6164 2c20 6120  equires grad, a 
+00009df0: 6772 6164 206f 6620 6f6e 6573 5f6c 696b  grad of ones_lik
+00009e00: 6528 6f29 2069 7320 7075 742e 0a23 2054  e(o) is put..# T
+00009e10: 6865 206f 7074 696f 6e61 6c20 6772 6164  he optional grad
+00009e20: 5f6f 7574 5f73 7065 6369 6669 6572 2061  _out_specifier a
+00009e30: 6363 6570 7473 2074 6865 2066 756e 6374  ccepts the funct
+00009e40: 696f 6e27 7320 696e 7075 7420 616e 6420  ion's input and 
+00009e50: 6361 6e20 6361 6c6c 2070 7269 6d73 2e67  can call prims.g
+00009e60: 6574 5f67 7261 6428 2920 746f 0a23 2020  et_grad() to.#  
+00009e70: 2061 6371 7569 7265 2061 6e64 2072 6574   acquire and ret
+00009e80: 7572 6e20 6772 6164 6965 6e74 7320 6173  urn gradients as
+00009e90: 2064 6573 6972 6564 2e20 4279 2064 6566   desired. By def
+00009ea0: 6175 6c74 2c20 7468 6520 696e 7075 7420  ault, the input 
+00009eb0: 6973 2066 6c61 7474 656e 6564 0a23 2020  is flattened.#  
+00009ec0: 2028 7472 6565 5f66 6c61 7474 656e 2861   (tree_flatten(a
+00009ed0: 7267 732c 206b 7761 7267 7329 2920 616e  rgs, kwargs)) an
+00009ee0: 6420 6120 666c 6174 206c 6973 7420 6f66  d a flat list of
+00009ef0: 2067 7261 6473 2066 6f72 2061 6c6c 2074   grads for all t
+00009f00: 656e 736f 7273 2072 6571 7569 7269 6e67  ensors requiring
+00009f10: 2067 7261 640a 2320 2020 616e 6420 4e6f   grad.#   and No
+00009f20: 6e65 2066 6f72 206f 7468 6572 2069 6e70  ne for other inp
+00009f30: 7574 7320 6973 2072 6574 7572 6e65 642e  uts is returned.
+00009f40: 0a23 2054 6865 2061 6c67 6f72 6974 686d  .# The algorithm
+00009f50: 2066 6f72 206d 6f64 6966 7969 6e67 2074   for modifying t
+00009f60: 6865 2070 726f 6772 616d 2068 6173 2074  he program has t
+00009f70: 6865 2066 6f6c 6c6f 7769 6e67 2073 7465  he following ste
+00009f80: 7073 3a0a 2320 2020 3129 2046 6c61 7474  ps:.#   1) Flatt
+00009f90: 656e 7320 7468 6520 6f72 6967 696e 616c  ens the original
+00009fa0: 2074 7261 6365 2066 6f72 2074 6865 2067   trace for the g
+00009fb0: 7261 6420 7472 616e 7366 6f72 6d20 2d2d  rad transform --
+00009fc0: 2065 6e73 7569 6e67 2074 6861 7420 616c   ensuing that al
+00009fd0: 6c20 746f 702d 6c65 7665 6c20 7379 6d62  l top-level symb
+00009fe0: 6f6c 7320 6861 7665 0a23 2020 2020 2020  ols have.#      
+00009ff0: 2061 2067 7261 6420 6675 6e63 7469 6f6e   a grad function
+0000a000: 2e0a 6465 6620 6772 6164 280a 2020 2020  ..def grad(.    
+0000a010: 6366 6e2c 2067 7261 645f 7370 6563 6966  cfn, grad_specif
+0000a020: 6965 723a 2043 616c 6c61 626c 6520 3d20  ier: Callable = 
+0000a030: 5f67 7261 645f 7370 6563 6966 6965 725f  _grad_specifier_
+0000a040: 6465 6661 756c 742c 2067 7261 645f 6f75  default, grad_ou
+0000a050: 745f 7370 6563 6966 6965 723a 2043 616c  t_specifier: Cal
+0000a060: 6c61 626c 6520 3d20 5f67 7261 645f 6f75  lable = _grad_ou
+0000a070: 745f 7370 6563 6966 6965 725f 6465 6661  t_specifier_defa
+0000a080: 756c 740a 2920 2d3e 2043 616c 6c61 626c  ult.) -> Callabl
+0000a090: 653a 0a20 2020 2023 2043 7265 6174 6573  e:.    # Creates
+0000a0a0: 2061 2063 7573 746f 6d20 7472 616e 7366   a custom transf
+0000a0b0: 6f72 6d20 6361 6c6c 6162 6c65 2074 6861  orm callable tha
+0000a0c0: 7420 6269 6e64 7320 7468 6520 6164 6469  t binds the addi
+0000a0d0: 7469 6f6e 616c 2061 7267 756d 656e 7473  tional arguments
+0000a0e0: 2074 6f20 7468 6520 6772 6164 2074 7261   to the grad tra
+0000a0f0: 6e73 666f 726d 0a20 2020 2040 6c61 6e67  nsform.    @lang
+0000a100: 6374 7828 4c61 6e67 7561 6765 732e 434c  ctx(Languages.CL
+0000a110: 414e 4729 0a20 2020 2064 6566 205f 6772  ANG).    def _gr
+0000a120: 6164 5f74 7261 6e73 666f 726d 2874 7263  ad_transform(trc
+0000a130: 3a20 5472 6163 652c 202a 2c20 6578 6563  : Trace, *, exec
+0000a140: 7574 6f72 735f 6c69 7374 3a20 5365 7175  utors_list: Sequ
+0000a150: 656e 6365 5b41 6e79 5d29 202d 3e20 5472  ence[Any]) -> Tr
+0000a160: 6163 653a 0a20 2020 2020 2020 2073 7461  ace:.        sta
+0000a170: 7274 5f74 696d 655f 6e73 203d 2074 696d  rt_time_ns = tim
+0000a180: 652e 7469 6d65 5f6e 7328 290a 0a20 2020  e.time_ns()..   
+0000a190: 2020 2020 2023 2053 5445 5020 4f4e 4520       # STEP ONE 
+0000a1a0: 2d2d 2046 6c61 7474 656e 7320 616e 6420  -- Flattens and 
+0000a1b0: 6463 6573 0a0a 2020 2020 2020 2020 2320  dces..        # 
+0000a1c0: 5265 7475 726e 7320 5472 7565 2069 6620  Returns True if 
+0000a1d0: 7468 6520 6273 796d 2068 6173 206e 6f20  the bsym has no 
+0000a1e0: 6772 6164 2066 756e 6374 696f 6e2c 2061  grad function, a
+0000a1f0: 6e64 2073 6f20 6d75 7374 2062 6520 666c  nd so must be fl
+0000a200: 6174 7465 6e65 6420 666f 7220 7468 6520  attened for the 
+0000a210: 6772 6164 2074 7261 6e73 666f 726d 0a20  grad transform. 
+0000a220: 2020 2020 2020 206e 6576 6572 5f66 6c61         never_fla
+0000a230: 7474 656e 3a20 7365 745b 4861 7368 6162  tten: set[Hashab
+0000a240: 6c65 5d20 3d20 7b70 7269 6d73 2e50 7269  le] = {prims.Pri
+0000a250: 6d49 4473 2e52 4554 5552 4e2c 2070 7269  mIDs.RETURN, pri
+0000a260: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
+0000a270: 4b5f 5452 4956 4941 4c7d 0a0a 2020 2020  K_TRIVIAL}..    
+0000a280: 2020 2020 6465 6620 7368 6f75 6c64 5f66      def should_f
+0000a290: 6c61 7474 656e 5f66 6f72 5f67 7261 6428  latten_for_grad(
+0000a2a0: 6273 796d 3a20 426f 756e 6453 796d 626f  bsym: BoundSymbo
+0000a2b0: 6c29 202d 3e20 626f 6f6c 3a0a 2020 2020  l) -> bool:.    
+0000a2c0: 2020 2020 2020 2020 6966 2062 7379 6d2e          if bsym.
+0000a2d0: 7379 6d2e 6964 2069 6e20 6e65 7665 725f  sym.id in never_
+0000a2e0: 666c 6174 7465 6e3a 0a20 2020 2020 2020  flatten:.       
+0000a2f0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000a300: 4661 6c73 650a 0a20 2020 2020 2020 2020  False..         
+0000a310: 2020 2067 7261 6466 6e3a 204e 6f6e 6520     gradfn: None 
+0000a320: 7c20 4361 6c6c 6162 6c65 0a20 2020 2020  | Callable.     
+0000a330: 2020 2020 2020 2067 7261 6466 6e2c 205f         gradfn, _
+0000a340: 203d 205f 6765 745f 6772 6164 666e 5f61   = _get_gradfn_a
+0000a350: 6e64 5f65 7865 6375 746f 7228 6273 796d  nd_executor(bsym
+0000a360: 2c20 6578 6563 7574 6f72 735f 6c69 7374  , executors_list
+0000a370: 3d65 7865 6375 746f 7273 5f6c 6973 7429  =executors_list)
+0000a380: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000a390: 7572 6e20 6772 6164 666e 2069 7320 4e6f  urn gradfn is No
+0000a3a0: 6e65 0a0a 2020 2020 2020 2020 2320 544f  ne..        # TO
+0000a3b0: 444f 2052 4331 3a20 6d61 7962 6520 6d6f  DO RC1: maybe mo
+0000a3c0: 7665 2074 6f20 7072 6f64 7563 6520 7468  ve to produce th
+0000a3d0: 6573 6520 616c 7761 7973 206f 6e20 6372  ese always on cr
+0000a3e0: 6561 7469 6f6e 0a20 2020 2020 2020 2069  eation.        i
+0000a3f0: 6620 7472 632e 6b77 6172 6773 2069 7320  f trc.kwargs is 
+0000a400: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000a410: 2020 7472 632e 6b77 6172 6773 203d 207b    trc.kwargs = {
+0000a420: 7d0a 2020 2020 2020 2020 6966 2074 7263  }.        if trc
+0000a430: 2e66 6e20 6973 204e 6f6e 653a 0a20 2020  .fn is None:.   
+0000a440: 2020 2020 2020 2020 2074 7263 2e66 6e20           trc.fn 
+0000a450: 3d20 7472 632e 7079 7468 6f6e 5f63 616c  = trc.python_cal
+0000a460: 6c61 626c 6528 290a 0a20 2020 2020 2020  lable()..       
+0000a470: 2067 7261 6474 7263 203d 2066 726f 6d5f   gradtrc = from_
+0000a480: 7472 6163 6528 7472 6329 0a20 2020 2020  trace(trc).     
+0000a490: 2020 2066 6c61 7474 656e 6564 5f62 7379     flattened_bsy
+0000a4a0: 6d73 3a20 6c69 7374 5b42 6f75 6e64 5379  ms: list[BoundSy
+0000a4b0: 6d62 6f6c 5d20 3d20 666c 6174 7465 6e5f  mbol] = flatten_
+0000a4c0: 666f 725f 7472 616e 7366 6f72 6d28 7368  for_transform(sh
+0000a4d0: 6f75 6c64 5f66 6c61 7474 656e 5f66 6f72  ould_flatten_for
+0000a4e0: 5f67 7261 642c 2074 7263 2e62 6f75 6e64  _grad, trc.bound
+0000a4f0: 5f73 796d 626f 6c73 290a 2020 2020 2020  _symbols).      
+0000a500: 2020 6772 6164 7472 632e 626f 756e 645f    gradtrc.bound_
+0000a510: 7379 6d62 6f6c 7320 3d20 666c 6174 7465  symbols = flatte
+0000a520: 6e65 645f 6273 796d 730a 2020 2020 2020  ned_bsyms.      
+0000a530: 2020 6772 6164 7472 6320 3d20 6463 6528    gradtrc = dce(
+0000a540: 6772 6164 7472 6329 0a0a 2020 2020 2020  gradtrc)..      
+0000a550: 2020 2320 5354 4550 2054 574f 202d 2d20    # STEP TWO -- 
+0000a560: 5265 706c 6163 6573 206f 7269 6769 6e61  Replaces origina
+0000a570: 6c20 6361 6c6c 7320 7769 7468 2067 7261  l calls with gra
+0000a580: 6420 6361 6c6c 730a 0a20 2020 2020 2020  d calls..       
+0000a590: 2023 2044 6566 696e 6573 2074 6865 2076   # Defines the v
+0000a5a0: 6973 6974 6f72 2070 6174 7465 726e 2066  isitor pattern f
+0000a5b0: 6f72 2074 6865 2066 6972 7374 2070 6173  or the first pas
+0000a5c0: 7320 6f66 2074 6865 2067 7261 6420 7472  s of the grad tr
+0000a5d0: 616e 7366 6f72 6d2c 0a20 2020 2020 2020  ansform,.       
+0000a5e0: 2023 2020 2077 6869 6368 2073 7761 7073   #   which swaps
+0000a5f0: 2042 6f75 6e64 5379 6d62 6f6c 7320 7769   BoundSymbols wi
+0000a600: 7468 2074 6865 6972 2067 7261 6420 6675  th their grad fu
+0000a610: 6e63 7469 6f6e 730a 2020 2020 2020 2020  nctions.        
+0000a620: 6465 6620 7669 7369 745f 2862 7379 6d3a  def visit_(bsym:
+0000a630: 2042 6f75 6e64 5379 6d62 6f6c 2920 2d3e   BoundSymbol) ->
+0000a640: 2043 616c 6c61 626c 653a 0a20 2020 2020   Callable:.     
+0000a650: 2020 2020 2020 2067 7261 6466 6e3a 204e         gradfn: N
+0000a660: 6f6e 6520 7c20 4361 6c6c 6162 6c65 0a20  one | Callable. 
+0000a670: 2020 2020 2020 2020 2020 2067 7261 6466             gradf
+0000a680: 6e2c 205f 203d 205f 6765 745f 6772 6164  n, _ = _get_grad
+0000a690: 666e 5f61 6e64 5f65 7865 6375 746f 7228  fn_and_executor(
+0000a6a0: 6273 796d 2c20 6578 6563 7574 6f72 735f  bsym, executors_
+0000a6b0: 6c69 7374 3d65 7865 6375 746f 7273 5f6c  list=executors_l
+0000a6c0: 6973 7429 0a20 2020 2020 2020 2020 2020  ist).           
+0000a6d0: 2063 6865 636b 280a 2020 2020 2020 2020   check(.        
+0000a6e0: 2020 2020 2020 2020 6772 6164 666e 2069          gradfn i
+0000a6f0: 7320 6e6f 7420 4e6f 6e65 2c0a 2020 2020  s not None,.    
+0000a700: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
+0000a710: 6461 3a20 6622 4661 696c 6564 2074 6f20  da: f"Failed to 
+0000a720: 6669 6e64 2061 2067 7261 6466 6e20 666f  find a gradfn fo
+0000a730: 7220 7b62 7379 6d3d 7d20 6166 7465 7220  r {bsym=} after 
+0000a740: 666c 6174 7465 6e69 6e67 222c 0a20 2020  flattening",.   
+0000a750: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0000a760: 6570 7469 6f6e 5f74 7970 653d 4173 7365  eption_type=Asse
+0000a770: 7274 696f 6e45 7272 6f72 2c0a 2020 2020  rtionError,.    
+0000a780: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000a790: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
+0000a7a0: 6466 6e0a 0a20 2020 2020 2020 2040 7772  dfn..        @wr
+0000a7b0: 6170 7328 7472 632e 666e 2e6d 6574 6120  aps(trc.fn.meta 
+0000a7c0: 6966 2069 7369 6e73 7461 6e63 6528 7472  if isinstance(tr
+0000a7d0: 632e 666e 2c20 5379 6d62 6f6c 2920 656c  c.fn, Symbol) el
+0000a7e0: 7365 2074 7263 2e66 6e29 0a20 2020 2020  se trc.fn).     
+0000a7f0: 2020 2064 6566 2069 6e74 6572 7072 6574     def interpret
+0000a800: 696e 675f 666e 282a 6172 6773 2c20 2a2a  ing_fn(*args, **
+0000a810: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+0000a820: 2020 2020 2072 6573 756c 7420 3d20 6576       result = ev
+0000a830: 616c 5f74 7261 6365 2867 7261 6474 7263  al_trace(gradtrc
+0000a840: 2c20 2a61 7267 732c 2073 796d 626f 6c5f  , *args, symbol_
+0000a850: 6d61 7070 6572 3d76 6973 6974 5f2c 202a  mapper=visit_, *
+0000a860: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
+0000a870: 2020 2020 2023 2053 6574 7320 6772 6164       # Sets grad
+0000a880: 7320 666f 7220 6f75 7470 7574 0a20 2020  s for output.   
+0000a890: 2020 2020 2020 2020 2023 2054 4f44 4f20           # TODO 
+0000a8a0: 5468 6973 2065 6666 6563 7469 7665 6c79  This effectively
+0000a8b0: 2072 756e 7320 696e 2061 206e 6f20 6772   runs in a no gr
+0000a8c0: 6164 2063 6f6e 7465 7874 202d 2d20 7368  ad context -- sh
+0000a8d0: 6f75 6c64 2069 7420 7275 6e20 696e 2061  ould it run in a
+0000a8e0: 2067 7261 6420 636f 6e74 6578 742c 0a20   grad context,. 
+0000a8f0: 2020 2020 2020 2020 2020 2023 2020 206f             #   o
+0000a900: 7220 7368 6f75 6c64 2074 6865 7265 2062  r should there b
+0000a910: 6520 7468 6520 6f70 7469 6f6e 2074 6f20  e the option to 
+0000a920: 7275 6e20 6974 2069 6e20 6120 6772 6164  run it in a grad
+0000a930: 2063 6f6e 7465 7874 3f0a 2020 2020 2020   context?.      
+0000a940: 2020 2020 2020 6772 6164 5f73 7065 6369        grad_speci
+0000a950: 6669 6572 2872 6573 756c 7429 0a20 2020  fier(result).   
+0000a960: 2020 2020 2020 2020 2023 2043 6f6e 7374           # Const
+0000a970: 7275 6374 7320 7265 7475 726e 2076 616c  ructs return val
+0000a980: 7565 0a20 2020 2020 2020 2020 2020 2066  ue.            f
+0000a990: 6c61 745f 6772 6164 7320 3d20 6772 6164  lat_grads = grad
+0000a9a0: 5f6f 7574 5f73 7065 6369 6669 6572 2828  _out_specifier((
+0000a9b0: 6172 6773 2c20 6b77 6172 6773 2929 0a20  args, kwargs)). 
+0000a9c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000a9d0: 6e20 666c 6174 5f67 7261 6473 0a0a 2020  n flat_grads..  
+0000a9e0: 2020 2020 2020 2320 4e4f 5445 2041 6674        # NOTE Aft
+0000a9f0: 6572 2074 6869 7320 6361 6c6c 2074 6865  er this call the
+0000aa00: 2067 7261 6474 7263 2069 7320 696e 7661   gradtrc is inva
+0000aa10: 6c69 642c 2062 6563 6175 7365 3a0a 2020  lid, because:.  
+0000aa20: 2020 2020 2020 2320 2020 3129 2054 6865        #   1) The
+0000aa30: 206e 6f6e 2d65 7865 6375 7461 626c 6520   non-executable 
+0000aa40: 7075 745f 6772 6164 206f 7065 7261 7469  put_grad operati
+0000aa50: 6f6e 7320 6172 6520 7374 696c 6c20 696e  ons are still in
+0000aa60: 2074 6865 2074 7261 6365 2c20 616e 6420   the trace, and 
+0000aa70: 6d75 6c74 6970 6c65 2063 616c 6c73 2074  multiple calls t
+0000aa80: 6f20 7075 7420 6772 6164 2061 7265 206e  o put grad are n
+0000aa90: 6f74 2061 6363 756d 756c 6174 6564 0a20  ot accumulated. 
+0000aaa0: 2020 2020 2020 2023 2020 2032 2920 5468         #   2) Th
+0000aab0: 6520 6e6f 6e2d 6578 6563 7574 6162 6c65  e non-executable
+0000aac0: 2067 6574 5f67 7261 6420 6f70 6572 6174   get_grad operat
+0000aad0: 696f 6e73 2061 7265 2073 7469 6c6c 2069  ions are still i
+0000aae0: 6e20 7468 6520 7472 6163 652c 2061 6e64  n the trace, and
+0000aaf0: 2074 6865 7920 6d61 7920 7072 6f64 7563   they may produc
+0000ab00: 6520 6469 6666 6572 656e 7420 7072 6f78  e different prox
+0000ab10: 6965 7320 7768 656e 0a20 2020 2020 2020  ies when.       
+0000ab20: 2023 2020 2020 2020 2063 616c 6c65 6420   #       called 
+0000ab30: 6f6e 2074 6865 2073 616d 6520 696e 7075  on the same inpu
+0000ab40: 7473 0a20 2020 2020 2020 2023 2020 2033  ts.        #   3
+0000ab50: 2920 5468 6520 6f70 6572 6174 696f 6e73  ) The operations
+0000ab60: 2061 7265 206e 6f74 2069 6e20 6120 7661   are not in a va
+0000ab70: 6c69 6420 6f72 6465 720a 2020 2020 2020  lid order.      
+0000ab80: 2020 6772 6164 7472 6320 3d20 636f 6e73    gradtrc = cons
+0000ab90: 7472 7563 745f 7472 6163 6528 0a20 2020  truct_trace(.   
+0000aba0: 2020 2020 2020 2020 2072 656e 616d 655f           rename_
+0000abb0: 7072 6f78 6965 733d 4661 6c73 652c 0a20  proxies=False,. 
+0000abc0: 2020 2020 2020 2020 2020 2075 7365 5f64             use_d
+0000abd0: 6365 3d46 616c 7365 2c0a 2020 2020 2020  ce=False,.      
+0000abe0: 2020 2928 696e 7465 7270 7265 7469 6e67    )(interpreting
+0000abf0: 5f66 6e2c 202a 6772 6164 7472 632e 6172  _fn, *gradtrc.ar
+0000ac00: 6773 2c20 2a2a 6772 6164 7472 632e 6b77  gs, **gradtrc.kw
+0000ac10: 6172 6773 290a 2020 2020 2020 2020 6772  args).        gr
+0000ac20: 6164 7472 632e 7363 6f70 6573 203d 205b  adtrc.scopes = [
+0000ac30: 6772 6164 7472 632e 626f 756e 645f 7379  gradtrc.bound_sy
+0000ac40: 6d62 6f6c 735d 0a20 2020 2020 2020 2067  mbols].        g
+0000ac50: 7261 6474 7263 2e5f 636f 6d70 6c65 7465  radtrc._complete
+0000ac60: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0000ac70: 2020 2320 5354 4550 2054 4852 4545 202d    # STEP THREE -
+0000ac80: 2d20 4861 6e64 6c65 7320 7075 745f 6772  - Handles put_gr
+0000ac90: 6164 2061 6e64 2067 6574 5f67 7261 6420  ad and get_grad 
+0000aca0: 6f70 6572 6174 696f 6e73 2061 6e64 2061  operations and a
+0000acb0: 6363 756d 756c 6174 6573 2067 7261 6469  ccumulates gradi
+0000acc0: 656e 7473 0a0a 2020 2020 2020 2020 2320  ents..        # 
+0000acd0: 4163 6375 6d75 6c61 7465 7320 6772 6164  Accumulates grad
+0000ace0: 6965 6e74 732c 2063 7265 6174 696e 6720  ients, creating 
+0000acf0: 7468 6520 7072 696d 616c 202d 3e20 6163  the primal -> ac
+0000ad00: 6375 6d75 6c61 7465 6420 6772 6164 206d  cumulated grad m
+0000ad10: 6170 7069 6e67 0a20 2020 2020 2020 2023  apping.        #
+0000ad20: 2053 6574 7320 7468 6520 7472 6163 696e   Sets the tracin
+0000ad30: 6720 636f 6e74 6578 7420 736f 2061 6363  g context so acc
+0000ad40: 756d 756c 6174 696f 6e20 6f70 6572 6174  umulation operat
+0000ad50: 696f 6e73 2061 7265 2072 6563 6f72 6465  ions are recorde
+0000ad60: 6420 696e 746f 2074 6865 2074 7261 6365  d into the trace
+0000ad70: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0000ad80: 2020 2020 2020 2020 2020 7472 6163 6563            tracec
+0000ad90: 7478 5f74 6f6b 203d 2073 6574 5f74 7261  tx_tok = set_tra
+0000ada0: 6365 6374 7828 6772 6164 7472 6329 0a0a  cectx(gradtrc)..
+0000adb0: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+0000adc0: 7073 2070 7269 6d61 6c73 2074 6f20 7468  ps primals to th
+0000add0: 6569 7220 6772 6164 6965 6e74 7320 2877  eir gradients (w
+0000ade0: 6869 6368 2061 7265 2072 6574 7572 6e65  hich are returne
+0000adf0: 6420 6672 6f6d 2063 616c 6c69 6e67 2067  d from calling g
+0000ae00: 6574 5f67 7261 6420 6f6e 2074 6865 2070  et_grad on the p
+0000ae10: 7269 6d61 6c29 0a20 2020 2020 2020 2020  rimal).         
+0000ae20: 2020 2070 7269 6d61 6c73 5f74 6f5f 6769     primals_to_gi
+0000ae30: 6e70 7574 5f6d 6170 3a20 6469 6374 5b56  nput_map: dict[V
+0000ae40: 6172 6961 626c 652c 2054 656e 736f 7250  ariable, TensorP
+0000ae50: 726f 7879 5d20 3d20 7b7d 0a0a 2020 2020  roxy] = {}..    
+0000ae60: 2020 2020 2020 2020 2320 4861 6e64 6c65          # Handle
+0000ae70: 7320 7075 745f 6772 6164 206f 7065 7261  s put_grad opera
+0000ae80: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
+0000ae90: 2020 2320 4e4f 5445 2054 6869 7320 6d6f    # NOTE This mo
+0000aea0: 6469 6669 6573 2061 206c 6973 7420 7468  difies a list th
+0000aeb0: 6174 2069 7320 6265 696e 6720 656e 756d  at is being enum
+0000aec0: 6572 6174 6564 206f 7665 722c 2062 7574  erated over, but
+0000aed0: 2069 7427 7320 4f4b 2062 6563 6175 7365   it's OK because
+0000aee0: 2077 6527 7265 206f 6e6c 790a 2020 2020   we're only.    
+0000aef0: 2020 2020 2020 2020 2320 2020 6170 7065          #   appe
+0000af00: 6e64 696e 6720 746f 2074 6865 2065 6e64  nding to the end
+0000af10: 206f 6620 7468 6520 6c69 7374 0a20 2020   of the list.   
+0000af20: 2020 2020 2020 2020 2062 7379 6d3a 2042           bsym: B
+0000af30: 6f75 6e64 5379 6d62 6f6c 0a20 2020 2020  oundSymbol.     
+0000af40: 2020 2020 2020 2066 6f72 2062 7379 6d20         for bsym 
+0000af50: 696e 2067 7261 6474 7263 2e62 6f75 6e64  in gradtrc.bound
+0000af60: 5f73 796d 626f 6c73 3a0a 2020 2020 2020  _symbols:.      
+0000af70: 2020 2020 2020 2020 2020 6964 3a20 4861            id: Ha
+0000af80: 7368 6162 6c65 203d 2062 7379 6d2e 7379  shable = bsym.sy
+0000af90: 6d2e 6964 0a20 2020 2020 2020 2020 2020  m.id.           
+0000afa0: 2020 2020 2069 6620 6964 2069 7320 7069       if id is pi
+0000afb0: 6473 2e50 5554 5f47 5241 443a 0a20 2020  ds.PUT_GRAD:.   
+0000afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000afd0: 2070 7269 6d61 6c3a 204e 756d 6265 7220   primal: Number 
+0000afe0: 7c20 5465 6e73 6f72 5072 6f78 790a 2020  | TensorProxy.  
+0000aff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b000: 2020 6772 6164 3a20 4e75 6d62 6572 207c    grad: Number |
+0000b010: 2054 656e 736f 7250 726f 7879 0a20 2020   TensorProxy.   
+0000b020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b030: 2070 7269 6d61 6c2c 2067 7261 6420 3d20   primal, grad = 
+0000b040: 6273 796d 2e66 6c61 745f 6172 6773 0a0a  bsym.flat_args..
+0000b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b060: 2020 2020 2320 544f 444f 2053 7570 706f      # TODO Suppo
+0000b070: 7274 2061 7574 6f67 7261 6420 6f6e 206e  rt autograd on n
+0000b080: 756d 6265 7273 0a20 2020 2020 2020 2020  umbers.         
+0000b090: 2020 2020 2020 2020 2020 2023 2046 696c             # Fil
+0000b0a0: 7465 7273 2063 616c 6c73 2074 6f20 7075  ters calls to pu
+0000b0b0: 745f 6772 6164 2074 6861 7420 776f 756c  t_grad that woul
+0000b0c0: 6420 7075 7420 6120 6772 6164 206f 6e20  d put a grad on 
+0000b0d0: 6120 6e6f 6e2d 7465 6e73 6f72 206f 7220  a non-tensor or 
+0000b0e0: 6120 7465 6e73 6f72 2074 6861 7420 646f  a tensor that do
+0000b0f0: 6573 6e27 7420 7265 7175 6972 6520 6772  esn't require gr
+0000b100: 6164 0a20 2020 2020 2020 2020 2020 2020  ad.             
+0000b110: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+0000b120: 696e 7374 616e 6365 2870 7269 6d61 6c2c  instance(primal,
+0000b130: 2054 656e 736f 7250 726f 7879 2920 6f72   TensorProxy) or
+0000b140: 206e 6f74 2070 7269 6d61 6c2e 7265 7175   not primal.requ
+0000b150: 6972 6573 5f67 7261 643a 0a20 2020 2020  ires_grad:.     
+0000b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b170: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+0000b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b190: 2023 2054 4f44 4f20 5375 7070 6f72 7420   # TODO Support 
+0000b1a0: 636f 6d70 6c65 7820 6175 746f 6772 6164  complex autograd
+0000b1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b1c0: 2020 2020 2063 6865 636b 280a 2020 2020       check(.    
+0000b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1e0: 2020 2020 6e6f 7420 6474 7970 6573 2e69      not dtypes.i
+0000b1f0: 735f 636f 6d70 6c65 785f 6474 7970 6528  s_complex_dtype(
+0000b200: 6474 7970 6573 2e74 6f5f 6474 7970 6528  dtypes.to_dtype(
+0000b210: 7072 696d 616c 2929 2c0a 2020 2020 2020  primal)),.      
+0000b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b230: 2020 6c61 6d62 6461 3a20 6622 436f 6d70    lambda: f"Comp
+0000b240: 6c65 7820 6772 6164 2069 7320 6e6f 7420  lex grad is not 
+0000b250: 7375 7070 6f72 7465 6420 7965 7422 2c0a  supported yet",.
+0000b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b270: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0000b280: 2020 2020 2020 2020 2020 2076 7072 696d             vprim
+0000b290: 616c 3a20 5661 7269 6162 6c65 203d 2076  al: Variable = v
+0000b2a0: 6172 6961 626c 6569 6679 2870 7269 6d61  ariableify(prima
+0000b2b0: 6c29 0a20 2020 2020 2020 2020 2020 2020  l).             
+0000b2c0: 2020 2020 2020 2061 6363 756d 3a20 4e6f         accum: No
+0000b2d0: 6e65 207c 2054 656e 736f 7250 726f 7879  ne | TensorProxy
+0000b2e0: 203d 2070 7269 6d61 6c73 5f74 6f5f 6769   = primals_to_gi
+0000b2f0: 6e70 7574 5f6d 6170 2e67 6574 2876 7072  nput_map.get(vpr
+0000b300: 696d 616c 2c20 4e6f 6e65 290a 0a20 2020  imal, None)..   
+0000b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b320: 2069 6620 6163 6375 6d20 6973 204e 6f6e   if accum is Non
+0000b330: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000b340: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
+0000b350: 6c73 5f74 6f5f 6769 6e70 7574 5f6d 6170  ls_to_ginput_map
+0000b360: 5b76 7072 696d 616c 5d20 3d20 6772 6164  [vprimal] = grad
+0000b370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b380: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3a0: 2020 2061 6363 756d 203d 2061 6363 756d     accum = accum
+0000b3b0: 202b 2067 7261 640a 2020 2020 2020 2020   + grad.        
 0000b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3d0: 6163 7475 616c 5f67 7261 643a 204e 6f6e  actual_grad: Non
-0000b3e0: 6520 7c20 5465 6e73 6f72 5072 6f78 7920  e | TensorProxy 
-0000b3f0: 3d20 7072 696d 616c 735f 746f 5f67 696e  = primals_to_gin
-0000b400: 7075 745f 6d61 702e 6765 7428 7670 7269  put_map.get(vpri
-0000b410: 6d61 6c2c 204e 6f6e 6529 0a0a 2020 2020  mal, None)..    
-0000b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b430: 2320 4e4f 5445 2049 6620 6163 7475 616c  # NOTE If actual
-0000b440: 5f67 7261 6420 6973 204e 6f6e 6520 7468  _grad is None th
-0000b450: 656e 2074 6865 7265 2773 2061 2067 6574  en there's a get
-0000b460: 5f67 7261 6428 2920 7265 7175 6573 7420  _grad() request 
-0000b470: 666f 7220 6120 7465 6e73 6f72 2077 6869  for a tensor whi
-0000b480: 6368 0a20 2020 2020 2020 2020 2020 2020  ch.             
-0000b490: 2020 2020 2020 2023 2020 2068 6173 206e         #   has n
-0000b4a0: 6f20 7075 745f 6772 6164 2829 2c20 736f  o put_grad(), so
-0000b4b0: 2077 6520 7265 7475 726e 207a 6572 6f73   we return zeros
-0000b4c0: 2066 6f72 2074 6865 2067 7261 640a 2020   for the grad.  
-0000b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4e0: 2020 2320 544f 444f 2052 6576 6973 6974    # TODO Revisit
-0000b4f0: 2074 6869 7320 2d2d 2063 616e 2077 6520   this -- can we 
-0000b500: 7265 6d6f 7665 2074 6865 7365 2063 6f6d  remove these com
-0000b510: 7075 7461 7469 6f6e 732c 206f 7220 7573  putations, or us
-0000b520: 6520 6120 7370 6563 6961 6c20 5a65 726f  e a special Zero
-0000b530: 5465 6e73 6f72 0a20 2020 2020 2020 2020  Tensor.         
-0000b540: 2020 2020 2020 2020 2020 2023 2020 2074             #   t
-0000b550: 6f20 7369 6d70 6c69 6679 2074 6865 6d3f  o simplify them?
+0000b3d0: 7072 696d 616c 735f 746f 5f67 696e 7075  primals_to_ginpu
+0000b3e0: 745f 6d61 705b 7670 7269 6d61 6c5d 203d  t_map[vprimal] =
+0000b3f0: 2061 6363 756d 0a0a 2020 2020 2020 2020   accum..        
+0000b400: 2020 2020 2320 4861 6e64 6c65 7320 6765      # Handles ge
+0000b410: 745f 6772 6164 206f 7065 7261 7469 6f6e  t_grad operation
+0000b420: 730a 0a20 2020 2020 2020 2020 2020 2023  s..            #
+0000b430: 2052 6573 6574 7320 7468 6520 7377 6170   Resets the swap
+0000b440: 6d61 7020 666f 7220 6772 6164 730a 2020  map for grads.  
+0000b450: 2020 2020 2020 2020 2020 7377 6170 6d61            swapma
+0000b460: 703a 2064 6963 745b 5661 7269 6162 6c65  p: dict[Variable
+0000b470: 2c20 5072 6f78 795d 203d 207b 7d0a 0a20  , Proxy] = {}.. 
+0000b480: 2020 2020 2020 2020 2020 2066 6f72 2062             for b
+0000b490: 7379 6d20 696e 2067 7261 6474 7263 2e62  sym in gradtrc.b
+0000b4a0: 6f75 6e64 5f73 796d 626f 6c73 3a0a 2020  ound_symbols:.  
+0000b4b0: 2020 2020 2020 2020 2020 2020 2020 6964                id
+0000b4c0: 3a20 4861 7368 6162 6c65 203d 2062 7379  : Hashable = bsy
+0000b4d0: 6d2e 7379 6d2e 6964 0a20 2020 2020 2020  m.sym.id.       
+0000b4e0: 2020 2020 2020 2020 2069 6620 6964 2069           if id i
+0000b4f0: 7320 7069 6473 2e47 4554 5f47 5241 443a  s pids.GET_GRAD:
+0000b500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b510: 2020 2020 2070 7269 6d61 6c3a 204e 756d       primal: Num
+0000b520: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+0000b530: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+0000b540: 2020 2020 2020 2870 7269 6d61 6c2c 2920        (primal,) 
+0000b550: 3d20 6273 796d 2e66 6c61 745f 6172 6773  = bsym.flat_args
 0000b560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b570: 2020 2020 2069 6620 6163 7475 616c 5f67       if actual_g
-0000b580: 7261 6420 6973 204e 6f6e 653a 0a20 2020  rad is None:.   
-0000b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5a0: 2020 2020 2061 6374 7561 6c5f 6772 6164       actual_grad
-0000b5b0: 203d 206c 746f 7263 682e 7a65 726f 735f   = ltorch.zeros_
-0000b5c0: 6c69 6b65 2870 7269 6d61 6c29 0a20 2020  like(primal).   
-0000b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5e0: 2020 2020 2070 7269 6d61 6c73 5f74 6f5f       primals_to_
-0000b5f0: 6769 6e70 7574 5f6d 6170 5b76 7072 696d  ginput_map[vprim
-0000b600: 616c 5d20 3d20 6163 7475 616c 5f67 7261  al] = actual_gra
-0000b610: 640a 0a20 2020 2020 2020 2020 2020 2020  d..             
-0000b620: 2020 2020 2020 2023 2055 7064 6174 6573         # Updates
-0000b630: 2074 6865 2067 7261 6420 616c 6961 7320   the grad alias 
-0000b640: 6d61 700a 2020 2020 2020 2020 2020 2020  map.            
-0000b650: 2020 2020 2020 2020 7661 6374 7561 6c5f          vactual_
-0000b660: 6772 6164 3a20 5661 7269 6162 6c65 203d  grad: Variable =
-0000b670: 2076 6172 6961 626c 6569 6679 2861 6374   variableify(act
-0000b680: 7561 6c5f 6772 6164 290a 2020 2020 2020  ual_grad).      
-0000b690: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000b6a0: 2076 6163 7475 616c 5f67 7261 6420 213d   vactual_grad !=
-0000b6b0: 2076 6772 6164 3a0a 2020 2020 2020 2020   vgrad:.        
-0000b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b6d0: 7377 6170 6d61 705b 7667 7261 645d 203d  swapmap[vgrad] =
-0000b6e0: 2061 6374 7561 6c5f 6772 6164 0a0a 2020   actual_grad..  
-0000b6f0: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
-0000b700: 2020 2020 2020 2020 2020 2023 2052 6573             # Res
-0000b710: 746f 7265 7320 7363 6f70 650a 2020 2020  tores scope.    
-0000b720: 2020 2020 2020 2020 7265 7365 745f 7472          reset_tr
-0000b730: 6163 6563 7478 2874 7261 6365 6374 785f  acectx(tracectx_
-0000b740: 746f 6b29 0a0a 2020 2020 2020 2020 2320  tok)..        # 
-0000b750: 4669 6c74 6572 7320 7075 745f 6772 6164  Filters put_grad
-0000b760: 2061 6e64 2067 6574 5f67 7261 6420 6f70   and get_grad op
-0000b770: 6572 6174 696f 6e73 2061 6e64 2061 7070  erations and app
-0000b780: 6c69 6573 2074 6865 2073 7761 706d 6170  lies the swapmap
-0000b790: 0a20 2020 2020 2020 2064 6566 205f 6669  .        def _fi
-0000b7a0: 6c74 6572 2862 7379 6d3a 2042 6f75 6e64  lter(bsym: Bound
-0000b7b0: 5379 6d62 6f6c 2920 2d3e 2062 6f6f 6c3a  Symbol) -> bool:
-0000b7c0: 0a20 2020 2020 2020 2020 2020 2069 643a  .            id:
-0000b7d0: 2048 6173 6861 626c 6520 3d20 6273 796d   Hashable = bsym
-0000b7e0: 2e73 796d 2e69 640a 2020 2020 2020 2020  .sym.id.        
-0000b7f0: 2020 2020 7265 7475 726e 2069 6420 696e      return id in
-0000b800: 2028 7069 6473 2e50 5554 5f47 5241 442c   (pids.PUT_GRAD,
-0000b810: 2070 6964 732e 4745 545f 4752 4144 290a   pids.GET_GRAD).
-0000b820: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
-0000b830: 2e62 6f75 6e64 5f73 796d 626f 6c73 203d  .bound_symbols =
-0000b840: 205b 0a20 2020 2020 2020 2020 2020 2062   [.            b
-0000b850: 7379 6d2e 6672 6f6d 5f62 7379 6d5f 7377  sym.from_bsym_sw
-0000b860: 6170 5f70 726f 7869 6573 2873 7761 706d  ap_proxies(swapm
-0000b870: 6170 2920 666f 7220 6273 796d 2069 6e20  ap) for bsym in 
-0000b880: 6772 6164 7472 632e 626f 756e 645f 7379  gradtrc.bound_sy
-0000b890: 6d62 6f6c 7320 6966 206e 6f74 205f 6669  mbols if not _fi
-0000b8a0: 6c74 6572 2862 7379 6d29 0a20 2020 2020  lter(bsym).     
-0000b8b0: 2020 205d 0a0a 2020 2020 2020 2020 2320     ]..        # 
-0000b8c0: 5354 4550 2046 4f55 5220 2d2d 2d20 4f72  STEP FOUR --- Or
-0000b8d0: 6465 7273 2074 6865 206f 7065 7261 7469  ders the operati
-0000b8e0: 6f6e 730a 2020 2020 2020 2020 2320 544f  ons.        # TO
-0000b8f0: 444f 2043 6f6e 7369 6465 7220 616c 7465  DO Consider alte
-0000b900: 726e 6174 6976 6520 7363 6865 6475 6c69  rnative scheduli
-0000b910: 6e67 2061 6c67 6f72 6974 686d 732c 206d  ng algorithms, m
-0000b920: 6179 6265 2062 7920 7573 696e 6720 6772  aybe by using gr
-0000b930: 6170 6820 6665 6174 7572 6573 0a20 2020  aph features.   
-0000b940: 2020 2020 2023 2020 2053 6f6d 6520 6964       #   Some id
-0000b950: 6561 7320 6172 6520 6c6f 6f6b 696e 6720  eas are looking 
-0000b960: 6174 206d 656d 6f72 792d 7361 7669 6e67  at memory-saving
-0000b970: 206e 6f64 6573 2c20 616e 6420 6e6f 6465   nodes, and node
-0000b980: 7320 7769 7468 2061 2068 6967 6820 696e  s with a high in
-0000b990: 2d64 6567 7265 6520 6f72 2068 6967 6820  -degree or high 
-0000b9a0: 6f75 742d 6465 6772 6565 0a0a 2020 2020  out-degree..    
-0000b9b0: 2020 2020 2320 4372 6561 7465 7320 616e      # Creates an
-0000b9c0: 2069 6e69 7469 616c 2076 616c 6964 206f   initial valid o
-0000b9d0: 7264 6572 696e 6720 746f 2044 4345 2c20  rdering to DCE, 
-0000b9e0: 736f 2074 6861 7420 6164 6469 7469 6f6e  so that addition
-0000b9f0: 616c 206f 7264 6572 696e 6720 616e 616c  al ordering anal
-0000ba00: 7973 6973 2064 6f65 736e 2774 206e 6565  ysis doesn't nee
-0000ba10: 6420 746f 2063 6f6e 7369 6465 7220 616c  d to consider al
-0000ba20: 6c20 7379 6d62 6f6c 730a 2020 2020 2020  l symbols.      
-0000ba30: 2020 726f 6f74 732c 206c 6561 7665 7320    roots, leaves 
-0000ba40: 3d20 6273 796d 5f6c 6973 745f 746f 5f64  = bsym_list_to_d
-0000ba50: 6167 2867 7261 6474 7263 2e62 6f75 6e64  ag(gradtrc.bound
-0000ba60: 5f73 796d 626f 6c73 290a 2020 2020 2020  _symbols).      
-0000ba70: 2020 6f72 6465 7265 645f 6273 796d 7320    ordered_bsyms 
-0000ba80: 3d20 746f 706f 736f 7274 5f62 7379 6d5f  = toposort_bsym_
-0000ba90: 6461 6728 726f 6f74 732c 2054 4f50 4f53  dag(roots, TOPOS
-0000baa0: 4f52 545f 4f52 4445 522e 544f 505f 444f  ORT_ORDER.TOP_DO
-0000bab0: 574e 290a 2020 2020 2020 2020 6772 6164  WN).        grad
-0000bac0: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
-0000bad0: 7320 3d20 6f72 6465 7265 645f 6273 796d  s = ordered_bsym
-0000bae0: 730a 2020 2020 2020 2020 6772 6164 7472  s.        gradtr
-0000baf0: 6320 3d20 6463 6528 6772 6164 7472 6329  c = dce(gradtrc)
-0000bb00: 0a0a 2020 2020 2020 2020 2320 4964 656e  ..        # Iden
-0000bb10: 7469 6669 6573 2074 6865 206f 7264 6572  tifies the order
-0000bb20: 206f 6620 426f 756e 6453 796d 626f 6c73   of BoundSymbols
-0000bb30: 2075 7369 6e67 2061 2022 4446 5320 616e   using a "DFS an
-0000bb40: 6420 6368 6169 6e22 2061 6c67 6f72 6974  d chain" algorit
-0000bb50: 686d 0a20 2020 2020 2020 2023 2054 4f44  hm.        # TOD
-0000bb60: 4f20 456c 6162 6f72 6174 6520 6f6e 2074  O Elaborate on t
-0000bb70: 6869 7320 616c 676f 7269 7468 6d20 616e  his algorithm an
-0000bb80: 6420 7468 6520 696d 706c 656d 656e 7461  d the implementa
-0000bb90: 7469 6f6e 0a20 2020 2020 2020 2072 6f6f  tion.        roo
-0000bba0: 7473 2c20 6c65 6176 6573 203d 2062 7379  ts, leaves = bsy
-0000bbb0: 6d5f 6c69 7374 5f74 6f5f 6461 6728 6772  m_list_to_dag(gr
-0000bbc0: 6164 7472 632e 626f 756e 645f 7379 6d62  adtrc.bound_symb
-0000bbd0: 6f6c 7329 0a20 2020 2020 2020 2063 6865  ols).        che
-0000bbe0: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
-0000bbf0: 6c65 6e28 6c65 6176 6573 2920 3d3d 2031  len(leaves) == 1
-0000bc00: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
-0000bc10: 6d62 6461 3a20 6622 4578 7065 6374 6564  mbda: f"Expected
-0000bc20: 206f 6e6c 7920 6f6e 6520 6c65 6166 206e   only one leaf n
-0000bc30: 6f64 6520 7768 656e 2073 6f72 7469 6e67  ode when sorting
-0000bc40: 2066 6f72 2067 7261 642c 2066 6f75 6e64   for grad, found
-0000bc50: 2074 6865 7265 2077 6572 6520 7b6c 656e   there were {len
-0000bc60: 286c 6561 7665 7329 7d20 6c65 6176 6573  (leaves)} leaves
-0000bc70: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
-0000bc80: 2020 2020 2028 6c65 6166 2c29 203d 206c       (leaf,) = l
-0000bc90: 6561 7665 730a 0a20 2020 2020 2020 2023  eaves..        #
-0000bca0: 2043 6f6d 7075 7465 7320 7468 6520 7465   Computes the te
-0000bcb0: 6e73 6f72 206d 656d 6f72 7920 7573 6564  nsor memory used
-0000bcc0: 2062 7920 7468 6520 6769 7665 6e20 7079   by the given py
-0000bcd0: 7472 6565 0a20 2020 2020 2020 2064 6566  tree.        def
-0000bce0: 206d 656d 6f72 795f 7573 6564 2870 7974   memory_used(pyt
-0000bcf0: 7265 6529 202d 3e20 696e 743a 0a20 2020  ree) -> int:.   
-0000bd00: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
-0000bd10: 7573 653a 2069 6e74 203d 2030 0a0a 2020  use: int = 0..  
-0000bd20: 2020 2020 2020 2020 2020 6465 6620 636f            def co
-0000bd30: 756e 745f 6d65 6d6f 7279 5f75 7365 2878  unt_memory_use(x
-0000bd40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000bd50: 2020 206e 6f6e 6c6f 6361 6c20 6d65 6d6f     nonlocal memo
-0000bd60: 7279 5f75 7365 0a20 2020 2020 2020 2020  ry_use.         
-0000bd70: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0000bd80: 616e 6365 2878 2c20 5465 6e73 6f72 5072  ance(x, TensorPr
-0000bd90: 6f78 7929 3a0a 2020 2020 2020 2020 2020  oxy):.          
-0000bda0: 2020 2020 2020 2020 2020 6d65 6d6f 7279            memory
-0000bdb0: 5f75 7365 202b 3d20 782e 6474 7970 652e  _use += x.dtype.
-0000bdc0: 5f62 7974 6573 202a 2078 2e6e 756d 656c  _bytes * x.numel
-0000bdd0: 0a0a 2020 2020 2020 2020 2020 2020 7472  ..            tr
-0000bde0: 6565 5f6d 6170 2863 6f75 6e74 5f6d 656d  ee_map(count_mem
-0000bdf0: 6f72 795f 7573 652c 2070 7974 7265 6529  ory_use, pytree)
-0000be00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000be10: 7572 6e20 6d65 6d6f 7279 5f75 7365 0a0a  urn memory_use..
-0000be20: 2020 2020 2020 2020 2320 5472 7565 2077          # True w
-0000be30: 6865 6e20 6120 6e6f 6465 2069 7320 6120  hen a node is a 
-0000be40: 226c 696e 6b22 202d 2d20 6120 6e6f 6465  "link" -- a node
-0000be50: 2077 6974 6820 6f6e 6c79 206f 6e65 2063   with only one c
-0000be60: 6869 6c64 2061 6e64 2061 7420 6d6f 7374  hild and at most
-0000be70: 206f 6e65 2070 6172 656e 740a 2020 2020   one parent.    
-0000be80: 2020 2020 2320 2020 436f 6e63 6570 7475      #   Conceptu
-0000be90: 616c 6c79 2074 6865 206e 6f64 6520 6973  ally the node is
-0000bea0: 2061 2022 6c69 6e6b 2220 696e 2061 2063   a "link" in a c
-0000beb0: 6861 696e 206f 6620 6e6f 6465 7320 6c69  hain of nodes li
-0000bec0: 6b65 2041 202d 3e20 4220 2d3e 2043 0a20  ke A -> B -> C. 
-0000bed0: 2020 2020 2020 2064 6566 2069 735f 6c69         def is_li
-0000bee0: 6e6b 286e 3a20 4e6f 6465 2920 2d3e 2062  nk(n: Node) -> b
-0000bef0: 6f6f 6c3a 0a20 2020 2020 2020 2020 2020  ool:.           
-0000bf00: 205f 6973 5f6c 696e 6b20 3d20 6c65 6e28   _is_link = len(
-0000bf10: 6e2e 6368 696c 6472 656e 2920 3d3d 2031  n.children) == 1
-0000bf20: 2061 6e64 206c 656e 286e 2e70 6172 656e   and len(n.paren
-0000bf30: 7473 2920 3c3d 2031 0a20 2020 2020 2020  ts) <= 1.       
-0000bf40: 2020 2020 2072 6574 7572 6e20 5f69 735f       return _is_
-0000bf50: 6c69 6e6b 0a0a 2020 2020 2020 2020 636f  link..        co
-0000bf60: 756e 7465 723a 2069 6e74 203d 2030 0a0a  unter: int = 0..
-0000bf70: 2020 2020 2020 2020 6465 6620 5f63 6861          def _cha
-0000bf80: 696e 2863 3a20 6c69 7374 5b4e 6f64 655d  in(c: list[Node]
-0000bf90: 2c20 656e 643a 204e 6f64 6529 202d 3e20  , end: Node) -> 
-0000bfa0: 6c69 7374 5b4e 6f64 655d 3a0a 2020 2020  list[Node]:.    
-0000bfb0: 2020 2020 2020 2020 6e6f 6e6c 6f63 616c          nonlocal
-0000bfc0: 2063 6f75 6e74 6572 0a0a 2020 2020 2020   counter..      
-0000bfd0: 2020 2020 2020 2320 544f 444f 2045 7870        # TODO Exp
-0000bfe0: 6572 696d 656e 7420 7769 7468 206e 6f74  eriment with not
-0000bff0: 2061 6c77 6179 7320 6675 7369 6e67 2074   always fusing t
-0000c000: 6869 7320 696e 746f 2074 6865 2063 6f6e  his into the con
-0000c010: 7375 6d65 7220 2d2d 2074 6865 7265 2063  sumer -- there c
-0000c020: 6f75 6c64 2062 6520 616e 0a20 2020 2020  ould be an.     
-0000c030: 2020 2020 2020 2023 2020 2069 6e74 6572         #   inter
-0000c040: 6573 7469 6e67 206d 696e 6375 740a 2020  esting mincut.  
-0000c050: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
-0000c060: 2049 6e20 7468 6973 2063 6173 6520 7468   In this case th
-0000c070: 6520 6368 6169 6e20 6361 6e6e 6f74 2062  e chain cannot b
-0000c080: 6520 6578 7465 6e64 6564 2c20 616e 6420  e extended, and 
-0000c090: 6974 7320 6f72 6967 696e 2069 7320 696e  its origin is in
-0000c0a0: 7075 7420 746f 2074 6865 2066 756e 6374  put to the funct
-0000c0b0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-0000c0c0: 2320 2020 736f 2074 6869 7320 6a75 7374  #   so this just
-0000c0d0: 2066 7573 6573 2069 7420 696e 746f 2074   fuses it into t
-0000c0e0: 6865 2063 6f6e 7375 6d65 720a 2020 2020  he consumer.    
-0000c0f0: 2020 2020 2020 2020 6966 206c 656e 2865          if len(e
-0000c100: 6e64 2e70 6172 656e 7473 2920 3d3d 2030  nd.parents) == 0
-0000c110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c120: 2020 666f 7220 6e20 696e 2063 3a0a 2020    for n in c:.  
-0000c130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c140: 2020 6e2e 6e75 6d62 6572 203d 2063 6f75    n.number = cou
-0000c150: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
-0000c160: 2020 2020 2020 2020 2063 6f75 6e74 6572           counter
-0000c170: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-0000c180: 2020 2020 2020 7265 7475 726e 205b 5d0a        return [].
-0000c190: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-0000c1a0: 4f54 4520 6c65 6e28 656e 642e 7061 7265  OTE len(end.pare
-0000c1b0: 6e74 7329 203d 3d20 3120 6f6e 2074 6869  nts) == 1 on thi
-0000c1c0: 7320 7061 7468 0a20 2020 2020 2020 2020  s path.         
-0000c1d0: 2020 2028 7061 7265 6e74 2c29 203d 2065     (parent,) = e
-0000c1e0: 6e64 2e70 6172 656e 7473 0a0a 2020 2020  nd.parents..    
-0000c1f0: 2020 2020 2020 2020 2320 4578 7465 6e64          # Extend
-0000c200: 7320 7468 6520 6368 6169 6e20 6966 2074  s the chain if t
-0000c210: 6865 2070 6172 656e 7420 6973 2061 206c  he parent is a l
-0000c220: 696e 6b0a 2020 2020 2020 2020 2020 2020  ink.            
-0000c230: 6966 2069 735f 6c69 6e6b 2870 6172 656e  if is_link(paren
-0000c240: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-0000c250: 2020 2020 632e 6170 7065 6e64 2870 6172      c.append(par
-0000c260: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
-0000c270: 2020 2020 2072 6574 7572 6e20 5f63 6861       return _cha
-0000c280: 696e 2863 2c20 7061 7265 6e74 290a 0a20  in(c, parent).. 
-0000c290: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
-0000c2a0: 4520 496e 2074 6869 7320 6361 7365 2074  E In this case t
-0000c2b0: 6865 2063 6861 696e 2068 6173 2061 2070  he chain has a p
-0000c2c0: 6172 656e 7420 7468 6174 2069 7320 6e6f  arent that is no
-0000c2d0: 7420 6120 6c69 6e6b 0a20 2020 2020 2020  t a link.       
-0000c2e0: 2020 2020 2023 2046 696e 6473 2074 6865       # Finds the
-0000c2f0: 206d 696e 6375 740a 2020 2020 2020 2020   mincut.        
-0000c300: 2020 2020 6d69 6e63 7574 5f69 6478 3a20      mincut_idx: 
-0000c310: 696e 7420 3d20 6c65 6e28 6329 0a20 2020  int = len(c).   
-0000c320: 2020 2020 2020 2020 206d 696e 5f6d 656d           min_mem
-0000c330: 6f72 795f 7573 6167 653a 2069 6e74 203d  ory_usage: int =
-0000c340: 206d 656d 6f72 795f 7573 6564 2870 6172   memory_used(par
-0000c350: 656e 742e 6273 796d 2e6f 7574 7075 7429  ent.bsym.output)
-0000c360: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-0000c370: 7220 6964 782c 206e 2069 6e20 656e 756d  r idx, n in enum
-0000c380: 6572 6174 6528 6329 3a0a 2020 2020 2020  erate(c):.      
-0000c390: 2020 2020 2020 2020 2020 6d65 6d20 3d20            mem = 
-0000c3a0: 6d65 6d6f 7279 5f75 7365 6428 6e2e 6273  memory_used(n.bs
-0000c3b0: 796d 2e6f 7574 7075 7429 0a20 2020 2020  ym.output).     
-0000c3c0: 2020 2020 2020 2020 2020 2069 6620 6d65             if me
-0000c3d0: 6d20 3c20 6d69 6e5f 6d65 6d6f 7279 5f75  m < min_memory_u
-0000c3e0: 7361 6765 3a0a 2020 2020 2020 2020 2020  sage:.          
-0000c3f0: 2020 2020 2020 2020 2020 6d69 6e63 7574            mincut
-0000c400: 5f69 6478 203d 2069 6478 0a20 2020 2020  _idx = idx.     
-0000c410: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000c420: 696e 5f6d 656d 6f72 795f 7573 6167 6520  in_memory_usage 
-0000c430: 3d20 6d65 6d0a 0a20 2020 2020 2020 2020  = mem..         
-0000c440: 2020 2066 6f72 2069 6478 2c20 6e20 696e     for idx, n in
-0000c450: 2065 6e75 6d65 7261 7465 2863 293a 0a20   enumerate(c):. 
-0000c460: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000c470: 6620 6964 7820 3c20 6d69 6e63 7574 5f69  f idx < mincut_i
-0000c480: 6478 3a0a 2020 2020 2020 2020 2020 2020  dx:.            
-0000c490: 2020 2020 2020 2020 6e2e 6e75 6d62 6572          n.number
-0000c4a0: 203d 2063 6f75 6e74 6572 0a20 2020 2020   = counter.     
-0000c4b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000c4c0: 6f75 6e74 6572 202b 3d20 310a 0a20 2020  ounter += 1..   
-0000c4d0: 2020 2020 2020 2020 2023 2052 6574 7572           # Retur
-0000c4e0: 6e73 2074 6865 2070 726f 6475 6365 722d  ns the producer-
-0000c4f0: 7369 6465 2063 6861 696e 2063 7574 2069  side chain cut i
-0000c500: 6620 6974 2065 7869 7374 730a 2020 2020  f it exists.    
-0000c510: 2020 2020 2020 2020 6966 206d 696e 6375          if mincu
-0000c520: 745f 6964 7820 3c20 6c65 6e28 6329 3a0a  t_idx < len(c):.
-0000c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c540: 7265 7475 726e 205b 635b 6d69 6e63 7574  return [c[mincut
-0000c550: 5f69 6478 5d5d 0a20 2020 2020 2020 2020  _idx]].         
-0000c560: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000c570: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000c580: 6d69 6e63 7574 5f69 6478 203d 3d20 6c65  mincut_idx == le
-0000c590: 6e28 6329 0a20 2020 2020 2020 2020 2020  n(c).           
-0000c5a0: 2020 2020 2072 6574 7572 6e20 656e 642e       return end.
-0000c5b0: 7061 7265 6e74 730a 0a20 2020 2020 2020  parents..       
-0000c5c0: 2064 6566 2063 6861 696e 5f6f 7574 286e   def chain_out(n
-0000c5d0: 3a20 4e6f 6465 2c20 7374 6163 6b3a 206c  : Node, stack: l
-0000c5e0: 6973 745b 4e6f 6465 5d29 202d 3e20 4e6f  ist[Node]) -> No
-0000c5f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000c600: 2320 5368 6f72 742d 6369 7263 7569 7473  # Short-circuits
-0000c610: 2069 6620 7468 6520 6f72 6967 696e 616c   if the original
-0000c620: 206e 6f64 6520 6e20 6361 6e6e 6f74 2062   node n cannot b
-0000c630: 6520 7061 7274 206f 6620 6120 6368 6169  e part of a chai
-0000c640: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
-0000c650: 206e 6f74 2069 735f 6c69 6e6b 286e 293a   not is_link(n):
-0000c660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c670: 2073 7461 636b 2e61 7070 656e 6428 6e29   stack.append(n)
-0000c680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c690: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-0000c6a0: 2020 2020 2023 204e 4f54 4520 6973 5f6c       # NOTE is_l
-0000c6b0: 696e 6b28 6e29 203d 3d20 5472 7565 0a20  ink(n) == True. 
-0000c6c0: 2020 2020 2020 2020 2020 2070 6f73 745f             post_
-0000c6d0: 6368 6169 6e3a 206c 6973 745b 4e6f 6465  chain: list[Node
-0000c6e0: 5d20 3d20 5f63 6861 696e 285b 6e5d 2c20  ] = _chain([n], 
-0000c6f0: 6e29 0a0a 2020 2020 2020 2020 2020 2020  n)..            
-0000c700: 666f 7220 7063 2069 6e20 706f 7374 5f63  for pc in post_c
-0000c710: 6861 696e 3a0a 2020 2020 2020 2020 2020  hain:.          
-0000c720: 2020 2020 2020 7374 6163 6b2e 6170 7065        stack.appe
-0000c730: 6e64 2870 6329 0a0a 2020 2020 2020 2020  nd(pc)..        
-0000c740: 7374 6163 6b3a 206c 6973 745b 4e6f 6465  stack: list[Node
-0000c750: 5d20 3d20 5b6c 6561 665d 0a20 2020 2020  ] = [leaf].     
-0000c760: 2020 2077 6869 6c65 206c 656e 2873 7461     while len(sta
-0000c770: 636b 2920 3e20 303a 0a20 2020 2020 2020  ck) > 0:.       
-0000c780: 2020 2020 206e 3a20 4e6f 6465 203d 2073       n: Node = s
-0000c790: 7461 636b 2e70 6f70 2829 0a0a 2020 2020  tack.pop()..    
-0000c7a0: 2020 2020 2020 2020 6966 206e 2e6e 756d          if n.num
-0000c7b0: 6265 7220 6973 206e 6f74 204e 6f6e 653a  ber is not None:
-0000c7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c7d0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-0000c7e0: 2020 2020 2020 206e 2e6e 756d 6265 7220         n.number 
-0000c7f0: 3d20 636f 756e 7465 720a 2020 2020 2020  = counter.      
-0000c800: 2020 2020 2020 636f 756e 7465 7220 2b3d        counter +=
-0000c810: 2031 0a0a 2020 2020 2020 2020 2020 2020   1..            
-0000c820: 666f 7220 7020 696e 206e 2e70 6172 656e  for p in n.paren
-0000c830: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0000c840: 2020 2020 6368 6169 6e5f 6f75 7428 702c      chain_out(p,
-0000c850: 2073 7461 636b 290a 0a20 2020 2020 2020   stack)..       
-0000c860: 2064 6566 205f 7365 6c65 6374 6f72 2865   def _selector(e
-0000c870: 6c69 6769 626c 655f 6e6f 6465 733a 206c  ligible_nodes: l
-0000c880: 6973 745b 4e6f 6465 5d29 202d 3e20 696e  ist[Node]) -> in
-0000c890: 743a 0a20 2020 2020 2020 2020 2020 206d  t:.            m
-0000c8a0: 696e 5f69 6478 3a20 696e 7420 3d20 300a  in_idx: int = 0.
-0000c8b0: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
-0000c8c0: 6e75 6d62 6572 3a20 696e 7420 3d20 656c  number: int = el
-0000c8d0: 6967 6962 6c65 5f6e 6f64 6573 5b30 5d2e  igible_nodes[0].
-0000c8e0: 6e75 6d62 6572 0a0a 2020 2020 2020 2020  number..        
-0000c8f0: 2020 2020 2320 4e4f 5445 2041 6c74 686f      # NOTE Altho
-0000c900: 7567 6820 7765 2776 6520 616c 7265 6164  ugh we've alread
-0000c910: 7920 7072 6f63 6573 7365 6420 7468 6520  y processed the 
-0000c920: 6669 7273 7420 656c 656d 656e 7420 6865  first element he
-0000c930: 7265 2c20 7468 6973 2073 7469 6c6c 0a20  re, this still. 
-0000c940: 2020 2020 2020 2020 2020 2023 2020 2065             #   e
-0000c950: 6e75 6d65 7261 7465 7320 7468 6520 656e  numerates the en
-0000c960: 7469 7265 206c 6973 7420 6320 746f 2061  tire list c to a
-0000c970: 6c69 676e 2074 6865 2065 6e75 6d65 7261  lign the enumera
-0000c980: 7469 6f6e 2069 6478 2070 726f 7065 726c  tion idx properl
-0000c990: 790a 2020 2020 2020 2020 2020 2020 666f  y.            fo
-0000c9a0: 7220 6964 782c 206e 2069 6e20 656e 756d  r idx, n in enum
-0000c9b0: 6572 6174 6528 656c 6967 6962 6c65 5f6e  erate(eligible_n
-0000c9c0: 6f64 6573 293a 0a20 2020 2020 2020 2020  odes):.         
-0000c9d0: 2020 2020 2020 2063 6865 636b 286e 2e6e         check(n.n
-0000c9e0: 756d 6265 7220 6973 206e 6f74 204e 6f6e  umber is not Non
-0000c9f0: 652c 206c 616d 6264 613a 2066 2245 7870  e, lambda: f"Exp
-0000ca00: 6563 7465 6420 6561 6368 206e 6f64 6520  ected each node 
-0000ca10: 746f 2062 6520 6e75 6d62 6572 6564 2c20  to be numbered, 
-0000ca20: 6275 7420 7b6e 7d20 7761 7320 6e6f 7422  but {n} was not"
-0000ca30: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000ca40: 2020 2069 6620 6e2e 6e75 6d62 6572 203c     if n.number <
-0000ca50: 206d 696e 5f6e 756d 6265 723a 0a20 2020   min_number:.   
-0000ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca70: 206d 696e 5f69 6478 203d 2069 6478 0a20   min_idx = idx. 
-0000ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca90: 2020 206d 696e 5f6e 756d 6265 7220 3d20     min_number = 
-0000caa0: 6e2e 6e75 6d62 6572 0a0a 2020 2020 2020  n.number..      
-0000cab0: 2020 2020 2020 7265 7475 726e 206d 696e        return min
-0000cac0: 5f69 6478 0a0a 2020 2020 2020 2020 736f  _idx..        so
-0000cad0: 7274 6564 5f62 7379 6d73 203d 2074 6f70  rted_bsyms = top
-0000cae0: 6f73 6f72 745f 6273 796d 5f64 6167 286c  osort_bsym_dag(l
-0000caf0: 6561 7665 732c 2074 6f70 6f73 6f72 745f  eaves, toposort_
-0000cb00: 6f72 6465 723d 544f 504f 534f 5254 5f4f  order=TOPOSORT_O
-0000cb10: 5244 4552 2e42 4f54 544f 4d5f 5550 2c20  RDER.BOTTOM_UP, 
-0000cb20: 7365 6c65 6374 6f72 3d5f 7365 6c65 6374  selector=_select
-0000cb30: 6f72 290a 2020 2020 2020 2020 6772 6164  or).        grad
-0000cb40: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
-0000cb50: 7320 3d20 736f 7274 6564 5f62 7379 6d73  s = sorted_bsyms
-0000cb60: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
-0000cb70: 203d 2064 6365 2867 7261 6474 7263 290a   = dce(gradtrc).
-0000cb80: 0a20 2020 2020 2020 2023 2054 4f44 4f20  .        # TODO 
-0000cb90: 436f 6e73 6964 6572 2068 6f77 2074 6f20  Consider how to 
-0000cba0: 6861 6e64 6c65 2067 7261 6420 772e 722e  handle grad w.r.
-0000cbb0: 742e 206f 6e6c 7920 736f 6d65 206f 7574  t. only some out
-0000cbc0: 7075 7473 202d 2d20 7368 6f75 6c64 2061  puts -- should a
-0000cbd0: 6c6c 2067 7261 640a 2020 2020 2020 2020  ll grad.        
-0000cbe0: 2320 2020 6f70 6572 6174 696f 6e73 2075  #   operations u
-0000cbf0: 7369 6e67 2074 6865 206f 7468 6572 206f  sing the other o
-0000cc00: 7574 7075 7420 6265 2072 656d 6f76 6564  utput be removed
-0000cc10: 3f20 5768 6174 206b 696e 6420 6f66 2061  ? What kind of a
-0000cc20: 7373 756d 7074 696f 6e20 646f 6573 2074  ssumption does t
-0000cc30: 6861 740a 2020 2020 2020 2020 2320 2020  hat.        #   
-0000cc40: 6d61 6b65 2061 626f 7574 2074 6865 2067  make about the g
-0000cc50: 7261 6420 7374 7275 6374 7572 653f 2050  rad structure? P
-0000cc60: 726f 6261 626c 7920 736f 6d65 206b 696e  robably some kin
-0000cc70: 6420 6f66 2069 6e64 6570 656e 6465 6e63  d of independenc
-0000cc80: 6520 6173 7375 6d70 7469 6f6e 3f20 4172  e assumption? Ar
-0000cc90: 650a 2020 2020 2020 2020 2320 2020 7468  e.        #   th
-0000cca0: 6572 6520 7072 6163 7469 6361 6c20 6578  ere practical ex
-0000ccb0: 616d 706c 6573 2077 6865 7265 2074 6861  amples where tha
-0000ccc0: 7427 7320 616e 2069 7373 7565 3f0a 0a20  t's an issue?.. 
-0000ccd0: 2020 2020 2020 2065 6e64 5f74 696d 655f         end_time_
-0000cce0: 6e73 203d 2074 696d 652e 7469 6d65 5f6e  ns = time.time_n
-0000ccf0: 7328 290a 2020 2020 2020 2020 656c 6170  s().        elap
-0000cd00: 7365 645f 7469 6d65 5f6e 7320 3d20 656e  sed_time_ns = en
-0000cd10: 645f 7469 6d65 5f6e 7320 2d20 7374 6172  d_time_ns - star
-0000cd20: 745f 7469 6d65 5f6e 730a 2020 2020 2020  t_time_ns.      
-0000cd30: 2020 656c 6170 7365 645f 7469 6d65 5f6d    elapsed_time_m
-0000cd40: 696c 6c69 7320 3d20 656c 6170 7365 645f  illis = elapsed_
-0000cd50: 7469 6d65 5f6e 7320 2f2f 2031 3030 3030  time_ns // 10000
-0000cd60: 3030 0a20 2020 2020 2020 2067 7261 6474  00.        gradt
-0000cd70: 7263 2e73 6574 5f70 726f 7665 6e61 6e63  rc.set_provenanc
-0000cd80: 6528 5472 6163 6550 726f 7665 6e61 6e63  e(TraceProvenanc
-0000cd90: 6528 6622 4772 6164 2028 746f 6f6b 207b  e(f"Grad (took {
-0000cda0: 656c 6170 7365 645f 7469 6d65 5f6d 696c  elapsed_time_mil
-0000cdb0: 6c69 737d 206d 696c 6c69 7365 636f 6e64  lis} millisecond
-0000cdc0: 7329 2229 290a 0a20 2020 2020 2020 2072  s)"))..        r
-0000cdd0: 6574 7572 6e20 6772 6164 7472 630a 0a20  eturn gradtrc.. 
-0000cde0: 2020 2023 204e 4f54 4520 5468 6973 2069     # NOTE This i
-0000cdf0: 7320 6120 6b6c 7564 6765 2074 6f20 696e  s a kludge to in
-0000ce00: 6469 6361 7465 2074 6861 7420 7765 2073  dicate that we s
-0000ce10: 686f 756c 646e 2774 2075 7365 2050 7954  houldn't use PyT
-0000ce20: 6f72 6368 2773 2061 7574 6f67 7261 6420  orch's autograd 
-0000ce30: 6265 6361 7573 650a 2020 2020 2320 2020  because.    #   
-0000ce40: 7765 2772 6520 7573 696e 6720 6f75 7220  we're using our 
-0000ce50: 6f77 6e20 6175 746f 6772 6164 2074 7261  own autograd tra
-0000ce60: 6e73 666f 726d 0a20 2020 2063 666e 2e5f  nsform.    cfn._
-0000ce70: 7573 696e 675f 6772 6164 5f74 7261 6e73  using_grad_trans
-0000ce80: 666f 726d 203d 2054 7275 650a 0a20 2020  form = True..   
-0000ce90: 2072 6574 7572 6e20 6164 645f 7472 616e   return add_tran
-0000cea0: 7366 6f72 6d28 6366 6e2c 205f 6772 6164  sform(cfn, _grad
-0000ceb0: 5f74 7261 6e73 666f 726d 290a 0a0a 6465  _transform)...de
-0000cec0: 6620 6772 6164 5f76 3128 0a20 2020 2063  f grad_v1(.    c
-0000ced0: 666e 2c0a 2920 2d3e 2043 616c 6c61 626c  fn,.) -> Callabl
-0000cee0: 653a 0a20 2020 2064 6566 2067 7261 6428  e:.    def grad(
-0000cef0: 6675 6e63 293a 0a20 2020 2020 2020 2064  func):.        d
-0000cf00: 6566 2067 7261 645f 6675 6e63 282a 6172  ef grad_func(*ar
-0000cf10: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
-0000cf20: 2020 2020 2020 2020 2020 205f 2c20 6772             _, gr
-0000cf30: 6164 7320 3d20 7661 6c75 655f 616e 645f  ads = value_and_
-0000cf40: 6772 6164 2866 756e 6329 282a 6172 6773  grad(func)(*args
-0000cf50: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-0000cf60: 2020 2020 2020 2020 6772 6164 7320 3d20          grads = 
-0000cf70: 5b67 2066 6f72 2067 2069 6e20 6772 6164  [g for g in grad
-0000cf80: 7320 6966 2067 2069 7320 6e6f 7420 4e6f  s if g is not No
-0000cf90: 6e65 5d0a 2020 2020 2020 2020 2020 2020  ne].            
-0000cfa0: 7265 7475 726e 2067 7261 6473 0a0a 2020  return grads..  
-0000cfb0: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
-0000cfc0: 645f 6675 6e63 0a0a 2020 2020 6465 6620  d_func..    def 
-0000cfd0: 5f67 7261 645f 7472 616e 7366 6f72 6d28  _grad_transform(
-0000cfe0: 7472 633a 2054 7261 6365 2c20 2a2c 2065  trc: Trace, *, e
-0000cff0: 7865 6375 746f 7273 5f6c 6973 743a 2053  xecutors_list: S
-0000d000: 6571 7565 6e63 655b 416e 795d 2920 2d3e  equence[Any]) ->
-0000d010: 2054 7261 6365 3a0a 2020 2020 2020 2020   Trace:.        
-0000d020: 6772 6164 7472 6320 3d20 636f 6e73 7472  gradtrc = constr
-0000d030: 7563 745f 7472 6163 6528 2928 6772 6164  uct_trace()(grad
-0000d040: 2874 7263 2e70 7974 686f 6e5f 6361 6c6c  (trc.python_call
-0000d050: 6162 6c65 2829 292c 202a 7472 632e 6172  able()), *trc.ar
-0000d060: 6773 2c20 2a2a 7472 632e 6b77 6172 6773  gs, **trc.kwargs
-0000d070: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0000d080: 2067 7261 6474 7263 0a0a 2020 2020 6366   gradtrc..    cf
-0000d090: 6e2e 5f75 7369 6e67 5f67 7261 645f 7472  n._using_grad_tr
-0000d0a0: 616e 7366 6f72 6d20 3d20 5472 7565 0a20  ansform = True. 
-0000d0b0: 2020 2072 6574 7572 6e20 6164 645f 7472     return add_tr
-0000d0c0: 616e 7366 6f72 6d28 6366 6e2c 205f 6772  ansform(cfn, _gr
-0000d0d0: 6164 5f74 7261 6e73 666f 726d 290a 0a0a  ad_transform)...
-0000d0e0: 636c 6173 7320 5472 616e 7366 6f72 6d73  class Transforms
-0000d0f0: 2845 6e75 6d29 3a0a 2020 2020 4964 656e  (Enum):.    Iden
-0000d100: 7469 7479 4f70 203d 2061 7574 6f28 290a  tityOp = auto().
-0000d110: 2020 2020 566d 6170 4f70 203d 2061 7574      VmapOp = aut
-0000d120: 6f28 290a 2020 2020 4a76 704f 7020 3d20  o().    JvpOp = 
-0000d130: 6175 746f 2829 0a20 2020 2056 6a70 4f70  auto().    VjpOp
-0000d140: 203d 2061 7574 6f28 290a 0a0a 406c 7275   = auto()...@lru
-0000d150: 5f63 6163 6865 286d 6178 7369 7a65 3d4e  _cache(maxsize=N
-0000d160: 6f6e 6529 0a64 6566 2073 796d 626f 6c5f  one).def symbol_
-0000d170: 746f 5f65 7661 6c28 626f 756e 645f 7379  to_eval(bound_sy
-0000d180: 6d62 6f6c 293a 0a20 2020 2022 2222 4d61  mbol):.    """Ma
-0000d190: 7020 6120 426f 756e 6453 796d 626f 6c20  p a BoundSymbol 
-0000d1a0: 746f 2061 2066 756e 6374 696f 6e20 7468  to a function th
-0000d1b0: 6174 2065 7661 6c75 6174 6573 2069 742e  at evaluates it.
-0000d1c0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0000d1d0: 2020 2020 626f 756e 645f 7379 6d62 6f6c      bound_symbol
-0000d1e0: 3a20 426f 756e 6453 796d 626f 6c20 746f  : BoundSymbol to
-0000d1f0: 206d 6170 0a20 2020 2022 2222 0a20 2020   map.    """.   
-0000d200: 2023 2053 796d 626f 6c20 6973 2063 616c   # Symbol is cal
-0000d210: 6c61 626c 650a 2020 2020 7265 7475 726e  lable.    return
-0000d220: 2062 6f75 6e64 5f73 796d 626f 6c2e 7379   bound_symbol.sy
-0000d230: 6d0a 0a0a 2320 544f 444f 3a20 4375 7272  m...# TODO: Curr
-0000d240: 656e 746c 7920 7765 2075 7365 2074 7261  ently we use tra
-0000d250: 6365 2e61 7267 7320 616e 6420 7472 6163  ce.args and trac
-0000d260: 652e 6b77 6172 6773 2074 6f20 6765 7420  e.kwargs to get 
-0000d270: 7468 6520 6172 6775 6d65 6e74 730a 2320  the arguments.# 
-0000d280: 4d61 7962 6520 7765 2073 686f 756c 6420  Maybe we should 
-0000d290: 7573 6520 7468 6573 6520 696e 7374 6561  use these instea
-0000d2a0: 640a 7472 616e 7366 6f72 6d5f 736b 6970  d.transform_skip
-0000d2b0: 5f6c 6973 7420 3d20 280a 2020 2020 7072  _list = (.    pr
-0000d2c0: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
-0000d2d0: 434b 5f45 4d50 5459 5f44 4943 542c 0a20  CK_EMPTY_DICT,. 
-0000d2e0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-0000d2f0: 2e55 4e50 4143 4b5f 4b45 592c 0a20 2020  .UNPACK_KEY,.   
-0000d300: 2070 7269 6d73 2e50 7269 6d49 4473 2e55   prims.PrimIDs.U
-0000d310: 4e50 4143 4b5f 5345 5155 454e 4345 2c0a  NPACK_SEQUENCE,.
-0000d320: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-0000d330: 732e 554e 5041 434b 5f54 5249 5649 414c  s.UNPACK_TRIVIAL
-0000d340: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-0000d350: 4944 732e 5245 5455 524e 2c0a 290a 0a0a  IDs.RETURN,.)...
-0000d360: 6465 6620 6576 616c 5f74 7261 6365 2874  def eval_trace(t
-0000d370: 7261 6365 2c20 2a61 7267 732c 2073 796d  race, *args, sym
-0000d380: 626f 6c5f 6d61 7070 6572 3d73 796d 626f  bol_mapper=symbo
-0000d390: 6c5f 746f 5f65 7661 6c2c 2077 6974 685f  l_to_eval, with_
-0000d3a0: 656e 763d 4661 6c73 652c 202a 2a6b 7761  env=False, **kwa
-0000d3b0: 7267 7329 3a0a 2020 2020 2222 2245 7661  rgs):.    """Eva
-0000d3c0: 6c75 6174 6520 6120 7472 6163 652e 0a0a  luate a trace...
-0000d3d0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-0000d3e0: 2020 7472 6163 653a 2074 7261 6365 2074    trace: trace t
-0000d3f0: 6f20 6576 616c 7561 7465 0a20 2020 2020  o evaluate.     
-0000d400: 2020 202a 6172 6773 3a20 6172 6775 6d65     *args: argume
-0000d410: 6e74 7320 746f 2065 7661 6c75 6174 6520  nts to evaluate 
-0000d420: 7468 6520 7472 6163 6520 7769 7468 0a20  the trace with. 
-0000d430: 2020 2020 2020 2073 796d 626f 6c5f 6d61         symbol_ma
-0000d440: 7070 6572 3a20 6675 6e63 7469 6f6e 2074  pper: function t
-0000d450: 6861 7420 6d61 7073 2061 2073 796d 626f  hat maps a symbo
-0000d460: 6c20 746f 2061 2066 756e 6374 696f 6e20  l to a function 
-0000d470: 7468 6174 2065 7661 6c75 6174 6573 2069  that evaluates i
-0000d480: 740a 2020 2020 2020 2020 2a2a 6b77 6172  t.        **kwar
-0000d490: 6773 3a20 6b65 7977 6f72 6420 6172 6775  gs: keyword argu
-0000d4a0: 6d65 6e74 7320 746f 2065 7661 6c75 6174  ments to evaluat
-0000d4b0: 6520 7468 6520 7472 6163 6520 7769 7468  e the trace with
-0000d4c0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-0000d4d0: 2020 2020 2020 2072 6573 756c 7420 6f66         result of
-0000d4e0: 2065 7661 6c75 6174 696e 6720 7468 6520   evaluating the 
-0000d4f0: 7472 6163 650a 2020 2020 2222 220a 2020  trace.    """.  
-0000d500: 2020 656e 7620 3d20 7b7d 0a0a 2020 2020    env = {}..    
-0000d510: 6465 6620 7265 6164 2878 3a20 5661 7269  def read(x: Vari
-0000d520: 6162 6c65 293a 0a20 2020 2020 2020 2069  able):.        i
-0000d530: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-0000d540: 5661 7269 6162 6c65 293a 0a20 2020 2020  Variable):.     
-0000d550: 2020 2020 2020 2072 6574 7572 6e20 656e         return en
-0000d560: 765b 782e 6e61 6d65 5d0a 2020 2020 2020  v[x.name].      
-0000d570: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000d580: 2020 2020 7265 7475 726e 2078 0a0a 2020      return x..  
-0000d590: 2020 6465 6620 7772 6974 6528 763a 2056    def write(v: V
-0000d5a0: 6172 6961 626c 652c 2076 616c 3a20 416e  ariable, val: An
-0000d5b0: 792c 2061 6c6c 6f77 5f64 7570 6c69 6361  y, allow_duplica
-0000d5c0: 7465 733d 4661 6c73 6529 202d 3e20 4e6f  tes=False) -> No
-0000d5d0: 6e65 3a0a 2020 2020 2020 2020 6966 206e  ne:.        if n
-0000d5e0: 6f74 2069 7369 6e73 7461 6e63 6528 762c  ot isinstance(v,
-0000d5f0: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
-0000d600: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0000d610: 2020 2020 2020 2023 2044 7570 6c69 6361         # Duplica
-0000d620: 7465 7320 6172 6520 616c 6c6f 7765 6420  tes are allowed 
-0000d630: 616e 6420 6f76 6572 7772 6974 7465 6e0a  and overwritten.
-0000d640: 2020 2020 2020 2020 6966 2076 2e6e 616d          if v.nam
-0000d650: 6520 696e 2065 6e76 3a0a 2020 2020 2020  e in env:.      
-0000d660: 2020 2020 2020 6966 2061 6c6c 6f77 5f64        if allow_d
-0000d670: 7570 6c69 6361 7465 733a 0a20 2020 2020  uplicates:.     
-0000d680: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000d690: 6e0a 2020 2020 2020 2020 2020 2020 7261  n.            ra
-0000d6a0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-0000d6b0: 2256 6172 6961 626c 6520 7b76 2e6e 616d  "Variable {v.nam
-0000d6c0: 657d 2069 7320 6265 696e 6720 6f76 6572  e} is being over
-0000d6d0: 7772 6974 7465 6e20 7468 6973 2069 7320  written this is 
-0000d6e0: 6e6f 7420 616c 6c6f 7765 6422 290a 2020  not allowed").  
-0000d6f0: 2020 2020 2020 656e 765b 762e 6e61 6d65        env[v.name
-0000d700: 5d20 3d20 7661 6c0a 0a20 2020 2073 6166  ] = val..    saf
-0000d710: 655f 6d61 705f 666c 6174 2877 7269 7465  e_map_flat(write
-0000d720: 2c20 6c69 7374 2874 7261 6365 2e61 7267  , list(trace.arg
-0000d730: 7329 2c20 6c69 7374 2861 7267 7329 290a  s), list(args)).
-0000d740: 2020 2020 7361 6665 5f6d 6170 5f66 6c61      safe_map_fla
-0000d750: 7428 7772 6974 652c 206c 6973 7428 7472  t(write, list(tr
-0000d760: 6163 652e 6b77 6172 6773 2e76 616c 7565  ace.kwargs.value
-0000d770: 7328 2929 2c20 6c69 7374 286b 7761 7267  s()), list(kwarg
-0000d780: 732e 7661 6c75 6573 2829 2929 0a0a 2020  s.values()))..  
-0000d790: 2020 666f 7220 7379 6d62 6f6c 2069 6e20    for symbol in 
-0000d7a0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-0000d7b0: 6f6c 733a 0a20 2020 2020 2020 2069 6620  ols:.        if 
-0000d7c0: 7379 6d62 6f6c 2e73 796d 2e69 6420 696e  symbol.sym.id in
-0000d7d0: 2074 7261 6e73 666f 726d 5f73 6b69 705f   transform_skip_
-0000d7e0: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
-0000d7f0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-0000d800: 2020 2061 7267 7320 3d20 7472 6565 5f6d     args = tree_m
-0000d810: 6170 2872 6561 642c 2073 796d 626f 6c2e  ap(read, symbol.
-0000d820: 6172 6773 290a 2020 2020 2020 2020 6b77  args).        kw
-0000d830: 6172 6773 203d 2074 7265 655f 6d61 7028  args = tree_map(
-0000d840: 7265 6164 2c20 7379 6d62 6f6c 2e6b 7761  read, symbol.kwa
-0000d850: 7267 7329 0a20 2020 2020 2020 2070 7269  rgs).        pri
-0000d860: 6d5f 6675 6e63 203d 2073 796d 626f 6c5f  m_func = symbol_
-0000d870: 6d61 7070 6572 2873 796d 626f 6c29 0a20  mapper(symbol). 
-0000d880: 2020 2020 2020 2069 6620 7072 696d 5f66         if prim_f
-0000d890: 756e 6320 6973 204e 6f6e 653a 0a20 2020  unc is None:.   
-0000d8a0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-0000d8b0: 650a 2020 2020 2020 2020 7265 7375 6c74  e.        result
-0000d8c0: 203d 2070 7269 6d5f 6675 6e63 282a 6172   = prim_func(*ar
-0000d8d0: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
-0000d8e0: 2020 2020 2020 7361 6665 5f6d 6170 5f66        safe_map_f
-0000d8f0: 6c61 7428 7772 6974 652c 206c 6973 7428  lat(write, list(
-0000d900: 7365 7175 656e 6369 6679 2873 796d 626f  sequencify(symbo
-0000d910: 6c2e 6f75 7470 7574 2929 2c20 6c69 7374  l.output)), list
-0000d920: 2873 6571 7565 6e63 6966 7928 7265 7375  (sequencify(resu
-0000d930: 6c74 2929 290a 0a20 2020 2069 6620 7769  lt)))..    if wi
-0000d940: 7468 5f65 6e76 3a0a 2020 2020 2020 2020  th_env:.        
-0000d950: 7265 7475 726e 2074 7265 655f 6d61 7028  return tree_map(
-0000d960: 7265 6164 2c20 7472 6163 652e 6f75 7470  read, trace.outp
-0000d970: 7574 292c 2065 6e76 0a0a 2020 2020 7265  ut), env..    re
-0000d980: 7475 726e 2074 7265 655f 6d61 7028 7265  turn tree_map(re
-0000d990: 6164 2c20 7472 6163 652e 6f75 7470 7574  ad, trace.output
-0000d9a0: 290a 0a0a 6465 6620 5f69 6465 6e74 6974  )...def _identit
-0000d9b0: 795f 6361 6c6c 5f6d 6574 6166 756e 6328  y_call_metafunc(
-0000d9c0: 2a61 7267 732c 2074 7261 6365 3a20 5472  *args, trace: Tr
-0000d9d0: 6163 652c 202a 2a6b 7761 7267 7329 3a0a  ace, **kwargs):.
-0000d9e0: 2020 2020 7769 7468 2064 6574 6163 6865      with detache
-0000d9f0: 645f 7472 6163 6528 293a 0a20 2020 2020  d_trace():.     
-0000da00: 2020 2072 6574 7572 6e20 6576 616c 5f74     return eval_t
-0000da10: 7261 6365 2874 7261 6365 2c20 2a61 7267  race(trace, *arg
-0000da20: 732c 202a 2a6b 7761 7267 7329 0a0a 0a69  s, **kwargs)...i
-0000da30: 6465 6e74 6974 795f 6361 6c6c 203d 2053  dentity_call = S
-0000da40: 796d 626f 6c28 6964 3d54 7261 6e73 666f  ymbol(id=Transfo
-0000da50: 726d 732e 4964 656e 7469 7479 4f70 2c20  rms.IdentityOp, 
-0000da60: 6e61 6d65 3d22 6964 656e 7469 7479 5f63  name="identity_c
-0000da70: 616c 6c22 2c20 6d65 7461 3d5f 6964 656e  all", meta=_iden
-0000da80: 7469 7479 5f63 616c 6c5f 6d65 7461 6675  tity_call_metafu
-0000da90: 6e63 290a 0a0a 6465 6620 6964 656e 7469  nc)...def identi
-0000daa0: 7479 2866 756e 6329 3a0a 2020 2020 2222  ty(func):.    ""
-0000dab0: 2249 6465 6e74 6974 7920 7472 616e 7366  "Identity transf
-0000dac0: 6f72 6d20 666f 7220 6120 5468 756e 6465  orm for a Thunde
-0000dad0: 7220 6675 6e63 7469 6f6e 2e0a 0a20 2020  r function...   
-0000dae0: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
-0000daf0: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
-0000db00: 4120 5468 756e 6465 7220 6675 6e63 7469  A Thunder functi
-0000db10: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
-0000db20: 726d 6564 2e0a 2020 2020 2222 220a 0a20  rmed..    """.. 
-0000db30: 2020 2064 6566 2077 7261 7070 6572 282a     def wrapper(*
-0000db40: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-0000db50: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
-0000db60: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
-0000db70: 2829 2866 756e 632c 202a 6172 6773 2c20  ()(func, *args, 
-0000db80: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
-0000db90: 2020 7265 7475 726e 2069 6465 6e74 6974    return identit
-0000dba0: 795f 6361 6c6c 282a 6172 6773 2c20 2a2a  y_call(*args, **
-0000dbb0: 6b77 6172 6773 2c20 7472 6163 653d 7472  kwargs, trace=tr
-0000dbc0: 6163 6529 0a0a 2020 2020 7265 7475 726e  ace)..    return
-0000dbd0: 2077 7261 7070 6572 0a0a 0a64 6566 205f   wrapper...def _
-0000dbe0: 6964 656e 7469 7479 5f63 616c 6c5f 7079  identity_call_py
-0000dbf0: 746f 7263 6828 2a61 7267 732c 2074 7261  torch(*args, tra
-0000dc00: 6365 3a20 5472 6163 652c 202a 2a6b 7761  ce: Trace, **kwa
-0000dc10: 7267 7329 3a0a 2020 2020 696d 706f 7274  rgs):.    import
-0000dc20: 2074 6f72 6368 0a0a 2020 2020 6465 6620   torch..    def 
-0000dc30: 7379 6d62 6f6c 5f6d 6170 7065 7228 6f70  symbol_mapper(op
-0000dc40: 293a 0a20 2020 2020 2020 2069 6620 6f70  ):.        if op
-0000dc50: 2e6f 7020 3d3d 2054 7261 6e73 666f 726d  .op == Transform
-0000dc60: 732e 4964 656e 7469 7479 4f70 3a0a 2020  s.IdentityOp:.  
-0000dc70: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000dc80: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
-0000dc90: 7079 746f 7263 680a 0a20 2020 2020 2020  pytorch..       
-0000dca0: 2074 6f72 6368 5f6f 7020 3d20 6f70 735f   torch_op = ops_
-0000dcb0: 746f 5f74 6f72 6368 5f6f 7073 5f6d 6170  to_torch_ops_map
-0000dcc0: 5b6f 702e 6f70 5d0a 2020 2020 2020 2020  [op.op].        
-0000dcd0: 6966 2069 7369 6e73 7461 6e63 6528 746f  if isinstance(to
-0000dce0: 7263 685f 6f70 2c20 7374 7229 3a0a 2020  rch_op, str):.  
-0000dcf0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000dd00: 2067 6574 6174 7472 2874 6f72 6368 2c20   getattr(torch, 
-0000dd10: 746f 7263 685f 6f70 2e73 7472 6970 2822  torch_op.strip("
-0000dd20: 7079 746f 7263 682e 2229 290a 2020 2020  pytorch.")).    
-0000dd30: 2020 2020 7265 7475 726e 2074 6f72 6368      return torch
-0000dd40: 5f6f 700a 0a20 2020 2077 6974 6820 6465  _op..    with de
-0000dd50: 7461 6368 6564 5f74 7261 6365 2829 3a0a  tached_trace():.
-0000dd60: 2020 2020 2020 2020 7265 7475 726e 2065          return e
-0000dd70: 7661 6c5f 7472 6163 6528 7472 6163 652c  val_trace(trace,
-0000dd80: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
-0000dd90: 2c20 7379 6d62 6f6c 5f6d 6170 7065 723d  , symbol_mapper=
-0000dda0: 7379 6d62 6f6c 5f6d 6170 7065 7229 0a0a  symbol_mapper)..
-0000ddb0: 0a23 2052 6567 6973 7465 7220 7468 6520  .# Register the 
-0000ddc0: 6964 656e 7469 7479 2063 616c 6c20 666f  identity call fo
-0000ddd0: 7220 5079 546f 7263 6820 6578 6563 7574  r PyTorch execut
-0000dde0: 6f72 2e0a 2320 6f70 735f 746f 5f74 6f72  or..# ops_to_tor
-0000ddf0: 6368 5f6f 7073 5f6d 6170 5b54 7261 6e73  ch_ops_map[Trans
-0000de00: 666f 726d 732e 4964 656e 7469 7479 4f70  forms.IdentityOp
-0000de10: 5d20 3d20 5f69 6465 6e74 6974 795f 6361  ] = _identity_ca
-0000de20: 6c6c 5f70 7974 6f72 6368 0a0a 0a23 2056  ll_pytorch...# V
-0000de30: 4d41 5020 7472 616e 7366 6f72 6d0a 2320  MAP transform.# 
-0000de40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a  -------------...
-0000de50: 636c 6173 7320 4e6f 744d 6170 7065 643a  class NotMapped:
-0000de60: 0a20 2020 2022 2222 5265 7072 6573 656e  .    """Represen
-0000de70: 7473 2061 206e 6f6e 2d62 6174 6368 6564  ts a non-batched
-0000de80: 2064 696d 656e 7369 6f6e 2e22 2222 0a0a   dimension."""..
-0000de90: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
-0000dea0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000deb0: 7265 7475 726e 2022 6e6f 745f 6d61 7070  return "not_mapp
-0000dec0: 6564 220a 0a0a 4064 6174 6163 6c61 7373  ed"...@dataclass
-0000ded0: 2866 726f 7a65 6e3d 5472 7565 290a 636c  (frozen=True).cl
-0000dee0: 6173 7320 4261 7463 6865 6456 616c 7565  ass BatchedValue
-0000def0: 3a0a 2020 2020 2222 2242 6174 6368 6564  :.    """Batched
-0000df00: 2076 616c 7565 2066 6f72 2074 6865 2076   value for the v
-0000df10: 6d61 7020 7472 616e 7366 6f72 6d2e 0a0a  map transform...
-0000df20: 2020 2020 4174 7472 6962 7574 6573 3a0a      Attributes:.
-0000df30: 2020 2020 2020 2020 7661 6c75 653a 2042          value: B
-0000df40: 6174 6368 6564 2076 616c 7565 2e0a 2020  atched value..  
-0000df50: 2020 2020 2020 6261 7463 685f 6469 6d3a        batch_dim:
-0000df60: 2042 6174 6368 696e 6720 6469 6d65 6e73   Batching dimens
-0000df70: 696f 6e20 6f72 206e 6f74 5f6d 6170 7065  ion or not_mappe
-0000df80: 640a 2020 2020 2222 220a 0a20 2020 2076  d.    """..    v
-0000df90: 616c 7565 3a20 416e 790a 2020 2020 6261  alue: Any.    ba
-0000dfa0: 7463 685f 6469 6d3a 2069 6e74 207c 204e  tch_dim: int | N
-0000dfb0: 6f74 4d61 7070 6564 0a0a 2020 2020 6465  otMapped..    de
-0000dfc0: 6620 5f5f 6974 6572 5f5f 2873 656c 6629  f __iter__(self)
-0000dfd0: 3a0a 2020 2020 2020 2020 7969 656c 6420  :.        yield 
-0000dfe0: 7365 6c66 2e76 616c 7565 0a20 2020 2020  self.value.     
-0000dff0: 2020 2079 6965 6c64 2073 656c 662e 6261     yield self.ba
-0000e000: 7463 685f 6469 6d0a 0a0a 6465 6620 7061  tch_dim...def pa
-0000e010: 6972 5f74 6f5f 6261 7463 6865 645f 7661  ir_to_batched_va
-0000e020: 6c75 6528 7061 6972 293a 0a20 2020 2022  lue(pair):.    "
-0000e030: 2222 436f 6e76 6572 7473 2061 2070 6169  ""Converts a pai
-0000e040: 7220 746f 2061 2042 6174 6368 6564 5661  r to a BatchedVa
-0000e050: 6c75 652e 0a0a 2020 2020 4172 6773 3a0a  lue...    Args:.
-0000e060: 2020 2020 2020 2020 7061 6972 2028 5365          pair (Se
-0000e070: 7175 656e 6365 293a 2050 6169 7220 746f  quence): Pair to
-0000e080: 2063 6f6e 7665 7274 2e0a 0a20 2020 2052   convert...    R
-0000e090: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0000e0a0: 4261 7463 6865 6456 616c 7565 3a20 4261  BatchedValue: Ba
-0000e0b0: 7463 6865 6456 616c 7565 2072 6570 7265  tchedValue repre
-0000e0c0: 7365 6e74 6174 696f 6e20 6f66 2074 6865  sentation of the
-0000e0d0: 2070 6169 722e 0a20 2020 2022 2222 0a20   pair..    """. 
-0000e0e0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000e0f0: 2870 6169 722c 2042 6174 6368 6564 5661  (pair, BatchedVa
-0000e100: 6c75 6529 3a0a 2020 2020 2020 2020 7265  lue):.        re
-0000e110: 7475 726e 2070 6169 720a 2020 2020 656c  turn pair.    el
-0000e120: 7365 3a0a 2020 2020 2020 2020 6173 7365  se:.        asse
-0000e130: 7274 2069 7369 6e73 7461 6e63 6528 7061  rt isinstance(pa
-0000e140: 6972 2c20 5365 7175 656e 6365 2920 616e  ir, Sequence) an
-0000e150: 6420 6c65 6e28 7061 6972 2920 3d3d 2032  d len(pair) == 2
-0000e160: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000e170: 4261 7463 6865 6456 616c 7565 282a 7061  BatchedValue(*pa
-0000e180: 6972 290a 0a0a 6465 6620 7665 6374 6f72  ir)...def vector
-0000e190: 697a 6564 5f62 6174 6368 6572 2870 7269  ized_batcher(pri
-0000e1a0: 6d2c 2061 7869 735f 7369 7a65 2c20 6261  m, axis_size, ba
-0000e1b0: 7463 6865 645f 7661 6c75 6573 2c20 2a2a  tched_values, **
-0000e1c0: 6b77 6172 6773 293a 0a20 2020 2062 6174  kwargs):.    bat
-0000e1d0: 6368 5f64 696d 203d 2062 6174 6368 6564  ch_dim = batched
-0000e1e0: 5f76 616c 7565 735b 305d 2e62 6174 6368  _values[0].batch
-0000e1f0: 5f64 696d 0a20 2020 2061 7373 6572 7420  _dim.    assert 
-0000e200: 616c 6c28 0a20 2020 2020 2020 2062 6174  all(.        bat
-0000e210: 6368 5f64 696d 203d 3d20 6276 2e62 6174  ch_dim == bv.bat
-0000e220: 6368 5f64 696d 2066 6f72 2062 7620 696e  ch_dim for bv in
-0000e230: 2062 6174 6368 6564 5f76 616c 7565 735b   batched_values[
-0000e240: 313a 5d0a 2020 2020 292c 2066 2260 7665  1:].    ), f"`ve
-0000e250: 6374 6f72 697a 6564 5f62 6174 6368 6572  ctorized_batcher
-0000e260: 6020 676f 7420 6469 6666 6572 656e 7420  ` got different 
-0000e270: 6261 7463 6865 6420 6469 6d65 6e73 696f  batched dimensio
-0000e280: 6e73 207b 5b62 762e 6261 7463 685f 6469  ns {[bv.batch_di
-0000e290: 6d20 666f 7220 6276 2069 6e20 6261 7463  m for bv in batc
-0000e2a0: 6865 645f 7661 6c75 6573 5d7d 220a 2020  hed_values]}".  
-0000e2b0: 2020 7265 7475 726e 2042 6174 6368 6564    return Batched
-0000e2c0: 5661 6c75 6528 7072 696d 282a 5b62 762e  Value(prim(*[bv.
-0000e2d0: 7661 6c75 6520 666f 7220 6276 2069 6e20  value for bv in 
-0000e2e0: 6261 7463 6865 645f 7661 6c75 6573 5d2c  batched_values],
-0000e2f0: 202a 2a6b 7761 7267 7329 2c20 6261 7463   **kwargs), batc
-0000e300: 685f 6469 6d29 0a0a 0a6e 6f74 5f6d 6170  h_dim)...not_map
-0000e310: 7065 6420 3d20 4e6f 744d 6170 7065 6428  ped = NotMapped(
-0000e320: 290a 0a0a 6465 6620 6d6f 7665 6469 6d28  )...def movedim(
-0000e330: 782c 2073 7263 3a20 696e 742c 2064 7374  x, src: int, dst
-0000e340: 3a20 696e 7429 3a0a 2020 2020 7065 726d  : int):.    perm
-0000e350: 203d 205b 6920 666f 7220 6920 696e 2072   = [i for i in r
-0000e360: 616e 6765 2878 2e6e 6469 6d29 2069 6620  ange(x.ndim) if 
-0000e370: 6920 213d 2073 7263 5d0a 2020 2020 7065  i != src].    pe
-0000e380: 726d 2e69 6e73 6572 7428 6473 742c 2073  rm.insert(dst, s
-0000e390: 7263 290a 2020 2020 7265 7475 726e 2070  rc).    return p
-0000e3a0: 7269 6d73 2e74 7261 6e73 706f 7365 2878  rims.transpose(x
-0000e3b0: 2c20 7475 706c 6528 7065 726d 2929 0a0a  , tuple(perm))..
-0000e3c0: 0a64 6566 206d 6f76 655f 6261 7463 685f  .def move_batch_
-0000e3d0: 6469 6d28 6178 6973 5f73 697a 652c 2073  dim(axis_size, s
-0000e3e0: 7263 2c20 6473 742c 2078 293a 0a20 2020  rc, dst, x):.   
-0000e3f0: 2069 6620 7372 6320 6973 206e 6f74 5f6d   if src is not_m
-0000e400: 6170 7065 643a 0a20 2020 2020 2020 2069  apped:.        i
-0000e410: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-0000e420: 4e75 6d62 6572 293a 0a20 2020 2020 2020  Number):.       
-0000e430: 2020 2020 2072 6574 7572 6e20 780a 2020       return x.  
-0000e440: 2020 2020 2020 7461 7267 6574 5f73 6861        target_sha
-0000e450: 7065 203d 206c 6973 7428 782e 7368 6170  pe = list(x.shap
-0000e460: 6529 0a20 2020 2020 2020 2074 6172 6765  e).        targe
-0000e470: 745f 7368 6170 652e 696e 7365 7274 2864  t_shape.insert(d
-0000e480: 7374 2c20 6178 6973 5f73 697a 6529 0a20  st, axis_size). 
-0000e490: 2020 2020 2020 2062 6361 7374 5f64 696d         bcast_dim
-0000e4a0: 7320 3d20 6c69 7374 2872 616e 6765 286c  s = list(range(l
-0000e4b0: 656e 2874 6172 6765 745f 7368 6170 6529  en(target_shape)
-0000e4c0: 2929 0a20 2020 2020 2020 2062 6361 7374  )).        bcast
-0000e4d0: 5f64 696d 732e 706f 7028 6473 7429 0a20  _dims.pop(dst). 
-0000e4e0: 2020 2020 2020 2072 6574 7572 6e20 7072         return pr
-0000e4f0: 696d 732e 6272 6f61 6463 6173 745f 696e  ims.broadcast_in
-0000e500: 5f64 696d 2878 2c20 7461 7267 6574 5f73  _dim(x, target_s
-0000e510: 6861 7065 2c20 6263 6173 745f 6469 6d73  hape, bcast_dims
-0000e520: 290a 2020 2020 656c 6966 2073 7263 203d  ).    elif src =
-0000e530: 3d20 6473 743a 0a20 2020 2020 2020 2072  = dst:.        r
-0000e540: 6574 7572 6e20 780a 2020 2020 656c 7365  eturn x.    else
-0000e550: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000e560: 206d 6f76 6564 696d 2878 2c20 7372 632c   movedim(x, src,
-0000e570: 2064 7374 290a 0a0a 6465 6620 6269 6e61   dst)...def bina
-0000e580: 7279 5f6f 705f 6261 7463 6869 6e67 5f72  ry_op_batching_r
-0000e590: 756c 6528 6f70 3a20 7072 696d 732e 5072  ule(op: prims.Pr
-0000e5a0: 696d 4944 732c 2061 7869 735f 7369 7a65  imIDs, axis_size
-0000e5b0: 3a20 696e 742c 2076 616c 735f 696e 3a20  : int, vals_in: 
-0000e5c0: 4261 7463 6865 6456 616c 7565 293a 0a20  BatchedValue):. 
-0000e5d0: 2020 2028 2878 2c20 785f 6264 696d 292c     ((x, x_bdim),
-0000e5e0: 2028 792c 2079 5f62 6469 6d29 2920 3d20   (y, y_bdim)) = 
-0000e5f0: 7661 6c73 5f69 6e0a 2020 2020 6966 2078  vals_in.    if x
-0000e600: 5f62 6469 6d20 213d 2079 5f62 6469 6d3a  _bdim != y_bdim:
-0000e610: 0a20 2020 2020 2020 2069 6620 785f 6264  .        if x_bd
-0000e620: 696d 2069 7320 6e6f 745f 6d61 7070 6564  im is not_mapped
-0000e630: 3a0a 2020 2020 2020 2020 2020 2020 7820  :.            x 
-0000e640: 3d20 6d6f 7665 5f62 6174 6368 5f64 696d  = move_batch_dim
-0000e650: 2861 7869 735f 7369 7a65 2c20 785f 6264  (axis_size, x_bd
-0000e660: 696d 2c20 795f 6264 696d 2c20 7829 0a20  im, y_bdim, x). 
-0000e670: 2020 2020 2020 2020 2020 2078 5f62 6469             x_bdi
-0000e680: 6d20 3d20 795f 6264 696d 0a20 2020 2020  m = y_bdim.     
-0000e690: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000e6a0: 2020 2020 2079 203d 206d 6f76 655f 6261       y = move_ba
-0000e6b0: 7463 685f 6469 6d28 6178 6973 5f73 697a  tch_dim(axis_siz
-0000e6c0: 652c 2079 5f62 6469 6d2c 2078 5f62 6469  e, y_bdim, x_bdi
-0000e6d0: 6d2c 2079 290a 2020 2020 7265 7475 726e  m, y).    return
-0000e6e0: 2042 6174 6368 6564 5661 6c75 6528 6f70   BatchedValue(op
-0000e6f0: 2878 2c20 7929 2c20 785f 6264 696d 290a  (x, y), x_bdim).
-0000e700: 0a0a 6465 6620 7369 6e5f 766d 6170 2861  ..def sin_vmap(a
-0000e710: 7869 735f 7369 7a65 3a20 696e 742c 2061  xis_size: int, a
-0000e720: 3a20 4261 7463 6865 6456 616c 7565 2920  : BatchedValue) 
-0000e730: 2d3e 2042 6174 6368 6564 5661 6c75 653a  -> BatchedValue:
-0000e740: 0a20 2020 2072 6574 7572 6e20 7665 6374  .    return vect
-0000e750: 6f72 697a 6564 5f62 6174 6368 6572 2870  orized_batcher(p
-0000e760: 7269 6d73 2e73 696e 2c20 6178 6973 5f73  rims.sin, axis_s
-0000e770: 697a 652c 2028 612c 2929 0a0a 0a64 6566  ize, (a,))...def
-0000e780: 2063 6f73 5f76 6d61 7028 6178 6973 5f73   cos_vmap(axis_s
-0000e790: 697a 653a 2069 6e74 2c20 613a 2042 6174  ize: int, a: Bat
-0000e7a0: 6368 6564 5661 6c75 6529 202d 3e20 4261  chedValue) -> Ba
-0000e7b0: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
-0000e7c0: 7265 7475 726e 2076 6563 746f 7269 7a65  return vectorize
-0000e7d0: 645f 6261 7463 6865 7228 7072 696d 732e  d_batcher(prims.
-0000e7e0: 636f 732c 2061 7869 735f 7369 7a65 2c20  cos, axis_size, 
-0000e7f0: 2861 2c29 290a 0a0a 6465 6620 6d75 6c5f  (a,))...def mul_
-0000e800: 766d 6170 2861 7869 735f 7369 7a65 3a20  vmap(axis_size: 
-0000e810: 696e 742c 2061 3a20 4261 7463 6865 6456  int, a: BatchedV
-0000e820: 616c 7565 2c20 623a 2042 6174 6368 6564  alue, b: Batched
-0000e830: 5661 6c75 6529 202d 3e20 4261 7463 6865  Value) -> Batche
-0000e840: 6456 616c 7565 3a0a 2020 2020 7265 7475  dValue:.    retu
-0000e850: 726e 2062 696e 6172 795f 6f70 5f62 6174  rn binary_op_bat
-0000e860: 6368 696e 675f 7275 6c65 2870 7269 6d73  ching_rule(prims
-0000e870: 2e6d 756c 2c20 6178 6973 5f73 697a 652c  .mul, axis_size,
-0000e880: 2028 612c 2062 2929 0a0a 0a64 6566 2061   (a, b))...def a
-0000e890: 6464 5f76 6d61 7028 6178 6973 5f73 697a  dd_vmap(axis_siz
-0000e8a0: 653a 2069 6e74 2c20 613a 2042 6174 6368  e: int, a: Batch
-0000e8b0: 6564 5661 6c75 652c 2062 3a20 4261 7463  edValue, b: Batc
-0000e8c0: 6865 6456 616c 7565 2920 2d3e 2042 6174  hedValue) -> Bat
-0000e8d0: 6368 6564 5661 6c75 653a 0a20 2020 2072  chedValue:.    r
-0000e8e0: 6574 7572 6e20 6269 6e61 7279 5f6f 705f  eturn binary_op_
-0000e8f0: 6261 7463 6869 6e67 5f72 756c 6528 7072  batching_rule(pr
-0000e900: 696d 732e 6164 642c 2061 7869 735f 7369  ims.add, axis_si
-0000e910: 7a65 2c20 2861 2c20 6229 290a 0a0a 6465  ze, (a, b))...de
-0000e920: 6620 7375 6d5f 766d 6170 2861 7869 735f  f sum_vmap(axis_
-0000e930: 7369 7a65 3a20 696e 742c 2061 3a20 4261  size: int, a: Ba
-0000e940: 7463 6865 6456 616c 7565 2c20 6469 6d73  tchedValue, dims
-0000e950: 3a20 5365 7175 656e 6365 5b69 6e74 5d2c  : Sequence[int],
-0000e960: 202a 2a6b 7761 7267 7329 202d 3e20 4261   **kwargs) -> Ba
-0000e970: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
-0000e980: 6264 696d 203d 2061 2e62 6174 6368 5f64  bdim = a.batch_d
-0000e990: 696d 0a20 2020 2023 2054 4f44 4f3a 2072  im.    # TODO: r
-0000e9a0: 656d 6f76 6520 7468 6973 2077 6865 6e20  emove this when 
-0000e9b0: 6469 6d73 2062 6563 6f6d 6573 2061 206d  dims becomes a m
-0000e9c0: 616e 6461 746f 7279 206b 7761 7267 0a20  andatory kwarg. 
-0000e9d0: 2020 2069 6620 6c65 6e28 6469 6d73 2920     if len(dims) 
-0000e9e0: 3e20 303a 0a20 2020 2020 2020 2064 696d  > 0:.        dim
-0000e9f0: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
-0000ea00: 2a64 696d 7329 0a20 2020 2064 696d 735f  *dims).    dims_
-0000ea10: 6265 666f 7265 203d 2074 7570 6c65 2865  before = tuple(e
-0000ea20: 6c20 666f 7220 656c 2069 6e20 6469 6d73  l for el in dims
-0000ea30: 2069 6620 656c 203c 2062 6469 6d29 0a20   if el < bdim). 
-0000ea40: 2020 2064 696d 735f 6166 7465 7220 3d20     dims_after = 
-0000ea50: 7475 706c 6528 656c 202b 2031 2066 6f72  tuple(el + 1 for
-0000ea60: 2065 6c20 696e 2064 696d 7320 6966 2065   el in dims if e
-0000ea70: 6c20 3e3d 2062 6469 6d29 0a20 2020 2062  l >= bdim).    b
-0000ea80: 6174 6368 6564 5f64 696d 7320 3d20 6469  atched_dims = di
-0000ea90: 6d73 5f62 6566 6f72 6520 2b20 6469 6d73  ms_before + dims
-0000eaa0: 5f61 6674 6572 0a20 2020 2072 6574 7572  _after.    retur
-0000eab0: 6e20 7665 6374 6f72 697a 6564 5f62 6174  n vectorized_bat
-0000eac0: 6368 6572 2870 7269 6d73 2e73 756d 2c20  cher(prims.sum, 
-0000ead0: 6178 6973 5f73 697a 652c 2028 612c 292c  axis_size, (a,),
-0000eae0: 2064 696d 733d 6261 7463 6865 645f 6469   dims=batched_di
-0000eaf0: 6d73 2c20 2a2a 6b77 6172 6773 290a 0a0a  ms, **kwargs)...
-0000eb00: 2320 544f 444f 3a20 506c 6561 7365 2074  # TODO: Please t
-0000eb10: 6573 7420 7468 6973 2065 7874 656e 7369  est this extensi
-0000eb20: 7665 6c79 0a64 6566 2062 726f 6164 6361  vely.def broadca
-0000eb30: 7374 5f69 6e5f 6469 6d5f 766d 6170 280a  st_in_dim_vmap(.
-0000eb40: 2020 2020 6178 6973 5f73 697a 653a 2069      axis_size: i
-0000eb50: 6e74 2c20 613a 2042 6174 6368 6564 5661  nt, a: BatchedVa
-0000eb60: 6c75 652c 2073 6861 7065 3a20 5365 7175  lue, shape: Sequ
-0000eb70: 656e 6365 5b42 6174 6368 6564 5661 6c75  ence[BatchedValu
-0000eb80: 655d 2c20 6272 6f61 6463 6173 745f 6469  e], broadcast_di
-0000eb90: 6d65 6e73 696f 6e73 3a20 5365 7175 656e  mensions: Sequen
-0000eba0: 6365 5b42 6174 6368 6564 5661 6c75 655d  ce[BatchedValue]
-0000ebb0: 0a29 202d 3e20 4261 7463 6865 6456 616c  .) -> BatchedVal
-0000ebc0: 7565 3a0a 2020 2020 6264 696d 203d 2061  ue:.    bdim = a
-0000ebd0: 2e62 6174 6368 5f64 696d 0a20 2020 2023  .batch_dim.    #
-0000ebe0: 2054 4f44 4f3a 2072 656d 6f76 6520 7468   TODO: remove th
-0000ebf0: 6973 2077 6865 6e20 7368 6170 6520 616e  is when shape an
-0000ec00: 6420 6272 6f61 6463 6173 745f 6469 6d65  d broadcast_dime
-0000ec10: 6e73 696f 6e73 2062 6563 6f6d 6520 6d61  nsions become ma
-0000ec20: 6e64 6174 6f72 7920 6b77 6172 6773 0a20  ndatory kwargs. 
-0000ec30: 2020 2073 6861 7065 2c20 5f20 3d20 7361     shape, _ = sa
-0000ec40: 6665 5f7a 6970 282a 7368 6170 6529 0a20  fe_zip(*shape). 
-0000ec50: 2020 2069 6620 6c65 6e28 6272 6f61 6463     if len(broadc
-0000ec60: 6173 745f 6469 6d65 6e73 696f 6e73 2920  ast_dimensions) 
-0000ec70: 3e20 303a 0a20 2020 2020 2020 2062 726f  > 0:.        bro
-0000ec80: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-0000ec90: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
-0000eca0: 2a62 726f 6164 6361 7374 5f64 696d 656e  *broadcast_dimen
-0000ecb0: 7369 6f6e 7329 0a20 2020 2069 6620 6264  sions).    if bd
-0000ecc0: 696d 2069 7320 6e6f 745f 6d61 7070 6564  im is not_mapped
-0000ecd0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000ece0: 2042 6174 6368 6564 5661 6c75 6528 7072   BatchedValue(pr
-0000ecf0: 696d 732e 6272 6f61 6463 6173 745f 696e  ims.broadcast_in
-0000ed00: 5f64 696d 2861 2e76 616c 7565 2c20 7368  _dim(a.value, sh
-0000ed10: 6170 652c 2062 726f 6164 6361 7374 5f64  ape, broadcast_d
-0000ed20: 696d 656e 7369 6f6e 7329 2c20 6264 696d  imensions), bdim
-0000ed30: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-0000ed40: 2020 2020 6e65 775f 6264 696d 203d 2062      new_bdim = b
-0000ed50: 6469 6d20 2b20 7375 6d28 3120 666f 7220  dim + sum(1 for 
-0000ed60: 6469 6d20 696e 2062 726f 6164 6361 7374  dim in broadcast
-0000ed70: 5f64 696d 656e 7369 6f6e 7320 6966 2064  _dimensions if d
-0000ed80: 696d 203c 2062 6469 6d29 0a20 2020 2020  im < bdim).     
-0000ed90: 2020 206e 6577 5f73 6861 7065 203d 206c     new_shape = l
-0000eda0: 6973 7428 7368 6170 6529 0a20 2020 2020  ist(shape).     
-0000edb0: 2020 206e 6577 5f73 6861 7065 2e69 6e73     new_shape.ins
-0000edc0: 6572 7428 6e65 775f 6264 696d 2c20 6178  ert(new_bdim, ax
-0000edd0: 6973 5f73 697a 6529 0a20 2020 2020 2020  is_size).       
-0000ede0: 206e 6577 5f62 726f 6164 6361 7374 5f64   new_broadcast_d
-0000edf0: 696d 656e 7369 6f6e 7320 3d20 2830 2c29  imensions = (0,)
-0000ee00: 202b 2074 7570 6c65 2864 696d 202b 2031   + tuple(dim + 1
-0000ee10: 2069 6620 6469 6d20 3e3d 2062 6469 6d20   if dim >= bdim 
-0000ee20: 656c 7365 2064 696d 2066 6f72 2064 696d  else dim for dim
-0000ee30: 2069 6e20 6272 6f61 6463 6173 745f 6469   in broadcast_di
-0000ee40: 6d65 6e73 696f 6e73 290a 2020 2020 2020  mensions).      
-0000ee50: 2020 6966 2062 726f 6164 6361 7374 5f64    if broadcast_d
-0000ee60: 696d 656e 7369 6f6e 7320 3d3d 2028 293a  imensions == ():
-0000ee70: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
-0000ee80: 5f62 726f 6164 6361 7374 5f64 696d 656e  _broadcast_dimen
-0000ee90: 7369 6f6e 7320 3d20 2829 0a20 2020 2020  sions = ().     
-0000eea0: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
-0000eeb0: 6456 616c 7565 2870 7269 6d73 2e62 726f  dValue(prims.bro
-0000eec0: 6164 6361 7374 5f69 6e5f 6469 6d28 612e  adcast_in_dim(a.
-0000eed0: 7661 6c75 652c 206e 6577 5f73 6861 7065  value, new_shape
-0000eee0: 2c20 6e65 775f 6272 6f61 6463 6173 745f  , new_broadcast_
-0000eef0: 6469 6d65 6e73 696f 6e73 292c 206e 6577  dimensions), new
-0000ef00: 5f62 6469 6d29 0a0a 0a76 6d61 705f 696d  _bdim)...vmap_im
-0000ef10: 706c 733a 2064 6963 745b 7072 696d 732e  pls: dict[prims.
-0000ef20: 5379 6d62 6f6c 2c20 4361 6c6c 6162 6c65  Symbol, Callable
-0000ef30: 5d20 3d20 6469 6374 2829 0a0a 0a64 6566  ] = dict()...def
-0000ef40: 2075 6e77 7261 705f 6f6e 655f 6c65 7665   unwrap_one_leve
-0000ef50: 6c5f 6f66 5f73 7562 7379 6d62 6f6c 7328  l_of_subsymbols(
-0000ef60: 7472 6163 6529 3a0a 2020 2020 6e65 775f  trace):.    new_
-0000ef70: 7379 6d62 6f6c 735f 6974 6572 203d 2028  symbols_iter = (
-0000ef80: 0a20 2020 2020 2020 2062 6f75 6e64 5f73  .        bound_s
-0000ef90: 796d 626f 6c2e 7375 6273 796d 626f 6c73  ymbol.subsymbols
-0000efa0: 2069 6620 6c65 6e28 626f 756e 645f 7379   if len(bound_sy
-0000efb0: 6d62 6f6c 2e73 7562 7379 6d62 6f6c 7329  mbol.subsymbols)
-0000efc0: 203e 2030 2065 6c73 6520 5b62 6f75 6e64   > 0 else [bound
-0000efd0: 5f73 796d 626f 6c5d 0a20 2020 2020 2020  _symbol].       
-0000efe0: 2066 6f72 2062 6f75 6e64 5f73 796d 626f   for bound_symbo
-0000eff0: 6c20 696e 2074 7261 6365 2e62 6f75 6e64  l in trace.bound
-0000f000: 5f73 796d 626f 6c73 0a20 2020 2029 0a20  _symbols.    ). 
-0000f010: 2020 206e 6577 5f73 796d 626f 6c73 203d     new_symbols =
-0000f020: 206c 6973 7428 6368 6169 6e2e 6672 6f6d   list(chain.from
-0000f030: 5f69 7465 7261 626c 6528 6e65 775f 7379  _iterable(new_sy
-0000f040: 6d62 6f6c 735f 6974 6572 2929 0a20 2020  mbols_iter)).   
-0000f050: 2074 7261 6365 2e62 6f75 6e64 5f73 796d   trace.bound_sym
-0000f060: 626f 6c73 203d 206e 6577 5f73 796d 626f  bols = new_symbo
-0000f070: 6c73 0a20 2020 2072 6574 7572 6e20 7472  ls.    return tr
-0000f080: 6163 650a 0a0a 6465 6620 6465 636f 6d70  ace...def decomp
-0000f090: 6f73 6564 5f66 6e5f 766d 6170 5f72 756c  osed_fn_vmap_rul
-0000f0a0: 6528 6178 6973 5f73 697a 652c 202a 6172  e(axis_size, *ar
-0000f0b0: 6773 2c20 666e 2c20 2a2a 6b77 6172 6773  gs, fn, **kwargs
-0000f0c0: 293a 0a20 2020 2061 7267 732c 2069 6e5f  ):.    args, in_
-0000f0d0: 6469 6d73 203d 2075 6e7a 6970 3228 6172  dims = unzip2(ar
-0000f0e0: 6773 290a 2020 2020 756e 6261 7463 6865  gs).    unbatche
-0000f0f0: 645f 6172 6773 203d 2074 7265 655f 6d61  d_args = tree_ma
-0000f100: 7028 6c61 6d62 6461 2078 3a20 7265 6d6f  p(lambda x: remo
-0000f110: 7665 5f62 6174 6368 5f64 696d 2878 2920  ve_batch_dim(x) 
-0000f120: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-0000f130: 2054 656e 736f 7250 726f 7879 2920 656c   TensorProxy) el
-0000f140: 7365 2078 2c20 6172 6773 290a 2020 2020  se x, args).    
-0000f150: 7472 6163 6520 3d20 636f 6e73 7472 7563  trace = construc
-0000f160: 745f 7472 6163 6528 2928 666e 2c20 2a75  t_trace()(fn, *u
-0000f170: 6e62 6174 6368 6564 5f61 7267 732c 202a  nbatched_args, *
-0000f180: 2a6b 7761 7267 7329 0a20 2020 2074 7261  *kwargs).    tra
-0000f190: 6365 203d 2075 6e77 7261 705f 6f6e 655f  ce = unwrap_one_
-0000f1a0: 6c65 7665 6c5f 6f66 5f73 7562 7379 6d62  level_of_subsymb
-0000f1b0: 6f6c 7328 7472 6163 6529 0a20 2020 206f  ols(trace).    o
-0000f1c0: 7574 7320 3d20 5f76 6d61 705f 6361 6c6c  uts = _vmap_call
-0000f1d0: 5f6d 6574 6166 756e 6328 4661 6c73 652c  _metafunc(False,
-0000f1e0: 2061 7267 732c 2069 6e5f 6469 6d73 2c20   args, in_dims, 
-0000f1f0: 302c 2061 7869 735f 7369 7a65 2c20 6675  0, axis_size, fu
-0000f200: 6e63 7469 6f6e 5f74 7261 6365 3d74 7261  nction_trace=tra
-0000f210: 6365 2c20 2a2a 6b77 6172 6773 290a 2020  ce, **kwargs).  
-0000f220: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0000f230: 6f75 7473 2c20 5365 7175 656e 6365 293a  outs, Sequence):
-0000f240: 0a20 2020 2020 2020 206f 7574 5f64 696d  .        out_dim
-0000f250: 7320 3d20 2830 2c29 202a 206c 656e 286f  s = (0,) * len(o
-0000f260: 7574 7329 0a20 2020 2020 2020 2072 6574  uts).        ret
-0000f270: 7572 6e20 7361 6665 5f6d 6170 2870 6169  urn safe_map(pai
-0000f280: 725f 746f 5f62 6174 6368 6564 5f76 616c  r_to_batched_val
-0000f290: 7565 2c20 7361 6665 5f7a 6970 286f 7574  ue, safe_zip(out
-0000f2a0: 732c 206f 7574 5f64 696d 7329 290a 2020  s, out_dims)).  
-0000f2b0: 2020 7265 7475 726e 2042 6174 6368 6564    return Batched
-0000f2c0: 5661 6c75 6528 6f75 7473 2c20 3029 0a0a  Value(outs, 0)..
-0000f2d0: 0a76 6d61 705f 696d 706c 735b 7072 696d  .vmap_impls[prim
-0000f2e0: 732e 5072 696d 4944 732e 5349 4e5d 203d  s.PrimIDs.SIN] =
-0000f2f0: 2073 696e 5f76 6d61 700a 766d 6170 5f69   sin_vmap.vmap_i
-0000f300: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
-0000f310: 4473 2e43 4f53 5d20 3d20 636f 735f 766d  Ds.COS] = cos_vm
-0000f320: 6170 0a76 6d61 705f 696d 706c 735b 7072  ap.vmap_impls[pr
-0000f330: 696d 732e 5072 696d 4944 732e 4d55 4c5d  ims.PrimIDs.MUL]
-0000f340: 203d 206d 756c 5f76 6d61 700a 766d 6170   = mul_vmap.vmap
-0000f350: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
-0000f360: 6d49 4473 2e41 4444 5d20 3d20 6164 645f  mIDs.ADD] = add_
-0000f370: 766d 6170 0a76 6d61 705f 696d 706c 735b  vmap.vmap_impls[
-0000f380: 7072 696d 732e 5072 696d 4944 732e 5355  prims.PrimIDs.SU
-0000f390: 4d5d 203d 2073 756d 5f76 6d61 700a 766d  M] = sum_vmap.vm
-0000f3a0: 6170 5f69 6d70 6c73 5b70 7269 6d73 2e50  ap_impls[prims.P
-0000f3b0: 7269 6d49 4473 2e42 524f 4144 4341 5354  rimIDs.BROADCAST
-0000f3c0: 5f49 4e5f 4449 4d5d 203d 2062 726f 6164  _IN_DIM] = broad
-0000f3d0: 6361 7374 5f69 6e5f 6469 6d5f 766d 6170  cast_in_dim_vmap
-0000f3e0: 0a0a 0a64 6566 2076 6d61 705f 7379 6d62  ...def vmap_symb
-0000f3f0: 6f6c 5f6d 6170 7065 7228 7379 6d62 6f6c  ol_mapper(symbol
-0000f400: 3a20 7072 696d 732e 5379 6d62 6f6c 2c20  : prims.Symbol, 
-0000f410: 2a2c 2061 7869 735f 7369 7a65 3a20 696e  *, axis_size: in
-0000f420: 7429 3a0a 2020 2020 2222 224d 6170 7320  t):.    """Maps 
-0000f430: 6120 7379 6d62 6f6c 2074 6f20 6120 766d  a symbol to a vm
-0000f440: 6170 2066 756e 6374 696f 6e20 7468 6174  ap function that
-0000f450: 2065 7661 6c75 6174 6573 2069 742e 0a0a   evaluates it...
-0000f460: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-0000f470: 2020 7379 6d62 6f6c 2028 7072 696d 732e    symbol (prims.
-0000f480: 5379 6d62 6f6c 293a 2053 796d 626f 6c20  Symbol): Symbol 
-0000f490: 746f 2065 7661 6c75 6174 652e 0a0a 2020  to evaluate...  
-0000f4a0: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
-0000f4b0: 2020 4e6f 7449 6d70 6c65 6d65 6e74 6564    NotImplemented
-0000f4c0: 4572 726f 723a 2049 6620 7468 6520 766d  Error: If the vm
-0000f4d0: 6170 2066 6f72 2074 6865 2073 796d 626f  ap for the symbo
-0000f4e0: 6c20 6973 206e 6f74 2069 6d70 6c65 6d65  l is not impleme
-0000f4f0: 6e74 6564 2e0a 0a20 2020 2052 6574 7572  nted...    Retur
-0000f500: 6e73 3a0a 2020 2020 2020 2020 4361 6c6c  ns:.        Call
-0000f510: 6162 6c65 3a20 766d 6170 2066 756e 6374  able: vmap funct
-0000f520: 696f 6e20 7468 6174 2065 7661 6c75 6174  ion that evaluat
-0000f530: 6573 2074 6865 2073 796d 626f 6c2e 0a20  es the symbol.. 
-0000f540: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-0000f550: 7772 6170 5f61 7267 2878 293a 0a20 2020  wrap_arg(x):.   
-0000f560: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0000f570: 6365 2878 2c20 4261 7463 6865 6456 616c  ce(x, BatchedVal
-0000f580: 7565 293a 0a20 2020 2020 2020 2020 2020  ue):.           
-0000f590: 2072 6574 7572 6e20 780a 2020 2020 2020   return x.      
-0000f5a0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-0000f5b0: 6528 782c 204e 756d 6265 7229 3a0a 2020  e(x, Number):.  
-0000f5c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000f5d0: 2042 6174 6368 6564 5661 6c75 6528 782c   BatchedValue(x,
-0000f5e0: 206e 6f74 5f6d 6170 7065 6429 0a20 2020   not_mapped).   
-0000f5f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000f600: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0000f610: 7565 4572 726f 7228 6622 766d 6170 2077  ueError(f"vmap w
-0000f620: 7261 705f 6172 6720 676f 7420 616e 2075  rap_arg got an u
-0000f630: 6e73 7570 706f 7274 6564 2074 7970 6520  nsupported type 
-0000f640: 7b74 7970 6528 7829 7d22 290a 0a20 2020  {type(x)}")..   
-0000f650: 2069 6620 7379 6d62 6f6c 2e61 7265 5f61   if symbol.are_a
-0000f660: 6c6c 5f61 7267 735f 636f 6e73 7461 6e74  ll_args_constant
-0000f670: 3a0a 0a20 2020 2020 2020 2064 6566 205f  :..        def _
-0000f680: 766d 6170 5f69 6d70 6c5f 636f 6e73 7428  vmap_impl_const(
-0000f690: 7379 6d62 6f6c 2c20 2a61 7267 732c 202a  symbol, *args, *
-0000f6a0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-0000f6b0: 2020 2020 2020 6f75 7420 3d20 7379 6d62        out = symb
-0000f6c0: 6f6c 5f74 6f5f 6576 616c 2873 796d 626f  ol_to_eval(symbo
-0000f6d0: 6c29 282a 6172 6773 2c20 2a2a 6b77 6172  l)(*args, **kwar
-0000f6e0: 6773 290a 0a20 2020 2020 2020 2020 2020  gs)..           
-0000f6f0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
-0000f700: 7574 2c20 5365 7175 656e 6365 293a 0a20  ut, Sequence):. 
-0000f710: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000f720: 6574 7572 6e20 7361 6665 5f6d 6170 2870  eturn safe_map(p
-0000f730: 6169 725f 746f 5f62 6174 6368 6564 5f76  air_to_batched_v
-0000f740: 616c 7565 2c20 7361 6665 5f7a 6970 2861  alue, safe_zip(a
-0000f750: 7267 732c 205b 6e6f 745f 6d61 7070 6564  rgs, [not_mapped
-0000f760: 5d20 2a20 6c65 6e28 6f75 7429 2929 0a0a  ] * len(out)))..
-0000f770: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000f780: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
-0000f790: 6f75 742c 206e 6f74 5f6d 6170 7065 6429  out, not_mapped)
-0000f7a0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0000f7b0: 2070 6172 7469 616c 285f 766d 6170 5f69   partial(_vmap_i
-0000f7c0: 6d70 6c5f 636f 6e73 742c 2073 796d 626f  mpl_const, symbo
-0000f7d0: 6c29 0a0a 2020 2020 766d 6170 5f69 6d70  l)..    vmap_imp
-0000f7e0: 6c20 3d20 766d 6170 5f69 6d70 6c73 2e67  l = vmap_impls.g
-0000f7f0: 6574 2873 796d 626f 6c2e 7379 6d2e 6964  et(symbol.sym.id
-0000f800: 290a 2020 2020 6966 2076 6d61 705f 696d  ).    if vmap_im
-0000f810: 706c 2069 7320 4e6f 6e65 3a0a 2020 2020  pl is None:.    
-0000f820: 2020 2020 6966 206c 656e 2873 796d 626f      if len(symbo
-0000f830: 6c2e 7375 6273 796d 626f 6c73 2920 3e20  l.subsymbols) > 
-0000f840: 303a 0a20 2020 2020 2020 2020 2020 2076  0:.            v
-0000f850: 6d61 705f 696d 706c 203d 2070 6172 7469  map_impl = parti
-0000f860: 616c 2864 6563 6f6d 706f 7365 645f 666e  al(decomposed_fn
-0000f870: 5f76 6d61 705f 7275 6c65 2c20 666e 3d73  _vmap_rule, fn=s
-0000f880: 796d 626f 6c2e 7379 6d29 0a20 2020 2020  ymbol.sym).     
-0000f890: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000f8a0: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
-0000f8b0: 706c 656d 656e 7465 6445 7272 6f72 2866  plementedError(f
-0000f8c0: 2276 6d61 7020 666f 7220 7b73 796d 626f  "vmap for {symbo
-0000f8d0: 6c2e 7379 6d2e 6964 7d20 6973 206e 6f74  l.sym.id} is not
-0000f8e0: 2069 6d70 6c65 6d65 6e74 6564 2229 0a0a   implemented")..
-0000f8f0: 2020 2020 6465 6620 5f76 6d61 705f 696d      def _vmap_im
-0000f900: 706c 282a 6172 6773 2c20 2a2a 6b77 6172  pl(*args, **kwar
-0000f910: 6773 293a 0a20 2020 2020 2020 2061 7267  gs):.        arg
-0000f920: 7320 3d20 7472 6565 5f6d 6170 2877 7261  s = tree_map(wra
-0000f930: 705f 6172 672c 2061 7267 7329 0a20 2020  p_arg, args).   
-0000f940: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
-0000f950: 6973 696e 7374 616e 6365 2861 7267 2c20  isinstance(arg, 
-0000f960: 4261 7463 6865 6456 616c 7565 2920 666f  BatchedValue) fo
-0000f970: 7220 6172 6720 696e 2074 7265 655f 666c  r arg in tree_fl
-0000f980: 6174 7465 6e28 6172 6773 295b 305d 290a  atten(args)[0]).
-0000f990: 2020 2020 2020 2020 7265 7475 726e 2076          return v
-0000f9a0: 6d61 705f 696d 706c 2861 7869 735f 7369  map_impl(axis_si
-0000f9b0: 7a65 2c20 2a61 7267 732c 202a 2a6b 7761  ze, *args, **kwa
-0000f9c0: 7267 7329 0a0a 2020 2020 7265 7475 726e  rgs)..    return
-0000f9d0: 205f 766d 6170 5f69 6d70 6c0a 0a0a 6465   _vmap_impl...de
-0000f9e0: 6620 7265 6d6f 7665 5f62 6174 6368 5f64  f remove_batch_d
-0000f9f0: 696d 2874 656e 736f 723a 2054 656e 736f  im(tensor: Tenso
-0000fa00: 7250 726f 7879 2c20 6261 7463 685f 6469  rProxy, batch_di
-0000fa10: 6d3a 2069 6e74 203d 2030 2920 2d3e 2054  m: int = 0) -> T
-0000fa20: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-0000fa30: 2222 2252 656d 6f76 6573 2074 6865 2062  """Removes the b
-0000fa40: 6174 6368 2064 696d 656e 7369 6f6e 2066  atch dimension f
-0000fa50: 726f 6d20 6120 7465 6e73 6f72 2e0a 0a20  rom a tensor... 
-0000fa60: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0000fa70: 2074 656e 736f 7220 2854 656e 736f 7250   tensor (TensorP
-0000fa80: 726f 7879 293a 2054 656e 736f 7220 746f  roxy): Tensor to
-0000fa90: 2072 656d 6f76 6520 7468 6520 6261 7463   remove the batc
-0000faa0: 6820 6469 6d65 6e73 696f 6e20 6672 6f6d  h dimension from
-0000fab0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0000fac0: 2020 2020 2020 2020 5465 6e73 6f72 5072          TensorPr
-0000fad0: 6f78 793a 2054 656e 736f 7220 7769 7468  oxy: Tensor with
-0000fae0: 2074 6865 2062 6174 6368 2064 696d 656e   the batch dimen
-0000faf0: 7369 6f6e 2072 656d 6f76 6564 2e0a 2020  sion removed..  
-0000fb00: 2020 2222 220a 2020 2020 6e65 775f 7368    """.    new_sh
-0000fb10: 6170 6520 3d20 7465 6e73 6f72 2e73 6861  ape = tensor.sha
-0000fb20: 7065 5b3a 6261 7463 685f 6469 6d5d 202b  pe[:batch_dim] +
-0000fb30: 2074 656e 736f 722e 7368 6170 655b 6261   tensor.shape[ba
-0000fb40: 7463 685f 6469 6d20 2b20 3120 3a5d 0a20  tch_dim + 1 :]. 
-0000fb50: 2020 2072 6574 7572 6e20 5465 6e73 6f72     return Tensor
-0000fb60: 5072 6f78 7928 6c69 6b65 3d74 656e 736f  Proxy(like=tenso
-0000fb70: 722c 2073 6861 7065 3d6e 6577 5f73 6861  r, shape=new_sha
-0000fb80: 7065 290a 0a0a 2320 544f 444f 3a20 696e  pe)...# TODO: in
-0000fb90: 204a 4158 2061 7267 732c 2069 6e5f 6469   JAX args, in_di
-0000fba0: 6d73 2061 7265 2066 6c61 7474 656e 6564  ms are flattened
-0000fbb0: 2074 6865 2073 616d 6520 7761 790a 2320   the same way.# 
-0000fbc0: 544f 444f 3a20 696e 204a 4158 206f 7574  TODO: in JAX out
-0000fbd0: 5f64 696d 7320 6172 6520 666c 6174 7465  _dims are flatte
-0000fbe0: 6e65 6420 6173 2077 656c 6c0a 6465 6620  ned as well.def 
-0000fbf0: 5f76 6d61 705f 6361 6c6c 5f6d 6574 6166  _vmap_call_metaf
-0000fc00: 756e 6328 6465 7461 6368 6564 3a20 626f  unc(detached: bo
-0000fc10: 6f6c 2c20 6172 6773 2c20 696e 5f64 696d  ol, args, in_dim
-0000fc20: 732c 206f 7574 5f64 696d 732c 2061 7869  s, out_dims, axi
-0000fc30: 735f 7369 7a65 2c20 6675 6e63 7469 6f6e  s_size, function
-0000fc40: 5f74 7261 6365 3a20 5472 6163 652c 202a  _trace: Trace, *
-0000fc50: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
-0000fc60: 224d 6574 6166 756e 6374 696f 6e20 666f  "Metafunction fo
-0000fc70: 7220 766d 6170 2063 616c 6c2e 0a0a 2020  r vmap call...  
-0000fc80: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0000fc90: 6465 7461 6368 6564 2028 626f 6f6c 293a  detached (bool):
-0000fca0: 2057 6865 7468 6572 2074 6f20 6465 7461   Whether to deta
-0000fcb0: 6368 2074 6865 2074 7261 6365 2e0a 2020  ch the trace..  
-0000fcc0: 2020 2020 2020 6172 6773 2028 5475 706c        args (Tupl
-0000fcd0: 655b 5072 6f78 795d 293a 2041 7267 756d  e[Proxy]): Argum
-0000fce0: 656e 7473 2074 6f20 7468 6520 6675 6e63  ents to the func
-0000fcf0: 7469 6f6e 2e0a 2020 2020 2020 2020 696e  tion..        in
-0000fd00: 5f64 696d 7320 2854 7570 6c65 5b69 6e74  _dims (Tuple[int
-0000fd10: 5d29 3a20 4261 7463 6820 6469 6d65 6e73  ]): Batch dimens
-0000fd20: 696f 6e20 666f 7220 6561 6368 2061 7267  ion for each arg
-0000fd30: 756d 656e 742e 0a20 2020 2020 2020 206f  ument..        o
-0000fd40: 7574 5f64 696d 7320 2854 7570 6c65 5b69  ut_dims (Tuple[i
-0000fd50: 6e74 5d29 3a20 4261 7463 6820 6469 6d65  nt]): Batch dime
-0000fd60: 6e73 696f 6e20 666f 7220 7265 7475 726e  nsion for return
-0000fd70: 2076 616c 7565 732e 0a20 2020 2020 2020   values..       
-0000fd80: 2066 756e 6374 696f 6e5f 7472 6163 6520   function_trace 
-0000fd90: 2854 7261 6365 293a 2054 7261 6365 2074  (Trace): Trace t
-0000fda0: 6f20 7573 6520 666f 7220 7468 6520 6675  o use for the fu
-0000fdb0: 6e63 7469 6f6e 2e0a 2020 2020 2020 2020  nction..        
-0000fdc0: 6b77 6172 6773 3a20 4b65 7977 6f72 6420  kwargs: Keyword 
-0000fdd0: 6172 6775 6d65 6e74 732e 0a0a 2020 2020  arguments...    
-0000fde0: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
-0000fdf0: 4173 7365 7274 696f 6e45 7272 6f72 3a20  AssertionError: 
-0000fe00: 4966 2074 6865 2076 6d61 7020 666f 7220  If the vmap for 
-0000fe10: 6b65 7977 6f72 6420 6172 6775 6d65 6e74  keyword argument
-0000fe20: 7320 6973 206e 6f74 2069 6d70 6c65 6d65  s is not impleme
-0000fe30: 6e74 6564 2e0a 0a20 2020 2052 6574 7572  nted...    Retur
-0000fe40: 6e73 3a0a 2020 2020 2020 2020 5265 7375  ns:.        Resu
-0000fe50: 6c74 206f 6620 7468 6520 766d 6170 2074  lt of the vmap t
-0000fe60: 7261 6e73 666f 726d 2e0a 2020 2020 2222  ransform..    ""
-0000fe70: 220a 2020 2020 636f 6d6d 6f6e 5f64 6576  ".    common_dev
-0000fe80: 6963 6520 3d20 7b78 2e64 6576 6963 6520  ice = {x.device 
-0000fe90: 666f 7220 7820 696e 2061 7267 7320 6966  for x in args if
-0000fea0: 2069 7369 6e73 7461 6e63 6528 782c 2054   isinstance(x, T
-0000feb0: 656e 736f 7250 726f 7879 297d 0a20 2020  ensorProxy)}.   
-0000fec0: 2061 7373 6572 7420 6c65 6e28 636f 6d6d   assert len(comm
-0000fed0: 6f6e 5f64 6576 6963 6529 203c 3d20 312c  on_device) <= 1,
-0000fee0: 2022 766d 6170 2066 6f72 206d 756c 7469   "vmap for multi
-0000fef0: 706c 6520 6465 7669 6365 7320 6973 206e  ple devices is n
-0000ff00: 6f74 2069 6d70 6c65 6d65 6e74 6564 220a  ot implemented".
-0000ff10: 2020 2020 2863 6f6d 6d6f 6e5f 6465 7669      (common_devi
-0000ff20: 6365 2c29 203d 2063 6f6d 6d6f 6e5f 6465  ce,) = common_de
-0000ff30: 7669 6365 2069 6620 6c65 6e28 636f 6d6d  vice if len(comm
-0000ff40: 6f6e 5f64 6576 6963 6529 203d 3d20 3120  on_device) == 1 
-0000ff50: 656c 7365 2028 6370 752c 290a 0a20 2020  else (cpu,)..   
-0000ff60: 2069 6620 6178 6973 5f73 697a 6520 6973   if axis_size is
-0000ff70: 204e 6f6e 653a 0a20 2020 2020 2020 2028   None:.        (
-0000ff80: 6178 6973 5f73 697a 652c 2920 3d20 7b78  axis_size,) = {x
-0000ff90: 2e73 6861 7065 5b61 785d 2066 6f72 2078  .shape[ax] for x
-0000ffa0: 2c20 6178 2069 6e20 7a69 7028 6172 6773  , ax in zip(args
-0000ffb0: 2c20 696e 5f64 696d 7329 2069 6620 6178  , in_dims) if ax
-0000ffc0: 2069 7320 6e6f 7420 6e6f 745f 6d61 7070   is not not_mapp
-0000ffd0: 6564 7d0a 2020 2020 696e 5f64 696d 7320  ed}.    in_dims 
-0000ffe0: 3d20 696e 5f64 696d 7320 6966 2069 7369  = in_dims if isi
-0000fff0: 6e73 7461 6e63 6528 696e 5f64 696d 732c  nstance(in_dims,
-00010000: 2053 6571 7565 6e63 6529 2065 6c73 6520   Sequence) else 
-00010010: 2869 6e5f 6469 6d73 2c29 0a20 2020 2069  (in_dims,).    i
-00010020: 6e5f 6469 6d73 203d 2074 7570 6c65 286e  n_dims = tuple(n
-00010030: 6f74 5f6d 6170 7065 6420 6966 2069 7369  ot_mapped if isi
-00010040: 6e73 7461 6e63 6528 612c 204e 756d 6265  nstance(a, Numbe
-00010050: 7229 2065 6c73 6520 6420 666f 7220 612c  r) else d for a,
-00010060: 2064 2069 6e20 7361 6665 5f7a 6970 2861   d in safe_zip(a
-00010070: 7267 732c 2069 6e5f 6469 6d73 2929 0a20  rgs, in_dims)). 
-00010080: 2020 206f 7574 5f64 696d 7320 3d20 6f75     out_dims = ou
-00010090: 745f 6469 6d73 2069 6620 6973 696e 7374  t_dims if isinst
-000100a0: 616e 6365 286f 7574 5f64 696d 732c 2053  ance(out_dims, S
-000100b0: 6571 7565 6e63 6529 2065 6c73 6520 286f  equence) else (o
-000100c0: 7574 5f64 696d 732c 290a 0a20 2020 2063  ut_dims,)..    c
-000100d0: 7478 203d 2064 6574 6163 6865 645f 7472  tx = detached_tr
-000100e0: 6163 6528 2920 6966 2064 6574 6163 6865  ace() if detache
-000100f0: 6420 656c 7365 206e 756c 6c63 6f6e 7465  d else nullconte
-00010100: 7874 2829 0a20 2020 2077 6974 6820 6374  xt().    with ct
-00010110: 783a 0a20 2020 2020 2020 2023 2057 6520  x:.        # We 
-00010120: 7072 6f70 6167 6174 6520 7468 6520 4261  propagate the Ba
-00010130: 7463 6856 616c 7565 2074 6872 6f75 6768  tchValue through
-00010140: 2074 6865 2074 7261 6365 2c20 616e 6420   the trace, and 
-00010150: 7468 656e 2075 6e77 7261 7020 6974 2061  then unwrap it a
-00010160: 7420 7468 6520 656e 640a 2020 2020 2020  t the end.      
-00010170: 2020 6261 7463 6865 645f 6172 6773 203d    batched_args =
-00010180: 2073 6166 655f 6d61 7028 7061 6972 5f74   safe_map(pair_t
-00010190: 6f5f 6261 7463 6865 645f 7661 6c75 652c  o_batched_value,
-000101a0: 2073 6166 655f 7a69 7028 6172 6773 2c20   safe_zip(args, 
-000101b0: 696e 5f64 696d 7329 290a 2020 2020 2020  in_dims)).      
-000101c0: 2020 7265 7375 6c74 203d 2065 7661 6c5f    result = eval_
-000101d0: 7472 6163 6528 0a20 2020 2020 2020 2020  trace(.         
-000101e0: 2020 2066 756e 6374 696f 6e5f 7472 6163     function_trac
-000101f0: 652c 202a 6261 7463 6865 645f 6172 6773  e, *batched_args
-00010200: 2c20 7379 6d62 6f6c 5f6d 6170 7065 723d  , symbol_mapper=
-00010210: 7061 7274 6961 6c28 766d 6170 5f73 796d  partial(vmap_sym
-00010220: 626f 6c5f 6d61 7070 6572 2c20 6178 6973  bol_mapper, axis
-00010230: 5f73 697a 653d 6178 6973 5f73 697a 6529  _size=axis_size)
-00010240: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
-00010250: 2020 2029 0a20 2020 2020 2020 2023 2055     ).        # U
-00010260: 6e77 7261 7070 696e 6720 7468 6520 4261  nwrapping the Ba
-00010270: 7463 6865 6456 616c 7565 2773 0a20 2020  tchedValue's.   
-00010280: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00010290: 6365 2872 6573 756c 742c 2053 6571 7565  ce(result, Seque
-000102a0: 6e63 6529 3a0a 2020 2020 2020 2020 2020  nce):.          
-000102b0: 2020 666c 6174 5f72 6573 756c 742c 2073    flat_result, s
-000102c0: 7065 6320 3d20 7472 6565 5f66 6c61 7474  pec = tree_flatt
-000102d0: 656e 2872 6573 756c 7429 0a20 2020 2020  en(result).     
-000102e0: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
-000102f0: 6c28 6973 696e 7374 616e 6365 2878 2c20  l(isinstance(x, 
-00010300: 4261 7463 6865 6456 616c 7565 2920 666f  BatchedValue) fo
-00010310: 7220 7820 696e 2066 6c61 745f 7265 7375  r x in flat_resu
-00010320: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
-00010330: 6f75 7473 2c20 6264 696d 7320 3d20 756e  outs, bdims = un
-00010340: 7a69 7032 2866 6c61 745f 7265 7375 6c74  zip2(flat_result
-00010350: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00010360: 544f 444f 3a20 6861 6e64 6c65 2074 6865  TODO: handle the
-00010370: 2063 6173 6520 7768 6572 6520 6f75 745f   case where out_
-00010380: 6469 6d73 2069 7320 6120 7369 6e67 6c65  dims is a single
-00010390: 2076 616c 7565 2062 6574 7465 720a 2020   value better.  
-000103a0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-000103b0: 286f 7574 5f64 696d 7329 203d 3d20 313a  (out_dims) == 1:
-000103c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000103d0: 206f 7574 5f64 696d 7320 3d20 6f75 745f   out_dims = out_
-000103e0: 6469 6d73 202a 206c 656e 286f 7574 7329  dims * len(outs)
-000103f0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-00010400: 7320 3d20 7361 6665 5f6d 6170 2870 6172  s = safe_map(par
-00010410: 7469 616c 286d 6f76 655f 6261 7463 685f  tial(move_batch_
-00010420: 6469 6d2c 2061 7869 735f 7369 7a65 292c  dim, axis_size),
-00010430: 2062 6469 6d73 2c20 6f75 745f 6469 6d73   bdims, out_dims
-00010440: 2c20 6f75 7473 290a 2020 2020 2020 2020  , outs).        
-00010450: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
-00010460: 756e 666c 6174 7465 6e28 6f75 7473 2c20  unflatten(outs, 
-00010470: 7370 6563 290a 2020 2020 2020 2020 6966  spec).        if
-00010480: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-00010490: 6c74 2c20 4e75 6d62 6572 2920 616e 6420  lt, Number) and 
-000104a0: 6178 6973 5f73 697a 6520 6973 206e 6f74  axis_size is not
-000104b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000104c0: 2020 2023 2054 4f44 4f3a 2066 6574 6368     # TODO: fetch
-000104d0: 2074 6865 2064 6566 6175 6c74 2064 6576   the default dev
-000104e0: 6963 6520 6672 6f6d 2074 6865 2063 6f6e  ice from the con
-000104f0: 7465 7874 0a20 2020 2020 2020 2020 2020  text.           
-00010500: 2072 6573 756c 7420 3d20 6675 6c6c 2873   result = full(s
-00010510: 6861 7065 3d28 292c 2066 696c 6c5f 7661  hape=(), fill_va
-00010520: 6c75 653d 7265 7375 6c74 2c20 6465 7669  lue=result, devi
-00010530: 6365 3d63 6f6d 6d6f 6e5f 6465 7669 6365  ce=common_device
-00010540: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00010550: 7375 6c74 203d 2042 6174 6368 6564 5661  sult = BatchedVa
-00010560: 6c75 6528 7265 7375 6c74 2c20 6e6f 745f  lue(result, not_
-00010570: 6d61 7070 6564 290a 2020 2020 2020 2020  mapped).        
-00010580: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00010590: 7265 7375 6c74 2c20 4261 7463 6865 6456  result, BatchedV
-000105a0: 616c 7565 2920 616e 6420 6973 696e 7374  alue) and isinst
-000105b0: 616e 6365 2872 6573 756c 742e 7661 6c75  ance(result.valu
-000105c0: 652c 204e 756d 6265 7229 2061 6e64 2061  e, Number) and a
-000105d0: 7869 735f 7369 7a65 2069 7320 6e6f 7420  xis_size is not 
-000105e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000105f0: 2020 7265 7375 6c74 203d 2042 6174 6368    result = Batch
-00010600: 6564 5661 6c75 6528 6675 6c6c 2873 6861  edValue(full(sha
-00010610: 7065 3d28 292c 2066 696c 6c5f 7661 6c75  pe=(), fill_valu
-00010620: 653d 7265 7375 6c74 2e76 616c 7565 2c20  e=result.value, 
-00010630: 6465 7669 6365 3d63 6f6d 6d6f 6e5f 6465  device=common_de
-00010640: 7669 6365 292c 2072 6573 756c 742e 6261  vice), result.ba
-00010650: 7463 685f 6469 6d29 0a20 2020 2020 2020  tch_dim).       
-00010660: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00010670: 6365 2872 6573 756c 742c 2042 6174 6368  ce(result, Batch
-00010680: 6564 5661 6c75 6529 0a20 2020 2020 2020  edValue).       
-00010690: 206f 7574 203d 206d 6f76 655f 6261 7463   out = move_batc
-000106a0: 685f 6469 6d28 6178 6973 5f73 697a 652c  h_dim(axis_size,
-000106b0: 2072 6573 756c 742e 6261 7463 685f 6469   result.batch_di
-000106c0: 6d2c 206f 7574 5f64 696d 735b 305d 2c20  m, out_dims[0], 
-000106d0: 7265 7375 6c74 2e76 616c 7565 290a 2020  result.value).  
-000106e0: 2020 2020 2020 7265 7475 726e 206f 7574        return out
-000106f0: 0a0a 0a76 6d61 705f 6361 6c6c 203d 2053  ...vmap_call = S
-00010700: 796d 626f 6c28 6964 3d54 7261 6e73 666f  ymbol(id=Transfo
-00010710: 726d 732e 566d 6170 4f70 2c20 6e61 6d65  rms.VmapOp, name
-00010720: 3d22 766d 6170 5f63 616c 6c22 2c20 6d65  ="vmap_call", me
-00010730: 7461 3d70 6172 7469 616c 285f 766d 6170  ta=partial(_vmap
-00010740: 5f63 616c 6c5f 6d65 7461 6675 6e63 2c20  _call_metafunc, 
-00010750: 4661 6c73 6529 290a 0a0a 2320 544f 444f  False))...# TODO
-00010760: 3a20 686f 7720 7368 6f75 6c64 2077 6520  : how should we 
-00010770: 6861 6e64 6c65 206f 7574 5f64 696d 7320  handle out_dims 
-00010780: 6865 7265 3f0a 2320 616c 7468 6f75 6768  here?.# although
-00010790: 2068 6572 6520 7765 2061 7265 2063 616c   here we are cal
-000107a0: 6c69 6e67 2076 6d61 7020 6f66 2069 6465  ling vmap of ide
-000107b0: 6e74 6974 792c 2073 6f20 7765 2073 686f  ntity, so we sho
-000107c0: 756c 6420 6b6e 6f77 2066 726f 6d20 7468  uld know from th
-000107d0: 6520 6361 6c6c 2074 6f20 766d 6170 0a23  e call to vmap.#
-000107e0: 2054 6869 7320 7368 6f75 6c64 2062 6520   This should be 
-000107f0: 6669 6e65 2e20 4966 2077 6520 6861 7665  fine. If we have
-00010800: 2076 6d61 7028 6964 656e 7469 7479 2866   vmap(identity(f
-00010810: 756e 6329 2c20 6f75 745f 6469 6d73 3d4e  unc), out_dims=N
-00010820: 2920 7468 656e 2074 6869 7320 7275 6c65  ) then this rule
-00010830: 2069 7320 6669 7273 7420 7573 6564 0a23   is first used.#
-00010840: 2074 6f20 6765 7420 7468 6520 766d 6170   to get the vmap
-00010850: 7065 6420 7265 7375 6c74 206f 6620 6964  ped result of id
-00010860: 656e 7469 7479 2866 756e 6329 2069 6e20  entity(func) in 
-00010870: 766d 6170 5f73 796d 626f 6c5f 6d61 7070  vmap_symbol_mapp
-00010880: 6572 2c20 616e 6420 6f75 745f 6469 6d73  er, and out_dims
-00010890: 2069 7320 6861 6e64 6c65 640a 2320 6166   is handled.# af
-000108a0: 7465 7220 7468 6174 2069 6e20 7468 6520  ter that in the 
-000108b0: 6f75 7465 7220 5f76 6d61 705f 6361 6c6c  outer _vmap_call
-000108c0: 5f6d 6574 6166 756e 632e 0a64 6566 205f  _metafunc..def _
-000108d0: 6964 656e 7469 7479 5f63 616c 6c5f 766d  identity_call_vm
-000108e0: 6170 2861 7869 735f 7369 7a65 2c20 2a62  ap(axis_size, *b
-000108f0: 6174 6368 6564 5f61 7267 732c 2074 7261  atched_args, tra
-00010900: 6365 3a20 5472 6163 652c 202a 2a6b 7761  ce: Trace, **kwa
-00010910: 7267 7329 3a0a 2020 2020 6172 6773 2c20  rgs):.    args, 
-00010920: 696e 5f64 696d 7320 3d20 756e 7a69 7032  in_dims = unzip2
-00010930: 2862 6174 6368 6564 5f61 7267 7329 0a20  (batched_args). 
-00010940: 2020 206f 7574 5f64 696d 7320 3d20 3020     out_dims = 0 
-00010950: 2023 2046 6978 6d65 0a20 2020 206f 7574   # Fixme.    out
-00010960: 732c 206f 7574 5f64 696d 7320 3d20 5f76  s, out_dims = _v
-00010970: 6d61 705f 6361 6c6c 5f6d 6574 6166 756e  map_call_metafun
-00010980: 6328 4661 6c73 652c 2061 7267 732c 2069  c(False, args, i
-00010990: 6e5f 6469 6d73 2c20 6f75 745f 6469 6d73  n_dims, out_dims
-000109a0: 2c20 6178 6973 5f73 697a 652c 2066 756e  , axis_size, fun
-000109b0: 6374 696f 6e5f 7472 6163 653d 7472 6163  ction_trace=trac
-000109c0: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
-000109d0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
-000109e0: 7574 732c 2053 6571 7565 6e63 6529 3a0a  uts, Sequence):.
-000109f0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00010a00: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
-00010a10: 6261 7463 6865 645f 7661 6c75 652c 2073  batched_value, s
-00010a20: 6166 655f 7a69 7028 6f75 7473 2c20 6f75  afe_zip(outs, ou
-00010a30: 745f 6469 6d73 2929 0a20 2020 2072 6574  t_dims)).    ret
-00010a40: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
-00010a50: 286f 7574 732c 206f 7574 5f64 696d 7329  (outs, out_dims)
-00010a60: 0a0a 0a76 6d61 705f 696d 706c 735b 5472  ...vmap_impls[Tr
-00010a70: 616e 7366 6f72 6d73 2e49 6465 6e74 6974  ansforms.Identit
-00010a80: 794f 705d 203d 205f 6964 656e 7469 7479  yOp] = _identity
-00010a90: 5f63 616c 6c5f 766d 6170 0a0a 0a64 6566  _call_vmap...def
-00010aa0: 205f 6a76 705f 6361 6c6c 5f76 6d61 7028   _jvp_call_vmap(
-00010ab0: 6178 6973 5f73 697a 652c 2062 6174 6368  axis_size, batch
-00010ac0: 6564 5f70 7269 6d61 6c73 2c20 6261 7463  ed_primals, batc
-00010ad0: 6865 645f 7461 6e67 656e 7473 2c20 2a2c  hed_tangents, *,
-00010ae0: 2066 756e 6374 696f 6e5f 7472 6163 653a   function_trace:
-00010af0: 2054 7261 6365 2c20 2a2a 6b77 6172 6773   Trace, **kwargs
-00010b00: 293a 0a20 2020 2070 7269 6d61 6c73 2c20  ):.    primals, 
-00010b10: 7072 696d 616c 735f 6264 696d 7320 3d20  primals_bdims = 
-00010b20: 7361 6665 5f7a 6970 282a 6261 7463 6865  safe_zip(*batche
-00010b30: 645f 7072 696d 616c 7329 0a20 2020 2074  d_primals).    t
-00010b40: 616e 6765 6e74 732c 2074 616e 6765 6e74  angents, tangent
-00010b50: 735f 6264 696d 7320 3d20 7361 6665 5f7a  s_bdims = safe_z
-00010b60: 6970 282a 6261 7463 6865 645f 7461 6e67  ip(*batched_tang
-00010b70: 656e 7473 290a 2020 2020 6a76 705f 6675  ents).    jvp_fu
-00010b80: 6e63 203d 2070 6172 7469 616c 285f 6a76  nc = partial(_jv
-00010b90: 705f 6361 6c6c 5f6d 6574 6166 756e 632c  p_call_metafunc,
-00010ba0: 2046 616c 7365 2c20 6675 6e63 7469 6f6e   False, function
-00010bb0: 5f74 7261 6365 3d66 756e 6374 696f 6e5f  _trace=function_
-00010bc0: 7472 6163 6529 0a20 2020 2076 6d61 7070  trace).    vmapp
-00010bd0: 6564 5f6a 7670 5f66 756e 6320 3d20 766d  ed_jvp_func = vm
-00010be0: 6170 286a 7670 5f66 756e 632c 2069 6e5f  ap(jvp_func, in_
-00010bf0: 6469 6d73 3d28 7072 696d 616c 735f 6264  dims=(primals_bd
-00010c00: 696d 732c 2074 616e 6765 6e74 735f 6264  ims, tangents_bd
-00010c10: 696d 7329 2c20 6178 6973 5f73 697a 653d  ims), axis_size=
-00010c20: 6178 6973 5f73 697a 6529 0a20 2020 2072  axis_size).    r
-00010c30: 6573 756c 7420 3d20 766d 6170 7065 645f  esult = vmapped_
-00010c40: 6a76 705f 6675 6e63 2870 7269 6d61 6c73  jvp_func(primals
-00010c50: 2c20 7461 6e67 656e 7473 2c20 2a2a 6b77  , tangents, **kw
-00010c60: 6172 6773 290a 2020 2020 7265 7475 726e  args).    return
-00010c70: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-00010c80: 2078 3a20 4261 7463 6865 6456 616c 7565   x: BatchedValue
-00010c90: 2878 2c20 3029 2c20 7265 7375 6c74 290a  (x, 0), result).
-00010ca0: 0a0a 766d 6170 5f69 6d70 6c73 5b54 7261  ..vmap_impls[Tra
-00010cb0: 6e73 666f 726d 732e 4a76 704f 705d 203d  nsforms.JvpOp] =
-00010cc0: 205f 6a76 705f 6361 6c6c 5f76 6d61 700a   _jvp_call_vmap.
-00010cd0: 0a0a 6465 6620 766d 6170 2866 756e 632c  ..def vmap(func,
-00010ce0: 2069 6e5f 6469 6d73 3d30 2c20 6f75 745f   in_dims=0, out_
-00010cf0: 6469 6d73 3d30 2c20 6178 6973 5f73 697a  dims=0, axis_siz
-00010d00: 653d 4e6f 6e65 293a 0a20 2020 2022 2222  e=None):.    """
-00010d10: 5665 6374 6f72 697a 696e 6720 7472 616e  Vectorizing tran
-00010d20: 7366 6f72 6d20 666f 7220 6120 5468 756e  sform for a Thun
-00010d30: 6465 7220 6675 6e63 7469 6f6e 2e0a 0a20  der function... 
-00010d40: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00010d50: 2066 756e 6320 2843 616c 6c61 626c 6529   func (Callable)
-00010d60: 3a20 4120 5468 756e 6465 7220 6675 6e63  : A Thunder func
-00010d70: 7469 6f6e 2074 6f20 6265 2074 7261 6e73  tion to be trans
-00010d80: 666f 726d 6564 2e0a 0a20 2020 2052 6574  formed...    Ret
-00010d90: 7572 6e73 3a0a 2020 2020 2020 2020 4361  urns:.        Ca
-00010da0: 6c6c 6162 6c65 3a20 4120 766d 6170 7065  llable: A vmappe
-00010db0: 6420 7665 7273 696f 6e20 6f66 2074 6865  d version of the
-00010dc0: 2066 756e 6374 696f 6e2e 0a20 2020 2022   function..    "
-00010dd0: 2222 0a0a 2020 2020 2320 544f 444f 3a20  ""..    # TODO: 
-00010de0: 666c 6174 7465 6e0a 2020 2020 2320 496e  flatten.    # In
-00010df0: 204a 4158 2066 6c61 7474 656e 696e 6720   JAX flattening 
-00010e00: 6f66 2069 6e5f 6469 6d73 2069 7320 7261  of in_dims is ra
-00010e10: 7468 6572 2063 6f6d 706c 6963 6174 6564  ther complicated
-00010e20: 2062 6563 6175 7365 2069 7420 6361 6e20   because it can 
-00010e30: 6f70 7469 6f6e 616c 6c79 2062 650a 2020  optionally be.  
-00010e40: 2020 2320 7370 6563 6966 6965 6420 6173    # specified as
-00010e50: 2061 20e2 809c 7072 6566 6978 e280 9d20   a ...prefix... 
-00010e60: 7079 7472 6565 2c20 6d65 616e 696e 6720  pytree, meaning 
-00010e70: 7468 6174 2061 2073 696e 676c 6520 6c65  that a single le
-00010e80: 6166 2076 616c 7565 2063 616e 2062 6520  af value can be 
-00010e90: 6170 706c 6965 640a 2020 2020 2320 746f  applied.    # to
-00010ea0: 2061 6e20 656e 7469 7265 2073 7562 2d70   an entire sub-p
-00010eb0: 7974 7265 652e 0a0a 2020 2020 6465 6620  ytree...    def 
-00010ec0: 666c 6174 7465 6e5f 6675 6e63 5f66 6f72  flatten_func_for
-00010ed0: 5f76 6d61 7028 6675 6e63 2c20 6172 6773  _vmap(func, args
-00010ee0: 2c20 6b77 6172 6773 293a 0a20 2020 2020  , kwargs):.     
-00010ef0: 2020 2066 6c61 745f 6172 6773 2c20 7370     flat_args, sp
-00010f00: 6563 203d 2074 7265 655f 666c 6174 7465  ec = tree_flatte
-00010f10: 6e28 2861 7267 732c 206b 7761 7267 7329  n((args, kwargs)
-00010f20: 290a 0a20 2020 2020 2020 2064 6566 2066  )..        def f
-00010f30: 6c61 745f 6675 6e63 282a 666c 6174 5f61  lat_func(*flat_a
-00010f40: 7267 7329 3a0a 2020 2020 2020 2020 2020  rgs):.          
-00010f50: 2020 666e 5f61 7267 732c 2066 6e5f 6b77    fn_args, fn_kw
-00010f60: 6172 6773 203d 2074 7265 655f 756e 666c  args = tree_unfl
-00010f70: 6174 7465 6e28 666c 6174 5f61 7267 732c  atten(flat_args,
-00010f80: 2073 7065 6329 0a20 2020 2020 2020 2020   spec).         
-00010f90: 2020 2072 6574 7572 6e20 6675 6e63 282a     return func(*
-00010fa0: 666e 5f61 7267 732c 202a 2a66 6e5f 6b77  fn_args, **fn_kw
-00010fb0: 6172 6773 290a 0a20 2020 2020 2020 2072  args)..        r
-00010fc0: 6574 7572 6e20 666c 6174 5f66 756e 632c  eturn flat_func,
-00010fd0: 2066 6c61 745f 6172 6773 2c20 7370 6563   flat_args, spec
-00010fe0: 0a0a 2020 2020 6465 6620 7772 6170 7065  ..    def wrappe
-00010ff0: 7228 2a61 7267 732c 202a 2a6b 7761 7267  r(*args, **kwarg
-00011000: 7329 3a0a 2020 2020 2020 2020 6675 6e63  s):.        func
-00011010: 5f66 6c61 742c 2061 7267 735f 666c 6174  _flat, args_flat
-00011020: 2c20 6172 6773 5f73 7065 6320 3d20 666c  , args_spec = fl
-00011030: 6174 7465 6e5f 6675 6e63 5f66 6f72 5f76  atten_func_for_v
-00011040: 6d61 7028 6675 6e63 2c20 6172 6773 2c20  map(func, args, 
-00011050: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-00011060: 6966 2069 7369 6e73 7461 6e63 6528 696e  if isinstance(in
-00011070: 5f64 696d 732c 2069 6e74 293a 0a20 2020  _dims, int):.   
-00011080: 2020 2020 2020 2020 2069 6e5f 6469 6d73           in_dims
-00011090: 5f66 6c61 7420 3d20 2869 6e5f 6469 6d73  _flat = (in_dims
-000110a0: 2c29 202a 206c 656e 2861 7267 735f 666c  ,) * len(args_fl
-000110b0: 6174 290a 2020 2020 2020 2020 656c 7365  at).        else
-000110c0: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
-000110d0: 5f64 696d 735f 666c 6174 2c20 696e 5f64  _dims_flat, in_d
-000110e0: 696d 735f 7370 6563 203d 2074 7265 655f  ims_spec = tree_
-000110f0: 666c 6174 7465 6e28 696e 5f64 696d 7329  flatten(in_dims)
-00011100: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00011110: 6572 7420 6c65 6e28 696e 5f64 696d 735f  ert len(in_dims_
-00011120: 666c 6174 2920 3d3d 206c 656e 2861 7267  flat) == len(arg
-00011130: 735f 666c 6174 292c 2022 696e 5f64 696d  s_flat), "in_dim
-00011140: 7320 6d75 7374 2068 6176 6520 7468 6520  s must have the 
-00011150: 7361 6d65 206c 656e 6774 6820 6173 2061  same length as a
-00011160: 7267 732c 206b 7761 7267 7322 0a20 2020  rgs, kwargs".   
-00011170: 2020 2020 2075 6e62 6174 6368 6564 5f61       unbatched_a
-00011180: 7267 735f 666c 6174 203d 205b 7265 6d6f  rgs_flat = [remo
-00011190: 7665 5f62 6174 6368 5f64 696d 2861 7267  ve_batch_dim(arg
-000111a0: 2920 6966 2069 7369 6e73 7461 6e63 6528  ) if isinstance(
-000111b0: 6172 672c 2054 656e 736f 7250 726f 7879  arg, TensorProxy
-000111c0: 2920 656c 7365 2061 7267 2066 6f72 2061  ) else arg for a
-000111d0: 7267 2069 6e20 6172 6773 5f66 6c61 745d  rg in args_flat]
-000111e0: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
-000111f0: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
-00011200: 2829 2866 756e 635f 666c 6174 2c20 2a75  ()(func_flat, *u
-00011210: 6e62 6174 6368 6564 5f61 7267 735f 666c  nbatched_args_fl
-00011220: 6174 290a 2020 2020 2020 2020 6f75 7473  at).        outs
-00011230: 203d 2076 6d61 705f 6361 6c6c 2861 7267   = vmap_call(arg
-00011240: 735f 666c 6174 2c20 696e 5f64 696d 735f  s_flat, in_dims_
-00011250: 666c 6174 2c20 6f75 745f 6469 6d73 2c20  flat, out_dims, 
-00011260: 6178 6973 5f73 697a 653d 6178 6973 5f73  axis_size=axis_s
-00011270: 697a 652c 2066 756e 6374 696f 6e5f 7472  ize, function_tr
-00011280: 6163 653d 7472 6163 6529 0a20 2020 2020  ace=trace).     
-00011290: 2020 2072 6574 7572 6e20 6f75 7473 0a0a     return outs..
-000112a0: 2020 2020 7265 7475 726e 2077 7261 7070      return wrapp
-000112b0: 6572 0a0a 0a23 2054 4f44 4f20 5468 6973  er...# TODO This
-000112c0: 2066 756e 6374 696f 6e20 636f 6d6d 656e   function commen
-000112d0: 7465 6420 6f75 7420 6265 6361 7573 6520  ted out because 
-000112e0: 6974 2063 616c 6c73 206d 616b 655f 7472  it calls make_tr
-000112f0: 6163 6564 2c20 7768 6963 6820 646f 6573  aced, which does
-00011300: 206e 6f74 2065 7869 7374 0a23 2064 6566   not exist.# def
-00011310: 2076 6d61 705f 6561 6765 7228 6675 6e63   vmap_eager(func
-00011320: 2c20 6172 6773 2c20 696e 5f64 696d 733d  , args, in_dims=
-00011330: 302c 206f 7574 5f64 696d 733d 302c 2061  0, out_dims=0, a
-00011340: 7869 735f 7369 7a65 3d4e 6f6e 652c 2065  xis_size=None, e
-00011350: 7865 6375 746f 723d 2274 6f72 6368 2229  xecutor="torch")
-00011360: 3a0a 2320 2020 2020 2222 2243 6f6d 7075  :.#     """Compu
-00011370: 7465 7320 7468 6520 766d 6170 206f 6620  tes the vmap of 
-00011380: 6120 5468 756e 6465 7220 6675 6e63 7469  a Thunder functi
-00011390: 6f6e 2e0a 0a23 2020 2020 2041 7267 733a  on...#     Args:
-000113a0: 0a23 2020 2020 2020 2020 2066 756e 6320  .#         func 
-000113b0: 2843 616c 6c61 626c 6529 3a20 4120 5468  (Callable): A Th
-000113c0: 756e 6465 7220 6675 6e63 7469 6f6e 2074  under function t
-000113d0: 6f20 6265 2074 7261 6e73 666f 726d 6564  o be transformed
-000113e0: 2e0a 2320 2020 2020 2020 2020 6172 6773  ..#         args
-000113f0: 2028 5f74 7970 655f 293a 2041 7267 7320   (_type_): Args 
-00011400: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
-00011410: 0a23 2020 2020 2020 2020 2065 7865 6375  .#         execu
-00011420: 746f 7220 2873 7472 2c20 6f70 7469 6f6e  tor (str, option
-00011430: 616c 293a 2045 7865 6375 746f 7220 746f  al): Executor to
-00011440: 2075 7365 2e20 4465 6661 756c 7473 2074   use. Defaults t
-00011450: 6f20 2274 6f72 6368 222e 0a0a 2320 2020  o "torch"...#   
-00011460: 2020 5265 7475 726e 733a 0a23 2020 2020    Returns:.#    
-00011470: 2020 2020 2054 6865 2072 6573 756c 7420       The result 
-00011480: 6f66 2074 6865 2076 6d61 7070 6564 2066  of the vmapped f
-00011490: 756e 6374 696f 6e2e 0a23 2020 2020 2022  unction..#     "
-000114a0: 2222 0a23 2020 2020 2023 2054 4f44 4f3a  "".#     # TODO:
-000114b0: 2066 6978 2074 6869 7320 2d20 6e6f 7420   fix this - not 
-000114c0: 616c 6c20 6172 6773 206d 6179 2062 6520  all args may be 
-000114d0: 6261 7463 6865 640a 2320 2020 2020 2320  batched.#     # 
-000114e0: 544f 444f 3a20 6865 7265 2077 6520 6173  TODO: here we as
-000114f0: 7375 6d65 2062 6174 6368 2061 7869 7320  sume batch axis 
-00011500: 6973 2030 0a23 2020 2020 2076 6d61 705f  is 0.#     vmap_
-00011510: 7472 6163 6520 3d20 6d61 6b65 5f74 7261  trace = make_tra
-00011520: 6365 280a 2320 2020 2020 2020 2020 766d  ce(.#         vm
-00011530: 6170 2866 756e 632c 2069 6e5f 6469 6d73  ap(func, in_dims
-00011540: 3d69 6e5f 6469 6d73 2c20 6f75 745f 6469  =in_dims, out_di
-00011550: 6d73 3d6f 7574 5f64 696d 732c 2061 7869  ms=out_dims, axi
-00011560: 735f 7369 7a65 3d61 7869 735f 7369 7a65  s_size=axis_size
-00011570: 292c 2065 7865 6375 746f 723d 6578 6563  ), executor=exec
-00011580: 7574 6f72 2c0a 2320 2020 2020 2020 2020  utor,.#         
-00011590: 2a61 7267 7329 0a23 2020 2020 2076 6d61  *args).#     vma
-000115a0: 705f 7472 6163 6564 203d 206d 616b 655f  p_traced = make_
-000115b0: 7472 6163 6564 2870 6172 7469 616c 2865  traced(partial(e
-000115c0: 7661 6c5f 7472 6163 652c 2076 6d61 705f  val_trace, vmap_
-000115d0: 7472 6163 6529 2c20 6578 6563 7574 6f72  trace), executor
-000115e0: 3d65 7865 6375 746f 7229 0a23 2020 2020  =executor).#    
-000115f0: 2072 6574 7572 6e20 766d 6170 5f74 7261   return vmap_tra
-00011600: 6365 6428 2a61 7267 7329 0a0a 0a23 204a  ced(*args)...# J
-00011610: 5650 2074 7261 6e73 666f 726d 0a23 202d  VP transform.# -
-00011620: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 0a40  ------------...@
-00011630: 6461 7461 636c 6173 7328 6672 6f7a 656e  dataclass(frozen
-00011640: 3d54 7275 6529 0a63 6c61 7373 204a 5650  =True).class JVP
-00011650: 4475 616c 3a0a 2020 2020 2222 2244 7561  Dual:.    """Dua
-00011660: 6c20 6e75 6d62 6572 2066 6f72 2074 6865  l number for the
-00011670: 204a 5650 2074 7261 6e73 666f 726d 2e0a   JVP transform..
-00011680: 0a20 2020 2041 7474 7269 6275 7465 733a  .    Attributes:
-00011690: 0a20 2020 2020 2020 2070 7269 6d61 6c3a  .        primal:
-000116a0: 2050 7269 6d61 6c20 7661 6c75 652e 0a20   Primal value.. 
-000116b0: 2020 2020 2020 2074 616e 6765 6e74 3a20         tangent: 
-000116c0: 5461 6e67 656e 7420 7661 6c75 652e 0a20  Tangent value.. 
-000116d0: 2020 2022 2222 0a0a 2020 2020 7072 696d     """..    prim
-000116e0: 616c 3a20 416e 790a 2020 2020 7461 6e67  al: Any.    tang
-000116f0: 656e 743a 2041 6e79 0a0a 2020 2020 6465  ent: Any..    de
-00011700: 6620 5f5f 6974 6572 5f5f 2873 656c 6629  f __iter__(self)
-00011710: 3a0a 2020 2020 2020 2020 7969 656c 6420  :.        yield 
-00011720: 7365 6c66 2e70 7269 6d61 6c0a 2020 2020  self.primal.    
-00011730: 2020 2020 7969 656c 6420 7365 6c66 2e74      yield self.t
-00011740: 616e 6765 6e74 0a0a 0a64 6566 2070 6169  angent...def pai
-00011750: 725f 746f 5f6a 7670 5f64 7561 6c28 7061  r_to_jvp_dual(pa
-00011760: 6972 293a 0a20 2020 2022 2222 436f 6e76  ir):.    """Conv
-00011770: 6572 7473 2061 2070 6169 7220 746f 2061  erts a pair to a
-00011780: 204a 5650 4475 616c 2e0a 0a20 2020 2041   JVPDual...    A
-00011790: 7267 733a 0a20 2020 2020 2020 2070 6169  rgs:.        pai
-000117a0: 7220 2853 6571 7565 6e63 6529 3a20 5061  r (Sequence): Pa
-000117b0: 6972 2074 6f20 636f 6e76 6572 742e 0a0a  ir to convert...
-000117c0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-000117d0: 2020 2020 204a 5650 4475 616c 3a20 4a56       JVPDual: JV
-000117e0: 5044 7561 6c20 7265 7072 6573 656e 7461  PDual representa
-000117f0: 7469 6f6e 206f 6620 7468 6520 7061 6972  tion of the pair
-00011800: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
-00011810: 2069 7369 6e73 7461 6e63 6528 7061 6972   isinstance(pair
-00011820: 2c20 4a56 5044 7561 6c29 3a0a 2020 2020  , JVPDual):.    
-00011830: 2020 2020 7265 7475 726e 2070 6169 720a      return pair.
-00011840: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00011850: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00011860: 6e63 6528 7061 6972 2c20 5365 7175 656e  nce(pair, Sequen
-00011870: 6365 2920 616e 6420 6c65 6e28 7061 6972  ce) and len(pair
-00011880: 2920 3d3d 2032 0a20 2020 2020 2020 2072  ) == 2.        r
-00011890: 6574 7572 6e20 4a56 5044 7561 6c28 2a70  eturn JVPDual(*p
-000118a0: 6169 7229 0a0a 0a64 6566 2073 696e 5f6a  air)...def sin_j
-000118b0: 7670 2861 3a20 4a56 5044 7561 6c29 3a0a  vp(a: JVPDual):.
-000118c0: 2020 2020 782c 2078 6420 3d20 610a 2020      x, xd = a.  
-000118d0: 2020 7265 7475 726e 204a 5650 4475 616c    return JVPDual
-000118e0: 2870 7269 6d73 2e73 696e 2878 292c 2070  (prims.sin(x), p
-000118f0: 7269 6d73 2e63 6f73 2878 2920 2a20 7864  rims.cos(x) * xd
-00011900: 290a 0a0a 6465 6620 6d75 6c5f 6a76 7028  )...def mul_jvp(
-00011910: 613a 204a 5650 4475 616c 2c20 623a 204a  a: JVPDual, b: J
-00011920: 5650 4475 616c 293a 0a20 2020 2078 2c20  VPDual):.    x, 
-00011930: 7864 203d 2061 0a20 2020 2079 2c20 7964  xd = a.    y, yd
-00011940: 203d 2062 0a20 2020 2072 6574 7572 6e20   = b.    return 
-00011950: 4a56 5044 7561 6c28 7820 2a20 792c 2078  JVPDual(x * y, x
-00011960: 202a 2079 6420 2b20 7920 2a20 7864 290a   * yd + y * xd).
-00011970: 0a0a 6465 6620 6164 645f 6a76 7028 613a  ..def add_jvp(a:
-00011980: 204a 5650 4475 616c 2c20 623a 204a 5650   JVPDual, b: JVP
-00011990: 4475 616c 293a 0a20 2020 2078 2c20 7864  Dual):.    x, xd
-000119a0: 203d 2061 0a20 2020 2079 2c20 7964 203d   = a.    y, yd =
-000119b0: 2062 0a20 2020 2072 6574 7572 6e20 4a56   b.    return JV
-000119c0: 5044 7561 6c28 7820 2b20 792c 2078 6420  PDual(x + y, xd 
-000119d0: 2b20 7964 290a 0a0a 6465 6620 6272 6f61  + yd)...def broa
-000119e0: 6463 6173 745f 696e 5f64 696d 5f6a 7670  dcast_in_dim_jvp
-000119f0: 2861 3a20 4a56 5044 7561 6c2c 2073 6861  (a: JVPDual, sha
-00011a00: 7065 3a20 7475 706c 655b 4a56 5044 7561  pe: tuple[JVPDua
-00011a10: 6c2c 202e 2e2e 5d2c 2062 726f 6164 6361  l, ...], broadca
-00011a20: 7374 5f64 696d 656e 7369 6f6e 733a 2074  st_dimensions: t
-00011a30: 7570 6c65 5b4a 5650 4475 616c 2c20 2e2e  uple[JVPDual, ..
-00011a40: 2e5d 2920 2d3e 204a 5650 4475 616c 3a0a  .]) -> JVPDual:.
-00011a50: 2020 2020 782c 2078 6420 3d20 610a 2020      x, xd = a.  
-00011a60: 2020 2320 544f 444f 3a20 7368 6170 6520    # TODO: shape 
-00011a70: 616e 6420 6272 6f61 6463 6173 745f 6469  and broadcast_di
-00011a80: 6d65 6e73 696f 6e73 2073 686f 756c 6420  mensions should 
-00011a90: 6265 2074 7570 6c65 7320 6f66 2069 6e74  be tuples of int
-00011aa0: 730a 2020 2020 2320 6275 7420 666f 7220  s.    # but for 
-00011ab0: 6e6f 7720 6974 2773 2061 2074 7570 6c65  now it's a tuple
-00011ac0: 206f 6620 4a56 5044 7561 6c73 0a20 2020   of JVPDuals.   
-00011ad0: 2069 6620 6c65 6e28 7368 6170 6529 203e   if len(shape) >
-00011ae0: 2030 2061 6e64 2069 7369 6e73 7461 6e63   0 and isinstanc
-00011af0: 6528 7368 6170 655b 305d 2c20 4a56 5044  e(shape[0], JVPD
-00011b00: 7561 6c29 3a0a 2020 2020 2020 2020 7368  ual):.        sh
-00011b10: 6170 652c 205f 203d 2073 6166 655f 7a69  ape, _ = safe_zi
-00011b20: 7028 2a73 6861 7065 290a 2020 2020 6966  p(*shape).    if
-00011b30: 206c 656e 2862 726f 6164 6361 7374 5f64   len(broadcast_d
-00011b40: 696d 656e 7369 6f6e 7329 203e 2030 2061  imensions) > 0 a
-00011b50: 6e64 2069 7369 6e73 7461 6e63 6528 6272  nd isinstance(br
-00011b60: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-00011b70: 6e73 5b30 5d2c 204a 5650 4475 616c 293a  ns[0], JVPDual):
-00011b80: 0a20 2020 2020 2020 2062 726f 6164 6361  .        broadca
-00011b90: 7374 5f64 696d 656e 7369 6f6e 732c 205f  st_dimensions, _
-00011ba0: 203d 2073 6166 655f 7a69 7028 2a62 726f   = safe_zip(*bro
-00011bb0: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-00011bc0: 7329 0a20 2020 2072 6574 7572 6e20 4a56  s).    return JV
-00011bd0: 5044 7561 6c28 0a20 2020 2020 2020 2070  PDual(.        p
-00011be0: 7269 6d73 2e62 726f 6164 6361 7374 5f69  rims.broadcast_i
-00011bf0: 6e5f 6469 6d28 782c 2073 6861 7065 2c20  n_dim(x, shape, 
-00011c00: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-00011c10: 696f 6e73 292c 2070 7269 6d73 2e62 726f  ions), prims.bro
-00011c20: 6164 6361 7374 5f69 6e5f 6469 6d28 7864  adcast_in_dim(xd
-00011c30: 2c20 7368 6170 652c 2062 726f 6164 6361  , shape, broadca
-00011c40: 7374 5f64 696d 656e 7369 6f6e 7329 0a20  st_dimensions). 
-00011c50: 2020 2029 0a0a 0a64 6566 2075 6e70 6163     )...def unpac
-00011c60: 6b5f 7365 7175 656e 6365 5f6a 7670 2873  k_sequence_jvp(s
-00011c70: 6571 7565 6e63 653a 204a 5650 4475 616c  equence: JVPDual
-00011c80: 2c20 6c65 6e67 7468 3a20 4a56 5044 7561  , length: JVPDua
-00011c90: 6c29 202d 3e20 4a56 5044 7561 6c3a 0a20  l) -> JVPDual:. 
-00011ca0: 2020 2078 203d 2074 7265 655f 6d61 7028     x = tree_map(
-00011cb0: 6c61 6d62 6461 2078 3a20 782e 7072 696d  lambda x: x.prim
-00011cc0: 616c 2c20 7365 7175 656e 6365 290a 2020  al, sequence).  
-00011cd0: 2020 7864 203d 2074 7265 655f 6d61 7028    xd = tree_map(
-00011ce0: 6c61 6d62 6461 2078 3a20 782e 7461 6e67  lambda x: x.tang
-00011cf0: 656e 742c 2073 6571 7565 6e63 6529 0a20  ent, sequence). 
-00011d00: 2020 206c 656e 6774 682c 205f 203d 206c     length, _ = l
-00011d10: 656e 6774 680a 2020 2020 7072 696d 616c  ength.    primal
-00011d20: 7320 3d20 7072 696d 732e 756e 7061 636b  s = prims.unpack
-00011d30: 5f73 6571 7565 6e63 6528 782c 206c 656e  _sequence(x, len
-00011d40: 6774 6829 0a20 2020 2074 616e 6765 6e74  gth).    tangent
-00011d50: 7320 3d20 7072 696d 732e 756e 7061 636b  s = prims.unpack
-00011d60: 5f73 6571 7565 6e63 6528 7864 2c20 6c65  _sequence(xd, le
-00011d70: 6e67 7468 290a 2020 2020 7265 7475 726e  ngth).    return
-00011d80: 2073 6166 655f 6d61 7028 7061 6972 5f74   safe_map(pair_t
-00011d90: 6f5f 6a76 705f 6475 616c 2c20 7361 6665  o_jvp_dual, safe
-00011da0: 5f7a 6970 2870 7269 6d61 6c73 2c20 7461  _zip(primals, ta
-00011db0: 6e67 656e 7473 2929 0a0a 0a64 6566 2075  ngents))...def u
-00011dc0: 6e70 6163 6b5f 7472 6976 6961 6c5f 6a76  npack_trivial_jv
-00011dd0: 7028 783a 204a 5650 4475 616c 2920 2d3e  p(x: JVPDual) ->
-00011de0: 204a 5650 4475 616c 3a0a 2020 2020 7265   JVPDual:.    re
-00011df0: 7475 726e 2078 0a0a 0a6a 7670 5f69 6d70  turn x...jvp_imp
-00011e00: 6c73 3a20 6469 6374 5b70 7269 6d73 2e53  ls: dict[prims.S
-00011e10: 796d 626f 6c2c 2043 616c 6c61 626c 655d  ymbol, Callable]
-00011e20: 203d 2064 6963 7428 290a 0a6a 7670 5f69   = dict()..jvp_i
-00011e30: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
-00011e40: 4473 2e53 494e 5d20 3d20 7369 6e5f 6a76  Ds.SIN] = sin_jv
-00011e50: 700a 6a76 705f 696d 706c 735b 7072 696d  p.jvp_impls[prim
-00011e60: 732e 5072 696d 4944 732e 4d55 4c5d 203d  s.PrimIDs.MUL] =
-00011e70: 206d 756c 5f6a 7670 0a6a 7670 5f69 6d70   mul_jvp.jvp_imp
-00011e80: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
-00011e90: 2e41 4444 5d20 3d20 6164 645f 6a76 700a  .ADD] = add_jvp.
-00011ea0: 6a76 705f 696d 706c 735b 7072 696d 732e  jvp_impls[prims.
-00011eb0: 5072 696d 4944 732e 4252 4f41 4443 4153  PrimIDs.BROADCAS
-00011ec0: 545f 494e 5f44 494d 5d20 3d20 6272 6f61  T_IN_DIM] = broa
-00011ed0: 6463 6173 745f 696e 5f64 696d 5f6a 7670  dcast_in_dim_jvp
-00011ee0: 0a23 206a 7670 5f69 6d70 6c73 5b70 7269  .# jvp_impls[pri
-00011ef0: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
-00011f00: 4b5f 5345 5155 454e 4345 5d20 3d20 756e  K_SEQUENCE] = un
-00011f10: 7061 636b 5f73 6571 7565 6e63 655f 6a76  pack_sequence_jv
-00011f20: 700a 2320 6a76 705f 696d 706c 735b 7072  p.# jvp_impls[pr
-00011f30: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
-00011f40: 434b 5f54 5249 5649 414c 5d20 3d20 756e  CK_TRIVIAL] = un
-00011f50: 7061 636b 5f74 7269 7669 616c 5f6a 7670  pack_trivial_jvp
-00011f60: 0a0a 0a64 6566 206a 7670 5f73 796d 626f  ...def jvp_symbo
-00011f70: 6c5f 6d61 7070 6572 2873 796d 626f 6c3a  l_mapper(symbol:
-00011f80: 2070 7269 6d73 2e53 796d 626f 6c29 3a0a   prims.Symbol):.
-00011f90: 2020 2020 2222 224d 6170 7320 6120 7379      """Maps a sy
-00011fa0: 6d62 6f6c 2074 6f20 6120 4a56 5020 6675  mbol to a JVP fu
-00011fb0: 6e63 7469 6f6e 2074 6861 7420 6576 616c  nction that eval
-00011fc0: 7561 7465 7320 6974 2e0a 0a20 2020 2041  uates it...    A
-00011fd0: 7267 733a 0a20 2020 2020 2020 2073 796d  rgs:.        sym
-00011fe0: 626f 6c20 2870 7269 6d73 2e53 796d 626f  bol (prims.Symbo
-00011ff0: 6c29 3a20 5379 6d62 6f6c 2074 6f20 6576  l): Symbol to ev
-00012000: 616c 7561 7465 2e0a 0a20 2020 2052 6169  aluate...    Rai
-00012010: 7365 733a 0a20 2020 2020 2020 204e 6f74  ses:.        Not
-00012020: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
-00012030: 3a20 4966 2074 6865 204a 5650 2066 6f72  : If the JVP for
-00012040: 2074 6865 2073 796d 626f 6c20 6973 206e   the symbol is n
-00012050: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
-00012060: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-00012070: 2020 2020 2020 4361 6c6c 6162 6c65 3a20        Callable: 
-00012080: 4a56 5020 6675 6e63 7469 6f6e 2074 6861  JVP function tha
-00012090: 7420 6576 616c 7561 7465 7320 7468 6520  t evaluates the 
-000120a0: 7379 6d62 6f6c 2e0a 2020 2020 2222 220a  symbol..    """.
-000120b0: 0a20 2020 2064 6566 2077 7261 705f 6172  .    def wrap_ar
-000120c0: 6728 7829 3a0a 2020 2020 2020 2020 6966  g(x):.        if
-000120d0: 2069 7369 6e73 7461 6e63 6528 782c 204a   isinstance(x, J
-000120e0: 5650 4475 616c 293a 0a20 2020 2020 2020  VPDual):.       
-000120f0: 2020 2020 2072 6574 7572 6e20 780a 2020       return x.  
-00012100: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-00012110: 7461 6e63 6528 782c 204e 756d 6265 7229  tance(x, Number)
-00012120: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00012130: 7475 726e 204a 5650 4475 616c 2878 2c20  turn JVPDual(x, 
-00012140: 7479 7065 2878 2928 3029 290a 2020 2020  type(x)(0)).    
-00012150: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00012160: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00012170: 6545 7272 6f72 2866 224a 5650 2077 7261  eError(f"JVP wra
-00012180: 705f 6172 6720 676f 7420 616e 2075 6e73  p_arg got an uns
-00012190: 7570 706f 7274 6564 2074 7970 6520 7b74  upported type {t
-000121a0: 7970 6528 7829 7d22 290a 0a20 2020 2023  ype(x)}")..    #
-000121b0: 2049 6620 7379 6d62 6f6c 2e61 7267 7320   If symbol.args 
-000121c0: 646f 6573 6e27 7420 6861 7665 2073 7562  doesn't have sub
-000121d0: 636c 6173 7365 7320 6f66 2056 6172 6961  classes of Varia
-000121e0: 626c 652c 2074 6865 6e20 7765 206e 6565  ble, then we nee
-000121f0: 6420 746f 2072 6574 7572 6e20 6120 7a65  d to return a ze
-00012200: 726f 2074 616e 6765 6e74 0a20 2020 2023  ro tangent.    #
-00012210: 2054 4f44 4f3a 2074 6865 7265 206d 6179   TODO: there may
-00012220: 2062 6520 6120 6265 7474 6572 2077 6179   be a better way
-00012230: 2074 6f20 6465 7465 6374 2063 6f6e 7374   to detect const
-00012240: 616e 7473 2069 6e20 7468 6520 7472 6163  ants in the trac
-00012250: 650a 2020 2020 6966 2073 796d 626f 6c2e  e.    if symbol.
-00012260: 6172 655f 616c 6c5f 6172 6773 5f63 6f6e  are_all_args_con
-00012270: 7374 616e 743a 0a0a 2020 2020 2020 2020  stant:..        
-00012280: 6465 6620 7a65 726f 735f 6c69 6b65 2878  def zeros_like(x
-00012290: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-000122a0: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-000122b0: 5465 6e73 6f72 5072 6f78 7929 3a0a 2020  TensorProxy):.  
-000122c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000122d0: 7475 726e 2066 756c 6c5f 6c69 6b65 2878  turn full_like(x
-000122e0: 2c20 6669 6c6c 5f76 616c 7565 3d30 290a  , fill_value=0).
-000122f0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00012300: 2069 7369 6e73 7461 6e63 6528 782c 204e   isinstance(x, N
-00012310: 756d 6265 7250 726f 7879 293a 0a20 2020  umberProxy):.   
-00012320: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00012330: 7572 6e20 7479 7065 2878 2e76 616c 7565  urn type(x.value
-00012340: 2928 3029 0a20 2020 2020 2020 2020 2020  )(0).           
-00012350: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-00012360: 2878 2c20 4e75 6d62 6572 293a 0a20 2020  (x, Number):.   
-00012370: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00012380: 7572 6e20 7479 7065 2878 2928 3029 0a20  urn type(x)(0). 
-00012390: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000123a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000123b0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000123c0: 7228 6622 7a65 726f 735f 6c69 6b65 2069  r(f"zeros_like i
-000123d0: 6e73 6964 6520 4a56 5020 676f 7420 616e  nside JVP got an
-000123e0: 2075 6e73 7570 706f 7274 6564 2074 7970   unsupported typ
-000123f0: 6520 7b74 7970 6528 7829 7d22 290a 0a20  e {type(x)}").. 
-00012400: 2020 2020 2020 2064 6566 206a 7670 5f69         def jvp_i
-00012410: 6d70 6c5f 636f 6e73 7428 7379 6d62 6f6c  mpl_const(symbol
-00012420: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-00012430: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00012440: 7072 696d 616c 7320 3d20 7379 6d62 6f6c  primals = symbol
-00012450: 5f74 6f5f 6576 616c 2873 796d 626f 6c29  _to_eval(symbol)
-00012460: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-00012470: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00012480: 2069 7369 6e73 7461 6e63 6528 7072 696d   isinstance(prim
-00012490: 616c 732c 2053 6571 7565 6e63 6529 3a0a  als, Sequence):.
-000124a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124b0: 7461 6e67 656e 7473 203d 2074 7570 6c65  tangents = tuple
-000124c0: 287a 6572 6f73 5f6c 696b 6528 7029 2066  (zeros_like(p) f
-000124d0: 6f72 2070 2069 6e20 7072 696d 616c 7329  or p in primals)
-000124e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000124f0: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
-00012500: 2870 6169 725f 746f 5f6a 7670 5f64 7561  (pair_to_jvp_dua
-00012510: 6c2c 2073 6166 655f 7a69 7028 7072 696d  l, safe_zip(prim
-00012520: 616c 732c 2074 616e 6765 6e74 7329 290a  als, tangents)).
-00012530: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012540: 726e 204a 5650 4475 616c 2870 7269 6d61  rn JVPDual(prima
-00012550: 6c73 2c20 7a65 726f 735f 6c69 6b65 2870  ls, zeros_like(p
-00012560: 7269 6d61 6c73 2929 0a0a 2020 2020 2020  rimals))..      
-00012570: 2020 7265 7475 726e 2070 6172 7469 616c    return partial
-00012580: 286a 7670 5f69 6d70 6c5f 636f 6e73 742c  (jvp_impl_const,
-00012590: 2073 796d 626f 6c29 0a0a 2020 2020 2320   symbol)..    # 
-000125a0: 4e6f 726d 616c 2063 6173 652c 2077 6520  Normal case, we 
-000125b0: 6861 7665 2061 2070 726f 7879 2074 616e  have a proxy tan
-000125c0: 6765 6e74 0a20 2020 206a 7670 5f69 6d70  gent.    jvp_imp
-000125d0: 6c20 3d20 6a76 705f 696d 706c 732e 6765  l = jvp_impls.ge
-000125e0: 7428 7379 6d62 6f6c 2e73 796d 2e69 6429  t(symbol.sym.id)
-000125f0: 0a20 2020 2069 6620 6a76 705f 696d 706c  .    if jvp_impl
-00012600: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00012610: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
-00012620: 6d65 6e74 6564 4572 726f 7228 6622 4a56  mentedError(f"JV
-00012630: 5020 666f 7220 7b73 796d 626f 6c2e 7379  P for {symbol.sy
-00012640: 6d2e 6964 7d20 6973 206e 6f74 2069 6d70  m.id} is not imp
-00012650: 6c65 6d65 6e74 6564 2229 0a0a 2020 2020  lemented")..    
-00012660: 6465 6620 5f6a 7670 5f69 6d70 6c28 2a61  def _jvp_impl(*a
-00012670: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
-00012680: 2020 2020 2020 2020 6172 6773 203d 2074          args = t
-00012690: 7265 655f 6d61 7028 7772 6170 5f61 7267  ree_map(wrap_arg
-000126a0: 2c20 6172 6773 290a 2020 2020 2020 2020  , args).        
-000126b0: 2320 4578 7065 6374 696e 6720 4a56 5044  # Expecting JVPD
-000126c0: 7561 6c73 2077 7261 7070 696e 6720 7061  uals wrapping pa
-000126d0: 6972 7320 6f66 2070 7269 6d61 6c73 2061  irs of primals a
-000126e0: 6e64 2074 616e 6765 6e74 730a 2020 2020  nd tangents.    
-000126f0: 2020 2020 6173 7365 7274 2061 6c6c 2869      assert all(i
-00012700: 7369 6e73 7461 6e63 6528 6172 672c 204a  sinstance(arg, J
-00012710: 5650 4475 616c 2920 666f 7220 6172 6720  VPDual) for arg 
-00012720: 696e 2074 7265 655f 666c 6174 7465 6e28  in tree_flatten(
-00012730: 6172 6773 295b 305d 290a 2020 2020 2020  args)[0]).      
-00012740: 2020 7265 7475 726e 206a 7670 5f69 6d70    return jvp_imp
-00012750: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
-00012760: 7329 0a0a 2020 2020 7265 7475 726e 205f  s)..    return _
-00012770: 6a76 705f 696d 706c 0a0a 0a64 6566 205f  jvp_impl...def _
-00012780: 6a76 705f 6361 6c6c 5f6d 6574 6166 756e  jvp_call_metafun
-00012790: 6328 6465 7461 6368 6564 3a20 626f 6f6c  c(detached: bool
-000127a0: 2c20 7072 696d 616c 732c 2074 616e 6765  , primals, tange
-000127b0: 6e74 732c 202a 2c20 6675 6e63 7469 6f6e  nts, *, function
-000127c0: 5f74 7261 6365 3a20 5472 6163 652c 202a  _trace: Trace, *
-000127d0: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
-000127e0: 224d 6574 6166 756e 6374 696f 6e20 666f  "Metafunction fo
-000127f0: 7220 7468 6520 4a56 5020 7472 616e 7366  r the JVP transf
-00012800: 6f72 6d2e 0a0a 2020 2020 4172 6773 3a0a  orm...    Args:.
-00012810: 2020 2020 2020 2020 6465 7461 6368 6564          detached
-00012820: 2028 626f 6f6c 293a 2057 6865 7468 6572   (bool): Whether
-00012830: 2074 6f20 6465 7461 6368 2074 6865 2074   to detach the t
-00012840: 7261 6365 2e0a 2020 2020 2020 2020 7072  race..        pr
-00012850: 696d 616c 7320 2854 7570 6c65 5b50 726f  imals (Tuple[Pro
-00012860: 7879 5d29 3a20 5072 696d 616c 2076 616c  xy]): Primal val
-00012870: 7565 732e 0a20 2020 2020 2020 2074 616e  ues..        tan
-00012880: 6765 6e74 7320 2854 7570 6c65 5b50 726f  gents (Tuple[Pro
-00012890: 7879 5d29 3a20 5461 6e67 656e 7420 7661  xy]): Tangent va
-000128a0: 6c75 6573 2e0a 2020 2020 2020 2020 6675  lues..        fu
-000128b0: 6e63 7469 6f6e 5f74 7261 6365 2028 5472  nction_trace (Tr
-000128c0: 6163 6529 3a20 5472 6163 6520 6f66 2074  ace): Trace of t
-000128d0: 6865 2066 756e 6374 696f 6e20 746f 2062  he function to b
-000128e0: 6520 7472 616e 7366 6f72 6d65 642e 0a20  e transformed.. 
-000128f0: 2020 2020 2020 206b 7761 7267 733a 204b         kwargs: K
-00012900: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
-00012910: 2e0a 0a20 2020 2052 6169 7365 733a 0a20  ...    Raises:. 
-00012920: 2020 2020 2020 2041 7373 6572 7469 6f6e         Assertion
-00012930: 4572 726f 723a 2049 6620 7468 6520 4a56  Error: If the JV
-00012940: 5020 666f 7220 6b65 7977 6f72 6420 6172  P for keyword ar
-00012950: 6775 6d65 6e74 7320 6973 206e 6f74 2069  guments is not i
-00012960: 6d70 6c65 6d65 6e74 6564 2e0a 0a20 2020  mplemented...   
-00012970: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00012980: 2020 5265 7375 6c74 206f 6620 7468 6520    Result of the 
-00012990: 4a56 5020 7472 616e 7366 6f72 6d2e 0a20  JVP transform.. 
-000129a0: 2020 2022 2222 0a20 2020 2061 7373 6572     """.    asser
-000129b0: 7420 6c65 6e28 6b77 6172 6773 2920 3d3d  t len(kwargs) ==
-000129c0: 2030 2c20 224a 5650 2066 6f72 206b 7761   0, "JVP for kwa
-000129d0: 7267 7320 6973 206e 6f74 2069 6d70 6c65  rgs is not imple
-000129e0: 6d65 6e74 6564 220a 0a20 2020 2063 7478  mented"..    ctx
-000129f0: 203d 2064 6574 6163 6865 645f 7472 6163   = detached_trac
-00012a00: 6528 2920 6966 2064 6574 6163 6865 6420  e() if detached 
-00012a10: 656c 7365 206e 756c 6c63 6f6e 7465 7874  else nullcontext
-00012a20: 2829 0a20 2020 2077 6974 6820 6374 783a  ().    with ctx:
-00012a30: 0a20 2020 2020 2020 2023 2057 7261 7070  .        # Wrapp
-00012a40: 696e 6720 7468 6520 7072 696d 616c 7320  ing the primals 
-00012a50: 616e 6420 7461 6e67 656e 7473 2069 6e20  and tangents in 
-00012a60: 4a56 5044 7561 6c73 2069 7320 6e6f 7420  JVPDuals is not 
-00012a70: 7374 7269 6374 6c79 206e 6563 6573 7361  strictly necessa
-00012a80: 7279 2c20 6275 7420 6974 206d 616b 6573  ry, but it makes
-00012a90: 0a20 2020 2020 2020 2023 2074 6865 2063  .        # the c
-00012aa0: 6f64 6520 6d6f 7265 2072 6561 6461 626c  ode more readabl
-00012ab0: 650a 2020 2020 2020 2020 2320 5765 2070  e.        # We p
-00012ac0: 726f 7061 6761 7465 2074 6865 204a 5650  ropagate the JVP
-00012ad0: 4475 616c 7320 7468 726f 7567 6820 7468  Duals through th
-00012ae0: 6520 7472 6163 652c 2061 6e64 2074 6865  e trace, and the
-00012af0: 6e20 756e 7772 6170 2074 6865 6d20 6174  n unwrap them at
-00012b00: 2074 6865 2065 6e64 0a20 2020 2020 2020   the end.       
-00012b10: 2070 7269 6d61 6c73 5f74 616e 6765 6e74   primals_tangent
-00012b20: 735f 6475 616c 7320 3d20 7361 6665 5f6d  s_duals = safe_m
-00012b30: 6170 2870 6169 725f 746f 5f6a 7670 5f64  ap(pair_to_jvp_d
-00012b40: 7561 6c2c 2073 6166 655f 7a69 7028 7072  ual, safe_zip(pr
-00012b50: 696d 616c 732c 2074 616e 6765 6e74 7329  imals, tangents)
-00012b60: 290a 2020 2020 2020 2020 7265 7375 6c74  ).        result
-00012b70: 203d 2065 7661 6c5f 7472 6163 6528 6675   = eval_trace(fu
-00012b80: 6e63 7469 6f6e 5f74 7261 6365 2c20 2a70  nction_trace, *p
-00012b90: 7269 6d61 6c73 5f74 616e 6765 6e74 735f  rimals_tangents_
-00012ba0: 6475 616c 732c 2073 796d 626f 6c5f 6d61  duals, symbol_ma
-00012bb0: 7070 6572 3d6a 7670 5f73 796d 626f 6c5f  pper=jvp_symbol_
-00012bc0: 6d61 7070 6572 290a 2020 2020 2020 2020  mapper).        
-00012bd0: 2320 556e 7772 6170 7069 6e67 2074 6865  # Unwrapping the
-00012be0: 204a 5650 4475 616c 730a 2020 2020 2020   JVPDuals.      
-00012bf0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00012c00: 7265 7375 6c74 2c20 5365 7175 656e 6365  result, Sequence
-00012c10: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
-00012c20: 7373 6572 7420 616c 6c28 6973 696e 7374  ssert all(isinst
-00012c30: 616e 6365 2878 2c20 4a56 5044 7561 6c29  ance(x, JVPDual)
-00012c40: 2066 6f72 2078 2069 6e20 7265 7375 6c74   for x in result
-00012c50: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-00012c60: 696d 616c 732c 2074 616e 6765 6e74 7320  imals, tangents 
-00012c70: 3d20 756e 7a69 7032 2872 6573 756c 7429  = unzip2(result)
-00012c80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00012c90: 7572 6e20 7072 696d 616c 732c 2074 616e  urn primals, tan
-00012ca0: 6765 6e74 730a 2020 2020 2020 2020 6173  gents.        as
-00012cb0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-00012cc0: 7265 7375 6c74 2c20 4a56 5044 7561 6c29  result, JVPDual)
-00012cd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00012ce0: 7265 7375 6c74 2e70 7269 6d61 6c2c 2072  result.primal, r
-00012cf0: 6573 756c 742e 7461 6e67 656e 740a 0a0a  esult.tangent...
-00012d00: 6a76 705f 6361 6c6c 203d 2053 796d 626f  jvp_call = Symbo
-00012d10: 6c28 6964 3d54 7261 6e73 666f 726d 732e  l(id=Transforms.
-00012d20: 4a76 704f 702c 206e 616d 653d 226a 7670  JvpOp, name="jvp
-00012d30: 5f63 616c 6c22 2c20 6d65 7461 3d70 6172  _call", meta=par
-00012d40: 7469 616c 285f 6a76 705f 6361 6c6c 5f6d  tial(_jvp_call_m
-00012d50: 6574 6166 756e 632c 2046 616c 7365 2929  etafunc, False))
-00012d60: 0a0a 0a64 6566 205f 6964 656e 7469 7479  ...def _identity
-00012d70: 5f63 616c 6c5f 6a76 7028 2a61 7267 733a  _call_jvp(*args:
-00012d80: 204a 5650 4475 616c 2c20 7472 6163 653a   JVPDual, trace:
-00012d90: 2054 7261 6365 2c20 2a2a 6b77 6172 6773   Trace, **kwargs
-00012da0: 293a 0a20 2020 2070 7269 6d61 6c73 2c20  ):.    primals, 
-00012db0: 7461 6e67 656e 7473 203d 2075 6e7a 6970  tangents = unzip
-00012dc0: 3228 6172 6773 290a 2020 2020 6f75 745f  2(args).    out_
-00012dd0: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
-00012de0: 6765 6e74 7320 3d20 5f6a 7670 5f63 616c  gents = _jvp_cal
-00012df0: 6c5f 6d65 7461 6675 6e63 2846 616c 7365  l_metafunc(False
-00012e00: 2c20 7072 696d 616c 732c 2074 616e 6765  , primals, tange
-00012e10: 6e74 732c 2074 7261 6365 2c20 2a2a 6b77  nts, trace, **kw
-00012e20: 6172 6773 290a 2020 2020 6966 2069 7369  args).    if isi
-00012e30: 6e73 7461 6e63 6528 6f75 745f 7072 696d  nstance(out_prim
-00012e40: 616c 732c 2053 6571 7565 6e63 6529 3a0a  als, Sequence):.
-00012e50: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00012e60: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
-00012e70: 6a76 705f 6475 616c 2c20 7361 6665 5f7a  jvp_dual, safe_z
-00012e80: 6970 286f 7574 5f70 7269 6d61 6c73 2c20  ip(out_primals, 
-00012e90: 6f75 745f 7461 6e67 656e 7473 2929 0a20  out_tangents)). 
-00012ea0: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
-00012eb0: 6c28 6f75 745f 7072 696d 616c 732c 206f  l(out_primals, o
-00012ec0: 7574 5f74 616e 6765 6e74 7329 0a0a 0a6a  ut_tangents)...j
-00012ed0: 7670 5f69 6d70 6c73 5b54 7261 6e73 666f  vp_impls[Transfo
-00012ee0: 726d 732e 4964 656e 7469 7479 4f70 5d20  rms.IdentityOp] 
-00012ef0: 3d20 5f69 6465 6e74 6974 795f 6361 6c6c  = _identity_call
-00012f00: 5f6a 7670 0a0a 0a64 6566 205f 766d 6170  _jvp...def _vmap
-00012f10: 5f63 616c 6c5f 6a76 7028 6172 6773 3a20  _call_jvp(args: 
-00012f20: 4a56 5044 7561 6c2c 2069 6e5f 6469 6d73  JVPDual, in_dims
-00012f30: 2c20 6f75 745f 6469 6d73 2c20 6178 6973  , out_dims, axis
-00012f40: 5f73 697a 652c 2074 7261 6365 3a20 5472  _size, trace: Tr
-00012f50: 6163 652c 202a 2a6b 7761 7267 7329 3a0a  ace, **kwargs):.
-00012f60: 2020 2020 7072 696d 616c 732c 2074 616e      primals, tan
-00012f70: 6765 6e74 7320 3d20 7361 6665 5f7a 6970  gents = safe_zip
-00012f80: 282a 6172 6773 290a 2020 2020 696e 5f64  (*args).    in_d
-00012f90: 696d 732c 205f 203d 2073 6166 655f 7a69  ims, _ = safe_zi
-00012fa0: 7028 2a69 6e5f 6469 6d73 290a 2020 2020  p(*in_dims).    
-00012fb0: 6f75 745f 6469 6d73 2c20 5f20 3d20 7361  out_dims, _ = sa
-00012fc0: 6665 5f7a 6970 282a 6f75 745f 6469 6d73  fe_zip(*out_dims
-00012fd0: 290a 2020 2020 766d 6170 7065 645f 7472  ).    vmapped_tr
-00012fe0: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
-00012ff0: 7472 6163 6528 2928 0a20 2020 2020 2020  trace()(.       
-00013000: 2076 6d61 7028 7061 7274 6961 6c28 6576   vmap(partial(ev
-00013010: 616c 5f74 7261 6365 2c20 7472 6163 6529  al_trace, trace)
-00013020: 2c20 696e 5f64 696d 733d 696e 5f64 696d  , in_dims=in_dim
-00013030: 732c 206f 7574 5f64 696d 733d 6f75 745f  s, out_dims=out_
-00013040: 6469 6d73 2c20 6178 6973 5f73 697a 653d  dims, axis_size=
-00013050: 6178 6973 5f73 697a 6529 2c20 2a70 7269  axis_size), *pri
-00013060: 6d61 6c73 0a20 2020 2029 0a20 2020 2076  mals.    ).    v
-00013070: 6d61 7070 6564 5f66 756e 6320 3d20 7061  mapped_func = pa
-00013080: 7274 6961 6c28 6576 616c 5f74 7261 6365  rtial(eval_trace
-00013090: 2c20 766d 6170 7065 645f 7472 6163 6529  , vmapped_trace)
-000130a0: 0a20 2020 206f 7574 5f70 7269 6d61 6c73  .    out_primals
-000130b0: 2c20 6f75 745f 7461 6e67 656e 7473 203d  , out_tangents =
-000130c0: 206a 7670 2876 6d61 7070 6564 5f66 756e   jvp(vmapped_fun
-000130d0: 6329 2870 7269 6d61 6c73 2c20 7461 6e67  c)(primals, tang
-000130e0: 656e 7473 2c20 2a2a 6b77 6172 6773 290a  ents, **kwargs).
-000130f0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00013100: 6528 6f75 745f 7072 696d 616c 732c 2053  e(out_primals, S
-00013110: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-00013120: 2020 7265 7475 726e 2073 6166 655f 6d61    return safe_ma
-00013130: 7028 7061 6972 5f74 6f5f 6a76 705f 6475  p(pair_to_jvp_du
-00013140: 616c 2c20 7361 6665 5f7a 6970 286f 7574  al, safe_zip(out
-00013150: 5f70 7269 6d61 6c73 2c20 6f75 745f 7461  _primals, out_ta
-00013160: 6e67 656e 7473 2929 0a20 2020 2072 6574  ngents)).    ret
-00013170: 7572 6e20 4a56 5044 7561 6c28 6f75 745f  urn JVPDual(out_
-00013180: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
-00013190: 6765 6e74 7329 0a0a 0a6a 7670 5f69 6d70  gents)...jvp_imp
-000131a0: 6c73 5b54 7261 6e73 666f 726d 732e 566d  ls[Transforms.Vm
-000131b0: 6170 4f70 5d20 3d20 5f76 6d61 705f 6361  apOp] = _vmap_ca
-000131c0: 6c6c 5f6a 7670 0a0a 0a64 6566 206a 7670  ll_jvp...def jvp
-000131d0: 2866 756e 6329 3a0a 2020 2020 2222 224a  (func):.    """J
-000131e0: 6163 6f62 6961 6e2d 7665 6374 6f72 2070  acobian-vector p
-000131f0: 726f 6475 6374 2074 7261 6e73 666f 726d  roduct transform
-00013200: 2066 6f72 2061 2054 6875 6e64 6572 2066   for a Thunder f
-00013210: 756e 6374 696f 6e2e 0a0a 2020 2020 4172  unction...    Ar
-00013220: 6773 3a0a 2020 2020 2020 2020 6675 6e63  gs:.        func
-00013230: 2028 4361 6c6c 6162 6c65 293a 2041 2054   (Callable): A T
-00013240: 6875 6e64 6572 2066 756e 6374 696f 6e20  hunder function 
-00013250: 746f 2062 6520 7472 616e 7366 6f72 6d65  to be transforme
-00013260: 642e 0a0a 2020 2020 5265 7475 726e 733a  d...    Returns:
-00013270: 0a20 2020 2020 2020 2043 616c 6c61 626c  .        Callabl
-00013280: 653a 2041 2066 756e 6374 696f 6e20 7468  e: A function th
-00013290: 6174 2063 6f6d 7075 7465 7320 7468 6520  at computes the 
-000132a0: 4a61 636f 6269 616e 2d76 6563 746f 7220  Jacobian-vector 
-000132b0: 7072 6f64 7563 740a 2020 2020 2020 2020  product.        
-000132c0: 2020 2020 7461 6b69 6e67 2070 7269 6d61      taking prima
-000132d0: 6c73 2061 6e64 2074 616e 6765 6e74 7320  ls and tangents 
-000132e0: 6173 2061 7267 756d 656e 7473 2e0a 2020  as arguments..  
-000132f0: 2020 2222 220a 0a20 2020 2064 6566 2077    """..    def w
-00013300: 7261 7070 6572 2870 7269 6d61 6c73 2c20  rapper(primals, 
-00013310: 7461 6e67 656e 7473 293a 0a20 2020 2020  tangents):.     
-00013320: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
-00013330: 7275 6374 5f74 7261 6365 2829 2866 756e  ruct_trace()(fun
-00013340: 632c 202a 7072 696d 616c 7329 0a20 2020  c, *primals).   
-00013350: 2020 2020 2072 6574 7572 6e20 6a76 705f       return jvp_
-00013360: 6361 6c6c 2870 7269 6d61 6c73 2c20 7461  call(primals, ta
-00013370: 6e67 656e 7473 2c20 6675 6e63 7469 6f6e  ngents, function
-00013380: 5f74 7261 6365 3d74 7261 6365 290a 0a20  _trace=trace).. 
-00013390: 2020 2072 6574 7572 6e20 7772 6170 7065     return wrappe
-000133a0: 720a 0a0a 2320 544f 444f 2054 6869 7320  r...# TODO This 
-000133b0: 6675 6e63 7469 6f6e 2063 6f6d 6d65 6e74  function comment
-000133c0: 6564 206f 7574 2062 6563 6175 7365 2069  ed out because i
-000133d0: 7420 6361 6c6c 7320 6d61 6b65 5f74 7261  t calls make_tra
-000133e0: 6365 642c 2077 6869 6368 2064 6f65 7320  ced, which does 
-000133f0: 6e6f 7420 6578 6973 740a 2320 6465 6620  not exist.# def 
-00013400: 6a76 705f 6561 6765 7228 6675 6e63 2c20  jvp_eager(func, 
-00013410: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
-00013420: 732c 2065 7865 6375 746f 723d 2274 6f72  s, executor="tor
-00013430: 6368 2229 3a0a 2320 2020 2020 2222 2243  ch"):.#     """C
-00013440: 6f6d 7075 7465 7320 7468 6520 4a61 636f  omputes the Jaco
-00013450: 6269 616e 2d76 6563 746f 7220 7072 6f64  bian-vector prod
-00013460: 7563 7420 6f66 2061 2054 6875 6e64 6572  uct of a Thunder
-00013470: 2066 756e 6374 696f 6e2e 0a0a 2320 2020   function...#   
-00013480: 2020 4172 6773 3a0a 2320 2020 2020 2020    Args:.#       
-00013490: 2020 6675 6e63 2028 4361 6c6c 6162 6c65    func (Callable
-000134a0: 293a 2041 2054 6875 6e64 6572 2066 756e  ): A Thunder fun
-000134b0: 6374 696f 6e20 746f 2062 6520 7472 616e  ction to be tran
-000134c0: 7366 6f72 6d65 642e 0a23 2020 2020 2020  sformed..#      
-000134d0: 2020 2070 7269 6d61 6c73 2028 5f74 7970     primals (_typ
-000134e0: 655f 293a 2050 7269 6d61 6c73 206f 6620  e_): Primals of 
-000134f0: 7468 6520 6675 6e63 7469 6f6e 2e0a 2320  the function..# 
-00013500: 2020 2020 2020 2020 7461 6e67 656e 7473          tangents
-00013510: 2028 5f74 7970 655f 293a 2054 616e 6765   (_type_): Tange
-00013520: 6e74 7320 6f66 2074 6865 2066 756e 6374  nts of the funct
-00013530: 696f 6e2e 0a23 2020 2020 2020 2020 2065  ion..#         e
-00013540: 7865 6375 746f 7220 2873 7472 2c20 6f70  xecutor (str, op
-00013550: 7469 6f6e 616c 293a 2045 7865 6375 746f  tional): Executo
-00013560: 7220 746f 2075 7365 2e20 4465 6661 756c  r to use. Defaul
-00013570: 7473 2074 6f20 2274 6f72 6368 222e 0a0a  ts to "torch"...
-00013580: 2320 2020 2020 5265 7475 726e 733a 0a23  #     Returns:.#
-00013590: 2020 2020 2020 2020 2054 6865 2072 6573           The res
-000135a0: 756c 7420 6f66 2074 6865 204a 6163 6f62  ult of the Jacob
-000135b0: 6961 6e2d 7665 6374 6f72 2070 726f 6475  ian-vector produ
-000135c0: 6374 2e0a 2320 2020 2020 2222 220a 2320  ct..#     """.# 
-000135d0: 2020 2020 7472 6163 6520 3d20 6d61 6b65      trace = make
-000135e0: 5f74 7261 6365 2866 756e 632c 2065 7865  _trace(func, exe
-000135f0: 6375 746f 723d 6578 6563 7574 6f72 2c20  cutor=executor, 
-00013600: 2a70 7269 6d61 6c73 290a 0a23 2020 2020  *primals)..#    
-00013610: 2064 6566 206a 7670 5f66 756e 6328 2a70   def jvp_func(*p
-00013620: 7269 6d61 6c73 5f61 6e64 5f74 616e 6765  rimals_and_tange
-00013630: 6e74 7329 3a0a 2320 2020 2020 2020 2020  nts):.#         
-00013640: 5f70 7269 6d61 6c73 2c20 5f74 616e 6765  _primals, _tange
-00013650: 6e74 7320 3d20 7072 696d 616c 735f 616e  nts = primals_an
-00013660: 645f 7461 6e67 656e 7473 5b3a 206c 656e  d_tangents[: len
-00013670: 2870 7269 6d61 6c73 295d 2c20 7072 696d  (primals)], prim
-00013680: 616c 735f 616e 645f 7461 6e67 656e 7473  als_and_tangents
-00013690: 5b6c 656e 2870 7269 6d61 6c73 2920 3a5d  [len(primals) :]
-000136a0: 0a23 2020 2020 2020 2020 2072 6574 7572  .#         retur
-000136b0: 6e20 5f6a 7670 5f63 616c 6c5f 6d65 7461  n _jvp_call_meta
-000136c0: 6675 6e63 285f 7072 696d 616c 732c 205f  func(_primals, _
-000136d0: 7461 6e67 656e 7473 2c20 7472 6163 652c  tangents, trace,
-000136e0: 2064 6574 6163 6865 643d 4661 6c73 6529   detached=False)
-000136f0: 0a0a 2320 2020 2020 6a76 705f 7472 6163  ..#     jvp_trac
-00013700: 6520 3d20 6d61 6b65 5f74 7261 6365 286a  e = make_trace(j
-00013710: 7670 5f66 756e 632c 2065 7865 6375 746f  vp_func, executo
-00013720: 723d 6578 6563 7574 6f72 2928 2a70 7269  r=executor)(*pri
-00013730: 6d61 6c73 2c20 2a74 616e 6765 6e74 7329  mals, *tangents)
-00013740: 0a23 2020 2020 206a 7670 5f74 7261 6365  .#     jvp_trace
-00013750: 6420 3d20 6d61 6b65 5f74 7261 6365 6428  d = make_traced(
-00013760: 7061 7274 6961 6c28 6576 616c 5f74 7261  partial(eval_tra
-00013770: 6365 2c20 6a76 705f 7472 6163 6529 2c20  ce, jvp_trace), 
-00013780: 6578 6563 7574 6f72 3d65 7865 6375 746f  executor=executo
-00013790: 7229 0a23 2020 2020 2072 6574 7572 6e20  r).#     return 
-000137a0: 6a76 705f 7472 6163 6564 282a 7072 696d  jvp_traced(*prim
-000137b0: 616c 732c 202a 7461 6e67 656e 7473 290a  als, *tangents).
-000137c0: 0a0a 2320 564a 5020 7472 616e 7366 6f72  ..# VJP transfor
-000137d0: 6d0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  m.# ============
-000137e0: 3d0a 4064 6174 6163 6c61 7373 2866 726f  =.@dataclass(fro
-000137f0: 7a65 6e3d 5472 7565 290a 636c 6173 7320  zen=True).class 
-00013800: 564a 5044 7561 6c3a 0a20 2020 2022 2222  VJPDual:.    """
-00013810: 4120 7061 6972 206f 6620 7072 696d 616c  A pair of primal
-00013820: 2061 6e64 2073 6176 6564 2069 6e66 6f72   and saved infor
-00013830: 6d61 7469 6f6e 2066 6f72 2062 6163 6b77  mation for backw
-00013840: 6172 6420 2872 6573 6964 7561 6c73 292e  ard (residuals).
-00013850: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00013860: 2020 2020 7072 696d 616c 2028 556e 696f      primal (Unio
-00013870: 6e5b 5072 6f78 792c 204e 756d 6265 725d  n[Proxy, Number]
-00013880: 293a 2050 7269 6d61 6c20 7661 6c75 652c  ): Primal value,
-00013890: 2069 2e65 2e2c 2074 6865 2076 616c 7565   i.e., the value
-000138a0: 2062 6569 6e67 2064 6966 6665 7265 6e74   being different
-000138b0: 6961 7465 642e 0a20 2020 2020 2020 2072  iated..        r
-000138c0: 6573 6964 7561 6c73 2028 5475 706c 655b  esiduals (Tuple[
-000138d0: 5072 6f78 792c 202e 2e2e 5d29 3a20 5265  Proxy, ...]): Re
-000138e0: 7369 6475 616c 732c 2069 2e65 2e2c 2074  siduals, i.e., t
-000138f0: 6865 2076 616c 7565 7320 7468 6174 2061  he values that a
-00013900: 7265 0a20 2020 2020 2020 2020 2020 2073  re.            s
-00013910: 6176 6564 2066 6f72 2074 6865 2062 6163  aved for the bac
-00013920: 6b77 6172 642e 0a0a 2020 2020 5969 656c  kward...    Yiel
-00013930: 6473 3a0a 2020 2020 2020 2020 5475 706c  ds:.        Tupl
-00013940: 655b 5661 7269 6162 6c65 2c20 5475 706c  e[Variable, Tupl
-00013950: 655b 5661 7269 6162 6c65 2c20 2e2e 2e5d  e[Variable, ...]
-00013960: 2c20 4361 6c6c 6162 6c65 5d3a 2050 7269  , Callable]: Pri
-00013970: 6d61 6c20 616e 6420 7265 7369 6475 616c  mal and residual
-00013980: 730a 2020 2020 2222 220a 0a20 2020 2070  s.    """..    p
-00013990: 7269 6d61 6c3a 2050 726f 7879 207c 204e  rimal: Proxy | N
-000139a0: 756d 6265 720a 2020 2020 7265 7369 6475  umber.    residu
-000139b0: 616c 733a 2074 7570 6c65 5b50 726f 7879  als: tuple[Proxy
-000139c0: 2c20 2e2e 2e5d 0a0a 2020 2020 6465 6620  , ...]..    def 
-000139d0: 5f5f 6974 6572 5f5f 2873 656c 6629 3a0a  __iter__(self):.
-000139e0: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
-000139f0: 6c66 2e70 7269 6d61 6c0a 2020 2020 2020  lf.primal.      
-00013a00: 2020 7969 656c 6420 7365 6c66 2e72 6573    yield self.res
-00013a10: 6964 7561 6c73 0a0a 0a63 6c61 7373 204e  iduals...class N
-00013a20: 6f50 756c 6c62 6163 6b3a 0a20 2020 2022  oPullback:.    "
-00013a30: 2222 4120 6475 6d6d 7920 7075 6c6c 6261  ""A dummy pullba
-00013a40: 636b 2066 756e 6374 696f 6e20 7468 6174  ck function that
-00013a50: 2072 6574 7572 6e73 204e 6f6e 6520 6f72   returns None or
-00013a60: 2072 6169 7365 7320 616e 2065 7272 6f72   raises an error
-00013a70: 2e22 2222 0a0a 2020 2020 6465 6620 5f5f  ."""..    def __
-00013a80: 696e 6974 5f5f 2873 656c 662c 206e 756d  init__(self, num
-00013a90: 5f61 7267 733d 3029 3a0a 2020 2020 2020  _args=0):.      
-00013aa0: 2020 7365 6c66 2e6e 756d 5f61 7267 7320    self.num_args 
-00013ab0: 3d20 6e75 6d5f 6172 6773 0a0a 2020 2020  = num_args..    
-00013ac0: 6465 6620 5f5f 6361 6c6c 5f5f 2873 656c  def __call__(sel
-00013ad0: 662c 202a 6172 6773 2c20 2a2a 6b77 6172  f, *args, **kwar
-00013ae0: 6773 293a 0a20 2020 2020 2020 2069 6620  gs):.        if 
-00013af0: 7365 6c66 2e6e 756d 5f61 7267 7320 3e20  self.num_args > 
-00013b00: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
-00013b10: 6574 7572 6e20 284e 6f6e 652c 2920 2a20  eturn (None,) * 
-00013b20: 7365 6c66 2e6e 756d 5f61 7267 730a 2020  self.num_args.  
-00013b30: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-00013b40: 696d 6545 7272 6f72 2822 5075 6c6c 6261  imeError("Pullba
-00013b50: 636b 2063 616c 6c65 6420 6f6e 2061 206e  ck called on a n
-00013b60: 6f6e 2d64 6966 6665 7265 6e74 6961 626c  on-differentiabl
-00013b70: 6520 7379 6d62 6f6c 206f 7220 6120 636f  e symbol or a co
-00013b80: 6e73 7461 6e74 2e22 290a 0a0a 636c 6173  nstant.")...clas
-00013b90: 7320 5a65 726f 4261 636b 7761 7264 3a0a  s ZeroBackward:.
-00013ba0: 2020 2020 2222 2241 2068 656c 7065 7220      """A helper 
-00013bb0: 6261 636b 7761 7264 2066 756e 6374 696f  backward functio
-00013bc0: 6e20 7468 6174 2072 6574 7572 6e73 207a  n that returns z
-00013bd0: 6572 6f73 2e22 2222 0a0a 2020 2020 6465  eros."""..    de
-00013be0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00013bf0: 206e 756d 5f61 7267 7329 3a0a 2020 2020   num_args):.    
-00013c00: 2020 2020 7365 6c66 2e6e 756d 5f61 7267      self.num_arg
-00013c10: 7320 3d20 6e75 6d5f 6172 6773 0a0a 2020  s = num_args..  
-00013c20: 2020 6465 6620 5f5f 6361 6c6c 5f5f 2873    def __call__(s
-00013c30: 656c 662c 202a 6172 6773 2c20 2a2a 6b77  elf, *args, **kw
-00013c40: 6172 6773 293a 0a20 2020 2020 2020 2023  args):.        #
-00013c50: 2041 7373 756d 696e 6720 7468 6174 2074   Assuming that t
-00013c60: 6865 2066 6972 7374 2061 7267 756d 656e  he first argumen
-00013c70: 7473 2061 7265 2074 6865 2066 6f72 7761  ts are the forwa
-00013c80: 7264 2061 7267 756d 656e 7473 0a20 2020  rd arguments.   
-00013c90: 2020 2020 2066 6f72 7761 7264 5f61 7267       forward_arg
-00013ca0: 7320 3d20 6172 6773 5b3a 2073 656c 662e  s = args[: self.
-00013cb0: 6e75 6d5f 6172 6773 5d0a 0a20 2020 2020  num_args]..     
-00013cc0: 2020 2064 6566 207a 6572 6f73 5f6c 696b     def zeros_lik
-00013cd0: 6528 7829 3a0a 2020 2020 2020 2020 2020  e(x):.          
-00013ce0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00013cf0: 782c 2054 656e 736f 7250 726f 7879 293a  x, TensorProxy):
-00013d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013d10: 2072 6574 7572 6e20 6675 6c6c 5f6c 696b   return full_lik
-00013d20: 6528 782c 2066 696c 6c5f 7661 6c75 653d  e(x, fill_value=
-00013d30: 3029 0a20 2020 2020 2020 2020 2020 2065  0).            e
-00013d40: 6c69 6620 6973 696e 7374 616e 6365 2878  lif isinstance(x
-00013d50: 2c20 4e75 6d62 6572 5072 6f78 7929 3a0a  , NumberProxy):.
-00013d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d70: 7265 7475 726e 2074 7970 6528 782e 7661  return type(x.va
-00013d80: 6c75 6529 2830 290a 2020 2020 2020 2020  lue)(0).        
-00013d90: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00013da0: 6e63 6528 782c 204e 756d 6265 7229 3a0a  nce(x, Number):.
-00013db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013dc0: 7265 7475 726e 2074 7970 6528 7829 2830  return type(x)(0
-00013dd0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00013de0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00013df0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00013e00: 7272 6f72 2866 227a 6572 6f73 5f6c 696b  rror(f"zeros_lik
-00013e10: 6520 696e 7369 6465 205a 6572 6f42 6163  e inside ZeroBac
-00013e20: 6b77 6172 6420 676f 7420 616e 2075 6e73  kward got an uns
-00013e30: 7570 706f 7274 6564 2074 7970 6520 7b74  upported type {t
-00013e40: 7970 6528 7829 7d22 290a 0a20 2020 2020  ype(x)}")..     
-00013e50: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
-00013e60: 7a65 726f 735f 6c69 6b65 2861 7267 2920  zeros_like(arg) 
-00013e70: 666f 7220 6172 6720 696e 2066 6f72 7761  for arg in forwa
-00013e80: 7264 5f61 7267 7329 0a0a 0a23 204d 6170  rd_args)...# Map
-00013e90: 7069 6e67 2066 726f 6d20 7379 6d62 6f6c  ping from symbol
-00013ea0: 7320 746f 2061 7567 6d65 6e74 6564 2070  s to augmented p
-00013eb0: 7269 6d61 6c20 2866 6f72 7761 7264 2920  rimal (forward) 
-00013ec0: 6675 6e63 7469 6f6e 7320 7573 6564 2069  functions used i
-00013ed0: 6e20 564a 500a 2320 5468 6520 6175 676d  n VJP.# The augm
-00013ee0: 656e 7465 645f 7072 696d 616c 2066 756e  ented_primal fun
-00013ef0: 6374 696f 6e20 7461 6b65 7320 7468 6520  ction takes the 
-00013f00: 7072 696d 616c 2076 616c 7565 7320 616e  primal values an
-00013f10: 6420 7265 7475 726e 7320 7468 6520 7072  d returns the pr
-00013f20: 696d 616c 0a23 2072 6573 756c 7420 616e  imal.# result an
-00013f30: 6420 7468 6520 7265 7369 6475 616c 7320  d the residuals 
-00013f40: 2873 6176 6564 2076 616c 7565 7320 666f  (saved values fo
-00013f50: 7220 7468 6520 6261 636b 7761 7264 292e  r the backward).
-00013f60: 0a61 7567 6d65 6e74 6564 5f66 6f72 7761  .augmented_forwa
-00013f70: 7264 5f69 6d70 6c73 203d 207b 0a20 2020  rd_impls = {.   
-00013f80: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
-00013f90: 434f 533a 206c 616d 6264 6120 783a 2028  COS: lambda x: (
-00013fa0: 7072 696d 732e 6163 6f73 2878 292c 2028  prims.acos(x), (
-00013fb0: 782c 2929 2c0a 2020 2020 7072 696d 732e  x,)),.    prims.
-00013fc0: 5072 696d 4944 732e 4143 4f53 483a 206c  PrimIDs.ACOSH: l
-00013fd0: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
-00013fe0: 6163 6f73 6828 7829 2c20 2878 2c29 292c  acosh(x), (x,)),
-00013ff0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014000: 4473 2e41 5349 4e3a 206c 616d 6264 6120  Ds.ASIN: lambda 
-00014010: 783a 2028 7072 696d 732e 6173 696e 2878  x: (prims.asin(x
-00014020: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
-00014030: 696d 732e 5072 696d 4944 732e 4153 494e  ims.PrimIDs.ASIN
-00014040: 483a 206c 616d 6264 6120 783a 2028 7072  H: lambda x: (pr
-00014050: 696d 732e 6173 696e 6828 7829 2c20 2878  ims.asinh(x), (x
-00014060: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014070: 7269 6d49 4473 2e41 5441 4e3a 206c 616d  rimIDs.ATAN: lam
-00014080: 6264 6120 783a 2028 7072 696d 732e 6174  bda x: (prims.at
-00014090: 616e 2878 292c 2028 782c 2929 2c0a 2020  an(x), (x,)),.  
-000140a0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-000140b0: 4154 414e 483a 206c 616d 6264 6120 783a  ATANH: lambda x:
-000140c0: 2028 7072 696d 732e 6174 616e 6828 7829   (prims.atanh(x)
-000140d0: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
-000140e0: 6d73 2e50 7269 6d49 4473 2e41 5441 4e32  ms.PrimIDs.ATAN2
-000140f0: 3a20 6c61 6d62 6461 2078 2c20 793a 2028  : lambda x, y: (
-00014100: 7072 696d 732e 6174 616e 3228 782c 2079  prims.atan2(x, y
-00014110: 292c 2028 782c 2079 2929 2c0a 2020 2020  ), (x, y)),.    
-00014120: 7072 696d 732e 5072 696d 4944 732e 434f  prims.PrimIDs.CO
-00014130: 5348 3a20 6c61 6d62 6461 2078 3a20 2870  SH: lambda x: (p
-00014140: 7269 6d73 2e63 6f73 6828 7829 2c20 2878  rims.cosh(x), (x
-00014150: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014160: 7269 6d49 4473 2e44 4947 414d 4d41 3a20  rimIDs.DIGAMMA: 
-00014170: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-00014180: 2e64 6967 616d 6d61 2878 292c 2028 782c  .digamma(x), (x,
-00014190: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-000141a0: 696d 4944 732e 4552 4643 3a20 6c61 6d62  imIDs.ERFC: lamb
-000141b0: 6461 2078 3a20 2870 7269 6d73 2e65 7266  da x: (prims.erf
-000141c0: 6328 7829 2c20 2878 2c29 292c 0a20 2020  c(x), (x,)),.   
-000141d0: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
-000141e0: 5246 494e 563a 206c 616d 6264 6120 783a  RFINV: lambda x:
-000141f0: 2028 7072 696d 732e 6572 6669 6e76 2878   (prims.erfinv(x
-00014200: 292c 2028 7072 696d 732e 6572 6669 6e76  ), (prims.erfinv
-00014210: 2878 292c 2929 2c0a 2020 2020 7072 696d  (x),)),.    prim
-00014220: 732e 5072 696d 4944 732e 4552 4643 494e  s.PrimIDs.ERFCIN
-00014230: 563a 206c 616d 6264 6120 783a 2028 7072  V: lambda x: (pr
-00014240: 696d 732e 6572 6663 696e 7628 7829 2c20  ims.erfcinv(x), 
-00014250: 2870 7269 6d73 2e65 7266 6369 6e76 2878  (prims.erfcinv(x
-00014260: 292c 2929 2c0a 2020 2020 7072 696d 732e  ),)),.    prims.
-00014270: 5072 696d 4944 732e 4558 5032 3a20 6c61  PrimIDs.EXP2: la
-00014280: 6d62 6461 2078 3a20 2870 7269 6d73 2e65  mbda x: (prims.e
-00014290: 7870 3228 7829 2c20 2870 7269 6d73 2e65  xp2(x), (prims.e
-000142a0: 7870 3228 7829 2c29 292c 0a20 2020 2070  xp2(x),)),.    p
-000142b0: 7269 6d73 2e50 7269 6d49 4473 2e45 5850  rims.PrimIDs.EXP
-000142c0: 4d31 3a20 6c61 6d62 6461 2078 3a20 2870  M1: lambda x: (p
-000142d0: 7269 6d73 2e65 7870 6d31 2878 292c 2028  rims.expm1(x), (
-000142e0: 7072 696d 732e 6578 706d 3128 7829 2c29  prims.expm1(x),)
-000142f0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00014300: 6d49 4473 2e4c 4741 4d4d 413a 206c 616d  mIDs.LGAMMA: lam
-00014310: 6264 6120 783a 2028 7072 696d 732e 6c67  bda x: (prims.lg
-00014320: 616d 6d61 2878 292c 2028 782c 2929 2c0a  amma(x), (x,)),.
-00014330: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014340: 732e 4e44 5452 493a 206c 616d 6264 6120  s.NDTRI: lambda 
-00014350: 783a 2028 7072 696d 732e 6e64 7472 6928  x: (prims.ndtri(
-00014360: 7829 2c20 2870 7269 6d73 2e6e 6474 7269  x), (prims.ndtri
-00014370: 2878 292c 2929 2c0a 2020 2020 7072 696d  (x),)),.    prim
-00014380: 732e 5072 696d 4944 732e 5349 4e48 3a20  s.PrimIDs.SINH: 
-00014390: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-000143a0: 2e73 696e 6828 7829 2c20 2878 2c29 292c  .sinh(x), (x,)),
-000143b0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-000143c0: 4473 2e53 5152 543a 206c 616d 6264 6120  Ds.SQRT: lambda 
-000143d0: 783a 2028 7072 696d 732e 7371 7274 2878  x: (prims.sqrt(x
-000143e0: 292c 2028 7072 696d 732e 7371 7274 2878  ), (prims.sqrt(x
-000143f0: 292c 2929 2c0a 2020 2020 7072 696d 732e  ),)),.    prims.
-00014400: 5072 696d 4944 732e 4e45 3a20 6c61 6d62  PrimIDs.NE: lamb
-00014410: 6461 2078 2c20 793a 2028 7072 696d 732e  da x, y: (prims.
-00014420: 6e65 2878 2c20 7929 2c20 2878 2c20 7929  ne(x, y), (x, y)
-00014430: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00014440: 6d49 4473 2e47 543a 206c 616d 6264 6120  mIDs.GT: lambda 
-00014450: 782c 2079 3a20 2870 7269 6d73 2e67 7428  x, y: (prims.gt(
-00014460: 782c 2079 292c 2028 782c 2079 2929 2c0a  x, y), (x, y)),.
-00014470: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014480: 732e 4c45 3a20 6c61 6d62 6461 2078 2c20  s.LE: lambda x, 
-00014490: 793a 2028 7072 696d 732e 6c65 2878 2c20  y: (prims.le(x, 
-000144a0: 7929 2c20 2878 2c20 7929 292c 0a20 2020  y), (x, y)),.   
-000144b0: 2070 7269 6d73 2e50 7269 6d49 4473 2e4c   prims.PrimIDs.L
-000144c0: 4f47 3130 3a20 6c61 6d62 6461 2078 3a20  OG10: lambda x: 
-000144d0: 2870 7269 6d73 2e6c 6f67 3130 2878 292c  (prims.log10(x),
-000144e0: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
-000144f0: 732e 5072 696d 4944 732e 4c4f 4731 503a  s.PrimIDs.LOG1P:
-00014500: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
-00014510: 732e 6c6f 6731 7028 7829 2c20 2878 2c29  s.log1p(x), (x,)
-00014520: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00014530: 6d49 4473 2e4c 4f47 323a 206c 616d 6264  mIDs.LOG2: lambd
-00014540: 6120 783a 2028 7072 696d 732e 6c6f 6732  a x: (prims.log2
-00014550: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
-00014560: 7072 696d 732e 5072 696d 4944 732e 5a45  prims.PrimIDs.ZE
-00014570: 5441 3a20 6c61 6d62 6461 2078 2c20 793a  TA: lambda x, y:
-00014580: 2028 7072 696d 732e 7a65 7461 2878 2c20   (prims.zeta(x, 
-00014590: 7929 2c20 2878 2c20 7929 292c 0a20 2020  y), (x, y)),.   
-000145a0: 2070 7269 6d73 2e50 7269 6d49 4473 2e46   prims.PrimIDs.F
-000145b0: 4d4f 443a 206c 616d 6264 6120 782c 2079  MOD: lambda x, y
-000145c0: 3a20 2870 7269 6d73 2e66 6d6f 6428 782c  : (prims.fmod(x,
-000145d0: 2079 292c 2028 782c 2079 2929 2c0a 2020   y), (x, y)),.  
-000145e0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-000145f0: 434f 5059 5f3a 206c 616d 6264 6120 782c  COPY_: lambda x,
-00014600: 2079 3a20 2870 7269 6d73 2e63 6f70 795f   y: (prims.copy_
-00014610: 2878 2c20 7929 2c20 7475 706c 6528 2929  (x, y), tuple())
-00014620: 2c0a 7d0a 0a0a 2320 4d61 7070 696e 6720  ,.}...# Mapping 
-00014630: 6672 6f6d 2073 796d 626f 6c73 2074 6f20  from symbols to 
-00014640: 6261 636b 7761 7264 2066 756e 6374 696f  backward functio
-00014650: 6e73 2075 7365 6420 696e 2056 4a50 0a23  ns used in VJP.#
-00014660: 2054 6865 2062 6163 6b77 6172 6420 6675   The backward fu
-00014670: 6e63 7469 6f6e 2074 616b 6573 2074 6865  nction takes the
-00014680: 2072 6573 6964 7561 6c73 2061 6e64 2063   residuals and c
-00014690: 6f74 616e 6765 6e74 7320 616e 6420 7265  otangents and re
-000146a0: 7475 726e 7320 7468 650a 2320 7665 6374  turns the.# vect
-000146b0: 6f72 2d4a 6163 6f62 6961 6e20 7072 6f64  or-Jacobian prod
-000146c0: 7563 7473 2066 6f72 2065 6163 6820 6172  ucts for each ar
-000146d0: 6775 6d65 6e74 2e0a 6261 636b 7761 7264  gument..backward
-000146e0: 5f69 6d70 6c73 203d 207b 0a20 2020 2070  _impls = {.    p
-000146f0: 7269 6d73 2e50 7269 6d49 4473 2e41 434f  rims.PrimIDs.ACO
-00014700: 533a 206c 616d 6264 6120 782c 2067 3a20  S: lambda x, g: 
-00014710: 2d67 202f 2070 7269 6d73 2e73 7172 7428  -g / prims.sqrt(
-00014720: 312e 3020 2d20 7820 2a20 7829 2c0a 2020  1.0 - x * x),.  
-00014730: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014740: 4143 4f53 483a 206c 616d 6264 6120 782c  ACOSH: lambda x,
-00014750: 2067 3a20 6720 2a20 7072 696d 732e 7273   g: g * prims.rs
-00014760: 7172 7428 7820 2a20 7820 2d20 312e 3029  qrt(x * x - 1.0)
-00014770: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014780: 4944 732e 4153 494e 3a20 6c61 6d62 6461  IDs.ASIN: lambda
-00014790: 2078 2c20 673a 2067 202f 2070 7269 6d73   x, g: g / prims
-000147a0: 2e73 7172 7428 312e 3020 2d20 7820 2a20  .sqrt(1.0 - x * 
-000147b0: 7829 2c0a 2020 2020 7072 696d 732e 5072  x),.    prims.Pr
-000147c0: 696d 4944 732e 4153 494e 483a 206c 616d  imIDs.ASINH: lam
-000147d0: 6264 6120 782c 2067 3a20 6720 2a20 7072  bda x, g: g * pr
-000147e0: 696d 732e 7273 7172 7428 312e 3020 2b20  ims.rsqrt(1.0 + 
-000147f0: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
-00014800: 732e 5072 696d 4944 732e 4154 414e 3a20  s.PrimIDs.ATAN: 
-00014810: 6c61 6d62 6461 2078 2c20 673a 2067 202f  lambda x, g: g /
-00014820: 2028 312e 3020 2b20 7820 2a20 7829 2c0a   (1.0 + x * x),.
-00014830: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014840: 732e 4154 414e 483a 206c 616d 6264 6120  s.ATANH: lambda 
-00014850: 782c 2067 3a20 6720 2f20 2831 2e30 202d  x, g: g / (1.0 -
-00014860: 2078 202a 2078 292c 0a20 2020 2070 7269   x * x),.    pri
-00014870: 6d73 2e50 7269 6d49 4473 2e43 4f53 483a  ms.PrimIDs.COSH:
-00014880: 206c 616d 6264 6120 782c 2067 3a20 7072   lambda x, g: pr
-00014890: 696d 732e 6d75 6c28 672c 2070 7269 6d73  ims.mul(g, prims
-000148a0: 2e73 696e 6828 7829 292c 0a20 2020 2070  .sinh(x)),.    p
-000148b0: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
-000148c0: 433a 206c 616d 6264 6120 782c 2067 3a20  C: lambda x, g: 
-000148d0: 2d67 202a 2032 2e30 202f 206d 6174 682e  -g * 2.0 / math.
-000148e0: 7371 7274 286d 6174 682e 7069 2920 2a20  sqrt(math.pi) * 
-000148f0: 7072 696d 732e 6578 7028 2d78 202a 2078  prims.exp(-x * x
-00014900: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00014910: 6d49 4473 2e45 5246 494e 563a 206c 616d  mIDs.ERFINV: lam
-00014920: 6264 6120 7265 7375 6c74 2c20 673a 2067  bda result, g: g
-00014930: 202a 2030 2e35 202a 206d 6174 682e 7371   * 0.5 * math.sq
-00014940: 7274 286d 6174 682e 7069 2920 2a20 7072  rt(math.pi) * pr
-00014950: 696d 732e 6578 7028 7265 7375 6c74 2a2a  ims.exp(result**
-00014960: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
-00014970: 696d 4944 732e 4552 4643 494e 563a 206c  imIDs.ERFCINV: l
-00014980: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
-00014990: 202d 6720 2a20 302e 3520 2a20 6d61 7468   -g * 0.5 * math
-000149a0: 2e73 7172 7428 6d61 7468 2e70 6929 202a  .sqrt(math.pi) *
-000149b0: 2070 7269 6d73 2e65 7870 2872 6573 756c   prims.exp(resul
-000149c0: 742a 2a32 292c 0a20 2020 2070 7269 6d73  t**2),.    prims
-000149d0: 2e50 7269 6d49 4473 2e45 5850 323a 206c  .PrimIDs.EXP2: l
-000149e0: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
-000149f0: 2067 202a 2072 6573 756c 7420 2a20 6d61   g * result * ma
-00014a00: 7468 2e6c 6f67 2832 2e30 292c 0a20 2020  th.log(2.0),.   
-00014a10: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
-00014a20: 5850 4d31 3a20 6c61 6d62 6461 2072 6573  XPM1: lambda res
-00014a30: 756c 742c 2067 3a20 6720 2a20 2872 6573  ult, g: g * (res
-00014a40: 756c 7420 2b20 312e 3029 2c0a 2020 2020  ult + 1.0),.    
-00014a50: 7072 696d 732e 5072 696d 4944 732e 4c47  prims.PrimIDs.LG
-00014a60: 414d 4d41 3a20 6c61 6d62 6461 2078 2c20  AMMA: lambda x, 
-00014a70: 673a 2067 202a 2070 7269 6d73 2e64 6967  g: g * prims.dig
-00014a80: 616d 6d61 2878 292c 0a20 2020 2070 7269  amma(x),.    pri
-00014a90: 6d73 2e50 7269 6d49 4473 2e4e 4454 5249  ms.PrimIDs.NDTRI
-00014aa0: 3a20 6c61 6d62 6461 2072 6573 756c 742c  : lambda result,
-00014ab0: 2067 3a20 6720 2a20 7072 696d 732e 6578   g: g * prims.ex
-00014ac0: 7028 302e 3520 2a20 7265 7375 6c74 2a2a  p(0.5 * result**
-00014ad0: 3229 202a 206d 6174 682e 7371 7274 2832  2) * math.sqrt(2
-00014ae0: 2e30 202a 206d 6174 682e 7069 292c 0a20  .0 * math.pi),. 
-00014af0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014b00: 2e53 494e 483a 206c 616d 6264 6120 782c  .SINH: lambda x,
-00014b10: 2067 3a20 7072 696d 732e 6d75 6c28 672c   g: prims.mul(g,
-00014b20: 2070 7269 6d73 2e63 6f73 6828 7829 292c   prims.cosh(x)),
-00014b30: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014b40: 4473 2e53 5152 543a 206c 616d 6264 6120  Ds.SQRT: lambda 
-00014b50: 7265 7375 6c74 2c20 673a 2067 202f 2028  result, g: g / (
-00014b60: 322e 3020 2a20 7265 7375 6c74 292c 0a20  2.0 * result),. 
-00014b70: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014b80: 2e4e 453a 205a 6572 6f42 6163 6b77 6172  .NE: ZeroBackwar
-00014b90: 6428 6e75 6d5f 6172 6773 3d32 292c 0a20  d(num_args=2),. 
-00014ba0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014bb0: 2e47 543a 205a 6572 6f42 6163 6b77 6172  .GT: ZeroBackwar
-00014bc0: 6428 6e75 6d5f 6172 6773 3d32 292c 0a20  d(num_args=2),. 
-00014bd0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014be0: 2e4c 453a 205a 6572 6f42 6163 6b77 6172  .LE: ZeroBackwar
-00014bf0: 6428 6e75 6d5f 6172 6773 3d32 292c 0a20  d(num_args=2),. 
-00014c00: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014c10: 2e4c 4f47 3130 3a20 6c61 6d62 6461 2078  .LOG10: lambda x
-00014c20: 2c20 673a 2067 202f 2028 7820 2a20 322e  , g: g / (x * 2.
-00014c30: 3330 3235 3835 3039 3239 3934 3034 3629  302585092994046)
-00014c40: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014c50: 4944 732e 4c4f 4731 503a 206c 616d 6264  IDs.LOG1P: lambd
-00014c60: 6120 782c 2067 3a20 6720 2f20 2878 202b  a x, g: g / (x +
-00014c70: 2031 292c 0a20 2020 2070 7269 6d73 2e50   1),.    prims.P
-00014c80: 7269 6d49 4473 2e4c 4f47 323a 206c 616d  rimIDs.LOG2: lam
-00014c90: 6264 6120 782c 2067 3a20 6720 2f20 2878  bda x, g: g / (x
-00014ca0: 202a 2030 2e36 3933 3134 3731 3830 3535   * 0.69314718055
-00014cb0: 3939 3435 3329 2c0a 2020 2020 7072 696d  99453),.    prim
-00014cc0: 732e 5072 696d 4944 732e 464d 4f44 3a20  s.PrimIDs.FMOD: 
-00014cd0: 6c61 6d62 6461 2078 2c20 792c 2067 3a20  lambda x, y, g: 
-00014ce0: 2867 2c20 2d67 202a 2070 7269 6d73 2e74  (g, -g * prims.t
-00014cf0: 7275 6e63 2878 202f 2079 2929 2c0a 2020  runc(x / y)),.  
-00014d00: 2020 2320 5468 6520 636f 7079 2073 686f    # The copy sho
-00014d10: 756c 6420 6e6f 7420 6265 2064 6966 6665  uld not be diffe
-00014d20: 7265 6e74 6961 626c 652e 2057 6520 7265  rentiable. We re
-00014d30: 7475 726e 204e 6f6e 6520 746f 2065 6e61  turn None to ena
-00014d40: 626c 6520 7468 6520 6765 6e65 7261 7469  ble the generati
-00014d50: 6f6e 206f 6620 7468 6520 6261 636b 7761  on of the backwa
-00014d60: 7264 2067 7261 7068 2074 6872 6f75 6768  rd graph through
-00014d70: 2074 6865 6d2e 0a20 2020 2070 7269 6d73   them..    prims
-00014d80: 2e50 7269 6d49 4473 2e43 4f50 595f 3a20  .PrimIDs.COPY_: 
-00014d90: 6c61 6d62 6461 2067 3a20 284e 6f6e 652c  lambda g: (None,
-00014da0: 204e 6f6e 6529 2c0a 7d0a 0a0a 6465 6620   None),.}...def 
-00014db0: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
-00014dc0: 6564 5f66 6f72 7761 7264 286f 7029 3a0a  ed_forward(op):.
-00014dd0: 2020 2020 2222 2244 6563 6f72 6174 6f72      """Decorator
-00014de0: 2074 6f20 7265 6769 7374 6572 2061 6e20   to register an 
-00014df0: 6175 676d 656e 7465 6420 666f 7277 6172  augmented forwar
-00014e00: 6420 696d 706c 656d 656e 7461 7469 6f6e  d implementation
-00014e10: 2066 6f72 2061 2073 796d 626f 6c2e 0a0a   for a symbol...
-00014e20: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00014e30: 2020 6f70 2028 4f70 7329 3a20 5379 6d62    op (Ops): Symb
-00014e40: 6f6c 2066 6f72 2077 6869 6368 2074 6f20  ol for which to 
-00014e50: 7265 6769 7374 6572 2074 6865 2061 7567  register the aug
-00014e60: 6d65 6e74 6564 2066 6f72 7761 7264 2069  mented forward i
-00014e70: 6d70 6c65 6d65 6e74 6174 696f 6e2e 0a0a  mplementation...
-00014e80: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-00014e90: 2020 2020 2043 616c 6c61 626c 653a 2044       Callable: D
-00014ea0: 6563 6f72 6174 6f72 2066 756e 6374 696f  ecorator functio
-00014eb0: 6e2e 0a20 2020 2022 2222 0a0a 2020 2020  n..    """..    
-00014ec0: 6465 6620 6465 636f 7261 746f 7228 6675  def decorator(fu
-00014ed0: 6e63 293a 0a20 2020 2020 2020 2061 7567  nc):.        aug
-00014ee0: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
-00014ef0: 6d70 6c73 5b6f 705d 203d 2066 756e 630a  mpls[op] = func.
-00014f00: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00014f10: 756e 630a 0a20 2020 2072 6574 7572 6e20  unc..    return 
-00014f20: 6465 636f 7261 746f 720a 0a0a 6465 6620  decorator...def 
-00014f30: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-00014f40: 6428 6f70 293a 0a20 2020 2022 2222 4465  d(op):.    """De
-00014f50: 636f 7261 746f 7220 746f 2072 6567 6973  corator to regis
-00014f60: 7465 7220 6120 6261 636b 7761 7264 2069  ter a backward i
-00014f70: 6d70 6c65 6d65 6e74 6174 696f 6e20 666f  mplementation fo
-00014f80: 7220 6120 7379 6d62 6f6c 2e0a 0a20 2020  r a symbol...   
-00014f90: 2041 7267 733a 0a20 2020 2020 2020 206f   Args:.        o
-00014fa0: 7020 284f 7073 293a 2053 796d 626f 6c20  p (Ops): Symbol 
-00014fb0: 666f 7220 7768 6963 6820 746f 2072 6567  for which to reg
-00014fc0: 6973 7465 7220 7468 6520 6261 636b 7761  ister the backwa
-00014fd0: 7264 2069 6d70 6c65 6d65 6e74 6174 696f  rd implementatio
-00014fe0: 6e2e 0a0a 2020 2020 5265 7475 726e 733a  n...    Returns:
-00014ff0: 0a20 2020 2020 2020 2043 616c 6c61 626c  .        Callabl
-00015000: 653a 2044 6563 6f72 6174 6f72 2066 756e  e: Decorator fun
-00015010: 6374 696f 6e2e 0a20 2020 2022 2222 0a0a  ction..    """..
-00015020: 2020 2020 6465 6620 6465 636f 7261 746f      def decorato
-00015030: 7228 6675 6e63 293a 0a20 2020 2020 2020  r(func):.       
-00015040: 2062 6163 6b77 6172 645f 696d 706c 735b   backward_impls[
-00015050: 6f70 5d20 3d20 6675 6e63 0a20 2020 2020  op] = func.     
-00015060: 2020 2072 6574 7572 6e20 6675 6e63 0a0a     return func..
-00015070: 2020 2020 7265 7475 726e 2064 6563 6f72      return decor
-00015080: 6174 6f72 0a0a 0a64 6566 2072 6573 746f  ator...def resto
-00015090: 7265 5f72 6564 7563 6564 5f64 696d 7328  re_reduced_dims(
-000150a0: 782c 2072 6564 7563 6564 5f64 696d 732c  x, reduced_dims,
-000150b0: 206f 7269 6769 6e61 6c5f 7368 6170 6529   original_shape)
-000150c0: 3a0a 2020 2020 2222 2252 6573 746f 7265  :.    """Restore
-000150d0: 7320 7468 6520 7265 6475 6365 6420 6469  s the reduced di
-000150e0: 6d65 6e73 696f 6e73 206f 6620 6120 7465  mensions of a te
-000150f0: 6e73 6f72 2e0a 0a20 2020 2041 7267 733a  nsor...    Args:
-00015100: 0a20 2020 2020 2020 2078 2028 5661 7269  .        x (Vari
-00015110: 6162 6c65 293a 2054 656e 736f 7220 746f  able): Tensor to
-00015120: 2062 6520 7265 7368 6170 6564 2e0a 2020   be reshaped..  
-00015130: 2020 2020 2020 7265 6475 6365 645f 6469        reduced_di
-00015140: 6d73 2028 5475 706c 655b 696e 742c 202e  ms (Tuple[int, .
-00015150: 2e2e 5d29 3a20 5475 706c 6520 6f66 2072  ..]): Tuple of r
-00015160: 6564 7563 6564 2064 696d 656e 7369 6f6e  educed dimension
-00015170: 732e 0a20 2020 2020 2020 206f 7269 6769  s..        origi
-00015180: 6e61 6c5f 7368 6170 6520 2854 7570 6c65  nal_shape (Tuple
-00015190: 5b69 6e74 2c20 2e2e 2e5d 293a 204f 7269  [int, ...]): Ori
-000151a0: 6769 6e61 6c20 7368 6170 6520 6f66 2074  ginal shape of t
-000151b0: 6865 2074 656e 736f 722e 0a0a 2020 2020  he tensor...    
-000151c0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-000151d0: 2056 6172 6961 626c 653a 2054 656e 736f   Variable: Tenso
-000151e0: 7220 7769 7468 2074 6865 2072 6564 7563  r with the reduc
-000151f0: 6564 2064 696d 656e 7369 6f6e 7320 7265  ed dimensions re
-00015200: 7374 6f72 6564 2e0a 2020 2020 2222 220a  stored..    """.
-00015210: 2020 2020 6966 206f 7269 6769 6e61 6c5f      if original_
-00015220: 7368 6170 6520 3d3d 2028 293a 2020 2320  shape == ():  # 
-00015230: 7363 616c 6172 0a20 2020 2020 2020 2072  scalar.        r
-00015240: 6574 7572 6e20 780a 0a20 2020 2075 6e73  eturn x..    uns
-00015250: 7175 6565 7a65 6420 3d20 636c 616e 672e  queezed = clang.
-00015260: 756e 7371 7565 657a 6528 782c 2072 6564  unsqueeze(x, red
-00015270: 7563 6564 5f64 696d 7329 0a20 2020 2072  uced_dims).    r
-00015280: 6574 7572 6e20 636c 616e 672e 6578 7061  eturn clang.expa
-00015290: 6e64 2875 6e73 7175 6565 7a65 642c 206f  nd(unsqueezed, o
-000152a0: 7269 6769 6e61 6c5f 7368 6170 6529 0a0a  riginal_shape)..
-000152b0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-000152c0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-000152d0: 732e 5a45 5441 290a 6465 6620 7a65 7461  s.ZETA).def zeta
-000152e0: 5f62 6163 6b77 6172 6428 782c 2079 2c20  _backward(x, y, 
-000152f0: 6729 3a0a 2020 2020 2320 5468 6520 6465  g):.    # The de
-00015300: 7269 7661 7469 7665 2077 7274 2074 6865  rivative wrt the
-00015310: 2066 6972 7374 2061 7267 756d 656e 7420   first argument 
-00015320: 6973 206e 6f74 2065 7870 7265 7373 6962  is not expressib
-00015330: 6c65 2069 6e20 7465 726d 7320 6f66 207a  le in terms of z
-00015340: 6574 6120 6f72 0a20 2020 2023 206f 7468  eta or.    # oth
-00015350: 6572 2073 7065 6369 616c 2066 756e 6374  er special funct
-00015360: 696f 6e73 0a20 2020 2023 2054 6865 7265  ions.    # There
-00015370: 666f 7265 2c20 7765 2063 6f6d 7075 7465  fore, we compute
-00015380: 206f 6e6c 7920 7468 6520 6465 7269 7661   only the deriva
-00015390: 7469 7665 2077 7274 2074 6865 2073 6563  tive wrt the sec
-000153a0: 6f6e 6420 6172 6775 6d65 6e74 0a20 2020  ond argument.   
-000153b0: 2067 7920 3d20 6720 2a20 2d78 202a 2070   gy = g * -x * p
-000153c0: 7269 6d73 2e7a 6574 6128 7820 2b20 312e  rims.zeta(x + 1.
-000153d0: 302c 2079 290a 0a20 2020 2023 2052 6574  0, y)..    # Ret
-000153e0: 7572 6e20 6120 6d61 7070 7069 6e67 2066  urn a mappping f
-000153f0: 726f 6d20 7468 6520 666f 7277 6172 6420  rom the forward 
-00015400: 6172 6775 6d65 6e74 7320 746f 2074 6865  arguments to the
-00015410: 2067 7261 6469 656e 7473 0a20 2020 2072   gradients.    r
-00015420: 6574 7572 6e20 7b22 7922 3a20 6779 7d0a  eturn {"y": gy}.
-00015430: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
-00015440: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-00015450: 4473 2e44 4947 414d 4d41 290a 6465 6620  Ds.DIGAMMA).def 
-00015460: 6469 6761 6d6d 615f 6261 636b 7761 7264  digamma_backward
-00015470: 2861 3a20 5072 6f78 792c 2067 293a 0a20  (a: Proxy, g):. 
-00015480: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
-00015490: 746f 7263 6820 696d 706f 7274 2070 6f6c  torch import pol
-000154a0: 7967 616d 6d61 0a0a 2020 2020 7265 7475  ygamma..    retu
-000154b0: 726e 2067 202a 2070 6f6c 7967 616d 6d61  rn g * polygamma
-000154c0: 2831 2c20 6129 0a0a 0a40 7265 6769 7374  (1, a)...@regist
-000154d0: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
-000154e0: 7761 7264 2822 746f 7263 682e 706f 6c79  ward("torch.poly
-000154f0: 6761 6d6d 6122 290a 6465 6620 706f 6c79  gamma").def poly
-00015500: 6761 6d6d 615f 6175 675f 6677 6428 6e3a  gamma_aug_fwd(n:
-00015510: 2069 6e74 2c20 613a 2050 726f 7879 293a   int, a: Proxy):
-00015520: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00015530: 722e 746f 7263 6820 696d 706f 7274 2070  r.torch import p
-00015540: 6f6c 7967 616d 6d61 0a0a 2020 2020 7072  olygamma..    pr
-00015550: 696d 616c 203d 2070 6f6c 7967 616d 6d61  imal = polygamma
-00015560: 286e 2c20 6129 0a20 2020 2072 6573 6964  (n, a).    resid
-00015570: 7561 6c73 203d 2028 6e2c 2061 290a 2020  uals = (n, a).  
-00015580: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-00015590: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
-000155a0: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
-000155b0: 6261 636b 7761 7264 2822 746f 7263 682e  backward("torch.
-000155c0: 706f 6c79 6761 6d6d 6122 290a 6465 6620  polygamma").def 
-000155d0: 706f 6c79 6761 6d6d 615f 6261 636b 7761  polygamma_backwa
-000155e0: 7264 286e 3a20 696e 742c 2061 3a20 5072  rd(n: int, a: Pr
-000155f0: 6f78 792c 2067 293a 0a20 2020 2066 726f  oxy, g):.    fro
-00015600: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
-00015610: 696d 706f 7274 2070 6f6c 7967 616d 6d61  import polygamma
-00015620: 0a0a 2020 2020 7265 7475 726e 204e 6f6e  ..    return Non
-00015630: 652c 2067 202a 2070 6f6c 7967 616d 6d61  e, g * polygamma
-00015640: 286e 202b 2031 2c20 6129 0a0a 0a40 7265  (n + 1, a)...@re
-00015650: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-00015660: 7072 696d 732e 5072 696d 4944 732e 4154  prims.PrimIDs.AT
-00015670: 414e 3229 0a64 6566 2061 7461 6e32 5f62  AN2).def atan2_b
-00015680: 6163 6b77 6172 6428 782c 2079 2c20 6729  ackward(x, y, g)
-00015690: 3a0a 2020 2020 616c 7068 6120 3d20 312e  :.    alpha = 1.
-000156a0: 3020 2f20 2878 202a 2078 202b 2079 202a  0 / (x * x + y *
-000156b0: 2079 290a 2020 2020 6772 6164 5f78 203d   y).    grad_x =
-000156c0: 2067 202a 2079 202a 2061 6c70 6861 0a20   g * y * alpha. 
-000156d0: 2020 2067 7261 645f 7920 3d20 6720 2a20     grad_y = g * 
-000156e0: 2d78 202a 2061 6c70 6861 0a20 2020 2072  -x * alpha.    r
-000156f0: 6574 7572 6e20 6772 6164 5f78 2c20 6772  eturn grad_x, gr
-00015700: 6164 5f79 0a0a 0a40 7265 6769 7374 6572  ad_y...@register
-00015710: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
-00015720: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
-00015730: 2e56 4152 290a 6465 6620 7661 725f 6175  .VAR).def var_au
-00015740: 675f 6677 6428 612c 2064 696d 2c20 2a2c  g_fwd(a, dim, *,
-00015750: 2063 6f72 7265 6374 696f 6e29 3a0a 2020   correction):.  
-00015760: 2020 7620 3d20 7072 696d 732e 7661 7228    v = prims.var(
-00015770: 612c 2064 696d 2c20 636f 7272 6563 7469  a, dim, correcti
-00015780: 6f6e 3d63 6f72 7265 6374 696f 6e29 0a20  on=correction). 
-00015790: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-000157a0: 6c28 2876 2c29 2c20 2861 2c20 6469 6d2c  l((v,), (a, dim,
-000157b0: 2063 6f72 7265 6374 696f 6e2c 2076 2929   correction, v))
-000157c0: 0a0a 0a23 2054 4f44 4f3a 2066 6978 2064  ...# TODO: fix d
-000157d0: 6976 6973 696f 6e20 6279 207a 6572 6f20  ivision by zero 
-000157e0: 7768 656e 206e 5f65 6c65 6d5f 7265 6475  when n_elem_redu
-000157f0: 6365 6420 3d3d 2030 206f 7220 7768 656e  ced == 0 or when
-00015800: 2076 2e6e 756d 656c 203d 3d20 300a 2320   v.numel == 0.# 
-00015810: 6279 2072 6574 7572 6e69 6e67 207a 6572  by returning zer
-00015820: 6f73 5f6c 696b 6528 6129 206f 7220 7369  os_like(a) or si
-00015830: 6d69 6c61 722e 0a23 2054 4f44 4f3a 2066  milar..# TODO: f
-00015840: 6978 2067 7261 6420 7768 656e 2063 6f72  ix grad when cor
-00015850: 7265 6374 696f 6e20 3e20 6e5f 656c 656d  rection > n_elem
-00015860: 5f72 6564 7563 6564 2e0a 4072 6567 6973  _reduced..@regis
-00015870: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
-00015880: 6d73 2e50 7269 6d49 4473 2e56 4152 290a  ms.PrimIDs.VAR).
-00015890: 6465 6620 7661 725f 6261 636b 7761 7264  def var_backward
-000158a0: 2861 2c20 6469 6d2c 2063 6f72 7265 6374  (a, dim, correct
-000158b0: 696f 6e2c 2076 2c20 6729 3a0a 2020 2020  ion, v, g):.    
-000158c0: 6e5f 656c 656d 5f72 6564 7563 6564 203d  n_elem_reduced =
-000158d0: 2061 2e6e 756d 656c 202f 2f20 762e 6e75   a.numel // v.nu
-000158e0: 6d65 6c20 6966 2061 2e6e 756d 656c 2021  mel if a.numel !
-000158f0: 3d20 3020 656c 7365 2031 0a20 2020 206e  = 0 else 1.    n
-00015900: 6f72 6d61 6c69 7a61 7469 6f6e 5f73 6361  ormalization_sca
-00015910: 6c61 7220 3d20 6e5f 656c 656d 5f72 6564  lar = n_elem_red
-00015920: 7563 6564 202d 2063 6f72 7265 6374 696f  uced - correctio
-00015930: 6e0a 2020 2020 6720 3d20 7265 7374 6f72  n.    g = restor
-00015940: 655f 7265 6475 6365 645f 6469 6d73 2867  e_reduced_dims(g
-00015950: 2c20 6469 6d2c 2061 2e73 6861 7065 290a  , dim, a.shape).
-00015960: 2020 2020 6966 2061 2e64 7479 7065 2021      if a.dtype !
-00015970: 3d20 762e 6474 7970 653a 0a20 2020 2020  = v.dtype:.     
-00015980: 2020 2061 203d 2070 7269 6d73 2e63 6f6e     a = prims.con
-00015990: 7665 7274 5f65 6c65 6d65 6e74 5f74 7970  vert_element_typ
-000159a0: 6528 612c 2076 2e64 7479 7065 290a 2020  e(a, v.dtype).  
-000159b0: 2020 6d65 616e 203d 2070 7269 6d73 2e73    mean = prims.s
-000159c0: 756d 2861 2c20 6469 6d29 202f 206e 5f65  um(a, dim) / n_e
-000159d0: 6c65 6d5f 7265 6475 6365 640a 2020 2020  lem_reduced.    
-000159e0: 6d65 616e 203d 2072 6573 746f 7265 5f72  mean = restore_r
-000159f0: 6564 7563 6564 5f64 696d 7328 6d65 616e  educed_dims(mean
-00015a00: 2c20 6469 6d2c 2061 2e73 6861 7065 290a  , dim, a.shape).
-00015a10: 2020 2020 7265 7475 726e 2028 3220 2a20      return (2 * 
-00015a20: 6720 2a20 2861 202d 206d 6561 6e29 2920  g * (a - mean)) 
-00015a30: 2f20 6e6f 726d 616c 697a 6174 696f 6e5f  / normalization_
-00015a40: 7363 616c 6172 0a0a 0a64 6566 206e 5f65  scalar...def n_e
-00015a50: 6c65 6d5f 7265 6475 6365 6428 615f 6e64  lem_reduced(a_nd
-00015a60: 696d 2c20 615f 7368 6170 652c 2064 696d  im, a_shape, dim
-00015a70: 7329 3a0a 2020 2020 6469 6d73 203d 2075  s):.    dims = u
-00015a80: 7469 6c73 2e63 616e 6f6e 6963 616c 697a  tils.canonicaliz
-00015a90: 655f 6469 6d73 2861 5f6e 6469 6d2c 2064  e_dims(a_ndim, d
-00015aa0: 696d 7329 0a20 2020 2072 6564 7563 7469  ims).    reducti
-00015ab0: 6f6e 5f73 697a 6520 3d20 310a 2020 2020  on_size = 1.    
-00015ac0: 666f 7220 6964 782c 2073 697a 6520 696e  for idx, size in
-00015ad0: 2065 6e75 6d65 7261 7465 2861 5f73 6861   enumerate(a_sha
-00015ae0: 7065 293a 0a20 2020 2020 2020 2069 6620  pe):.        if 
-00015af0: 6964 7820 696e 2064 696d 733a 0a20 2020  idx in dims:.   
-00015b00: 2020 2020 2020 2020 2072 6564 7563 7469           reducti
-00015b10: 6f6e 5f73 697a 6520 2a3d 2073 697a 650a  on_size *= size.
-00015b20: 2020 2020 7265 7475 726e 2072 6564 7563      return reduc
-00015b30: 7469 6f6e 5f73 697a 650a 0a0a 6465 6620  tion_size...def 
-00015b40: 6d65 616e 5f62 6163 6b77 6172 6428 615f  mean_backward(a_
-00015b50: 6e64 696d 2c20 615f 7368 6170 652c 2064  ndim, a_shape, d
-00015b60: 696d 732c 2067 7261 6429 3a0a 2020 2020  ims, grad):.    
-00015b70: 6d65 616e 5f6c 6f63 616c 5f67 7261 6420  mean_local_grad 
-00015b80: 3d20 312e 3020 2f20 6e5f 656c 656d 5f72  = 1.0 / n_elem_r
-00015b90: 6564 7563 6564 2861 5f6e 6469 6d2c 2061  educed(a_ndim, a
-00015ba0: 5f73 6861 7065 2c20 6469 6d73 290a 2020  _shape, dims).  
-00015bb0: 2020 7265 7475 726e 2072 6573 746f 7265    return restore
-00015bc0: 5f72 6564 7563 6564 5f64 696d 7328 6772  _reduced_dims(gr
-00015bd0: 6164 2c20 6469 6d73 2c20 615f 7368 6170  ad, dims, a_shap
-00015be0: 6529 202a 206d 6561 6e5f 6c6f 6361 6c5f  e) * mean_local_
-00015bf0: 6772 6164 0a0a 0a40 7265 6769 7374 6572  grad...@register
-00015c00: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
-00015c10: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
-00015c20: 2e50 4144 290a 6465 6620 7061 645f 6175  .PAD).def pad_au
-00015c30: 675f 6677 6428 612c 2070 6164 6469 6e67  g_fwd(a, padding
-00015c40: 5f76 616c 7565 2c20 7061 6464 696e 675f  _value, padding_
-00015c50: 636f 6e66 6967 293a 0a20 2020 2072 6574  config):.    ret
-00015c60: 7572 6e20 564a 5044 7561 6c28 2870 7269  urn VJPDual((pri
-00015c70: 6d73 2e70 6164 2861 2c20 7061 6464 696e  ms.pad(a, paddin
-00015c80: 675f 7661 6c75 652c 2070 6164 6469 6e67  g_value, padding
-00015c90: 5f63 6f6e 6669 6729 2c29 2c20 2861 2c20  _config),), (a, 
-00015ca0: 7061 6464 696e 675f 636f 6e66 6967 2929  padding_config))
-00015cb0: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-00015cc0: 6b77 6172 6428 7072 696d 732e 5072 696d  kward(prims.Prim
-00015cd0: 4944 732e 5041 4429 0a64 6566 2070 6164  IDs.PAD).def pad
-00015ce0: 5f62 6163 6b77 6172 6428 612c 2070 6164  _backward(a, pad
-00015cf0: 6469 6e67 5f63 6f6e 6669 672c 2067 293a  ding_config, g):
-00015d00: 0a20 2020 2023 2053 686f 7274 2063 6972  .    # Short cir
-00015d10: 6375 6974 206f 6e20 656d 7074 7920 696e  cuit on empty in
-00015d20: 7075 742e 0a20 2020 2069 6620 616e 7928  put..    if any(
-00015d30: 6469 6d20 3d3d 2030 2066 6f72 2064 696d  dim == 0 for dim
-00015d40: 2069 6e20 612e 7368 6170 6529 3a0a 2020   in a.shape):.  
-00015d50: 2020 2020 2020 7265 7475 726e 2066 756c        return ful
-00015d60: 6c5f 6c69 6b65 2861 2c20 6669 6c6c 5f76  l_like(a, fill_v
-00015d70: 616c 7565 3d30 290a 0a20 2020 2023 2055  alue=0)..    # U
-00015d80: 6e2d 7061 6420 6279 2070 6164 6469 6e67  n-pad by padding
-00015d90: 2077 6974 6820 7a65 726f 2076 616c 7565   with zero value
-00015da0: 730a 2020 2020 7a65 726f 5f70 6164 6469  s.    zero_paddi
-00015db0: 6e67 5f63 6f6e 6669 6720 3d20 5b28 2d6c  ng_config = [(-l
-00015dc0: 6f2c 202d 6869 2c20 3029 2066 6f72 206c  o, -hi, 0) for l
-00015dd0: 6f2c 2068 692c 205f 2069 6e20 7061 6464  o, hi, _ in padd
-00015de0: 696e 675f 636f 6e66 6967 5d0a 0a20 2020  ing_config]..   
-00015df0: 2067 203d 2070 7269 6d73 2e70 6164 2867   g = prims.pad(g
-00015e00: 2c20 302e 302c 207a 6572 6f5f 7061 6464  , 0.0, zero_padd
-00015e10: 696e 675f 636f 6e66 6967 290a 0a20 2020  ing_config)..   
-00015e20: 2023 2055 6e2d 736c 6963 6520 6279 2073   # Un-slice by s
-00015e30: 6c69 6369 6e67 2077 6974 6820 6120 7374  licing with a st
-00015e40: 7269 6465 206f 6620 7661 6c75 6520 2864  ride of value (d
-00015e50: 696c 6174 696f 6e20 2b20 3129 0a20 2020  ilation + 1).   
-00015e60: 2066 6f72 2064 696d 2c20 285f 2c20 5f2c   for dim, (_, _,
-00015e70: 2064 2920 696e 2065 6e75 6d65 7261 7465   d) in enumerate
-00015e80: 2870 6164 6469 6e67 5f63 6f6e 6669 6729  (padding_config)
-00015e90: 3a0a 2020 2020 2020 2020 6720 3d20 736c  :.        g = sl
-00015ea0: 6963 655f 696e 5f64 696d 2867 2c20 302c  ice_in_dim(g, 0,
-00015eb0: 2067 2e73 6861 7065 5b64 696d 5d2c 2073   g.shape[dim], s
-00015ec0: 7472 6964 653d 6420 2b20 312c 2064 696d  tride=d + 1, dim
-00015ed0: 3d64 696d 290a 0a20 2020 2072 6574 7572  =dim)..    retur
-00015ee0: 6e20 670a 0a0a 4072 6567 6973 7465 725f  n g...@register_
-00015ef0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00015f00: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00015f10: 5052 4f44 290a 6465 6620 7072 6f64 5f61  PROD).def prod_a
-00015f20: 7567 5f66 7764 2878 2c20 6469 6d73 293a  ug_fwd(x, dims):
-00015f30: 0a20 2020 2022 2222 4175 676d 656e 7465  .    """Augmente
-00015f40: 6420 7072 6f64 206f 7065 7261 7469 6f6e  d prod operation
-00015f50: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-00015f60: 2020 2020 2078 2028 5661 7269 6162 6c65       x (Variable
-00015f70: 293a 2054 656e 736f 7220 746f 2062 6520  ): Tensor to be 
-00015f80: 6d75 6c74 6970 6c69 6564 2e0a 2020 2020  multiplied..    
-00015f90: 2020 2020 6469 6d73 2028 5475 706c 655b      dims (Tuple[
-00015fa0: 696e 742c 202e 2e2e 5d29 3a20 4469 6d65  int, ...]): Dime
-00015fb0: 6e73 696f 6e73 2074 6f20 6265 206d 756c  nsions to be mul
-00015fc0: 7469 706c 6965 642e 0a0a 2020 2020 5265  tiplied...    Re
-00015fd0: 7475 726e 733a 0a20 2020 2020 2020 2056  turns:.        V
-00015fe0: 4a50 4475 616c 3a20 5072 696d 616c 2061  JPDual: Primal a
-00015ff0: 6e64 2072 6573 6964 7561 6c73 2e0a 2020  nd residuals..  
-00016000: 2020 2222 220a 2020 2020 7072 696d 616c    """.    primal
-00016010: 203d 2070 7269 6d73 2e70 726f 6428 782c   = prims.prod(x,
-00016020: 2064 696d 7329 0a0a 2020 2020 7265 7369   dims)..    resi
-00016030: 6475 616c 7320 3d20 280a 2020 2020 2020  duals = (.      
-00016040: 2020 7072 696d 616c 2c0a 2020 2020 2020    primal,.      
-00016050: 2020 782c 0a20 2020 2020 2020 2078 2e73    x,.        x.s
-00016060: 6861 7065 2c0a 2020 2020 2020 2020 6469  hape,.        di
-00016070: 6d73 2c0a 2020 2020 290a 2020 2020 7265  ms,.    ).    re
-00016080: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-00016090: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
-000160a0: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
-000160b0: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-000160c0: 4473 2e50 524f 4429 0a64 6566 2070 726f  Ds.PROD).def pro
-000160d0: 645f 7075 6c6c 6261 636b 2870 7269 6d61  d_pullback(prima
-000160e0: 6c2c 2078 2c20 785f 7368 6170 652c 2072  l, x, x_shape, r
-000160f0: 6564 7563 6564 5f64 696d 732c 2067 293a  educed_dims, g):
-00016100: 0a20 2020 2072 6574 7572 6e20 7072 696d  .    return prim
-00016110: 732e 6469 7628 7265 7374 6f72 655f 7265  s.div(restore_re
-00016120: 6475 6365 645f 6469 6d73 2870 7269 6d61  duced_dims(prima
-00016130: 6c20 2a20 672c 2072 6564 7563 6564 5f64  l * g, reduced_d
-00016140: 696d 732c 2078 5f73 6861 7065 292c 2078  ims, x_shape), x
-00016150: 290a 0a0a 6465 6620 6b65 6570 6469 6d5f  )...def keepdim_
-00016160: 7265 6475 6374 696f 6e28 7265 6475 6374  reduction(reduct
-00016170: 696f 6e5f 666e 2c20 782c 2064 696d 7329  ion_fn, x, dims)
-00016180: 3a0a 2020 2020 2222 2241 7070 6c69 6573  :.    """Applies
-00016190: 2072 6564 7563 7469 6f6e 2061 6e64 2066   reduction and f
-000161a0: 6978 6573 206f 7574 7075 7420 746f 2063  ixes output to c
-000161b0: 6f6e 666f 726d 2074 6f20 6b65 6570 6469  onform to keepdi
-000161c0: 6d3d 5472 7565 2222 220a 2020 2020 6f75  m=True""".    ou
-000161d0: 7420 3d20 7265 6475 6374 696f 6e5f 666e  t = reduction_fn
-000161e0: 2878 2c20 6469 6d73 290a 2020 2020 6172  (x, dims).    ar
-000161f0: 676d 6178 5f73 756d 5f6f 7574 5f73 6861  gmax_sum_out_sha
-00016200: 7065 203d 205b 782e 7368 6170 655b 695d  pe = [x.shape[i]
-00016210: 2069 6620 6920 6e6f 7420 696e 2064 696d   if i not in dim
-00016220: 7320 656c 7365 2031 2066 6f72 2069 2069  s else 1 for i i
-00016230: 6e20 7261 6e67 6528 782e 6e64 696d 295d  n range(x.ndim)]
-00016240: 0a20 2020 2062 726f 6164 6361 7374 5f64  .    broadcast_d
-00016250: 696d 7320 3d20 5b69 2066 6f72 2069 2069  ims = [i for i i
-00016260: 6e20 7261 6e67 6528 782e 6e64 696d 2920  n range(x.ndim) 
-00016270: 6966 2069 206e 6f74 2069 6e20 6469 6d73  if i not in dims
-00016280: 5d0a 2020 2020 7265 7475 726e 2070 7269  ].    return pri
-00016290: 6d73 2e62 726f 6164 6361 7374 5f69 6e5f  ms.broadcast_in_
-000162a0: 6469 6d28 6f75 742c 2061 7267 6d61 785f  dim(out, argmax_
-000162b0: 7375 6d5f 6f75 745f 7368 6170 652c 2062  sum_out_shape, b
-000162c0: 726f 6164 6361 7374 5f64 696d 7329 0a0a  roadcast_dims)..
-000162d0: 0a23 2049 6e73 7069 7265 6420 6672 6f6d  .# Inspired from
-000162e0: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
-000162f0: 636f 6d2f 4849 5053 2f61 7574 6f67 7261  com/HIPS/autogra
-00016300: 642f 626c 6f62 2f6d 6173 7465 722f 6175  d/blob/master/au
-00016310: 746f 6772 6164 2f6e 756d 7079 2f6e 756d  tograd/numpy/num
-00016320: 7079 5f76 6a70 732e 7079 234c 3335 330a  py_vjps.py#L353.
-00016330: 6465 6620 6772 6164 5f63 686f 6f73 6572  def grad_chooser
-00016340: 5f62 6163 6b77 6172 6428 7072 696d 616c  _backward(primal
-00016350: 2c20 782c 2078 5f73 6861 7065 2c20 7265  , x, x_shape, re
-00016360: 6475 6365 645f 6469 6d73 2c20 6729 3a0a  duced_dims, g):.
-00016370: 2020 2020 2222 2242 7569 6c64 7320 6772      """Builds gr
-00016380: 6164 6965 6e74 206f 6620 6675 6e63 7469  adient of functi
-00016390: 6f6e 7320 7468 6174 2063 686f 6f73 6520  ons that choose 
-000163a0: 6120 7369 6e67 6c65 2069 7465 6d2c 2073  a single item, s
-000163b0: 7563 6820 6173 206d 696e 206f 7220 6d61  uch as min or ma
-000163c0: 782e 2222 220a 2020 2020 675f 7265 7065  x.""".    g_repe
-000163d0: 6174 6564 203d 2072 6573 746f 7265 5f72  ated = restore_r
-000163e0: 6564 7563 6564 5f64 696d 7328 672c 2072  educed_dims(g, r
-000163f0: 6564 7563 6564 5f64 696d 732c 2078 5f73  educed_dims, x_s
-00016400: 6861 7065 290a 2020 2020 7072 696d 616c  hape).    primal
-00016410: 5f72 6570 6561 7465 6420 3d20 7265 7374  _repeated = rest
-00016420: 6f72 655f 7265 6475 6365 645f 6469 6d73  ore_reduced_dims
-00016430: 2870 7269 6d61 6c2c 2072 6564 7563 6564  (primal, reduced
-00016440: 5f64 696d 732c 2078 5f73 6861 7065 290a  _dims, x_shape).
-00016450: 2020 2020 6172 676d 6178 5f6c 6f63 6174      argmax_locat
-00016460: 696f 6e73 203d 2078 203d 3d20 7072 696d  ions = x == prim
-00016470: 616c 5f72 6570 6561 7465 640a 2020 2020  al_repeated.    
-00016480: 6172 676d 6178 5f73 756d 203d 206b 6565  argmax_sum = kee
-00016490: 7064 696d 5f72 6564 7563 7469 6f6e 2870  pdim_reduction(p
-000164a0: 7269 6d73 2e73 756d 2c20 6172 676d 6178  rims.sum, argmax
-000164b0: 5f6c 6f63 6174 696f 6e73 2c20 7265 6475  _locations, redu
-000164c0: 6365 645f 6469 6d73 290a 2020 2020 6f75  ced_dims).    ou
-000164d0: 7420 3d20 675f 7265 7065 6174 6564 202a  t = g_repeated *
-000164e0: 2061 7267 6d61 785f 6c6f 6361 7469 6f6e   argmax_location
-000164f0: 7320 2f20 6172 676d 6178 5f73 756d 0a20  s / argmax_sum. 
-00016500: 2020 2072 6574 7572 6e20 6f75 740a 0a0a     return out...
-00016510: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-00016520: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00016530: 414d 494e 2928 6772 6164 5f63 686f 6f73  AMIN)(grad_choos
-00016540: 6572 5f62 6163 6b77 6172 6429 0a0a 0a40  er_backward)...@
-00016550: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
-00016560: 6564 5f66 6f72 7761 7264 2870 7269 6d73  ed_forward(prims
-00016570: 2e50 7269 6d49 4473 2e41 4d49 4e29 0a64  .PrimIDs.AMIN).d
-00016580: 6566 2061 6d69 6e5f 6175 675f 6677 6428  ef amin_aug_fwd(
-00016590: 782c 2064 696d 7329 3a0a 2020 2020 2222  x, dims):.    ""
-000165a0: 2241 7567 6d65 6e74 6564 2061 6d69 6e20  "Augmented amin 
-000165b0: 6f70 6572 6174 696f 6e2e 0a20 2020 2041  operation..    A
-000165c0: 7267 733a 0a20 2020 2020 2020 2078 2028  rgs:.        x (
-000165d0: 5661 7269 6162 6c65 293a 2054 656e 736f  Variable): Tenso
-000165e0: 7220 746f 2063 6f6d 7075 7465 2061 6d69  r to compute ami
-000165f0: 6e20 6f6e 2e0a 2020 2020 2020 2020 6469  n on..        di
-00016600: 6d73 2028 5475 706c 655b 696e 742c 202e  ms (Tuple[int, .
-00016610: 2e2e 5d29 3a20 4469 6d65 6e73 696f 6e73  ..]): Dimensions
-00016620: 2074 6f20 636f 6d70 7574 6520 616d 696e   to compute amin
-00016630: 206f 7665 722e 0a20 2020 2052 6574 7572   over..    Retur
-00016640: 6e73 3a0a 2020 2020 2020 2020 564a 5044  ns:.        VJPD
-00016650: 7561 6c3a 2050 7269 6d61 6c20 616e 6420  ual: Primal and 
-00016660: 7265 7369 6475 616c 732e 0a20 2020 2022  residuals..    "
-00016670: 2222 0a20 2020 2070 7269 6d61 6c20 3d20  "".    primal = 
-00016680: 7072 696d 732e 616d 696e 2878 2c20 6469  prims.amin(x, di
-00016690: 6d73 290a 0a20 2020 2072 6573 6964 7561  ms)..    residua
-000166a0: 6c73 203d 2028 0a20 2020 2020 2020 2070  ls = (.        p
-000166b0: 7269 6d61 6c2c 0a20 2020 2020 2020 2078  rimal,.        x
-000166c0: 2c0a 2020 2020 2020 2020 782e 7368 6170  ,.        x.shap
-000166d0: 652c 0a20 2020 2020 2020 2064 696d 732c  e,.        dims,
-000166e0: 0a20 2020 2029 0a0a 2020 2020 7265 7475  .    )..    retu
-000166f0: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
-00016700: 6c2c 2072 6573 6964 7561 6c73 290a 0a0a  l, residuals)...
-00016710: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
-00016720: 7465 645f 666f 7277 6172 6428 7072 696d  ted_forward(prim
-00016730: 732e 5072 696d 4944 732e 504f 5729 0a64  s.PrimIDs.POW).d
-00016740: 6566 2070 6f77 5f61 7567 5f66 6564 2878  ef pow_aug_fed(x
-00016750: 2c20 7929 3a0a 2020 2020 2222 2241 7567  , y):.    """Aug
-00016760: 6d65 6e74 6564 2074 6865 2070 6f77 206f  mented the pow o
-00016770: 7065 7261 7469 6f6e 2e0a 0a20 2020 2041  peration...    A
-00016780: 7267 733a 0a20 2020 2020 2020 2078 2028  rgs:.        x (
-00016790: 5661 7269 6162 6c65 293a 2054 656e 736f  Variable): Tenso
-000167a0: 7220 7769 7468 2074 6865 2062 6173 6520  r with the base 
-000167b0: 746f 2062 6520 6578 706f 6e65 6e74 6961  to be exponentia
-000167c0: 7465 642e 0a20 2020 2020 2020 2079 2028  ted..        y (
-000167d0: 5661 7269 6162 6c65 293a 2054 656e 736f  Variable): Tenso
-000167e0: 7220 7769 7468 2070 6f77 6572 2074 6f20  r with power to 
-000167f0: 7261 6973 6520 746f 2e0a 0a20 2020 2052  raise to...    R
-00016800: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00016810: 564a 5044 7561 6c3a 2050 7269 6d61 6c20  VJPDual: Primal 
-00016820: 616e 6420 7265 7369 6475 616c 732e 0a20  and residuals.. 
-00016830: 2020 2022 2222 0a20 2020 2070 7269 6d61     """.    prima
-00016840: 6c20 3d20 7072 696d 732e 706f 7728 782c  l = prims.pow(x,
-00016850: 2079 290a 2020 2020 7265 7369 6475 616c   y).    residual
-00016860: 7320 3d20 2870 7269 6d61 6c2c 2078 2c20  s = (primal, x, 
-00016870: 7929 0a20 2020 2072 6574 7572 6e20 564a  y).    return VJ
-00016880: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
-00016890: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
-000168a0: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
-000168b0: 696d 732e 5072 696d 4944 732e 504f 5729  ims.PrimIDs.POW)
-000168c0: 0a64 6566 2070 6f77 5f62 6163 6b77 6172  .def pow_backwar
-000168d0: 6428 7265 7375 6c74 2c20 782c 2079 2c20  d(result, x, y, 
-000168e0: 6729 3a0a 2020 2020 696d 706f 7274 2074  g):.    import t
-000168f0: 6875 6e64 6572 2e63 6c61 6e67 2061 7320  hunder.clang as 
-00016900: 746c 616e 670a 0a20 2020 2067 7265 7375  tlang..    gresu
-00016910: 6c74 203d 2067 202a 2072 6573 756c 7420  lt = g * result 
-00016920: 2023 2072 6575 7365 2063 6f6d 6d6f 6e20   # reuse common 
-00016930: 6661 6374 6f72 0a20 2020 2064 7820 3d20  factor.    dx = 
-00016940: 6720 2a20 7920 2a20 7820 2a2a 2028 7920  g * y * x ** (y 
-00016950: 2d20 3129 0a20 2020 2064 7920 3d20 6772  - 1).    dy = gr
-00016960: 6573 756c 7420 2a20 746c 616e 672e 6c6f  esult * tlang.lo
-00016970: 6728 7829 0a20 2020 2072 6574 7572 6e20  g(x).    return 
-00016980: 6478 2c20 6479 0a0a 0a40 7265 6769 7374  dx, dy...@regist
-00016990: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
-000169a0: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-000169b0: 4473 2e54 414e 290a 6465 6620 7461 6e5f  Ds.TAN).def tan_
-000169c0: 6175 675f 6677 6428 7829 3a0a 2020 2020  aug_fwd(x):.    
-000169d0: 2222 2241 7567 6d65 6e74 6564 2074 616e  """Augmented tan
-000169e0: 206f 7065 7261 7469 6f6e 2e0a 0a20 2020   operation...   
-000169f0: 2041 7267 733a 0a20 2020 2020 2020 2078   Args:.        x
-00016a00: 2028 5661 7269 6162 6c65 293a 2054 656e   (Variable): Ten
-00016a10: 736f 7220 746f 2062 6520 7061 7373 6564  sor to be passed
-00016a20: 2074 6f20 7461 6e2e 0a20 2020 2022 2222   to tan..    """
-00016a30: 0a0a 2020 2020 7072 696d 616c 203d 2070  ..    primal = p
-00016a40: 7269 6d73 2e74 616e 2878 290a 2020 2020  rims.tan(x).    
-00016a50: 7265 7369 6475 616c 7320 3d20 2870 7269  residuals = (pri
-00016a60: 6d61 6c2c 290a 2020 2020 7265 7475 726e  mal,).    return
-00016a70: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
-00016a80: 2072 6573 6964 7561 6c73 290a 0a0a 4072   residuals)...@r
-00016a90: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-00016aa0: 2870 7269 6d73 2e50 7269 6d49 4473 2e54  (prims.PrimIDs.T
-00016ab0: 414e 290a 6465 6620 7461 6e5f 6261 636b  AN).def tan_back
-00016ac0: 7761 7264 2872 6573 756c 742c 2067 293a  ward(result, g):
-00016ad0: 0a20 2020 2072 6574 7572 6e20 6720 2a20  .    return g * 
-00016ae0: 2831 202b 2072 6573 756c 7420 2a20 7265  (1 + result * re
-00016af0: 7375 6c74 290a 0a0a 2320 4e4f 5445 3a20  sult)...# NOTE: 
-00016b00: 4a61 7820 7573 6573 206e 702e 6172 6773  Jax uses np.args
-00016b10: 6f72 7420 696e 2069 7473 2074 7261 6e73  ort in its trans
-00016b20: 706f 7365 2076 6a70 2063 6f6d 7075 7461  pose vjp computa
-00016b30: 7469 6f6e 0a64 6566 205f 6172 6773 6f72  tion.def _argsor
-00016b40: 7428 7365 7129 3a0a 2020 2020 7265 7475  t(seq):.    retu
-00016b50: 726e 2073 6f72 7465 6428 7261 6e67 6528  rn sorted(range(
-00016b60: 6c65 6e28 7365 7129 292c 206b 6579 3d73  len(seq)), key=s
-00016b70: 6571 2e5f 5f67 6574 6974 656d 5f5f 290a  eq.__getitem__).
-00016b80: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
-00016b90: 656e 7465 645f 666f 7277 6172 6428 7072  ented_forward(pr
-00016ba0: 696d 732e 5072 696d 4944 732e 4445 5649  ims.PrimIDs.DEVI
-00016bb0: 4345 5f50 5554 290a 6465 6620 6465 7669  CE_PUT).def devi
-00016bc0: 6365 5f70 7574 5f61 7567 5f66 7764 2861  ce_put_aug_fwd(a
-00016bd0: 3a20 5465 6e73 6f72 5072 6f78 792c 2064  : TensorProxy, d
-00016be0: 6576 6963 653a 2044 6576 6963 6529 202d  evice: Device) -
-00016bf0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-00016c00: 2020 2070 7269 6d61 6c20 3d20 7072 696d     primal = prim
-00016c10: 732e 6465 7669 6365 5f70 7574 2861 2c20  s.device_put(a, 
-00016c20: 6465 7669 6365 290a 2020 2020 7265 7369  device).    resi
-00016c30: 6475 616c 7320 3d20 2861 2e64 6576 6963  duals = (a.devic
-00016c40: 652c 290a 2020 2020 7265 7475 726e 2056  e,).    return V
-00016c50: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
-00016c60: 6573 6964 7561 6c73 290a 0a0a 4072 6567  esiduals)...@reg
-00016c70: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
-00016c80: 7269 6d73 2e50 7269 6d49 4473 2e44 4556  rims.PrimIDs.DEV
-00016c90: 4943 455f 5055 5429 0a64 6566 2064 6576  ICE_PUT).def dev
-00016ca0: 6963 655f 7075 745f 6261 636b 7761 7264  ice_put_backward
-00016cb0: 286f 7269 675f 6465 7669 6365 2c20 6729  (orig_device, g)
-00016cc0: 3a0a 2020 2020 7265 7475 726e 2070 7269  :.    return pri
-00016cd0: 6d73 2e64 6576 6963 655f 7075 7428 672c  ms.device_put(g,
-00016ce0: 206f 7269 675f 6465 7669 6365 292c 204e   orig_device), N
-00016cf0: 6f6e 650a 0a0a 4072 6567 6973 7465 725f  one...@register_
-00016d00: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00016d10: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00016d20: 434f 4e56 4f4c 5554 494f 4e29 0a64 6566  CONVOLUTION).def
-00016d30: 2063 6f6e 766f 6c75 7469 6f6e 5f61 7567   convolution_aug
-00016d40: 5f66 7764 280a 2020 2020 613a 2050 726f  _fwd(.    a: Pro
-00016d50: 7879 2c0a 2020 2020 7765 6967 6874 2c0a  xy,.    weight,.
-00016d60: 2020 2020 6269 6173 2c0a 2020 2020 7374      bias,.    st
-00016d70: 7269 6465 2c0a 2020 2020 7061 6464 696e  ride,.    paddin
-00016d80: 672c 0a20 2020 2064 696c 6174 696f 6e2c  g,.    dilation,
-00016d90: 0a20 2020 2074 7261 6e73 706f 7365 642c  .    transposed,
-00016da0: 0a20 2020 206f 7574 7075 745f 7061 6464  .    output_padd
-00016db0: 696e 672c 0a20 2020 2067 726f 7570 732c  ing,.    groups,
-00016dc0: 0a29 3a0a 2020 2020 7072 696d 616c 203d  .):.    primal =
-00016dd0: 2063 6f6e 766f 6c75 7469 6f6e 2861 2c20   convolution(a, 
-00016de0: 7765 6967 6874 2c20 6269 6173 2c20 7374  weight, bias, st
-00016df0: 7269 6465 2c20 7061 6464 696e 672c 2064  ride, padding, d
-00016e00: 696c 6174 696f 6e2c 2074 7261 6e73 706f  ilation, transpo
-00016e10: 7365 642c 206f 7574 7075 745f 7061 6464  sed, output_padd
-00016e20: 696e 672c 2067 726f 7570 7329 0a20 2020  ing, groups).   
-00016e30: 2072 6573 6964 7561 6c73 203d 2028 7072   residuals = (pr
-00016e40: 696d 616c 2c20 612c 2077 6569 6768 742c  imal, a, weight,
-00016e50: 2062 6961 732c 2073 7472 6964 652c 2070   bias, stride, p
-00016e60: 6164 6469 6e67 2c20 6469 6c61 7469 6f6e  adding, dilation
-00016e70: 2c20 7472 616e 7370 6f73 6564 2c20 6f75  , transposed, ou
-00016e80: 7470 7574 5f70 6164 6469 6e67 2c20 6772  tput_padding, gr
-00016e90: 6f75 7073 290a 2020 2020 7265 7475 726e  oups).    return
-00016ea0: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
-00016eb0: 2072 6573 6964 7561 6c73 290a 0a0a 4072   residuals)...@r
-00016ec0: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-00016ed0: 2870 7269 6d73 2e50 7269 6d49 4473 2e43  (prims.PrimIDs.C
-00016ee0: 4f4e 564f 4c55 5449 4f4e 290a 6465 6620  ONVOLUTION).def 
-00016ef0: 636f 6e76 6f6c 7574 696f 6e5f 6261 636b  convolution_back
-00016f00: 7761 7264 280a 2020 2020 6f75 7470 7574  ward(.    output
-00016f10: 3a20 5072 6f78 792c 0a20 2020 2069 6e70  : Proxy,.    inp
-00016f20: 7574 3a20 5072 6f78 792c 0a20 2020 2077  ut: Proxy,.    w
-00016f30: 6569 6768 742c 0a20 2020 2062 6961 732c  eight,.    bias,
-00016f40: 0a20 2020 2073 7472 6964 652c 0a20 2020  .    stride,.   
-00016f50: 2070 6164 6469 6e67 2c0a 2020 2020 6469   padding,.    di
-00016f60: 6c61 7469 6f6e 2c0a 2020 2020 7472 616e  lation,.    tran
-00016f70: 7370 6f73 6564 2c0a 2020 2020 6f75 7470  sposed,.    outp
-00016f80: 7574 5f70 6164 6469 6e67 2c0a 2020 2020  ut_padding,.    
-00016f90: 6772 6f75 7073 2c0a 2020 2020 6772 6164  groups,.    grad
-00016fa0: 2c0a 293a 0a20 2020 2023 2054 7261 6e73  ,.):.    # Trans
-00016fb0: 706f 7365 6420 636f 6e76 6f6c 7574 696f  posed convolutio
-00016fc0: 6e20 6973 206e 6f74 2073 7570 706f 7274  n is not support
-00016fd0: 6564 210a 2020 2020 6173 7365 7274 2074  ed!.    assert t
-00016fe0: 7261 6e73 706f 7365 6420 3d3d 2030 0a0a  ransposed == 0..
-00016ff0: 2020 2020 696e 7075 745f 6772 6164 203d      input_grad =
-00017000: 204e 6f6e 650a 2020 2020 7765 6967 6874   None.    weight
-00017010: 5f67 7261 6420 3d20 4e6f 6e65 0a20 2020  _grad = None.   
-00017020: 2062 6961 735f 6772 6164 203d 204e 6f6e   bias_grad = Non
-00017030: 650a 0a20 2020 2023 2053 686f 7274 2063  e..    # Short c
-00017040: 6972 6375 6974 206f 6e20 7a65 726f 2d64  ircuit on zero-d
-00017050: 696d 2067 7261 640a 2020 2020 6966 2061  im grad.    if a
-00017060: 6e79 2873 203d 3d20 3020 666f 7220 7320  ny(s == 0 for s 
-00017070: 696e 2067 7261 642e 7368 6170 6529 3a0a  in grad.shape):.
-00017080: 2020 2020 2020 2020 696e 7075 745f 6772          input_gr
-00017090: 6164 203d 2066 756c 6c5f 6c69 6b65 2869  ad = full_like(i
-000170a0: 6e70 7574 2c20 6669 6c6c 5f76 616c 7565  nput, fill_value
-000170b0: 3d30 290a 2020 2020 2020 2020 7765 6967  =0).        weig
-000170c0: 6874 5f67 7261 6420 3d20 6675 6c6c 5f6c  ht_grad = full_l
-000170d0: 696b 6528 7765 6967 6874 2c20 6669 6c6c  ike(weight, fill
-000170e0: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
-000170f0: 2020 6966 2062 6961 7320 6973 206e 6f74    if bias is not
-00017100: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00017110: 2020 2062 6961 735f 6772 6164 203d 2066     bias_grad = f
-00017120: 756c 6c5f 6c69 6b65 2862 6961 732c 2066  ull_like(bias, f
-00017130: 696c 6c5f 7661 6c75 653d 3029 0a20 2020  ill_value=0).   
-00017140: 2020 2020 2072 6574 7572 6e20 2869 6e70       return (inp
-00017150: 7574 5f67 7261 642c 2077 6569 6768 745f  ut_grad, weight_
-00017160: 6772 6164 2c20 6269 6173 5f67 7261 6429  grad, bias_grad)
-00017170: 202b 2028 284e 6f6e 652c 2920 2a20 3629   + ((None,) * 6)
-00017180: 0a0a 2020 2020 6261 7463 682c 2069 6e5f  ..    batch, in_
-00017190: 6368 616e 6e65 6c73 2c20 2a73 7061 7469  channels, *spati
-000171a0: 616c 5f64 696d 7320 3d20 696e 7075 742e  al_dims = input.
-000171b0: 7368 6170 650a 2020 2020 6f75 745f 6368  shape.    out_ch
-000171c0: 616e 6e65 6c73 2c20 6769 6e5f 6368 616e  annels, gin_chan
-000171d0: 6e65 6c73 2c20 2a6b 6572 6e65 6c5f 6469  nels, *kernel_di
-000171e0: 6d73 203d 2077 6569 6768 742e 7368 6170  ms = weight.shap
-000171f0: 650a 2020 2020 6469 6d20 3d20 6c65 6e28  e.    dim = len(
-00017200: 7370 6174 6961 6c5f 6469 6d73 290a 0a20  spatial_dims).. 
-00017210: 2020 2064 6566 206d 6179 6265 5f65 7870     def maybe_exp
-00017220: 616e 645f 7365 7128 732c 2064 696d 293a  and_seq(s, dim):
-00017230: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-00017240: 7329 203d 3d20 313a 0a20 2020 2020 2020  s) == 1:.       
-00017250: 2020 2020 2072 6574 7572 6e20 2873 5b30       return (s[0
-00017260: 5d2c 2920 2a20 6469 6d0a 2020 2020 2020  ],) * dim.      
-00017270: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00017280: 2020 2020 7265 7475 726e 2073 0a0a 2020      return s..  
-00017290: 2020 7374 7269 6465 203d 206d 6179 6265    stride = maybe
-000172a0: 5f65 7870 616e 645f 7365 7128 7374 7269  _expand_seq(stri
-000172b0: 6465 2c20 6469 6d29 0a20 2020 2070 6164  de, dim).    pad
-000172c0: 6469 6e67 203d 206d 6179 6265 5f65 7870  ding = maybe_exp
-000172d0: 616e 645f 7365 7128 7061 6464 696e 672c  and_seq(padding,
-000172e0: 2064 696d 290a 2020 2020 6469 6c61 7469   dim).    dilati
-000172f0: 6f6e 203d 206d 6179 6265 5f65 7870 616e  on = maybe_expan
-00017300: 645f 7365 7128 6469 6c61 7469 6f6e 2c20  d_seq(dilation, 
-00017310: 6469 6d29 0a0a 2020 2020 6465 6620 636f  dim)..    def co
-00017320: 6e76 5f74 7261 6e73 706f 7365 2874 293a  nv_transpose(t):
-00017330: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00017340: 7072 696d 732e 7472 616e 7370 6f73 6528  prims.transpose(
-00017350: 742c 2028 312c 2030 2920 2b20 7475 706c  t, (1, 0) + tupl
-00017360: 6528 7261 6e67 6528 322c 2074 2e6e 6469  e(range(2, t.ndi
-00017370: 6d29 2929 0a0a 2020 2020 2320 696e 7075  m)))..    # inpu
-00017380: 745f 6772 6164 203d 207b 0a20 2020 2064  t_grad = {.    d
-00017390: 6566 2074 7261 6e73 706f 7365 5f61 6e64  ef transpose_and
-000173a0: 5f66 6c69 705f 7765 6967 6874 2877 6569  _flip_weight(wei
-000173b0: 6768 7429 3a0a 2020 2020 2020 2020 2320  ght):.        # 
-000173c0: 5468 6520 6c69 6e65 7320 6265 6c6f 7720  The lines below 
-000173d0: 6172 6520 7472 616e 7370 6f73 696e 6720  are transposing 
-000173e0: 7468 6520 6368 616e 6e65 6c73 2064 696d  the channels dim
-000173f0: 732e 0a20 2020 2020 2020 2023 2057 6520  s..        # We 
-00017400: 616c 736f 206e 6565 6420 746f 2065 7874  also need to ext
-00017410: 7261 6374 2074 6865 2067 726f 7570 2069  ract the group i
-00017420: 6e66 6f72 6d61 7469 6f6e 2061 6e64 206d  nformation and m
-00017430: 6572 6765 2069 740a 2020 2020 2020 2020  erge it.        
-00017440: 2320 7769 7468 2074 6865 2064 696d 656e  # with the dimen
-00017450: 7369 6f6e 2063 6f72 7265 7370 6f6e 6469  sion correspondi
-00017460: 6e67 2074 6f20 7468 6520 226f 7574 5f63  ng to the "out_c
-00017470: 6861 6e6e 656c 7322 2064 696d 2e0a 2020  hannels" dim..  
-00017480: 2020 2020 2020 2320 286f 7574 5f63 6861        # (out_cha
-00017490: 6e6e 656c 732c 2067 696e 5f63 6861 6e6e  nnels, gin_chann
-000174a0: 656c 7329 202d 3e20 2867 696e 5f63 6861  els) -> (gin_cha
-000174b0: 6e6e 656c 732c 206f 7574 5f63 6861 6e6e  nnels, out_chann
-000174c0: 656c 7329 0a20 2020 2020 2020 2077 6569  els).        wei
-000174d0: 6768 7420 3d20 636f 6e76 5f74 7261 6e73  ght = conv_trans
-000174e0: 706f 7365 2877 6569 6768 7429 0a20 2020  pose(weight).   
-000174f0: 2020 2020 2023 2053 706c 6974 2028 6f75       # Split (ou
-00017500: 745f 6368 616e 6e65 6c73 2c29 202d 3e20  t_channels,) -> 
-00017510: 2867 726f 7570 732c 206f 7574 5f63 6861  (groups, out_cha
-00017520: 6e6e 656c 7320 2f2f 2067 726f 7570 7329  nnels // groups)
-00017530: 0a20 2020 2020 2020 2077 6569 6768 7420  .        weight 
-00017540: 3d20 7765 6967 6874 2e72 6573 6861 7065  = weight.reshape
-00017550: 285b 6769 6e5f 6368 616e 6e65 6c73 2c20  ([gin_channels, 
-00017560: 6772 6f75 7073 2c20 6f75 745f 6368 616e  groups, out_chan
-00017570: 6e65 6c73 202f 2f20 6772 6f75 7073 5d20  nels // groups] 
-00017580: 2b20 6b65 726e 656c 5f64 696d 7329 0a20  + kernel_dims). 
-00017590: 2020 2020 2020 2023 204d 6f76 696e 6720         # Moving 
-000175a0: 6772 6f75 7073 2074 6f20 7468 6520 6c65  groups to the le
-000175b0: 6674 2d6d 6f73 7420 706f 7369 7469 6f6e  ft-most position
-000175c0: 2e0a 2020 2020 2020 2020 2320 2867 696e  ..        # (gin
-000175d0: 5f63 6861 6e6e 656c 732c 2067 726f 7570  _channels, group
-000175e0: 732c 206f 7574 5f63 6861 6e6e 656c 7320  s, out_channels 
-000175f0: 2f2f 2067 726f 7570 7329 202d 3e20 2867  // groups) -> (g
-00017600: 726f 7570 732c 2067 696e 5f63 6861 6e6e  roups, gin_chann
-00017610: 656c 732c 206f 7574 5f63 6861 6e6e 656c  els, out_channel
-00017620: 7320 2f2f 2067 726f 7570 7329 0a20 2020  s // groups).   
-00017630: 2020 2020 2077 6569 6768 7420 3d20 636f       weight = co
-00017640: 6e76 5f74 7261 6e73 706f 7365 2877 6569  nv_transpose(wei
-00017650: 6768 7429 0a20 2020 2020 2020 2023 2053  ght).        # S
-00017660: 7175 6173 6820 2867 726f 7570 732c 2067  quash (groups, g
-00017670: 696e 5f63 6861 6e6e 656c 7329 202d 3e20  in_channels) -> 
-00017680: 2869 6e5f 6368 616e 6e65 6c73 290a 2020  (in_channels).  
-00017690: 2020 2020 2020 7765 6967 6874 203d 2077        weight = w
-000176a0: 6569 6768 742e 7265 7368 6170 6528 5b69  eight.reshape([i
-000176b0: 6e5f 6368 616e 6e65 6c73 2c20 6f75 745f  n_channels, out_
-000176c0: 6368 616e 6e65 6c73 202f 2f20 6772 6f75  channels // grou
-000176d0: 7073 5d20 2b20 6b65 726e 656c 5f64 696d  ps] + kernel_dim
-000176e0: 7329 0a0a 2020 2020 2020 2020 2320 466c  s)..        # Fl
-000176f0: 6970 2073 7061 7469 616c 2064 696d 656e  ip spatial dimen
-00017700: 7369 6f6e 730a 2020 2020 2020 2020 7765  sions.        we
-00017710: 6967 6874 203d 2070 7269 6d73 2e66 6c69  ight = prims.fli
-00017720: 7028 7765 6967 6874 2c20 7475 706c 6528  p(weight, tuple(
-00017730: 7261 6e67 6528 322c 2077 6569 6768 742e  range(2, weight.
-00017740: 6e64 696d 2929 290a 2020 2020 2020 2020  ndim))).        
-00017750: 7265 7475 726e 2077 6569 6768 740a 0a20  return weight.. 
-00017760: 2020 2023 2057 6520 6e65 6564 2074 6f20     # We need to 
-00017770: 7061 6420 7468 6520 6772 6164 6965 6e74  pad the gradient
-00017780: 2074 6f20 6265 2061 626c 6520 746f 2066   to be able to f
-00017790: 6974 206b 6572 6e65 6c20 7769 6e64 6f77  it kernel window
-000177a0: 732e 0a20 2020 2069 6e69 7469 616c 5f67  s..    initial_g
-000177b0: 7261 645f 7061 6464 696e 6720 3d20 5b64  rad_padding = [d
-000177c0: 202a 2028 6b20 2d20 3129 2066 6f72 2064   * (k - 1) for d
-000177d0: 2c20 6b20 696e 207a 6970 2864 696c 6174  , k in zip(dilat
-000177e0: 696f 6e2c 206b 6572 6e65 6c5f 6469 6d73  ion, kernel_dims
-000177f0: 295d 0a0a 2020 2020 696e 7075 745f 6772  )]..    input_gr
-00017800: 6164 203d 2063 6f6e 766f 6c75 7469 6f6e  ad = convolution
-00017810: 280a 2020 2020 2020 2020 7072 696d 732e  (.        prims.
-00017820: 7061 6428 0a20 2020 2020 2020 2020 2020  pad(.           
-00017830: 2067 7261 642c 0a20 2020 2020 2020 2020   grad,.         
-00017840: 2020 2030 2e30 2c0a 2020 2020 2020 2020     0.0,.        
-00017850: 2020 2020 2320 5468 6520 7069 7865 7320      # The pixes 
-00017860: 6172 6520 7374 7269 6465 2061 7761 7920  are stride away 
-00017870: 6672 6f6d 2065 6163 6820 6f74 6865 7220  from each other 
-00017880: 696e 2074 6865 206f 7269 6769 6e61 6c20  in the original 
-00017890: 696e 7075 742e 0a20 2020 2020 2020 2020  input..         
-000178a0: 2020 2023 2048 656e 6365 2077 6520 6e65     # Hence we ne
-000178b0: 6564 2074 6f20 6469 6c61 7465 2074 6865  ed to dilate the
-000178c0: 2067 7261 6469 656e 7420 6279 2064 696c   gradient by dil
-000178d0: 6174 696f 6e3d 7374 7269 6465 202d 2031  ation=stride - 1
-000178e0: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
-000178f0: 6f20 7468 6174 2074 6865 7265 2061 7265  o that there are
-00017900: 2073 7472 6964 6520 2d20 3120 7a65 726f   stride - 1 zero
-00017910: 7320 6265 7477 6565 6e20 7468 6520 7069  s between the pi
-00017920: 7865 6c73 2e0a 2020 2020 2020 2020 2020  xels..          
-00017930: 2020 5b28 302c 2030 2c20 3029 2c20 2830    [(0, 0, 0), (0
-00017940: 2c20 302c 2030 295d 202b 205b 2830 2c20  , 0, 0)] + [(0, 
-00017950: 302c 2073 202d 2031 2920 666f 7220 7320  0, s - 1) for s 
-00017960: 696e 2073 7472 6964 655d 2c0a 2020 2020  in stride],.    
-00017970: 2020 2020 292c 0a20 2020 2020 2020 2074      ),.        t
-00017980: 7261 6e73 706f 7365 5f61 6e64 5f66 6c69  ranspose_and_fli
-00017990: 705f 7765 6967 6874 2877 6569 6768 7429  p_weight(weight)
-000179a0: 2c0a 2020 2020 2020 2020 4e6f 6e65 2c0a  ,.        None,.
-000179b0: 2020 2020 2020 2020 2320 5365 7474 696e          # Settin
-000179c0: 6720 7374 7269 6465 2074 6f20 3120 6173  g stride to 1 as
-000179d0: 2074 6865 2064 6973 7461 6e63 6520 6265   the distance be
-000179e0: 7477 6565 6e20 7069 7865 6c73 2069 7320  tween pixels is 
-000179f0: 7461 6b65 6e0a 2020 2020 2020 2020 2320  taken.        # 
-00017a00: 6361 7265 2062 7920 7468 6520 7061 6420  care by the pad 
-00017a10: 7269 6768 7420 6162 6f76 652e 0a20 2020  right above..   
-00017a20: 2020 2020 2028 312c 292c 0a20 2020 2020       (1,),.     
-00017a30: 2020 2069 6e69 7469 616c 5f67 7261 645f     initial_grad_
-00017a40: 7061 6464 696e 672c 0a20 2020 2020 2020  padding,.       
-00017a50: 2064 696c 6174 696f 6e2c 0a20 2020 2020   dilation,.     
-00017a60: 2020 2074 7261 6e73 706f 7365 642c 0a20     transposed,. 
-00017a70: 2020 2020 2020 206f 7574 7075 745f 7061         output_pa
-00017a80: 6464 696e 672c 0a20 2020 2020 2020 2067  dding,.        g
-00017a90: 726f 7570 732c 0a20 2020 2029 0a0a 2020  roups,.    )..  
-00017aa0: 2020 6465 6620 7061 645f 746f 5f69 6e70    def pad_to_inp
-00017ab0: 7574 2867 7261 6429 3a0a 2020 2020 2020  ut(grad):.      
-00017ac0: 2020 2320 5765 206e 6565 6420 746f 2075    # We need to u
-00017ad0: 6e70 6164 2074 6865 2070 6164 6469 6e67  npad the padding
-00017ae0: 2064 6f6e 6520 746f 2074 6865 2069 6e70   done to the inp
-00017af0: 7574 2070 7269 6f72 2074 6f20 7468 6520  ut prior to the 
-00017b00: 636f 6e76 6f6c 7574 696f 6e2e 0a20 2020  convolution..   
-00017b10: 2020 2020 2023 204e 6f74 6520 7468 6174       # Note that
-00017b20: 206c 6f77 2061 6e64 2068 6967 6820 7061   low and high pa
-00017b30: 6464 696e 6720 6172 6520 6e6f 7420 6e65  dding are not ne
-00017b40: 6365 7373 6172 696c 7920 6571 7561 6c2c  cessarily equal,
-00017b50: 2073 6f20 7765 2063 616e 6e6f 740a 2020   so we cannot.  
-00017b60: 2020 2020 2020 2320 6162 736f 7262 2069        # absorb i
-00017b70: 7420 696e 746f 2074 6865 2063 6f6e 766f  t into the convo
-00017b80: 6c75 7469 6f6e 206a 7573 7420 7965 742c  lution just yet,
-00017b90: 2075 6e6c 6573 7320 7468 6520 4150 4920   unless the API 
-00017ba0: 6973 206d 6f64 6966 6965 642e 0a20 2020  is modified..   
-00017bb0: 2020 2020 2070 6164 5f63 6f6e 6669 6720       pad_config 
-00017bc0: 3d20 5b28 302c 2030 2c20 3029 2c20 2830  = [(0, 0, 0), (0
-00017bd0: 2c20 302c 2030 295d 0a20 2020 2020 2020  , 0, 0)].       
-00017be0: 2066 6f72 206f 2c20 692c 2067 2c20 7020   for o, i, g, p 
-00017bf0: 696e 207a 6970 2867 7261 642e 7368 6170  in zip(grad.shap
-00017c00: 655b 323a 5d2c 2073 7061 7469 616c 5f64  e[2:], spatial_d
-00017c10: 696d 732c 2069 6e70 7574 5f67 7261 642e  ims, input_grad.
-00017c20: 7368 6170 655b 323a 5d2c 2070 6164 6469  shape[2:], paddi
-00017c30: 6e67 293a 0a20 2020 2020 2020 2020 2020  ng):.           
-00017c40: 206c 6f20 3d20 2d70 0a20 2020 2020 2020   lo = -p.       
-00017c50: 2020 2020 2023 204e 6f74 6520 7468 6174       # Note that
-00017c60: 2028 6920 2b20 3220 2a20 7029 2069 7320   (i + 2 * p) is 
-00017c70: 7468 6520 7369 7a65 206f 6620 7468 6520  the size of the 
-00017c80: 7061 6464 6564 2069 6e70 7574 2c0a 2020  padded input,.  
-00017c90: 2020 2020 2020 2020 2020 2320 736f 2074            # so t
-00017ca0: 6865 2071 7561 6e74 6974 7920 2869 202b  he quantity (i +
-00017cb0: 2032 202a 2070 2920 2d20 6720 7465 6c6c   2 * p) - g tell
-00017cc0: 7320 7573 2062 7920 686f 7720 6d75 6368  s us by how much
-00017cd0: 0a20 2020 2020 2020 2020 2020 2023 2077  .            # w
-00017ce0: 6520 6e65 6564 2074 6f20 7061 6420 7468  e need to pad th
-00017cf0: 6520 6772 6164 6965 6e74 2073 6f20 7468  e gradient so th
-00017d00: 6174 2074 6865 2065 6c65 6d65 6e74 7320  at the elements 
-00017d10: 6f75 7473 6964 650a 2020 2020 2020 2020  outside.        
-00017d20: 2020 2020 2320 6f66 2074 6865 2063 6f6e      # of the con
-00017d30: 766f 6c75 7469 6f6e 2072 6563 6569 7665  volution receive
-00017d40: 207a 6572 6f20 6772 6164 6965 6e74 2e0a   zero gradient..
-00017d50: 2020 2020 2020 2020 2020 2020 2320 7020              # p 
-00017d60: 6973 2061 6464 6974 696f 6e61 6c6c 7920  is additionally 
-00017d70: 7375 6274 7261 6374 6564 2074 6f20 6e65  subtracted to ne
-00017d80: 6761 7465 2074 6865 2069 6e70 7574 2773  gate the input's
-00017d90: 2070 6164 0a20 2020 2020 2020 2020 2020   pad.           
-00017da0: 2023 2069 6e20 666f 7277 6172 642e 0a20   # in forward.. 
-00017db0: 2020 2020 2020 2020 2020 2068 6920 3d20             hi = 
-00017dc0: 2869 202b 2032 202a 2070 2920 2d20 6720  (i + 2 * p) - g 
-00017dd0: 2d20 700a 2020 2020 2020 2020 2020 2020  - p.            
-00017de0: 7061 645f 636f 6e66 6967 2e61 7070 656e  pad_config.appen
-00017df0: 6428 286c 6f2c 2068 692c 2030 2929 0a20  d((lo, hi, 0)). 
-00017e00: 2020 2020 2020 2072 6574 7572 6e20 7072         return pr
-00017e10: 696d 732e 7061 6428 6772 6164 2c20 302e  ims.pad(grad, 0.
-00017e20: 302c 2070 6164 5f63 6f6e 6669 6729 0a0a  0, pad_config)..
-00017e30: 2020 2020 696e 7075 745f 6772 6164 203d      input_grad =
-00017e40: 2070 6164 5f74 6f5f 696e 7075 7428 696e   pad_to_input(in
-00017e50: 7075 745f 6772 6164 290a 2020 2020 2320  put_grad).    # 
-00017e60: 7d0a 0a20 2020 2023 2062 6961 735f 6772  }..    # bias_gr
-00017e70: 6164 203d 207b 0a20 2020 2069 6620 6269  ad = {.    if bi
-00017e80: 6173 2069 7320 6e6f 7420 4e6f 6e65 3a0a  as is not None:.
-00017e90: 2020 2020 2020 2020 696d 706f 7274 2074          import t
-00017ea0: 6875 6e64 6572 2e74 6f72 6368 2061 7320  hunder.torch as 
-00017eb0: 6c74 6f72 6368 0a0a 2020 2020 2020 2020  ltorch..        
-00017ec0: 6269 6173 5f67 7261 6420 3d20 6c74 6f72  bias_grad = ltor
-00017ed0: 6368 2e73 756d 2867 7261 642c 205b 6420  ch.sum(grad, [d 
-00017ee0: 666f 7220 6420 696e 2072 616e 6765 2867  for d in range(g
-00017ef0: 7261 642e 6e64 696d 2920 6966 2064 2021  rad.ndim) if d !
-00017f00: 3d20 315d 290a 2020 2020 2320 7d0a 0a20  = 1]).    # }.. 
-00017f10: 2020 2023 2077 6569 6768 7420 6772 6164     # weight grad
-00017f20: 203d 207b 0a20 2020 2064 6566 2070 6164   = {.    def pad
-00017f30: 5f74 7261 6e73 706f 7365 5f61 6e64 5f70  _transpose_and_p
-00017f40: 7573 685f 6772 6f75 7073 5f69 6e74 6f5f  ush_groups_into_
-00017f50: 6261 7463 6865 7328 7429 3a0a 2020 2020  batches(t):.    
-00017f60: 2020 2020 2320 4669 7273 7420 7061 642c      # First pad,
-00017f70: 2e2e 2e0a 2020 2020 2020 2020 2320 5061  ....        # Pa
-00017f80: 6420 6173 206e 6563 6573 7361 7279 2073  d as necessary s
-00017f90: 6f20 7468 6174 2069 6e20 636f 6e76 6f6c  o that in convol
-00017fa0: 7574 696f 6e73 2077 6520 6e65 7665 7220  utions we never 
-00017fb0: 6164 7661 6e63 650a 2020 2020 2020 2020  advance.        
-00017fc0: 2320 7061 7374 2072 656c 6576 616e 7420  # past relevant 
-00017fd0: 696e 7075 7473 2e0a 2020 2020 2020 2020  inputs..        
-00017fe0: 7061 645f 636f 6e66 6967 203d 205b 2830  pad_config = [(0
-00017ff0: 2c20 302c 2030 292c 2028 302c 2030 2c20  , 0, 0), (0, 0, 
-00018000: 3029 5d0a 2020 2020 2020 2020 666f 7220  0)].        for 
-00018010: 6f2c 2069 2c20 6b2c 2070 2c20 732c 2064  o, i, k, p, s, d
-00018020: 2069 6e20 7a69 7028 6772 6164 2e73 6861   in zip(grad.sha
-00018030: 7065 5b32 3a5d 2c20 7370 6174 6961 6c5f  pe[2:], spatial_
-00018040: 6469 6d73 2c20 6b65 726e 656c 5f64 696d  dims, kernel_dim
-00018050: 732c 2070 6164 6469 6e67 2c20 7374 7269  s, padding, stri
-00018060: 6465 2c20 6469 6c61 7469 6f6e 293a 0a20  de, dilation):. 
-00018070: 2020 2020 2020 2020 2020 2023 2050 6164             # Pad
-00018080: 6469 6e67 2066 726f 6d20 6265 6c6f 7720  ding from below 
-00018090: 6973 2074 6865 2073 616d 652e 0a20 2020  is the same..   
-000180a0: 2020 2020 2020 2020 206c 6f20 3d20 700a           lo = p.
-000180b0: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-000180c0: 6572 6520 6973 2061 6c77 6179 7320 7468  ere is always th
-000180d0: 6520 6d61 7820 696e 6465 7820 6964 7820  e max index idx 
-000180e0: 696e 2074 6865 2069 6e70 7574 0a20 2020  in the input.   
-000180f0: 2020 2020 2020 2020 2023 2074 6865 2076           # the v
-00018100: 616c 7565 206f 6620 7768 6963 682c 2069  alue of which, i
-00018110: 6e70 7574 5b69 6478 5d2c 2074 6865 206b  nput[idx], the k
-00018120: 6572 6e65 6c20 746f 7563 6865 732e 0a20  ernel touches.. 
-00018130: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-00018140: 206b 6572 6e65 6c20 7265 6163 682c 206f   kernel reach, o
-00018150: 7220 6b5f 7265 6163 682c 2069 7320 6578  r k_reach, is ex
-00018160: 6163 746c 7920 6964 7820 2b20 312e 0a20  actly idx + 1.. 
-00018170: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
-00018180: 7573 6520 6974 2074 6f20 6465 6369 6465  use it to decide
-00018190: 2062 7920 686f 7720 6d75 6368 2077 6520   by how much we 
-000181a0: 6e65 6564 2074 6f20 7061 6420 6672 6f6d  need to pad from
-000181b0: 2061 626f 7665 0a20 2020 2020 2020 2020   above.         
-000181c0: 2020 2023 2061 7320 746f 206e 6f74 206d     # as to not m
-000181d0: 6f76 6520 7061 7374 2072 656c 6576 616e  ove past relevan
-000181e0: 7420 7661 6c75 6573 2e0a 2020 2020 2020  t values..      
-000181f0: 2020 2020 2020 6b5f 7265 6163 6820 3d20        k_reach = 
-00018200: 286f 202d 2031 2920 2a20 7320 2b20 6420  (o - 1) * s + d 
-00018210: 2a20 286b 202d 2031 2920 2b20 310a 2020  * (k - 1) + 1.  
-00018220: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00018230: 7061 6420 6672 6f6d 2061 626f 7665 2065  pad from above e
-00018240: 7175 616c 7320 6b5f 7265 6163 6820 6d69  quals k_reach mi
-00018250: 6e75 7320 7468 6520 6c65 6e67 7468 0a20  nus the length. 
-00018260: 2020 2020 2020 2020 2020 2023 206f 6620             # of 
-00018270: 7468 6520 696e 7075 7420 7061 6464 6564  the input padded
-00018280: 2066 726f 6d20 6265 6c6f 772e 0a20 2020   from below..   
-00018290: 2020 2020 2020 2020 2068 6920 3d20 6b5f           hi = k_
-000182a0: 7265 6163 6820 2d20 2869 202b 2070 290a  reach - (i + p).
-000182b0: 2020 2020 2020 2020 2020 2020 7061 645f              pad_
-000182c0: 636f 6e66 6967 2e61 7070 656e 6428 286c  config.append((l
-000182d0: 6f2c 2068 692c 2030 2929 0a20 2020 2020  o, hi, 0)).     
-000182e0: 2020 2074 203d 2070 7269 6d73 2e70 6164     t = prims.pad
-000182f0: 2874 2c20 302e 302c 2070 6164 5f63 6f6e  (t, 0.0, pad_con
-00018300: 6669 6729 0a0a 2020 2020 2020 2020 5f2c  fig)..        _,
-00018310: 205f 2c20 2a74 5f73 7061 7469 616c 5f64   _, *t_spatial_d
-00018320: 696d 7320 3d20 742e 7368 6170 650a 0a20  ims = t.shape.. 
-00018330: 2020 2020 2020 2023 202e 2e2e 2074 6865         # ... the
-00018340: 6e20 646f 2074 6865 2072 6573 742e 0a20  n do the rest.. 
-00018350: 2020 2020 2020 2023 2074 2e73 6861 7065         # t.shape
-00018360: 203d 3d20 2862 6174 6368 2c20 696e 5f63   == (batch, in_c
-00018370: 6861 6e6e 656c 732c 202e 2e2e 290a 2020  hannels, ...).  
-00018380: 2020 2020 2020 2320 5468 6520 7265 7375        # The resu
-00018390: 6c74 206f 6620 7468 6973 2066 756e 6374  lt of this funct
-000183a0: 696f 6e20 6861 7320 7368 6170 650a 2020  ion has shape.  
-000183b0: 2020 2020 2020 2320 2869 6e5f 6368 616e        # (in_chan
-000183c0: 6e65 6c73 2c20 6261 7463 6820 2a20 6772  nels, batch * gr
-000183d0: 6f75 7073 290a 2020 2020 2020 2020 2320  oups).        # 
-000183e0: 2862 6174 6368 2c20 696e 5f63 6861 6e6e  (batch, in_chann
-000183f0: 656c 7329 202d 3e20 2869 6e5f 6368 616e  els) -> (in_chan
-00018400: 6e65 6c73 2c20 6261 7463 6829 0a20 2020  nels, batch).   
-00018410: 2020 2020 2074 203d 2063 6f6e 765f 7472       t = conv_tr
-00018420: 616e 7370 6f73 6528 7429 0a20 2020 2020  anspose(t).     
-00018430: 2020 2023 2053 706c 6974 2028 696e 5f63     # Split (in_c
-00018440: 6861 6e6e 656c 732c 2920 2d3e 2028 6772  hannels,) -> (gr
-00018450: 6f75 7073 2c20 6769 6e5f 6368 616e 6e65  oups, gin_channe
-00018460: 6c73 290a 2020 2020 2020 2020 7420 3d20  ls).        t = 
-00018470: 742e 7265 7368 6170 6528 5b67 726f 7570  t.reshape([group
-00018480: 732c 2067 696e 5f63 6861 6e6e 656c 732c  s, gin_channels,
-00018490: 2062 6174 6368 5d20 2b20 745f 7370 6174   batch] + t_spat
-000184a0: 6961 6c5f 6469 6d73 290a 2020 2020 2020  ial_dims).      
-000184b0: 2020 2320 5472 616e 7370 6f73 6520 2867    # Transpose (g
-000184c0: 726f 7570 732c 2067 696e 5f63 6861 6e6e  roups, gin_chann
-000184d0: 656c 732c 2062 6174 6368 2920 2d3e 2028  els, batch) -> (
-000184e0: 6769 6e5f 6368 616e 6e65 6c73 2c20 6772  gin_channels, gr
-000184f0: 6f75 7073 2c20 6261 7463 6829 0a20 2020  oups, batch).   
-00018500: 2020 2020 2074 203d 2063 6f6e 765f 7472       t = conv_tr
-00018510: 616e 7370 6f73 6528 7429 0a20 2020 2020  anspose(t).     
-00018520: 2020 2023 2046 6c61 7474 656e 2028 6772     # Flatten (gr
-00018530: 6f75 7073 2c20 6261 7463 6829 202d 3e20  oups, batch) -> 
-00018540: 2867 726f 7570 7320 2a20 6261 7463 682c  (groups * batch,
-00018550: 290a 2020 2020 2020 2020 7420 3d20 742e  ).        t = t.
-00018560: 7265 7368 6170 6528 5b67 696e 5f63 6861  reshape([gin_cha
-00018570: 6e6e 656c 732c 2067 726f 7570 7320 2a20  nnels, groups * 
-00018580: 6261 7463 685d 202b 2074 5f73 7061 7469  batch] + t_spati
-00018590: 616c 5f64 696d 7329 0a20 2020 2020 2020  al_dims).       
-000185a0: 2072 6574 7572 6e20 740a 0a20 2020 2023   return t..    #
-000185b0: 2069 6e70 7574 2077 696c 6c20 6861 7665   input will have
-000185c0: 2073 6861 7065 2028 6769 6e5f 6368 616e   shape (gin_chan
-000185d0: 6e65 6c73 2c20 6772 6f75 7073 202a 2062  nels, groups * b
-000185e0: 6174 6368 290a 2020 2020 696e 7075 7420  atch).    input 
-000185f0: 3d20 7061 645f 7472 616e 7370 6f73 655f  = pad_transpose_
-00018600: 616e 645f 7075 7368 5f67 726f 7570 735f  and_push_groups_
-00018610: 696e 746f 5f62 6174 6368 6573 2869 6e70  into_batches(inp
-00018620: 7574 290a 2020 2020 2320 6772 6164 2077  ut).    # grad w
-00018630: 696c 6c20 6861 7665 2073 6861 7065 2028  ill have shape (
-00018640: 6f75 745f 6368 616e 6e65 6c73 2c20 6261  out_channels, ba
-00018650: 7463 6829 0a20 2020 2023 204e 6f74 6520  tch).    # Note 
-00018660: 7468 6174 2074 6865 7365 2073 6861 7065  that these shape
-00018670: 7320 6172 6520 636f 6d70 6174 6962 6c65  s are compatible
-00018680: 2066 6f72 2061 2067 726f 7570 2063 6f6e   for a group con
-00018690: 766f 6c75 7469 6f6e 2e0a 2020 2020 6772  volution..    gr
-000186a0: 6164 203d 2063 6f6e 765f 7472 616e 7370  ad = conv_transp
-000186b0: 6f73 6528 6772 6164 290a 0a20 2020 2023  ose(grad)..    #
-000186c0: 2057 6879 2064 6f20 7765 2066 6c69 7020   Why do we flip 
-000186d0: 7374 7269 6465 2061 6e64 2064 696c 6174  stride and dilat
-000186e0: 696f 6e3f 0a20 2020 2023 206b 6572 6e65  ion?.    # kerne
-000186f0: 6c5b 695d 2061 6e64 206b 6572 6e65 6c5b  l[i] and kernel[
-00018700: 6920 2b20 315d 2061 7265 2064 696c 6174  i + 1] are dilat
-00018710: 696f 6e20 6170 6172 7420 6672 6f6d 2065  ion apart from e
-00018720: 6163 6820 6f74 6865 722c 0a20 2020 2023  ach other,.    #
-00018730: 2073 6f20 6469 6c61 7469 6f6e 2062 6563   so dilation bec
-00018740: 6f6d 6573 2074 6865 206e 6577 2073 7472  omes the new str
-00018750: 6964 652e 0a20 2020 2023 2041 6c6c 2074  ide..    # All t
-00018760: 6865 2065 6c65 6d65 6e74 7320 7468 6174  he elements that
-00018770: 206b 6572 6e65 6c5b 695d 2074 6f75 6368   kernel[i] touch
-00018780: 6573 2061 7265 2073 7472 6964 6520 6177  es are stride aw
-00018790: 6179 2066 726f 6d20 6561 6368 206f 7468  ay from each oth
-000187a0: 6572 2c0a 2020 2020 2320 6865 6e63 6520  er,.    # hence 
-000187b0: 7374 7269 6465 2062 6563 6f6d 6573 2074  stride becomes t
-000187c0: 6865 206e 6577 2064 696c 6174 696f 6e2e  he new dilation.
-000187d0: 0a20 2020 2077 6569 6768 745f 6772 6164  .    weight_grad
-000187e0: 203d 2063 6f6e 766f 6c75 7469 6f6e 280a   = convolution(.
-000187f0: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
-00018800: 2020 2020 2020 2067 7261 642c 0a20 2020         grad,.   
-00018810: 2020 2020 204e 6f6e 652c 0a20 2020 2020       None,.     
-00018820: 2020 2064 696c 6174 696f 6e2c 2020 2320     dilation,  # 
-00018830: 7365 7420 7374 7269 6465 3d64 696c 6174  set stride=dilat
-00018840: 696f 6e0a 2020 2020 2020 2020 2830 2c29  ion.        (0,)
-00018850: 2c0a 2020 2020 2020 2020 7374 7269 6465  ,.        stride
-00018860: 2c20 2023 2073 6574 2064 696c 6174 696f  ,  # set dilatio
-00018870: 6e3d 7374 7269 6465 0a20 2020 2020 2020  n=stride.       
-00018880: 2074 7261 6e73 706f 7365 642c 0a20 2020   transposed,.   
-00018890: 2020 2020 206f 7574 7075 745f 7061 6464       output_padd
-000188a0: 696e 672c 0a20 2020 2020 2020 2067 726f  ing,.        gro
-000188b0: 7570 732c 0a20 2020 2029 0a0a 2020 2020  ups,.    )..    
-000188c0: 2320 5468 6520 7265 7375 6c74 206f 6620  # The result of 
-000188d0: 7468 6520 636f 6e76 6f6c 7574 696f 6e20  the convolution 
-000188e0: 6861 7320 7368 6170 6520 2867 696e 5f63  has shape (gin_c
-000188f0: 6861 6e6e 656c 732c 206f 7574 5f63 6861  hannels, out_cha
-00018900: 6e6e 656c 7329 2c0a 2020 2020 2320 736f  nnels),.    # so
-00018910: 2074 7261 6e73 706f 7369 7469 6f6e 2069   transposition i
-00018920: 7320 7265 7175 6972 6564 2e0a 2020 2020  s required..    
-00018930: 7765 6967 6874 5f67 7261 6420 3d20 636f  weight_grad = co
-00018940: 6e76 5f74 7261 6e73 706f 7365 2877 6569  nv_transpose(wei
-00018950: 6768 745f 6772 6164 290a 2020 2020 2320  ght_grad).    # 
-00018960: 7d0a 0a20 2020 2072 6574 7572 6e20 2869  }..    return (i
-00018970: 6e70 7574 5f67 7261 642c 2077 6569 6768  nput_grad, weigh
-00018980: 745f 6772 6164 2c20 6269 6173 5f67 7261  t_grad, bias_gra
-00018990: 6429 0a0a 0a40 7265 6769 7374 6572 5f61  d)...@register_a
-000189a0: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-000189b0: 2822 746f 7263 682e 6c6f 675f 736f 6674  ("torch.log_soft
-000189c0: 6d61 7822 290a 6465 6620 6c6f 675f 736f  max").def log_so
-000189d0: 6674 6d61 785f 6175 675f 6677 6428 696e  ftmax_aug_fwd(in
-000189e0: 7075 743a 2054 656e 736f 7250 726f 7879  put: TensorProxy
-000189f0: 2c20 6469 6d3a 2069 6e74 2c20 2a2c 2064  , dim: int, *, d
-00018a00: 7479 7065 3d4e 6f6e 6529 202d 3e20 564a  type=None) -> VJ
-00018a10: 5044 7561 6c3a 0a20 2020 2066 726f 6d20  PDual:.    from 
-00018a20: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
-00018a30: 706f 7274 206c 6f67 5f73 6f66 746d 6178  port log_softmax
-00018a40: 0a0a 2020 2020 7072 696d 616c 203d 206c  ..    primal = l
-00018a50: 6f67 5f73 6f66 746d 6178 2869 6e70 7574  og_softmax(input
-00018a60: 2c20 6469 6d3d 6469 6d2c 2064 7479 7065  , dim=dim, dtype
-00018a70: 3d64 7479 7065 290a 2020 2020 7265 7369  =dtype).    resi
-00018a80: 6475 616c 7320 3d20 2870 7269 6d61 6c2c  duals = (primal,
-00018a90: 2064 696d 2c20 696e 7075 742e 6474 7970   dim, input.dtyp
-00018aa0: 6529 0a20 2020 2072 6574 7572 6e20 564a  e).    return VJ
-00018ab0: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
-00018ac0: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
-00018ad0: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
-00018ae0: 6f72 6368 2e6c 6f67 5f73 6f66 746d 6178  orch.log_softmax
-00018af0: 2229 0a64 6566 206c 6f67 5f73 6f66 746d  ").def log_softm
-00018b00: 6178 5f62 6163 6b77 6172 6428 7072 696d  ax_backward(prim
-00018b10: 616c 2c20 6469 6d2c 2064 7479 7065 2c20  al, dim, dtype, 
-00018b20: 6729 3a0a 2020 2020 6672 6f6d 2074 6875  g):.    from thu
-00018b30: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
-00018b40: 7420 6c6f 675f 736f 6674 6d61 785f 6261  t log_softmax_ba
-00018b50: 636b 7761 7264 0a0a 2020 2020 7265 7475  ckward..    retu
-00018b60: 726e 206c 6f67 5f73 6f66 746d 6178 5f62  rn log_softmax_b
-00018b70: 6163 6b77 6172 6428 672c 2070 7269 6d61  ackward(g, prima
-00018b80: 6c2c 2064 696d 2c20 6474 7970 6529 0a0a  l, dim, dtype)..
-00018b90: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
-00018ba0: 6e74 6564 5f66 6f72 7761 7264 2822 746f  nted_forward("to
-00018bb0: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
-00018bc0: 6c2e 6e6c 6c5f 6c6f 7373 2229 0a64 6566  l.nll_loss").def
-00018bd0: 206e 6c6c 5f6c 6f73 735f 6175 675f 6677   nll_loss_aug_fw
-00018be0: 6428 0a20 2020 2069 6e70 7574 3a20 5072  d(.    input: Pr
-00018bf0: 6f78 792c 0a20 2020 2074 6172 6765 743a  oxy,.    target:
-00018c00: 2050 726f 7879 2c0a 2020 2020 7765 6967   Proxy,.    weig
-00018c10: 6874 3a20 4e6f 6e65 207c 2050 726f 7879  ht: None | Proxy
-00018c20: 2c0a 2020 2020 6967 6e6f 7265 5f69 6e64  ,.    ignore_ind
-00018c30: 6578 3a20 696e 742c 0a20 2020 2072 6564  ex: int,.    red
-00018c40: 7563 7469 6f6e 3a20 7374 722c 0a29 202d  uction: str,.) -
-00018c50: 3e20 564a 5044 7561 6c3a 0a20 2020 2066  > VJPDual:.    f
-00018c60: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
-00018c70: 6820 696d 706f 7274 205f 6e6c 6c5f 6c6f  h import _nll_lo
-00018c80: 7373 5f68 656c 7065 720a 0a20 2020 2070  ss_helper..    p
-00018c90: 7269 6d61 6c2c 2074 6f74 616c 5f77 6569  rimal, total_wei
-00018ca0: 6768 7420 3d20 5f6e 6c6c 5f6c 6f73 735f  ght = _nll_loss_
-00018cb0: 6865 6c70 6572 280a 2020 2020 2020 2020  helper(.        
-00018cc0: 696e 7075 742c 0a20 2020 2020 2020 2074  input,.        t
-00018cd0: 6172 6765 742c 0a20 2020 2020 2020 2077  arget,.        w
-00018ce0: 6569 6768 742c 0a20 2020 2020 2020 2069  eight,.        i
-00018cf0: 676e 6f72 655f 696e 6465 782c 0a20 2020  gnore_index,.   
-00018d00: 2020 2020 2072 6564 7563 7469 6f6e 2c0a       reduction,.
-00018d10: 2020 2020 290a 2020 2020 7265 7369 6475      ).    residu
-00018d20: 616c 7320 3d20 2869 6e70 7574 2c20 7461  als = (input, ta
-00018d30: 7267 6574 2c20 7765 6967 6874 2c20 7265  rget, weight, re
-00018d40: 6475 6374 696f 6e2c 2069 676e 6f72 655f  duction, ignore_
-00018d50: 696e 6465 782c 2074 6f74 616c 5f77 6569  index, total_wei
-00018d60: 6768 7429 0a20 2020 2072 6574 7572 6e20  ght).    return 
-00018d70: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-00018d80: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
-00018d90: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-00018da0: 2274 6f72 6368 2e6e 6e2e 6675 6e63 7469  "torch.nn.functi
-00018db0: 6f6e 616c 2e6e 6c6c 5f6c 6f73 7322 290a  onal.nll_loss").
-00018dc0: 6465 6620 6e6c 6c5f 6c6f 7373 5f62 6163  def nll_loss_bac
-00018dd0: 6b77 6172 6428 696e 7075 742c 2074 6172  kward(input, tar
-00018de0: 6765 742c 2077 6569 6768 742c 2072 6564  get, weight, red
-00018df0: 7563 7469 6f6e 2c20 6967 6e6f 7265 5f69  uction, ignore_i
-00018e00: 6e64 6578 2c20 746f 7461 6c5f 7765 6967  ndex, total_weig
-00018e10: 6874 2c20 6729 3a0a 2020 2020 6672 6f6d  ht, g):.    from
-00018e20: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
-00018e30: 6d70 6f72 7420 6e6c 6c5f 6c6f 7373 5f62  mport nll_loss_b
-00018e40: 6163 6b77 6172 640a 0a20 2020 2067 696e  ackward..    gin
-00018e50: 7075 7420 3d20 6e6c 6c5f 6c6f 7373 5f62  put = nll_loss_b
-00018e60: 6163 6b77 6172 6428 672c 2069 6e70 7574  ackward(g, input
-00018e70: 2c20 7461 7267 6574 2c20 7765 6967 6874  , target, weight
-00018e80: 2c20 7265 6475 6374 696f 6e2c 2069 676e  , reduction, ign
-00018e90: 6f72 655f 696e 6465 782c 2074 6f74 616c  ore_index, total
-00018ea0: 5f77 6569 6768 7429 0a20 2020 2072 6574  _weight).    ret
-00018eb0: 7572 6e20 6769 6e70 7574 2c20 2a28 284e  urn ginput, *((N
-00018ec0: 6f6e 652c 2920 2a20 3429 0a0a 0a40 7265  one,) * 4)...@re
-00018ed0: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
-00018ee0: 5f66 6f72 7761 7264 2822 746f 7263 682e  _forward("torch.
-00018ef0: 7370 6c69 7422 290a 6465 6620 7370 6c69  split").def spli
-00018f00: 745f 6175 675f 6677 6428 613a 2054 656e  t_aug_fwd(a: Ten
-00018f10: 736f 7250 726f 7879 2c20 7370 6c69 745f  sorProxy, split_
-00018f20: 7369 7a65 5f6f 725f 7365 6374 696f 6e73  size_or_sections
-00018f30: 3a20 696e 7420 7c20 5365 7175 656e 6365  : int | Sequence
-00018f40: 5b69 6e74 5d2c 2064 696d 3a20 696e 7420  [int], dim: int 
-00018f50: 3d20 3029 202d 3e20 564a 5044 7561 6c3a  = 0) -> VJPDual:
-00018f60: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00018f70: 722e 746f 7263 6820 696d 706f 7274 2073  r.torch import s
-00018f80: 706c 6974 0a0a 2020 2020 7072 696d 616c  plit..    primal
-00018f90: 203d 2073 706c 6974 2861 2c20 7370 6c69   = split(a, spli
-00018fa0: 745f 7369 7a65 5f6f 725f 7365 6374 696f  t_size_or_sectio
-00018fb0: 6e73 2c20 6469 6d29 0a20 2020 2072 6573  ns, dim).    res
-00018fc0: 6964 7561 6c73 203d 2028 6469 6d2c 290a  iduals = (dim,).
-00018fd0: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-00018fe0: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
-00018ff0: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
-00019000: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
-00019010: 682e 7370 6c69 7422 290a 6465 6620 7370  h.split").def sp
-00019020: 6c69 745f 6261 636b 7761 7264 2864 696d  lit_backward(dim
-00019030: 2c20 2a67 7261 6473 293a 0a20 2020 2066  , *grads):.    f
-00019040: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
-00019050: 6820 696d 706f 7274 2063 6174 0a0a 2020  h import cat..  
-00019060: 2020 7265 7475 726e 2063 6174 2867 7261    return cat(gra
-00019070: 6473 2c20 6469 6d29 0a0a 0a40 7265 6769  ds, dim)...@regi
-00019080: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
-00019090: 6f72 7761 7264 2822 746f 7263 682e 6e6e  orward("torch.nn
-000190a0: 2e66 756e 6374 696f 6e61 6c2e 656d 6265  .functional.embe
-000190b0: 6464 696e 6722 290a 6465 6620 656d 6265  dding").def embe
-000190c0: 6464 696e 675f 6175 675f 6677 6428 0a20  dding_aug_fwd(. 
-000190d0: 2020 2061 3a20 5072 6f78 792c 0a20 2020     a: Proxy,.   
-000190e0: 2077 6569 6768 743a 2050 726f 7879 2c0a   weight: Proxy,.
-000190f0: 2020 2020 7061 6464 696e 675f 6964 783a      padding_idx:
-00019100: 2069 6e74 207c 204e 6f6e 652c 0a20 2020   int | None,.   
-00019110: 206d 6178 5f6e 6f72 6d3a 2066 6c6f 6174   max_norm: float
-00019120: 207c 204e 6f6e 652c 0a20 2020 206e 6f72   | None,.    nor
-00019130: 6d5f 7479 7065 3a20 666c 6f61 742c 0a20  m_type: float,. 
-00019140: 2020 2073 6361 6c65 5f67 7261 645f 6279     scale_grad_by
-00019150: 5f66 7265 713a 2062 6f6f 6c2c 0a20 2020  _freq: bool,.   
-00019160: 2073 7061 7273 653a 2062 6f6f 6c2c 0a29   sparse: bool,.)
-00019170: 202d 3e20 564a 5044 7561 6c3a 0a20 2020   -> VJPDual:.   
-00019180: 2066 726f 6d20 7468 756e 6465 722e 746f   from thunder.to
-00019190: 7263 6820 696d 706f 7274 2065 6d62 6564  rch import embed
-000191a0: 6469 6e67 0a0a 2020 2020 7072 696d 616c  ding..    primal
-000191b0: 203d 2065 6d62 6564 6469 6e67 280a 2020   = embedding(.  
-000191c0: 2020 2020 2020 612c 0a20 2020 2020 2020        a,.       
-000191d0: 2077 6569 6768 742c 0a20 2020 2020 2020   weight,.       
-000191e0: 2070 6164 6469 6e67 5f69 6478 3d70 6164   padding_idx=pad
-000191f0: 6469 6e67 5f69 6478 2c0a 2020 2020 2020  ding_idx,.      
-00019200: 2020 6d61 785f 6e6f 726d 3d6d 6178 5f6e    max_norm=max_n
-00019210: 6f72 6d2c 0a20 2020 2020 2020 206e 6f72  orm,.        nor
-00019220: 6d5f 7479 7065 3d6e 6f72 6d5f 7479 7065  m_type=norm_type
-00019230: 2c0a 2020 2020 2020 2020 7363 616c 655f  ,.        scale_
-00019240: 6772 6164 5f62 795f 6672 6571 3d73 6361  grad_by_freq=sca
-00019250: 6c65 5f67 7261 645f 6279 5f66 7265 712c  le_grad_by_freq,
-00019260: 0a20 2020 2020 2020 2073 7061 7273 653d  .        sparse=
-00019270: 7370 6172 7365 2c0a 2020 2020 290a 2020  sparse,.    ).  
-00019280: 2020 7265 7369 6475 616c 7320 3d20 2861    residuals = (a
-00019290: 2c20 7765 6967 6874 2e73 6861 7065 5b30  , weight.shape[0
-000192a0: 5d2c 2070 6164 6469 6e67 5f69 6478 2c20  ], padding_idx, 
-000192b0: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
-000192c0: 6571 2c20 7370 6172 7365 290a 2020 2020  eq, sparse).    
-000192d0: 7265 7475 726e 2056 4a50 4475 616c 2870  return VJPDual(p
-000192e0: 7269 6d61 6c2c 2072 6573 6964 7561 6c73  rimal, residuals
-000192f0: 290a 0a0a 4072 6567 6973 7465 725f 6261  )...@register_ba
-00019300: 636b 7761 7264 2822 746f 7263 682e 6e6e  ckward("torch.nn
-00019310: 2e66 756e 6374 696f 6e61 6c2e 656d 6265  .functional.embe
-00019320: 6464 696e 6722 290a 6465 6620 656d 6265  dding").def embe
-00019330: 6464 696e 675f 6261 636b 7761 7264 2861  dding_backward(a
-00019340: 2c20 6e75 6d5f 7765 6967 6874 732c 2070  , num_weights, p
-00019350: 6164 6469 6e67 5f69 6478 2c20 7363 616c  adding_idx, scal
-00019360: 655f 6772 6164 5f62 795f 6672 6571 2c20  e_grad_by_freq, 
-00019370: 7370 6172 7365 2c20 6729 3a0a 2020 2020  sparse, g):.    
-00019380: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-00019390: 6368 2069 6d70 6f72 7420 656d 6265 6464  ch import embedd
-000193a0: 696e 675f 6261 636b 7761 7264 0a0a 2020  ing_backward..  
-000193b0: 2020 7061 6464 696e 675f 6964 7820 3d20    padding_idx = 
-000193c0: 2d31 2069 6620 7061 6464 696e 675f 6964  -1 if padding_id
-000193d0: 7820 6973 204e 6f6e 6520 656c 7365 2070  x is None else p
-000193e0: 6164 6469 6e67 5f69 6478 0a20 2020 2067  adding_idx.    g
-000193f0: 7765 6967 6874 203d 2065 6d62 6564 6469  weight = embeddi
-00019400: 6e67 5f62 6163 6b77 6172 6428 672c 2061  ng_backward(g, a
-00019410: 2c20 6e75 6d5f 7765 6967 6874 732c 2070  , num_weights, p
-00019420: 6164 6469 6e67 5f69 6478 2c20 7363 616c  adding_idx, scal
-00019430: 655f 6772 6164 5f62 795f 6672 6571 2c20  e_grad_by_freq, 
-00019440: 7370 6172 7365 290a 2020 2020 7265 7475  sparse).    retu
-00019450: 726e 2067 7765 6967 6874 0a0a 0a40 7265  rn gweight...@re
-00019460: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
-00019470: 5f66 6f72 7761 7264 2822 746f 7263 682e  _forward("torch.
-00019480: 6375 6d73 756d 2229 0a64 6566 2063 756d  cumsum").def cum
-00019490: 7375 6d5f 6175 675f 6677 6428 613a 2050  sum_aug_fwd(a: P
-000194a0: 726f 7879 2c20 6469 6d3a 2069 6e74 2c20  roxy, dim: int, 
-000194b0: 2a2c 2064 7479 7065 3a20 4e6f 6e65 207c  *, dtype: None |
-000194c0: 2064 7479 7065 732e 6474 7970 6520 3d20   dtypes.dtype = 
-000194d0: 4e6f 6e65 2920 2d3e 2056 4a50 4475 616c  None) -> VJPDual
-000194e0: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
-000194f0: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
-00019500: 6375 6d73 756d 0a0a 2020 2020 7072 696d  cumsum..    prim
-00019510: 616c 203d 2063 756d 7375 6d28 612c 2064  al = cumsum(a, d
-00019520: 696d 2c20 6474 7970 653d 6474 7970 6529  im, dtype=dtype)
-00019530: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
-00019540: 2028 0a20 2020 2020 2020 2061 2e64 7479   (.        a.dty
-00019550: 7065 2c0a 2020 2020 2020 2020 6469 6d2c  pe,.        dim,
-00019560: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
-00019570: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
-00019580: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
-00019590: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-000195a0: 6428 2274 6f72 6368 2e63 756d 7375 6d22  d("torch.cumsum"
-000195b0: 290a 6465 6620 6375 6d73 756d 5f62 6163  ).def cumsum_bac
-000195c0: 6b77 6172 6428 615f 6474 7970 652c 2064  kward(a_dtype, d
-000195d0: 696d 2c20 6729 3a0a 2020 2020 6720 3d20  im, g):.    g = 
-000195e0: 672e 746f 2861 5f64 7479 7065 290a 2020  g.to(a_dtype).  
-000195f0: 2020 6966 2067 2e6e 756d 656c 203c 3d20    if g.numel <= 
-00019600: 3120 6f72 2067 2e73 6861 7065 5b64 696d  1 or g.shape[dim
-00019610: 5d20 3d3d 2031 3a0a 2020 2020 2020 2020  ] == 1:.        
-00019620: 7265 7475 726e 2067 0a20 2020 2072 6574  return g.    ret
-00019630: 7572 6e20 672e 666c 6970 2864 696d 292e  urn g.flip(dim).
-00019640: 6375 6d73 756d 2864 696d 292e 666c 6970  cumsum(dim).flip
-00019650: 2864 696d 290a 0a0a 4072 6567 6973 7465  (dim)...@registe
-00019660: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-00019670: 6172 6428 2274 6f72 6368 2e73 6f66 746d  ard("torch.softm
-00019680: 6178 2229 0a64 6566 2073 6f66 746d 6178  ax").def softmax
-00019690: 5f61 7567 5f66 7764 2861 3a20 5072 6f78  _aug_fwd(a: Prox
-000196a0: 792c 2064 696d 3a20 696e 742c 2064 7479  y, dim: int, dty
-000196b0: 7065 3a20 6474 7970 6573 2e64 7479 7065  pe: dtypes.dtype
-000196c0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
-000196d0: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
-000196e0: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-000196f0: 6368 2069 6d70 6f72 7420 736f 6674 6d61  ch import softma
-00019700: 780a 0a20 2020 2070 7269 6d61 6c20 3d20  x..    primal = 
-00019710: 736f 6674 6d61 7828 612c 2064 696d 2c20  softmax(a, dim, 
-00019720: 6474 7970 653d 6474 7970 6529 0a20 2020  dtype=dtype).   
-00019730: 2072 6573 6964 7561 6c73 203d 2028 7072   residuals = (pr
-00019740: 696d 616c 2c20 6469 6d29 0a20 2020 2072  imal, dim).    r
-00019750: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
-00019760: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
-00019770: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-00019780: 6b77 6172 6428 2274 6f72 6368 2e73 6f66  kward("torch.sof
-00019790: 746d 6178 2229 0a64 6566 2073 6f66 746d  tmax").def softm
-000197a0: 6178 5f62 6163 6b77 6172 6428 7072 696d  ax_backward(prim
-000197b0: 616c 2c20 6469 6d2c 2067 293a 0a20 2020  al, dim, g):.   
-000197c0: 2072 6574 7572 6e20 7072 696d 616c 202a   return primal *
-000197d0: 2028 6720 2d20 2870 7269 6d61 6c20 2a20   (g - (primal * 
-000197e0: 6729 2e73 756d 2864 696d 2c20 6b65 6570  g).sum(dim, keep
-000197f0: 6469 6d3d 5472 7565 2929 0a0a 0a64 6566  dim=True))...def
-00019800: 2069 7465 725f 626f 756e 645f 7379 6d62   iter_bound_symb
-00019810: 6f6c 7328 626f 756e 645f 7379 6d62 6f6c  ols(bound_symbol
-00019820: 7329 3a0a 2020 2020 2222 2249 7465 7261  s):.    """Itera
-00019830: 7465 206f 7665 7220 626f 756e 6420 7379  te over bound sy
-00019840: 6d62 6f6c 732c 2073 6b69 7070 696e 6720  mbols, skipping 
-00019850: 7379 6d62 6f6c 7320 7468 6174 2061 7265  symbols that are
-00019860: 206e 6f74 2073 7570 706f 7274 6564 2062   not supported b
-00019870: 790a 2020 2020 7468 6520 7472 616e 7366  y.    the transf
-00019880: 6f72 6d73 2069 6e66 7261 7374 7275 6374  orms infrastruct
-00019890: 7572 652e 0a0a 2020 2020 4172 6773 3a0a  ure...    Args:.
-000198a0: 2020 2020 2020 2020 626f 756e 645f 7379          bound_sy
-000198b0: 6d62 6f6c 7320 284c 6973 745b 426f 756e  mbols (List[Boun
-000198c0: 6453 796d 626f 6c5d 293a 204c 6973 7420  dSymbol]): List 
-000198d0: 6f66 2062 6f75 6e64 2073 796d 626f 6c73  of bound symbols
-000198e0: 0a0a 2020 2020 5969 656c 6473 3a0a 2020  ..    Yields:.  
-000198f0: 2020 2020 2020 426f 756e 6453 796d 626f        BoundSymbo
-00019900: 6c3a 2042 6f75 6e64 2073 796d 626f 6c73  l: Bound symbols
-00019910: 2074 6861 7420 6172 6520 7375 7070 6f72   that are suppor
-00019920: 7465 6420 6279 2074 6865 2074 7261 6e73  ted by the trans
-00019930: 666f 726d 730a 2020 2020 2020 2020 696e  forms.        in
-00019940: 6672 6173 7472 7563 7475 7265 0a20 2020  frastructure.   
-00019950: 2022 2222 0a20 2020 2066 6f72 2073 796d   """.    for sym
-00019960: 626f 6c20 696e 2062 6f75 6e64 5f73 796d  bol in bound_sym
-00019970: 626f 6c73 3a0a 2020 2020 2020 2020 6966  bols:.        if
-00019980: 2073 796d 626f 6c2e 7379 6d2e 6964 2069   symbol.sym.id i
-00019990: 6e20 7472 616e 7366 6f72 6d5f 736b 6970  n transform_skip
-000199a0: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
-000199b0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-000199c0: 2020 2020 656c 6966 2073 796d 626f 6c2e      elif symbol.
-000199d0: 6f75 7470 7574 2069 7320 4e6f 6e65 3a0a  output is None:.
-000199e0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-000199f0: 696e 7565 0a20 2020 2020 2020 2065 6c73  inue.        els
-00019a00: 653a 0a20 2020 2020 2020 2020 2020 2079  e:.            y
-00019a10: 6965 6c64 2073 796d 626f 6c0a 0a0a 6465  ield symbol...de
-00019a20: 6620 6465 636f 6e73 7472 7563 745f 666f  f deconstruct_fo
-00019a30: 7277 6172 645f 656e 765f 666f 725f 6261  rward_env_for_ba
-00019a40: 636b 7761 7264 2874 7261 6365 2c20 656e  ckward(trace, en
-00019a50: 7629 3a0a 2020 2020 2320 4e6f 7465 205b  v):.    # Note [
-00019a60: 5361 7669 6e67 2074 6865 2066 6f72 7761  Saving the forwa
-00019a70: 7264 2065 6e76 6972 6f6e 6d65 6e74 2069  rd environment i
-00019a80: 6e20 7468 6520 6261 636b 7761 7264 2072  n the backward r
-00019a90: 756c 655d 0a20 2020 2023 2057 6520 6361  ule].    # We ca
-00019aa0: 6e6e 6f74 2073 6176 6520 7468 6520 7472  nnot save the tr
-00019ab0: 6163 6520 6f62 6a65 6374 2069 6e20 7468  ace object in th
-00019ac0: 6520 7265 7369 6475 616c 7320 6265 6361  e residuals beca
-00019ad0: 7573 6520 6578 6563 7574 6f72 7320 6d61  use executors ma
-00019ae0: 7920 6e6f 740a 2020 2020 2320 6265 2061  y not.    # be a
-00019af0: 626c 6520 746f 2072 6574 7572 6e20 6974  ble to return it
-00019b00: 2066 6f72 2074 6865 2073 706c 6974 7465   for the splitte
-00019b10: 6420 666f 7277 6172 642f 6261 636b 7761  d forward/backwa
-00019b20: 7264 2070 6173 7365 732e 2049 6e73 7465  rd passes. Inste
-00019b30: 6164 2c20 7765 0a20 2020 2023 2073 6176  ad, we.    # sav
-00019b40: 6520 6172 6773 2061 6e64 206b 7761 7267  e args and kwarg
-00019b50: 7320 6f66 2074 6865 206f 7269 6769 6e61  s of the origina
-00019b60: 6c20 6675 6e63 7469 6f6e 2063 616c 6c20  l function call 
-00019b70: 616e 6420 7265 636f 6e73 7472 7563 7420  and reconstruct 
-00019b80: 7468 650a 2020 2020 2320 7472 6163 6520  the.    # trace 
-00019b90: 6f62 6a65 6374 2061 6e64 2069 7473 2065  object and its e
-00019ba0: 6e76 6972 6f6e 6d65 6e74 2064 6963 7420  nvironment dict 
-00019bb0: 696e 2074 6865 2062 6163 6b77 6172 6420  in the backward 
-00019bc0: 7275 6c65 2e20 4865 7265 2077 6520 7265  rule. Here we re
-00019bd0: 6c79 0a20 2020 2023 206f 6e20 7468 6520  ly.    # on the 
-00019be0: 6661 6374 2074 6861 7420 7468 6520 6f72  fact that the or
-00019bf0: 6465 7220 6f66 2074 6865 2073 796d 626f  der of the symbo
-00019c00: 6c73 2069 6e20 7468 6520 7472 6163 6520  ls in the trace 
-00019c10: 6973 2064 6574 6572 6d69 6e69 7374 6963  is deterministic
-00019c20: 0a20 2020 2023 2061 6e64 2061 6c77 6179  .    # and alway
-00019c30: 7320 7468 6520 7361 6d65 2066 6f72 2074  s the same for t
-00019c40: 6865 2073 616d 6520 6675 6e63 7469 6f6e  he same function
-00019c50: 2063 616c 6c20 616e 6420 7468 6520 7361   call and the sa
-00019c60: 6d65 2073 6574 206f 660a 2020 2020 2320  me set of.    # 
-00019c70: 6172 6775 6d65 6e74 732e 2053 6565 2074  arguments. See t
-00019c80: 6573 745f 6772 6164 2e70 793a 7465 7374  est_grad.py:test
-00019c90: 5f74 6f72 6368 5f61 7574 6f67 7261 645f  _torch_autograd_
-00019ca0: 6675 6e63 7469 6f6e 2066 6f72 2061 6e20  function for an 
-00019cb0: 6578 616d 706c 650a 2020 2020 2320 7768  example.    # wh
-00019cc0: 6572 6520 7468 6973 2069 7320 7465 7374  ere this is test
-00019cd0: 6564 2e0a 2020 2020 626f 756e 645f 7379  ed..    bound_sy
-00019ce0: 6d62 6f6c 7320 3d20 6974 6572 5f62 6f75  mbols = iter_bou
-00019cf0: 6e64 5f73 796d 626f 6c73 2874 7261 6365  nd_symbols(trace
-00019d00: 2e62 6f75 6e64 5f73 796d 626f 6c73 290a  .bound_symbols).
-00019d10: 2020 2020 7361 7665 645f 666f 725f 6261      saved_for_ba
-00019d20: 636b 7761 7264 203d 2074 7570 6c65 2865  ckward = tuple(e
-00019d30: 6e76 5b73 6571 7565 6e63 6966 7928 7379  nv[sequencify(sy
-00019d40: 6d62 6f6c 2e6f 7574 7075 7429 5b30 5d2e  mbol.output)[0].
-00019d50: 6e61 6d65 5d2e 7265 7369 6475 616c 7320  name].residuals 
-00019d60: 666f 7220 7379 6d62 6f6c 2069 6e20 626f  for symbol in bo
-00019d70: 756e 645f 7379 6d62 6f6c 7329 0a20 2020  und_symbols).   
-00019d80: 2072 6574 7572 6e20 7361 7665 645f 666f   return saved_fo
-00019d90: 725f 6261 636b 7761 7264 0a0a 0a64 6566  r_backward...def
-00019da0: 2072 6563 6f6e 7374 7275 6374 5f66 6f72   reconstruct_for
-00019db0: 7761 7264 5f65 6e76 5f66 6f72 5f62 6163  ward_env_for_bac
-00019dc0: 6b77 6172 6428 7472 6163 652c 2073 6176  kward(trace, sav
-00019dd0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
-00019de0: 3a0a 2020 2020 626f 756e 645f 7379 6d62  :.    bound_symb
-00019df0: 6f6c 7320 3d20 6974 6572 5f62 6f75 6e64  ols = iter_bound
-00019e00: 5f73 796d 626f 6c73 2874 7261 6365 2e62  _symbols(trace.b
-00019e10: 6f75 6e64 5f73 796d 626f 6c73 290a 0a20  ound_symbols).. 
-00019e20: 2020 2072 6563 6f6e 7374 7275 6374 6564     reconstructed
-00019e30: 5f65 6e76 203d 207b 7d0a 0a20 2020 2066  _env = {}..    f
-00019e40: 6f72 2069 6478 2c20 7379 6d20 696e 2065  or idx, sym in e
-00019e50: 6e75 6d65 7261 7465 2862 6f75 6e64 5f73  numerate(bound_s
-00019e60: 796d 626f 6c73 293a 0a20 2020 2020 2020  ymbols):.       
-00019e70: 206b 203d 2073 6571 7565 6e63 6966 7928   k = sequencify(
-00019e80: 7379 6d2e 6f75 7470 7574 295b 305d 2e6e  sym.output)[0].n
-00019e90: 616d 650a 2020 2020 2020 2020 7620 3d20  ame.        v = 
-00019ea0: 564a 5044 7561 6c28 4e6f 6e65 2c20 7361  VJPDual(None, sa
-00019eb0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-00019ec0: 5b69 6478 5d29 0a20 2020 2020 2020 2072  [idx]).        r
-00019ed0: 6563 6f6e 7374 7275 6374 6564 5f65 6e76  econstructed_env
-00019ee0: 5b6b 5d20 3d20 760a 0a20 2020 2072 6574  [k] = v..    ret
-00019ef0: 7572 6e20 7265 636f 6e73 7472 7563 7465  urn reconstructe
-00019f00: 645f 656e 760a 0a0a 6465 6620 6465 636f  d_env...def deco
-00019f10: 6d70 6f73 6564 5f66 6e5f 6175 675f 6677  mposed_fn_aug_fw
-00019f20: 645f 7275 6c65 282a 6172 6773 2c20 6465  d_rule(*args, de
-00019f30: 636f 6d70 6f73 6564 5f66 6e2c 202a 2a6b  composed_fn, **k
-00019f40: 7761 7267 7329 3a0a 2020 2020 2222 2241  wargs):.    """A
-00019f50: 7567 6d65 6e74 6564 2066 6f72 7761 7264  ugmented forward
-00019f60: 2072 756c 6520 666f 7220 636f 6d70 6f73   rule for compos
-00019f70: 6974 6520 6675 6e63 7469 6f6e 7320 696d  ite functions im
-00019f80: 706c 656d 656e 7465 6420 696e 2074 6572  plemented in ter
-00019f90: 6d73 206f 6620 6f74 6865 7220 6675 6e63  ms of other func
-00019fa0: 7469 6f6e 7320 7468 6174 2061 7265 0a20  tions that are. 
-00019fb0: 2020 2073 7570 706f 7365 6420 746f 2062     supposed to b
-00019fc0: 6520 7375 7070 6f72 7465 6420 6279 2074  e supported by t
-00019fd0: 6865 2056 4a50 2069 6e66 7261 7374 7275  he VJP infrastru
-00019fe0: 6374 7572 652e 0a0a 2020 2020 4172 6773  cture...    Args
-00019ff0: 3a0a 2020 2020 2020 2020 6465 636f 6d70  :.        decomp
-0001a000: 6f73 6564 5f66 6e20 2843 616c 6c61 626c  osed_fn (Callabl
-0001a010: 6529 3a20 6465 636f 6d70 6f73 6564 2076  e): decomposed v
-0001a020: 6572 7369 6f6e 206f 6620 7468 6520 6675  ersion of the fu
-0001a030: 6e63 7469 6f6e 0a0a 2020 2020 5265 7475  nction..    Retu
-0001a040: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
-0001a050: 6c61 626c 653a 2041 7567 6d65 6e74 6564  lable: Augmented
-0001a060: 2066 6f72 7761 7264 2072 756c 6520 666f   forward rule fo
-0001a070: 7220 7468 6520 636f 6d70 6f73 6974 6520  r the composite 
-0001a080: 6675 6e63 7469 6f6e 0a20 2020 2022 2222  function.    """
-0001a090: 0a20 2020 2074 7261 6365 203d 2063 6f6e  .    trace = con
-0001a0a0: 7374 7275 6374 5f74 7261 6365 2829 2864  struct_trace()(d
-0001a0b0: 6563 6f6d 706f 7365 645f 666e 2c20 2a61  ecomposed_fn, *a
-0001a0c0: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
-0001a0d0: 2020 2074 7261 6365 203d 2075 6e77 7261     trace = unwra
-0001a0e0: 705f 6f6e 655f 6c65 7665 6c5f 6f66 5f73  p_one_level_of_s
-0001a0f0: 7562 7379 6d62 6f6c 7328 7472 6163 6529  ubsymbols(trace)
-0001a100: 0a20 2020 2023 2054 6865 7265 206d 6179  .    # There may
-0001a110: 2062 6520 6120 6465 6164 206e 6f64 6520   be a dead node 
-0001a120: 6c69 6b65 2022 5f20 3d20 7072 696d 732e  like "_ = prims.
-0001a130: 636f 6e76 6572 745f 656c 656d 656e 745f  convert_element_
-0001a140: 7479 7065 2830 2c20 666c 6f61 7429 220a  type(0, float)".
-0001a150: 2020 2020 2320 696e 2074 6865 2074 7261      # in the tra
-0001a160: 6365 2e20 5765 206e 6565 6420 746f 2072  ce. We need to r
-0001a170: 656d 6f76 6520 6974 2062 6566 6f72 6520  emove it before 
-0001a180: 7765 2063 616e 2075 7365 2074 6865 2074  we can use the t
-0001a190: 7261 6365 2066 6f72 0a20 2020 2023 2061  race for.    # a
-0001a1a0: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-0001a1b0: 5f70 6173 732e 0a20 2020 2074 7261 6365  _pass..    trace
-0001a1c0: 203d 2064 6365 2874 7261 6365 290a 2020   = dce(trace).  
-0001a1d0: 2020 7265 7375 6c74 2c20 656e 7620 3d20    result, env = 
-0001a1e0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-0001a1f0: 645f 7061 7373 282a 6172 6773 2c20 7472  d_pass(*args, tr
-0001a200: 6163 653d 7472 6163 652c 202a 2a6b 7761  ace=trace, **kwa
-0001a210: 7267 7329 0a20 2020 2073 6176 6564 5f66  rgs).    saved_f
-0001a220: 6f72 5f62 6163 6b77 6172 6420 3d20 6465  or_backward = de
-0001a230: 636f 6e73 7472 7563 745f 666f 7277 6172  construct_forwar
-0001a240: 645f 656e 765f 666f 725f 6261 636b 7761  d_env_for_backwa
-0001a250: 7264 2874 7261 6365 2c20 656e 7629 0a20  rd(trace, env). 
-0001a260: 2020 2023 2053 7461 7469 6320 6361 6368     # Static cach
-0001a270: 696e 6720 646f 6573 206e 6f74 2077 6974  ing does not wit
-0001a280: 6820 7769 7468 206b 7761 7267 7320 6469  h with kwargs di
-0001a290: 6374 732c 2073 6f20 7765 2772 6520 636f  cts, so we're co
-0001a2a0: 6e76 6572 7469 6e67 2074 6865 6d0a 2020  nverting them.  
-0001a2b0: 2020 2320 746f 204e 6f6e 6520 666f 7220    # to None for 
-0001a2c0: 6e6f 7720 7768 656e 2070 6f73 7369 626c  now when possibl
-0001a2d0: 652e 0a20 2020 206b 7761 7267 7320 3d20  e..    kwargs = 
-0001a2e0: 4e6f 6e65 2069 6620 6e6f 7420 6b77 6172  None if not kwar
-0001a2f0: 6773 2065 6c73 6520 6b77 6172 6773 0a20  gs else kwargs. 
-0001a300: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
-0001a310: 6172 6773 2c20 6b77 6172 6773 2c20 7361  args, kwargs, sa
-0001a320: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001a330: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
-0001a340: 4475 616c 2872 6573 756c 742c 2072 6573  Dual(result, res
-0001a350: 6964 7561 6c73 290a 0a0a 6465 6620 6465  iduals)...def de
-0001a360: 636f 6d70 6f73 6564 5f66 6e5f 6261 636b  composed_fn_back
-0001a370: 7761 7264 5f72 756c 6528 6465 636f 6d70  ward_rule(decomp
-0001a380: 6f73 6564 5f66 6e2c 2061 7267 732c 206b  osed_fn, args, k
-0001a390: 7761 7267 732c 2073 6176 6564 5f66 6f72  wargs, saved_for
-0001a3a0: 5f62 6163 6b77 6172 642c 202a 6772 6164  _backward, *grad
-0001a3b0: 7329 3a0a 2020 2020 6b77 6172 6773 203d  s):.    kwargs =
-0001a3c0: 207b 7d20 6966 206b 7761 7267 7320 6973   {} if kwargs is
-0001a3d0: 204e 6f6e 6520 656c 7365 206b 7761 7267   None else kwarg
-0001a3e0: 730a 2020 2020 7472 6163 6520 3d20 636f  s.    trace = co
-0001a3f0: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
-0001a400: 6465 636f 6d70 6f73 6564 5f66 6e2c 202a  decomposed_fn, *
-0001a410: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
-0001a420: 2020 2020 7472 6163 6520 3d20 756e 7772      trace = unwr
-0001a430: 6170 5f6f 6e65 5f6c 6576 656c 5f6f 665f  ap_one_level_of_
-0001a440: 7375 6273 796d 626f 6c73 2874 7261 6365  subsymbols(trace
-0001a450: 290a 2020 2020 7472 6163 6520 3d20 6463  ).    trace = dc
-0001a460: 6528 7472 6163 6529 0a20 2020 2023 2062  e(trace).    # b
-0001a470: 6f75 6e64 5f73 796d 626f 6c73 203d 2069  ound_symbols = i
-0001a480: 7465 725f 626f 756e 645f 7379 6d62 6f6c  ter_bound_symbol
-0001a490: 7328 7472 6163 652e 626f 756e 645f 7379  s(trace.bound_sy
-0001a4a0: 6d62 6f6c 7329 0a20 2020 2023 2072 6563  mbols).    # rec
-0001a4b0: 6f6e 7374 7275 6374 6564 5f65 6e76 203d  onstructed_env =
-0001a4c0: 207b 0a20 2020 2023 2020 2020 2073 6571   {.    #     seq
-0001a4d0: 7565 6e63 6966 7928 7379 6d62 6f6c 2e6f  uencify(symbol.o
-0001a4e0: 7574 7075 7429 5b30 5d2e 6e61 6d65 3a20  utput)[0].name: 
-0001a4f0: 564a 5044 7561 6c28 4e6f 6e65 2c20 7361  VJPDual(None, sa
-0001a500: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001a510: 5b69 5d29 0a20 2020 2023 2020 2020 2066  [i]).    #     f
-0001a520: 6f72 2069 2c20 7379 6d62 6f6c 2069 6e20  or i, symbol in 
-0001a530: 656e 756d 6572 6174 6528 626f 756e 645f  enumerate(bound_
-0001a540: 7379 6d62 6f6c 7329 0a20 2020 2023 207d  symbols).    # }
-0001a550: 0a20 2020 2072 6563 6f6e 7374 7275 6374  .    reconstruct
-0001a560: 6564 5f65 6e76 203d 2072 6563 6f6e 7374  ed_env = reconst
-0001a570: 7275 6374 5f66 6f72 7761 7264 5f65 6e76  ruct_forward_env
-0001a580: 5f66 6f72 5f62 6163 6b77 6172 6428 7472  _for_backward(tr
-0001a590: 6163 652c 2073 6176 6564 5f66 6f72 5f62  ace, saved_for_b
-0001a5a0: 6163 6b77 6172 6429 0a20 2020 2072 6573  ackward).    res
-0001a5b0: 756c 7420 3d20 6261 636b 7761 7264 5f70  ult = backward_p
-0001a5c0: 6173 7328 7265 636f 6e73 7472 7563 7465  ass(reconstructe
-0001a5d0: 645f 656e 762c 2074 7261 6365 2c20 6772  d_env, trace, gr
-0001a5e0: 6164 7329 0a20 2020 2069 6620 6c65 6e28  ads).    if len(
-0001a5f0: 6172 6773 2920 3d3d 2031 3a0a 2020 2020  args) == 1:.    
-0001a600: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0001a610: 745b 305d 0a20 2020 2023 2042 6163 6b77  t[0].    # Backw
-0001a620: 6172 6420 7061 7373 206d 6967 6874 2072  ard pass might r
-0001a630: 6574 7572 6e20 6120 6469 6374 2077 6974  eturn a dict wit
-0001a640: 6820 6772 6164 7320 6275 7420 6375 7272  h grads but curr
-0001a650: 656e 7420 696e 7465 7266 6163 6520 6f66  ent interface of
-0001a660: 0a20 2020 2023 2062 6163 6b77 6172 6420  .    # backward 
-0001a670: 7275 6c65 2064 6f65 7320 6e6f 7420 7375  rule does not su
-0001a680: 7070 6f72 7420 6974 2e20 536f 2077 6520  pport it. So we 
-0001a690: 6a75 7374 2064 726f 7020 6974 2066 6f72  just drop it for
-0001a6a0: 206e 6f77 2e0a 2020 2020 656c 6966 2069   now..    elif i
-0001a6b0: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
-0001a6c0: 5b2d 315d 2c20 6469 6374 293a 0a20 2020  [-1], dict):.   
-0001a6d0: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
-0001a6e0: 6c74 5b3a 2d31 5d0a 2020 2020 7265 7475  lt[:-1].    retu
-0001a6f0: 726e 2072 6573 756c 740a 0a0a 4072 6567  rn result...@reg
-0001a700: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-0001a710: 666f 7277 6172 6428 2274 6f72 6368 2e54  forward("torch.T
-0001a720: 656e 736f 722e 636f 6e74 6967 756f 7573  ensor.contiguous
-0001a730: 2229 0a40 7265 6769 7374 6572 5f61 7567  ").@register_aug
-0001a740: 6d65 6e74 6564 5f66 6f72 7761 7264 2822  mented_forward("
-0001a750: 746f 7263 682e 636f 6e74 6967 756f 7573  torch.contiguous
-0001a760: 2229 0a64 6566 2063 6f6e 7469 6775 6f75  ").def contiguou
-0001a770: 735f 6175 675f 6677 6428 783a 2054 656e  s_aug_fwd(x: Ten
-0001a780: 736f 7250 726f 7879 2c20 2f2c 202a 2c20  sorProxy, /, *, 
-0001a790: 6d65 6d6f 7279 5f66 6f72 6d61 743a 2074  memory_format: t
-0001a7a0: 6f72 6368 2e6d 656d 6f72 795f 666f 726d  orch.memory_form
-0001a7b0: 6174 203d 2074 6f72 6368 2e63 6f6e 7469  at = torch.conti
-0001a7c0: 6775 6f75 735f 666f 726d 6174 2920 2d3e  guous_format) ->
-0001a7d0: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
-0001a7e0: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
-0001a7f0: 2069 6d70 6f72 7420 636f 6e74 6967 756f   import contiguo
-0001a800: 7573 0a0a 2020 2020 7265 7475 726e 2056  us..    return V
-0001a810: 4a50 4475 616c 2863 6f6e 7469 6775 6f75  JPDual(contiguou
-0001a820: 7328 782c 206d 656d 6f72 795f 666f 726d  s(x, memory_form
-0001a830: 6174 3d6d 656d 6f72 795f 666f 726d 6174  at=memory_format
-0001a840: 292c 2074 7570 6c65 2829 290a 0a0a 4072  ), tuple())...@r
-0001a850: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-0001a860: 2822 746f 7263 682e 5465 6e73 6f72 2e63  ("torch.Tensor.c
-0001a870: 6f6e 7469 6775 6f75 7322 290a 4072 6567  ontiguous").@reg
-0001a880: 6973 7465 725f 6261 636b 7761 7264 2822  ister_backward("
-0001a890: 746f 7263 682e 636f 6e74 6967 756f 7573  torch.contiguous
-0001a8a0: 2229 0a64 6566 2063 6f6e 7469 6775 6f75  ").def contiguou
-0001a8b0: 735f 6261 636b 7761 7264 282a 7265 7369  s_backward(*resi
-0001a8c0: 6475 616c 735f 616e 645f 6772 6164 2920  duals_and_grad) 
-0001a8d0: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
-0001a8e0: 2020 2020 2320 5265 7369 6475 616c 7320      # Residuals 
-0001a8f0: 6973 206e 6f74 2065 6d70 7479 2062 6563  is not empty bec
-0001a900: 6175 7365 2063 6f6e 7469 6775 6f75 7320  ause contiguous 
-0001a910: 7379 6d62 6f6c 2068 6173 2074 6865 2073  symbol has the s
-0001a920: 616d 6520 6f75 7470 7574 2061 7320 6974  ame output as it
-0001a930: 7320 696e 7075 740a 2020 2020 6720 3d20  s input.    g = 
-0001a940: 7265 7369 6475 616c 735f 616e 645f 6772  residuals_and_gr
-0001a950: 6164 5b2d 315d 0a20 2020 2072 6574 7572  ad[-1].    retur
-0001a960: 6e20 670a 0a0a 6465 6620 7265 6369 7072  n g...def recipr
-0001a970: 6f63 616c 5f61 7567 5f66 7764 2861 3a20  ocal_aug_fwd(a: 
-0001a980: 5465 6e73 6f72 5072 6f78 7929 202d 3e20  TensorProxy) -> 
-0001a990: 564a 5044 7561 6c3a 0a20 2020 2070 7269  VJPDual:.    pri
-0001a9a0: 6d61 6c20 3d20 7265 6369 7072 6f63 616c  mal = reciprocal
-0001a9b0: 2861 290a 2020 2020 7265 7475 726e 2056  (a).    return V
-0001a9c0: 4a50 4475 616c 2870 7269 6d61 6c2c 2028  JPDual(primal, (
-0001a9d0: 7072 696d 616c 2c29 290a 0a0a 6465 6620  primal,))...def 
-0001a9e0: 7265 6369 7072 6f63 616c 5f62 6163 6b77  reciprocal_backw
-0001a9f0: 6172 6428 7072 696d 616c 2c20 6729 3a0a  ard(primal, g):.
-0001aa00: 2020 2020 7265 7475 726e 202d 6720 2a20      return -g * 
-0001aa10: 7072 696d 616c 202a 2070 7269 6d61 6c0a  primal * primal.
-0001aa20: 0a0a 4070 6172 7469 616c 2872 6567 6973  ..@partial(regis
-0001aa30: 7465 725f 6772 6164 2c20 7072 696d 732e  ter_grad, prims.
-0001aa40: 5072 696d 4944 732e 5245 4349 5052 4f43  PrimIDs.RECIPROC
-0001aa50: 414c 290a 6465 6620 7265 6369 7072 6f63  AL).def reciproc
-0001aa60: 616c 5f6a 6f69 6e74 5f66 6f72 7761 7264  al_joint_forward
-0001aa70: 5f62 6163 6b77 6172 645f 7275 6c65 2861  _backward_rule(a
-0001aa80: 3a20 5465 6e73 6f72 5072 6f78 7929 202d  : TensorProxy) -
-0001aa90: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-0001aaa0: 2020 2072 6573 756c 742c 2073 6176 6564     result, saved
-0001aab0: 203d 2072 6563 6970 726f 6361 6c5f 6175   = reciprocal_au
-0001aac0: 675f 6677 6428 6129 0a20 2020 2067 203d  g_fwd(a).    g =
-0001aad0: 2067 6574 5f67 7261 6428 7265 7375 6c74   get_grad(result
-0001aae0: 290a 2020 2020 6761 203d 2072 6563 6970  ).    ga = recip
-0001aaf0: 726f 6361 6c5f 6261 636b 7761 7264 282a  rocal_backward(*
-0001ab00: 7361 7665 642c 2067 290a 2020 2020 7075  saved, g).    pu
-0001ab10: 745f 6772 6164 2861 2c20 6761 290a 2020  t_grad(a, ga).  
-0001ab20: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
-0001ab30: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
-0001ab40: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
-0001ab50: 6f72 6368 2e69 6e64 6578 5f70 7574 2229  orch.index_put")
-0001ab60: 0a64 6566 2069 6e64 6578 5f70 7574 5f61  .def index_put_a
-0001ab70: 7567 5f66 7764 280a 2020 2020 613a 2054  ug_fwd(.    a: T
-0001ab80: 656e 736f 7250 726f 7879 2c20 2f2c 2069  ensorProxy, /, i
-0001ab90: 6e64 6963 6573 3a20 5365 7175 656e 6365  ndices: Sequence
-0001aba0: 5b54 656e 736f 7250 726f 7879 5d2c 2076  [TensorProxy], v
-0001abb0: 616c 7565 733a 2054 656e 736f 7250 726f  alues: TensorPro
-0001abc0: 7879 2c20 6163 6375 6d75 6c61 7465 3a20  xy, accumulate: 
-0001abd0: 626f 6f6c 203d 2046 616c 7365 0a29 202d  bool = False.) -
-0001abe0: 3e20 564a 5044 7561 6c3a 0a20 2020 2070  > VJPDual:.    p
-0001abf0: 7269 6d61 6c20 3d20 636c 616e 672e 696e  rimal = clang.in
-0001ac00: 6465 785f 7075 7428 612c 2069 6e64 6963  dex_put(a, indic
-0001ac10: 6573 2c20 7661 6c75 6573 2c20 6163 6375  es, values, accu
-0001ac20: 6d75 6c61 7465 290a 2020 2020 7265 7369  mulate).    resi
-0001ac30: 6475 616c 7320 3d20 280a 2020 2020 2020  duals = (.      
-0001ac40: 2020 696e 6469 6365 732c 0a20 2020 2020    indices,.     
-0001ac50: 2020 2076 616c 7565 732c 0a20 2020 2020     values,.     
-0001ac60: 2020 2061 6363 756d 756c 6174 652c 0a20     accumulate,. 
-0001ac70: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
-0001ac80: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-0001ac90: 7265 7369 6475 616c 7329 0a0a 0a64 6566  residuals)...def
-0001aca0: 2073 756d 5f74 6f28 613a 2054 656e 736f   sum_to(a: Tenso
-0001acb0: 7250 726f 7879 2c20 7368 6170 653a 2053  rProxy, shape: S
-0001acc0: 6571 7565 6e63 655b 696e 745d 2920 2d3e  equence[int]) ->
-0001acd0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-0001ace0: 2020 6966 206e 6f74 2073 6861 7065 3a0a    if not shape:.
-0001acf0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
-0001ad00: 2e73 756d 2829 0a20 2020 206c 6561 6469  .sum().    leadi
-0001ad10: 6e67 5f64 696d 7320 3d20 612e 6e64 696d  ng_dims = a.ndim
-0001ad20: 202d 206c 656e 2873 6861 7065 290a 2020   - len(shape).  
-0001ad30: 2020 7265 6475 6365 5f64 696d 7320 3d20    reduce_dims = 
-0001ad40: 7475 706c 6528 7261 6e67 6528 6c65 6164  tuple(range(lead
-0001ad50: 696e 675f 6469 6d73 2929 202b 2074 7570  ing_dims)) + tup
-0001ad60: 6c65 280a 2020 2020 2020 2020 6920 666f  le(.        i fo
-0001ad70: 7220 6920 696e 2072 616e 6765 286c 6561  r i in range(lea
-0001ad80: 6469 6e67 5f64 696d 732c 2061 2e6e 6469  ding_dims, a.ndi
-0001ad90: 6d29 2069 6620 7368 6170 655b 6920 2d20  m) if shape[i - 
-0001ada0: 6c65 6164 696e 675f 6469 6d73 5d20 3d3d  leading_dims] ==
-0001adb0: 2031 2061 6e64 2061 2e73 6861 7065 5b69   1 and a.shape[i
-0001adc0: 5d20 213d 2031 0a20 2020 2029 0a20 2020  ] != 1.    ).   
-0001add0: 2061 203d 206c 746f 7263 682e 7375 6d28   a = ltorch.sum(
-0001ade0: 612c 2064 696d 3d72 6564 7563 655f 6469  a, dim=reduce_di
-0001adf0: 6d73 2c20 6b65 6570 6469 6d3d 5472 7565  ms, keepdim=True
-0001ae00: 290a 2020 2020 6966 206c 6561 6469 6e67  ).    if leading
-0001ae10: 5f64 696d 7320 3e20 303a 0a20 2020 2020  _dims > 0:.     
-0001ae20: 2020 2072 6574 7572 6e20 6c74 6f72 6368     return ltorch
-0001ae30: 2e76 6965 7728 612c 2073 6861 7065 290a  .view(a, shape).
-0001ae40: 2020 2020 7265 7475 726e 2061 0a0a 0a40      return a...@
-0001ae50: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-0001ae60: 6428 2274 6f72 6368 2e69 6e64 6578 5f70  d("torch.index_p
-0001ae70: 7574 2229 0a64 6566 2069 6e64 6578 5f70  ut").def index_p
-0001ae80: 7574 5f62 6163 6b77 6172 6428 696e 6469  ut_backward(indi
-0001ae90: 6365 733a 2053 6571 7565 6e63 655b 5465  ces: Sequence[Te
-0001aea0: 6e73 6f72 5072 6f78 795d 2c20 7661 6c75  nsorProxy], valu
-0001aeb0: 6573 3a20 5465 6e73 6f72 5072 6f78 792c  es: TensorProxy,
-0001aec0: 2061 6363 756d 756c 6174 653a 2062 6f6f   accumulate: boo
-0001aed0: 6c2c 2067 3a20 5465 6e73 6f72 5072 6f78  l, g: TensorProx
-0001aee0: 7929 3a0a 2020 2020 675f 7661 6c75 6573  y):.    g_values
-0001aef0: 203d 2067 5b69 6e64 6963 6573 5d0a 2020   = g[indices].  
-0001af00: 2020 2320 746f 7263 6820 6861 7320 6578    # torch has ex
-0001af10: 7472 6120 6c6f 6769 6320 746f 2068 616e  tra logic to han
-0001af20: 646c 6520 7468 6520 6578 7061 6e64 6564  dle the expanded
-0001af30: 2076 616c 7565 730a 2020 2020 6966 206e   values.    if n
-0001af40: 6f74 2075 7469 6c73 2e73 616d 655f 7368  ot utils.same_sh
-0001af50: 6170 6528 675f 7661 6c75 6573 2e73 6861  ape(g_values.sha
-0001af60: 7065 2c20 7661 6c75 6573 2e73 6861 7065  pe, values.shape
-0001af70: 293a 0a20 2020 2020 2020 2069 6620 636c  ):.        if cl
-0001af80: 616e 672e 636f 6d70 7574 655f 6272 6f61  ang.compute_broa
-0001af90: 6463 6173 745f 7368 6170 6528 675f 7661  dcast_shape(g_va
-0001afa0: 6c75 6573 2e73 6861 7065 2c20 7661 6c75  lues.shape, valu
-0001afb0: 6573 2e73 6861 7065 293a 0a20 2020 2020  es.shape):.     
-0001afc0: 2020 2020 2020 2067 5f76 616c 7565 7320         g_values 
-0001afd0: 3d20 7375 6d5f 746f 2867 5f76 616c 7565  = sum_to(g_value
-0001afe0: 732c 2076 616c 7565 732e 7368 6170 6529  s, values.shape)
-0001aff0: 0a20 2020 2069 6620 6163 6375 6d75 6c61  .    if accumula
-0001b000: 7465 3a0a 2020 2020 2020 2020 7265 7475  te:.        retu
-0001b010: 726e 2067 2c20 675f 7661 6c75 6573 0a20  rn g, g_values. 
-0001b020: 2020 2072 6574 7572 6e20 636c 616e 672e     return clang.
-0001b030: 696e 6465 785f 7075 7428 672c 2069 6e64  index_put(g, ind
-0001b040: 6963 6573 2c20 6c74 6f72 6368 2e7a 6572  ices, ltorch.zer
-0001b050: 6f73 5f6c 696b 6528 7661 6c75 6573 292c  os_like(values),
-0001b060: 2046 616c 7365 292c 2067 5f76 616c 7565   False), g_value
-0001b070: 730a 0a0a 6465 6620 756e 6966 6f72 6d5f  s...def uniform_
-0001b080: 6175 675f 6677 6428 7368 6170 652c 206d  aug_fwd(shape, m
-0001b090: 696e 7661 6c2c 206d 6178 7661 6c2c 202a  inval, maxval, *
-0001b0a0: 2c20 6465 7669 6365 2c20 6474 7970 6529  , device, dtype)
-0001b0b0: 3a0a 2020 2020 7072 696d 616c 203d 2070  :.    primal = p
-0001b0c0: 7269 6d73 2e75 6e69 666f 726d 2873 6861  rims.uniform(sha
-0001b0d0: 7065 2c20 6d69 6e76 616c 2c20 6d61 7876  pe, minval, maxv
-0001b0e0: 616c 2c20 6465 7669 6365 3d64 6576 6963  al, device=devic
-0001b0f0: 652c 2064 7479 7065 3d64 7479 7065 290a  e, dtype=dtype).
-0001b100: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-0001b110: 616c 2870 7269 6d61 6c2c 2028 7072 696d  al(primal, (prim
-0001b120: 616c 2c20 6d69 6e76 616c 2c20 6d61 7876  al, minval, maxv
-0001b130: 616c 2929 0a0a 0a64 6566 2075 6e69 666f  al))...def unifo
-0001b140: 726d 5f62 6163 6b77 6172 6428 7072 696d  rm_backward(prim
-0001b150: 616c 2c20 6d69 6e76 616c 2c20 6d61 7876  al, minval, maxv
-0001b160: 616c 2c20 6729 3a0a 2020 2020 2320 756e  al, g):.    # un
-0001b170: 6966 6f72 6d20 6973 2069 6d70 6c65 6d65  iform is impleme
-0001b180: 6e74 6564 2061 7320 286d 6178 7661 6c20  nted as (maxval 
-0001b190: 2d20 6d69 6e76 616c 2920 2a20 756e 6966  - minval) * unif
-0001b1a0: 6f72 6d28 7368 6170 652c 2030 2c20 3129  orm(shape, 0, 1)
-0001b1b0: 202b 206d 696e 7661 6c0a 2020 2020 756e   + minval.    un
-0001b1c0: 7363 616c 6564 5f70 7269 6d61 6c20 3d20  scaled_primal = 
-0001b1d0: 2870 7269 6d61 6c20 2d20 6d69 6e76 616c  (primal - minval
-0001b1e0: 2920 2f20 286d 6178 7661 6c20 2d20 6d69  ) / (maxval - mi
-0001b1f0: 6e76 616c 290a 2020 2020 7265 6475 6365  nval).    reduce
-0001b200: 5f61 6c6c 5f64 696d 7320 3d20 7475 706c  _all_dims = tupl
-0001b210: 6528 7261 6e67 6528 672e 6e64 696d 2929  e(range(g.ndim))
-0001b220: 0a20 2020 2073 756d 203d 2070 6172 7469  .    sum = parti
-0001b230: 616c 2870 7269 6d73 2e73 756d 2c20 6469  al(prims.sum, di
-0001b240: 6d73 3d72 6564 7563 655f 616c 6c5f 6469  ms=reduce_all_di
-0001b250: 6d73 290a 2020 2020 7265 7475 726e 204e  ms).    return N
-0001b260: 6f6e 652c 2073 756d 2867 202a 2028 3120  one, sum(g * (1 
-0001b270: 2d20 756e 7363 616c 6564 5f70 7269 6d61  - unscaled_prima
-0001b280: 6c29 292c 2073 756d 2867 202a 2075 6e73  l)), sum(g * uns
-0001b290: 6361 6c65 645f 7072 696d 616c 290a 0a0a  caled_primal)...
-0001b2a0: 6e6f 6e64 6966 6665 7265 6e74 6961 626c  nondifferentiabl
-0001b2b0: 655f 766a 705f 7379 6d62 6f6c 7320 3d20  e_vjp_symbols = 
-0001b2c0: 2870 7269 6d73 2e50 7269 6d49 4473 2e42  (prims.PrimIDs.B
-0001b2d0: 4954 5749 5345 5f41 4e44 2c20 7072 696d  ITWISE_AND, prim
-0001b2e0: 732e 5072 696d 4944 732e 5349 474e 4249  s.PrimIDs.SIGNBI
-0001b2f0: 542c 2070 7269 6d73 2e50 7269 6d49 4473  T, prims.PrimIDs
-0001b300: 2e46 554c 4c29 0a0a 0a64 6566 2069 735f  .FULL)...def is_
-0001b310: 636f 6e73 7461 6e74 5f66 6f72 5f76 6a70  constant_for_vjp
-0001b320: 2873 796d 626f 6c3a 2070 7269 6d73 2e53  (symbol: prims.S
-0001b330: 796d 626f 6c29 202d 3e20 626f 6f6c 3a0a  ymbol) -> bool:.
-0001b340: 2020 2020 2222 2243 6865 636b 2069 6620      """Check if 
-0001b350: 6120 7379 6d62 6f6c 2069 7320 636f 6e73  a symbol is cons
-0001b360: 7461 6e74 2066 6f72 2074 6865 2056 4a50  tant for the VJP
-0001b370: 2074 7261 6e73 666f 726d 2e0a 0a20 2020   transform...   
-0001b380: 2041 7267 733a 0a20 2020 2020 2020 2073   Args:.        s
-0001b390: 796d 626f 6c20 2870 7269 6d73 2e53 796d  ymbol (prims.Sym
-0001b3a0: 626f 6c29 3a20 5379 6d62 6f6c 2074 6f20  bol): Symbol to 
-0001b3b0: 6368 6563 6b2e 0a0a 2020 2020 5265 7475  check...    Retu
-0001b3c0: 726e 733a 0a20 2020 2020 2020 2062 6f6f  rns:.        boo
-0001b3d0: 6c3a 2054 7275 6520 6966 2074 6865 2073  l: True if the s
-0001b3e0: 796d 626f 6c20 6973 2063 6f6e 7374 616e  ymbol is constan
-0001b3f0: 742c 2046 616c 7365 206f 7468 6572 7769  t, False otherwi
-0001b400: 7365 2e0a 2020 2020 2222 220a 2020 2020  se..    """.    
-0001b410: 6172 655f 616c 6c5f 6172 6773 5f6e 6f6e  are_all_args_non
-0001b420: 5f64 6966 6665 7265 6e74 6961 626c 6520  _differentiable 
-0001b430: 3d20 6e6f 7420 616e 7928 6973 696e 7374  = not any(isinst
-0001b440: 616e 6365 2861 7267 2c20 2846 6c6f 6174  ance(arg, (Float
-0001b450: 5072 6f78 792c 2054 656e 736f 7250 726f  Proxy, TensorPro
-0001b460: 7879 2929 2066 6f72 2061 7267 2069 6e20  xy)) for arg in 
-0001b470: 7379 6d62 6f6c 2e66 6c61 745f 6172 6773  symbol.flat_args
-0001b480: 290a 2020 2020 7265 7475 726e 2028 0a20  ).    return (. 
-0001b490: 2020 2020 2020 2061 7265 5f61 6c6c 5f61         are_all_a
-0001b4a0: 7267 735f 6e6f 6e5f 6469 6666 6572 656e  rgs_non_differen
-0001b4b0: 7469 6162 6c65 0a20 2020 2020 2020 206f  tiable.        o
-0001b4c0: 7220 7379 6d62 6f6c 2e61 7265 5f61 6c6c  r symbol.are_all
-0001b4d0: 5f61 7267 735f 636f 6e73 7461 6e74 0a20  _args_constant. 
-0001b4e0: 2020 2020 2020 206f 7220 7379 6d62 6f6c         or symbol
-0001b4f0: 2e73 796d 2e69 6420 696e 206e 6f6e 6469  .sym.id in nondi
-0001b500: 6666 6572 656e 7469 6162 6c65 5f76 6a70  fferentiable_vjp
-0001b510: 5f73 796d 626f 6c73 0a20 2020 2029 0a0a  _symbols.    )..
-0001b520: 0a64 6566 2076 6a70 5f73 796d 626f 6c5f  .def vjp_symbol_
-0001b530: 6d61 7070 6572 2873 796d 626f 6c3a 2070  mapper(symbol: p
-0001b540: 7269 6d73 2e53 796d 626f 6c2c 202a 6172  rims.Symbol, *ar
-0001b550: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
-0001b560: 2020 2022 2222 5379 6d62 6f6c 206d 6170     """Symbol map
-0001b570: 7065 7220 666f 7220 7468 6520 564a 5020  per for the VJP 
-0001b580: 7472 616e 7366 6f72 6d2e 0a0a 2020 2020  transform...    
-0001b590: 4172 6773 3a0a 2020 2020 2020 2020 7379  Args:.        sy
-0001b5a0: 6d62 6f6c 2028 7072 696d 732e 5379 6d62  mbol (prims.Symb
-0001b5b0: 6f6c 293a 2053 796d 626f 6c20 746f 2062  ol): Symbol to b
-0001b5c0: 6520 6d61 7070 6564 2e0a 2020 2020 2020  e mapped..      
-0001b5d0: 2020 6172 6773 2028 5475 706c 655b 5661    args (Tuple[Va
-0001b5e0: 7269 6162 6c65 5d29 3a20 4172 6775 6d65  riable]): Argume
-0001b5f0: 6e74 7320 746f 2074 6865 2073 796d 626f  nts to the symbo
-0001b600: 6c2e 0a20 2020 2020 2020 206b 7761 7267  l..        kwarg
-0001b610: 7320 2844 6963 745b 7374 722c 2056 6172  s (Dict[str, Var
-0001b620: 6961 626c 655d 293a 204b 6579 776f 7264  iable]): Keyword
-0001b630: 2061 7267 756d 656e 7473 2074 6f20 7468   arguments to th
-0001b640: 6520 7379 6d62 6f6c 2e0a 0a20 2020 2052  e symbol...    R
-0001b650: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0001b660: 4361 6c6c 6162 6c65 3a20 4120 6675 6e63  Callable: A func
-0001b670: 7469 6f6e 2074 6861 7420 636f 6d70 7574  tion that comput
-0001b680: 6573 2074 6865 2056 4a50 206f 6620 7468  es the VJP of th
-0001b690: 6520 7379 6d62 6f6c 2e0a 2020 2020 2222  e symbol..    ""
-0001b6a0: 220a 2020 2020 2320 436f 6e73 7461 6e74  ".    # Constant
-0001b6b0: 2063 6173 650a 2020 2020 6966 2069 735f   case.    if is_
-0001b6c0: 636f 6e73 7461 6e74 5f66 6f72 5f76 6a70  constant_for_vjp
-0001b6d0: 2873 796d 626f 6c29 3a0a 0a20 2020 2020  (symbol):..     
-0001b6e0: 2020 2064 6566 2076 6a70 5f69 6d70 6c5f     def vjp_impl_
-0001b6f0: 636f 6e73 7428 7379 6d62 6f6c 2c20 2a61  const(symbol, *a
-0001b700: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
-0001b710: 2020 2020 2020 2020 2020 2020 6172 6773              args
-0001b720: 2c20 6b77 6172 6773 203d 2074 7265 655f  , kwargs = tree_
-0001b730: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
-0001b740: 7072 696d 616c 2069 6620 6973 696e 7374  primal if isinst
-0001b750: 616e 6365 2878 2c20 564a 5044 7561 6c29  ance(x, VJPDual)
-0001b760: 2065 6c73 6520 782c 2028 6172 6773 2c20   else x, (args, 
-0001b770: 6b77 6172 6773 2929 0a20 2020 2020 2020  kwargs)).       
-0001b780: 2020 2020 2070 7269 6d61 6c73 203d 2073       primals = s
-0001b790: 796d 626f 6c5f 746f 5f65 7661 6c28 7379  ymbol_to_eval(sy
-0001b7a0: 6d62 6f6c 2928 2a61 7267 732c 202a 2a6b  mbol)(*args, **k
-0001b7b0: 7761 7267 7329 0a20 2020 2020 2020 2020  wargs).         
-0001b7c0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0001b7d0: 2870 7269 6d61 6c73 2c20 5365 7175 656e  (primals, Sequen
-0001b7e0: 6365 293a 0a20 2020 2020 2020 2020 2020  ce):.           
-0001b7f0: 2020 2020 2072 6574 7572 6e20 7472 6565       return tree
-0001b800: 5f6d 6170 286c 616d 6264 6120 783a 2056  _map(lambda x: V
-0001b810: 4a50 4475 616c 2878 2c20 7475 706c 6528  JPDual(x, tuple(
-0001b820: 2929 2c20 7072 696d 616c 7329 0a20 2020  )), primals).   
-0001b830: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001b840: 564a 5044 7561 6c28 7072 696d 616c 732c  VJPDual(primals,
-0001b850: 2074 7570 6c65 2829 290a 0a20 2020 2020   tuple())..     
-0001b860: 2020 2072 6574 7572 6e20 7061 7274 6961     return partia
-0001b870: 6c28 766a 705f 696d 706c 5f63 6f6e 7374  l(vjp_impl_const
-0001b880: 2c20 7379 6d62 6f6c 290a 0a20 2020 2023  , symbol)..    #
-0001b890: 204e 6f72 6d61 6c20 6361 7365 2c20 7765   Normal case, we
-0001b8a0: 2068 6176 6520 6120 7072 6f78 7920 7461   have a proxy ta
-0001b8b0: 6e67 656e 740a 2020 2020 766a 705f 696d  ngent.    vjp_im
-0001b8c0: 706c 203d 2061 7567 6d65 6e74 6564 5f66  pl = augmented_f
-0001b8d0: 6f72 7761 7264 5f69 6d70 6c73 2e67 6574  orward_impls.get
-0001b8e0: 2873 796d 626f 6c2e 7379 6d2e 6964 290a  (symbol.sym.id).
-0001b8f0: 0a20 2020 2069 6620 5f67 6574 5f67 7261  .    if _get_gra
-0001b900: 6466 6e28 7379 6d62 6f6c 2920 6973 206e  dfn(symbol) is n
-0001b910: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001b920: 2076 6a70 5f69 6d70 6c2c 2062 6163 6b77   vjp_impl, backw
-0001b930: 6172 645f 666e 203d 206d 616b 655f 6175  ard_fn = make_au
-0001b940: 675f 666f 7277 6172 645f 616e 645f 6261  g_forward_and_ba
-0001b950: 636b 7761 7264 2873 796d 626f 6c29 0a0a  ckward(symbol)..
-0001b960: 2020 2020 6966 2076 6a70 5f69 6d70 6c20      if vjp_impl 
-0001b970: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0001b980: 2023 2057 6520 636f 756c 6420 6e6f 7420   # We could not 
-0001b990: 6669 6e64 2061 2056 4a50 2066 6f72 2074  find a VJP for t
-0001b9a0: 6869 7320 7379 6d62 6f6c 2c20 736f 2077  his symbol, so w
-0001b9b0: 6520 7472 7920 746f 2064 6563 6f6d 706f  e try to decompo
-0001b9c0: 7365 2069 740a 2020 2020 2020 2020 6966  se it.        if
-0001b9d0: 206c 656e 2873 796d 626f 6c2e 7375 6273   len(symbol.subs
-0001b9e0: 796d 626f 6c73 2920 3e20 3020 616e 6420  ymbols) > 0 and 
-0001b9f0: 6e6f 7420 6973 696e 7374 616e 6365 2873  not isinstance(s
-0001ba00: 796d 626f 6c2e 7379 6d2e 6964 2c20 7072  ymbol.sym.id, pr
-0001ba10: 696d 732e 5072 696d 4944 7329 3a0a 2020  ims.PrimIDs):.  
-0001ba20: 2020 2020 2020 2020 2020 766a 705f 696d            vjp_im
-0001ba30: 706c 203d 2070 6172 7469 616c 2864 6563  pl = partial(dec
-0001ba40: 6f6d 706f 7365 645f 666e 5f61 7567 5f66  omposed_fn_aug_f
-0001ba50: 7764 5f72 756c 652c 2064 6563 6f6d 706f  wd_rule, decompo
-0001ba60: 7365 645f 666e 3d73 796d 626f 6c2e 7379  sed_fn=symbol.sy
-0001ba70: 6d29 0a20 2020 2020 2020 2065 6c73 653a  m).        else:
-0001ba80: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
-0001ba90: 6520 636f 756c 6420 6e6f 7420 6669 6e64  e could not find
-0001baa0: 2061 2056 4a50 2066 6f72 2074 6869 7320   a VJP for this 
-0001bab0: 7379 6d62 6f6c 2061 6e64 2077 6520 636f  symbol and we co
-0001bac0: 756c 6420 6e6f 7420 6465 636f 6d70 6f73  uld not decompos
-0001bad0: 6520 6974 0a20 2020 2020 2020 2020 2020  e it.           
-0001bae0: 2023 2049 7420 636f 756c 6420 6265 2061   # It could be a
-0001baf0: 2074 6f72 6368 2e64 726f 706f 7574 2077   torch.dropout w
-0001bb00: 6974 6820 302e 3020 7072 6f62 6162 696c  ith 0.0 probabil
-0001bb10: 6974 792c 2073 6f20 7765 2073 6b69 7020  ity, so we skip 
-0001bb20: 6974 0a20 2020 2020 2020 2020 2020 2069  it.            i
-0001bb30: 6620 7379 6d62 6f6c 2e73 796d 2e69 6420  f symbol.sym.id 
-0001bb40: 3d3d 2022 746f 7263 682e 6e6e 2e66 756e  == "torch.nn.fun
-0001bb50: 6374 696f 6e61 6c2e 6472 6f70 6f75 7422  ctional.dropout"
-0001bb60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001bb70: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
-0001bb80: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0001bb90: 6622 564a 5020 666f 7220 7b73 796d 626f  f"VJP for {symbo
-0001bba0: 6c7d 2069 7320 6e6f 7420 696d 706c 656d  l} is not implem
-0001bbb0: 656e 7465 6422 290a 2020 2020 2020 2020  ented").        
-0001bbc0: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
-0001bbd0: 6c65 6d65 6e74 6564 4572 726f 7228 6622  lementedError(f"
-0001bbe0: 564a 5020 666f 7220 7b73 796d 626f 6c2e  VJP for {symbol.
-0001bbf0: 7379 6d2e 6964 7d20 6973 206e 6f74 2069  sym.id} is not i
-0001bc00: 6d70 6c65 6d65 6e74 6564 2229 0a0a 2020  mplemented")..  
-0001bc10: 2020 6465 6620 5f76 6a70 5f69 6d70 6c28    def _vjp_impl(
-0001bc20: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-0001bc30: 3a0a 2020 2020 2020 2020 7072 696d 616c  :.        primal
-0001bc40: 732c 206b 7761 7267 7320 3d20 7472 6565  s, kwargs = tree
-0001bc50: 5f6d 6170 286c 616d 6264 6120 783a 2078  _map(lambda x: x
-0001bc60: 2e70 7269 6d61 6c20 6966 2069 7369 6e73  .primal if isins
-0001bc70: 7461 6e63 6528 782c 2056 4a50 4475 616c  tance(x, VJPDual
-0001bc80: 2920 656c 7365 2078 2c20 2861 7267 732c  ) else x, (args,
-0001bc90: 206b 7761 7267 7329 290a 2020 2020 2020   kwargs)).      
-0001bca0: 2020 6f75 745f 7072 696d 616c 2c20 6f75    out_primal, ou
-0001bcb0: 745f 7265 7369 6475 616c 7320 3d20 766a  t_residuals = vj
-0001bcc0: 705f 696d 706c 282a 7072 696d 616c 732c  p_impl(*primals,
-0001bcd0: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
-0001bce0: 2020 2020 2320 5765 2061 7265 2073 6176      # We are sav
-0001bcf0: 696e 6720 7468 6520 7265 7369 6475 616c  ing the residual
-0001bd00: 7320 616e 6420 7075 6c6c 6261 636b 206f  s and pullback o
-0001bd10: 6e6c 7920 696e 2074 6865 2066 6972 7374  nly in the first
-0001bd20: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-0001bd30: 2320 6261 636b 7761 7264 5f70 6173 7320  # backward_pass 
-0001bd40: 7468 656e 2072 6574 7269 6576 6573 2074  then retrieves t
-0001bd50: 6865 2072 6573 6964 7561 6c73 2061 6e64  he residuals and
-0001bd60: 2070 756c 6c62 6163 6b20 6672 6f6d 2074   pullback from t
-0001bd70: 6865 2066 6972 7374 206f 7574 7075 740a  he first output.
-0001bd80: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001bd90: 7461 6e63 6528 6f75 745f 7072 696d 616c  tance(out_primal
-0001bda0: 2c20 5365 7175 656e 6365 293a 0a20 2020  , Sequence):.   
-0001bdb0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001bdc0: 2856 4a50 4475 616c 286f 7574 5f70 7269  (VJPDual(out_pri
-0001bdd0: 6d61 6c5b 305d 2c20 6f75 745f 7265 7369  mal[0], out_resi
-0001bde0: 6475 616c 7329 2c20 2a28 564a 5044 7561  duals), *(VJPDua
-0001bdf0: 6c28 6f2c 2074 7570 6c65 2829 2920 666f  l(o, tuple()) fo
-0001be00: 7220 6f20 696e 206f 7574 5f70 7269 6d61  r o in out_prima
-0001be10: 6c5b 313a 5d29 290a 0a20 2020 2020 2020  l[1:]))..       
-0001be20: 2072 6574 7572 6e20 2856 4a50 4475 616c   return (VJPDual
-0001be30: 286f 7574 5f70 7269 6d61 6c2c 206f 7574  (out_primal, out
-0001be40: 5f72 6573 6964 7561 6c73 292c 290a 0a20  _residuals),).. 
-0001be50: 2020 2072 6574 7572 6e20 5f76 6a70 5f69     return _vjp_i
-0001be60: 6d70 6c0a 0a0a 6465 6620 6368 6563 6b5f  mpl...def check_
-0001be70: 6273 796d 5f66 6f72 5f76 6a70 2862 7379  bsym_for_vjp(bsy
-0001be80: 6d29 3a0a 2020 2020 2222 220a 2020 2020  m):.    """.    
-0001be90: 4368 6563 6b20 6966 2061 2062 6f75 6e64  Check if a bound
-0001bea0: 2073 796d 626f 6c20 6973 2073 7570 706f   symbol is suppo
-0001beb0: 7274 6564 2062 7920 766a 702e 0a0a 2020  rted by vjp...  
-0001bec0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0001bed0: 6273 796d 2028 426f 756e 6453 796d 626f  bsym (BoundSymbo
-0001bee0: 6c29 3a20 5468 6520 626f 756e 6420 7379  l): The bound sy
-0001bef0: 6d62 6f6c 2074 6f20 6368 6563 6b2e 0a0a  mbol to check...
-0001bf00: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001bf10: 2020 2020 2062 6f6f 6c3a 2054 7275 6520       bool: True 
-0001bf20: 6966 2074 6865 2062 6f75 6e64 2073 796d  if the bound sym
-0001bf30: 626f 6c20 6973 2073 7570 706f 7274 6564  bol is supported
-0001bf40: 2062 7920 766a 702c 2046 616c 7365 206f   by vjp, False o
-0001bf50: 7468 6572 7769 7365 2e0a 2020 2020 2222  therwise..    ""
-0001bf60: 220a 0a20 2020 2069 6620 6273 796d 2e73  "..    if bsym.s
-0001bf70: 796d 2e69 6420 696e 2074 7261 6e73 666f  ym.id in transfo
-0001bf80: 726d 5f73 6b69 705f 6c69 7374 3a0a 2020  rm_skip_list:.  
-0001bf90: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-0001bfa0: 650a 0a20 2020 2069 6620 6273 796d 2e73  e..    if bsym.s
-0001bfb0: 796d 2e69 6420 696e 2062 6163 6b77 6172  ym.id in backwar
-0001bfc0: 645f 696d 706c 7320 616e 6420 6273 796d  d_impls and bsym
-0001bfd0: 2e73 796d 2e69 6420 696e 2061 7567 6d65  .sym.id in augme
-0001bfe0: 6e74 6564 5f66 6f72 7761 7264 5f69 6d70  nted_forward_imp
-0001bff0: 6c73 3a0a 2020 2020 2020 2020 7265 7475  ls:.        retu
-0001c000: 726e 2054 7275 650a 0a20 2020 2069 6620  rn True..    if 
-0001c010: 6273 796d 2e73 796d 2e69 6420 696e 205f  bsym.sym.id in _
-0001c020: 6772 6164 5f66 6e5f 6d61 703a 0a20 2020  grad_fn_map:.   
-0001c030: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-0001c040: 0a0a 2020 2020 2320 5765 2063 6f75 6c64  ..    # We could
-0001c050: 206e 6f74 2066 696e 6420 6120 564a 5020   not find a VJP 
-0001c060: 666f 7220 7468 6973 2073 796d 626f 6c2c  for this symbol,
-0001c070: 2073 6f20 7765 2074 7279 2074 6f20 6465   so we try to de
-0001c080: 636f 6d70 6f73 6520 6974 0a20 2020 2023  compose it.    #
-0001c090: 2069 6e74 6f20 7375 622d 7379 6d62 6f6c   into sub-symbol
-0001c0a0: 7320 616e 6420 6368 6563 6b20 6966 2074  s and check if t
-0001c0b0: 6865 7920 6172 6520 7375 7070 6f72 7465  hey are supporte
-0001c0c0: 640a 2020 2020 6966 206c 656e 2862 7379  d.    if len(bsy
-0001c0d0: 6d2e 7375 6273 796d 626f 6c73 2920 3e20  m.subsymbols) > 
-0001c0e0: 3020 616e 6420 6e6f 7420 6273 796d 2e73  0 and not bsym.s
-0001c0f0: 796d 2e69 735f 7072 696d 3a0a 2020 2020  ym.is_prim:.    
-0001c100: 2020 2020 7375 6274 7261 6365 203d 2063      subtrace = c
-0001c110: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
-0001c120: 2862 7379 6d2e 7379 6d2c 202a 6273 796d  (bsym.sym, *bsym
-0001c130: 2e61 7267 732c 202a 2a62 7379 6d2e 6b77  .args, **bsym.kw
-0001c140: 6172 6773 290a 2020 2020 2020 2020 7375  args).        su
-0001c150: 6274 7261 6365 203d 2075 6e77 7261 705f  btrace = unwrap_
-0001c160: 6f6e 655f 6c65 7665 6c5f 6f66 5f73 7562  one_level_of_sub
-0001c170: 7379 6d62 6f6c 7328 7375 6274 7261 6365  symbols(subtrace
-0001c180: 290a 2020 2020 2020 2020 616c 6c5f 7375  ).        all_su
-0001c190: 7070 6f72 7465 6420 3d20 616c 6c28 6368  pported = all(ch
-0001c1a0: 6563 6b5f 6273 796d 5f66 6f72 5f76 6a70  eck_bsym_for_vjp
-0001c1b0: 2873 7562 6273 796d 2920 666f 7220 7375  (subbsym) for su
-0001c1c0: 6262 7379 6d20 696e 2073 7562 7472 6163  bbsym in subtrac
-0001c1d0: 652e 626f 756e 645f 7379 6d62 6f6c 7329  e.bound_symbols)
-0001c1e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001c1f0: 616c 6c5f 7375 7070 6f72 7465 640a 0a20  all_supported.. 
-0001c200: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-0001c210: 0a0a 6465 6620 6175 676d 656e 7465 645f  ..def augmented_
-0001c220: 666f 7277 6172 645f 7061 7373 282a 6172  forward_pass(*ar
-0001c230: 6773 2c20 7472 6163 653a 2054 7261 6365  gs, trace: Trace
-0001c240: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0001c250: 2022 2222 4175 676d 656e 7465 6420 666f   """Augmented fo
-0001c260: 7277 6172 6420 7061 7373 2066 6f72 2074  rward pass for t
-0001c270: 6865 2056 4a50 2074 7261 6e73 666f 726d  he VJP transform
-0001c280: 2e0a 0a20 2020 2054 6865 2061 7567 6d65  ...    The augme
-0001c290: 6e74 6564 2066 6f72 7761 7264 2070 6173  nted forward pas
-0001c2a0: 7320 6973 2061 2066 6f72 7761 7264 2070  s is a forward p
-0001c2b0: 6173 7320 7468 6174 2072 6574 7572 6e73  ass that returns
-0001c2c0: 2074 6865 2072 6573 6964 7561 6c73 0a20   the residuals. 
-0001c2d0: 2020 206f 6620 7468 6520 666f 7277 6172     of the forwar
-0001c2e0: 6420 7061 7373 2e0a 2020 2020 5468 6573  d pass..    Thes
-0001c2f0: 6520 7265 7369 6475 616c 7320 6172 6520  e residuals are 
-0001c300: 7573 6564 2069 6e20 7468 6520 6261 636b  used in the back
-0001c310: 7761 7264 2070 6173 7320 746f 2063 6f6d  ward pass to com
-0001c320: 7075 7465 2074 6865 2056 4a50 2061 6e64  pute the VJP and
-0001c330: 2074 6865 790a 2020 2020 6172 6520 7265   they.    are re
-0001c340: 636f 7264 6564 2069 6e20 7468 6520 656e  corded in the en
-0001c350: 7669 726f 6e6d 656e 7420 6469 6374 696f  vironment dictio
-0001c360: 6e61 7279 2066 6f72 2065 6163 6820 7661  nary for each va
-0001c370: 7269 6162 6c65 2e0a 0a20 2020 2041 7267  riable...    Arg
-0001c380: 733a 0a20 2020 2020 2020 2061 7267 7320  s:.        args 
-0001c390: 2854 7570 6c65 5b56 6172 6961 626c 655d  (Tuple[Variable]
-0001c3a0: 293a 2041 7267 756d 656e 7473 2074 6f20  ): Arguments to 
-0001c3b0: 7468 6520 6675 6e63 7469 6f6e 2e0a 2020  the function..  
-0001c3c0: 2020 2020 2020 7472 6163 6520 2854 7261        trace (Tra
-0001c3d0: 6365 293a 2054 7261 6365 206f 6620 7468  ce): Trace of th
-0001c3e0: 6520 6675 6e63 7469 6f6e 2e0a 2020 2020  e function..    
-0001c3f0: 2020 2020 6b77 6172 6773 2028 4469 6374      kwargs (Dict
-0001c400: 5b73 7472 2c20 5661 7269 6162 6c65 5d29  [str, Variable])
-0001c410: 3a20 4b65 7977 6f72 6420 6172 6775 6d65  : Keyword argume
-0001c420: 6e74 7320 746f 2074 6865 2066 756e 6374  nts to the funct
-0001c430: 696f 6e2e 0a0a 2020 2020 5265 7475 726e  ion...    Return
-0001c440: 733a 0a20 2020 2020 2020 2054 7570 6c65  s:.        Tuple
-0001c450: 5b41 6e79 2c20 4469 6374 5b73 7472 2c20  [Any, Dict[str, 
-0001c460: 416e 795d 5d3a 2054 7570 6c65 206f 6620  Any]]: Tuple of 
-0001c470: 7468 6520 7072 696d 616c 206f 7574 7075  the primal outpu
-0001c480: 7473 2061 6e64 2074 6865 2065 6e76 6972  ts and the envir
-0001c490: 6f6e 6d65 6e74 2e0a 2020 2020 2222 220a  onment..    """.
-0001c4a0: 2020 2020 6172 6773 2c20 6b77 6172 6773      args, kwargs
-0001c4b0: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
-0001c4c0: 6461 2078 3a20 564a 5044 7561 6c28 782c  da x: VJPDual(x,
-0001c4d0: 2074 7570 6c65 2829 292c 2028 6172 6773   tuple()), (args
-0001c4e0: 2c20 6b77 6172 6773 2929 0a20 2020 2072  , kwargs)).    r
-0001c4f0: 6573 756c 742c 2065 6e76 203d 2065 7661  esult, env = eva
-0001c500: 6c5f 7472 6163 6528 0a20 2020 2020 2020  l_trace(.       
-0001c510: 2074 7261 6365 2c0a 2020 2020 2020 2020   trace,.        
-0001c520: 2a61 7267 732c 0a20 2020 2020 2020 202a  *args,.        *
-0001c530: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
-0001c540: 2077 6974 685f 656e 763d 5472 7565 2c0a   with_env=True,.
-0001c550: 2020 2020 2020 2020 7379 6d62 6f6c 5f6d          symbol_m
-0001c560: 6170 7065 723d 766a 705f 7379 6d62 6f6c  apper=vjp_symbol
-0001c570: 5f6d 6170 7065 722c 0a20 2020 2029 0a20  _mapper,.    ). 
-0001c580: 2020 2072 6573 756c 7420 3d20 7472 6565     result = tree
-0001c590: 5f6d 6170 286c 616d 6264 6120 783a 2078  _map(lambda x: x
-0001c5a0: 2e70 7269 6d61 6c20 6966 2069 7369 6e73  .primal if isins
-0001c5b0: 7461 6e63 6528 782c 2056 4a50 4475 616c  tance(x, VJPDual
-0001c5c0: 2920 656c 7365 2078 2c20 7265 7375 6c74  ) else x, result
-0001c5d0: 290a 2020 2020 7265 7475 726e 2072 6573  ).    return res
-0001c5e0: 756c 742c 2065 6e76 0a0a 0a23 2054 4f44  ult, env...# TOD
-0001c5f0: 4f3a 2049 6e73 7465 6164 206f 6620 7573  O: Instead of us
-0001c600: 696e 6720 7468 6520 656e 7669 726f 6e6d  ing the environm
-0001c610: 656e 7420 6469 6374 696f 6e61 7279 2c20  ent dictionary, 
-0001c620: 7765 2063 6f75 6c64 2075 7365 2074 6865  we could use the
-0001c630: 2074 7261 6365 0a23 2073 796d 626f 6c73   trace.# symbols
-0001c640: 206f 7264 6572 2028 7468 6174 2073 686f   order (that sho
-0001c650: 756c 6420 6265 2064 6574 6572 6d69 6e69  uld be determini
-0001c660: 7374 6963 2920 746f 2072 6574 7269 6576  stic) to retriev
-0001c670: 6520 7468 6520 7265 7369 6475 616c 7320  e the residuals 
-0001c680: 6e65 6564 6564 0a23 2066 6f72 2074 6865  needed.# for the
-0001c690: 2062 6163 6b77 6172 6420 7061 7373 2e0a   backward pass..
-0001c6a0: 6465 6620 6261 636b 7761 7264 5f70 6173  def backward_pas
-0001c6b0: 7328 666f 7277 6172 645f 656e 762c 2074  s(forward_env, t
-0001c6c0: 7261 6365 2c20 696e 6974 5f63 6f74 616e  race, init_cotan
-0001c6d0: 6765 6e74 7329 3a0a 2020 2020 2222 2242  gents):.    """B
-0001c6e0: 6163 6b77 6172 6420 7061 7373 2066 6f72  ackward pass for
-0001c6f0: 2074 6865 2056 4a50 2074 7261 6e73 666f   the VJP transfo
-0001c700: 726d 2e0a 0a20 2020 2054 6865 2062 6163  rm...    The bac
-0001c710: 6b77 6172 6420 7061 7373 2069 7320 6120  kward pass is a 
-0001c720: 7265 7665 7273 6520 6d6f 6465 2061 7574  reverse mode aut
-0001c730: 6f6d 6174 6963 2064 6966 6665 7265 6e74  omatic different
-0001c740: 6961 7469 6f6e 2070 6173 7320 7468 6174  iation pass that
-0001c750: 0a20 2020 2063 6f6d 7075 7465 7320 7468  .    computes th
-0001c760: 6520 7665 6374 6f72 2d4a 6163 6f62 6961  e vector-Jacobia
-0001c770: 6e20 7072 6f64 7563 7420 2856 4a50 2920  n product (VJP) 
-0001c780: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
-0001c790: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0001c7a0: 2020 2020 666f 7277 6172 645f 656e 7620      forward_env 
-0001c7b0: 2844 6963 745b 7374 722c 2041 6e79 5d29  (Dict[str, Any])
-0001c7c0: 3a20 456e 7669 726f 6e6d 656e 7420 6f66  : Environment of
-0001c7d0: 2074 6865 2066 6f72 7761 7264 2070 6173   the forward pas
-0001c7e0: 732e 0a20 2020 2020 2020 2074 7261 6365  s..        trace
-0001c7f0: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
-0001c800: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
-0001c810: 0a20 2020 2020 2020 2069 6e69 745f 636f  .        init_co
-0001c820: 7461 6e67 656e 7473 2028 5475 706c 655b  tangents (Tuple[
-0001c830: 5661 7269 6162 6c65 5d29 3a20 496e 6974  Variable]): Init
-0001c840: 6961 6c20 636f 7461 6e67 656e 7473 2e0a  ial cotangents..
-0001c850: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-0001c860: 2020 2020 2020 5475 706c 655b 5072 6f78        Tuple[Prox
-0001c870: 792c 202e 2e2e 5d3a 2054 7570 6c65 206f  y, ...]: Tuple o
-0001c880: 6620 7468 6520 7265 7375 6c74 7320 6f66  f the results of
-0001c890: 2074 6865 2062 6163 6b77 6172 6420 7061   the backward pa
-0001c8a0: 7373 2066 6f72 2065 6163 6820 696e 7075  ss for each inpu
-0001c8b0: 742e 0a20 2020 2022 2222 0a20 2020 2065  t..    """.    e
-0001c8c0: 6e76 203d 207b 7d0a 0a20 2020 2064 6566  nv = {}..    def
-0001c8d0: 2067 6574 5f67 7261 6428 783a 2056 6172   get_grad(x: Var
-0001c8e0: 6961 626c 6529 3a0a 2020 2020 2020 2020  iable):.        
-0001c8f0: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-0001c900: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
-0001c910: 2020 2020 2020 2020 2320 5265 7475 726e          # Return
-0001c920: 204e 6f6e 6520 6966 2074 6865 2076 6172   None if the var
-0001c930: 6961 626c 6520 7761 7320 6e6f 7420 7573  iable was not us
-0001c940: 6564 2069 6e20 7468 6520 636f 6d70 7574  ed in the comput
-0001c950: 6174 696f 6e20 616e 640a 2020 2020 2020  ation and.      
-0001c960: 2020 2020 2020 2320 6865 6e63 6520 6e6f        # hence no
-0001c970: 7420 696e 2074 6865 2065 6e76 0a20 2020  t in the env.   
-0001c980: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001c990: 656e 762e 6765 7428 782e 6e61 6d65 2c20  env.get(x.name, 
-0001c9a0: 4e6f 6e65 290a 2020 2020 2020 2020 656c  None).        el
-0001c9b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001c9c0: 7265 7475 726e 2078 0a0a 2020 2020 6465  return x..    de
-0001c9d0: 6620 7075 745f 6772 6164 2876 3a20 5661  f put_grad(v: Va
-0001c9e0: 7269 6162 6c65 2c20 7661 6c3a 2041 6e79  riable, val: Any
-0001c9f0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0001ca00: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0001ca10: 2876 2c20 5661 7269 6162 6c65 293a 0a20  (v, Variable):. 
-0001ca20: 2020 2020 2020 2020 2020 2069 6620 762e             if v.
-0001ca30: 6e61 6d65 2069 6e20 656e 763a 0a20 2020  name in env:.   
-0001ca40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001ca50: 7661 6c20 6973 204e 6f6e 653a 0a20 2020  val is None:.   
-0001ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca70: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-0001ca80: 2020 2020 2020 2020 2320 4163 6375 6d75          # Accumu
-0001ca90: 6c61 7465 2063 6f74 616e 6765 6e74 730a  late cotangents.
-0001caa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cab0: 656e 765b 762e 6e61 6d65 5d20 3d20 636c  env[v.name] = cl
-0001cac0: 616e 672e 6164 6428 656e 765b 762e 6e61  ang.add(env[v.na
-0001cad0: 6d65 5d2c 2076 616c 2920 6966 2065 6e76  me], val) if env
-0001cae0: 5b76 2e6e 616d 655d 2069 7320 6e6f 7420  [v.name] is not 
-0001caf0: 4e6f 6e65 2065 6c73 6520 7661 6c0a 2020  None else val.  
-0001cb00: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001cb10: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
-0001cb20: 2065 6e76 5b76 2e6e 616d 655d 203d 2076   env[v.name] = v
-0001cb30: 616c 0a20 2020 2020 2020 2065 6c69 6620  al.        elif 
-0001cb40: 6973 696e 7374 616e 6365 2876 2c20 5365  isinstance(v, Se
-0001cb50: 7175 656e 6365 2920 616e 6420 616c 6c28  quence) and all(
-0001cb60: 6973 696e 7374 616e 6365 2878 2c20 696e  isinstance(x, in
-0001cb70: 7429 2066 6f72 2078 2069 6e20 7629 3a0a  t) for x in v):.
-0001cb80: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-0001cb90: 444f 3a20 7265 6d6f 7665 2077 6865 6e20  DO: remove when 
-0001cba0: 7765 206d 6f76 6520 6469 6d73 2074 6f20  we move dims to 
-0001cbb0: 6b77 6172 6773 0a20 2020 2020 2020 2020  kwargs.         
-0001cbc0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-0001cbd0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-0001cbe0: 762c 2073 7472 293a 0a20 2020 2020 2020  v, str):.       
-0001cbf0: 2020 2020 2065 6e76 5b76 5d20 3d20 7661       env[v] = va
-0001cc00: 6c0a 2020 2020 2020 2020 656c 6966 2069  l.        elif i
-0001cc10: 7369 6e73 7461 6e63 6528 762c 2053 6571  sinstance(v, Seq
-0001cc20: 7565 6e63 6529 2061 6e64 2076 616c 2069  uence) and val i
-0001cc30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001cc40: 2020 2020 2320 6272 6f61 6463 6173 7420      # broadcast 
-0001cc50: 4e6f 6e65 2074 6f20 7468 6520 7269 6768  None to the righ
-0001cc60: 7420 7368 6170 650a 2020 2020 2020 2020  t shape.        
-0001cc70: 2020 2020 7361 6665 5f6d 6170 2870 7574      safe_map(put
-0001cc80: 5f67 7261 642c 2076 2c20 5b4e 6f6e 655d  _grad, v, [None]
-0001cc90: 202a 206c 656e 2876 2929 0a20 2020 2020   * len(v)).     
-0001cca0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-0001ccb0: 6365 2876 2c20 5365 7175 656e 6365 2920  ce(v, Sequence) 
-0001ccc0: 616e 6420 6973 696e 7374 616e 6365 2876  and isinstance(v
-0001ccd0: 616c 2c20 5365 7175 656e 6365 293a 0a20  al, Sequence):. 
-0001cce0: 2020 2020 2020 2020 2020 2073 6166 655f             safe_
-0001ccf0: 6d61 705f 666c 6174 2870 7574 5f67 7261  map_flat(put_gra
-0001cd00: 642c 2076 2c20 7661 6c29 0a20 2020 2020  d, v, val).     
-0001cd10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001cd20: 2020 2020 2023 2053 6b69 7020 7772 6974       # Skip writ
-0001cd30: 696e 6720 746f 2063 6f6e 7374 616e 7473  ing to constants
-0001cd40: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
-0001cd50: 730a 0a20 2020 2069 6620 6973 696e 7374  s..    if isinst
-0001cd60: 616e 6365 2869 6e69 745f 636f 7461 6e67  ance(init_cotang
-0001cd70: 656e 7473 2c20 5365 7175 656e 6365 2920  ents, Sequence) 
-0001cd80: 616e 6420 6c65 6e28 696e 6974 5f63 6f74  and len(init_cot
-0001cd90: 616e 6765 6e74 7329 203d 3d20 3120 616e  angents) == 1 an
-0001cda0: 6420 6e6f 7420 6973 696e 7374 616e 6365  d not isinstance
-0001cdb0: 2874 7261 6365 2e6f 7574 7075 742c 2053  (trace.output, S
-0001cdc0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-0001cdd0: 2020 696e 6974 5f63 6f74 616e 6765 6e74    init_cotangent
-0001cde0: 7320 3d20 696e 6974 5f63 6f74 616e 6765  s = init_cotange
-0001cdf0: 6e74 735b 305d 0a20 2020 2073 6166 655f  nts[0].    safe_
-0001ce00: 6d61 705f 666c 6174 2870 7574 5f67 7261  map_flat(put_gra
-0001ce10: 642c 2074 7261 6365 2e6f 7574 7075 742c  d, trace.output,
-0001ce20: 2069 6e69 745f 636f 7461 6e67 656e 7473   init_cotangents
-0001ce30: 290a 0a20 2020 2066 6f72 2073 796d 626f  )..    for symbo
-0001ce40: 6c20 696e 2072 6576 6572 7365 6428 6c69  l in reversed(li
-0001ce50: 7374 2869 7465 725f 626f 756e 645f 7379  st(iter_bound_sy
-0001ce60: 6d62 6f6c 7328 7472 6163 652e 626f 756e  mbols(trace.boun
-0001ce70: 645f 7379 6d62 6f6c 7329 2929 3a0a 2020  d_symbols))):.  
-0001ce80: 2020 2020 2020 7379 6d62 6f6c 5f6f 7574        symbol_out
-0001ce90: 7075 7420 3d20 7365 7175 656e 6369 6679  put = sequencify
-0001cea0: 2873 796d 626f 6c2e 6f75 7470 7574 290a  (symbol.output).
-0001ceb0: 0a20 2020 2020 2020 2063 6f74 616e 6765  .        cotange
-0001cec0: 6e74 7320 3d20 7472 6565 5f6d 6170 2867  nts = tree_map(g
-0001ced0: 6574 5f67 7261 642c 2073 796d 626f 6c5f  et_grad, symbol_
-0001cee0: 6f75 7470 7574 290a 2020 2020 2020 2020  output).        
-0001cef0: 2320 4861 7669 6e67 2061 2073 696e 676c  # Having a singl
-0001cf00: 6520 636f 7461 6e67 656e 7420 6973 2061  e cotangent is a
-0001cf10: 2063 6f6d 6d6f 6e20 6361 7365 2c20 736f   common case, so
-0001cf20: 2077 6520 666c 6174 7465 6e20 6974 0a20   we flatten it. 
-0001cf30: 2020 2020 2020 2023 204f 7468 6572 7769         # Otherwi
-0001cf40: 7365 2c20 7765 2077 696c 6c20 6e65 6564  se, we will need
-0001cf50: 2074 6f20 7265 7772 6974 6520 7468 6520   to rewrite the 
-0001cf60: 7075 6c6c 6261 636b 2066 756e 6374 696f  pullback functio
-0001cf70: 6e73 0a20 2020 2020 2020 2063 6f74 616e  ns.        cotan
-0001cf80: 6765 6e74 7320 3d20 7472 6565 5f66 6c61  gents = tree_fla
-0001cf90: 7474 656e 2863 6f74 616e 6765 6e74 7329  tten(cotangents)
-0001cfa0: 5b30 5d0a 2020 2020 2020 2020 7265 7369  [0].        resi
-0001cfb0: 6475 616c 7320 3d20 666f 7277 6172 645f  duals = forward_
-0001cfc0: 656e 765b 7379 6d62 6f6c 5f6f 7574 7075  env[symbol_outpu
-0001cfd0: 745b 305d 2e6e 616d 655d 2e72 6573 6964  t[0].name].resid
-0001cfe0: 7561 6c73 0a20 2020 2020 2020 2069 6620  uals.        if 
-0001cff0: 6973 5f63 6f6e 7374 616e 745f 666f 725f  is_constant_for_
-0001d000: 766a 7028 7379 6d62 6f6c 293a 0a20 2020  vjp(symbol):.   
-0001d010: 2020 2020 2020 2020 2023 2057 6520 6361           # We ca
-0001d020: 6e20 736b 6970 2074 6865 2070 756c 6c62  n skip the pullb
-0001d030: 6163 6b20 6966 2061 6c6c 2074 6865 2061  ack if all the a
-0001d040: 7267 756d 656e 7473 2061 7265 2063 6f6e  rguments are con
-0001d050: 7374 616e 740a 2020 2020 2020 2020 2020  stant.          
-0001d060: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-0001d070: 2020 2020 6966 2061 6c6c 2863 6f74 616e      if all(cotan
-0001d080: 6765 6e74 2069 7320 4e6f 6e65 2066 6f72  gent is None for
-0001d090: 2063 6f74 616e 6765 6e74 2069 6e20 636f   cotangent in co
-0001d0a0: 7461 6e67 656e 7473 293a 0a20 2020 2020  tangents):.     
-0001d0b0: 2020 2020 2020 2023 2057 6520 6361 6e20         # We can 
-0001d0c0: 736b 6970 2074 6865 2070 756c 6c62 6163  skip the pullbac
-0001d0d0: 6b20 6966 2074 6865 2063 6f74 616e 6765  k if the cotange
-0001d0e0: 6e74 2069 7320 4e6f 6e65 0a20 2020 2020  nt is None.     
-0001d0f0: 2020 2020 2020 2073 6166 655f 6d61 7028         safe_map(
-0001d100: 7075 745f 6772 6164 2c20 7379 6d62 6f6c  put_grad, symbol
-0001d110: 2e61 7267 732c 2028 4e6f 6e65 2c29 202a  .args, (None,) *
-0001d120: 206c 656e 2873 796d 626f 6c2e 6172 6773   len(symbol.args
-0001d130: 2929 0a20 2020 2020 2020 2020 2020 2063  )).            c
-0001d140: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-0001d150: 2069 6620 7379 6d62 6f6c 2e73 796d 2e69   if symbol.sym.i
-0001d160: 6420 3d3d 2022 746f 7263 682e 6e6e 2e66  d == "torch.nn.f
-0001d170: 756e 6374 696f 6e61 6c2e 6472 6f70 6f75  unctional.dropou
-0001d180: 7422 2061 6e64 206e 6f74 2073 796d 626f  t" and not symbo
-0001d190: 6c2e 7375 6273 796d 626f 6c73 3a0a 2020  l.subsymbols:.  
-0001d1a0: 2020 2020 2020 2020 2020 2320 5765 2063            # We c
-0001d1b0: 616e 2073 6b69 7020 7468 6520 7075 6c6c  an skip the pull
-0001d1c0: 6261 636b 2069 6620 7468 6520 6472 6f70  back if the drop
-0001d1d0: 6f75 7420 7072 6f62 6162 696c 6974 7920  out probability 
-0001d1e0: 6973 2030 2e30 0a20 2020 2020 2020 2020  is 0.0.         
-0001d1f0: 2020 2023 2041 7373 756d 696e 6720 7468     # Assuming th
-0001d200: 6174 2074 6865 2064 726f 706f 7574 2073  at the dropout s
-0001d210: 796d 626f 6c20 6861 7320 7468 6520 7361  ymbol has the sa
-0001d220: 6d65 206f 7574 7075 7420 616e 6420 6172  me output and ar
-0001d230: 6775 6d65 6e74 0a20 2020 2020 2020 2020  gument.         
-0001d240: 2020 2061 7373 6572 7420 7379 6d62 6f6c     assert symbol
-0001d250: 2e6f 7574 7075 742e 6e61 6d65 203d 3d20  .output.name == 
-0001d260: 7379 6d62 6f6c 2e61 7267 735b 305d 2e6e  symbol.args[0].n
-0001d270: 616d 652c 2022 4472 6f70 6f75 7420 7379  ame, "Dropout sy
-0001d280: 6d62 6f6c 2068 6173 2061 2064 6966 6665  mbol has a diffe
-0001d290: 7265 6e74 206f 7574 7075 7420 616e 6420  rent output and 
-0001d2a0: 6172 6775 6d65 6e74 220a 2020 2020 2020  argument".      
-0001d2b0: 2020 2020 2020 6966 2073 796d 626f 6c2e        if symbol.
-0001d2c0: 6172 6773 5b31 5d20 3d3d 2030 2e30 206f  args[1] == 0.0 o
-0001d2d0: 7220 7379 6d62 6f6c 2e61 7267 735b 325d  r symbol.args[2]
-0001d2e0: 2069 7320 4661 6c73 653a 0a20 2020 2020   is False:.     
-0001d2f0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0001d300: 6e75 650a 0a20 2020 2020 2020 2062 6163  nue..        bac
-0001d310: 6b77 6172 6420 3d20 6261 636b 7761 7264  kward = backward
-0001d320: 5f69 6d70 6c73 2e67 6574 2873 796d 626f  _impls.get(symbo
-0001d330: 6c2e 7379 6d2e 6964 290a 2020 2020 2020  l.sym.id).      
-0001d340: 2020 6175 675f 666f 7277 6172 6420 3d20    aug_forward = 
-0001d350: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-0001d360: 645f 696d 706c 732e 6765 7428 7379 6d62  d_impls.get(symb
-0001d370: 6f6c 2e73 796d 2e69 6429 0a0a 2020 2020  ol.sym.id)..    
-0001d380: 2020 2020 6966 205f 6765 745f 6772 6164      if _get_grad
-0001d390: 666e 2873 796d 626f 6c29 2069 7320 6e6f  fn(symbol) is no
-0001d3a0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0001d3b0: 2020 2020 6175 675f 666f 7277 6172 642c      aug_forward,
-0001d3c0: 2062 6163 6b77 6172 6420 3d20 6d61 6b65   backward = make
-0001d3d0: 5f61 7567 5f66 6f72 7761 7264 5f61 6e64  _aug_forward_and
-0001d3e0: 5f62 6163 6b77 6172 6428 7379 6d62 6f6c  _backward(symbol
-0001d3f0: 290a 0a20 2020 2020 2020 2069 6620 6261  )..        if ba
-0001d400: 636b 7761 7264 2069 7320 4e6f 6e65 3a0a  ckward is None:.
-0001d410: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0001d420: 656e 2873 796d 626f 6c2e 7375 6273 796d  en(symbol.subsym
-0001d430: 626f 6c73 2920 3e20 3020 616e 6420 6e6f  bols) > 0 and no
-0001d440: 7420 6973 696e 7374 616e 6365 2873 796d  t isinstance(sym
-0001d450: 626f 6c2e 7379 6d2e 6964 2c20 7072 696d  bol.sym.id, prim
-0001d460: 732e 5072 696d 4944 7329 3a0a 2020 2020  s.PrimIDs):.    
-0001d470: 2020 2020 2020 2020 2020 2020 2320 5765              # We
-0001d480: 2063 6f75 6c64 206e 6f74 2066 696e 6420   could not find 
-0001d490: 6120 6261 636b 7761 7264 2066 6f72 2074  a backward for t
-0001d4a0: 6869 7320 7379 6d62 6f6c 2c20 736f 2077  his symbol, so w
-0001d4b0: 6520 7472 7920 746f 2064 6563 6f6d 706f  e try to decompo
-0001d4c0: 7365 2069 740a 2020 2020 2020 2020 2020  se it.          
-0001d4d0: 2020 2020 2020 6261 636b 7761 7264 203d        backward =
-0001d4e0: 2070 6172 7469 616c 2864 6563 6f6d 706f   partial(decompo
-0001d4f0: 7365 645f 666e 5f62 6163 6b77 6172 645f  sed_fn_backward_
-0001d500: 7275 6c65 2c20 7379 6d62 6f6c 2e73 796d  rule, symbol.sym
-0001d510: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-0001d520: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001d530: 2020 2020 2320 5765 2063 6f75 6c64 206e      # We could n
-0001d540: 6f74 2066 696e 6420 6120 6261 636b 7761  ot find a backwa
-0001d550: 7264 2066 6f72 2074 6869 7320 7379 6d62  rd for this symb
-0001d560: 6f6c 2061 6e64 2077 6520 636f 756c 6420  ol and we could 
-0001d570: 6e6f 7420 6465 636f 6d70 6f73 6520 6974  not decompose it
-0001d580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d590: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-0001d5a0: 656e 7465 6445 7272 6f72 2866 2242 6163  entedError(f"Bac
-0001d5b0: 6b77 6172 6420 666f 7220 7b73 796d 626f  kward for {symbo
-0001d5c0: 6c2e 7379 6d2e 6964 7d20 6973 206e 6f74  l.sym.id} is not
-0001d5d0: 2069 6d70 6c65 6d65 6e74 6564 2229 0a0a   implemented")..
-0001d5e0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-0001d5f0: 2062 6163 6b77 6172 6428 2a72 6573 6964   backward(*resid
-0001d600: 7561 6c73 2c20 2a63 6f74 616e 6765 6e74  uals, *cotangent
-0001d610: 7329 0a20 2020 2020 2020 2069 6620 6973  s).        if is
-0001d620: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
-0001d630: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
-0001d640: 2020 2020 2320 4966 2074 6865 2062 6163      # If the bac
-0001d650: 6b77 6172 6420 7265 7475 726e 7320 6120  kward returns a 
-0001d660: 6469 6374 2c20 7765 2061 7373 756d 6520  dict, we assume 
-0001d670: 7468 6174 2069 7420 6973 2061 2064 6963  that it is a dic
-0001d680: 7420 6f66 0a20 2020 2020 2020 2020 2020  t of.           
-0001d690: 2023 2066 6f72 7761 7264 2061 7267 756d   # forward argum
-0001d6a0: 656e 7473 2074 6f20 7468 6520 636f 7272  ents to the corr
-0001d6b0: 6573 706f 6e64 696e 670a 2020 2020 2020  esponding.      
-0001d6c0: 2020 2020 2020 2320 6772 6164 6965 6e74        # gradient
-0001d6d0: 732f 636f 7461 6e67 656e 7473 2f61 646a  s/cotangents/adj
-0001d6e0: 6f69 6e74 732f 7365 6e73 6974 6976 6974  oints/sensitivit
-0001d6f0: 6965 732e 0a20 2020 2020 2020 2020 2020  ies..           
-0001d700: 2075 7365 645f 6e61 6d65 7320 3d20 7365   used_names = se
-0001d710: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0001d720: 666f 7220 692c 2028 6b2c 2076 2920 696e  for i, (k, v) in
-0001d730: 2065 6e75 6d65 7261 7465 2869 6e73 7065   enumerate(inspe
-0001d740: 6374 2e73 6967 6e61 7475 7265 2861 7567  ct.signature(aug
-0001d750: 5f66 6f72 7761 7264 292e 7061 7261 6d65  _forward).parame
-0001d760: 7465 7273 2e69 7465 6d73 2829 293a 0a20  ters.items()):. 
-0001d770: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001d780: 6620 762e 6b69 6e64 2069 6e20 2869 6e73  f v.kind in (ins
-0001d790: 7065 6374 2e50 6172 616d 6574 6572 2e50  pect.Parameter.P
-0001d7a0: 4f53 4954 494f 4e41 4c5f 4f4e 4c59 2c20  OSITIONAL_ONLY, 
-0001d7b0: 696e 7370 6563 742e 5061 7261 6d65 7465  inspect.Paramete
-0001d7c0: 722e 504f 5349 5449 4f4e 414c 5f4f 525f  r.POSITIONAL_OR_
-0001d7d0: 4b45 5957 4f52 4429 3a0a 2020 2020 2020  KEYWORD):.      
-0001d7e0: 2020 2020 2020 2020 2020 2020 2020 7075                pu
-0001d7f0: 745f 6772 6164 2873 796d 626f 6c2e 6172  t_grad(symbol.ar
-0001d800: 6773 5b69 5d2c 2072 6573 756c 742e 6765  gs[i], result.ge
-0001d810: 7428 6b2c 204e 6f6e 6529 290a 2020 2020  t(k, None)).    
-0001d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d830: 7573 6564 5f6e 616d 6573 2e61 6464 286b  used_names.add(k
-0001d840: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0001d850: 2046 6f72 2064 6576 656c 6f70 6572 2063   For developer c
-0001d860: 6f6e 7665 6e69 656e 6365 2c20 7765 2061  onvenience, we a
-0001d870: 6c6c 6f77 2075 7369 6e67 2074 6865 206e  llow using the n
-0001d880: 616d 6520 6672 6f6d 2074 6865 0a20 2020  ame from the.   
-0001d890: 2020 2020 2020 2020 2023 2066 6f72 7761           # forwa
-0001d8a0: 7264 206d 6574 6120 696e 2061 6464 6974  rd meta in addit
-0001d8b0: 696f 6e20 746f 2074 6865 206e 616d 6520  ion to the name 
-0001d8c0: 6672 6f6d 2074 6865 2061 7567 6d65 6e74  from the augment
-0001d8d0: 6564 2066 6f72 7761 7264 0a20 2020 2020  ed forward.     
-0001d8e0: 2020 2020 2020 2023 2073 6967 6e61 7475         # signatu
-0001d8f0: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
-0001d900: 2320 4966 2062 6f74 6820 6e61 6d65 7320  # If both names 
-0001d910: 6172 6520 7573 6564 2c20 7468 6520 6f6e  are used, the on
-0001d920: 6520 6672 6f6d 2074 6865 2066 6f72 7761  e from the forwa
-0001d930: 7264 206d 6574 6120 7461 6b65 730a 2020  rd meta takes.  
-0001d940: 2020 2020 2020 2020 2020 2320 7072 6563            # prec
-0001d950: 6564 656e 6365 2e0a 2020 2020 2020 2020  edence..        
-0001d960: 2020 2020 666f 7220 692c 2028 6b2c 2076      for i, (k, v
-0001d970: 2920 696e 2065 6e75 6d65 7261 7465 2869  ) in enumerate(i
-0001d980: 6e73 7065 6374 2e73 6967 6e61 7475 7265  nspect.signature
-0001d990: 2873 796d 626f 6c2e 7379 6d2e 6d65 7461  (symbol.sym.meta
-0001d9a0: 292e 7061 7261 6d65 7465 7273 2e69 7465  ).parameters.ite
-0001d9b0: 6d73 2829 293a 0a20 2020 2020 2020 2020  ms()):.         
-0001d9c0: 2020 2020 2020 2069 6620 762e 6b69 6e64         if v.kind
-0001d9d0: 2069 6e20 2869 6e73 7065 6374 2e50 6172   in (inspect.Par
-0001d9e0: 616d 6574 6572 2e50 4f53 4954 494f 4e41  ameter.POSITIONA
-0001d9f0: 4c5f 4f4e 4c59 2c20 696e 7370 6563 742e  L_ONLY, inspect.
-0001da00: 5061 7261 6d65 7465 722e 504f 5349 5449  Parameter.POSITI
-0001da10: 4f4e 414c 5f4f 525f 4b45 5957 4f52 4429  ONAL_OR_KEYWORD)
-0001da20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001da30: 2020 2020 2020 6966 206b 206e 6f74 2069        if k not i
-0001da40: 6e20 7573 6564 5f6e 616d 6573 3a0a 2020  n used_names:.  
-0001da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da60: 2020 2020 2020 7075 745f 6772 6164 2873        put_grad(s
-0001da70: 796d 626f 6c2e 6172 6773 5b69 5d2c 2072  ymbol.args[i], r
-0001da80: 6573 756c 742e 6765 7428 6b2c 204e 6f6e  esult.get(k, Non
-0001da90: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-0001daa0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-0001dab0: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-0001dac0: 6e63 6528 7265 7375 6c74 2c20 5365 7175  nce(result, Sequ
-0001dad0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0001dae0: 2020 2072 6573 756c 7420 3d20 2872 6573     result = (res
-0001daf0: 756c 742c 290a 0a20 2020 2020 2020 2064  ult,)..        d
-0001db00: 6566 2069 735f 6469 6666 6572 656e 7469  ef is_differenti
-0001db10: 6162 6c65 2861 7267 293a 0a20 2020 2020  able(arg):.     
-0001db20: 2020 2020 2020 206d 6174 6368 2061 7267         match arg
-0001db30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001db40: 2020 6361 7365 2054 656e 736f 7250 726f    case TensorPro
-0001db50: 7879 2829 3a0a 2020 2020 2020 2020 2020  xy():.          
-0001db60: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001db70: 2064 7479 7065 732e 6973 5f69 6e65 7861   dtypes.is_inexa
-0001db80: 6374 5f64 7479 7065 2861 7267 2e64 7479  ct_dtype(arg.dty
-0001db90: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
-0001dba0: 2020 2020 6361 7365 2053 6571 7565 6e63      case Sequenc
-0001dbb0: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-0001dbc0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001dbd0: 6172 6720 616e 6420 616c 6c28 6973 696e  arg and all(isin
-0001dbe0: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
-0001dbf0: 5072 6f78 7929 2061 6e64 2064 7479 7065  Proxy) and dtype
-0001dc00: 732e 6973 5f69 6e65 7861 6374 5f64 7479  s.is_inexact_dty
-0001dc10: 7065 2878 2e64 7479 7065 2920 666f 7220  pe(x.dtype) for 
-0001dc20: 7820 696e 2061 7267 290a 2020 2020 2020  x in arg).      
-0001dc30: 2020 2020 2020 2020 2020 6361 7365 205f            case _
-0001dc40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001dc50: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0001dc60: 7365 0a0a 2020 2020 2020 2020 6966 206c  se..        if l
-0001dc70: 656e 2873 796d 626f 6c2e 6172 6773 2920  en(symbol.args) 
-0001dc80: 213d 2028 6f72 6967 5f72 6573 5f6c 656e  != (orig_res_len
-0001dc90: 203a 3d20 6c65 6e28 7265 7375 6c74 2929   := len(result))
-0001dca0: 3a0a 2020 2020 2020 2020 2020 2020 6368  :.            ch
-0001dcb0: 6563 6b28 0a20 2020 2020 2020 2020 2020  eck(.           
-0001dcc0: 2020 2020 206f 7269 675f 7265 735f 6c65       orig_res_le
-0001dcd0: 6e20 3c3d 206c 656e 2873 796d 626f 6c2e  n <= len(symbol.
-0001dce0: 6172 6773 292c 0a20 2020 2020 2020 2020  args),.         
-0001dcf0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
-0001dd00: 2242 6163 6b77 6172 6420 666f 7220 7b73  "Backward for {s
-0001dd10: 796d 626f 6c2e 7379 6d2e 6964 7d20 7265  ymbol.sym.id} re
-0001dd20: 7475 726e 6564 207b 6f72 6967 5f72 6573  turned {orig_res
-0001dd30: 5f6c 656e 7d20 7661 6c75 6573 2c20 220a  _len} values, ".
-0001dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd50: 2b20 6622 6275 7420 6578 7065 6374 6564  + f"but expected
-0001dd60: 2061 7420 6d6f 7374 207b 6c65 6e28 7379   at most {len(sy
-0001dd70: 6d62 6f6c 2e61 7267 7329 7d22 2c0a 2020  mbol.args)}",.  
-0001dd80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001dd90: 2020 2020 2020 2020 2320 4173 7375 6d69          # Assumi
-0001dda0: 6e67 2074 6861 7420 7468 6520 6e6f 6e2d  ng that the non-
-0001ddb0: 6469 6666 6572 656e 7469 6162 6c65 2061  differentiable a
-0001ddc0: 7267 756d 656e 7473 2077 6572 6520 6472  rguments were dr
-0001ddd0: 6f70 7065 6420 6672 6f6d 0a20 2020 2020  opped from.     
-0001dde0: 2020 2020 2020 2023 2074 6865 2062 6163         # the bac
-0001ddf0: 6b77 6172 6420 6675 6e63 7469 6f6e 2c20  kward function, 
-0001de00: 7765 2061 7265 2067 6f69 6e67 2074 6f20  we are going to 
-0001de10: 6170 7065 6e64 204e 6f6e 6520 746f 2074  append None to t
-0001de20: 6865 2072 6573 756c 740a 2020 2020 2020  he result.      
-0001de30: 2020 2020 2020 2320 746f 206d 6174 6368        # to match
-0001de40: 2074 6865 206e 756d 6265 7220 6f66 2061   the number of a
-0001de50: 7267 756d 656e 7473 2e20 416c 7465 726e  rguments. Altern
-0001de60: 6174 6976 656c 792c 2077 6520 636f 756c  atively, we coul
-0001de70: 6420 6a75 7374 0a20 2020 2020 2020 2020  d just.         
-0001de80: 2020 2023 2068 6176 6520 6120 666f 722d     # have a for-
-0001de90: 6c6f 6f70 2077 6974 6820 6120 636f 6e64  loop with a cond
-0001dea0: 6974 696f 6e61 6c20 7768 656e 2077 7269  itional when wri
-0001deb0: 7469 6e67 2074 6f20 7468 650a 2020 2020  ting to the.    
-0001dec0: 2020 2020 2020 2020 2320 656e 7669 726f          # enviro
-0001ded0: 6e6d 656e 742e 0a0a 2020 2020 2020 2020  nment...        
-0001dee0: 2020 2020 6974 6572 5f72 6573 756c 7420      iter_result 
-0001def0: 3d20 6974 6572 2872 6573 756c 7429 0a20  = iter(result). 
-0001df00: 2020 2020 2020 2020 2020 206e 5f64 6966             n_dif
-0001df10: 6665 7265 6e74 6961 626c 655f 6172 6773  ferentiable_args
-0001df20: 203d 2073 756d 2862 6f6f 6c28 6973 5f64   = sum(bool(is_d
-0001df30: 6966 6665 7265 6e74 6961 626c 6528 6172  ifferentiable(ar
-0001df40: 6729 2920 666f 7220 6172 6720 696e 2073  g)) for arg in s
-0001df50: 796d 626f 6c2e 6172 6773 290a 2020 2020  ymbol.args).    
-0001df60: 2020 2020 2020 2020 6368 6563 6b28 0a20          check(. 
-0001df70: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0001df80: 5f64 6966 6665 7265 6e74 6961 626c 655f  _differentiable_
-0001df90: 6172 6773 203c 3d20 6f72 6967 5f72 6573  args <= orig_res
-0001dfa0: 5f6c 656e 2c0a 2020 2020 2020 2020 2020  _len,.          
-0001dfb0: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
-0001dfc0: 4261 636b 7761 7264 2066 6f72 207b 7379  Backward for {sy
-0001dfd0: 6d62 6f6c 2e73 796d 2e69 647d 2072 6574  mbol.sym.id} ret
-0001dfe0: 7572 6e65 6420 7b6f 7269 675f 7265 735f  urned {orig_res_
-0001dff0: 6c65 6e7d 2076 616c 7565 2873 292c 2022  len} value(s), "
-0001e000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e010: 202b 2066 2262 7574 2065 7870 6563 7465   + f"but expecte
-0001e020: 6420 7b6e 5f64 6966 6665 7265 6e74 6961  d {n_differentia
-0001e030: 626c 655f 6172 6773 7d22 2c0a 2020 2020  ble_args}",.    
-0001e040: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001e050: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-0001e060: 7475 706c 6528 6e65 7874 2869 7465 725f  tuple(next(iter_
-0001e070: 7265 7375 6c74 2920 6966 2069 735f 6469  result) if is_di
-0001e080: 6666 6572 656e 7469 6162 6c65 2861 7267  fferentiable(arg
-0001e090: 2920 656c 7365 204e 6f6e 6520 666f 7220  ) else None for 
-0001e0a0: 6172 6720 696e 2073 796d 626f 6c2e 6172  arg in symbol.ar
-0001e0b0: 6773 290a 0a20 2020 2020 2020 2023 2053  gs)..        # S
-0001e0c0: 6565 2022 4261 636b 7761 7264 2069 6d70  ee "Backward imp
-0001e0d0: 6c20 666f 7220 6f70 7320 6f66 2074 6865  l for ops of the
-0001e0e0: 2074 7970 6520 5365 7175 656e 6365 5b54   type Sequence[T
-0001e0f0: 656e 736f 7250 726f 7879 5d2c 202e 2e2e  ensorProxy], ...
-0001e100: 202d 3e20 2e2e 2e20 7265 7375 6c74 7320   -> ... results 
-0001e110: 696e 204e 6f6e 6520 6772 6164 732e 220a  in None grads.".
-0001e120: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
-0001e130: 7320 6120 7465 6d70 6f72 6172 7920 776f  s a temporary wo
-0001e140: 726b 6172 6f75 6e64 2e0a 2020 2020 2020  rkaround..      
-0001e150: 2020 6966 2073 796d 626f 6c2e 7379 6d2e    if symbol.sym.
-0001e160: 6964 2069 6e20 2870 7269 6d73 2e50 7269  id in (prims.Pri
-0001e170: 6d49 4473 2e43 4154 2c20 2274 6f72 6368  mIDs.CAT, "torch
-0001e180: 2e63 6174 222c 2022 746f 7263 682e 7374  .cat", "torch.st
-0001e190: 6163 6b22 293a 0a20 2020 2020 2020 2020  ack"):.         
-0001e1a0: 2020 2073 6166 655f 6d61 705f 666c 6174     safe_map_flat
-0001e1b0: 2870 7574 5f67 7261 642c 2073 796d 626f  (put_grad, symbo
-0001e1c0: 6c2e 6172 6773 2c20 7265 7375 6c74 290a  l.args, result).
-0001e1d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001e1e0: 2020 2020 2020 2020 2020 7361 6665 5f6d            safe_m
-0001e1f0: 6170 2870 7574 5f67 7261 642c 2073 796d  ap(put_grad, sym
-0001e200: 626f 6c2e 6172 6773 2c20 7265 7375 6c74  bol.args, result
-0001e210: 290a 0a20 2020 2064 6566 2067 6574 5f69  )..    def get_i
-0001e220: 6e65 7861 6374 5f64 7479 7065 5f6f 725f  nexact_dtype_or_
-0001e230: 6e6f 6e65 2878 293a 0a20 2020 2020 2020  none(x):.       
-0001e240: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
-0001e250: 2c20 2854 656e 736f 7250 726f 7879 2c20  , (TensorProxy, 
-0001e260: 4675 7475 7265 5465 6e73 6f72 5072 6f78  FutureTensorProx
-0001e270: 7929 2920 616e 6420 6474 7970 6573 2e69  y)) and dtypes.i
-0001e280: 735f 696e 6578 6163 745f 6474 7970 6528  s_inexact_dtype(
-0001e290: 782e 6474 7970 6529 3a0a 2020 2020 2020  x.dtype):.      
-0001e2a0: 2020 2020 2020 7265 7475 726e 2078 0a20        return x. 
-0001e2b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001e2c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001e2d0: 4e6f 6e65 0a0a 2020 2020 6761 7267 7320  None..    gargs 
-0001e2e0: 3d20 7472 6565 5f6d 6170 2867 6574 5f67  = tree_map(get_g
-0001e2f0: 7261 642c 2074 7570 6c65 2874 7261 6365  rad, tuple(trace
-0001e300: 2e61 7267 7329 290a 2020 2020 676b 7761  .args)).    gkwa
-0001e310: 7267 7320 3d20 7472 6565 5f6d 6170 2867  rgs = tree_map(g
-0001e320: 6574 5f67 7261 642c 2074 7261 6365 2e6b  et_grad, trace.k
-0001e330: 7761 7267 7329 0a20 2020 2067 6b77 6172  wargs).    gkwar
-0001e340: 6773 203d 207b 6b3a 2076 2066 6f72 206b  gs = {k: v for k
-0001e350: 2c20 7620 696e 2067 6b77 6172 6773 2e69  , v in gkwargs.i
-0001e360: 7465 6d73 2829 2069 6620 7620 6973 206e  tems() if v is n
-0001e370: 6f74 204e 6f6e 657d 0a20 2020 2067 6172  ot None}.    gar
-0001e380: 6773 2c20 676b 7761 7267 7320 3d20 7472  gs, gkwargs = tr
-0001e390: 6565 5f6d 6170 2867 6574 5f69 6e65 7861  ee_map(get_inexa
-0001e3a0: 6374 5f64 7479 7065 5f6f 725f 6e6f 6e65  ct_dtype_or_none
-0001e3b0: 2c20 2867 6172 6773 2c20 676b 7761 7267  , (gargs, gkwarg
-0001e3c0: 7329 290a 2020 2020 7265 7475 726e 2067  s)).    return g
-0001e3d0: 6172 6773 202b 2028 676b 7761 7267 732c  args + (gkwargs,
-0001e3e0: 2920 6966 206c 656e 2867 6b77 6172 6773  ) if len(gkwargs
-0001e3f0: 2920 213d 2030 2065 6c73 6520 6761 7267  ) != 0 else garg
-0001e400: 730a 0a0a 6465 6620 766a 705f 6361 6c6c  s...def vjp_call
-0001e410: 5f6d 6574 6166 756e 6328 6465 7461 6368  _metafunc(detach
-0001e420: 6564 3a20 626f 6f6c 2c20 7072 696d 616c  ed: bool, primal
-0001e430: 732c 2063 6f74 616e 6765 6e74 732c 2074  s, cotangents, t
-0001e440: 7261 6365 3a20 5472 6163 652c 202a 2a6b  race: Trace, **k
-0001e450: 7761 7267 7329 3a0a 2020 2020 2320 4173  wargs):.    # As
-0001e460: 7375 6d69 6e67 2070 7269 6d61 6c73 2069  suming primals i
-0001e470: 7320 666c 6174 0a0a 2020 2020 6966 206e  s flat..    if n
-0001e480: 6f74 2069 7369 6e73 7461 6e63 6528 7072  ot isinstance(pr
-0001e490: 696d 616c 732c 2053 6571 7565 6e63 6529  imals, Sequence)
-0001e4a0: 3a0a 2020 2020 2020 2020 7072 696d 616c  :.        primal
-0001e4b0: 7320 3d20 2870 7269 6d61 6c73 2c29 0a0a  s = (primals,)..
-0001e4c0: 2020 2020 6374 7820 3d20 6465 7461 6368      ctx = detach
-0001e4d0: 6564 5f74 7261 6365 2829 2069 6620 6465  ed_trace() if de
-0001e4e0: 7461 6368 6564 2065 6c73 6520 6e75 6c6c  tached else null
-0001e4f0: 636f 6e74 6578 7428 290a 2020 2020 7769  context().    wi
-0001e500: 7468 2063 7478 3a0a 2020 2020 2020 2020  th ctx:.        
-0001e510: 7265 7375 6c74 2c20 656e 7620 3d20 6175  result, env = au
-0001e520: 676d 656e 7465 645f 666f 7277 6172 645f  gmented_forward_
-0001e530: 7061 7373 282a 7072 696d 616c 732c 2074  pass(*primals, t
-0001e540: 7261 6365 3d74 7261 6365 2c20 2a2a 6b77  race=trace, **kw
-0001e550: 6172 6773 290a 2020 2020 2020 2020 6368  args).        ch
-0001e560: 6563 6b28 0a20 2020 2020 2020 2020 2020  eck(.           
-0001e570: 206c 656e 2872 6573 756c 7429 203d 3d20   len(result) == 
-0001e580: 6c65 6e28 636f 7461 6e67 656e 7473 2920  len(cotangents) 
-0001e590: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-0001e5a0: 7375 6c74 2c20 5365 7175 656e 6365 2920  sult, Sequence) 
-0001e5b0: 656c 7365 2054 7275 652c 0a20 2020 2020  else True,.     
-0001e5c0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
-0001e5d0: 2245 7870 6563 7465 6420 636f 7461 6e67  "Expected cotang
-0001e5e0: 656e 7473 2074 6f20 6265 2061 2073 6571  ents to be a seq
-0001e5f0: 7565 6e63 6520 6f66 206c 656e 6774 6820  uence of length 
-0001e600: 7b6c 656e 2872 6573 756c 7429 7d2c 2067  {len(result)}, g
-0001e610: 6f74 2061 2073 6571 7565 6e63 6520 6f66  ot a sequence of
-0001e620: 206c 656e 6774 6820 7b6c 656e 2863 6f74   length {len(cot
-0001e630: 616e 6765 6e74 7329 7d22 2c0a 2020 2020  angents)}",.    
-0001e640: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-0001e650: 7475 726e 2072 6573 756c 742c 2062 6163  turn result, bac
-0001e660: 6b77 6172 645f 7061 7373 2865 6e76 2c20  kward_pass(env, 
-0001e670: 7472 6163 652c 2063 6f74 616e 6765 6e74  trace, cotangent
-0001e680: 7329 0a0a 0a23 2054 4f44 4f3a 2043 616e  s)...# TODO: Can
-0001e690: 2774 2075 7365 2061 2053 796d 626f 6c20  't use a Symbol 
-0001e6a0: 6865 7265 2062 6563 6175 7365 206d 6978  here because mix
-0001e6b0: 6564 2065 7865 6375 746f 7220 7379 6273  ed executor sybs
-0001e6c0: 796d 626f 6c73 2073 6565 6d20 746f 2062  ymbols seem to b
-0001e6d0: 650a 2320 756e 7375 7070 6f72 7465 642e  e.# unsupported.
-0001e6e0: 2053 6565 2069 7373 7565 2022 436f 756c   See issue "Coul
-0001e6f0: 6420 6e6f 7420 6669 6e64 2061 6e20 6578  d not find an ex
-0001e700: 6563 7574 6f72 2066 6f72 2062 6f75 6e64  ecutor for bound
-0001e710: 2073 796d 626f 6c20 7768 656e 2069 7473   symbol when its
-0001e720: 2073 7562 7379 6d62 6f6c 730a 2320 6172   subsymbols.# ar
-0001e730: 6520 6e6f 7420 6675 6c6c 7920 7375 7070  e not fully supp
-0001e740: 6f72 7465 6420 6279 2061 2073 696e 676c  orted by a singl
-0001e750: 6520 6578 6563 7574 6f72 220a 766a 705f  e executor".vjp_
-0001e760: 6361 6c6c 203d 2070 6172 7469 616c 280a  call = partial(.
-0001e770: 2020 2020 766a 705f 6361 6c6c 5f6d 6574      vjp_call_met
-0001e780: 6166 756e 632c 2046 616c 7365 0a29 2020  afunc, False.)  
-0001e790: 2320 5379 6d62 6f6c 2869 643d 5472 616e  # Symbol(id=Tran
-0001e7a0: 7366 6f72 6d73 2e56 6a70 4f70 2c20 6e61  sforms.VjpOp, na
-0001e7b0: 6d65 3d22 766a 705f 6361 6c6c 222c 206d  me="vjp_call", m
-0001e7c0: 6574 613d 7061 7274 6961 6c28 766a 705f  eta=partial(vjp_
-0001e7d0: 6361 6c6c 5f6d 6574 6166 756e 632c 2046  call_metafunc, F
-0001e7e0: 616c 7365 2929 0a0a 0a64 6566 2076 6a70  alse))...def vjp
-0001e7f0: 2866 756e 6329 3a0a 2020 2020 2222 2243  (func):.    """C
-0001e800: 6f6d 7075 7465 7320 7468 6520 564a 5020  omputes the VJP 
-0001e810: 6f66 2061 2066 756e 6374 696f 6e2e 0a0a  of a function...
-0001e820: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-0001e830: 2020 6675 6e63 2028 4361 6c6c 6162 6c65    func (Callable
-0001e840: 293a 2046 756e 6374 696f 6e20 746f 2062  ): Function to b
-0001e850: 6520 6469 6666 6572 656e 7469 6174 6564  e differentiated
-0001e860: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
-0001e870: 6566 205f 766a 7028 7072 696d 616c 732c  ef _vjp(primals,
-0001e880: 2063 6f74 616e 6765 6e74 732c 202a 2a6b   cotangents, **k
-0001e890: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-0001e8a0: 666c 6174 5f66 756e 632c 2066 6c61 745f  flat_func, flat_
-0001e8b0: 6172 6773 2c20 7370 6563 203d 2066 6c61  args, spec = fla
-0001e8c0: 7474 656e 5f66 756e 6328 6675 6e63 2c20  tten_func(func, 
-0001e8d0: 7072 696d 616c 732c 206b 7761 7267 7329  primals, kwargs)
-0001e8e0: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
-0001e8f0: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
-0001e900: 2829 2866 6c61 745f 6675 6e63 2c20 2a66  ()(flat_func, *f
-0001e910: 6c61 745f 6172 6773 290a 2020 2020 2020  lat_args).      
-0001e920: 2020 7265 7375 6c74 2c20 766a 705f 7265    result, vjp_re
-0001e930: 7375 6c74 203d 2076 6a70 5f63 616c 6c28  sult = vjp_call(
-0001e940: 666c 6174 5f61 7267 732c 2063 6f74 616e  flat_args, cotan
-0001e950: 6765 6e74 732c 2074 7261 6365 3d74 7261  gents, trace=tra
-0001e960: 6365 290a 2020 2020 2020 2020 6770 7269  ce).        gpri
-0001e970: 6d61 6c73 2c20 676b 7761 7267 7320 3d20  mals, gkwargs = 
-0001e980: 7472 6565 5f75 6e66 6c61 7474 656e 2876  tree_unflatten(v
-0001e990: 6a70 5f72 6573 756c 742c 2073 7065 6329  jp_result, spec)
-0001e9a0: 0a20 2020 2020 2020 2067 7261 6473 203d  .        grads =
-0001e9b0: 2067 7072 696d 616c 7320 2b20 2867 6b77   gprimals + (gkw
-0001e9c0: 6172 6773 2c29 2069 6620 6c65 6e28 676b  args,) if len(gk
-0001e9d0: 7761 7267 7329 2021 3d20 3020 656c 7365  wargs) != 0 else
-0001e9e0: 2067 7072 696d 616c 730a 2020 2020 2020   gprimals.      
-0001e9f0: 2020 7265 7475 726e 2072 6573 756c 742c    return result,
-0001ea00: 2067 7261 6473 0a0a 2020 2020 7265 7475   grads..    retu
-0001ea10: 726e 205f 766a 700a 0a0a 6465 6620 7661  rn _vjp...def va
-0001ea20: 6c75 655f 616e 645f 6772 6164 2866 756e  lue_and_grad(fun
-0001ea30: 6329 3a0a 2020 2020 2222 2243 6f6d 7075  c):.    """Compu
-0001ea40: 7465 7320 7468 6520 7661 6c75 6520 616e  tes the value an
-0001ea50: 6420 6772 6164 6965 6e74 206f 6620 6120  d gradient of a 
-0001ea60: 6675 6e63 7469 6f6e 2e0a 0a20 2020 2054  function...    T
-0001ea70: 6869 7320 6973 2061 2063 6f6e 7665 6e69  his is a conveni
-0001ea80: 656e 6365 2066 756e 6374 696f 6e20 7468  ence function th
-0001ea90: 6174 2063 6f6d 6269 6e65 7320 7468 6520  at combines the 
-0001eaa0: 6675 6e63 7469 6f6e 616c 6974 7920 6f66  functionality of
-0001eab0: 0a20 2020 2060 766a 705f 6361 6c6c 6020  .    `vjp_call` 
-0001eac0: 7769 7468 2069 6d70 6c69 6369 7420 696e  with implicit in
-0001ead0: 6974 6961 6c69 7a61 7469 6f6e 206f 6620  itialization of 
-0001eae0: 7468 6520 636f 7461 6e67 656e 7420 746f  the cotangent to
-0001eaf0: 2031 2e0a 0a20 2020 2041 7267 733a 0a20   1...    Args:. 
-0001eb00: 2020 2020 2020 2066 756e 6320 2843 616c         func (Cal
-0001eb10: 6c61 626c 6529 3a20 4675 6e63 7469 6f6e  lable): Function
-0001eb20: 2074 6f20 6265 2064 6966 6665 7265 6e74   to be different
-0001eb30: 6961 7465 642e 0a20 2020 2022 2222 0a0a  iated..    """..
-0001eb40: 2020 2020 6465 6620 6f6e 6573 5f6c 696b      def ones_lik
-0001eb50: 6528 7829 3a0a 2020 2020 2020 2020 6966  e(x):.        if
-0001eb60: 2069 7369 6e73 7461 6e63 6528 782c 2054   isinstance(x, T
-0001eb70: 656e 736f 7250 726f 7879 293a 0a20 2020  ensorProxy):.   
-0001eb80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001eb90: 6675 6c6c 5f6c 696b 6528 782c 2066 696c  full_like(x, fil
-0001eba0: 6c5f 7661 6c75 653d 3129 0a20 2020 2020  l_value=1).     
-0001ebb0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-0001ebc0: 6365 2878 2c20 4e75 6d62 6572 5072 6f78  ce(x, NumberProx
-0001ebd0: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
-0001ebe0: 7265 7475 726e 2074 7970 6528 782e 7661  return type(x.va
-0001ebf0: 6c75 6529 2831 290a 2020 2020 2020 2020  lue)(1).        
-0001ec00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001ec10: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0001ec20: 6f72 2866 226f 6e65 735f 6c69 6b65 2069  or(f"ones_like i
-0001ec30: 6e73 6964 6520 7661 6c75 655f 616e 645f  nside value_and_
-0001ec40: 6772 6164 2067 6f74 2061 6e20 756e 7375  grad got an unsu
-0001ec50: 7070 6f72 7465 6420 7479 7065 207b 7479  pported type {ty
-0001ec60: 7065 2878 297d 2229 0a0a 2020 2020 6465  pe(x)}")..    de
-0001ec70: 6620 5f76 616c 7565 5f61 6e64 5f67 7261  f _value_and_gra
-0001ec80: 6428 2a61 7267 732c 202a 2a6b 7761 7267  d(*args, **kwarg
-0001ec90: 7329 3a0a 2020 2020 2020 2020 7472 6163  s):.        trac
-0001eca0: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
-0001ecb0: 6163 6528 2928 6675 6e63 2c20 2a61 7267  ace()(func, *arg
-0001ecc0: 732c 202a 2a6b 7761 7267 7329 0a20 2020  s, **kwargs).   
-0001ecd0: 2020 2020 2063 6f74 616e 6765 6e74 7320       cotangents 
-0001ece0: 3d20 7472 6565 5f6d 6170 286c 616d 6264  = tree_map(lambd
-0001ecf0: 6120 763a 206f 6e65 735f 6c69 6b65 2876  a v: ones_like(v
-0001ed00: 292c 2074 7261 6365 2e6f 7574 7075 7429  ), trace.output)
-0001ed10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001ed20: 766a 7028 6675 6e63 2928 6172 6773 2c20  vjp(func)(args, 
-0001ed30: 636f 7461 6e67 656e 7473 2c20 2a2a 6b77  cotangents, **kw
-0001ed40: 6172 6773 290a 0a20 2020 2072 6574 7572  args)..    retur
-0001ed50: 6e20 5f76 616c 7565 5f61 6e64 5f67 7261  n _value_and_gra
-0001ed60: 640a 0a0a 466f 7277 6172 6442 6163 6b77  d...ForwardBackw
-0001ed70: 6172 6454 7261 6365 7320 3d20 6e61 6d65  ardTraces = name
-0001ed80: 6474 7570 6c65 2822 466f 7277 6172 6442  dtuple("ForwardB
-0001ed90: 6163 6b77 6172 6454 7261 6365 7322 2c20  ackwardTraces", 
-0001eda0: 5b22 666f 7277 6172 645f 7472 6163 6522  ["forward_trace"
-0001edb0: 2c20 2262 6163 6b77 6172 645f 7472 6163  , "backward_trac
-0001edc0: 6522 5d29 0a0a 0a64 6566 205f 7370 6c69  e"])...def _spli
-0001edd0: 745f 7361 7665 645f 666f 725f 6261 636b  t_saved_for_back
-0001ede0: 7761 7264 5f69 6e74 6f5f 7465 6e73 6f72  ward_into_tensor
-0001edf0: 735f 616e 645f 6f74 6865 7228 0a20 2020  s_and_other(.   
-0001ee00: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-0001ee10: 6172 643a 2053 6571 7565 6e63 655b 5661  ard: Sequence[Va
-0001ee20: 7269 6162 6c65 5d2c 0a29 202d 3e20 7475  riable],.) -> tu
-0001ee30: 706c 655b 5365 7175 656e 6365 5b56 6172  ple[Sequence[Var
-0001ee40: 6961 626c 655d 2c20 5365 7175 656e 6365  iable], Sequence
-0001ee50: 5b56 6172 6961 626c 655d 5d3a 0a20 2020  [Variable]]:.   
-0001ee60: 2022 2222 5370 6c69 7473 2073 6176 6564   """Splits saved
-0001ee70: 5f66 6f72 5f62 6163 6b77 6172 6420 696e  _for_backward in
-0001ee80: 746f 2074 656e 736f 7273 2061 6e64 206f  to tensors and o
-0001ee90: 7468 6572 2e0a 0a20 2020 2041 7267 733a  ther...    Args:
-0001eea0: 0a20 2020 2020 2020 2073 6176 6564 5f66  .        saved_f
-0001eeb0: 6f72 5f62 6163 6b77 6172 6420 2853 6571  or_backward (Seq
-0001eec0: 7565 6e63 655b 5661 7269 6162 6c65 5d29  uence[Variable])
-0001eed0: 3a20 5361 7665 645f 666f 725f 6261 636b  : Saved_for_back
-0001eee0: 7761 7264 2074 6f20 7370 6c69 742e 0a0a  ward to split...
-0001eef0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001ef00: 2020 2020 2074 7570 6c65 5b53 6571 7565       tuple[Seque
-0001ef10: 6e63 655b 5661 7269 6162 6c65 5d2c 2053  nce[Variable], S
-0001ef20: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
-0001ef30: 5d5d 3a20 5475 706c 6520 6f66 2074 656e  ]]: Tuple of ten
-0001ef40: 736f 7273 2061 6e64 206f 7468 6572 2e0a  sors and other..
-0001ef50: 2020 2020 2222 220a 2020 2020 6973 5f74      """.    is_t
-0001ef60: 656e 736f 7220 3d20 6c61 6d62 6461 2078  ensor = lambda x
-0001ef70: 3a20 6973 696e 7374 616e 6365 2878 2c20  : isinstance(x, 
-0001ef80: 5465 6e73 6f72 5072 6f78 7929 0a20 2020  TensorProxy).   
-0001ef90: 206f 7468 6572 2c20 7465 6e73 6f72 7320   other, tensors 
-0001efa0: 3d20 7574 696c 732e 7061 7274 6974 696f  = utils.partitio
-0001efb0: 6e28 6973 5f74 656e 736f 722c 2073 6176  n(is_tensor, sav
-0001efc0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
-0001efd0: 0a20 2020 2072 6574 7572 6e20 7475 706c  .    return tupl
-0001efe0: 6528 7465 6e73 6f72 7329 2c20 7475 706c  e(tensors), tupl
-0001eff0: 6528 6f74 6865 7229 0a0a 0a64 6566 205f  e(other)...def _
-0001f000: 7570 6461 7465 5f66 6f72 7761 7264 5f77  update_forward_w
-0001f010: 6974 685f 6e65 775f 7361 7665 645f 666f  ith_new_saved_fo
-0001f020: 725f 6261 636b 7761 7264 2866 6f72 7761  r_backward(forwa
-0001f030: 7264 5f74 7261 6365 3a20 5472 6163 652c  rd_trace: Trace,
-0001f040: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-0001f050: 6172 643a 2053 6571 7565 6e63 655b 5661  ard: Sequence[Va
-0001f060: 7269 6162 6c65 5d29 202d 3e20 4e6f 6e65  riable]) -> None
-0001f070: 3a0a 2020 2020 2222 2255 7064 6174 6573  :.    """Updates
-0001f080: 2074 6865 2066 6f72 7761 7264 2074 7261   the forward tra
-0001f090: 6365 2077 6974 6820 6e65 7720 7361 7665  ce with new save
-0001f0a0: 645f 666f 725f 6261 636b 7761 7264 2e0a  d_for_backward..
-0001f0b0: 0a20 2020 2054 6869 7320 6973 206e 6563  .    This is nec
-0001f0c0: 6573 7361 7279 2062 6563 6175 7365 2074  essary because t
-0001f0d0: 6865 2075 7064 6174 6564 2073 6176 6564  he updated saved
-0001f0e0: 5f66 6f72 5f62 6163 6b77 6172 6420 6973  _for_backward is
-0001f0f0: 206e 6f74 2061 7661 696c 6162 6c65 0a20   not available. 
-0001f100: 2020 2077 6865 6e20 7468 6520 666f 7277     when the forw
-0001f110: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
-0001f120: 2074 7261 6365 7320 6172 6520 636f 6e73   traces are cons
-0001f130: 7472 7563 7465 642e 0a0a 2020 2020 4172  tructed...    Ar
-0001f140: 6773 3a0a 2020 2020 2020 2020 666f 7277  gs:.        forw
-0001f150: 6172 645f 7472 6163 6520 2854 7261 6365  ard_trace (Trace
-0001f160: 293a 2046 6f72 7761 7264 2074 7261 6365  ): Forward trace
-0001f170: 2074 6f20 7570 6461 7465 2e0a 2020 2020   to update..    
-0001f180: 2020 2020 7361 7665 645f 666f 725f 6261      saved_for_ba
-0001f190: 636b 7761 7264 2028 5365 7175 656e 6365  ckward (Sequence
-0001f1a0: 5b56 6172 6961 626c 655d 293a 2053 6176  [Variable]): Sav
-0001f1b0: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-0001f1c0: 746f 2075 7365 2074 6f0a 2020 2020 2020  to use to.      
-0001f1d0: 2020 2020 2020 7570 6461 7465 2074 6865        update the
-0001f1e0: 2066 6f72 7761 7264 2074 7261 6365 2e0a   forward trace..
-0001f1f0: 2020 2020 2222 220a 2020 2020 7361 7665      """.    save
-0001f200: 645f 666f 725f 6261 636b 7761 7264 203d  d_for_backward =
-0001f210: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-0001f220: 2078 3a20 782e 7661 6c75 6520 6966 2069   x: x.value if i
-0001f230: 7369 6e73 7461 6e63 6528 782c 204e 756d  sinstance(x, Num
-0001f240: 6265 7250 726f 7879 2920 656c 7365 2078  berProxy) else x
-0001f250: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
-0001f260: 7761 7264 290a 2020 2020 7361 7665 645f  ward).    saved_
-0001f270: 7465 6e73 6f72 732c 2073 6176 6564 5f6f  tensors, saved_o
-0001f280: 7468 6572 203d 205f 7370 6c69 745f 7361  ther = _split_sa
-0001f290: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f2a0: 5f69 6e74 6f5f 7465 6e73 6f72 735f 616e  _into_tensors_an
-0001f2b0: 645f 6f74 6865 7228 7361 7665 645f 666f  d_other(saved_fo
-0001f2c0: 725f 6261 636b 7761 7264 290a 2020 2020  r_backward).    
-0001f2d0: 6173 7365 7274 2066 6f72 7761 7264 5f74  assert forward_t
-0001f2e0: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
-0001f2f0: 6c73 5b2d 315d 2e73 796d 2e69 6420 3d3d  ls[-1].sym.id ==
-0001f300: 2070 7269 6d73 2e50 7269 6d49 4473 2e52   prims.PrimIDs.R
-0001f310: 4554 5552 4e0a 2020 2020 6e65 775f 7265  ETURN.    new_re
-0001f320: 7475 726e 203d 2028 666f 7277 6172 645f  turn = (forward_
-0001f330: 7472 6163 652e 6f75 7470 7574 5b30 5d2c  trace.output[0],
-0001f340: 2028 7361 7665 645f 7465 6e73 6f72 732c   (saved_tensors,
-0001f350: 2073 6176 6564 5f6f 7468 6572 2929 0a20   saved_other)). 
-0001f360: 2020 2066 6f72 7761 7264 5f74 7261 6365     forward_trace
-0001f370: 2e62 6f75 6e64 5f73 796d 626f 6c73 5b2d  .bound_symbols[-
-0001f380: 315d 203d 2072 6570 6c61 6365 2866 6f72  1] = replace(for
-0001f390: 7761 7264 5f74 7261 6365 2e62 6f75 6e64  ward_trace.bound
-0001f3a0: 5f73 796d 626f 6c73 5b2d 315d 2c20 6172  _symbols[-1], ar
-0001f3b0: 6773 3d6e 6577 5f72 6574 7572 6e29 0a0a  gs=new_return)..
-0001f3c0: 0a64 6566 205f 7570 6461 7465 5f62 6163  .def _update_bac
-0001f3d0: 6b77 6172 645f 7769 7468 5f6e 6577 5f73  kward_with_new_s
-0001f3e0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f3f0: 6428 6261 636b 7761 7264 5f74 7261 6365  d(backward_trace
-0001f400: 3a20 5472 6163 652c 2073 6176 6564 5f66  : Trace, saved_f
-0001f410: 6f72 5f62 6163 6b77 6172 643a 2053 6571  or_backward: Seq
-0001f420: 7565 6e63 655b 5661 7269 6162 6c65 5d29  uence[Variable])
-0001f430: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
-0001f440: 2255 7064 6174 6573 2074 6865 2062 6163  "Updates the bac
-0001f450: 6b77 6172 6420 7472 6163 6520 7769 7468  kward trace with
-0001f460: 206e 6577 2073 6176 6564 5f66 6f72 5f62   new saved_for_b
-0001f470: 6163 6b77 6172 642e 0a0a 2020 2020 5468  ackward...    Th
-0001f480: 6973 2069 7320 6e65 6365 7373 6172 7920  is is necessary 
-0001f490: 6265 6361 7573 6520 7468 6520 7570 6461  because the upda
-0001f4a0: 7465 6420 7361 7665 645f 666f 725f 6261  ted saved_for_ba
-0001f4b0: 636b 7761 7264 2069 730a 2020 2020 6e6f  ckward is.    no
-0001f4c0: 7420 6176 6169 6c61 626c 6520 7768 656e  t available when
-0001f4d0: 2074 6865 2062 6163 6b77 6172 6420 7472   the backward tr
-0001f4e0: 6163 6520 6973 2063 6f6e 7374 7275 6374  ace is construct
-0001f4f0: 6564 2e0a 0a20 2020 2041 7267 733a 0a20  ed...    Args:. 
-0001f500: 2020 2020 2020 2062 6163 6b77 6172 645f         backward_
-0001f510: 7472 6163 6520 2854 7261 6365 293a 2042  trace (Trace): B
-0001f520: 6163 6b77 6172 6420 7472 6163 6520 746f  ackward trace to
-0001f530: 2075 7064 6174 652e 0a20 2020 2020 2020   update..       
-0001f540: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-0001f550: 6172 6420 2853 6571 7565 6e63 655b 5661  ard (Sequence[Va
-0001f560: 7269 6162 6c65 5d29 3a20 5361 7665 645f  riable]): Saved_
-0001f570: 666f 725f 6261 636b 7761 7264 2074 6f20  for_backward to 
-0001f580: 7573 6520 746f 0a20 2020 2020 2020 2020  use to.         
-0001f590: 2020 2075 7064 6174 6520 7468 6520 6261     update the ba
-0001f5a0: 636b 7761 7264 2074 7261 6365 2e0a 2020  ckward trace..  
-0001f5b0: 2020 2222 220a 0a20 2020 2064 6566 2075    """..    def u
-0001f5c0: 6e70 6163 6b69 6e67 5f66 6e28 7361 7665  npacking_fn(save
-0001f5d0: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
-0001f5e0: 636f 7461 6e67 656e 7473 293a 0a20 2020  cotangents):.   
-0001f5f0: 2020 2020 2070 6173 730a 0a20 2020 2063       pass..    c
-0001f600: 6f74 616e 6765 6e74 7320 3d20 6261 636b  otangents = back
-0001f610: 7761 7264 5f74 7261 6365 2e61 7267 735b  ward_trace.args[
-0001f620: 315d 0a20 2020 2073 6176 6564 5f74 656e  1].    saved_ten
-0001f630: 736f 7273 2c20 7361 7665 645f 6f74 6865  sors, saved_othe
-0001f640: 7220 3d20 5f73 706c 6974 5f73 6176 6564  r = _split_saved
-0001f650: 5f66 6f72 5f62 6163 6b77 6172 645f 696e  _for_backward_in
-0001f660: 746f 5f74 656e 736f 7273 5f61 6e64 5f6f  to_tensors_and_o
-0001f670: 7468 6572 2873 6176 6564 5f66 6f72 5f62  ther(saved_for_b
-0001f680: 6163 6b77 6172 6429 0a20 2020 2075 6e70  ackward).    unp
-0001f690: 6163 6b69 6e67 5f74 7261 6365 203d 2063  acking_trace = c
-0001f6a0: 6f6e 7374 7275 6374 5f74 7261 6365 2872  onstruct_trace(r
-0001f6b0: 656e 616d 655f 7072 6f78 6965 733d 4661  ename_proxies=Fa
-0001f6c0: 6c73 652c 2075 7365 5f64 6365 3d46 616c  lse, use_dce=Fal
-0001f6d0: 7365 2928 0a20 2020 2020 2020 2075 6e70  se)(.        unp
-0001f6e0: 6163 6b69 6e67 5f66 6e2c 2028 7361 7665  acking_fn, (save
-0001f6f0: 645f 7465 6e73 6f72 732c 2073 6176 6564  d_tensors, saved
-0001f700: 5f6f 7468 6572 292c 2063 6f74 616e 6765  _other), cotange
-0001f710: 6e74 730a 2020 2020 290a 2020 2020 6173  nts.    ).    as
-0001f720: 7365 7274 2075 6e70 6163 6b69 6e67 5f74  sert unpacking_t
-0001f730: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
-0001f740: 6c73 5b2d 315d 2e73 796d 2e69 6420 3d3d  ls[-1].sym.id ==
-0001f750: 2070 7269 6d73 2e50 7269 6d49 4473 2e52   prims.PrimIDs.R
-0001f760: 4554 5552 4e0a 0a20 2020 2062 6163 6b77  ETURN..    backw
-0001f770: 6172 645f 7472 6163 652e 6172 6773 203d  ard_trace.args =
-0001f780: 2075 6e70 6163 6b69 6e67 5f74 7261 6365   unpacking_trace
-0001f790: 2e61 7267 730a 2020 2020 6261 636b 7761  .args.    backwa
-0001f7a0: 7264 5f74 7261 6365 5f62 7379 6d73 5f77  rd_trace_bsyms_w
-0001f7b0: 6974 686f 7574 5f75 6e70 6163 6b69 6e67  ithout_unpacking
-0001f7c0: 203d 2028 0a20 2020 2020 2020 2062 7379   = (.        bsy
-0001f7d0: 6d0a 2020 2020 2020 2020 666f 7220 6273  m.        for bs
-0001f7e0: 796d 2069 6e20 6261 636b 7761 7264 5f74  ym in backward_t
-0001f7f0: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
-0001f800: 6c73 0a20 2020 2020 2020 2069 6620 6273  ls.        if bs
-0001f810: 796d 2e73 796d 2e69 640a 2020 2020 2020  ym.sym.id.      
-0001f820: 2020 6e6f 7420 696e 2028 0a20 2020 2020    not in (.     
-0001f830: 2020 2020 2020 2070 7269 6d73 2e50 7269         prims.Pri
-0001f840: 6d49 4473 2e55 4e50 4143 4b5f 454d 5054  mIDs.UNPACK_EMPT
-0001f850: 595f 4449 4354 2c0a 2020 2020 2020 2020  Y_DICT,.        
-0001f860: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-0001f870: 732e 554e 5041 434b 5f4b 4559 2c0a 2020  s.UNPACK_KEY,.  
-0001f880: 2020 2020 2020 2020 2020 7072 696d 732e            prims.
-0001f890: 5072 696d 4944 732e 554e 5041 434b 5f53  PrimIDs.UNPACK_S
-0001f8a0: 4551 5545 4e43 452c 0a20 2020 2020 2020  EQUENCE,.       
-0001f8b0: 2020 2020 2070 7269 6d73 2e50 7269 6d49       prims.PrimI
-0001f8c0: 4473 2e55 4e50 4143 4b5f 5452 4956 4941  Ds.UNPACK_TRIVIA
-0001f8d0: 4c2c 0a20 2020 2020 2020 2029 0a20 2020  L,.        ).   
-0001f8e0: 2029 0a20 2020 2062 6163 6b77 6172 645f   ).    backward_
-0001f8f0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-0001f900: 6f6c 7320 3d20 6c69 7374 2828 2a75 6e70  ols = list((*unp
-0001f910: 6163 6b69 6e67 5f74 7261 6365 2e62 6f75  acking_trace.bou
-0001f920: 6e64 5f73 796d 626f 6c73 5b3a 2d31 5d2c  nd_symbols[:-1],
-0001f930: 202a 6261 636b 7761 7264 5f74 7261 6365   *backward_trace
-0001f940: 5f62 7379 6d73 5f77 6974 686f 7574 5f75  _bsyms_without_u
-0001f950: 6e70 6163 6b69 6e67 2929 0a0a 0a23 204e  npacking))...# N
-0001f960: 4f54 453a 2052 6574 7572 6e69 6e67 206e  OTE: Returning n
-0001f970: 616d 6564 7475 706c 6573 2066 726f 6d20  amedtuples from 
-0001f980: 636f 6d70 696c 6564 2066 756e 6374 696f  compiled functio
-0001f990: 6e73 2064 6f65 736e 2774 2077 6f72 6b2e  ns doesn't work.
-0001f9a0: 2053 6565 3a0a 2320 2241 6c6c 6f77 2072   See:.# "Allow r
-0001f9b0: 6574 7572 6e69 6e67 206e 616d 6564 7475  eturning namedtu
-0001f9c0: 706c 6573 2066 726f 6d20 636f 6d70 696c  ples from compil
-0001f9d0: 6564 2066 756e 6374 696f 6e73 220a 2320  ed functions".# 
-0001f9e0: 4e6f 7465 205b 4772 6164 2066 6f72 7761  Note [Grad forwa
-0001f9f0: 7264 206f 7574 7075 7420 7370 6563 5d0a  rd output spec].
-0001fa00: 2320 4966 2069 7420 6469 6420 776f 726b  # If it did work
-0001fa10: 2069 7420 776f 756c 6420 6265 206e 6963   it would be nic
-0001fa20: 6520 746f 2075 7365 2074 6869 7320 6e61  e to use this na
-0001fa30: 6d65 6474 7570 6c65 0a23 2069 6e73 7465  medtuple.# inste
-0001fa40: 6164 206f 6620 7468 6520 706c 6169 6e20  ad of the plain 
-0001fa50: 7475 706c 6520 6f72 2064 6963 7420 7468  tuple or dict th
-0001fa60: 6174 2077 6527 7265 2075 7369 6e67 206e  at we're using n
-0001fa70: 6f77 2e0a 546f 7263 6841 7574 6f67 7261  ow..TorchAutogra
-0001fa80: 6446 6f72 7761 7264 4461 7461 203d 206e  dForwardData = n
-0001fa90: 616d 6564 7475 706c 6528 0a20 2020 2022  amedtuple(.    "
-0001faa0: 546f 7263 6841 7574 6f67 7261 6446 6f72  TorchAutogradFor
-0001fab0: 7761 7264 4461 7461 222c 0a20 2020 205b  wardData",.    [
-0001fac0: 226f 7574 7075 7422 2c20 2266 6c61 745f  "output", "flat_
-0001fad0: 6172 6773 222c 2022 666c 6174 5f6f 7574  args", "flat_out
-0001fae0: 7075 7422 5d2c 0a29 0a0a 0a64 6566 2066  put"],.)...def f
-0001faf0: 6f72 7761 7264 5f61 6e64 5f62 6163 6b77  orward_and_backw
-0001fb00: 6172 645f 6672 6f6d 5f74 7261 6365 2874  ard_from_trace(t
-0001fb10: 7261 6365 3a20 5472 6163 652c 2074 6f72  race: Trace, tor
-0001fb20: 6368 5f61 7574 6f67 7261 643d 4661 6c73  ch_autograd=Fals
-0001fb30: 6529 202d 3e20 466f 7277 6172 6442 6163  e) -> ForwardBac
-0001fb40: 6b77 6172 6454 7261 6365 733a 0a20 2020  kwardTraces:.   
-0001fb50: 2022 2222 4765 6e65 7261 7465 7320 7468   """Generates th
-0001fb60: 6520 666f 7277 6172 6420 616e 6420 6261  e forward and ba
-0001fb70: 636b 7761 7264 2070 6173 7365 7320 6672  ckward passes fr
-0001fb80: 6f6d 2061 2074 7261 6365 2e0a 0a20 2020  om a trace...   
-0001fb90: 2054 6869 7320 6973 2061 2063 6f6e 7665   This is a conve
-0001fba0: 6e69 656e 6365 2066 756e 6374 696f 6e20  nience function 
-0001fbb0: 7468 6174 2063 6f6d 6269 6e65 7320 7468  that combines th
-0001fbc0: 6520 6675 6e63 7469 6f6e 616c 6974 7920  e functionality 
-0001fbd0: 6f66 0a20 2020 2060 6175 676d 656e 7465  of.    `augmente
-0001fbe0: 645f 666f 7277 6172 645f 7061 7373 6020  d_forward_pass` 
-0001fbf0: 616e 6420 6062 6163 6b77 6172 645f 7061  and `backward_pa
-0001fc00: 7373 602e 2054 6865 206d 6169 6e20 6469  ss`. The main di
-0001fc10: 6666 6572 656e 6365 2069 7320 7468 6174  fference is that
-0001fc20: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
-0001fc30: 6f6e 2064 6f65 7320 6e6f 7420 7265 7175  on does not requ
-0001fc40: 6972 6520 7468 6520 7573 6572 2074 6f20  ire the user to 
-0001fc50: 7072 6f76 6964 6520 6e65 7720 696e 7075  provide new inpu
-0001fc60: 7473 2066 6f72 2074 6865 0a20 2020 2074  ts for the.    t
-0001fc70: 7261 6365 2065 7661 6c75 6174 696f 6e2e  race evaluation.
-0001fc80: 2049 6e73 7465 6164 2069 7420 7573 6573   Instead it uses
-0001fc90: 2074 6865 2069 6e70 7574 7320 7468 6174   the inputs that
-0001fca0: 2077 6572 6520 7573 6564 2074 6f20 636f   were used to co
-0001fcb0: 6e73 7472 7563 740a 2020 2020 7468 6520  nstruct.    the 
-0001fcc0: 7472 6163 652e 0a0a 2020 2020 4172 6773  trace...    Args
-0001fcd0: 3a0a 2020 2020 2020 2020 7472 6163 6520  :.        trace 
-0001fce0: 2854 7261 6365 293a 2054 7261 6365 2074  (Trace): Trace t
-0001fcf0: 6f20 6765 6e65 7261 7465 2074 6865 2066  o generate the f
-0001fd00: 6f72 7761 7264 2061 6e64 2062 6163 6b77  orward and backw
-0001fd10: 6172 6420 7061 7373 6573 2066 726f 6d2e  ard passes from.
-0001fd20: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-0001fd30: 2020 2020 2020 2046 6f72 7761 7264 4261         ForwardBa
-0001fd40: 636b 7761 7264 5472 6163 6573 3a20 4120  ckwardTraces: A 
-0001fd50: 6e61 6d65 6420 7475 706c 6520 636f 6e74  named tuple cont
-0001fd60: 6169 6e69 6e67 2074 6865 2066 6f72 7761  aining the forwa
-0001fd70: 7264 2061 6e64 2062 6163 6b77 6172 640a  rd and backward.
-0001fd80: 2020 2020 2020 2020 2020 2020 7472 6163              trac
-0001fd90: 6573 2e0a 0a20 2020 2045 7861 6d70 6c65  es...    Example
-0001fda0: 3a0a 2020 2020 2020 2020 3e3e 3e20 696d  :.        >>> im
-0001fdb0: 706f 7274 2074 6f72 6368 0a20 2020 2020  port torch.     
-0001fdc0: 2020 203e 3e3e 2066 726f 6d20 7468 756e     >>> from thun
-0001fdd0: 6465 7220 696d 706f 7274 2063 6f6d 7069  der import compi
-0001fde0: 6c65 2c20 6c61 7374 5f74 7261 6365 730a  le, last_traces.
-0001fdf0: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
-0001fe00: 2074 6875 6e64 6572 2e63 6f72 652e 7472   thunder.core.tr
-0001fe10: 616e 7366 6f72 6d73 2069 6d70 6f72 7420  ansforms import 
-0001fe20: 666f 7277 6172 645f 616e 645f 6261 636b  forward_and_back
-0001fe30: 7761 7264 5f66 726f 6d5f 7472 6163 650a  ward_from_trace.
-0001fe40: 2020 2020 2020 2020 3e3e 3e20 6465 6620          >>> def 
-0001fe50: 6628 7829 3a0a 2020 2020 2020 2020 2e2e  f(x):.        ..
-0001fe60: 2e20 2020 2020 7265 7475 726e 2074 6f72  .     return tor
-0001fe70: 6368 2e73 696e 2878 290a 2020 2020 2020  ch.sin(x).      
-0001fe80: 2020 3e3e 3e20 7820 3d20 746f 7263 682e    >>> x = torch.
-0001fe90: 7465 6e73 6f72 2833 2e30 290a 2020 2020  tensor(3.0).    
-0001fea0: 2020 2020 3e3e 3e20 6366 203d 2063 6f6d      >>> cf = com
-0001feb0: 7069 6c65 2866 290a 2020 2020 2020 2020  pile(f).        
-0001fec0: 3e3e 3e20 6f75 7420 3d20 6366 2878 290a  >>> out = cf(x).
-0001fed0: 2020 2020 2020 2020 3e3e 3e20 7472 6163          >>> trac
-0001fee0: 6520 3d20 6c61 7374 5f74 7261 6365 7328  e = last_traces(
-0001fef0: 6366 295b 305d 0a20 2020 2020 2020 203e  cf)[0].        >
-0001ff00: 3e3e 2066 6f72 7761 7264 5f61 6e64 5f62  >> forward_and_b
-0001ff10: 6163 6b77 6172 645f 6672 6f6d 5f74 7261  ackward_from_tra
-0001ff20: 6365 2874 7261 6365 290a 2020 2020 2020  ce(trace).      
-0001ff30: 2020 2e2e 2e20 466f 7277 6172 6442 6163    ... ForwardBac
-0001ff40: 6b77 6172 6454 7261 6365 7328 0a20 2020  kwardTraces(.   
-0001ff50: 2020 2020 202e 2e2e 2066 6f72 7761 7264       ... forward
-0001ff60: 5f74 7261 6365 3d23 2069 6d70 6f72 7420  _trace=# import 
-0001ff70: 7468 756e 6465 7220 6173 2074 6875 6e64  thunder as thund
-0001ff80: 6572 0a20 2020 2020 2020 202e 2e2e 2023  er.        ... #
-0001ff90: 2069 6d70 6f72 7420 7468 756e 6465 722e   import thunder.
-0001ffa0: 636f 7265 2e70 7269 6d73 2061 7320 7072  core.prims as pr
-0001ffb0: 696d 730a 2020 2020 2020 2020 2e2e 2e20  ims.        ... 
-0001ffc0: 696d 706f 7274 2074 6f72 6368 0a20 2020  import torch.   
-0001ffd0: 2020 2020 202e 2e2e 0a20 2020 2020 2020       ....       
-0001ffe0: 202e 2e2e 2040 746f 7263 682e 6e6f 5f67   ... @torch.no_g
-0001fff0: 7261 6428 290a 2020 2020 2020 2020 2e2e  rad().        ..
-00020000: 2e20 6465 6620 6175 676d 656e 7465 645f  . def augmented_
-00020010: 666f 7277 6172 645f 666e 282a 6172 6773  forward_fn(*args
-00020020: 293a 0a20 2020 2020 2020 202e 2e2e 2020  ):.        ...  
-00020030: 2023 2061 7267 733a 2022 436f 6c6c 6563   # args: "Collec
-00020040: 7469 6f6e 2220 3d20 2028 7430 2c29 2020  tion" =  (t0,)  
-00020050: 2874 7269 7669 616c 2075 6e70 6163 6b29  (trivial unpack)
-00020060: 0a20 2020 2020 2020 202e 2e2e 2020 2074  .        ...   t
-00020070: 302c 205c 0a20 2020 2020 2020 202e 2e2e  0, \.        ...
-00020080: 2020 203d 2061 7267 730a 2020 2020 2020     = args.      
-00020090: 2020 2e2e 2e20 2020 7431 203d 2070 7269    ...   t1 = pri
-000200a0: 6d73 2e73 696e 2874 3029 2020 2320 7431  ms.sin(t0)  # t1
-000200b0: 3a20 2263 7075 2066 3332 5b5d 220a 2020  : "cpu f32[]".  
-000200c0: 2020 2020 2020 2e2e 2e20 2020 7265 7475        ...   retu
-000200d0: 726e 2074 312c 2028 7430 2c29 2c0a 2020  rn t1, (t0,),.  
-000200e0: 2020 2020 2020 2e2e 2e20 6261 636b 7761        ... backwa
-000200f0: 7264 5f74 7261 6365 3d23 2069 6d70 6f72  rd_trace=# impor
-00020100: 7420 7468 756e 6465 7220 6173 2074 6875  t thunder as thu
-00020110: 6e64 6572 0a20 2020 2020 2020 202e 2e2e  nder.        ...
-00020120: 2023 2069 6d70 6f72 7420 7468 756e 6465   # import thunde
-00020130: 722e 636f 7265 2e70 7269 6d73 2061 7320  r.core.prims as 
-00020140: 7072 696d 730a 2020 2020 2020 2020 2e2e  prims.        ..
-00020150: 2e20 696d 706f 7274 2074 6f72 6368 0a20  . import torch. 
-00020160: 2020 2020 2020 202e 2e2e 0a20 2020 2020         ....     
-00020170: 2020 202e 2e2e 2040 746f 7263 682e 6e6f     ... @torch.no
-00020180: 5f67 7261 6428 290a 2020 2020 2020 2020  _grad().        
-00020190: 2e2e 2e20 6465 6620 6261 636b 7761 7264  ... def backward
-000201a0: 5f66 6e28 7361 7665 645f 666f 725f 6261  _fn(saved_for_ba
-000201b0: 636b 7761 7264 2c20 636f 7461 6e67 656e  ckward, cotangen
-000201c0: 7473 293a 0a20 2020 2020 2020 202e 2e2e  ts):.        ...
-000201d0: 2020 2023 2073 6176 6564 5f66 6f72 5f62     # saved_for_b
-000201e0: 6163 6b77 6172 643a 2022 436f 6c6c 6563  ackward: "Collec
-000201f0: 7469 6f6e 2220 3d20 2028 7430 2c29 2020  tion" =  (t0,)  
-00020200: 2874 7269 7669 616c 2075 6e70 6163 6b29  (trivial unpack)
-00020210: 0a20 2020 2020 2020 202e 2e2e 2020 2023  .        ...   #
-00020220: 2063 6f74 616e 6765 6e74 733a 2022 6370   cotangents: "cp
-00020230: 7520 6633 325b 5d22 203d 2020 636f 7461  u f32[]" =  cota
-00020240: 6e67 656e 7473 2020 2874 7269 7669 616c  ngents  (trivial
-00020250: 2075 6e70 6163 6b29 0a20 2020 2020 2020   unpack).       
-00020260: 202e 2e2e 2020 2074 302c 205c 0a20 2020   ...   t0, \.   
-00020270: 2020 2020 202e 2e2e 2020 203d 2073 6176       ...   = sav
-00020280: 6564 5f66 6f72 5f62 6163 6b77 6172 640a  ed_for_backward.
-00020290: 2020 2020 2020 2020 2e2e 2e20 2020 7431          ...   t1
-000202a0: 203d 2070 7269 6d73 2e63 6f73 2874 3029   = prims.cos(t0)
-000202b0: 2020 2320 7431 3a20 2263 7075 2066 3332    # t1: "cpu f32
-000202c0: 5b5d 220a 2020 2020 2020 2020 2e2e 2e20  []".        ... 
-000202d0: 2020 7432 203d 2070 7269 6d73 2e6d 756c    t2 = prims.mul
-000202e0: 2863 6f74 616e 6765 6e74 732c 2074 3129  (cotangents, t1)
-000202f0: 2020 2320 7432 3a20 2263 7075 2066 3332    # t2: "cpu f32
-00020300: 5b5d 220a 2020 2020 2020 2020 2e2e 2e20  []".        ... 
-00020310: 2020 7265 7475 726e 2028 7432 2c29 290a    return (t2,)).
-00020320: 2020 2020 2222 220a 0a20 2020 206f 7574      """..    out
-00020330: 7075 745f 7370 6563 203d 204e 6f6e 650a  put_spec = None.
-00020340: 0a20 2020 2064 6566 2061 7567 6d65 6e74  .    def augment
-00020350: 6564 5f66 6f72 7761 7264 5f66 6e28 2a61  ed_forward_fn(*a
-00020360: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
-00020370: 2020 2020 2020 2020 7265 7375 6c74 2c20          result, 
-00020380: 656e 7620 3d20 6175 676d 656e 7465 645f  env = augmented_
-00020390: 666f 7277 6172 645f 7061 7373 282a 6172  forward_pass(*ar
-000203a0: 6773 2c20 7472 6163 653d 7472 6163 652c  gs, trace=trace,
-000203b0: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
-000203c0: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
-000203d0: 6b77 6172 6420 3d20 6465 636f 6e73 7472  kward = deconstr
-000203e0: 7563 745f 666f 7277 6172 645f 656e 765f  uct_forward_env_
-000203f0: 666f 725f 6261 636b 7761 7264 2874 7261  for_backward(tra
-00020400: 6365 2c20 656e 7629 0a20 2020 2020 2020  ce, env).       
-00020410: 2069 6620 746f 7263 685f 6175 746f 6772   if torch_autogr
-00020420: 6164 3a0a 2020 2020 2020 2020 2020 2020  ad:.            
-00020430: 6e6f 6e6c 6f63 616c 206f 7574 7075 745f  nonlocal output_
-00020440: 7370 6563 0a20 2020 2020 2020 2020 2020  spec.           
-00020450: 2066 6c61 745f 6172 6773 2c20 5f20 3d20   flat_args, _ = 
-00020460: 7472 6565 5f66 6c61 7474 656e 2828 6172  tree_flatten((ar
-00020470: 6773 2c20 6b77 6172 6773 2929 0a20 2020  gs, kwargs)).   
-00020480: 2020 2020 2020 2020 2066 6c61 745f 6f75           flat_ou
-00020490: 7470 7574 2c20 6f75 7470 7574 5f73 7065  tput, output_spe
-000204a0: 6320 3d20 7472 6565 5f66 6c61 7474 656e  c = tree_flatten
-000204b0: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
-000204c0: 2020 2020 2066 6c61 745f 6f75 7470 7574       flat_output
-000204d0: 203d 2074 7570 6c65 2866 6c61 745f 6f75   = tuple(flat_ou
-000204e0: 7470 7574 290a 2020 2020 2020 2020 2020  tput).          
-000204f0: 2020 2320 5365 6520 4e6f 7465 205b 4772    # See Note [Gr
-00020500: 6164 2066 6f72 7761 7264 206f 7574 7075  ad forward outpu
-00020510: 7420 7370 6563 5d0a 2020 2020 2020 2020  t spec].        
-00020520: 2020 2020 666f 725f 6175 746f 6772 6164      for_autograd
-00020530: 203d 2054 6f72 6368 4175 746f 6772 6164   = TorchAutograd
-00020540: 466f 7277 6172 6444 6174 6128 0a20 2020  ForwardData(.   
-00020550: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00020560: 756c 742c 0a20 2020 2020 2020 2020 2020  ult,.           
-00020570: 2020 2020 2066 6c61 745f 6172 6773 2c0a       flat_args,.
-00020580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020590: 666c 6174 5f6f 7574 7075 742c 0a20 2020  flat_output,.   
-000205a0: 2020 2020 2020 2020 2029 2e5f 6173 6469           )._asdi
-000205b0: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
-000205c0: 2072 6574 7572 6e20 2866 6f72 5f61 7574   return (for_aut
-000205d0: 6f67 7261 642c 2073 6176 6564 5f66 6f72  ograd, saved_for
-000205e0: 5f62 6163 6b77 6172 6429 0a20 2020 2020  _backward).     
-000205f0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-00020600: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
-00020610: 7761 7264 0a0a 2020 2020 2320 436f 7079  ward..    # Copy
-00020620: 2074 6865 2073 6967 6e61 7475 7265 206f   the signature o
-00020630: 6620 7468 6520 6f72 6967 696e 616c 2066  f the original f
-00020640: 756e 6374 696f 6e20 736f 2074 6861 7420  unction so that 
-00020650: 7468 6520 6172 6775 6d65 6e74 7320 6172  the arguments ar
-00020660: 650a 2020 2020 2320 6e61 6d65 6420 636f  e.    # named co
-00020670: 7272 6563 746c 7920 696e 2074 6865 2061  rrectly in the a
-00020680: 7567 6d65 6e74 6564 2066 6f72 7761 7264  ugmented forward
-00020690: 2070 6173 7320 696e 7374 6561 6420 6f66   pass instead of
-000206a0: 2062 6569 6e67 206e 616d 6564 0a20 2020   being named.   
-000206b0: 2023 2022 6172 6773 2220 616e 6420 226b   # "args" and "k
-000206c0: 7761 7267 7322 2e0a 2020 2020 6175 676d  wargs"..    augm
-000206d0: 656e 7465 645f 666f 7277 6172 645f 666e  ented_forward_fn
-000206e0: 2e5f 5f73 6967 6e61 7475 7265 5f5f 203d  .__signature__ =
-000206f0: 2069 6e73 7065 6374 2e73 6967 6e61 7475   inspect.signatu
-00020700: 7265 2874 7261 6365 2e66 6e20 6f72 2074  re(trace.fn or t
-00020710: 7261 6365 2e70 7974 686f 6e5f 6361 6c6c  race.python_call
-00020720: 6162 6c65 2829 290a 0a20 2020 2064 6566  able())..    def
-00020730: 206f 6e65 735f 6c69 6b65 2878 293a 0a20   ones_like(x):. 
-00020740: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00020750: 616e 6365 2878 2c20 5465 6e73 6f72 5072  ance(x, TensorPr
-00020760: 6f78 7929 3a0a 2020 2020 2020 2020 2020  oxy):.          
-00020770: 2020 7265 7475 726e 2066 756c 6c5f 6c69    return full_li
-00020780: 6b65 2878 2c20 6669 6c6c 5f76 616c 7565  ke(x, fill_value
-00020790: 3d31 290a 2020 2020 2020 2020 656c 6966  =1).        elif
-000207a0: 2069 7369 6e73 7461 6e63 6528 782c 204e   isinstance(x, N
-000207b0: 756d 6265 7250 726f 7879 293a 0a20 2020  umberProxy):.   
-000207c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000207d0: 7479 7065 2878 2e76 616c 7565 2928 3129  type(x.value)(1)
-000207e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000207f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00020800: 6e20 4e6f 6e65 0a0a 2020 2020 666f 7277  n None..    forw
-00020810: 6172 645f 7472 6163 6520 3d20 636f 6e73  ard_trace = cons
-00020820: 7472 7563 745f 7472 6163 6528 2928 6175  truct_trace()(au
-00020830: 676d 656e 7465 645f 666f 7277 6172 645f  gmented_forward_
-00020840: 666e 2c20 2a74 7261 6365 2e61 7267 732c  fn, *trace.args,
-00020850: 202a 2a74 7261 6365 2e6b 7761 7267 7329   **trace.kwargs)
-00020860: 0a20 2020 2023 2057 6520 7365 7420 666f  .    # We set fo
-00020870: 7277 6172 6420 7472 6163 6520 746f 2063  rward trace to c
-00020880: 6f6e 7374 7275 6374 2070 726f 7869 6573  onstruct proxies
-00020890: 2062 6563 6175 7365 2077 6520 6e65 6564   because we need
-000208a0: 2074 6865 7365 2070 726f 7869 6573 2074   these proxies t
-000208b0: 6f0a 2020 2020 2320 6861 7665 2064 6966  o.    # have dif
-000208c0: 6665 7265 6e74 206e 616d 6573 2074 6861  ferent names tha
-000208d0: 6e20 7468 6520 6f6e 6573 2069 6e20 7468  n the ones in th
-000208e0: 6520 666f 7277 6172 6420 7472 6163 652e  e forward trace.
-000208f0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-00020900: 2020 7472 6163 6563 7478 5f74 6f6b 656e    tracectx_token
-00020910: 203d 2073 6574 5f74 7261 6365 6374 7828   = set_tracectx(
-00020920: 666f 7277 6172 645f 7472 6163 6529 0a20  forward_trace). 
-00020930: 2020 2020 2020 2023 2057 6520 646f 6e27         # We don'
-00020940: 7420 7761 6e74 2074 6f20 7265 636f 7264  t want to record
-00020950: 2074 686f 7365 206f 6e65 735f 6c69 6b65   those ones_like
-00020960: 2063 616c 6c73 2069 6e20 7468 6520 666f   calls in the fo
-00020970: 7277 6172 6420 7472 6163 652e 0a20 2020  rward trace..   
-00020980: 2020 2020 2077 6974 6820 6465 7461 6368       with detach
-00020990: 6564 5f74 7261 6365 2829 3a0a 2020 2020  ed_trace():.    
-000209a0: 2020 2020 2020 2020 6966 2074 6f72 6368          if torch
-000209b0: 5f61 7574 6f67 7261 643a 0a20 2020 2020  _autograd:.     
-000209c0: 2020 2020 2020 2020 2020 2023 2049 7427             # It'
-000209d0: 7320 6173 7375 6d65 6420 7468 6174 2066  s assumed that f
-000209e0: 6f72 7761 7264 5f74 7261 6365 2e6f 7574  orward_trace.out
-000209f0: 7075 745b 305d 2069 7320 6120 6469 6374  put[0] is a dict
-00020a00: 2066 726f 6d20 546f 7263 6841 7574 6f67   from TorchAutog
-00020a10: 7261 6446 6f72 7761 7264 4461 7461 0a20  radForwardData. 
-00020a20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00020a30: 6c61 745f 6f75 7470 7574 203d 2066 6f72  lat_output = for
-00020a40: 7761 7264 5f74 7261 6365 2e6f 7574 7075  ward_trace.outpu
-00020a50: 745b 305d 5b22 666c 6174 5f6f 7574 7075  t[0]["flat_outpu
-00020a60: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
-00020a70: 2020 2020 636f 7461 6e67 656e 7473 203d      cotangents =
-00020a80: 2075 7469 6c73 2e73 6571 7565 6e63 6966   utils.sequencif
-00020a90: 7928 7472 6565 5f6d 6170 286c 616d 6264  y(tree_map(lambd
-00020aa0: 6120 763a 206f 6e65 735f 6c69 6b65 2876  a v: ones_like(v
-00020ab0: 292c 2066 6c61 745f 6f75 7470 7574 2929  ), flat_output))
-00020ac0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00020ad0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00020ae0: 2020 2063 6f74 616e 6765 6e74 7320 3d20     cotangents = 
-00020af0: 7574 696c 732e 7365 7175 656e 6369 6679  utils.sequencify
-00020b00: 2874 7265 655f 6d61 7028 6c61 6d62 6461  (tree_map(lambda
-00020b10: 2076 3a20 6f6e 6573 5f6c 696b 6528 7629   v: ones_like(v)
-00020b20: 2c20 7472 6163 652e 6f75 7470 7574 2929  , trace.output))
-00020b30: 0a20 2020 2066 696e 616c 6c79 3a0a 2020  .    finally:.  
-00020b40: 2020 2020 2020 7265 7365 745f 7472 6163        reset_trac
-00020b50: 6563 7478 2874 7261 6365 6374 785f 746f  ectx(tracectx_to
-00020b60: 6b65 6e29 0a0a 2020 2020 6465 6620 6261  ken)..    def ba
-00020b70: 636b 7761 7264 5f66 6e28 7361 7665 645f  ckward_fn(saved_
-00020b80: 666f 725f 6261 636b 7761 7264 2c20 636f  for_backward, co
-00020b90: 7461 6e67 656e 7473 293a 0a20 2020 2020  tangents):.     
-00020ba0: 2020 2065 6e76 203d 2072 6563 6f6e 7374     env = reconst
-00020bb0: 7275 6374 5f66 6f72 7761 7264 5f65 6e76  ruct_forward_env
-00020bc0: 5f66 6f72 5f62 6163 6b77 6172 6428 7472  _for_backward(tr
-00020bd0: 6163 652c 2073 6176 6564 5f66 6f72 5f62  ace, saved_for_b
-00020be0: 6163 6b77 6172 6429 0a20 2020 2020 2020  ackward).       
-00020bf0: 2069 6620 746f 7263 685f 6175 746f 6772   if torch_autogr
-00020c00: 6164 3a0a 2020 2020 2020 2020 2020 2020  ad:.            
-00020c10: 636f 7461 6e67 656e 7473 203d 2074 7265  cotangents = tre
-00020c20: 655f 756e 666c 6174 7465 6e28 636f 7461  e_unflatten(cota
-00020c30: 6e67 656e 7473 2c20 6f75 7470 7574 5f73  ngents, output_s
-00020c40: 7065 6329 0a20 2020 2020 2020 206f 7574  pec).        out
-00020c50: 203d 2062 6163 6b77 6172 645f 7061 7373   = backward_pass
-00020c60: 2865 6e76 2c20 7472 6163 652c 2063 6f74  (env, trace, cot
-00020c70: 616e 6765 6e74 7329 0a20 2020 2020 2020  angents).       
-00020c80: 2069 6620 746f 7263 685f 6175 746f 6772   if torch_autogr
-00020c90: 6164 3a0a 2020 2020 2020 2020 2020 2020  ad:.            
-00020ca0: 676b 7761 7267 7320 3d20 6f75 745b 2d31  gkwargs = out[-1
-00020cb0: 5d20 6966 2069 7369 6e73 7461 6e63 6528  ] if isinstance(
-00020cc0: 6f75 745b 2d31 5d2c 2064 6963 7429 2065  out[-1], dict) e
-00020cd0: 6c73 6520 7b7d 0a20 2020 2020 2020 2020  lse {}.         
-00020ce0: 2020 2067 6172 6773 203d 206f 7574 5b3a     gargs = out[:
-00020cf0: 2d31 5d20 6966 2069 7369 6e73 7461 6e63  -1] if isinstanc
-00020d00: 6528 6f75 745b 2d31 5d2c 2064 6963 7429  e(out[-1], dict)
-00020d10: 2065 6c73 6520 6f75 740a 2020 2020 2020   else out.      
-00020d20: 2020 2020 2020 676b 7761 7267 7320 3d20        gkwargs = 
-00020d30: 7b6b 3a20 676b 7761 7267 732e 6765 7428  {k: gkwargs.get(
-00020d40: 6b2c 204e 6f6e 6529 2066 6f72 206b 2069  k, None) for k i
-00020d50: 6e20 7472 6163 652e 6b77 6172 6773 7d0a  n trace.kwargs}.
-00020d60: 2020 2020 2020 2020 2020 2020 6f75 7420              out 
-00020d70: 3d20 282a 6761 7267 732c 2067 6b77 6172  = (*gargs, gkwar
-00020d80: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00020d90: 6f75 7420 3d20 7472 6565 5f66 6c61 7474  out = tree_flatt
-00020da0: 656e 286f 7574 295b 305d 0a20 2020 2020  en(out)[0].     
-00020db0: 2020 2072 6574 7572 6e20 6f75 740a 0a20     return out.. 
-00020dc0: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
-00020dd0: 6b77 6172 6420 3d20 666f 7277 6172 645f  kward = forward_
-00020de0: 7472 6163 652e 6f75 7470 7574 5b31 5d0a  trace.output[1].
-00020df0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
-00020e00: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
-00020e10: 7261 6365 2872 656e 616d 655f 7072 6f78  race(rename_prox
-00020e20: 6965 733d 4661 6c73 6529 2862 6163 6b77  ies=False)(backw
-00020e30: 6172 645f 666e 2c20 7361 7665 645f 666f  ard_fn, saved_fo
-00020e40: 725f 6261 636b 7761 7264 2c20 636f 7461  r_backward, cota
-00020e50: 6e67 656e 7473 290a 0a20 2020 2023 2057  ngents)..    # W
-00020e60: 6520 6172 6520 646f 6e65 2077 6974 6820  e are done with 
-00020e70: 636f 6e73 7472 7563 7469 6e67 2074 6865  constructing the
-00020e80: 2066 6f72 7761 7264 2061 6e64 2062 6163   forward and bac
-00020e90: 6b77 6172 6420 7061 7373 6573 2061 7420  kward passes at 
-00020ea0: 7468 6973 0a20 2020 2023 2073 7461 6765  this.    # stage
-00020eb0: 2e20 5468 6520 666f 6c6c 6f77 696e 6720  . The following 
-00020ec0: 6973 206e 6f74 2073 7472 6963 746c 7920  is not strictly 
-00020ed0: 6e65 6365 7373 6172 792c 2062 7574 2069  necessary, but i
-00020ee0: 7427 7320 676f 6f64 2074 6f20 6669 6c74  t's good to filt
-00020ef0: 6572 0a20 2020 2023 206f 7574 2074 6865  er.    # out the
-00020f00: 2075 6e75 7365 6420 656c 656d 656e 7473   unused elements
-00020f10: 206f 6620 7468 6520 7361 7665 645f 666f   of the saved_fo
-00020f20: 725f 6261 636b 7761 7264 2061 6e64 2066  r_backward and f
-00020f30: 6c61 7474 656e 2069 7420 666f 7220 6d6f  latten it for mo
-00020f40: 7265 0a20 2020 2023 2063 6f6d 7061 6374  re.    # compact
-00020f50: 2062 6163 6b77 6172 6420 7472 6163 652e   backward trace.
-00020f60: 0a0a 2020 2020 2320 4e6f 7720 7765 2063  ..    # Now we c
-00020f70: 616e 2064 6574 6572 6d69 6e65 2065 7861  an determine exa
-00020f80: 6374 6c79 2077 6861 7427 7320 7573 6564  ctly what's used
-00020f90: 2069 6e20 7468 6520 6261 636b 7761 7264   in the backward
-00020fa0: 2070 6173 7320 6672 6f6d 2074 6865 0a20   pass from the. 
-00020fb0: 2020 2023 2073 6176 6564 5f66 6f72 5f62     # saved_for_b
-00020fc0: 6163 6b77 6172 642e 2057 6520 6361 6e20  ackward. We can 
-00020fd0: 666c 6174 7465 6e20 616e 6420 6669 6c74  flatten and filt
-00020fe0: 6572 2074 6865 2073 6176 6564 5f66 6f72  er the saved_for
-00020ff0: 5f62 6163 6b77 6172 640a 2020 2020 636f  _backward.    co
-00021000: 6e73 756d 6572 7320 3d20 7574 696c 732e  nsumers = utils.
-00021010: 636f 6e73 756d 6572 7328 6261 636b 7761  consumers(backwa
-00021020: 7264 5f74 7261 6365 290a 0a20 2020 2023  rd_trace)..    #
-00021030: 2046 6f72 7761 7264 2773 2061 6e64 2062   Forward's and b
-00021040: 6163 6b77 6172 6427 7320 2273 6176 6564  ackward's "saved
-00021050: 5f66 6f72 5f62 6163 6b77 6172 6422 2061  _for_backward" a
-00021060: 7265 206e 6f74 206e 6563 6573 7361 7269  re not necessari
-00021070: 6c79 2074 6865 2073 616d 650a 2020 2020  ly the same.    
-00021080: 2320 6173 2074 6865 2073 6176 6564 5f66  # as the saved_f
-00021090: 6f72 5f62 6163 6b77 6172 642c 2062 6563  or_backward, bec
-000210a0: 6175 7365 2073 6f6d 6520 6f72 2061 6c6c  ause some or all
-000210b0: 2065 6c65 6d65 6e74 7320 6f66 2074 6865   elements of the
-000210c0: 0a20 2020 2023 2073 6176 6564 5f66 6f72  .    # saved_for
-000210d0: 5f62 6163 6b77 6172 6420 7265 7375 6c74  _backward result
-000210e0: 7320 6d69 6768 7420 6265 2072 652d 7072  s might be re-pr
-000210f0: 6f78 6966 6965 642e 0a20 2020 2062 775f  oxified..    bw_
-00021100: 666c 6174 5f73 6176 6564 5f66 6f72 5f62  flat_saved_for_b
-00021110: 6163 6b77 6172 642c 2073 7065 6320 3d20  ackward, spec = 
-00021120: 7472 6565 5f66 6c61 7474 656e 2862 6163  tree_flatten(bac
-00021130: 6b77 6172 645f 7472 6163 652e 6172 6773  kward_trace.args
-00021140: 5b30 5d29 0a20 2020 2066 775f 666c 6174  [0]).    fw_flat
-00021150: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
-00021160: 6172 642c 205f 203d 2074 7265 655f 666c  ard, _ = tree_fl
-00021170: 6174 7465 6e28 666f 7277 6172 645f 7472  atten(forward_tr
-00021180: 6163 652e 6f75 7470 7574 5b31 5d29 0a20  ace.output[1]). 
-00021190: 2020 2075 7365 645f 6d61 736b 203d 206c     used_mask = l
-000211a0: 6973 7428 6c65 6e28 636f 6e73 756d 6572  ist(len(consumer
-000211b0: 732e 6765 7428 782c 2028 2929 2920 3e20  s.get(x, ())) > 
-000211c0: 3020 666f 7220 7820 696e 2062 775f 666c  0 for x in bw_fl
-000211d0: 6174 5f73 6176 6564 5f66 6f72 5f62 6163  at_saved_for_bac
-000211e0: 6b77 6172 6429 0a0a 2020 2020 2320 446f  kward)..    # Do
-000211f0: 6e27 7420 7573 6520 7468 6520 7361 6d65  n't use the same
-00021200: 2076 6172 6961 626c 6520 7477 6963 6520   variable twice 
-00021210: 696e 2074 6865 2062 6163 6b77 6172 6420  in the backward 
-00021220: 7061 7373 0a20 2020 2073 6565 6e20 3d20  pass.    seen = 
-00021230: 7365 7428 290a 2020 2020 6672 6f6d 2074  set().    from t
-00021240: 6875 6e64 6572 2e63 6f72 652e 7072 6f78  hunder.core.prox
-00021250: 6965 7320 696d 706f 7274 2056 6172 6961  ies import Varia
-00021260: 626c 650a 0a20 2020 2066 6f72 2069 2c20  ble..    for i, 
-00021270: 7820 696e 2065 6e75 6d65 7261 7465 2866  x in enumerate(f
-00021280: 775f 666c 6174 5f73 6176 6564 5f66 6f72  w_flat_saved_for
-00021290: 5f62 6163 6b77 6172 6429 3a0a 2020 2020  _backward):.    
-000212a0: 2020 2020 7820 3d20 7661 7269 6162 6c65      x = variable
-000212b0: 6966 7928 7829 0a20 2020 2020 2020 2069  ify(x).        i
-000212c0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-000212d0: 2878 2c20 5661 7269 6162 6c65 293a 0a20  (x, Variable):. 
-000212e0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-000212f0: 6e75 650a 2020 2020 2020 2020 6966 2078  nue.        if x
-00021300: 2069 6e20 7365 656e 3a0a 2020 2020 2020   in seen:.      
-00021310: 2020 2020 2020 7573 6564 5f6d 6173 6b5b        used_mask[
-00021320: 695d 203d 2046 616c 7365 0a20 2020 2020  i] = False.     
-00021330: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00021340: 2020 2020 2073 6565 6e2e 6164 6428 7829       seen.add(x)
-00021350: 0a0a 2020 2020 6f6e 6c79 5f75 7365 645f  ..    only_used_
-00021360: 6677 5f73 6176 6564 5f66 6f72 5f62 6163  fw_saved_for_bac
-00021370: 6b77 6172 6420 3d20 7475 706c 6528 636f  kward = tuple(co
-00021380: 6d70 7265 7373 2866 775f 666c 6174 5f73  mpress(fw_flat_s
-00021390: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000213a0: 642c 2075 7365 645f 6d61 736b 2929 0a20  d, used_mask)). 
-000213b0: 2020 206f 6e6c 795f 7573 6564 5f62 775f     only_used_bw_
-000213c0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-000213d0: 7264 203d 2074 7570 6c65 2863 6f6d 7072  rd = tuple(compr
-000213e0: 6573 7328 6277 5f66 6c61 745f 7361 7665  ess(bw_flat_save
-000213f0: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
-00021400: 7573 6564 5f6d 6173 6b29 290a 0a20 2020  used_mask))..   
-00021410: 2023 2057 6520 6e65 6564 2074 6f20 7570   # We need to up
-00021420: 6461 7465 2074 6865 2074 7261 6365 7320  date the traces 
-00021430: 7769 7468 2074 6865 206e 6577 2073 6176  with the new sav
-00021440: 6564 5f66 6f72 5f62 6163 6b77 6172 640a  ed_for_backward.
-00021450: 2020 2020 5f75 7064 6174 655f 666f 7277      _update_forw
-00021460: 6172 645f 7769 7468 5f6e 6577 5f73 6176  ard_with_new_sav
-00021470: 6564 5f66 6f72 5f62 6163 6b77 6172 6428  ed_for_backward(
-00021480: 666f 7277 6172 645f 7472 6163 652c 206f  forward_trace, o
-00021490: 6e6c 795f 7573 6564 5f66 775f 7361 7665  nly_used_fw_save
-000214a0: 645f 666f 725f 6261 636b 7761 7264 290a  d_for_backward).
-000214b0: 2020 2020 5f75 7064 6174 655f 6261 636b      _update_back
-000214c0: 7761 7264 5f77 6974 685f 6e65 775f 7361  ward_with_new_sa
-000214d0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-000214e0: 2862 6163 6b77 6172 645f 7472 6163 652c  (backward_trace,
-000214f0: 206f 6e6c 795f 7573 6564 5f62 775f 7361   only_used_bw_sa
-00021500: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-00021510: 290a 2020 2020 666f 7277 6172 645f 7472  ).    forward_tr
-00021520: 6163 652e 7365 745f 7072 6f76 656e 616e  ace.set_provenan
-00021530: 6365 2854 7261 6365 5072 6f76 656e 616e  ce(TraceProvenan
-00021540: 6365 2822 4175 676d 656e 7465 6420 666f  ce("Augmented fo
-00021550: 7277 6172 6420 7061 7373 2229 290a 2020  rward pass")).  
-00021560: 2020 6261 636b 7761 7264 5f74 7261 6365    backward_trace
-00021570: 2e73 6574 5f70 726f 7665 6e61 6e63 6528  .set_provenance(
-00021580: 5472 6163 6550 726f 7665 6e61 6e63 6528  TraceProvenance(
-00021590: 2242 6163 6b77 6172 6420 7061 7373 2229  "Backward pass")
-000215a0: 290a 2020 2020 7265 7475 726e 2046 6f72  ).    return For
-000215b0: 7761 7264 4261 636b 7761 7264 5472 6163  wardBackwardTrac
-000215c0: 6573 2866 6f72 7761 7264 5f74 7261 6365  es(forward_trace
-000215d0: 2c20 6261 636b 7761 7264 5f74 7261 6365  , backward_trace
-000215e0: 290a 0a0a 2320 646f 2077 6520 6861 7070  )...# do we happ
-000215f0: 656e 2074 6f20 7761 6e74 2074 6f20 7265  en to want to re
-00021600: 6769 7374 6572 2060 6c74 6f72 6368 6020  gister `ltorch` 
-00021610: 6f70 7320 7375 6368 2061 7320 606c 746f  ops such as `lto
-00021620: 7263 682e 6c61 7965 725f 6e6f 726d 6020  rch.layer_norm` 
-00021630: 6173 2077 656c 6c3f 0a61 7574 6f63 6173  as well?.autocas
-00021640: 745f 696d 706c 733a 2064 6963 745b 7072  t_impls: dict[pr
-00021650: 696d 732e 5072 696d 4944 732c 2043 616c  ims.PrimIDs, Cal
-00021660: 6c61 626c 655d 203d 207b 7d0a 0a0a 6465  lable] = {}...de
-00021670: 6620 7265 6769 7374 6572 5f61 7574 6f63  f register_autoc
-00021680: 6173 745f 7275 6c65 286f 7029 3a0a 2020  ast_rule(op):.  
-00021690: 2020 6465 6620 6465 636f 7261 746f 7228    def decorator(
-000216a0: 6675 6e63 293a 0a20 2020 2020 2020 2061  func):.        a
-000216b0: 7574 6f63 6173 745f 696d 706c 735b 6f70  utocast_impls[op
-000216c0: 5d20 3d20 6675 6e63 0a20 2020 2020 2020  ] = func.       
-000216d0: 2072 6574 7572 6e20 6675 6e63 0a0a 2020   return func..  
-000216e0: 2020 7265 7475 726e 2064 6563 6f72 6174    return decorat
-000216f0: 6f72 0a0a 0a64 6566 206d 6179 6265 5f64  or...def maybe_d
-00021700: 6f77 6e63 6173 745f 746f 2864 7479 7065  owncast_to(dtype
-00021710: 2c20 6172 6773 293a 0a20 2020 2061 6c6c  , args):.    all
-00021720: 6f77 6564 5f64 6f77 6e63 6173 745f 7479  owed_downcast_ty
-00021730: 7065 7320 3d20 2864 7479 7065 732e 666c  pes = (dtypes.fl
-00021740: 6f61 7431 362c 2064 7479 7065 732e 6266  oat16, dtypes.bf
-00021750: 6c6f 6174 3136 2c20 6474 7970 6573 2e66  loat16, dtypes.f
-00021760: 6c6f 6174 3332 290a 0a20 2020 2064 6566  loat32)..    def
-00021770: 206d 6170 5f66 6e28 6129 3a0a 2020 2020   map_fn(a):.    
-00021780: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00021790: 6528 612c 2054 656e 736f 7250 726f 7879  e(a, TensorProxy
-000217a0: 2920 616e 6420 612e 6474 7970 6520 696e  ) and a.dtype in
-000217b0: 2061 6c6c 6f77 6564 5f64 6f77 6e63 6173   allowed_downcas
-000217c0: 745f 7479 7065 733a 0a20 2020 2020 2020  t_types:.       
-000217d0: 2020 2020 2072 6574 7572 6e20 6d61 7962       return mayb
-000217e0: 655f 636f 6e76 6572 745f 746f 5f64 7479  e_convert_to_dty
-000217f0: 7065 2861 2c20 6474 7970 6529 0a20 2020  pe(a, dtype).   
-00021800: 2020 2020 2072 6574 7572 6e20 610a 0a20       return a.. 
-00021810: 2020 2072 6574 7572 6e20 7472 6565 5f6d     return tree_m
-00021820: 6170 286d 6170 5f66 6e2c 2061 7267 7329  ap(map_fn, args)
-00021830: 0a0a 0a40 7265 6769 7374 6572 5f61 7574  ...@register_aut
-00021840: 6f63 6173 745f 7275 6c65 2822 746f 7263  ocast_rule("torc
-00021850: 682e 6d61 746d 756c 2229 0a40 7265 6769  h.matmul").@regi
-00021860: 7374 6572 5f61 7574 6f63 6173 745f 7275  ster_autocast_ru
-00021870: 6c65 2870 7269 6d73 2e50 7269 6d49 4473  le(prims.PrimIDs
-00021880: 2e4d 4154 4d55 4c29 0a64 6566 2061 7574  .MATMUL).def aut
-00021890: 6f63 6173 745f 6d61 746d 756c 5f72 756c  ocast_matmul_rul
-000218a0: 6528 612c 2062 2c20 6474 7970 6529 3a0a  e(a, b, dtype):.
-000218b0: 2020 2020 2222 2241 7574 6f63 6173 7420      """Autocast 
-000218c0: 7275 6c65 2066 6f72 206d 6174 6d75 6c22  rule for matmul"
-000218d0: 2222 0a20 2020 2072 6574 7572 6e20 7072  "".    return pr
-000218e0: 696d 732e 6d61 746d 756c 282a 286d 6179  ims.matmul(*(may
-000218f0: 6265 5f64 6f77 6e63 6173 745f 746f 2864  be_downcast_to(d
-00021900: 7479 7065 2c20 2861 2c20 6229 2929 290a  type, (a, b)))).
-00021910: 0a0a 4072 6567 6973 7465 725f 6175 746f  ..@register_auto
-00021920: 6361 7374 5f72 756c 6528 2274 6f72 6368  cast_rule("torch
-00021930: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e6c  .nn.functional.l
-00021940: 696e 6561 7222 290a 4072 6567 6973 7465  inear").@registe
-00021950: 725f 6175 746f 6361 7374 5f72 756c 6528  r_autocast_rule(
-00021960: 7072 696d 732e 5072 696d 4944 732e 4c49  prims.PrimIDs.LI
-00021970: 4e45 4152 290a 6465 6620 6175 746f 6361  NEAR).def autoca
-00021980: 7374 5f6c 696e 6561 725f 7275 6c65 2861  st_linear_rule(a
-00021990: 2c20 772c 2062 6961 732c 2064 7479 7065  , w, bias, dtype
-000219a0: 293a 0a20 2020 2069 6620 6269 6173 2069  ):.    if bias i
-000219b0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000219c0: 2320 446f 6e27 7420 7061 7373 2060 6269  # Don't pass `bi
-000219d0: 6173 6020 746f 206d 6179 6265 5f64 6f77  as` to maybe_dow
-000219e0: 6e63 6173 745f 746f 2e0a 2020 2020 2020  ncast_to..      
-000219f0: 2020 646f 776e 6361 7374 5f61 7267 7320    downcast_args 
-00021a00: 3d20 6d61 7962 655f 646f 776e 6361 7374  = maybe_downcast
-00021a10: 5f74 6f28 6474 7970 652c 2028 612c 2077  _to(dtype, (a, w
-00021a20: 2929 202b 2028 6269 6173 2c29 0a20 2020  )) + (bias,).   
-00021a30: 2065 6c73 653a 0a20 2020 2020 2020 2064   else:.        d
-00021a40: 6f77 6e63 6173 745f 6172 6773 203d 206d  owncast_args = m
-00021a50: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
-00021a60: 2864 7479 7065 2c20 2861 2c20 772c 2062  (dtype, (a, w, b
-00021a70: 6961 7329 290a 0a20 2020 2072 6574 7572  ias))..    retur
-00021a80: 6e20 7072 696d 732e 6c69 6e65 6172 282a  n prims.linear(*
-00021a90: 646f 776e 6361 7374 5f61 7267 7329 0a0a  downcast_args)..
-00021aa0: 0a40 7265 6769 7374 6572 5f61 7574 6f63  .@register_autoc
-00021ab0: 6173 745f 7275 6c65 2822 746f 7263 682e  ast_rule("torch.
-00021ac0: 6e6e 2e66 756e 6374 696f 6e61 6c2e 7363  nn.functional.sc
-00021ad0: 616c 6564 5f64 6f74 5f70 726f 6475 6374  aled_dot_product
-00021ae0: 5f61 7474 656e 7469 6f6e 2229 0a64 6566  _attention").def
-00021af0: 2061 7574 6f63 6173 745f 7363 616c 6564   autocast_scaled
-00021b00: 5f64 6f74 5f70 726f 6475 6374 5f61 7474  _dot_product_att
-00021b10: 656e 7469 6f6e 280a 2020 2020 7175 6572  ention(.    quer
-00021b20: 792c 0a20 2020 206b 6579 2c0a 2020 2020  y,.    key,.    
-00021b30: 7661 6c75 652c 0a20 2020 2061 7474 6e5f  value,.    attn_
-00021b40: 6d61 736b 2c0a 2020 2020 6472 6f70 6f75  mask,.    dropou
-00021b50: 745f 702c 0a20 2020 2069 735f 6361 7573  t_p,.    is_caus
-00021b60: 616c 2c0a 2020 2020 2a2c 0a20 2020 2064  al,.    *,.    d
-00021b70: 7479 7065 2c0a 2020 2020 7363 616c 652c  type,.    scale,
-00021b80: 0a29 3a0a 2020 2020 6672 6f6d 2074 6875  .):.    from thu
-00021b90: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
-00021ba0: 7420 7363 616c 6564 5f64 6f74 5f70 726f  t scaled_dot_pro
-00021bb0: 6475 6374 5f61 7474 656e 7469 6f6e 0a0a  duct_attention..
-00021bc0: 2020 2020 712c 206b 2c20 7620 3d20 6d61      q, k, v = ma
-00021bd0: 7962 655f 646f 776e 6361 7374 5f74 6f28  ybe_downcast_to(
-00021be0: 6474 7970 652c 2028 7175 6572 792c 206b  dtype, (query, k
-00021bf0: 6579 2c20 7661 6c75 6529 290a 2020 2020  ey, value)).    
-00021c00: 7265 7475 726e 2073 6361 6c65 645f 646f  return scaled_do
-00021c10: 745f 7072 6f64 7563 745f 6174 7465 6e74  t_product_attent
-00021c20: 696f 6e28 712c 206b 2c20 762c 2061 7474  ion(q, k, v, att
-00021c30: 6e5f 6d61 736b 2c20 6472 6f70 6f75 745f  n_mask, dropout_
-00021c40: 702c 2069 735f 6361 7573 616c 2c20 7363  p, is_causal, sc
-00021c50: 616c 653d 7363 616c 6529 0a0a 0a64 6566  ale=scale)...def
-00021c60: 2061 7574 6f63 6173 745f 7379 6d62 6f6c   autocast_symbol
-00021c70: 5f6d 6170 7065 7228 626f 756e 645f 7379  _mapper(bound_sy
-00021c80: 6d62 6f6c 3a20 426f 756e 6453 796d 626f  mbol: BoundSymbo
-00021c90: 6c49 6e74 6572 6661 6365 2c20 6474 7970  lInterface, dtyp
-00021ca0: 653a 2064 7479 7065 732e 6474 7970 6529  e: dtypes.dtype)
-00021cb0: 3a0a 2020 2020 2222 2252 6574 7572 6e20  :.    """Return 
-00021cc0: 7468 6520 6361 6c6c 6162 6c65 2069 6d70  the callable imp
-00021cd0: 6c65 6d65 6e74 696e 6720 7468 6520 6175  lementing the au
-00021ce0: 746f 6361 7374 2072 756c 6520 666f 7220  tocast rule for 
-00021cf0: 7468 6520 7379 6d62 6f6c 2e0a 0a20 2020  the symbol...   
-00021d00: 2041 7267 733a 0a20 2020 2020 2020 2062   Args:.        b
-00021d10: 6f75 6e64 5f73 796d 626f 6c3a 204d 6170  ound_symbol: Map
-00021d20: 7065 6420 746f 2069 7473 2061 7574 6f63  ped to its autoc
-00021d30: 6173 7420 7275 6c65 2e0a 0a20 2020 2052  ast rule...    R
-00021d40: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00021d50: 4361 6c6c 6162 6c65 3a20 5468 6520 6361  Callable: The ca
-00021d60: 6c6c 6162 6c65 2069 6d70 6c65 6d65 6e74  llable implement
-00021d70: 696e 6720 7468 6520 6175 746f 6361 7374  ing the autocast
-00021d80: 2072 756c 6520 666f 7220 7468 6520 7379   rule for the sy
-00021d90: 6d62 6f6c 2e0a 2020 2020 2222 220a 2020  mbol..    """.  
-00021da0: 2020 6175 746f 6361 7374 5f69 6d70 6c3a    autocast_impl:
-00021db0: 2043 616c 6c61 626c 6520 7c20 4e6f 6e65   Callable | None
-00021dc0: 203d 2061 7574 6f63 6173 745f 696d 706c   = autocast_impl
-00021dd0: 732e 6765 7428 626f 756e 645f 7379 6d62  s.get(bound_symb
-00021de0: 6f6c 2e73 796d 2e69 6429 0a20 2020 2072  ol.sym.id).    r
-00021df0: 6574 7572 6e20 626f 756e 645f 7379 6d62  eturn bound_symb
-00021e00: 6f6c 2e73 796d 2069 6620 6175 746f 6361  ol.sym if autoca
-00021e10: 7374 5f69 6d70 6c20 6973 204e 6f6e 6520  st_impl is None 
-00021e20: 656c 7365 2070 6172 7469 616c 2861 7574  else partial(aut
-00021e30: 6f63 6173 745f 696d 706c 2c20 6474 7970  ocast_impl, dtyp
-00021e40: 653d 6474 7970 6529 0a0a 0a64 6566 2061  e=dtype)...def a
-00021e50: 7574 6f63 6173 7428 6675 6e63 3a20 4361  utocast(func: Ca
-00021e60: 6c6c 6162 6c65 2c20 6474 7970 653a 2064  llable, dtype: d
-00021e70: 7479 7065 732e 6474 7970 6529 3a0a 2020  types.dtype):.  
-00021e80: 2020 2222 2254 7261 6e73 666f 726d 7320    """Transforms 
-00021e90: 6120 6675 6e63 7469 6f6e 2074 6f20 6175  a function to au
-00021ea0: 746f 6361 7374 2063 6572 7461 696e 206f  tocast certain o
-00021eb0: 7065 7261 7469 6f6e 732e 0a0a 2020 2020  perations...    
-00021ec0: 4172 6773 3a0a 2020 2020 2020 2020 6675  Args:.        fu
-00021ed0: 6e63 3a20 5468 6520 6675 6e63 7469 6f6e  nc: The function
-00021ee0: 2074 6f20 6265 2074 7261 6e73 666f 726d   to be transform
-00021ef0: 6564 2e0a 2020 2020 2020 2020 6474 7970  ed..        dtyp
-00021f00: 653a 2054 6865 2064 6174 6120 7479 7065  e: The data type
-00021f10: 2074 6f20 7768 6963 6820 6172 6775 6d65   to which argume
-00021f20: 6e74 7320 6f66 2074 6865 2066 756e 6374  nts of the funct
-00021f30: 696f 6e20 6f72 2073 7562 2066 756e 6374  ion or sub funct
-00021f40: 696f 6e73 2063 6f75 6c64 2067 6574 2063  ions could get c
-00021f50: 6173 7420 6966 0a20 2020 2020 2020 2020  ast if.         
-00021f60: 2020 2074 6865 7920 6172 6520 6064 7479     they are `dty
-00021f70: 7065 732e 666c 6f61 7433 3260 2e0a 0a20  pes.float32`... 
-00021f80: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00021f90: 2020 2020 4361 6c6c 6162 6c65 3a20 5468      Callable: Th
-00021fa0: 6520 7472 616e 7366 6f72 6d65 6420 6675  e transformed fu
-00021fb0: 6e63 7469 6f6e 0a20 2020 2022 2222 0a0a  nction.    """..
-00021fc0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-00021fd0: 7461 6e63 6528 6474 7970 652c 2064 7479  tance(dtype, dty
-00021fe0: 7065 732e 6474 7970 6529 3a0a 2020 2020  pes.dtype):.    
-00021ff0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00022000: 7272 6f72 2866 2260 6474 7970 6560 2069  rror(f"`dtype` i
-00022010: 7320 6578 7065 6374 6564 2074 6f20 6265  s expected to be
-00022020: 2060 7468 756e 6465 722e 6474 7970 652e   `thunder.dtype.
-00022030: 6474 7970 6560 2062 7574 207b 7479 7065  dtype` but {type
-00022040: 2864 7479 7065 297d 2229 0a20 2020 2069  (dtype)}").    i
-00022050: 6620 6474 7970 6520 6e6f 7420 696e 207b  f dtype not in {
-00022060: 6474 7970 6573 2e66 6c6f 6174 3136 2c20  dtypes.float16, 
-00022070: 6474 7970 6573 2e62 666c 6f61 7431 367d  dtypes.bfloat16}
-00022080: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00022090: 5661 6c75 6545 7272 6f72 2866 2260 6474  ValueError(f"`dt
-000220a0: 7970 6560 2069 7320 6578 7065 6374 6564  ype` is expected
-000220b0: 2074 6f20 6265 2065 6974 6865 7220 6074   to be either `t
-000220c0: 6875 6e64 6572 2e66 6c6f 6174 3136 6020  hunder.float16` 
-000220d0: 6f72 2060 7468 756e 6465 722e 6266 6c6f  or `thunder.bflo
-000220e0: 6174 3136 602c 2062 7574 207b 6474 7970  at16`, but {dtyp
-000220f0: 657d 2229 0a0a 2020 2020 4077 7261 7073  e}")..    @wraps
-00022100: 2866 756e 6329 0a20 2020 2064 6566 2077  (func).    def w
-00022110: 7261 7070 6572 282a 6172 6773 2c20 2a2a  rapper(*args, **
-00022120: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-00022130: 2074 7261 6365 203d 2063 6f6e 7374 7275   trace = constru
-00022140: 6374 5f74 7261 6365 2829 2866 756e 632c  ct_trace()(func,
-00022150: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
-00022160: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00022170: 2065 7661 6c5f 7472 6163 6528 7472 6163   eval_trace(trac
-00022180: 652c 202a 6172 6773 2c20 2a2a 6b77 6172  e, *args, **kwar
-00022190: 6773 2c20 7379 6d62 6f6c 5f6d 6170 7065  gs, symbol_mappe
-000221a0: 723d 7061 7274 6961 6c28 6175 746f 6361  r=partial(autoca
-000221b0: 7374 5f73 796d 626f 6c5f 6d61 7070 6572  st_symbol_mapper
-000221c0: 2c20 6474 7970 653d 6474 7970 6529 290a  , dtype=dtype)).
-000221d0: 0a20 2020 2072 6574 7572 6e20 7772 6170  .    return wrap
-000221e0: 7065 720a                                per.
+0000b570: 2020 2020 2067 7261 643a 204e 756d 6265       grad: Numbe
+0000b580: 7220 7c20 5465 6e73 6f72 5072 6f78 7920  r | TensorProxy 
+0000b590: 3d20 6273 796d 2e6f 7574 7075 740a 0a20  = bsym.output.. 
+0000b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5b0: 2020 2076 7072 696d 616c 3a20 5661 7269     vprimal: Vari
+0000b5c0: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
+0000b5d0: 2020 2020 2020 2020 2076 6772 6164 3a20           vgrad: 
+0000b5e0: 5661 7269 6162 6c65 0a20 2020 2020 2020  Variable.       
+0000b5f0: 2020 2020 2020 2020 2020 2020 2076 7072               vpr
+0000b600: 696d 616c 2c20 7667 7261 6420 3d20 7661  imal, vgrad = va
+0000b610: 7269 6162 6c65 6966 7928 7072 696d 616c  riableify(primal
+0000b620: 292c 2076 6172 6961 626c 6569 6679 2867  ), variableify(g
+0000b630: 7261 6429 0a0a 2020 2020 2020 2020 2020  rad)..          
+0000b640: 2020 2020 2020 2020 2020 6163 7475 616c            actual
+0000b650: 5f67 7261 643a 204e 6f6e 6520 7c20 5465  _grad: None | Te
+0000b660: 6e73 6f72 5072 6f78 7920 3d20 7072 696d  nsorProxy = prim
+0000b670: 616c 735f 746f 5f67 696e 7075 745f 6d61  als_to_ginput_ma
+0000b680: 702e 6765 7428 7670 7269 6d61 6c2c 204e  p.get(vprimal, N
+0000b690: 6f6e 6529 0a0a 2020 2020 2020 2020 2020  one)..          
+0000b6a0: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+0000b6b0: 2049 6620 6163 7475 616c 5f67 7261 6420   If actual_grad 
+0000b6c0: 6973 204e 6f6e 6520 7468 656e 2074 6865  is None then the
+0000b6d0: 7265 2773 2061 2067 6574 5f67 7261 6428  re's a get_grad(
+0000b6e0: 2920 7265 7175 6573 7420 666f 7220 6120  ) request for a 
+0000b6f0: 7465 6e73 6f72 2077 6869 6368 0a20 2020  tensor which.   
+0000b700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b710: 2023 2020 2068 6173 206e 6f20 7075 745f   #   has no put_
+0000b720: 6772 6164 2829 2c20 736f 2077 6520 7265  grad(), so we re
+0000b730: 7475 726e 207a 6572 6f73 2066 6f72 2074  turn zeros for t
+0000b740: 6865 2067 7261 640a 2020 2020 2020 2020  he grad.        
+0000b750: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+0000b760: 444f 2052 6576 6973 6974 2074 6869 7320  DO Revisit this 
+0000b770: 2d2d 2063 616e 2077 6520 7265 6d6f 7665  -- can we remove
+0000b780: 2074 6865 7365 2063 6f6d 7075 7461 7469   these computati
+0000b790: 6f6e 732c 206f 7220 7573 6520 6120 7370  ons, or use a sp
+0000b7a0: 6563 6961 6c20 5a65 726f 5465 6e73 6f72  ecial ZeroTensor
+0000b7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b7c0: 2020 2020 2023 2020 2074 6f20 7369 6d70       #   to simp
+0000b7d0: 6c69 6679 2074 6865 6d3f 0a20 2020 2020  lify them?.     
+0000b7e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000b7f0: 6620 6163 7475 616c 5f67 7261 6420 6973  f actual_grad is
+0000b800: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000b810: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000b820: 6374 7561 6c5f 6772 6164 203d 206c 746f  ctual_grad = lto
+0000b830: 7263 682e 7a65 726f 735f 6c69 6b65 2870  rch.zeros_like(p
+0000b840: 7269 6d61 6c29 0a20 2020 2020 2020 2020  rimal).         
+0000b850: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000b860: 7269 6d61 6c73 5f74 6f5f 6769 6e70 7574  rimals_to_ginput
+0000b870: 5f6d 6170 5b76 7072 696d 616c 5d20 3d20  _map[vprimal] = 
+0000b880: 6163 7475 616c 5f67 7261 640a 0a20 2020  actual_grad..   
+0000b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8a0: 2023 2055 7064 6174 6573 2074 6865 2067   # Updates the g
+0000b8b0: 7261 6420 616c 6961 7320 6d61 700a 2020  rad alias map.  
+0000b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8d0: 2020 7661 6374 7561 6c5f 6772 6164 3a20    vactual_grad: 
+0000b8e0: 5661 7269 6162 6c65 203d 2076 6172 6961  Variable = varia
+0000b8f0: 626c 6569 6679 2861 6374 7561 6c5f 6772  bleify(actual_gr
+0000b900: 6164 290a 2020 2020 2020 2020 2020 2020  ad).            
+0000b910: 2020 2020 2020 2020 6966 2076 6163 7475          if vactu
+0000b920: 616c 5f67 7261 6420 213d 2076 6772 6164  al_grad != vgrad
+0000b930: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b940: 2020 2020 2020 2020 2020 7377 6170 6d61            swapma
+0000b950: 705b 7667 7261 645d 203d 2061 6374 7561  p[vgrad] = actua
+0000b960: 6c5f 6772 6164 0a0a 2020 2020 2020 2020  l_grad..        
+0000b970: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+0000b980: 2020 2020 2023 2052 6573 746f 7265 7320       # Restores 
+0000b990: 7363 6f70 650a 2020 2020 2020 2020 2020  scope.          
+0000b9a0: 2020 7265 7365 745f 7472 6163 6563 7478    reset_tracectx
+0000b9b0: 2874 7261 6365 6374 785f 746f 6b29 0a0a  (tracectx_tok)..
+0000b9c0: 2020 2020 2020 2020 2320 4669 6c74 6572          # Filter
+0000b9d0: 7320 7075 745f 6772 6164 2061 6e64 2067  s put_grad and g
+0000b9e0: 6574 5f67 7261 6420 6f70 6572 6174 696f  et_grad operatio
+0000b9f0: 6e73 2061 6e64 2061 7070 6c69 6573 2074  ns and applies t
+0000ba00: 6865 2073 7761 706d 6170 0a20 2020 2020  he swapmap.     
+0000ba10: 2020 2064 6566 205f 6669 6c74 6572 2862     def _filter(b
+0000ba20: 7379 6d3a 2042 6f75 6e64 5379 6d62 6f6c  sym: BoundSymbol
+0000ba30: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+0000ba40: 2020 2020 2020 2069 643a 2048 6173 6861         id: Hasha
+0000ba50: 626c 6520 3d20 6273 796d 2e73 796d 2e69  ble = bsym.sym.i
+0000ba60: 640a 2020 2020 2020 2020 2020 2020 7265  d.            re
+0000ba70: 7475 726e 2069 6420 696e 2028 7069 6473  turn id in (pids
+0000ba80: 2e50 5554 5f47 5241 442c 2070 6964 732e  .PUT_GRAD, pids.
+0000ba90: 4745 545f 4752 4144 290a 0a20 2020 2020  GET_GRAD)..     
+0000baa0: 2020 2067 7261 6474 7263 2e62 6f75 6e64     gradtrc.bound
+0000bab0: 5f73 796d 626f 6c73 203d 205b 0a20 2020  _symbols = [.   
+0000bac0: 2020 2020 2020 2020 2062 7379 6d2e 6672           bsym.fr
+0000bad0: 6f6d 5f62 7379 6d5f 7377 6170 5f70 726f  om_bsym_swap_pro
+0000bae0: 7869 6573 2873 7761 706d 6170 2920 666f  xies(swapmap) fo
+0000baf0: 7220 6273 796d 2069 6e20 6772 6164 7472  r bsym in gradtr
+0000bb00: 632e 626f 756e 645f 7379 6d62 6f6c 7320  c.bound_symbols 
+0000bb10: 6966 206e 6f74 205f 6669 6c74 6572 2862  if not _filter(b
+0000bb20: 7379 6d29 0a20 2020 2020 2020 205d 0a0a  sym).        ]..
+0000bb30: 2020 2020 2020 2020 2320 5354 4550 2046          # STEP F
+0000bb40: 4f55 5220 2d2d 2d20 4f72 6465 7273 2074  OUR --- Orders t
+0000bb50: 6865 206f 7065 7261 7469 6f6e 730a 2020  he operations.  
+0000bb60: 2020 2020 2020 2320 544f 444f 2043 6f6e        # TODO Con
+0000bb70: 7369 6465 7220 616c 7465 726e 6174 6976  sider alternativ
+0000bb80: 6520 7363 6865 6475 6c69 6e67 2061 6c67  e scheduling alg
+0000bb90: 6f72 6974 686d 732c 206d 6179 6265 2062  orithms, maybe b
+0000bba0: 7920 7573 696e 6720 6772 6170 6820 6665  y using graph fe
+0000bbb0: 6174 7572 6573 0a20 2020 2020 2020 2023  atures.        #
+0000bbc0: 2020 2053 6f6d 6520 6964 6561 7320 6172     Some ideas ar
+0000bbd0: 6520 6c6f 6f6b 696e 6720 6174 206d 656d  e looking at mem
+0000bbe0: 6f72 792d 7361 7669 6e67 206e 6f64 6573  ory-saving nodes
+0000bbf0: 2c20 616e 6420 6e6f 6465 7320 7769 7468  , and nodes with
+0000bc00: 2061 2068 6967 6820 696e 2d64 6567 7265   a high in-degre
+0000bc10: 6520 6f72 2068 6967 6820 6f75 742d 6465  e or high out-de
+0000bc20: 6772 6565 0a0a 2020 2020 2020 2020 2320  gree..        # 
+0000bc30: 4372 6561 7465 7320 616e 2069 6e69 7469  Creates an initi
+0000bc40: 616c 2076 616c 6964 206f 7264 6572 696e  al valid orderin
+0000bc50: 6720 746f 2044 4345 2c20 736f 2074 6861  g to DCE, so tha
+0000bc60: 7420 6164 6469 7469 6f6e 616c 206f 7264  t additional ord
+0000bc70: 6572 696e 6720 616e 616c 7973 6973 2064  ering analysis d
+0000bc80: 6f65 736e 2774 206e 6565 6420 746f 2063  oesn't need to c
+0000bc90: 6f6e 7369 6465 7220 616c 6c20 7379 6d62  onsider all symb
+0000bca0: 6f6c 730a 2020 2020 2020 2020 726f 6f74  ols.        root
+0000bcb0: 732c 206c 6561 7665 7320 3d20 6273 796d  s, leaves = bsym
+0000bcc0: 5f6c 6973 745f 746f 5f64 6167 2867 7261  _list_to_dag(gra
+0000bcd0: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
+0000bce0: 6c73 290a 2020 2020 2020 2020 6f72 6465  ls).        orde
+0000bcf0: 7265 645f 6273 796d 7320 3d20 746f 706f  red_bsyms = topo
+0000bd00: 736f 7274 5f62 7379 6d5f 6461 6728 726f  sort_bsym_dag(ro
+0000bd10: 6f74 732c 2054 4f50 4f53 4f52 545f 4f52  ots, TOPOSORT_OR
+0000bd20: 4445 522e 544f 505f 444f 574e 290a 2020  DER.TOP_DOWN).  
+0000bd30: 2020 2020 2020 6772 6164 7472 632e 626f        gradtrc.bo
+0000bd40: 756e 645f 7379 6d62 6f6c 7320 3d20 6f72  und_symbols = or
+0000bd50: 6465 7265 645f 6273 796d 730a 2020 2020  dered_bsyms.    
+0000bd60: 2020 2020 6772 6164 7472 6320 3d20 6463      gradtrc = dc
+0000bd70: 6528 6772 6164 7472 6329 0a0a 2020 2020  e(gradtrc)..    
+0000bd80: 2020 2020 2320 4964 656e 7469 6669 6573      # Identifies
+0000bd90: 2074 6865 206f 7264 6572 206f 6620 426f   the order of Bo
+0000bda0: 756e 6453 796d 626f 6c73 2075 7369 6e67  undSymbols using
+0000bdb0: 2061 2022 4446 5320 616e 6420 6368 6169   a "DFS and chai
+0000bdc0: 6e22 2061 6c67 6f72 6974 686d 0a20 2020  n" algorithm.   
+0000bdd0: 2020 2020 2023 2054 4f44 4f20 456c 6162       # TODO Elab
+0000bde0: 6f72 6174 6520 6f6e 2074 6869 7320 616c  orate on this al
+0000bdf0: 676f 7269 7468 6d20 616e 6420 7468 6520  gorithm and the 
+0000be00: 696d 706c 656d 656e 7461 7469 6f6e 0a20  implementation. 
+0000be10: 2020 2020 2020 2072 6f6f 7473 2c20 6c65         roots, le
+0000be20: 6176 6573 203d 2062 7379 6d5f 6c69 7374  aves = bsym_list
+0000be30: 5f74 6f5f 6461 6728 6772 6164 7472 632e  _to_dag(gradtrc.
+0000be40: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
+0000be50: 2020 2020 2020 2063 6865 636b 280a 2020         check(.  
+0000be60: 2020 2020 2020 2020 2020 6c65 6e28 6c65            len(le
+0000be70: 6176 6573 2920 3d3d 2031 2c0a 2020 2020  aves) == 1,.    
+0000be80: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+0000be90: 6622 4578 7065 6374 6564 206f 6e6c 7920  f"Expected only 
+0000bea0: 6f6e 6520 6c65 6166 206e 6f64 6520 7768  one leaf node wh
+0000beb0: 656e 2073 6f72 7469 6e67 2066 6f72 2067  en sorting for g
+0000bec0: 7261 642c 2066 6f75 6e64 2074 6865 7265  rad, found there
+0000bed0: 2077 6572 6520 7b6c 656e 286c 6561 7665   were {len(leave
+0000bee0: 7329 7d20 6c65 6176 6573 222c 0a20 2020  s)} leaves",.   
+0000bef0: 2020 2020 2029 0a20 2020 2020 2020 2028       ).        (
+0000bf00: 6c65 6166 2c29 203d 206c 6561 7665 730a  leaf,) = leaves.
+0000bf10: 0a20 2020 2020 2020 2023 2043 6f6d 7075  .        # Compu
+0000bf20: 7465 7320 7468 6520 7465 6e73 6f72 206d  tes the tensor m
+0000bf30: 656d 6f72 7920 7573 6564 2062 7920 7468  emory used by th
+0000bf40: 6520 6769 7665 6e20 7079 7472 6565 0a20  e given pytree. 
+0000bf50: 2020 2020 2020 2064 6566 206d 656d 6f72         def memor
+0000bf60: 795f 7573 6564 2870 7974 7265 6529 202d  y_used(pytree) -
+0000bf70: 3e20 696e 743a 0a20 2020 2020 2020 2020  > int:.         
+0000bf80: 2020 206d 656d 6f72 795f 7573 653a 2069     memory_use: i
+0000bf90: 6e74 203d 2030 0a0a 2020 2020 2020 2020  nt = 0..        
+0000bfa0: 2020 2020 6465 6620 636f 756e 745f 6d65      def count_me
+0000bfb0: 6d6f 7279 5f75 7365 2878 293a 0a20 2020  mory_use(x):.   
+0000bfc0: 2020 2020 2020 2020 2020 2020 206e 6f6e               non
+0000bfd0: 6c6f 6361 6c20 6d65 6d6f 7279 5f75 7365  local memory_use
+0000bfe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bff0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
+0000c000: 2c20 5465 6e73 6f72 5072 6f78 7929 3a0a  , TensorProxy):.
+0000c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c020: 2020 2020 6d65 6d6f 7279 5f75 7365 202b      memory_use +
+0000c030: 3d20 782e 6474 7970 652e 5f62 7974 6573  = x.dtype._bytes
+0000c040: 202a 2078 2e6e 756d 656c 0a0a 2020 2020   * x.numel..    
+0000c050: 2020 2020 2020 2020 7472 6565 5f6d 6170          tree_map
+0000c060: 2863 6f75 6e74 5f6d 656d 6f72 795f 7573  (count_memory_us
+0000c070: 652c 2070 7974 7265 6529 0a20 2020 2020  e, pytree).     
+0000c080: 2020 2020 2020 2072 6574 7572 6e20 6d65         return me
+0000c090: 6d6f 7279 5f75 7365 0a0a 2020 2020 2020  mory_use..      
+0000c0a0: 2020 2320 5472 7565 2077 6865 6e20 6120    # True when a 
+0000c0b0: 6e6f 6465 2069 7320 6120 226c 696e 6b22  node is a "link"
+0000c0c0: 202d 2d20 6120 6e6f 6465 2077 6974 6820   -- a node with 
+0000c0d0: 6f6e 6c79 206f 6e65 2063 6869 6c64 2061  only one child a
+0000c0e0: 6e64 2061 7420 6d6f 7374 206f 6e65 2070  nd at most one p
+0000c0f0: 6172 656e 740a 2020 2020 2020 2020 2320  arent.        # 
+0000c100: 2020 436f 6e63 6570 7475 616c 6c79 2074    Conceptually t
+0000c110: 6865 206e 6f64 6520 6973 2061 2022 6c69  he node is a "li
+0000c120: 6e6b 2220 696e 2061 2063 6861 696e 206f  nk" in a chain o
+0000c130: 6620 6e6f 6465 7320 6c69 6b65 2041 202d  f nodes like A -
+0000c140: 3e20 4220 2d3e 2043 0a20 2020 2020 2020  > B -> C.       
+0000c150: 2064 6566 2069 735f 6c69 6e6b 286e 3a20   def is_link(n: 
+0000c160: 4e6f 6465 2920 2d3e 2062 6f6f 6c3a 0a20  Node) -> bool:. 
+0000c170: 2020 2020 2020 2020 2020 205f 6973 5f6c             _is_l
+0000c180: 696e 6b20 3d20 6c65 6e28 6e2e 6368 696c  ink = len(n.chil
+0000c190: 6472 656e 2920 3d3d 2031 2061 6e64 206c  dren) == 1 and l
+0000c1a0: 656e 286e 2e70 6172 656e 7473 2920 3c3d  en(n.parents) <=
+0000c1b0: 2031 0a20 2020 2020 2020 2020 2020 2072   1.            r
+0000c1c0: 6574 7572 6e20 5f69 735f 6c69 6e6b 0a0a  eturn _is_link..
+0000c1d0: 2020 2020 2020 2020 636f 756e 7465 723a          counter:
+0000c1e0: 2069 6e74 203d 2030 0a0a 2020 2020 2020   int = 0..      
+0000c1f0: 2020 6465 6620 5f63 6861 696e 2863 3a20    def _chain(c: 
+0000c200: 6c69 7374 5b4e 6f64 655d 2c20 656e 643a  list[Node], end:
+0000c210: 204e 6f64 6529 202d 3e20 6c69 7374 5b4e   Node) -> list[N
+0000c220: 6f64 655d 3a0a 2020 2020 2020 2020 2020  ode]:.          
+0000c230: 2020 6e6f 6e6c 6f63 616c 2063 6f75 6e74    nonlocal count
+0000c240: 6572 0a0a 2020 2020 2020 2020 2020 2020  er..            
+0000c250: 2320 544f 444f 2045 7870 6572 696d 656e  # TODO Experimen
+0000c260: 7420 7769 7468 206e 6f74 2061 6c77 6179  t with not alway
+0000c270: 7320 6675 7369 6e67 2074 6869 7320 696e  s fusing this in
+0000c280: 746f 2074 6865 2063 6f6e 7375 6d65 7220  to the consumer 
+0000c290: 2d2d 2074 6865 7265 2063 6f75 6c64 2062  -- there could b
+0000c2a0: 6520 616e 0a20 2020 2020 2020 2020 2020  e an.           
+0000c2b0: 2023 2020 2069 6e74 6572 6573 7469 6e67   #   interesting
+0000c2c0: 206d 696e 6375 740a 2020 2020 2020 2020   mincut.        
+0000c2d0: 2020 2020 2320 4e4f 5445 2049 6e20 7468      # NOTE In th
+0000c2e0: 6973 2063 6173 6520 7468 6520 6368 6169  is case the chai
+0000c2f0: 6e20 6361 6e6e 6f74 2062 6520 6578 7465  n cannot be exte
+0000c300: 6e64 6564 2c20 616e 6420 6974 7320 6f72  nded, and its or
+0000c310: 6967 696e 2069 7320 696e 7075 7420 746f  igin is input to
+0000c320: 2074 6865 2066 756e 6374 696f 6e0a 2020   the function.  
+0000c330: 2020 2020 2020 2020 2020 2320 2020 736f            #   so
+0000c340: 2074 6869 7320 6a75 7374 2066 7573 6573   this just fuses
+0000c350: 2069 7420 696e 746f 2074 6865 2063 6f6e   it into the con
+0000c360: 7375 6d65 720a 2020 2020 2020 2020 2020  sumer.          
+0000c370: 2020 6966 206c 656e 2865 6e64 2e70 6172    if len(end.par
+0000c380: 656e 7473 2920 3d3d 2030 3a0a 2020 2020  ents) == 0:.    
+0000c390: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000c3a0: 6e20 696e 2063 3a0a 2020 2020 2020 2020  n in c:.        
+0000c3b0: 2020 2020 2020 2020 2020 2020 6e2e 6e75              n.nu
+0000c3c0: 6d62 6572 203d 2063 6f75 6e74 6572 0a20  mber = counter. 
+0000c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3e0: 2020 2063 6f75 6e74 6572 202b 3d20 310a     counter += 1.
+0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c400: 7265 7475 726e 205b 5d0a 0a20 2020 2020  return []..     
+0000c410: 2020 2020 2020 2023 204e 4f54 4520 6c65         # NOTE le
+0000c420: 6e28 656e 642e 7061 7265 6e74 7329 203d  n(end.parents) =
+0000c430: 3d20 3120 6f6e 2074 6869 7320 7061 7468  = 1 on this path
+0000c440: 0a20 2020 2020 2020 2020 2020 2028 7061  .            (pa
+0000c450: 7265 6e74 2c29 203d 2065 6e64 2e70 6172  rent,) = end.par
+0000c460: 656e 7473 0a0a 2020 2020 2020 2020 2020  ents..          
+0000c470: 2020 2320 4578 7465 6e64 7320 7468 6520    # Extends the 
+0000c480: 6368 6169 6e20 6966 2074 6865 2070 6172  chain if the par
+0000c490: 656e 7420 6973 2061 206c 696e 6b0a 2020  ent is a link.  
+0000c4a0: 2020 2020 2020 2020 2020 6966 2069 735f            if is_
+0000c4b0: 6c69 6e6b 2870 6172 656e 7429 3a0a 2020  link(parent):.  
+0000c4c0: 2020 2020 2020 2020 2020 2020 2020 632e                c.
+0000c4d0: 6170 7065 6e64 2870 6172 656e 7429 0a20  append(parent). 
+0000c4e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000c4f0: 6574 7572 6e20 5f63 6861 696e 2863 2c20  eturn _chain(c, 
+0000c500: 7061 7265 6e74 290a 0a20 2020 2020 2020  parent)..       
+0000c510: 2020 2020 2023 204e 4f54 4520 496e 2074       # NOTE In t
+0000c520: 6869 7320 6361 7365 2074 6865 2063 6861  his case the cha
+0000c530: 696e 2068 6173 2061 2070 6172 656e 7420  in has a parent 
+0000c540: 7468 6174 2069 7320 6e6f 7420 6120 6c69  that is not a li
+0000c550: 6e6b 0a20 2020 2020 2020 2020 2020 2023  nk.            #
+0000c560: 2046 696e 6473 2074 6865 206d 696e 6375   Finds the mincu
+0000c570: 740a 2020 2020 2020 2020 2020 2020 6d69  t.            mi
+0000c580: 6e63 7574 5f69 6478 3a20 696e 7420 3d20  ncut_idx: int = 
+0000c590: 6c65 6e28 6329 0a20 2020 2020 2020 2020  len(c).         
+0000c5a0: 2020 206d 696e 5f6d 656d 6f72 795f 7573     min_memory_us
+0000c5b0: 6167 653a 2069 6e74 203d 206d 656d 6f72  age: int = memor
+0000c5c0: 795f 7573 6564 2870 6172 656e 742e 6273  y_used(parent.bs
+0000c5d0: 796d 2e6f 7574 7075 7429 0a0a 2020 2020  ym.output)..    
+0000c5e0: 2020 2020 2020 2020 666f 7220 6964 782c          for idx,
+0000c5f0: 206e 2069 6e20 656e 756d 6572 6174 6528   n in enumerate(
+0000c600: 6329 3a0a 2020 2020 2020 2020 2020 2020  c):.            
+0000c610: 2020 2020 6d65 6d20 3d20 6d65 6d6f 7279      mem = memory
+0000c620: 5f75 7365 6428 6e2e 6273 796d 2e6f 7574  _used(n.bsym.out
+0000c630: 7075 7429 0a20 2020 2020 2020 2020 2020  put).           
+0000c640: 2020 2020 2069 6620 6d65 6d20 3c20 6d69       if mem < mi
+0000c650: 6e5f 6d65 6d6f 7279 5f75 7361 6765 3a0a  n_memory_usage:.
+0000c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c670: 2020 2020 6d69 6e63 7574 5f69 6478 203d      mincut_idx =
+0000c680: 2069 6478 0a20 2020 2020 2020 2020 2020   idx.           
+0000c690: 2020 2020 2020 2020 206d 696e 5f6d 656d           min_mem
+0000c6a0: 6f72 795f 7573 6167 6520 3d20 6d65 6d0a  ory_usage = mem.
+0000c6b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0000c6c0: 2069 6478 2c20 6e20 696e 2065 6e75 6d65   idx, n in enume
+0000c6d0: 7261 7465 2863 293a 0a20 2020 2020 2020  rate(c):.       
+0000c6e0: 2020 2020 2020 2020 2069 6620 6964 7820           if idx 
+0000c6f0: 3c20 6d69 6e63 7574 5f69 6478 3a0a 2020  < mincut_idx:.  
+0000c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c710: 2020 6e2e 6e75 6d62 6572 203d 2063 6f75    n.number = cou
+0000c720: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
+0000c730: 2020 2020 2020 2020 2063 6f75 6e74 6572           counter
+0000c740: 202b 3d20 310a 0a20 2020 2020 2020 2020   += 1..         
+0000c750: 2020 2023 2052 6574 7572 6e73 2074 6865     # Returns the
+0000c760: 2070 726f 6475 6365 722d 7369 6465 2063   producer-side c
+0000c770: 6861 696e 2063 7574 2069 6620 6974 2065  hain cut if it e
+0000c780: 7869 7374 730a 2020 2020 2020 2020 2020  xists.          
+0000c790: 2020 6966 206d 696e 6375 745f 6964 7820    if mincut_idx 
+0000c7a0: 3c20 6c65 6e28 6329 3a0a 2020 2020 2020  < len(c):.      
+0000c7b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000c7c0: 205b 635b 6d69 6e63 7574 5f69 6478 5d5d   [c[mincut_idx]]
+0000c7d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0000c7e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000c7f0: 2020 2061 7373 6572 7420 6d69 6e63 7574     assert mincut
+0000c800: 5f69 6478 203d 3d20 6c65 6e28 6329 0a20  _idx == len(c). 
+0000c810: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000c820: 6574 7572 6e20 656e 642e 7061 7265 6e74  eturn end.parent
+0000c830: 730a 0a20 2020 2020 2020 2064 6566 2063  s..        def c
+0000c840: 6861 696e 5f6f 7574 286e 3a20 4e6f 6465  hain_out(n: Node
+0000c850: 2c20 7374 6163 6b3a 206c 6973 745b 4e6f  , stack: list[No
+0000c860: 6465 5d29 202d 3e20 4e6f 6e65 3a0a 2020  de]) -> None:.  
+0000c870: 2020 2020 2020 2020 2020 2320 5368 6f72            # Shor
+0000c880: 742d 6369 7263 7569 7473 2069 6620 7468  t-circuits if th
+0000c890: 6520 6f72 6967 696e 616c 206e 6f64 6520  e original node 
+0000c8a0: 6e20 6361 6e6e 6f74 2062 6520 7061 7274  n cannot be part
+0000c8b0: 206f 6620 6120 6368 6169 6e0a 2020 2020   of a chain.    
+0000c8c0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+0000c8d0: 735f 6c69 6e6b 286e 293a 0a20 2020 2020  s_link(n):.     
+0000c8e0: 2020 2020 2020 2020 2020 2073 7461 636b             stack
+0000c8f0: 2e61 7070 656e 6428 6e29 0a20 2020 2020  .append(n).     
+0000c900: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000c910: 6e0a 0a20 2020 2020 2020 2020 2020 2023  n..            #
+0000c920: 204e 4f54 4520 6973 5f6c 696e 6b28 6e29   NOTE is_link(n)
+0000c930: 203d 3d20 5472 7565 0a20 2020 2020 2020   == True.       
+0000c940: 2020 2020 2070 6f73 745f 6368 6169 6e3a       post_chain:
+0000c950: 206c 6973 745b 4e6f 6465 5d20 3d20 5f63   list[Node] = _c
+0000c960: 6861 696e 285b 6e5d 2c20 6e29 0a0a 2020  hain([n], n)..  
+0000c970: 2020 2020 2020 2020 2020 666f 7220 7063            for pc
+0000c980: 2069 6e20 706f 7374 5f63 6861 696e 3a0a   in post_chain:.
+0000c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9a0: 7374 6163 6b2e 6170 7065 6e64 2870 6329  stack.append(pc)
+0000c9b0: 0a0a 2020 2020 2020 2020 7374 6163 6b3a  ..        stack:
+0000c9c0: 206c 6973 745b 4e6f 6465 5d20 3d20 5b6c   list[Node] = [l
+0000c9d0: 6561 665d 0a20 2020 2020 2020 2077 6869  eaf].        whi
+0000c9e0: 6c65 206c 656e 2873 7461 636b 2920 3e20  le len(stack) > 
+0000c9f0: 303a 0a20 2020 2020 2020 2020 2020 206e  0:.            n
+0000ca00: 3a20 4e6f 6465 203d 2073 7461 636b 2e70  : Node = stack.p
+0000ca10: 6f70 2829 0a0a 2020 2020 2020 2020 2020  op()..          
+0000ca20: 2020 6966 206e 2e6e 756d 6265 7220 6973    if n.number is
+0000ca30: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000ca40: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0000ca50: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+0000ca60: 206e 2e6e 756d 6265 7220 3d20 636f 756e   n.number = coun
+0000ca70: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
+0000ca80: 636f 756e 7465 7220 2b3d 2031 0a0a 2020  counter += 1..  
+0000ca90: 2020 2020 2020 2020 2020 666f 7220 7020            for p 
+0000caa0: 696e 206e 2e70 6172 656e 7473 3a0a 2020  in n.parents:.  
+0000cab0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+0000cac0: 6169 6e5f 6f75 7428 702c 2073 7461 636b  ain_out(p, stack
+0000cad0: 290a 0a20 2020 2020 2020 2064 6566 205f  )..        def _
+0000cae0: 7365 6c65 6374 6f72 2865 6c69 6769 626c  selector(eligibl
+0000caf0: 655f 6e6f 6465 733a 206c 6973 745b 4e6f  e_nodes: list[No
+0000cb00: 6465 5d29 202d 3e20 696e 743a 0a20 2020  de]) -> int:.   
+0000cb10: 2020 2020 2020 2020 206d 696e 5f69 6478           min_idx
+0000cb20: 3a20 696e 7420 3d20 300a 2020 2020 2020  : int = 0.      
+0000cb30: 2020 2020 2020 6d69 6e5f 6e75 6d62 6572        min_number
+0000cb40: 3a20 696e 7420 3d20 656c 6967 6962 6c65  : int = eligible
+0000cb50: 5f6e 6f64 6573 5b30 5d2e 6e75 6d62 6572  _nodes[0].number
+0000cb60: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000cb70: 4e4f 5445 2041 6c74 686f 7567 6820 7765  NOTE Although we
+0000cb80: 2776 6520 616c 7265 6164 7920 7072 6f63  've already proc
+0000cb90: 6573 7365 6420 7468 6520 6669 7273 7420  essed the first 
+0000cba0: 656c 656d 656e 7420 6865 7265 2c20 7468  element here, th
+0000cbb0: 6973 2073 7469 6c6c 0a20 2020 2020 2020  is still.       
+0000cbc0: 2020 2020 2023 2020 2065 6e75 6d65 7261       #   enumera
+0000cbd0: 7465 7320 7468 6520 656e 7469 7265 206c  tes the entire l
+0000cbe0: 6973 7420 6320 746f 2061 6c69 676e 2074  ist c to align t
+0000cbf0: 6865 2065 6e75 6d65 7261 7469 6f6e 2069  he enumeration i
+0000cc00: 6478 2070 726f 7065 726c 790a 2020 2020  dx properly.    
+0000cc10: 2020 2020 2020 2020 666f 7220 6964 782c          for idx,
+0000cc20: 206e 2069 6e20 656e 756d 6572 6174 6528   n in enumerate(
+0000cc30: 656c 6967 6962 6c65 5f6e 6f64 6573 293a  eligible_nodes):
+0000cc40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cc50: 2063 6865 636b 286e 2e6e 756d 6265 7220   check(n.number 
+0000cc60: 6973 206e 6f74 204e 6f6e 652c 206c 616d  is not None, lam
+0000cc70: 6264 613a 2066 2245 7870 6563 7465 6420  bda: f"Expected 
+0000cc80: 6561 6368 206e 6f64 6520 746f 2062 6520  each node to be 
+0000cc90: 6e75 6d62 6572 6564 2c20 6275 7420 7b6e  numbered, but {n
+0000cca0: 7d20 7761 7320 6e6f 7422 290a 0a20 2020  } was not")..   
+0000ccb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000ccc0: 6e2e 6e75 6d62 6572 203c 206d 696e 5f6e  n.number < min_n
+0000ccd0: 756d 6265 723a 0a20 2020 2020 2020 2020  umber:.         
+0000cce0: 2020 2020 2020 2020 2020 206d 696e 5f69             min_i
+0000ccf0: 6478 203d 2069 6478 0a20 2020 2020 2020  dx = idx.       
+0000cd00: 2020 2020 2020 2020 2020 2020 206d 696e               min
+0000cd10: 5f6e 756d 6265 7220 3d20 6e2e 6e75 6d62  _number = n.numb
+0000cd20: 6572 0a0a 2020 2020 2020 2020 2020 2020  er..            
+0000cd30: 7265 7475 726e 206d 696e 5f69 6478 0a0a  return min_idx..
+0000cd40: 2020 2020 2020 2020 736f 7274 6564 5f62          sorted_b
+0000cd50: 7379 6d73 203d 2074 6f70 6f73 6f72 745f  syms = toposort_
+0000cd60: 6273 796d 5f64 6167 286c 6561 7665 732c  bsym_dag(leaves,
+0000cd70: 2074 6f70 6f73 6f72 745f 6f72 6465 723d   toposort_order=
+0000cd80: 544f 504f 534f 5254 5f4f 5244 4552 2e42  TOPOSORT_ORDER.B
+0000cd90: 4f54 544f 4d5f 5550 2c20 7365 6c65 6374  OTTOM_UP, select
+0000cda0: 6f72 3d5f 7365 6c65 6374 6f72 290a 2020  or=_selector).  
+0000cdb0: 2020 2020 2020 6772 6164 7472 632e 626f        gradtrc.bo
+0000cdc0: 756e 645f 7379 6d62 6f6c 7320 3d20 736f  und_symbols = so
+0000cdd0: 7274 6564 5f62 7379 6d73 0a20 2020 2020  rted_bsyms.     
+0000cde0: 2020 2067 7261 6474 7263 203d 2064 6365     gradtrc = dce
+0000cdf0: 2867 7261 6474 7263 290a 0a20 2020 2020  (gradtrc)..     
+0000ce00: 2020 2023 2054 4f44 4f20 436f 6e73 6964     # TODO Consid
+0000ce10: 6572 2068 6f77 2074 6f20 6861 6e64 6c65  er how to handle
+0000ce20: 2067 7261 6420 772e 722e 742e 206f 6e6c   grad w.r.t. onl
+0000ce30: 7920 736f 6d65 206f 7574 7075 7473 202d  y some outputs -
+0000ce40: 2d20 7368 6f75 6c64 2061 6c6c 2067 7261  - should all gra
+0000ce50: 640a 2020 2020 2020 2020 2320 2020 6f70  d.        #   op
+0000ce60: 6572 6174 696f 6e73 2075 7369 6e67 2074  erations using t
+0000ce70: 6865 206f 7468 6572 206f 7574 7075 7420  he other output 
+0000ce80: 6265 2072 656d 6f76 6564 3f20 5768 6174  be removed? What
+0000ce90: 206b 696e 6420 6f66 2061 7373 756d 7074   kind of assumpt
+0000cea0: 696f 6e20 646f 6573 2074 6861 740a 2020  ion does that.  
+0000ceb0: 2020 2020 2020 2320 2020 6d61 6b65 2061        #   make a
+0000cec0: 626f 7574 2074 6865 2067 7261 6420 7374  bout the grad st
+0000ced0: 7275 6374 7572 653f 2050 726f 6261 626c  ructure? Probabl
+0000cee0: 7920 736f 6d65 206b 696e 6420 6f66 2069  y some kind of i
+0000cef0: 6e64 6570 656e 6465 6e63 6520 6173 7375  ndependence assu
+0000cf00: 6d70 7469 6f6e 3f20 4172 650a 2020 2020  mption? Are.    
+0000cf10: 2020 2020 2320 2020 7468 6572 6520 7072      #   there pr
+0000cf20: 6163 7469 6361 6c20 6578 616d 706c 6573  actical examples
+0000cf30: 2077 6865 7265 2074 6861 7427 7320 616e   where that's an
+0000cf40: 2069 7373 7565 3f0a 0a20 2020 2020 2020   issue?..       
+0000cf50: 2065 6e64 5f74 696d 655f 6e73 203d 2074   end_time_ns = t
+0000cf60: 696d 652e 7469 6d65 5f6e 7328 290a 2020  ime.time_ns().  
+0000cf70: 2020 2020 2020 656c 6170 7365 645f 7469        elapsed_ti
+0000cf80: 6d65 5f6e 7320 3d20 656e 645f 7469 6d65  me_ns = end_time
+0000cf90: 5f6e 7320 2d20 7374 6172 745f 7469 6d65  _ns - start_time
+0000cfa0: 5f6e 730a 2020 2020 2020 2020 656c 6170  _ns.        elap
+0000cfb0: 7365 645f 7469 6d65 5f6d 696c 6c69 7320  sed_time_millis 
+0000cfc0: 3d20 656c 6170 7365 645f 7469 6d65 5f6e  = elapsed_time_n
+0000cfd0: 7320 2f2f 2031 3030 3030 3030 0a20 2020  s // 1000000.   
+0000cfe0: 2020 2020 2067 7261 6474 7263 2e73 6574       gradtrc.set
+0000cff0: 5f70 726f 7665 6e61 6e63 6528 5472 6163  _provenance(Trac
+0000d000: 6550 726f 7665 6e61 6e63 6528 6622 4772  eProvenance(f"Gr
+0000d010: 6164 2028 746f 6f6b 207b 656c 6170 7365  ad (took {elapse
+0000d020: 645f 7469 6d65 5f6d 696c 6c69 737d 206d  d_time_millis} m
+0000d030: 696c 6c69 7365 636f 6e64 7329 2229 290a  illiseconds)")).
+0000d040: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000d050: 6772 6164 7472 630a 0a20 2020 2023 204e  gradtrc..    # N
+0000d060: 4f54 4520 5468 6973 2069 7320 6120 6b6c  OTE This is a kl
+0000d070: 7564 6765 2074 6f20 696e 6469 6361 7465  udge to indicate
+0000d080: 2074 6861 7420 7765 2073 686f 756c 646e   that we shouldn
+0000d090: 2774 2075 7365 2050 7954 6f72 6368 2773  't use PyTorch's
+0000d0a0: 2061 7574 6f67 7261 6420 6265 6361 7573   autograd becaus
+0000d0b0: 650a 2020 2020 2320 2020 7765 2772 6520  e.    #   we're 
+0000d0c0: 7573 696e 6720 6f75 7220 6f77 6e20 6175  using our own au
+0000d0d0: 746f 6772 6164 2074 7261 6e73 666f 726d  tograd transform
+0000d0e0: 0a20 2020 2063 666e 2e5f 7573 696e 675f  .    cfn._using_
+0000d0f0: 6772 6164 5f74 7261 6e73 666f 726d 203d  grad_transform =
+0000d100: 2054 7275 650a 0a20 2020 2072 6574 7572   True..    retur
+0000d110: 6e20 6164 645f 7472 616e 7366 6f72 6d28  n add_transform(
+0000d120: 6366 6e2c 205f 6772 6164 5f74 7261 6e73  cfn, _grad_trans
+0000d130: 666f 726d 290a 0a0a 6465 6620 6772 6164  form)...def grad
+0000d140: 5f76 3128 0a20 2020 2063 666e 2c0a 2920  _v1(.    cfn,.) 
+0000d150: 2d3e 2043 616c 6c61 626c 653a 0a20 2020  -> Callable:.   
+0000d160: 2064 6566 2067 7261 6428 6675 6e63 293a   def grad(func):
+0000d170: 0a20 2020 2020 2020 2064 6566 2067 7261  .        def gra
+0000d180: 645f 6675 6e63 282a 6172 6773 2c20 2a2a  d_func(*args, **
+0000d190: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+0000d1a0: 2020 2020 205f 2c20 6772 6164 7320 3d20       _, grads = 
+0000d1b0: 7661 6c75 655f 616e 645f 6772 6164 2866  value_and_grad(f
+0000d1c0: 756e 6329 282a 6172 6773 2c20 2a2a 6b77  unc)(*args, **kw
+0000d1d0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
+0000d1e0: 2020 6772 6164 7320 3d20 5b67 2066 6f72    grads = [g for
+0000d1f0: 2067 2069 6e20 6772 6164 7320 6966 2067   g in grads if g
+0000d200: 2069 7320 6e6f 7420 4e6f 6e65 5d0a 2020   is not None].  
+0000d210: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000d220: 2067 7261 6473 0a0a 2020 2020 2020 2020   grads..        
+0000d230: 7265 7475 726e 2067 7261 645f 6675 6e63  return grad_func
+0000d240: 0a0a 2020 2020 6465 6620 5f67 7261 645f  ..    def _grad_
+0000d250: 7472 616e 7366 6f72 6d28 7472 633a 2054  transform(trc: T
+0000d260: 7261 6365 2c20 2a2c 2065 7865 6375 746f  race, *, executo
+0000d270: 7273 5f6c 6973 743a 2053 6571 7565 6e63  rs_list: Sequenc
+0000d280: 655b 416e 795d 2920 2d3e 2054 7261 6365  e[Any]) -> Trace
+0000d290: 3a0a 2020 2020 2020 2020 6772 6164 7472  :.        gradtr
+0000d2a0: 6320 3d20 636f 6e73 7472 7563 745f 7472  c = construct_tr
+0000d2b0: 6163 6528 2928 6772 6164 2874 7263 2e70  ace()(grad(trc.p
+0000d2c0: 7974 686f 6e5f 6361 6c6c 6162 6c65 2829  ython_callable()
+0000d2d0: 292c 202a 7472 632e 6172 6773 2c20 2a2a  ), *trc.args, **
+0000d2e0: 7472 632e 6b77 6172 6773 290a 2020 2020  trc.kwargs).    
+0000d2f0: 2020 2020 7265 7475 726e 2067 7261 6474      return gradt
+0000d300: 7263 0a0a 2020 2020 6366 6e2e 5f75 7369  rc..    cfn._usi
+0000d310: 6e67 5f67 7261 645f 7472 616e 7366 6f72  ng_grad_transfor
+0000d320: 6d20 3d20 5472 7565 0a20 2020 2072 6574  m = True.    ret
+0000d330: 7572 6e20 6164 645f 7472 616e 7366 6f72  urn add_transfor
+0000d340: 6d28 6366 6e2c 205f 6772 6164 5f74 7261  m(cfn, _grad_tra
+0000d350: 6e73 666f 726d 290a 0a0a 636c 6173 7320  nsform)...class 
+0000d360: 5472 616e 7366 6f72 6d73 2845 6e75 6d29  Transforms(Enum)
+0000d370: 3a0a 2020 2020 4964 656e 7469 7479 4f70  :.    IdentityOp
+0000d380: 203d 2061 7574 6f28 290a 2020 2020 566d   = auto().    Vm
+0000d390: 6170 4f70 203d 2061 7574 6f28 290a 2020  apOp = auto().  
+0000d3a0: 2020 4a76 704f 7020 3d20 6175 746f 2829    JvpOp = auto()
+0000d3b0: 0a20 2020 2056 6a70 4f70 203d 2061 7574  .    VjpOp = aut
+0000d3c0: 6f28 290a 0a0a 406c 7275 5f63 6163 6865  o()...@lru_cache
+0000d3d0: 286d 6178 7369 7a65 3d4e 6f6e 6529 0a64  (maxsize=None).d
+0000d3e0: 6566 2073 796d 626f 6c5f 746f 5f65 7661  ef symbol_to_eva
+0000d3f0: 6c28 626f 756e 645f 7379 6d62 6f6c 293a  l(bound_symbol):
+0000d400: 0a20 2020 2022 2222 4d61 7020 6120 426f  .    """Map a Bo
+0000d410: 756e 6453 796d 626f 6c20 746f 2061 2066  undSymbol to a f
+0000d420: 756e 6374 696f 6e20 7468 6174 2065 7661  unction that eva
+0000d430: 6c75 6174 6573 2069 742e 0a0a 2020 2020  luates it...    
+0000d440: 4172 6773 3a0a 2020 2020 2020 2020 626f  Args:.        bo
+0000d450: 756e 645f 7379 6d62 6f6c 3a20 426f 756e  und_symbol: Boun
+0000d460: 6453 796d 626f 6c20 746f 206d 6170 0a20  dSymbol to map. 
+0000d470: 2020 2022 2222 0a20 2020 2023 2053 796d     """.    # Sym
+0000d480: 626f 6c20 6973 2063 616c 6c61 626c 650a  bol is callable.
+0000d490: 2020 2020 7265 7475 726e 2062 6f75 6e64      return bound
+0000d4a0: 5f73 796d 626f 6c2e 7379 6d0a 0a0a 2320  _symbol.sym...# 
+0000d4b0: 544f 444f 3a20 4375 7272 656e 746c 7920  TODO: Currently 
+0000d4c0: 7765 2075 7365 2074 7261 6365 2e61 7267  we use trace.arg
+0000d4d0: 7320 616e 6420 7472 6163 652e 6b77 6172  s and trace.kwar
+0000d4e0: 6773 2074 6f20 6765 7420 7468 6520 6172  gs to get the ar
+0000d4f0: 6775 6d65 6e74 730a 2320 4d61 7962 6520  guments.# Maybe 
+0000d500: 7765 2073 686f 756c 6420 7573 6520 7468  we should use th
+0000d510: 6573 6520 696e 7374 6561 640a 7472 616e  ese instead.tran
+0000d520: 7366 6f72 6d5f 736b 6970 5f6c 6973 7420  sform_skip_list 
+0000d530: 3d20 280a 2020 2020 7072 696d 732e 5072  = (.    prims.Pr
+0000d540: 696d 4944 732e 554e 5041 434b 5f45 4d50  imIDs.UNPACK_EMP
+0000d550: 5459 5f44 4943 542c 0a20 2020 2070 7269  TY_DICT,.    pri
+0000d560: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
+0000d570: 4b5f 4b45 592c 0a20 2020 2070 7269 6d73  K_KEY,.    prims
+0000d580: 2e50 7269 6d49 4473 2e55 4e50 4143 4b5f  .PrimIDs.UNPACK_
+0000d590: 5345 5155 454e 4345 2c0a 2020 2020 7072  SEQUENCE,.    pr
+0000d5a0: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
+0000d5b0: 434b 5f54 5249 5649 414c 2c0a 2020 2020  CK_TRIVIAL,.    
+0000d5c0: 7072 696d 732e 5072 696d 4944 732e 5245  prims.PrimIDs.RE
+0000d5d0: 5455 524e 2c0a 290a 0a0a 6465 6620 6576  TURN,.)...def ev
+0000d5e0: 616c 5f74 7261 6365 2874 7261 6365 2c20  al_trace(trace, 
+0000d5f0: 2a61 7267 732c 2073 796d 626f 6c5f 6d61  *args, symbol_ma
+0000d600: 7070 6572 3d73 796d 626f 6c5f 746f 5f65  pper=symbol_to_e
+0000d610: 7661 6c2c 2077 6974 685f 656e 763d 4661  val, with_env=Fa
+0000d620: 6c73 652c 202a 2a6b 7761 7267 7329 3a0a  lse, **kwargs):.
+0000d630: 2020 2020 2222 2245 7661 6c75 6174 6520      """Evaluate 
+0000d640: 6120 7472 6163 652e 0a0a 2020 2020 4172  a trace...    Ar
+0000d650: 6773 3a0a 2020 2020 2020 2020 7472 6163  gs:.        trac
+0000d660: 653a 2074 7261 6365 2074 6f20 6576 616c  e: trace to eval
+0000d670: 7561 7465 0a20 2020 2020 2020 202a 6172  uate.        *ar
+0000d680: 6773 3a20 6172 6775 6d65 6e74 7320 746f  gs: arguments to
+0000d690: 2065 7661 6c75 6174 6520 7468 6520 7472   evaluate the tr
+0000d6a0: 6163 6520 7769 7468 0a20 2020 2020 2020  ace with.       
+0000d6b0: 2073 796d 626f 6c5f 6d61 7070 6572 3a20   symbol_mapper: 
+0000d6c0: 6675 6e63 7469 6f6e 2074 6861 7420 6d61  function that ma
+0000d6d0: 7073 2061 2073 796d 626f 6c20 746f 2061  ps a symbol to a
+0000d6e0: 2066 756e 6374 696f 6e20 7468 6174 2065   function that e
+0000d6f0: 7661 6c75 6174 6573 2069 740a 2020 2020  valuates it.    
+0000d700: 2020 2020 2a2a 6b77 6172 6773 3a20 6b65      **kwargs: ke
+0000d710: 7977 6f72 6420 6172 6775 6d65 6e74 7320  yword arguments 
+0000d720: 746f 2065 7661 6c75 6174 6520 7468 6520  to evaluate the 
+0000d730: 7472 6163 6520 7769 7468 0a0a 2020 2020  trace with..    
+0000d740: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+0000d750: 2072 6573 756c 7420 6f66 2065 7661 6c75   result of evalu
+0000d760: 6174 696e 6720 7468 6520 7472 6163 650a  ating the trace.
+0000d770: 2020 2020 2222 220a 2020 2020 656e 7620      """.    env 
+0000d780: 3d20 7b7d 0a0a 2020 2020 6465 6620 7265  = {}..    def re
+0000d790: 6164 2878 3a20 5661 7269 6162 6c65 293a  ad(x: Variable):
+0000d7a0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+0000d7b0: 7374 616e 6365 2878 2c20 5661 7269 6162  stance(x, Variab
+0000d7c0: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
+0000d7d0: 2072 6574 7572 6e20 656e 765b 782e 6e61   return env[x.na
+0000d7e0: 6d65 5d0a 2020 2020 2020 2020 656c 7365  me].        else
+0000d7f0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000d800: 7475 726e 2078 0a0a 2020 2020 6465 6620  turn x..    def 
+0000d810: 7772 6974 6528 763a 2056 6172 6961 626c  write(v: Variabl
+0000d820: 652c 2076 616c 3a20 416e 792c 2061 6c6c  e, val: Any, all
+0000d830: 6f77 5f64 7570 6c69 6361 7465 733d 4661  ow_duplicates=Fa
+0000d840: 6c73 6529 202d 3e20 4e6f 6e65 3a0a 2020  lse) -> None:.  
+0000d850: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
+0000d860: 6e73 7461 6e63 6528 762c 2056 6172 6961  nstance(v, Varia
+0000d870: 626c 6529 3a0a 2020 2020 2020 2020 2020  ble):.          
+0000d880: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+0000d890: 2023 2044 7570 6c69 6361 7465 7320 6172   # Duplicates ar
+0000d8a0: 6520 616c 6c6f 7765 6420 616e 6420 6f76  e allowed and ov
+0000d8b0: 6572 7772 6974 7465 6e0a 2020 2020 2020  erwritten.      
+0000d8c0: 2020 6966 2076 2e6e 616d 6520 696e 2065    if v.name in e
+0000d8d0: 6e76 3a0a 2020 2020 2020 2020 2020 2020  nv:.            
+0000d8e0: 6966 2061 6c6c 6f77 5f64 7570 6c69 6361  if allow_duplica
+0000d8f0: 7465 733a 0a20 2020 2020 2020 2020 2020  tes:.           
+0000d900: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0000d910: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0000d920: 6c75 6545 7272 6f72 2866 2256 6172 6961  lueError(f"Varia
+0000d930: 626c 6520 7b76 2e6e 616d 657d 2069 7320  ble {v.name} is 
+0000d940: 6265 696e 6720 6f76 6572 7772 6974 7465  being overwritte
+0000d950: 6e20 7468 6973 2069 7320 6e6f 7420 616c  n this is not al
+0000d960: 6c6f 7765 6422 290a 2020 2020 2020 2020  lowed").        
+0000d970: 656e 765b 762e 6e61 6d65 5d20 3d20 7661  env[v.name] = va
+0000d980: 6c0a 0a20 2020 2073 6166 655f 6d61 705f  l..    safe_map_
+0000d990: 666c 6174 2877 7269 7465 2c20 6c69 7374  flat(write, list
+0000d9a0: 2874 7261 6365 2e61 7267 7329 2c20 6c69  (trace.args), li
+0000d9b0: 7374 2861 7267 7329 290a 2020 2020 7361  st(args)).    sa
+0000d9c0: 6665 5f6d 6170 5f66 6c61 7428 7772 6974  fe_map_flat(writ
+0000d9d0: 652c 206c 6973 7428 7472 6163 652e 6b77  e, list(trace.kw
+0000d9e0: 6172 6773 2e76 616c 7565 7328 2929 2c20  args.values()), 
+0000d9f0: 6c69 7374 286b 7761 7267 732e 7661 6c75  list(kwargs.valu
+0000da00: 6573 2829 2929 0a0a 2020 2020 666f 7220  es()))..    for 
+0000da10: 7379 6d62 6f6c 2069 6e20 7472 6163 652e  symbol in trace.
+0000da20: 626f 756e 645f 7379 6d62 6f6c 733a 0a20  bound_symbols:. 
+0000da30: 2020 2020 2020 2069 6620 7379 6d62 6f6c         if symbol
+0000da40: 2e73 796d 2e69 6420 696e 2074 7261 6e73  .sym.id in trans
+0000da50: 666f 726d 5f73 6b69 705f 6c69 7374 3a0a  form_skip_list:.
+0000da60: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0000da70: 696e 7565 0a20 2020 2020 2020 2061 7267  inue.        arg
+0000da80: 7320 3d20 7472 6565 5f6d 6170 2872 6561  s = tree_map(rea
+0000da90: 642c 2073 796d 626f 6c2e 6172 6773 290a  d, symbol.args).
+0000daa0: 2020 2020 2020 2020 6b77 6172 6773 203d          kwargs =
+0000dab0: 2074 7265 655f 6d61 7028 7265 6164 2c20   tree_map(read, 
+0000dac0: 7379 6d62 6f6c 2e6b 7761 7267 7329 0a20  symbol.kwargs). 
+0000dad0: 2020 2020 2020 2070 7269 6d5f 6675 6e63         prim_func
+0000dae0: 203d 2073 796d 626f 6c5f 6d61 7070 6572   = symbol_mapper
+0000daf0: 2873 796d 626f 6c29 0a20 2020 2020 2020  (symbol).       
+0000db00: 2069 6620 7072 696d 5f66 756e 6320 6973   if prim_func is
+0000db10: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000db20: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+0000db30: 2020 2020 7265 7375 6c74 203d 2070 7269      result = pri
+0000db40: 6d5f 6675 6e63 282a 6172 6773 2c20 2a2a  m_func(*args, **
+0000db50: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+0000db60: 7361 6665 5f6d 6170 5f66 6c61 7428 7772  safe_map_flat(wr
+0000db70: 6974 652c 206c 6973 7428 7365 7175 656e  ite, list(sequen
+0000db80: 6369 6679 2873 796d 626f 6c2e 6f75 7470  cify(symbol.outp
+0000db90: 7574 2929 2c20 6c69 7374 2873 6571 7565  ut)), list(seque
+0000dba0: 6e63 6966 7928 7265 7375 6c74 2929 290a  ncify(result))).
+0000dbb0: 0a20 2020 2069 6620 7769 7468 5f65 6e76  .    if with_env
+0000dbc0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000dbd0: 2074 7265 655f 6d61 7028 7265 6164 2c20   tree_map(read, 
+0000dbe0: 7472 6163 652e 6f75 7470 7574 292c 2065  trace.output), e
+0000dbf0: 6e76 0a0a 2020 2020 7265 7475 726e 2074  nv..    return t
+0000dc00: 7265 655f 6d61 7028 7265 6164 2c20 7472  ree_map(read, tr
+0000dc10: 6163 652e 6f75 7470 7574 290a 0a0a 6465  ace.output)...de
+0000dc20: 6620 5f69 6465 6e74 6974 795f 6361 6c6c  f _identity_call
+0000dc30: 5f6d 6574 6166 756e 6328 2a61 7267 732c  _metafunc(*args,
+0000dc40: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
+0000dc50: 2a6b 7761 7267 7329 3a0a 2020 2020 7769  *kwargs):.    wi
+0000dc60: 7468 2064 6574 6163 6865 645f 7472 6163  th detached_trac
+0000dc70: 6528 293a 0a20 2020 2020 2020 2072 6574  e():.        ret
+0000dc80: 7572 6e20 6576 616c 5f74 7261 6365 2874  urn eval_trace(t
+0000dc90: 7261 6365 2c20 2a61 7267 732c 202a 2a6b  race, *args, **k
+0000dca0: 7761 7267 7329 0a0a 0a69 6465 6e74 6974  wargs)...identit
+0000dcb0: 795f 6361 6c6c 203d 2053 796d 626f 6c28  y_call = Symbol(
+0000dcc0: 6964 3d54 7261 6e73 666f 726d 732e 4964  id=Transforms.Id
+0000dcd0: 656e 7469 7479 4f70 2c20 6e61 6d65 3d22  entityOp, name="
+0000dce0: 6964 656e 7469 7479 5f63 616c 6c22 2c20  identity_call", 
+0000dcf0: 6d65 7461 3d5f 6964 656e 7469 7479 5f63  meta=_identity_c
+0000dd00: 616c 6c5f 6d65 7461 6675 6e63 290a 0a0a  all_metafunc)...
+0000dd10: 6465 6620 6964 656e 7469 7479 2866 756e  def identity(fun
+0000dd20: 6329 3a0a 2020 2020 2222 2249 6465 6e74  c):.    """Ident
+0000dd30: 6974 7920 7472 616e 7366 6f72 6d20 666f  ity transform fo
+0000dd40: 7220 6120 5468 756e 6465 7220 6675 6e63  r a Thunder func
+0000dd50: 7469 6f6e 2e0a 0a20 2020 2041 7267 733a  tion...    Args:
+0000dd60: 0a20 2020 2020 2020 2066 756e 6320 2843  .        func (C
+0000dd70: 616c 6c61 626c 6529 3a20 4120 5468 756e  allable): A Thun
+0000dd80: 6465 7220 6675 6e63 7469 6f6e 2074 6f20  der function to 
+0000dd90: 6265 2074 7261 6e73 666f 726d 6564 2e0a  be transformed..
+0000dda0: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
+0000ddb0: 2077 7261 7070 6572 282a 6172 6773 2c20   wrapper(*args, 
+0000ddc0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+0000ddd0: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
+0000dde0: 7275 6374 5f74 7261 6365 2829 2866 756e  ruct_trace()(fun
+0000ddf0: 632c 202a 6172 6773 2c20 2a2a 6b77 6172  c, *args, **kwar
+0000de00: 6773 290a 2020 2020 2020 2020 7265 7475  gs).        retu
+0000de10: 726e 2069 6465 6e74 6974 795f 6361 6c6c  rn identity_call
+0000de20: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+0000de30: 2c20 7472 6163 653d 7472 6163 6529 0a0a  , trace=trace)..
+0000de40: 2020 2020 7265 7475 726e 2077 7261 7070      return wrapp
+0000de50: 6572 0a0a 0a64 6566 205f 6964 656e 7469  er...def _identi
+0000de60: 7479 5f63 616c 6c5f 7079 746f 7263 6828  ty_call_pytorch(
+0000de70: 2a61 7267 732c 2074 7261 6365 3a20 5472  *args, trace: Tr
+0000de80: 6163 652c 202a 2a6b 7761 7267 7329 3a0a  ace, **kwargs):.
+0000de90: 2020 2020 696d 706f 7274 2074 6f72 6368      import torch
+0000dea0: 0a0a 2020 2020 6465 6620 7379 6d62 6f6c  ..    def symbol
+0000deb0: 5f6d 6170 7065 7228 6f70 293a 0a20 2020  _mapper(op):.   
+0000dec0: 2020 2020 2069 6620 6f70 2e6f 7020 3d3d       if op.op ==
+0000ded0: 2054 7261 6e73 666f 726d 732e 4964 656e   Transforms.Iden
+0000dee0: 7469 7479 4f70 3a0a 2020 2020 2020 2020  tityOp:.        
+0000def0: 2020 2020 7265 7475 726e 205f 6964 656e      return _iden
+0000df00: 7469 7479 5f63 616c 6c5f 7079 746f 7263  tity_call_pytorc
+0000df10: 680a 0a20 2020 2020 2020 2074 6f72 6368  h..        torch
+0000df20: 5f6f 7020 3d20 6f70 735f 746f 5f74 6f72  _op = ops_to_tor
+0000df30: 6368 5f6f 7073 5f6d 6170 5b6f 702e 6f70  ch_ops_map[op.op
+0000df40: 5d0a 2020 2020 2020 2020 6966 2069 7369  ].        if isi
+0000df50: 6e73 7461 6e63 6528 746f 7263 685f 6f70  nstance(torch_op
+0000df60: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
+0000df70: 2020 2020 7265 7475 726e 2067 6574 6174      return getat
+0000df80: 7472 2874 6f72 6368 2c20 746f 7263 685f  tr(torch, torch_
+0000df90: 6f70 2e73 7472 6970 2822 7079 746f 7263  op.strip("pytorc
+0000dfa0: 682e 2229 290a 2020 2020 2020 2020 7265  h.")).        re
+0000dfb0: 7475 726e 2074 6f72 6368 5f6f 700a 0a20  turn torch_op.. 
+0000dfc0: 2020 2077 6974 6820 6465 7461 6368 6564     with detached
+0000dfd0: 5f74 7261 6365 2829 3a0a 2020 2020 2020  _trace():.      
+0000dfe0: 2020 7265 7475 726e 2065 7661 6c5f 7472    return eval_tr
+0000dff0: 6163 6528 7472 6163 652c 202a 6172 6773  ace(trace, *args
+0000e000: 2c20 2a2a 6b77 6172 6773 2c20 7379 6d62  , **kwargs, symb
+0000e010: 6f6c 5f6d 6170 7065 723d 7379 6d62 6f6c  ol_mapper=symbol
+0000e020: 5f6d 6170 7065 7229 0a0a 0a23 2052 6567  _mapper)...# Reg
+0000e030: 6973 7465 7220 7468 6520 6964 656e 7469  ister the identi
+0000e040: 7479 2063 616c 6c20 666f 7220 5079 546f  ty call for PyTo
+0000e050: 7263 6820 6578 6563 7574 6f72 2e0a 2320  rch executor..# 
+0000e060: 6f70 735f 746f 5f74 6f72 6368 5f6f 7073  ops_to_torch_ops
+0000e070: 5f6d 6170 5b54 7261 6e73 666f 726d 732e  _map[Transforms.
+0000e080: 4964 656e 7469 7479 4f70 5d20 3d20 5f69  IdentityOp] = _i
+0000e090: 6465 6e74 6974 795f 6361 6c6c 5f70 7974  dentity_call_pyt
+0000e0a0: 6f72 6368 0a0a 0a23 2056 4d41 5020 7472  orch...# VMAP tr
+0000e0b0: 616e 7366 6f72 6d0a 2320 2d2d 2d2d 2d2d  ansform.# ------
+0000e0c0: 2d2d 2d2d 2d2d 2d0a 0a0a 636c 6173 7320  -------...class 
+0000e0d0: 4e6f 744d 6170 7065 643a 0a20 2020 2022  NotMapped:.    "
+0000e0e0: 2222 5265 7072 6573 656e 7473 2061 206e  ""Represents a n
+0000e0f0: 6f6e 2d62 6174 6368 6564 2064 696d 656e  on-batched dimen
+0000e100: 7369 6f6e 2e22 2222 0a0a 2020 2020 6465  sion."""..    de
+0000e110: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
+0000e120: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000e130: 2022 6e6f 745f 6d61 7070 6564 220a 0a0a   "not_mapped"...
+0000e140: 4064 6174 6163 6c61 7373 2866 726f 7a65  @dataclass(froze
+0000e150: 6e3d 5472 7565 290a 636c 6173 7320 4261  n=True).class Ba
+0000e160: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
+0000e170: 2222 2242 6174 6368 6564 2076 616c 7565  """Batched value
+0000e180: 2066 6f72 2074 6865 2076 6d61 7020 7472   for the vmap tr
+0000e190: 616e 7366 6f72 6d2e 0a0a 2020 2020 4174  ansform...    At
+0000e1a0: 7472 6962 7574 6573 3a0a 2020 2020 2020  tributes:.      
+0000e1b0: 2020 7661 6c75 653a 2042 6174 6368 6564    value: Batched
+0000e1c0: 2076 616c 7565 2e0a 2020 2020 2020 2020   value..        
+0000e1d0: 6261 7463 685f 6469 6d3a 2042 6174 6368  batch_dim: Batch
+0000e1e0: 696e 6720 6469 6d65 6e73 696f 6e20 6f72  ing dimension or
+0000e1f0: 206e 6f74 5f6d 6170 7065 640a 2020 2020   not_mapped.    
+0000e200: 2222 220a 0a20 2020 2076 616c 7565 3a20  """..    value: 
+0000e210: 416e 790a 2020 2020 6261 7463 685f 6469  Any.    batch_di
+0000e220: 6d3a 2069 6e74 207c 204e 6f74 4d61 7070  m: int | NotMapp
+0000e230: 6564 0a0a 2020 2020 6465 6620 5f5f 6974  ed..    def __it
+0000e240: 6572 5f5f 2873 656c 6629 3a0a 2020 2020  er__(self):.    
+0000e250: 2020 2020 7969 656c 6420 7365 6c66 2e76      yield self.v
+0000e260: 616c 7565 0a20 2020 2020 2020 2079 6965  alue.        yie
+0000e270: 6c64 2073 656c 662e 6261 7463 685f 6469  ld self.batch_di
+0000e280: 6d0a 0a0a 6465 6620 7061 6972 5f74 6f5f  m...def pair_to_
+0000e290: 6261 7463 6865 645f 7661 6c75 6528 7061  batched_value(pa
+0000e2a0: 6972 293a 0a20 2020 2022 2222 436f 6e76  ir):.    """Conv
+0000e2b0: 6572 7473 2061 2070 6169 7220 746f 2061  erts a pair to a
+0000e2c0: 2042 6174 6368 6564 5661 6c75 652e 0a0a   BatchedValue...
+0000e2d0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0000e2e0: 2020 7061 6972 2028 5365 7175 656e 6365    pair (Sequence
+0000e2f0: 293a 2050 6169 7220 746f 2063 6f6e 7665  ): Pair to conve
+0000e300: 7274 2e0a 0a20 2020 2052 6574 7572 6e73  rt...    Returns
+0000e310: 3a0a 2020 2020 2020 2020 4261 7463 6865  :.        Batche
+0000e320: 6456 616c 7565 3a20 4261 7463 6865 6456  dValue: BatchedV
+0000e330: 616c 7565 2072 6570 7265 7365 6e74 6174  alue representat
+0000e340: 696f 6e20 6f66 2074 6865 2070 6169 722e  ion of the pair.
+0000e350: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+0000e360: 6973 696e 7374 616e 6365 2870 6169 722c  isinstance(pair,
+0000e370: 2042 6174 6368 6564 5661 6c75 6529 3a0a   BatchedValue):.
+0000e380: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+0000e390: 6169 720a 2020 2020 656c 7365 3a0a 2020  air.    else:.  
+0000e3a0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0000e3b0: 6e73 7461 6e63 6528 7061 6972 2c20 5365  nstance(pair, Se
+0000e3c0: 7175 656e 6365 2920 616e 6420 6c65 6e28  quence) and len(
+0000e3d0: 7061 6972 2920 3d3d 2032 0a20 2020 2020  pair) == 2.     
+0000e3e0: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
+0000e3f0: 6456 616c 7565 282a 7061 6972 290a 0a0a  dValue(*pair)...
+0000e400: 6465 6620 7665 6374 6f72 697a 6564 5f62  def vectorized_b
+0000e410: 6174 6368 6572 2870 7269 6d2c 2061 7869  atcher(prim, axi
+0000e420: 735f 7369 7a65 2c20 6261 7463 6865 645f  s_size, batched_
+0000e430: 7661 6c75 6573 2c20 2a2a 6b77 6172 6773  values, **kwargs
+0000e440: 293a 0a20 2020 2062 6174 6368 5f64 696d  ):.    batch_dim
+0000e450: 203d 2062 6174 6368 6564 5f76 616c 7565   = batched_value
+0000e460: 735b 305d 2e62 6174 6368 5f64 696d 0a20  s[0].batch_dim. 
+0000e470: 2020 2061 7373 6572 7420 616c 6c28 0a20     assert all(. 
+0000e480: 2020 2020 2020 2062 6174 6368 5f64 696d         batch_dim
+0000e490: 203d 3d20 6276 2e62 6174 6368 5f64 696d   == bv.batch_dim
+0000e4a0: 2066 6f72 2062 7620 696e 2062 6174 6368   for bv in batch
+0000e4b0: 6564 5f76 616c 7565 735b 313a 5d0a 2020  ed_values[1:].  
+0000e4c0: 2020 292c 2066 2260 7665 6374 6f72 697a    ), f"`vectoriz
+0000e4d0: 6564 5f62 6174 6368 6572 6020 676f 7420  ed_batcher` got 
+0000e4e0: 6469 6666 6572 656e 7420 6261 7463 6865  different batche
+0000e4f0: 6420 6469 6d65 6e73 696f 6e73 207b 5b62  d dimensions {[b
+0000e500: 762e 6261 7463 685f 6469 6d20 666f 7220  v.batch_dim for 
+0000e510: 6276 2069 6e20 6261 7463 6865 645f 7661  bv in batched_va
+0000e520: 6c75 6573 5d7d 220a 2020 2020 7265 7475  lues]}".    retu
+0000e530: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
+0000e540: 7072 696d 282a 5b62 762e 7661 6c75 6520  prim(*[bv.value 
+0000e550: 666f 7220 6276 2069 6e20 6261 7463 6865  for bv in batche
+0000e560: 645f 7661 6c75 6573 5d2c 202a 2a6b 7761  d_values], **kwa
+0000e570: 7267 7329 2c20 6261 7463 685f 6469 6d29  rgs), batch_dim)
+0000e580: 0a0a 0a6e 6f74 5f6d 6170 7065 6420 3d20  ...not_mapped = 
+0000e590: 4e6f 744d 6170 7065 6428 290a 0a0a 6465  NotMapped()...de
+0000e5a0: 6620 6d6f 7665 6469 6d28 782c 2073 7263  f movedim(x, src
+0000e5b0: 3a20 696e 742c 2064 7374 3a20 696e 7429  : int, dst: int)
+0000e5c0: 3a0a 2020 2020 7065 726d 203d 205b 6920  :.    perm = [i 
+0000e5d0: 666f 7220 6920 696e 2072 616e 6765 2878  for i in range(x
+0000e5e0: 2e6e 6469 6d29 2069 6620 6920 213d 2073  .ndim) if i != s
+0000e5f0: 7263 5d0a 2020 2020 7065 726d 2e69 6e73  rc].    perm.ins
+0000e600: 6572 7428 6473 742c 2073 7263 290a 2020  ert(dst, src).  
+0000e610: 2020 7265 7475 726e 2070 7269 6d73 2e74    return prims.t
+0000e620: 7261 6e73 706f 7365 2878 2c20 7475 706c  ranspose(x, tupl
+0000e630: 6528 7065 726d 2929 0a0a 0a64 6566 206d  e(perm))...def m
+0000e640: 6f76 655f 6261 7463 685f 6469 6d28 6178  ove_batch_dim(ax
+0000e650: 6973 5f73 697a 652c 2073 7263 2c20 6473  is_size, src, ds
+0000e660: 742c 2078 293a 0a20 2020 2069 6620 7372  t, x):.    if sr
+0000e670: 6320 6973 206e 6f74 5f6d 6170 7065 643a  c is not_mapped:
+0000e680: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+0000e690: 7374 616e 6365 2878 2c20 4e75 6d62 6572  stance(x, Number
+0000e6a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0000e6b0: 6574 7572 6e20 780a 2020 2020 2020 2020  eturn x.        
+0000e6c0: 7461 7267 6574 5f73 6861 7065 203d 206c  target_shape = l
+0000e6d0: 6973 7428 782e 7368 6170 6529 0a20 2020  ist(x.shape).   
+0000e6e0: 2020 2020 2074 6172 6765 745f 7368 6170       target_shap
+0000e6f0: 652e 696e 7365 7274 2864 7374 2c20 6178  e.insert(dst, ax
+0000e700: 6973 5f73 697a 6529 0a20 2020 2020 2020  is_size).       
+0000e710: 2062 6361 7374 5f64 696d 7320 3d20 6c69   bcast_dims = li
+0000e720: 7374 2872 616e 6765 286c 656e 2874 6172  st(range(len(tar
+0000e730: 6765 745f 7368 6170 6529 2929 0a20 2020  get_shape))).   
+0000e740: 2020 2020 2062 6361 7374 5f64 696d 732e       bcast_dims.
+0000e750: 706f 7028 6473 7429 0a20 2020 2020 2020  pop(dst).       
+0000e760: 2072 6574 7572 6e20 7072 696d 732e 6272   return prims.br
+0000e770: 6f61 6463 6173 745f 696e 5f64 696d 2878  oadcast_in_dim(x
+0000e780: 2c20 7461 7267 6574 5f73 6861 7065 2c20  , target_shape, 
+0000e790: 6263 6173 745f 6469 6d73 290a 2020 2020  bcast_dims).    
+0000e7a0: 656c 6966 2073 7263 203d 3d20 6473 743a  elif src == dst:
+0000e7b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000e7c0: 780a 2020 2020 656c 7365 3a0a 2020 2020  x.    else:.    
+0000e7d0: 2020 2020 7265 7475 726e 206d 6f76 6564      return moved
+0000e7e0: 696d 2878 2c20 7372 632c 2064 7374 290a  im(x, src, dst).
+0000e7f0: 0a0a 6465 6620 6269 6e61 7279 5f6f 705f  ..def binary_op_
+0000e800: 6261 7463 6869 6e67 5f72 756c 6528 6f70  batching_rule(op
+0000e810: 3a20 7072 696d 732e 5072 696d 4944 732c  : prims.PrimIDs,
+0000e820: 2061 7869 735f 7369 7a65 3a20 696e 742c   axis_size: int,
+0000e830: 2076 616c 735f 696e 3a20 4261 7463 6865   vals_in: Batche
+0000e840: 6456 616c 7565 293a 0a20 2020 2028 2878  dValue):.    ((x
+0000e850: 2c20 785f 6264 696d 292c 2028 792c 2079  , x_bdim), (y, y
+0000e860: 5f62 6469 6d29 2920 3d20 7661 6c73 5f69  _bdim)) = vals_i
+0000e870: 6e0a 2020 2020 6966 2078 5f62 6469 6d20  n.    if x_bdim 
+0000e880: 213d 2079 5f62 6469 6d3a 0a20 2020 2020  != y_bdim:.     
+0000e890: 2020 2069 6620 785f 6264 696d 2069 7320     if x_bdim is 
+0000e8a0: 6e6f 745f 6d61 7070 6564 3a0a 2020 2020  not_mapped:.    
+0000e8b0: 2020 2020 2020 2020 7820 3d20 6d6f 7665          x = move
+0000e8c0: 5f62 6174 6368 5f64 696d 2861 7869 735f  _batch_dim(axis_
+0000e8d0: 7369 7a65 2c20 785f 6264 696d 2c20 795f  size, x_bdim, y_
+0000e8e0: 6264 696d 2c20 7829 0a20 2020 2020 2020  bdim, x).       
+0000e8f0: 2020 2020 2078 5f62 6469 6d20 3d20 795f       x_bdim = y_
+0000e900: 6264 696d 0a20 2020 2020 2020 2065 6c73  bdim.        els
+0000e910: 653a 0a20 2020 2020 2020 2020 2020 2079  e:.            y
+0000e920: 203d 206d 6f76 655f 6261 7463 685f 6469   = move_batch_di
+0000e930: 6d28 6178 6973 5f73 697a 652c 2079 5f62  m(axis_size, y_b
+0000e940: 6469 6d2c 2078 5f62 6469 6d2c 2079 290a  dim, x_bdim, y).
+0000e950: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
+0000e960: 6564 5661 6c75 6528 6f70 2878 2c20 7929  edValue(op(x, y)
+0000e970: 2c20 785f 6264 696d 290a 0a0a 6465 6620  , x_bdim)...def 
+0000e980: 7369 6e5f 766d 6170 2861 7869 735f 7369  sin_vmap(axis_si
+0000e990: 7a65 3a20 696e 742c 2061 3a20 4261 7463  ze: int, a: Batc
+0000e9a0: 6865 6456 616c 7565 2920 2d3e 2042 6174  hedValue) -> Bat
+0000e9b0: 6368 6564 5661 6c75 653a 0a20 2020 2072  chedValue:.    r
+0000e9c0: 6574 7572 6e20 7665 6374 6f72 697a 6564  eturn vectorized
+0000e9d0: 5f62 6174 6368 6572 2870 7269 6d73 2e73  _batcher(prims.s
+0000e9e0: 696e 2c20 6178 6973 5f73 697a 652c 2028  in, axis_size, (
+0000e9f0: 612c 2929 0a0a 0a64 6566 2063 6f73 5f76  a,))...def cos_v
+0000ea00: 6d61 7028 6178 6973 5f73 697a 653a 2069  map(axis_size: i
+0000ea10: 6e74 2c20 613a 2042 6174 6368 6564 5661  nt, a: BatchedVa
+0000ea20: 6c75 6529 202d 3e20 4261 7463 6865 6456  lue) -> BatchedV
+0000ea30: 616c 7565 3a0a 2020 2020 7265 7475 726e  alue:.    return
+0000ea40: 2076 6563 746f 7269 7a65 645f 6261 7463   vectorized_batc
+0000ea50: 6865 7228 7072 696d 732e 636f 732c 2061  her(prims.cos, a
+0000ea60: 7869 735f 7369 7a65 2c20 2861 2c29 290a  xis_size, (a,)).
+0000ea70: 0a0a 6465 6620 6d75 6c5f 766d 6170 2861  ..def mul_vmap(a
+0000ea80: 7869 735f 7369 7a65 3a20 696e 742c 2061  xis_size: int, a
+0000ea90: 3a20 4261 7463 6865 6456 616c 7565 2c20  : BatchedValue, 
+0000eaa0: 623a 2042 6174 6368 6564 5661 6c75 6529  b: BatchedValue)
+0000eab0: 202d 3e20 4261 7463 6865 6456 616c 7565   -> BatchedValue
+0000eac0: 3a0a 2020 2020 7265 7475 726e 2062 696e  :.    return bin
+0000ead0: 6172 795f 6f70 5f62 6174 6368 696e 675f  ary_op_batching_
+0000eae0: 7275 6c65 2870 7269 6d73 2e6d 756c 2c20  rule(prims.mul, 
+0000eaf0: 6178 6973 5f73 697a 652c 2028 612c 2062  axis_size, (a, b
+0000eb00: 2929 0a0a 0a64 6566 2061 6464 5f76 6d61  ))...def add_vma
+0000eb10: 7028 6178 6973 5f73 697a 653a 2069 6e74  p(axis_size: int
+0000eb20: 2c20 613a 2042 6174 6368 6564 5661 6c75  , a: BatchedValu
+0000eb30: 652c 2062 3a20 4261 7463 6865 6456 616c  e, b: BatchedVal
+0000eb40: 7565 2920 2d3e 2042 6174 6368 6564 5661  ue) -> BatchedVa
+0000eb50: 6c75 653a 0a20 2020 2072 6574 7572 6e20  lue:.    return 
+0000eb60: 6269 6e61 7279 5f6f 705f 6261 7463 6869  binary_op_batchi
+0000eb70: 6e67 5f72 756c 6528 7072 696d 732e 6164  ng_rule(prims.ad
+0000eb80: 642c 2061 7869 735f 7369 7a65 2c20 2861  d, axis_size, (a
+0000eb90: 2c20 6229 290a 0a0a 6465 6620 7375 6d5f  , b))...def sum_
+0000eba0: 766d 6170 2861 7869 735f 7369 7a65 3a20  vmap(axis_size: 
+0000ebb0: 696e 742c 2061 3a20 4261 7463 6865 6456  int, a: BatchedV
+0000ebc0: 616c 7565 2c20 6469 6d73 3a20 5365 7175  alue, dims: Sequ
+0000ebd0: 656e 6365 5b69 6e74 5d2c 202a 2a6b 7761  ence[int], **kwa
+0000ebe0: 7267 7329 202d 3e20 4261 7463 6865 6456  rgs) -> BatchedV
+0000ebf0: 616c 7565 3a0a 2020 2020 6264 696d 203d  alue:.    bdim =
+0000ec00: 2061 2e62 6174 6368 5f64 696d 0a20 2020   a.batch_dim.   
+0000ec10: 2023 2054 4f44 4f3a 2072 656d 6f76 6520   # TODO: remove 
+0000ec20: 7468 6973 2077 6865 6e20 6469 6d73 2062  this when dims b
+0000ec30: 6563 6f6d 6573 2061 206d 616e 6461 746f  ecomes a mandato
+0000ec40: 7279 206b 7761 7267 0a20 2020 2069 6620  ry kwarg.    if 
+0000ec50: 6c65 6e28 6469 6d73 2920 3e20 303a 0a20  len(dims) > 0:. 
+0000ec60: 2020 2020 2020 2064 696d 732c 205f 203d         dims, _ =
+0000ec70: 2073 6166 655f 7a69 7028 2a64 696d 7329   safe_zip(*dims)
+0000ec80: 0a20 2020 2064 696d 735f 6265 666f 7265  .    dims_before
+0000ec90: 203d 2074 7570 6c65 2865 6c20 666f 7220   = tuple(el for 
+0000eca0: 656c 2069 6e20 6469 6d73 2069 6620 656c  el in dims if el
+0000ecb0: 203c 2062 6469 6d29 0a20 2020 2064 696d   < bdim).    dim
+0000ecc0: 735f 6166 7465 7220 3d20 7475 706c 6528  s_after = tuple(
+0000ecd0: 656c 202b 2031 2066 6f72 2065 6c20 696e  el + 1 for el in
+0000ece0: 2064 696d 7320 6966 2065 6c20 3e3d 2062   dims if el >= b
+0000ecf0: 6469 6d29 0a20 2020 2062 6174 6368 6564  dim).    batched
+0000ed00: 5f64 696d 7320 3d20 6469 6d73 5f62 6566  _dims = dims_bef
+0000ed10: 6f72 6520 2b20 6469 6d73 5f61 6674 6572  ore + dims_after
+0000ed20: 0a20 2020 2072 6574 7572 6e20 7665 6374  .    return vect
+0000ed30: 6f72 697a 6564 5f62 6174 6368 6572 2870  orized_batcher(p
+0000ed40: 7269 6d73 2e73 756d 2c20 6178 6973 5f73  rims.sum, axis_s
+0000ed50: 697a 652c 2028 612c 292c 2064 696d 733d  ize, (a,), dims=
+0000ed60: 6261 7463 6865 645f 6469 6d73 2c20 2a2a  batched_dims, **
+0000ed70: 6b77 6172 6773 290a 0a0a 2320 544f 444f  kwargs)...# TODO
+0000ed80: 3a20 506c 6561 7365 2074 6573 7420 7468  : Please test th
+0000ed90: 6973 2065 7874 656e 7369 7665 6c79 0a64  is extensively.d
+0000eda0: 6566 2062 726f 6164 6361 7374 5f69 6e5f  ef broadcast_in_
+0000edb0: 6469 6d5f 766d 6170 280a 2020 2020 6178  dim_vmap(.    ax
+0000edc0: 6973 5f73 697a 653a 2069 6e74 2c20 613a  is_size: int, a:
+0000edd0: 2042 6174 6368 6564 5661 6c75 652c 2073   BatchedValue, s
+0000ede0: 6861 7065 3a20 5365 7175 656e 6365 5b42  hape: Sequence[B
+0000edf0: 6174 6368 6564 5661 6c75 655d 2c20 6272  atchedValue], br
+0000ee00: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+0000ee10: 6e73 3a20 5365 7175 656e 6365 5b42 6174  ns: Sequence[Bat
+0000ee20: 6368 6564 5661 6c75 655d 0a29 202d 3e20  chedValue].) -> 
+0000ee30: 4261 7463 6865 6456 616c 7565 3a0a 2020  BatchedValue:.  
+0000ee40: 2020 6264 696d 203d 2061 2e62 6174 6368    bdim = a.batch
+0000ee50: 5f64 696d 0a20 2020 2023 2054 4f44 4f3a  _dim.    # TODO:
+0000ee60: 2072 656d 6f76 6520 7468 6973 2077 6865   remove this whe
+0000ee70: 6e20 7368 6170 6520 616e 6420 6272 6f61  n shape and broa
+0000ee80: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+0000ee90: 2062 6563 6f6d 6520 6d61 6e64 6174 6f72   become mandator
+0000eea0: 7920 6b77 6172 6773 0a20 2020 2073 6861  y kwargs.    sha
+0000eeb0: 7065 2c20 5f20 3d20 7361 6665 5f7a 6970  pe, _ = safe_zip
+0000eec0: 282a 7368 6170 6529 0a20 2020 2069 6620  (*shape).    if 
+0000eed0: 6c65 6e28 6272 6f61 6463 6173 745f 6469  len(broadcast_di
+0000eee0: 6d65 6e73 696f 6e73 2920 3e20 303a 0a20  mensions) > 0:. 
+0000eef0: 2020 2020 2020 2062 726f 6164 6361 7374         broadcast
+0000ef00: 5f64 696d 656e 7369 6f6e 732c 205f 203d  _dimensions, _ =
+0000ef10: 2073 6166 655f 7a69 7028 2a62 726f 6164   safe_zip(*broad
+0000ef20: 6361 7374 5f64 696d 656e 7369 6f6e 7329  cast_dimensions)
+0000ef30: 0a20 2020 2069 6620 6264 696d 2069 7320  .    if bdim is 
+0000ef40: 6e6f 745f 6d61 7070 6564 3a0a 2020 2020  not_mapped:.    
+0000ef50: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
+0000ef60: 6564 5661 6c75 6528 7072 696d 732e 6272  edValue(prims.br
+0000ef70: 6f61 6463 6173 745f 696e 5f64 696d 2861  oadcast_in_dim(a
+0000ef80: 2e76 616c 7565 2c20 7368 6170 652c 2062  .value, shape, b
+0000ef90: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+0000efa0: 6f6e 7329 2c20 6264 696d 290a 2020 2020  ons), bdim).    
+0000efb0: 656c 7365 3a0a 2020 2020 2020 2020 6e65  else:.        ne
+0000efc0: 775f 6264 696d 203d 2062 6469 6d20 2b20  w_bdim = bdim + 
+0000efd0: 7375 6d28 3120 666f 7220 6469 6d20 696e  sum(1 for dim in
+0000efe0: 2062 726f 6164 6361 7374 5f64 696d 656e   broadcast_dimen
+0000eff0: 7369 6f6e 7320 6966 2064 696d 203c 2062  sions if dim < b
+0000f000: 6469 6d29 0a20 2020 2020 2020 206e 6577  dim).        new
+0000f010: 5f73 6861 7065 203d 206c 6973 7428 7368  _shape = list(sh
+0000f020: 6170 6529 0a20 2020 2020 2020 206e 6577  ape).        new
+0000f030: 5f73 6861 7065 2e69 6e73 6572 7428 6e65  _shape.insert(ne
+0000f040: 775f 6264 696d 2c20 6178 6973 5f73 697a  w_bdim, axis_siz
+0000f050: 6529 0a20 2020 2020 2020 206e 6577 5f62  e).        new_b
+0000f060: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+0000f070: 6f6e 7320 3d20 2830 2c29 202b 2074 7570  ons = (0,) + tup
+0000f080: 6c65 2864 696d 202b 2031 2069 6620 6469  le(dim + 1 if di
+0000f090: 6d20 3e3d 2062 6469 6d20 656c 7365 2064  m >= bdim else d
+0000f0a0: 696d 2066 6f72 2064 696d 2069 6e20 6272  im for dim in br
+0000f0b0: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+0000f0c0: 6e73 290a 2020 2020 2020 2020 6966 2062  ns).        if b
+0000f0d0: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+0000f0e0: 6f6e 7320 3d3d 2028 293a 0a20 2020 2020  ons == ():.     
+0000f0f0: 2020 2020 2020 206e 6577 5f62 726f 6164         new_broad
+0000f100: 6361 7374 5f64 696d 656e 7369 6f6e 7320  cast_dimensions 
+0000f110: 3d20 2829 0a20 2020 2020 2020 2072 6574  = ().        ret
+0000f120: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
+0000f130: 2870 7269 6d73 2e62 726f 6164 6361 7374  (prims.broadcast
+0000f140: 5f69 6e5f 6469 6d28 612e 7661 6c75 652c  _in_dim(a.value,
+0000f150: 206e 6577 5f73 6861 7065 2c20 6e65 775f   new_shape, new_
+0000f160: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+0000f170: 696f 6e73 292c 206e 6577 5f62 6469 6d29  ions), new_bdim)
+0000f180: 0a0a 0a76 6d61 705f 696d 706c 733a 2064  ...vmap_impls: d
+0000f190: 6963 745b 7072 696d 732e 5379 6d62 6f6c  ict[prims.Symbol
+0000f1a0: 2c20 4361 6c6c 6162 6c65 5d20 3d20 6469  , Callable] = di
+0000f1b0: 6374 2829 0a0a 0a64 6566 2075 6e77 7261  ct()...def unwra
+0000f1c0: 705f 6f6e 655f 6c65 7665 6c5f 6f66 5f73  p_one_level_of_s
+0000f1d0: 7562 7379 6d62 6f6c 7328 7472 6163 6529  ubsymbols(trace)
+0000f1e0: 3a0a 2020 2020 6e65 775f 7379 6d62 6f6c  :.    new_symbol
+0000f1f0: 735f 6974 6572 203d 2028 0a20 2020 2020  s_iter = (.     
+0000f200: 2020 2062 6f75 6e64 5f73 796d 626f 6c2e     bound_symbol.
+0000f210: 7375 6273 796d 626f 6c73 2069 6620 6c65  subsymbols if le
+0000f220: 6e28 626f 756e 645f 7379 6d62 6f6c 2e73  n(bound_symbol.s
+0000f230: 7562 7379 6d62 6f6c 7329 203e 2030 2065  ubsymbols) > 0 e
+0000f240: 6c73 6520 5b62 6f75 6e64 5f73 796d 626f  lse [bound_symbo
+0000f250: 6c5d 0a20 2020 2020 2020 2066 6f72 2062  l].        for b
+0000f260: 6f75 6e64 5f73 796d 626f 6c20 696e 2074  ound_symbol in t
+0000f270: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+0000f280: 6c73 0a20 2020 2029 0a20 2020 206e 6577  ls.    ).    new
+0000f290: 5f73 796d 626f 6c73 203d 206c 6973 7428  _symbols = list(
+0000f2a0: 6368 6169 6e2e 6672 6f6d 5f69 7465 7261  chain.from_itera
+0000f2b0: 626c 6528 6e65 775f 7379 6d62 6f6c 735f  ble(new_symbols_
+0000f2c0: 6974 6572 2929 0a20 2020 2074 7261 6365  iter)).    trace
+0000f2d0: 2e62 6f75 6e64 5f73 796d 626f 6c73 203d  .bound_symbols =
+0000f2e0: 206e 6577 5f73 796d 626f 6c73 0a20 2020   new_symbols.   
+0000f2f0: 2072 6574 7572 6e20 7472 6163 650a 0a0a   return trace...
+0000f300: 6465 6620 6465 636f 6d70 6f73 6564 5f66  def decomposed_f
+0000f310: 6e5f 766d 6170 5f72 756c 6528 6178 6973  n_vmap_rule(axis
+0000f320: 5f73 697a 652c 202a 6172 6773 2c20 666e  _size, *args, fn
+0000f330: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+0000f340: 2061 7267 732c 2069 6e5f 6469 6d73 203d   args, in_dims =
+0000f350: 2075 6e7a 6970 3228 6172 6773 290a 2020   unzip2(args).  
+0000f360: 2020 756e 6261 7463 6865 645f 6172 6773    unbatched_args
+0000f370: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
+0000f380: 6461 2078 3a20 7265 6d6f 7665 5f62 6174  da x: remove_bat
+0000f390: 6368 5f64 696d 2878 2920 6966 2069 7369  ch_dim(x) if isi
+0000f3a0: 6e73 7461 6e63 6528 782c 2054 656e 736f  nstance(x, Tenso
+0000f3b0: 7250 726f 7879 2920 656c 7365 2078 2c20  rProxy) else x, 
+0000f3c0: 6172 6773 290a 2020 2020 7472 6163 6520  args).    trace 
+0000f3d0: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
+0000f3e0: 6528 2928 666e 2c20 2a75 6e62 6174 6368  e()(fn, *unbatch
+0000f3f0: 6564 5f61 7267 732c 202a 2a6b 7761 7267  ed_args, **kwarg
+0000f400: 7329 0a20 2020 2074 7261 6365 203d 2075  s).    trace = u
+0000f410: 6e77 7261 705f 6f6e 655f 6c65 7665 6c5f  nwrap_one_level_
+0000f420: 6f66 5f73 7562 7379 6d62 6f6c 7328 7472  of_subsymbols(tr
+0000f430: 6163 6529 0a20 2020 206f 7574 7320 3d20  ace).    outs = 
+0000f440: 5f76 6d61 705f 6361 6c6c 5f6d 6574 6166  _vmap_call_metaf
+0000f450: 756e 6328 4661 6c73 652c 2061 7267 732c  unc(False, args,
+0000f460: 2069 6e5f 6469 6d73 2c20 302c 2061 7869   in_dims, 0, axi
+0000f470: 735f 7369 7a65 2c20 6675 6e63 7469 6f6e  s_size, function
+0000f480: 5f74 7261 6365 3d74 7261 6365 2c20 2a2a  _trace=trace, **
+0000f490: 6b77 6172 6773 290a 2020 2020 6966 2069  kwargs).    if i
+0000f4a0: 7369 6e73 7461 6e63 6528 6f75 7473 2c20  sinstance(outs, 
+0000f4b0: 5365 7175 656e 6365 293a 0a20 2020 2020  Sequence):.     
+0000f4c0: 2020 206f 7574 5f64 696d 7320 3d20 2830     out_dims = (0
+0000f4d0: 2c29 202a 206c 656e 286f 7574 7329 0a20  ,) * len(outs). 
+0000f4e0: 2020 2020 2020 2072 6574 7572 6e20 7361         return sa
+0000f4f0: 6665 5f6d 6170 2870 6169 725f 746f 5f62  fe_map(pair_to_b
+0000f500: 6174 6368 6564 5f76 616c 7565 2c20 7361  atched_value, sa
+0000f510: 6665 5f7a 6970 286f 7574 732c 206f 7574  fe_zip(outs, out
+0000f520: 5f64 696d 7329 290a 2020 2020 7265 7475  _dims)).    retu
+0000f530: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
+0000f540: 6f75 7473 2c20 3029 0a0a 0a76 6d61 705f  outs, 0)...vmap_
+0000f550: 696d 706c 735b 7072 696d 732e 5072 696d  impls[prims.Prim
+0000f560: 4944 732e 5349 4e5d 203d 2073 696e 5f76  IDs.SIN] = sin_v
+0000f570: 6d61 700a 766d 6170 5f69 6d70 6c73 5b70  map.vmap_impls[p
+0000f580: 7269 6d73 2e50 7269 6d49 4473 2e43 4f53  rims.PrimIDs.COS
+0000f590: 5d20 3d20 636f 735f 766d 6170 0a76 6d61  ] = cos_vmap.vma
+0000f5a0: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
+0000f5b0: 696d 4944 732e 4d55 4c5d 203d 206d 756c  imIDs.MUL] = mul
+0000f5c0: 5f76 6d61 700a 766d 6170 5f69 6d70 6c73  _vmap.vmap_impls
+0000f5d0: 5b70 7269 6d73 2e50 7269 6d49 4473 2e41  [prims.PrimIDs.A
+0000f5e0: 4444 5d20 3d20 6164 645f 766d 6170 0a76  DD] = add_vmap.v
+0000f5f0: 6d61 705f 696d 706c 735b 7072 696d 732e  map_impls[prims.
+0000f600: 5072 696d 4944 732e 5355 4d5d 203d 2073  PrimIDs.SUM] = s
+0000f610: 756d 5f76 6d61 700a 766d 6170 5f69 6d70  um_vmap.vmap_imp
+0000f620: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
+0000f630: 2e42 524f 4144 4341 5354 5f49 4e5f 4449  .BROADCAST_IN_DI
+0000f640: 4d5d 203d 2062 726f 6164 6361 7374 5f69  M] = broadcast_i
+0000f650: 6e5f 6469 6d5f 766d 6170 0a0a 0a64 6566  n_dim_vmap...def
+0000f660: 2076 6d61 705f 7379 6d62 6f6c 5f6d 6170   vmap_symbol_map
+0000f670: 7065 7228 7379 6d62 6f6c 3a20 7072 696d  per(symbol: prim
+0000f680: 732e 5379 6d62 6f6c 2c20 2a2c 2061 7869  s.Symbol, *, axi
+0000f690: 735f 7369 7a65 3a20 696e 7429 3a0a 2020  s_size: int):.  
+0000f6a0: 2020 2222 224d 6170 7320 6120 7379 6d62    """Maps a symb
+0000f6b0: 6f6c 2074 6f20 6120 766d 6170 2066 756e  ol to a vmap fun
+0000f6c0: 6374 696f 6e20 7468 6174 2065 7661 6c75  ction that evalu
+0000f6d0: 6174 6573 2069 742e 0a0a 2020 2020 4172  ates it...    Ar
+0000f6e0: 6773 3a0a 2020 2020 2020 2020 7379 6d62  gs:.        symb
+0000f6f0: 6f6c 2028 7072 696d 732e 5379 6d62 6f6c  ol (prims.Symbol
+0000f700: 293a 2053 796d 626f 6c20 746f 2065 7661  ): Symbol to eva
+0000f710: 6c75 6174 652e 0a0a 2020 2020 5261 6973  luate...    Rais
+0000f720: 6573 3a0a 2020 2020 2020 2020 4e6f 7449  es:.        NotI
+0000f730: 6d70 6c65 6d65 6e74 6564 4572 726f 723a  mplementedError:
+0000f740: 2049 6620 7468 6520 766d 6170 2066 6f72   If the vmap for
+0000f750: 2074 6865 2073 796d 626f 6c20 6973 206e   the symbol is n
+0000f760: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
+0000f770: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+0000f780: 2020 2020 2020 4361 6c6c 6162 6c65 3a20        Callable: 
+0000f790: 766d 6170 2066 756e 6374 696f 6e20 7468  vmap function th
+0000f7a0: 6174 2065 7661 6c75 6174 6573 2074 6865  at evaluates the
+0000f7b0: 2073 796d 626f 6c2e 0a20 2020 2022 2222   symbol..    """
+0000f7c0: 0a0a 2020 2020 6465 6620 7772 6170 5f61  ..    def wrap_a
+0000f7d0: 7267 2878 293a 0a20 2020 2020 2020 2069  rg(x):.        i
+0000f7e0: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+0000f7f0: 4261 7463 6865 6456 616c 7565 293a 0a20  BatchedValue):. 
+0000f800: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000f810: 6e20 780a 2020 2020 2020 2020 656c 6966  n x.        elif
+0000f820: 2069 7369 6e73 7461 6e63 6528 782c 204e   isinstance(x, N
+0000f830: 756d 6265 7229 3a0a 2020 2020 2020 2020  umber):.        
+0000f840: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
+0000f850: 6564 5661 6c75 6528 782c 206e 6f74 5f6d  edValue(x, not_m
+0000f860: 6170 7065 6429 0a20 2020 2020 2020 2065  apped).        e
+0000f870: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000f880: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0000f890: 7228 6622 766d 6170 2077 7261 705f 6172  r(f"vmap wrap_ar
+0000f8a0: 6720 676f 7420 616e 2075 6e73 7570 706f  g got an unsuppo
+0000f8b0: 7274 6564 2074 7970 6520 7b74 7970 6528  rted type {type(
+0000f8c0: 7829 7d22 290a 0a20 2020 2069 6620 7379  x)}")..    if sy
+0000f8d0: 6d62 6f6c 2e61 7265 5f61 6c6c 5f61 7267  mbol.are_all_arg
+0000f8e0: 735f 636f 6e73 7461 6e74 3a0a 0a20 2020  s_constant:..   
+0000f8f0: 2020 2020 2064 6566 205f 766d 6170 5f69       def _vmap_i
+0000f900: 6d70 6c5f 636f 6e73 7428 7379 6d62 6f6c  mpl_const(symbol
+0000f910: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+0000f920: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0000f930: 6f75 7420 3d20 7379 6d62 6f6c 5f74 6f5f  out = symbol_to_
+0000f940: 6576 616c 2873 796d 626f 6c29 282a 6172  eval(symbol)(*ar
+0000f950: 6773 2c20 2a2a 6b77 6172 6773 290a 0a20  gs, **kwargs).. 
+0000f960: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0000f970: 696e 7374 616e 6365 286f 7574 2c20 5365  instance(out, Se
+0000f980: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
+0000f990: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000f9a0: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
+0000f9b0: 5f62 6174 6368 6564 5f76 616c 7565 2c20  _batched_value, 
+0000f9c0: 7361 6665 5f7a 6970 2861 7267 732c 205b  safe_zip(args, [
+0000f9d0: 6e6f 745f 6d61 7070 6564 5d20 2a20 6c65  not_mapped] * le
+0000f9e0: 6e28 6f75 7429 2929 0a0a 2020 2020 2020  n(out)))..      
+0000f9f0: 2020 2020 2020 7265 7475 726e 2042 6174        return Bat
+0000fa00: 6368 6564 5661 6c75 6528 6f75 742c 206e  chedValue(out, n
+0000fa10: 6f74 5f6d 6170 7065 6429 0a0a 2020 2020  ot_mapped)..    
+0000fa20: 2020 2020 7265 7475 726e 2070 6172 7469      return parti
+0000fa30: 616c 285f 766d 6170 5f69 6d70 6c5f 636f  al(_vmap_impl_co
+0000fa40: 6e73 742c 2073 796d 626f 6c29 0a0a 2020  nst, symbol)..  
+0000fa50: 2020 766d 6170 5f69 6d70 6c20 3d20 766d    vmap_impl = vm
+0000fa60: 6170 5f69 6d70 6c73 2e67 6574 2873 796d  ap_impls.get(sym
+0000fa70: 626f 6c2e 7379 6d2e 6964 290a 2020 2020  bol.sym.id).    
+0000fa80: 6966 2076 6d61 705f 696d 706c 2069 7320  if vmap_impl is 
+0000fa90: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+0000faa0: 206c 656e 2873 796d 626f 6c2e 7375 6273   len(symbol.subs
+0000fab0: 796d 626f 6c73 2920 3e20 303a 0a20 2020  ymbols) > 0:.   
+0000fac0: 2020 2020 2020 2020 2076 6d61 705f 696d           vmap_im
+0000fad0: 706c 203d 2070 6172 7469 616c 2864 6563  pl = partial(dec
+0000fae0: 6f6d 706f 7365 645f 666e 5f76 6d61 705f  omposed_fn_vmap_
+0000faf0: 7275 6c65 2c20 666e 3d73 796d 626f 6c2e  rule, fn=symbol.
+0000fb00: 7379 6d29 0a20 2020 2020 2020 2065 6c73  sym).        els
+0000fb10: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0000fb20: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
+0000fb30: 7465 6445 7272 6f72 2866 2276 6d61 7020  tedError(f"vmap 
+0000fb40: 666f 7220 7b73 796d 626f 6c2e 7379 6d2e  for {symbol.sym.
+0000fb50: 6964 7d20 6973 206e 6f74 2069 6d70 6c65  id} is not imple
+0000fb60: 6d65 6e74 6564 2229 0a0a 2020 2020 6465  mented")..    de
+0000fb70: 6620 5f76 6d61 705f 696d 706c 282a 6172  f _vmap_impl(*ar
+0000fb80: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+0000fb90: 2020 2020 2020 2061 7267 7320 3d20 7472         args = tr
+0000fba0: 6565 5f6d 6170 2877 7261 705f 6172 672c  ee_map(wrap_arg,
+0000fbb0: 2061 7267 7329 0a20 2020 2020 2020 2061   args).        a
+0000fbc0: 7373 6572 7420 616c 6c28 6973 696e 7374  ssert all(isinst
+0000fbd0: 616e 6365 2861 7267 2c20 4261 7463 6865  ance(arg, Batche
+0000fbe0: 6456 616c 7565 2920 666f 7220 6172 6720  dValue) for arg 
+0000fbf0: 696e 2074 7265 655f 666c 6174 7465 6e28  in tree_flatten(
+0000fc00: 6172 6773 295b 305d 290a 2020 2020 2020  args)[0]).      
+0000fc10: 2020 7265 7475 726e 2076 6d61 705f 696d    return vmap_im
+0000fc20: 706c 2861 7869 735f 7369 7a65 2c20 2a61  pl(axis_size, *a
+0000fc30: 7267 732c 202a 2a6b 7761 7267 7329 0a0a  rgs, **kwargs)..
+0000fc40: 2020 2020 7265 7475 726e 205f 766d 6170      return _vmap
+0000fc50: 5f69 6d70 6c0a 0a0a 6465 6620 7265 6d6f  _impl...def remo
+0000fc60: 7665 5f62 6174 6368 5f64 696d 2874 656e  ve_batch_dim(ten
+0000fc70: 736f 723a 2054 656e 736f 7250 726f 7879  sor: TensorProxy
+0000fc80: 2c20 6261 7463 685f 6469 6d3a 2069 6e74  , batch_dim: int
+0000fc90: 203d 2030 2920 2d3e 2054 656e 736f 7250   = 0) -> TensorP
+0000fca0: 726f 7879 3a0a 2020 2020 2222 2252 656d  roxy:.    """Rem
+0000fcb0: 6f76 6573 2074 6865 2062 6174 6368 2064  oves the batch d
+0000fcc0: 696d 656e 7369 6f6e 2066 726f 6d20 6120  imension from a 
+0000fcd0: 7465 6e73 6f72 2e0a 0a20 2020 2041 7267  tensor...    Arg
+0000fce0: 733a 0a20 2020 2020 2020 2074 656e 736f  s:.        tenso
+0000fcf0: 7220 2854 656e 736f 7250 726f 7879 293a  r (TensorProxy):
+0000fd00: 2054 656e 736f 7220 746f 2072 656d 6f76   Tensor to remov
+0000fd10: 6520 7468 6520 6261 7463 6820 6469 6d65  e the batch dime
+0000fd20: 6e73 696f 6e20 6672 6f6d 2e0a 0a20 2020  nsion from...   
+0000fd30: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0000fd40: 2020 5465 6e73 6f72 5072 6f78 793a 2054    TensorProxy: T
+0000fd50: 656e 736f 7220 7769 7468 2074 6865 2062  ensor with the b
+0000fd60: 6174 6368 2064 696d 656e 7369 6f6e 2072  atch dimension r
+0000fd70: 656d 6f76 6564 2e0a 2020 2020 2222 220a  emoved..    """.
+0000fd80: 2020 2020 6e65 775f 7368 6170 6520 3d20      new_shape = 
+0000fd90: 7465 6e73 6f72 2e73 6861 7065 5b3a 6261  tensor.shape[:ba
+0000fda0: 7463 685f 6469 6d5d 202b 2074 656e 736f  tch_dim] + tenso
+0000fdb0: 722e 7368 6170 655b 6261 7463 685f 6469  r.shape[batch_di
+0000fdc0: 6d20 2b20 3120 3a5d 0a20 2020 2072 6574  m + 1 :].    ret
+0000fdd0: 7572 6e20 5465 6e73 6f72 5072 6f78 7928  urn TensorProxy(
+0000fde0: 6c69 6b65 3d74 656e 736f 722c 2073 6861  like=tensor, sha
+0000fdf0: 7065 3d6e 6577 5f73 6861 7065 290a 0a0a  pe=new_shape)...
+0000fe00: 2320 544f 444f 3a20 696e 204a 4158 2061  # TODO: in JAX a
+0000fe10: 7267 732c 2069 6e5f 6469 6d73 2061 7265  rgs, in_dims are
+0000fe20: 2066 6c61 7474 656e 6564 2074 6865 2073   flattened the s
+0000fe30: 616d 6520 7761 790a 2320 544f 444f 3a20  ame way.# TODO: 
+0000fe40: 696e 204a 4158 206f 7574 5f64 696d 7320  in JAX out_dims 
+0000fe50: 6172 6520 666c 6174 7465 6e65 6420 6173  are flattened as
+0000fe60: 2077 656c 6c0a 6465 6620 5f76 6d61 705f   well.def _vmap_
+0000fe70: 6361 6c6c 5f6d 6574 6166 756e 6328 6465  call_metafunc(de
+0000fe80: 7461 6368 6564 3a20 626f 6f6c 2c20 6172  tached: bool, ar
+0000fe90: 6773 2c20 696e 5f64 696d 732c 206f 7574  gs, in_dims, out
+0000fea0: 5f64 696d 732c 2061 7869 735f 7369 7a65  _dims, axis_size
+0000feb0: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
+0000fec0: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
+0000fed0: 7329 3a0a 2020 2020 2222 224d 6574 6166  s):.    """Metaf
+0000fee0: 756e 6374 696f 6e20 666f 7220 766d 6170  unction for vmap
+0000fef0: 2063 616c 6c2e 0a0a 2020 2020 4172 6773   call...    Args
+0000ff00: 3a0a 2020 2020 2020 2020 6465 7461 6368  :.        detach
+0000ff10: 6564 2028 626f 6f6c 293a 2057 6865 7468  ed (bool): Wheth
+0000ff20: 6572 2074 6f20 6465 7461 6368 2074 6865  er to detach the
+0000ff30: 2074 7261 6365 2e0a 2020 2020 2020 2020   trace..        
+0000ff40: 6172 6773 2028 5475 706c 655b 5072 6f78  args (Tuple[Prox
+0000ff50: 795d 293a 2041 7267 756d 656e 7473 2074  y]): Arguments t
+0000ff60: 6f20 7468 6520 6675 6e63 7469 6f6e 2e0a  o the function..
+0000ff70: 2020 2020 2020 2020 696e 5f64 696d 7320          in_dims 
+0000ff80: 2854 7570 6c65 5b69 6e74 5d29 3a20 4261  (Tuple[int]): Ba
+0000ff90: 7463 6820 6469 6d65 6e73 696f 6e20 666f  tch dimension fo
+0000ffa0: 7220 6561 6368 2061 7267 756d 656e 742e  r each argument.
+0000ffb0: 0a20 2020 2020 2020 206f 7574 5f64 696d  .        out_dim
+0000ffc0: 7320 2854 7570 6c65 5b69 6e74 5d29 3a20  s (Tuple[int]): 
+0000ffd0: 4261 7463 6820 6469 6d65 6e73 696f 6e20  Batch dimension 
+0000ffe0: 666f 7220 7265 7475 726e 2076 616c 7565  for return value
+0000fff0: 732e 0a20 2020 2020 2020 2066 756e 6374  s..        funct
+00010000: 696f 6e5f 7472 6163 6520 2854 7261 6365  ion_trace (Trace
+00010010: 293a 2054 7261 6365 2074 6f20 7573 6520  ): Trace to use 
+00010020: 666f 7220 7468 6520 6675 6e63 7469 6f6e  for the function
+00010030: 2e0a 2020 2020 2020 2020 6b77 6172 6773  ..        kwargs
+00010040: 3a20 4b65 7977 6f72 6420 6172 6775 6d65  : Keyword argume
+00010050: 6e74 732e 0a0a 2020 2020 5261 6973 6573  nts...    Raises
+00010060: 3a0a 2020 2020 2020 2020 4173 7365 7274  :.        Assert
+00010070: 696f 6e45 7272 6f72 3a20 4966 2074 6865  ionError: If the
+00010080: 2076 6d61 7020 666f 7220 6b65 7977 6f72   vmap for keywor
+00010090: 6420 6172 6775 6d65 6e74 7320 6973 206e  d arguments is n
+000100a0: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
+000100b0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+000100c0: 2020 2020 2020 5265 7375 6c74 206f 6620        Result of 
+000100d0: 7468 6520 766d 6170 2074 7261 6e73 666f  the vmap transfo
+000100e0: 726d 2e0a 2020 2020 2222 220a 2020 2020  rm..    """.    
+000100f0: 636f 6d6d 6f6e 5f64 6576 6963 6520 3d20  common_device = 
+00010100: 7b78 2e64 6576 6963 6520 666f 7220 7820  {x.device for x 
+00010110: 696e 2061 7267 7320 6966 2069 7369 6e73  in args if isins
+00010120: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
+00010130: 726f 7879 297d 0a20 2020 2061 7373 6572  roxy)}.    asser
+00010140: 7420 6c65 6e28 636f 6d6d 6f6e 5f64 6576  t len(common_dev
+00010150: 6963 6529 203c 3d20 312c 2022 766d 6170  ice) <= 1, "vmap
+00010160: 2066 6f72 206d 756c 7469 706c 6520 6465   for multiple de
+00010170: 7669 6365 7320 6973 206e 6f74 2069 6d70  vices is not imp
+00010180: 6c65 6d65 6e74 6564 220a 2020 2020 2863  lemented".    (c
+00010190: 6f6d 6d6f 6e5f 6465 7669 6365 2c29 203d  ommon_device,) =
+000101a0: 2063 6f6d 6d6f 6e5f 6465 7669 6365 2069   common_device i
+000101b0: 6620 6c65 6e28 636f 6d6d 6f6e 5f64 6576  f len(common_dev
+000101c0: 6963 6529 203d 3d20 3120 656c 7365 2028  ice) == 1 else (
+000101d0: 6370 752c 290a 0a20 2020 2069 6620 6178  cpu,)..    if ax
+000101e0: 6973 5f73 697a 6520 6973 204e 6f6e 653a  is_size is None:
+000101f0: 0a20 2020 2020 2020 2028 6178 6973 5f73  .        (axis_s
+00010200: 697a 652c 2920 3d20 7b78 2e73 6861 7065  ize,) = {x.shape
+00010210: 5b61 785d 2066 6f72 2078 2c20 6178 2069  [ax] for x, ax i
+00010220: 6e20 7a69 7028 6172 6773 2c20 696e 5f64  n zip(args, in_d
+00010230: 696d 7329 2069 6620 6178 2069 7320 6e6f  ims) if ax is no
+00010240: 7420 6e6f 745f 6d61 7070 6564 7d0a 2020  t not_mapped}.  
+00010250: 2020 696e 5f64 696d 7320 3d20 696e 5f64    in_dims = in_d
+00010260: 696d 7320 6966 2069 7369 6e73 7461 6e63  ims if isinstanc
+00010270: 6528 696e 5f64 696d 732c 2053 6571 7565  e(in_dims, Seque
+00010280: 6e63 6529 2065 6c73 6520 2869 6e5f 6469  nce) else (in_di
+00010290: 6d73 2c29 0a20 2020 2069 6e5f 6469 6d73  ms,).    in_dims
+000102a0: 203d 2074 7570 6c65 286e 6f74 5f6d 6170   = tuple(not_map
+000102b0: 7065 6420 6966 2069 7369 6e73 7461 6e63  ped if isinstanc
+000102c0: 6528 612c 204e 756d 6265 7229 2065 6c73  e(a, Number) els
+000102d0: 6520 6420 666f 7220 612c 2064 2069 6e20  e d for a, d in 
+000102e0: 7361 6665 5f7a 6970 2861 7267 732c 2069  safe_zip(args, i
+000102f0: 6e5f 6469 6d73 2929 0a20 2020 206f 7574  n_dims)).    out
+00010300: 5f64 696d 7320 3d20 6f75 745f 6469 6d73  _dims = out_dims
+00010310: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+00010320: 7574 5f64 696d 732c 2053 6571 7565 6e63  ut_dims, Sequenc
+00010330: 6529 2065 6c73 6520 286f 7574 5f64 696d  e) else (out_dim
+00010340: 732c 290a 0a20 2020 2063 7478 203d 2064  s,)..    ctx = d
+00010350: 6574 6163 6865 645f 7472 6163 6528 2920  etached_trace() 
+00010360: 6966 2064 6574 6163 6865 6420 656c 7365  if detached else
+00010370: 206e 756c 6c63 6f6e 7465 7874 2829 0a20   nullcontext(). 
+00010380: 2020 2077 6974 6820 6374 783a 0a20 2020     with ctx:.   
+00010390: 2020 2020 2023 2057 6520 7072 6f70 6167       # We propag
+000103a0: 6174 6520 7468 6520 4261 7463 6856 616c  ate the BatchVal
+000103b0: 7565 2074 6872 6f75 6768 2074 6865 2074  ue through the t
+000103c0: 7261 6365 2c20 616e 6420 7468 656e 2075  race, and then u
+000103d0: 6e77 7261 7020 6974 2061 7420 7468 6520  nwrap it at the 
+000103e0: 656e 640a 2020 2020 2020 2020 6261 7463  end.        batc
+000103f0: 6865 645f 6172 6773 203d 2073 6166 655f  hed_args = safe_
+00010400: 6d61 7028 7061 6972 5f74 6f5f 6261 7463  map(pair_to_batc
+00010410: 6865 645f 7661 6c75 652c 2073 6166 655f  hed_value, safe_
+00010420: 7a69 7028 6172 6773 2c20 696e 5f64 696d  zip(args, in_dim
+00010430: 7329 290a 2020 2020 2020 2020 7265 7375  s)).        resu
+00010440: 6c74 203d 2065 7661 6c5f 7472 6163 6528  lt = eval_trace(
+00010450: 0a20 2020 2020 2020 2020 2020 2066 756e  .            fun
+00010460: 6374 696f 6e5f 7472 6163 652c 202a 6261  ction_trace, *ba
+00010470: 7463 6865 645f 6172 6773 2c20 7379 6d62  tched_args, symb
+00010480: 6f6c 5f6d 6170 7065 723d 7061 7274 6961  ol_mapper=partia
+00010490: 6c28 766d 6170 5f73 796d 626f 6c5f 6d61  l(vmap_symbol_ma
+000104a0: 7070 6572 2c20 6178 6973 5f73 697a 653d  pper, axis_size=
+000104b0: 6178 6973 5f73 697a 6529 2c20 2a2a 6b77  axis_size), **kw
+000104c0: 6172 6773 0a20 2020 2020 2020 2029 0a20  args.        ). 
+000104d0: 2020 2020 2020 2023 2055 6e77 7261 7070         # Unwrapp
+000104e0: 696e 6720 7468 6520 4261 7463 6865 6456  ing the BatchedV
+000104f0: 616c 7565 2773 0a20 2020 2020 2020 2069  alue's.        i
+00010500: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+00010510: 756c 742c 2053 6571 7565 6e63 6529 3a0a  ult, Sequence):.
+00010520: 2020 2020 2020 2020 2020 2020 666c 6174              flat
+00010530: 5f72 6573 756c 742c 2073 7065 6320 3d20  _result, spec = 
+00010540: 7472 6565 5f66 6c61 7474 656e 2872 6573  tree_flatten(res
+00010550: 756c 7429 0a20 2020 2020 2020 2020 2020  ult).           
+00010560: 2061 7373 6572 7420 616c 6c28 6973 696e   assert all(isin
+00010570: 7374 616e 6365 2878 2c20 4261 7463 6865  stance(x, Batche
+00010580: 6456 616c 7565 2920 666f 7220 7820 696e  dValue) for x in
+00010590: 2066 6c61 745f 7265 7375 6c74 290a 2020   flat_result).  
+000105a0: 2020 2020 2020 2020 2020 6f75 7473 2c20            outs, 
+000105b0: 6264 696d 7320 3d20 756e 7a69 7032 2866  bdims = unzip2(f
+000105c0: 6c61 745f 7265 7375 6c74 290a 2020 2020  lat_result).    
+000105d0: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
+000105e0: 6861 6e64 6c65 2074 6865 2063 6173 6520  handle the case 
+000105f0: 7768 6572 6520 6f75 745f 6469 6d73 2069  where out_dims i
+00010600: 7320 6120 7369 6e67 6c65 2076 616c 7565  s a single value
+00010610: 2062 6574 7465 720a 2020 2020 2020 2020   better.        
+00010620: 2020 2020 6966 206c 656e 286f 7574 5f64      if len(out_d
+00010630: 696d 7329 203d 3d20 313a 0a20 2020 2020  ims) == 1:.     
+00010640: 2020 2020 2020 2020 2020 206f 7574 5f64             out_d
+00010650: 696d 7320 3d20 6f75 745f 6469 6d73 202a  ims = out_dims *
+00010660: 206c 656e 286f 7574 7329 0a20 2020 2020   len(outs).     
+00010670: 2020 2020 2020 206f 7574 7320 3d20 7361         outs = sa
+00010680: 6665 5f6d 6170 2870 6172 7469 616c 286d  fe_map(partial(m
+00010690: 6f76 655f 6261 7463 685f 6469 6d2c 2061  ove_batch_dim, a
+000106a0: 7869 735f 7369 7a65 292c 2062 6469 6d73  xis_size), bdims
+000106b0: 2c20 6f75 745f 6469 6d73 2c20 6f75 7473  , out_dims, outs
+000106c0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+000106d0: 7475 726e 2074 7265 655f 756e 666c 6174  turn tree_unflat
+000106e0: 7465 6e28 6f75 7473 2c20 7370 6563 290a  ten(outs, spec).
+000106f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00010700: 7461 6e63 6528 7265 7375 6c74 2c20 4e75  tance(result, Nu
+00010710: 6d62 6572 2920 616e 6420 6178 6973 5f73  mber) and axis_s
+00010720: 697a 6520 6973 206e 6f74 204e 6f6e 653a  ize is not None:
+00010730: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00010740: 4f44 4f3a 2066 6574 6368 2074 6865 2064  ODO: fetch the d
+00010750: 6566 6175 6c74 2064 6576 6963 6520 6672  efault device fr
+00010760: 6f6d 2074 6865 2063 6f6e 7465 7874 0a20  om the context. 
+00010770: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00010780: 7420 3d20 6675 6c6c 2873 6861 7065 3d28  t = full(shape=(
+00010790: 292c 2066 696c 6c5f 7661 6c75 653d 7265  ), fill_value=re
+000107a0: 7375 6c74 2c20 6465 7669 6365 3d63 6f6d  sult, device=com
+000107b0: 6d6f 6e5f 6465 7669 6365 290a 2020 2020  mon_device).    
+000107c0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+000107d0: 2042 6174 6368 6564 5661 6c75 6528 7265   BatchedValue(re
+000107e0: 7375 6c74 2c20 6e6f 745f 6d61 7070 6564  sult, not_mapped
+000107f0: 290a 2020 2020 2020 2020 656c 6966 2069  ).        elif i
+00010800: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
+00010810: 2c20 4261 7463 6865 6456 616c 7565 2920  , BatchedValue) 
+00010820: 616e 6420 6973 696e 7374 616e 6365 2872  and isinstance(r
+00010830: 6573 756c 742e 7661 6c75 652c 204e 756d  esult.value, Num
+00010840: 6265 7229 2061 6e64 2061 7869 735f 7369  ber) and axis_si
+00010850: 7a65 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ze is not None:.
+00010860: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00010870: 6c74 203d 2042 6174 6368 6564 5661 6c75  lt = BatchedValu
+00010880: 6528 6675 6c6c 2873 6861 7065 3d28 292c  e(full(shape=(),
+00010890: 2066 696c 6c5f 7661 6c75 653d 7265 7375   fill_value=resu
+000108a0: 6c74 2e76 616c 7565 2c20 6465 7669 6365  lt.value, device
+000108b0: 3d63 6f6d 6d6f 6e5f 6465 7669 6365 292c  =common_device),
+000108c0: 2072 6573 756c 742e 6261 7463 685f 6469   result.batch_di
+000108d0: 6d29 0a20 2020 2020 2020 2061 7373 6572  m).        asser
+000108e0: 7420 6973 696e 7374 616e 6365 2872 6573  t isinstance(res
+000108f0: 756c 742c 2042 6174 6368 6564 5661 6c75  ult, BatchedValu
+00010900: 6529 0a20 2020 2020 2020 206f 7574 203d  e).        out =
+00010910: 206d 6f76 655f 6261 7463 685f 6469 6d28   move_batch_dim(
+00010920: 6178 6973 5f73 697a 652c 2072 6573 756c  axis_size, resul
+00010930: 742e 6261 7463 685f 6469 6d2c 206f 7574  t.batch_dim, out
+00010940: 5f64 696d 735b 305d 2c20 7265 7375 6c74  _dims[0], result
+00010950: 2e76 616c 7565 290a 2020 2020 2020 2020  .value).        
+00010960: 7265 7475 726e 206f 7574 0a0a 0a76 6d61  return out...vma
+00010970: 705f 6361 6c6c 203d 2053 796d 626f 6c28  p_call = Symbol(
+00010980: 6964 3d54 7261 6e73 666f 726d 732e 566d  id=Transforms.Vm
+00010990: 6170 4f70 2c20 6e61 6d65 3d22 766d 6170  apOp, name="vmap
+000109a0: 5f63 616c 6c22 2c20 6d65 7461 3d70 6172  _call", meta=par
+000109b0: 7469 616c 285f 766d 6170 5f63 616c 6c5f  tial(_vmap_call_
+000109c0: 6d65 7461 6675 6e63 2c20 4661 6c73 6529  metafunc, False)
+000109d0: 290a 0a0a 2320 544f 444f 3a20 686f 7720  )...# TODO: how 
+000109e0: 7368 6f75 6c64 2077 6520 6861 6e64 6c65  should we handle
+000109f0: 206f 7574 5f64 696d 7320 6865 7265 3f0a   out_dims here?.
+00010a00: 2320 616c 7468 6f75 6768 2068 6572 6520  # although here 
+00010a10: 7765 2061 7265 2063 616c 6c69 6e67 2076  we are calling v
+00010a20: 6d61 7020 6f66 2069 6465 6e74 6974 792c  map of identity,
+00010a30: 2073 6f20 7765 2073 686f 756c 6420 6b6e   so we should kn
+00010a40: 6f77 2066 726f 6d20 7468 6520 6361 6c6c  ow from the call
+00010a50: 2074 6f20 766d 6170 0a23 2054 6869 7320   to vmap.# This 
+00010a60: 7368 6f75 6c64 2062 6520 6669 6e65 2e20  should be fine. 
+00010a70: 4966 2077 6520 6861 7665 2076 6d61 7028  If we have vmap(
+00010a80: 6964 656e 7469 7479 2866 756e 6329 2c20  identity(func), 
+00010a90: 6f75 745f 6469 6d73 3d4e 2920 7468 656e  out_dims=N) then
+00010aa0: 2074 6869 7320 7275 6c65 2069 7320 6669   this rule is fi
+00010ab0: 7273 7420 7573 6564 0a23 2074 6f20 6765  rst used.# to ge
+00010ac0: 7420 7468 6520 766d 6170 7065 6420 7265  t the vmapped re
+00010ad0: 7375 6c74 206f 6620 6964 656e 7469 7479  sult of identity
+00010ae0: 2866 756e 6329 2069 6e20 766d 6170 5f73  (func) in vmap_s
+00010af0: 796d 626f 6c5f 6d61 7070 6572 2c20 616e  ymbol_mapper, an
+00010b00: 6420 6f75 745f 6469 6d73 2069 7320 6861  d out_dims is ha
+00010b10: 6e64 6c65 640a 2320 6166 7465 7220 7468  ndled.# after th
+00010b20: 6174 2069 6e20 7468 6520 6f75 7465 7220  at in the outer 
+00010b30: 5f76 6d61 705f 6361 6c6c 5f6d 6574 6166  _vmap_call_metaf
+00010b40: 756e 632e 0a64 6566 205f 6964 656e 7469  unc..def _identi
+00010b50: 7479 5f63 616c 6c5f 766d 6170 2861 7869  ty_call_vmap(axi
+00010b60: 735f 7369 7a65 2c20 2a62 6174 6368 6564  s_size, *batched
+00010b70: 5f61 7267 732c 2074 7261 6365 3a20 5472  _args, trace: Tr
+00010b80: 6163 652c 202a 2a6b 7761 7267 7329 3a0a  ace, **kwargs):.
+00010b90: 2020 2020 6172 6773 2c20 696e 5f64 696d      args, in_dim
+00010ba0: 7320 3d20 756e 7a69 7032 2862 6174 6368  s = unzip2(batch
+00010bb0: 6564 5f61 7267 7329 0a20 2020 206f 7574  ed_args).    out
+00010bc0: 5f64 696d 7320 3d20 3020 2023 2046 6978  _dims = 0  # Fix
+00010bd0: 6d65 0a20 2020 206f 7574 732c 206f 7574  me.    outs, out
+00010be0: 5f64 696d 7320 3d20 5f76 6d61 705f 6361  _dims = _vmap_ca
+00010bf0: 6c6c 5f6d 6574 6166 756e 6328 4661 6c73  ll_metafunc(Fals
+00010c00: 652c 2061 7267 732c 2069 6e5f 6469 6d73  e, args, in_dims
+00010c10: 2c20 6f75 745f 6469 6d73 2c20 6178 6973  , out_dims, axis
+00010c20: 5f73 697a 652c 2066 756e 6374 696f 6e5f  _size, function_
+00010c30: 7472 6163 653d 7472 6163 652c 202a 2a6b  trace=trace, **k
+00010c40: 7761 7267 7329 0a20 2020 2069 6620 6973  wargs).    if is
+00010c50: 696e 7374 616e 6365 286f 7574 732c 2053  instance(outs, S
+00010c60: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+00010c70: 2020 7265 7475 726e 2073 6166 655f 6d61    return safe_ma
+00010c80: 7028 7061 6972 5f74 6f5f 6261 7463 6865  p(pair_to_batche
+00010c90: 645f 7661 6c75 652c 2073 6166 655f 7a69  d_value, safe_zi
+00010ca0: 7028 6f75 7473 2c20 6f75 745f 6469 6d73  p(outs, out_dims
+00010cb0: 2929 0a20 2020 2072 6574 7572 6e20 4261  )).    return Ba
+00010cc0: 7463 6865 6456 616c 7565 286f 7574 732c  tchedValue(outs,
+00010cd0: 206f 7574 5f64 696d 7329 0a0a 0a76 6d61   out_dims)...vma
+00010ce0: 705f 696d 706c 735b 5472 616e 7366 6f72  p_impls[Transfor
+00010cf0: 6d73 2e49 6465 6e74 6974 794f 705d 203d  ms.IdentityOp] =
+00010d00: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
+00010d10: 766d 6170 0a0a 0a64 6566 205f 6a76 705f  vmap...def _jvp_
+00010d20: 6361 6c6c 5f76 6d61 7028 6178 6973 5f73  call_vmap(axis_s
+00010d30: 697a 652c 2062 6174 6368 6564 5f70 7269  ize, batched_pri
+00010d40: 6d61 6c73 2c20 6261 7463 6865 645f 7461  mals, batched_ta
+00010d50: 6e67 656e 7473 2c20 2a2c 2066 756e 6374  ngents, *, funct
+00010d60: 696f 6e5f 7472 6163 653a 2054 7261 6365  ion_trace: Trace
+00010d70: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00010d80: 2070 7269 6d61 6c73 2c20 7072 696d 616c   primals, primal
+00010d90: 735f 6264 696d 7320 3d20 7361 6665 5f7a  s_bdims = safe_z
+00010da0: 6970 282a 6261 7463 6865 645f 7072 696d  ip(*batched_prim
+00010db0: 616c 7329 0a20 2020 2074 616e 6765 6e74  als).    tangent
+00010dc0: 732c 2074 616e 6765 6e74 735f 6264 696d  s, tangents_bdim
+00010dd0: 7320 3d20 7361 6665 5f7a 6970 282a 6261  s = safe_zip(*ba
+00010de0: 7463 6865 645f 7461 6e67 656e 7473 290a  tched_tangents).
+00010df0: 2020 2020 6a76 705f 6675 6e63 203d 2070      jvp_func = p
+00010e00: 6172 7469 616c 285f 6a76 705f 6361 6c6c  artial(_jvp_call
+00010e10: 5f6d 6574 6166 756e 632c 2046 616c 7365  _metafunc, False
+00010e20: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
+00010e30: 3d66 756e 6374 696f 6e5f 7472 6163 6529  =function_trace)
+00010e40: 0a20 2020 2076 6d61 7070 6564 5f6a 7670  .    vmapped_jvp
+00010e50: 5f66 756e 6320 3d20 766d 6170 286a 7670  _func = vmap(jvp
+00010e60: 5f66 756e 632c 2069 6e5f 6469 6d73 3d28  _func, in_dims=(
+00010e70: 7072 696d 616c 735f 6264 696d 732c 2074  primals_bdims, t
+00010e80: 616e 6765 6e74 735f 6264 696d 7329 2c20  angents_bdims), 
+00010e90: 6178 6973 5f73 697a 653d 6178 6973 5f73  axis_size=axis_s
+00010ea0: 697a 6529 0a20 2020 2072 6573 756c 7420  ize).    result 
+00010eb0: 3d20 766d 6170 7065 645f 6a76 705f 6675  = vmapped_jvp_fu
+00010ec0: 6e63 2870 7269 6d61 6c73 2c20 7461 6e67  nc(primals, tang
+00010ed0: 656e 7473 2c20 2a2a 6b77 6172 6773 290a  ents, **kwargs).
+00010ee0: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
+00010ef0: 6d61 7028 6c61 6d62 6461 2078 3a20 4261  map(lambda x: Ba
+00010f00: 7463 6865 6456 616c 7565 2878 2c20 3029  tchedValue(x, 0)
+00010f10: 2c20 7265 7375 6c74 290a 0a0a 766d 6170  , result)...vmap
+00010f20: 5f69 6d70 6c73 5b54 7261 6e73 666f 726d  _impls[Transform
+00010f30: 732e 4a76 704f 705d 203d 205f 6a76 705f  s.JvpOp] = _jvp_
+00010f40: 6361 6c6c 5f76 6d61 700a 0a0a 6465 6620  call_vmap...def 
+00010f50: 766d 6170 2866 756e 632c 2069 6e5f 6469  vmap(func, in_di
+00010f60: 6d73 3d30 2c20 6f75 745f 6469 6d73 3d30  ms=0, out_dims=0
+00010f70: 2c20 6178 6973 5f73 697a 653d 4e6f 6e65  , axis_size=None
+00010f80: 293a 0a20 2020 2022 2222 5665 6374 6f72  ):.    """Vector
+00010f90: 697a 696e 6720 7472 616e 7366 6f72 6d20  izing transform 
+00010fa0: 666f 7220 6120 5468 756e 6465 7220 6675  for a Thunder fu
+00010fb0: 6e63 7469 6f6e 2e0a 0a20 2020 2041 7267  nction...    Arg
+00010fc0: 733a 0a20 2020 2020 2020 2066 756e 6320  s:.        func 
+00010fd0: 2843 616c 6c61 626c 6529 3a20 4120 5468  (Callable): A Th
+00010fe0: 756e 6465 7220 6675 6e63 7469 6f6e 2074  under function t
+00010ff0: 6f20 6265 2074 7261 6e73 666f 726d 6564  o be transformed
+00011000: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+00011010: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+00011020: 3a20 4120 766d 6170 7065 6420 7665 7273  : A vmapped vers
+00011030: 696f 6e20 6f66 2074 6865 2066 756e 6374  ion of the funct
+00011040: 696f 6e2e 0a20 2020 2022 2222 0a0a 2020  ion..    """..  
+00011050: 2020 2320 544f 444f 3a20 666c 6174 7465    # TODO: flatte
+00011060: 6e0a 2020 2020 2320 496e 204a 4158 2066  n.    # In JAX f
+00011070: 6c61 7474 656e 696e 6720 6f66 2069 6e5f  lattening of in_
+00011080: 6469 6d73 2069 7320 7261 7468 6572 2063  dims is rather c
+00011090: 6f6d 706c 6963 6174 6564 2062 6563 6175  omplicated becau
+000110a0: 7365 2069 7420 6361 6e20 6f70 7469 6f6e  se it can option
+000110b0: 616c 6c79 2062 650a 2020 2020 2320 7370  ally be.    # sp
+000110c0: 6563 6966 6965 6420 6173 2061 20e2 809c  ecified as a ...
+000110d0: 7072 6566 6978 e280 9d20 7079 7472 6565  prefix... pytree
+000110e0: 2c20 6d65 616e 696e 6720 7468 6174 2061  , meaning that a
+000110f0: 2073 696e 676c 6520 6c65 6166 2076 616c   single leaf val
+00011100: 7565 2063 616e 2062 6520 6170 706c 6965  ue can be applie
+00011110: 640a 2020 2020 2320 746f 2061 6e20 656e  d.    # to an en
+00011120: 7469 7265 2073 7562 2d70 7974 7265 652e  tire sub-pytree.
+00011130: 0a0a 2020 2020 6465 6620 666c 6174 7465  ..    def flatte
+00011140: 6e5f 6675 6e63 5f66 6f72 5f76 6d61 7028  n_func_for_vmap(
+00011150: 6675 6e63 2c20 6172 6773 2c20 6b77 6172  func, args, kwar
+00011160: 6773 293a 0a20 2020 2020 2020 2066 6c61  gs):.        fla
+00011170: 745f 6172 6773 2c20 7370 6563 203d 2074  t_args, spec = t
+00011180: 7265 655f 666c 6174 7465 6e28 2861 7267  ree_flatten((arg
+00011190: 732c 206b 7761 7267 7329 290a 0a20 2020  s, kwargs))..   
+000111a0: 2020 2020 2064 6566 2066 6c61 745f 6675       def flat_fu
+000111b0: 6e63 282a 666c 6174 5f61 7267 7329 3a0a  nc(*flat_args):.
+000111c0: 2020 2020 2020 2020 2020 2020 666e 5f61              fn_a
+000111d0: 7267 732c 2066 6e5f 6b77 6172 6773 203d  rgs, fn_kwargs =
+000111e0: 2074 7265 655f 756e 666c 6174 7465 6e28   tree_unflatten(
+000111f0: 666c 6174 5f61 7267 732c 2073 7065 6329  flat_args, spec)
+00011200: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00011210: 7572 6e20 6675 6e63 282a 666e 5f61 7267  urn func(*fn_arg
+00011220: 732c 202a 2a66 6e5f 6b77 6172 6773 290a  s, **fn_kwargs).
+00011230: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00011240: 666c 6174 5f66 756e 632c 2066 6c61 745f  flat_func, flat_
+00011250: 6172 6773 2c20 7370 6563 0a0a 2020 2020  args, spec..    
+00011260: 6465 6620 7772 6170 7065 7228 2a61 7267  def wrapper(*arg
+00011270: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+00011280: 2020 2020 2020 6675 6e63 5f66 6c61 742c        func_flat,
+00011290: 2061 7267 735f 666c 6174 2c20 6172 6773   args_flat, args
+000112a0: 5f73 7065 6320 3d20 666c 6174 7465 6e5f  _spec = flatten_
+000112b0: 6675 6e63 5f66 6f72 5f76 6d61 7028 6675  func_for_vmap(fu
+000112c0: 6e63 2c20 6172 6773 2c20 6b77 6172 6773  nc, args, kwargs
+000112d0: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
+000112e0: 6e73 7461 6e63 6528 696e 5f64 696d 732c  nstance(in_dims,
+000112f0: 2069 6e74 293a 0a20 2020 2020 2020 2020   int):.         
+00011300: 2020 2069 6e5f 6469 6d73 5f66 6c61 7420     in_dims_flat 
+00011310: 3d20 2869 6e5f 6469 6d73 2c29 202a 206c  = (in_dims,) * l
+00011320: 656e 2861 7267 735f 666c 6174 290a 2020  en(args_flat).  
+00011330: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00011340: 2020 2020 2020 2020 696e 5f64 696d 735f          in_dims_
+00011350: 666c 6174 2c20 696e 5f64 696d 735f 7370  flat, in_dims_sp
+00011360: 6563 203d 2074 7265 655f 666c 6174 7465  ec = tree_flatte
+00011370: 6e28 696e 5f64 696d 7329 0a20 2020 2020  n(in_dims).     
+00011380: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
+00011390: 6e28 696e 5f64 696d 735f 666c 6174 2920  n(in_dims_flat) 
+000113a0: 3d3d 206c 656e 2861 7267 735f 666c 6174  == len(args_flat
+000113b0: 292c 2022 696e 5f64 696d 7320 6d75 7374  ), "in_dims must
+000113c0: 2068 6176 6520 7468 6520 7361 6d65 206c   have the same l
+000113d0: 656e 6774 6820 6173 2061 7267 732c 206b  ength as args, k
+000113e0: 7761 7267 7322 0a20 2020 2020 2020 2075  wargs".        u
+000113f0: 6e62 6174 6368 6564 5f61 7267 735f 666c  nbatched_args_fl
+00011400: 6174 203d 205b 7265 6d6f 7665 5f62 6174  at = [remove_bat
+00011410: 6368 5f64 696d 2861 7267 2920 6966 2069  ch_dim(arg) if i
+00011420: 7369 6e73 7461 6e63 6528 6172 672c 2054  sinstance(arg, T
+00011430: 656e 736f 7250 726f 7879 2920 656c 7365  ensorProxy) else
+00011440: 2061 7267 2066 6f72 2061 7267 2069 6e20   arg for arg in 
+00011450: 6172 6773 5f66 6c61 745d 0a20 2020 2020  args_flat].     
+00011460: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
+00011470: 7275 6374 5f74 7261 6365 2829 2866 756e  ruct_trace()(fun
+00011480: 635f 666c 6174 2c20 2a75 6e62 6174 6368  c_flat, *unbatch
+00011490: 6564 5f61 7267 735f 666c 6174 290a 2020  ed_args_flat).  
+000114a0: 2020 2020 2020 6f75 7473 203d 2076 6d61        outs = vma
+000114b0: 705f 6361 6c6c 2861 7267 735f 666c 6174  p_call(args_flat
+000114c0: 2c20 696e 5f64 696d 735f 666c 6174 2c20  , in_dims_flat, 
+000114d0: 6f75 745f 6469 6d73 2c20 6178 6973 5f73  out_dims, axis_s
+000114e0: 697a 653d 6178 6973 5f73 697a 652c 2066  ize=axis_size, f
+000114f0: 756e 6374 696f 6e5f 7472 6163 653d 7472  unction_trace=tr
+00011500: 6163 6529 0a20 2020 2020 2020 2072 6574  ace).        ret
+00011510: 7572 6e20 6f75 7473 0a0a 2020 2020 7265  urn outs..    re
+00011520: 7475 726e 2077 7261 7070 6572 0a0a 0a23  turn wrapper...#
+00011530: 2054 4f44 4f20 5468 6973 2066 756e 6374   TODO This funct
+00011540: 696f 6e20 636f 6d6d 656e 7465 6420 6f75  ion commented ou
+00011550: 7420 6265 6361 7573 6520 6974 2063 616c  t because it cal
+00011560: 6c73 206d 616b 655f 7472 6163 6564 2c20  ls make_traced, 
+00011570: 7768 6963 6820 646f 6573 206e 6f74 2065  which does not e
+00011580: 7869 7374 0a23 2064 6566 2076 6d61 705f  xist.# def vmap_
+00011590: 6561 6765 7228 6675 6e63 2c20 6172 6773  eager(func, args
+000115a0: 2c20 696e 5f64 696d 733d 302c 206f 7574  , in_dims=0, out
+000115b0: 5f64 696d 733d 302c 2061 7869 735f 7369  _dims=0, axis_si
+000115c0: 7a65 3d4e 6f6e 652c 2065 7865 6375 746f  ze=None, executo
+000115d0: 723d 2274 6f72 6368 2229 3a0a 2320 2020  r="torch"):.#   
+000115e0: 2020 2222 2243 6f6d 7075 7465 7320 7468    """Computes th
+000115f0: 6520 766d 6170 206f 6620 6120 5468 756e  e vmap of a Thun
+00011600: 6465 7220 6675 6e63 7469 6f6e 2e0a 0a23  der function...#
+00011610: 2020 2020 2041 7267 733a 0a23 2020 2020       Args:.#    
+00011620: 2020 2020 2066 756e 6320 2843 616c 6c61       func (Calla
+00011630: 626c 6529 3a20 4120 5468 756e 6465 7220  ble): A Thunder 
+00011640: 6675 6e63 7469 6f6e 2074 6f20 6265 2074  function to be t
+00011650: 7261 6e73 666f 726d 6564 2e0a 2320 2020  ransformed..#   
+00011660: 2020 2020 2020 6172 6773 2028 5f74 7970        args (_typ
+00011670: 655f 293a 2041 7267 7320 6f66 2074 6865  e_): Args of the
+00011680: 2066 756e 6374 696f 6e2e 0a23 2020 2020   function..#    
+00011690: 2020 2020 2065 7865 6375 746f 7220 2873       executor (s
+000116a0: 7472 2c20 6f70 7469 6f6e 616c 293a 2045  tr, optional): E
+000116b0: 7865 6375 746f 7220 746f 2075 7365 2e20  xecutor to use. 
+000116c0: 4465 6661 756c 7473 2074 6f20 2274 6f72  Defaults to "tor
+000116d0: 6368 222e 0a0a 2320 2020 2020 5265 7475  ch"...#     Retu
+000116e0: 726e 733a 0a23 2020 2020 2020 2020 2054  rns:.#         T
+000116f0: 6865 2072 6573 756c 7420 6f66 2074 6865  he result of the
+00011700: 2076 6d61 7070 6564 2066 756e 6374 696f   vmapped functio
+00011710: 6e2e 0a23 2020 2020 2022 2222 0a23 2020  n..#     """.#  
+00011720: 2020 2023 2054 4f44 4f3a 2066 6978 2074     # TODO: fix t
+00011730: 6869 7320 2d20 6e6f 7420 616c 6c20 6172  his - not all ar
+00011740: 6773 206d 6179 2062 6520 6261 7463 6865  gs may be batche
+00011750: 640a 2320 2020 2020 2320 544f 444f 3a20  d.#     # TODO: 
+00011760: 6865 7265 2077 6520 6173 7375 6d65 2062  here we assume b
+00011770: 6174 6368 2061 7869 7320 6973 2030 0a23  atch axis is 0.#
+00011780: 2020 2020 2076 6d61 705f 7472 6163 6520       vmap_trace 
+00011790: 3d20 6d61 6b65 5f74 7261 6365 280a 2320  = make_trace(.# 
+000117a0: 2020 2020 2020 2020 766d 6170 2866 756e          vmap(fun
+000117b0: 632c 2069 6e5f 6469 6d73 3d69 6e5f 6469  c, in_dims=in_di
+000117c0: 6d73 2c20 6f75 745f 6469 6d73 3d6f 7574  ms, out_dims=out
+000117d0: 5f64 696d 732c 2061 7869 735f 7369 7a65  _dims, axis_size
+000117e0: 3d61 7869 735f 7369 7a65 292c 2065 7865  =axis_size), exe
+000117f0: 6375 746f 723d 6578 6563 7574 6f72 2c0a  cutor=executor,.
+00011800: 2320 2020 2020 2020 2020 2a61 7267 7329  #         *args)
+00011810: 0a23 2020 2020 2076 6d61 705f 7472 6163  .#     vmap_trac
+00011820: 6564 203d 206d 616b 655f 7472 6163 6564  ed = make_traced
+00011830: 2870 6172 7469 616c 2865 7661 6c5f 7472  (partial(eval_tr
+00011840: 6163 652c 2076 6d61 705f 7472 6163 6529  ace, vmap_trace)
+00011850: 2c20 6578 6563 7574 6f72 3d65 7865 6375  , executor=execu
+00011860: 746f 7229 0a23 2020 2020 2072 6574 7572  tor).#     retur
+00011870: 6e20 766d 6170 5f74 7261 6365 6428 2a61  n vmap_traced(*a
+00011880: 7267 7329 0a0a 0a23 204a 5650 2074 7261  rgs)...# JVP tra
+00011890: 6e73 666f 726d 0a23 202d 2d2d 2d2d 2d2d  nsform.# -------
+000118a0: 2d2d 2d2d 2d2d 0a0a 0a40 6461 7461 636c  ------...@datacl
+000118b0: 6173 7328 6672 6f7a 656e 3d54 7275 6529  ass(frozen=True)
+000118c0: 0a63 6c61 7373 204a 5650 4475 616c 3a0a  .class JVPDual:.
+000118d0: 2020 2020 2222 2244 7561 6c20 6e75 6d62      """Dual numb
+000118e0: 6572 2066 6f72 2074 6865 204a 5650 2074  er for the JVP t
+000118f0: 7261 6e73 666f 726d 2e0a 0a20 2020 2041  ransform...    A
+00011900: 7474 7269 6275 7465 733a 0a20 2020 2020  ttributes:.     
+00011910: 2020 2070 7269 6d61 6c3a 2050 7269 6d61     primal: Prima
+00011920: 6c20 7661 6c75 652e 0a20 2020 2020 2020  l value..       
+00011930: 2074 616e 6765 6e74 3a20 5461 6e67 656e   tangent: Tangen
+00011940: 7420 7661 6c75 652e 0a20 2020 2022 2222  t value..    """
+00011950: 0a0a 2020 2020 7072 696d 616c 3a20 416e  ..    primal: An
+00011960: 790a 2020 2020 7461 6e67 656e 743a 2041  y.    tangent: A
+00011970: 6e79 0a0a 2020 2020 6465 6620 5f5f 6974  ny..    def __it
+00011980: 6572 5f5f 2873 656c 6629 3a0a 2020 2020  er__(self):.    
+00011990: 2020 2020 7969 656c 6420 7365 6c66 2e70      yield self.p
+000119a0: 7269 6d61 6c0a 2020 2020 2020 2020 7969  rimal.        yi
+000119b0: 656c 6420 7365 6c66 2e74 616e 6765 6e74  eld self.tangent
+000119c0: 0a0a 0a64 6566 2070 6169 725f 746f 5f6a  ...def pair_to_j
+000119d0: 7670 5f64 7561 6c28 7061 6972 293a 0a20  vp_dual(pair):. 
+000119e0: 2020 2022 2222 436f 6e76 6572 7473 2061     """Converts a
+000119f0: 2070 6169 7220 746f 2061 204a 5650 4475   pair to a JVPDu
+00011a00: 616c 2e0a 0a20 2020 2041 7267 733a 0a20  al...    Args:. 
+00011a10: 2020 2020 2020 2070 6169 7220 2853 6571         pair (Seq
+00011a20: 7565 6e63 6529 3a20 5061 6972 2074 6f20  uence): Pair to 
+00011a30: 636f 6e76 6572 742e 0a0a 2020 2020 5265  convert...    Re
+00011a40: 7475 726e 733a 0a20 2020 2020 2020 204a  turns:.        J
+00011a50: 5650 4475 616c 3a20 4a56 5044 7561 6c20  VPDual: JVPDual 
+00011a60: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
+00011a70: 6620 7468 6520 7061 6972 2e0a 2020 2020  f the pair..    
+00011a80: 2222 220a 2020 2020 6966 2069 7369 6e73  """.    if isins
+00011a90: 7461 6e63 6528 7061 6972 2c20 4a56 5044  tance(pair, JVPD
+00011aa0: 7561 6c29 3a0a 2020 2020 2020 2020 7265  ual):.        re
+00011ab0: 7475 726e 2070 6169 720a 2020 2020 656c  turn pair.    el
+00011ac0: 7365 3a0a 2020 2020 2020 2020 6173 7365  se:.        asse
+00011ad0: 7274 2069 7369 6e73 7461 6e63 6528 7061  rt isinstance(pa
+00011ae0: 6972 2c20 5365 7175 656e 6365 2920 616e  ir, Sequence) an
+00011af0: 6420 6c65 6e28 7061 6972 2920 3d3d 2032  d len(pair) == 2
+00011b00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00011b10: 4a56 5044 7561 6c28 2a70 6169 7229 0a0a  JVPDual(*pair)..
+00011b20: 0a64 6566 2073 696e 5f6a 7670 2861 3a20  .def sin_jvp(a: 
+00011b30: 4a56 5044 7561 6c29 3a0a 2020 2020 782c  JVPDual):.    x,
+00011b40: 2078 6420 3d20 610a 2020 2020 7265 7475   xd = a.    retu
+00011b50: 726e 204a 5650 4475 616c 2870 7269 6d73  rn JVPDual(prims
+00011b60: 2e73 696e 2878 292c 2070 7269 6d73 2e63  .sin(x), prims.c
+00011b70: 6f73 2878 2920 2a20 7864 290a 0a0a 6465  os(x) * xd)...de
+00011b80: 6620 6d75 6c5f 6a76 7028 613a 204a 5650  f mul_jvp(a: JVP
+00011b90: 4475 616c 2c20 623a 204a 5650 4475 616c  Dual, b: JVPDual
+00011ba0: 293a 0a20 2020 2078 2c20 7864 203d 2061  ):.    x, xd = a
+00011bb0: 0a20 2020 2079 2c20 7964 203d 2062 0a20  .    y, yd = b. 
+00011bc0: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
+00011bd0: 6c28 7820 2a20 792c 2078 202a 2079 6420  l(x * y, x * yd 
+00011be0: 2b20 7920 2a20 7864 290a 0a0a 6465 6620  + y * xd)...def 
+00011bf0: 6164 645f 6a76 7028 613a 204a 5650 4475  add_jvp(a: JVPDu
+00011c00: 616c 2c20 623a 204a 5650 4475 616c 293a  al, b: JVPDual):
+00011c10: 0a20 2020 2078 2c20 7864 203d 2061 0a20  .    x, xd = a. 
+00011c20: 2020 2079 2c20 7964 203d 2062 0a20 2020     y, yd = b.   
+00011c30: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
+00011c40: 7820 2b20 792c 2078 6420 2b20 7964 290a  x + y, xd + yd).
+00011c50: 0a0a 6465 6620 6272 6f61 6463 6173 745f  ..def broadcast_
+00011c60: 696e 5f64 696d 5f6a 7670 2861 3a20 4a56  in_dim_jvp(a: JV
+00011c70: 5044 7561 6c2c 2073 6861 7065 3a20 7475  PDual, shape: tu
+00011c80: 706c 655b 4a56 5044 7561 6c2c 202e 2e2e  ple[JVPDual, ...
+00011c90: 5d2c 2062 726f 6164 6361 7374 5f64 696d  ], broadcast_dim
+00011ca0: 656e 7369 6f6e 733a 2074 7570 6c65 5b4a  ensions: tuple[J
+00011cb0: 5650 4475 616c 2c20 2e2e 2e5d 2920 2d3e  VPDual, ...]) ->
+00011cc0: 204a 5650 4475 616c 3a0a 2020 2020 782c   JVPDual:.    x,
+00011cd0: 2078 6420 3d20 610a 2020 2020 2320 544f   xd = a.    # TO
+00011ce0: 444f 3a20 7368 6170 6520 616e 6420 6272  DO: shape and br
+00011cf0: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+00011d00: 6e73 2073 686f 756c 6420 6265 2074 7570  ns should be tup
+00011d10: 6c65 7320 6f66 2069 6e74 730a 2020 2020  les of ints.    
+00011d20: 2320 6275 7420 666f 7220 6e6f 7720 6974  # but for now it
+00011d30: 2773 2061 2074 7570 6c65 206f 6620 4a56  's a tuple of JV
+00011d40: 5044 7561 6c73 0a20 2020 2069 6620 6c65  PDuals.    if le
+00011d50: 6e28 7368 6170 6529 203e 2030 2061 6e64  n(shape) > 0 and
+00011d60: 2069 7369 6e73 7461 6e63 6528 7368 6170   isinstance(shap
+00011d70: 655b 305d 2c20 4a56 5044 7561 6c29 3a0a  e[0], JVPDual):.
+00011d80: 2020 2020 2020 2020 7368 6170 652c 205f          shape, _
+00011d90: 203d 2073 6166 655f 7a69 7028 2a73 6861   = safe_zip(*sha
+00011da0: 7065 290a 2020 2020 6966 206c 656e 2862  pe).    if len(b
+00011db0: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+00011dc0: 6f6e 7329 203e 2030 2061 6e64 2069 7369  ons) > 0 and isi
+00011dd0: 6e73 7461 6e63 6528 6272 6f61 6463 6173  nstance(broadcas
+00011de0: 745f 6469 6d65 6e73 696f 6e73 5b30 5d2c  t_dimensions[0],
+00011df0: 204a 5650 4475 616c 293a 0a20 2020 2020   JVPDual):.     
+00011e00: 2020 2062 726f 6164 6361 7374 5f64 696d     broadcast_dim
+00011e10: 656e 7369 6f6e 732c 205f 203d 2073 6166  ensions, _ = saf
+00011e20: 655f 7a69 7028 2a62 726f 6164 6361 7374  e_zip(*broadcast
+00011e30: 5f64 696d 656e 7369 6f6e 7329 0a20 2020  _dimensions).   
+00011e40: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
+00011e50: 0a20 2020 2020 2020 2070 7269 6d73 2e62  .        prims.b
+00011e60: 726f 6164 6361 7374 5f69 6e5f 6469 6d28  roadcast_in_dim(
+00011e70: 782c 2073 6861 7065 2c20 6272 6f61 6463  x, shape, broadc
+00011e80: 6173 745f 6469 6d65 6e73 696f 6e73 292c  ast_dimensions),
+00011e90: 2070 7269 6d73 2e62 726f 6164 6361 7374   prims.broadcast
+00011ea0: 5f69 6e5f 6469 6d28 7864 2c20 7368 6170  _in_dim(xd, shap
+00011eb0: 652c 2062 726f 6164 6361 7374 5f64 696d  e, broadcast_dim
+00011ec0: 656e 7369 6f6e 7329 0a20 2020 2029 0a0a  ensions).    )..
+00011ed0: 0a64 6566 2075 6e70 6163 6b5f 7365 7175  .def unpack_sequ
+00011ee0: 656e 6365 5f6a 7670 2873 6571 7565 6e63  ence_jvp(sequenc
+00011ef0: 653a 204a 5650 4475 616c 2c20 6c65 6e67  e: JVPDual, leng
+00011f00: 7468 3a20 4a56 5044 7561 6c29 202d 3e20  th: JVPDual) -> 
+00011f10: 4a56 5044 7561 6c3a 0a20 2020 2078 203d  JVPDual:.    x =
+00011f20: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
+00011f30: 2078 3a20 782e 7072 696d 616c 2c20 7365   x: x.primal, se
+00011f40: 7175 656e 6365 290a 2020 2020 7864 203d  quence).    xd =
+00011f50: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
+00011f60: 2078 3a20 782e 7461 6e67 656e 742c 2073   x: x.tangent, s
+00011f70: 6571 7565 6e63 6529 0a20 2020 206c 656e  equence).    len
+00011f80: 6774 682c 205f 203d 206c 656e 6774 680a  gth, _ = length.
+00011f90: 2020 2020 7072 696d 616c 7320 3d20 7072      primals = pr
+00011fa0: 696d 732e 756e 7061 636b 5f73 6571 7565  ims.unpack_seque
+00011fb0: 6e63 6528 782c 206c 656e 6774 6829 0a20  nce(x, length). 
+00011fc0: 2020 2074 616e 6765 6e74 7320 3d20 7072     tangents = pr
+00011fd0: 696d 732e 756e 7061 636b 5f73 6571 7565  ims.unpack_seque
+00011fe0: 6e63 6528 7864 2c20 6c65 6e67 7468 290a  nce(xd, length).
+00011ff0: 2020 2020 7265 7475 726e 2073 6166 655f      return safe_
+00012000: 6d61 7028 7061 6972 5f74 6f5f 6a76 705f  map(pair_to_jvp_
+00012010: 6475 616c 2c20 7361 6665 5f7a 6970 2870  dual, safe_zip(p
+00012020: 7269 6d61 6c73 2c20 7461 6e67 656e 7473  rimals, tangents
+00012030: 2929 0a0a 0a64 6566 2075 6e70 6163 6b5f  ))...def unpack_
+00012040: 7472 6976 6961 6c5f 6a76 7028 783a 204a  trivial_jvp(x: J
+00012050: 5650 4475 616c 2920 2d3e 204a 5650 4475  VPDual) -> JVPDu
+00012060: 616c 3a0a 2020 2020 7265 7475 726e 2078  al:.    return x
+00012070: 0a0a 0a6a 7670 5f69 6d70 6c73 3a20 6469  ...jvp_impls: di
+00012080: 6374 5b70 7269 6d73 2e53 796d 626f 6c2c  ct[prims.Symbol,
+00012090: 2043 616c 6c61 626c 655d 203d 2064 6963   Callable] = dic
+000120a0: 7428 290a 0a6a 7670 5f69 6d70 6c73 5b70  t()..jvp_impls[p
+000120b0: 7269 6d73 2e50 7269 6d49 4473 2e53 494e  rims.PrimIDs.SIN
+000120c0: 5d20 3d20 7369 6e5f 6a76 700a 6a76 705f  ] = sin_jvp.jvp_
+000120d0: 696d 706c 735b 7072 696d 732e 5072 696d  impls[prims.Prim
+000120e0: 4944 732e 4d55 4c5d 203d 206d 756c 5f6a  IDs.MUL] = mul_j
+000120f0: 7670 0a6a 7670 5f69 6d70 6c73 5b70 7269  vp.jvp_impls[pri
+00012100: 6d73 2e50 7269 6d49 4473 2e41 4444 5d20  ms.PrimIDs.ADD] 
+00012110: 3d20 6164 645f 6a76 700a 6a76 705f 696d  = add_jvp.jvp_im
+00012120: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
+00012130: 732e 4252 4f41 4443 4153 545f 494e 5f44  s.BROADCAST_IN_D
+00012140: 494d 5d20 3d20 6272 6f61 6463 6173 745f  IM] = broadcast_
+00012150: 696e 5f64 696d 5f6a 7670 0a23 206a 7670  in_dim_jvp.# jvp
+00012160: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
+00012170: 6d49 4473 2e55 4e50 4143 4b5f 5345 5155  mIDs.UNPACK_SEQU
+00012180: 454e 4345 5d20 3d20 756e 7061 636b 5f73  ENCE] = unpack_s
+00012190: 6571 7565 6e63 655f 6a76 700a 2320 6a76  equence_jvp.# jv
+000121a0: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
+000121b0: 696d 4944 732e 554e 5041 434b 5f54 5249  imIDs.UNPACK_TRI
+000121c0: 5649 414c 5d20 3d20 756e 7061 636b 5f74  VIAL] = unpack_t
+000121d0: 7269 7669 616c 5f6a 7670 0a0a 0a64 6566  rivial_jvp...def
+000121e0: 206a 7670 5f73 796d 626f 6c5f 6d61 7070   jvp_symbol_mapp
+000121f0: 6572 2873 796d 626f 6c3a 2070 7269 6d73  er(symbol: prims
+00012200: 2e53 796d 626f 6c29 3a0a 2020 2020 2222  .Symbol):.    ""
+00012210: 224d 6170 7320 6120 7379 6d62 6f6c 2074  "Maps a symbol t
+00012220: 6f20 6120 4a56 5020 6675 6e63 7469 6f6e  o a JVP function
+00012230: 2074 6861 7420 6576 616c 7561 7465 7320   that evaluates 
+00012240: 6974 2e0a 0a20 2020 2041 7267 733a 0a20  it...    Args:. 
+00012250: 2020 2020 2020 2073 796d 626f 6c20 2870         symbol (p
+00012260: 7269 6d73 2e53 796d 626f 6c29 3a20 5379  rims.Symbol): Sy
+00012270: 6d62 6f6c 2074 6f20 6576 616c 7561 7465  mbol to evaluate
+00012280: 2e0a 0a20 2020 2052 6169 7365 733a 0a20  ...    Raises:. 
+00012290: 2020 2020 2020 204e 6f74 496d 706c 656d         NotImplem
+000122a0: 656e 7465 6445 7272 6f72 3a20 4966 2074  entedError: If t
+000122b0: 6865 204a 5650 2066 6f72 2074 6865 2073  he JVP for the s
+000122c0: 796d 626f 6c20 6973 206e 6f74 2069 6d70  ymbol is not imp
+000122d0: 6c65 6d65 6e74 6564 2e0a 0a20 2020 2052  lemented...    R
+000122e0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+000122f0: 4361 6c6c 6162 6c65 3a20 4a56 5020 6675  Callable: JVP fu
+00012300: 6e63 7469 6f6e 2074 6861 7420 6576 616c  nction that eval
+00012310: 7561 7465 7320 7468 6520 7379 6d62 6f6c  uates the symbol
+00012320: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
+00012330: 6566 2077 7261 705f 6172 6728 7829 3a0a  ef wrap_arg(x):.
+00012340: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00012350: 7461 6e63 6528 782c 204a 5650 4475 616c  tance(x, JVPDual
+00012360: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00012370: 6574 7572 6e20 780a 2020 2020 2020 2020  eturn x.        
+00012380: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00012390: 782c 204e 756d 6265 7229 3a0a 2020 2020  x, Number):.    
+000123a0: 2020 2020 2020 2020 7265 7475 726e 204a          return J
+000123b0: 5650 4475 616c 2878 2c20 7479 7065 2878  VPDual(x, type(x
+000123c0: 2928 3029 290a 2020 2020 2020 2020 656c  )(0)).        el
+000123d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000123e0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000123f0: 2866 224a 5650 2077 7261 705f 6172 6720  (f"JVP wrap_arg 
+00012400: 676f 7420 616e 2075 6e73 7570 706f 7274  got an unsupport
+00012410: 6564 2074 7970 6520 7b74 7970 6528 7829  ed type {type(x)
+00012420: 7d22 290a 0a20 2020 2023 2049 6620 7379  }")..    # If sy
+00012430: 6d62 6f6c 2e61 7267 7320 646f 6573 6e27  mbol.args doesn'
+00012440: 7420 6861 7665 2073 7562 636c 6173 7365  t have subclasse
+00012450: 7320 6f66 2056 6172 6961 626c 652c 2074  s of Variable, t
+00012460: 6865 6e20 7765 206e 6565 6420 746f 2072  hen we need to r
+00012470: 6574 7572 6e20 6120 7a65 726f 2074 616e  eturn a zero tan
+00012480: 6765 6e74 0a20 2020 2023 2054 4f44 4f3a  gent.    # TODO:
+00012490: 2074 6865 7265 206d 6179 2062 6520 6120   there may be a 
+000124a0: 6265 7474 6572 2077 6179 2074 6f20 6465  better way to de
+000124b0: 7465 6374 2063 6f6e 7374 616e 7473 2069  tect constants i
+000124c0: 6e20 7468 6520 7472 6163 650a 2020 2020  n the trace.    
+000124d0: 6966 2073 796d 626f 6c2e 6172 655f 616c  if symbol.are_al
+000124e0: 6c5f 6172 6773 5f63 6f6e 7374 616e 743a  l_args_constant:
+000124f0: 0a0a 2020 2020 2020 2020 6465 6620 7a65  ..        def ze
+00012500: 726f 735f 6c69 6b65 2878 293a 0a20 2020  ros_like(x):.   
+00012510: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00012520: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
+00012530: 5072 6f78 7929 3a0a 2020 2020 2020 2020  Proxy):.        
+00012540: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00012550: 756c 6c5f 6c69 6b65 2878 2c20 6669 6c6c  ull_like(x, fill
+00012560: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
+00012570: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+00012580: 7461 6e63 6528 782c 204e 756d 6265 7250  tance(x, NumberP
+00012590: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
+000125a0: 2020 2020 2020 2072 6574 7572 6e20 7479         return ty
+000125b0: 7065 2878 2e76 616c 7565 2928 3029 0a20  pe(x.value)(0). 
+000125c0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000125d0: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
+000125e0: 6d62 6572 293a 0a20 2020 2020 2020 2020  mber):.         
+000125f0: 2020 2020 2020 2072 6574 7572 6e20 7479         return ty
+00012600: 7065 2878 2928 3029 0a20 2020 2020 2020  pe(x)(0).       
+00012610: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00012620: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00012630: 2056 616c 7565 4572 726f 7228 6622 7a65   ValueError(f"ze
+00012640: 726f 735f 6c69 6b65 2069 6e73 6964 6520  ros_like inside 
+00012650: 4a56 5020 676f 7420 616e 2075 6e73 7570  JVP got an unsup
+00012660: 706f 7274 6564 2074 7970 6520 7b74 7970  ported type {typ
+00012670: 6528 7829 7d22 290a 0a20 2020 2020 2020  e(x)}")..       
+00012680: 2064 6566 206a 7670 5f69 6d70 6c5f 636f   def jvp_impl_co
+00012690: 6e73 7428 7379 6d62 6f6c 2c20 2a61 7267  nst(symbol, *arg
+000126a0: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+000126b0: 2020 2020 2020 2020 2020 7072 696d 616c            primal
+000126c0: 7320 3d20 7379 6d62 6f6c 5f74 6f5f 6576  s = symbol_to_ev
+000126d0: 616c 2873 796d 626f 6c29 282a 6172 6773  al(symbol)(*args
+000126e0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+000126f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00012700: 7461 6e63 6528 7072 696d 616c 732c 2053  tance(primals, S
+00012710: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+00012720: 2020 2020 2020 2020 2020 7461 6e67 656e            tangen
+00012730: 7473 203d 2074 7570 6c65 287a 6572 6f73  ts = tuple(zeros
+00012740: 5f6c 696b 6528 7029 2066 6f72 2070 2069  _like(p) for p i
+00012750: 6e20 7072 696d 616c 7329 0a20 2020 2020  n primals).     
+00012760: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00012770: 6e20 7361 6665 5f6d 6170 2870 6169 725f  n safe_map(pair_
+00012780: 746f 5f6a 7670 5f64 7561 6c2c 2073 6166  to_jvp_dual, saf
+00012790: 655f 7a69 7028 7072 696d 616c 732c 2074  e_zip(primals, t
+000127a0: 616e 6765 6e74 7329 290a 2020 2020 2020  angents)).      
+000127b0: 2020 2020 2020 7265 7475 726e 204a 5650        return JVP
+000127c0: 4475 616c 2870 7269 6d61 6c73 2c20 7a65  Dual(primals, ze
+000127d0: 726f 735f 6c69 6b65 2870 7269 6d61 6c73  ros_like(primals
+000127e0: 2929 0a0a 2020 2020 2020 2020 7265 7475  ))..        retu
+000127f0: 726e 2070 6172 7469 616c 286a 7670 5f69  rn partial(jvp_i
+00012800: 6d70 6c5f 636f 6e73 742c 2073 796d 626f  mpl_const, symbo
+00012810: 6c29 0a0a 2020 2020 2320 4e6f 726d 616c  l)..    # Normal
+00012820: 2063 6173 652c 2077 6520 6861 7665 2061   case, we have a
+00012830: 2070 726f 7879 2074 616e 6765 6e74 0a20   proxy tangent. 
+00012840: 2020 206a 7670 5f69 6d70 6c20 3d20 6a76     jvp_impl = jv
+00012850: 705f 696d 706c 732e 6765 7428 7379 6d62  p_impls.get(symb
+00012860: 6f6c 2e73 796d 2e69 6429 0a20 2020 2069  ol.sym.id).    i
+00012870: 6620 6a76 705f 696d 706c 2069 7320 4e6f  f jvp_impl is No
+00012880: 6e65 3a0a 2020 2020 2020 2020 7261 6973  ne:.        rais
+00012890: 6520 4e6f 7449 6d70 6c65 6d65 6e74 6564  e NotImplemented
+000128a0: 4572 726f 7228 6622 4a56 5020 666f 7220  Error(f"JVP for 
+000128b0: 7b73 796d 626f 6c2e 7379 6d2e 6964 7d20  {symbol.sym.id} 
+000128c0: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
+000128d0: 6564 2229 0a0a 2020 2020 6465 6620 5f6a  ed")..    def _j
+000128e0: 7670 5f69 6d70 6c28 2a61 7267 732c 202a  vp_impl(*args, *
+000128f0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00012900: 2020 6172 6773 203d 2074 7265 655f 6d61    args = tree_ma
+00012910: 7028 7772 6170 5f61 7267 2c20 6172 6773  p(wrap_arg, args
+00012920: 290a 2020 2020 2020 2020 2320 4578 7065  ).        # Expe
+00012930: 6374 696e 6720 4a56 5044 7561 6c73 2077  cting JVPDuals w
+00012940: 7261 7070 696e 6720 7061 6972 7320 6f66  rapping pairs of
+00012950: 2070 7269 6d61 6c73 2061 6e64 2074 616e   primals and tan
+00012960: 6765 6e74 730a 2020 2020 2020 2020 6173  gents.        as
+00012970: 7365 7274 2061 6c6c 2869 7369 6e73 7461  sert all(isinsta
+00012980: 6e63 6528 6172 672c 204a 5650 4475 616c  nce(arg, JVPDual
+00012990: 2920 666f 7220 6172 6720 696e 2074 7265  ) for arg in tre
+000129a0: 655f 666c 6174 7465 6e28 6172 6773 295b  e_flatten(args)[
+000129b0: 305d 290a 2020 2020 2020 2020 7265 7475  0]).        retu
+000129c0: 726e 206a 7670 5f69 6d70 6c28 2a61 7267  rn jvp_impl(*arg
+000129d0: 732c 202a 2a6b 7761 7267 7329 0a0a 2020  s, **kwargs)..  
+000129e0: 2020 7265 7475 726e 205f 6a76 705f 696d    return _jvp_im
+000129f0: 706c 0a0a 0a64 6566 205f 6a76 705f 6361  pl...def _jvp_ca
+00012a00: 6c6c 5f6d 6574 6166 756e 6328 6465 7461  ll_metafunc(deta
+00012a10: 6368 6564 3a20 626f 6f6c 2c20 7072 696d  ched: bool, prim
+00012a20: 616c 732c 2074 616e 6765 6e74 732c 202a  als, tangents, *
+00012a30: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
+00012a40: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
+00012a50: 7329 3a0a 2020 2020 2222 224d 6574 6166  s):.    """Metaf
+00012a60: 756e 6374 696f 6e20 666f 7220 7468 6520  unction for the 
+00012a70: 4a56 5020 7472 616e 7366 6f72 6d2e 0a0a  JVP transform...
+00012a80: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00012a90: 2020 6465 7461 6368 6564 2028 626f 6f6c    detached (bool
+00012aa0: 293a 2057 6865 7468 6572 2074 6f20 6465  ): Whether to de
+00012ab0: 7461 6368 2074 6865 2074 7261 6365 2e0a  tach the trace..
+00012ac0: 2020 2020 2020 2020 7072 696d 616c 7320          primals 
+00012ad0: 2854 7570 6c65 5b50 726f 7879 5d29 3a20  (Tuple[Proxy]): 
+00012ae0: 5072 696d 616c 2076 616c 7565 732e 0a20  Primal values.. 
+00012af0: 2020 2020 2020 2074 616e 6765 6e74 7320         tangents 
+00012b00: 2854 7570 6c65 5b50 726f 7879 5d29 3a20  (Tuple[Proxy]): 
+00012b10: 5461 6e67 656e 7420 7661 6c75 6573 2e0a  Tangent values..
+00012b20: 2020 2020 2020 2020 6675 6e63 7469 6f6e          function
+00012b30: 5f74 7261 6365 2028 5472 6163 6529 3a20  _trace (Trace): 
+00012b40: 5472 6163 6520 6f66 2074 6865 2066 756e  Trace of the fun
+00012b50: 6374 696f 6e20 746f 2062 6520 7472 616e  ction to be tran
+00012b60: 7366 6f72 6d65 642e 0a20 2020 2020 2020  sformed..       
+00012b70: 206b 7761 7267 733a 204b 6579 776f 7264   kwargs: Keyword
+00012b80: 2061 7267 756d 656e 7473 2e0a 0a20 2020   arguments...   
+00012b90: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
+00012ba0: 2041 7373 6572 7469 6f6e 4572 726f 723a   AssertionError:
+00012bb0: 2049 6620 7468 6520 4a56 5020 666f 7220   If the JVP for 
+00012bc0: 6b65 7977 6f72 6420 6172 6775 6d65 6e74  keyword argument
+00012bd0: 7320 6973 206e 6f74 2069 6d70 6c65 6d65  s is not impleme
+00012be0: 6e74 6564 2e0a 0a20 2020 2052 6574 7572  nted...    Retur
+00012bf0: 6e73 3a0a 2020 2020 2020 2020 5265 7375  ns:.        Resu
+00012c00: 6c74 206f 6620 7468 6520 4a56 5020 7472  lt of the JVP tr
+00012c10: 616e 7366 6f72 6d2e 0a20 2020 2022 2222  ansform..    """
+00012c20: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
+00012c30: 6b77 6172 6773 2920 3d3d 2030 2c20 224a  kwargs) == 0, "J
+00012c40: 5650 2066 6f72 206b 7761 7267 7320 6973  VP for kwargs is
+00012c50: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
+00012c60: 220a 0a20 2020 2063 7478 203d 2064 6574  "..    ctx = det
+00012c70: 6163 6865 645f 7472 6163 6528 2920 6966  ached_trace() if
+00012c80: 2064 6574 6163 6865 6420 656c 7365 206e   detached else n
+00012c90: 756c 6c63 6f6e 7465 7874 2829 0a20 2020  ullcontext().   
+00012ca0: 2077 6974 6820 6374 783a 0a20 2020 2020   with ctx:.     
+00012cb0: 2020 2023 2057 7261 7070 696e 6720 7468     # Wrapping th
+00012cc0: 6520 7072 696d 616c 7320 616e 6420 7461  e primals and ta
+00012cd0: 6e67 656e 7473 2069 6e20 4a56 5044 7561  ngents in JVPDua
+00012ce0: 6c73 2069 7320 6e6f 7420 7374 7269 6374  ls is not strict
+00012cf0: 6c79 206e 6563 6573 7361 7279 2c20 6275  ly necessary, bu
+00012d00: 7420 6974 206d 616b 6573 0a20 2020 2020  t it makes.     
+00012d10: 2020 2023 2074 6865 2063 6f64 6520 6d6f     # the code mo
+00012d20: 7265 2072 6561 6461 626c 650a 2020 2020  re readable.    
+00012d30: 2020 2020 2320 5765 2070 726f 7061 6761      # We propaga
+00012d40: 7465 2074 6865 204a 5650 4475 616c 7320  te the JVPDuals 
+00012d50: 7468 726f 7567 6820 7468 6520 7472 6163  through the trac
+00012d60: 652c 2061 6e64 2074 6865 6e20 756e 7772  e, and then unwr
+00012d70: 6170 2074 6865 6d20 6174 2074 6865 2065  ap them at the e
+00012d80: 6e64 0a20 2020 2020 2020 2070 7269 6d61  nd.        prima
+00012d90: 6c73 5f74 616e 6765 6e74 735f 6475 616c  ls_tangents_dual
+00012da0: 7320 3d20 7361 6665 5f6d 6170 2870 6169  s = safe_map(pai
+00012db0: 725f 746f 5f6a 7670 5f64 7561 6c2c 2073  r_to_jvp_dual, s
+00012dc0: 6166 655f 7a69 7028 7072 696d 616c 732c  afe_zip(primals,
+00012dd0: 2074 616e 6765 6e74 7329 290a 2020 2020   tangents)).    
+00012de0: 2020 2020 7265 7375 6c74 203d 2065 7661      result = eva
+00012df0: 6c5f 7472 6163 6528 6675 6e63 7469 6f6e  l_trace(function
+00012e00: 5f74 7261 6365 2c20 2a70 7269 6d61 6c73  _trace, *primals
+00012e10: 5f74 616e 6765 6e74 735f 6475 616c 732c  _tangents_duals,
+00012e20: 2073 796d 626f 6c5f 6d61 7070 6572 3d6a   symbol_mapper=j
+00012e30: 7670 5f73 796d 626f 6c5f 6d61 7070 6572  vp_symbol_mapper
+00012e40: 290a 2020 2020 2020 2020 2320 556e 7772  ).        # Unwr
+00012e50: 6170 7069 6e67 2074 6865 204a 5650 4475  apping the JVPDu
+00012e60: 616c 730a 2020 2020 2020 2020 6966 2069  als.        if i
+00012e70: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
+00012e80: 2c20 5365 7175 656e 6365 293a 0a20 2020  , Sequence):.   
+00012e90: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00012ea0: 616c 6c28 6973 696e 7374 616e 6365 2878  all(isinstance(x
+00012eb0: 2c20 4a56 5044 7561 6c29 2066 6f72 2078  , JVPDual) for x
+00012ec0: 2069 6e20 7265 7375 6c74 290a 2020 2020   in result).    
+00012ed0: 2020 2020 2020 2020 7072 696d 616c 732c          primals,
+00012ee0: 2074 616e 6765 6e74 7320 3d20 756e 7a69   tangents = unzi
+00012ef0: 7032 2872 6573 756c 7429 0a20 2020 2020  p2(result).     
+00012f00: 2020 2020 2020 2072 6574 7572 6e20 7072         return pr
+00012f10: 696d 616c 732c 2074 616e 6765 6e74 730a  imals, tangents.
+00012f20: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
+00012f30: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
+00012f40: 2c20 4a56 5044 7561 6c29 0a20 2020 2020  , JVPDual).     
+00012f50: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00012f60: 2e70 7269 6d61 6c2c 2072 6573 756c 742e  .primal, result.
+00012f70: 7461 6e67 656e 740a 0a0a 6a76 705f 6361  tangent...jvp_ca
+00012f80: 6c6c 203d 2053 796d 626f 6c28 6964 3d54  ll = Symbol(id=T
+00012f90: 7261 6e73 666f 726d 732e 4a76 704f 702c  ransforms.JvpOp,
+00012fa0: 206e 616d 653d 226a 7670 5f63 616c 6c22   name="jvp_call"
+00012fb0: 2c20 6d65 7461 3d70 6172 7469 616c 285f  , meta=partial(_
+00012fc0: 6a76 705f 6361 6c6c 5f6d 6574 6166 756e  jvp_call_metafun
+00012fd0: 632c 2046 616c 7365 2929 0a0a 0a64 6566  c, False))...def
+00012fe0: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
+00012ff0: 6a76 7028 2a61 7267 733a 204a 5650 4475  jvp(*args: JVPDu
+00013000: 616c 2c20 7472 6163 653a 2054 7261 6365  al, trace: Trace
+00013010: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00013020: 2070 7269 6d61 6c73 2c20 7461 6e67 656e   primals, tangen
+00013030: 7473 203d 2075 6e7a 6970 3228 6172 6773  ts = unzip2(args
+00013040: 290a 2020 2020 6f75 745f 7072 696d 616c  ).    out_primal
+00013050: 732c 206f 7574 5f74 616e 6765 6e74 7320  s, out_tangents 
+00013060: 3d20 5f6a 7670 5f63 616c 6c5f 6d65 7461  = _jvp_call_meta
+00013070: 6675 6e63 2846 616c 7365 2c20 7072 696d  func(False, prim
+00013080: 616c 732c 2074 616e 6765 6e74 732c 2074  als, tangents, t
+00013090: 7261 6365 2c20 2a2a 6b77 6172 6773 290a  race, **kwargs).
+000130a0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+000130b0: 6528 6f75 745f 7072 696d 616c 732c 2053  e(out_primals, S
+000130c0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+000130d0: 2020 7265 7475 726e 2073 6166 655f 6d61    return safe_ma
+000130e0: 7028 7061 6972 5f74 6f5f 6a76 705f 6475  p(pair_to_jvp_du
+000130f0: 616c 2c20 7361 6665 5f7a 6970 286f 7574  al, safe_zip(out
+00013100: 5f70 7269 6d61 6c73 2c20 6f75 745f 7461  _primals, out_ta
+00013110: 6e67 656e 7473 2929 0a20 2020 2072 6574  ngents)).    ret
+00013120: 7572 6e20 4a56 5044 7561 6c28 6f75 745f  urn JVPDual(out_
+00013130: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
+00013140: 6765 6e74 7329 0a0a 0a6a 7670 5f69 6d70  gents)...jvp_imp
+00013150: 6c73 5b54 7261 6e73 666f 726d 732e 4964  ls[Transforms.Id
+00013160: 656e 7469 7479 4f70 5d20 3d20 5f69 6465  entityOp] = _ide
+00013170: 6e74 6974 795f 6361 6c6c 5f6a 7670 0a0a  ntity_call_jvp..
+00013180: 0a64 6566 205f 766d 6170 5f63 616c 6c5f  .def _vmap_call_
+00013190: 6a76 7028 6172 6773 3a20 4a56 5044 7561  jvp(args: JVPDua
+000131a0: 6c2c 2069 6e5f 6469 6d73 2c20 6f75 745f  l, in_dims, out_
+000131b0: 6469 6d73 2c20 6178 6973 5f73 697a 652c  dims, axis_size,
+000131c0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
+000131d0: 2a6b 7761 7267 7329 3a0a 2020 2020 7072  *kwargs):.    pr
+000131e0: 696d 616c 732c 2074 616e 6765 6e74 7320  imals, tangents 
+000131f0: 3d20 7361 6665 5f7a 6970 282a 6172 6773  = safe_zip(*args
+00013200: 290a 2020 2020 696e 5f64 696d 732c 205f  ).    in_dims, _
+00013210: 203d 2073 6166 655f 7a69 7028 2a69 6e5f   = safe_zip(*in_
+00013220: 6469 6d73 290a 2020 2020 6f75 745f 6469  dims).    out_di
+00013230: 6d73 2c20 5f20 3d20 7361 6665 5f7a 6970  ms, _ = safe_zip
+00013240: 282a 6f75 745f 6469 6d73 290a 2020 2020  (*out_dims).    
+00013250: 766d 6170 7065 645f 7472 6163 6520 3d20  vmapped_trace = 
+00013260: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
+00013270: 2928 0a20 2020 2020 2020 2076 6d61 7028  )(.        vmap(
+00013280: 7061 7274 6961 6c28 6576 616c 5f74 7261  partial(eval_tra
+00013290: 6365 2c20 7472 6163 6529 2c20 696e 5f64  ce, trace), in_d
+000132a0: 696d 733d 696e 5f64 696d 732c 206f 7574  ims=in_dims, out
+000132b0: 5f64 696d 733d 6f75 745f 6469 6d73 2c20  _dims=out_dims, 
+000132c0: 6178 6973 5f73 697a 653d 6178 6973 5f73  axis_size=axis_s
+000132d0: 697a 6529 2c20 2a70 7269 6d61 6c73 0a20  ize), *primals. 
+000132e0: 2020 2029 0a20 2020 2076 6d61 7070 6564     ).    vmapped
+000132f0: 5f66 756e 6320 3d20 7061 7274 6961 6c28  _func = partial(
+00013300: 6576 616c 5f74 7261 6365 2c20 766d 6170  eval_trace, vmap
+00013310: 7065 645f 7472 6163 6529 0a20 2020 206f  ped_trace).    o
+00013320: 7574 5f70 7269 6d61 6c73 2c20 6f75 745f  ut_primals, out_
+00013330: 7461 6e67 656e 7473 203d 206a 7670 2876  tangents = jvp(v
+00013340: 6d61 7070 6564 5f66 756e 6329 2870 7269  mapped_func)(pri
+00013350: 6d61 6c73 2c20 7461 6e67 656e 7473 2c20  mals, tangents, 
+00013360: 2a2a 6b77 6172 6773 290a 2020 2020 6966  **kwargs).    if
+00013370: 2069 7369 6e73 7461 6e63 6528 6f75 745f   isinstance(out_
+00013380: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
+00013390: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
+000133a0: 726e 2073 6166 655f 6d61 7028 7061 6972  rn safe_map(pair
+000133b0: 5f74 6f5f 6a76 705f 6475 616c 2c20 7361  _to_jvp_dual, sa
+000133c0: 6665 5f7a 6970 286f 7574 5f70 7269 6d61  fe_zip(out_prima
+000133d0: 6c73 2c20 6f75 745f 7461 6e67 656e 7473  ls, out_tangents
+000133e0: 2929 0a20 2020 2072 6574 7572 6e20 4a56  )).    return JV
+000133f0: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
+00013400: 732c 206f 7574 5f74 616e 6765 6e74 7329  s, out_tangents)
+00013410: 0a0a 0a6a 7670 5f69 6d70 6c73 5b54 7261  ...jvp_impls[Tra
+00013420: 6e73 666f 726d 732e 566d 6170 4f70 5d20  nsforms.VmapOp] 
+00013430: 3d20 5f76 6d61 705f 6361 6c6c 5f6a 7670  = _vmap_call_jvp
+00013440: 0a0a 0a64 6566 206a 7670 2866 756e 6329  ...def jvp(func)
+00013450: 3a0a 2020 2020 2222 224a 6163 6f62 6961  :.    """Jacobia
+00013460: 6e2d 7665 6374 6f72 2070 726f 6475 6374  n-vector product
+00013470: 2074 7261 6e73 666f 726d 2066 6f72 2061   transform for a
+00013480: 2054 6875 6e64 6572 2066 756e 6374 696f   Thunder functio
+00013490: 6e2e 0a0a 2020 2020 4172 6773 3a0a 2020  n...    Args:.  
+000134a0: 2020 2020 2020 6675 6e63 2028 4361 6c6c        func (Call
+000134b0: 6162 6c65 293a 2041 2054 6875 6e64 6572  able): A Thunder
+000134c0: 2066 756e 6374 696f 6e20 746f 2062 6520   function to be 
+000134d0: 7472 616e 7366 6f72 6d65 642e 0a0a 2020  transformed...  
+000134e0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+000134f0: 2020 2043 616c 6c61 626c 653a 2041 2066     Callable: A f
+00013500: 756e 6374 696f 6e20 7468 6174 2063 6f6d  unction that com
+00013510: 7075 7465 7320 7468 6520 4a61 636f 6269  putes the Jacobi
+00013520: 616e 2d76 6563 746f 7220 7072 6f64 7563  an-vector produc
+00013530: 740a 2020 2020 2020 2020 2020 2020 7461  t.            ta
+00013540: 6b69 6e67 2070 7269 6d61 6c73 2061 6e64  king primals and
+00013550: 2074 616e 6765 6e74 7320 6173 2061 7267   tangents as arg
+00013560: 756d 656e 7473 2e0a 2020 2020 2222 220a  uments..    """.
+00013570: 0a20 2020 2064 6566 2077 7261 7070 6572  .    def wrapper
+00013580: 2870 7269 6d61 6c73 2c20 7461 6e67 656e  (primals, tangen
+00013590: 7473 293a 0a20 2020 2020 2020 2074 7261  ts):.        tra
+000135a0: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
+000135b0: 7261 6365 2829 2866 756e 632c 202a 7072  race()(func, *pr
+000135c0: 696d 616c 7329 0a20 2020 2020 2020 2072  imals).        r
+000135d0: 6574 7572 6e20 6a76 705f 6361 6c6c 2870  eturn jvp_call(p
+000135e0: 7269 6d61 6c73 2c20 7461 6e67 656e 7473  rimals, tangents
+000135f0: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
+00013600: 3d74 7261 6365 290a 0a20 2020 2072 6574  =trace)..    ret
+00013610: 7572 6e20 7772 6170 7065 720a 0a0a 2320  urn wrapper...# 
+00013620: 544f 444f 2054 6869 7320 6675 6e63 7469  TODO This functi
+00013630: 6f6e 2063 6f6d 6d65 6e74 6564 206f 7574  on commented out
+00013640: 2062 6563 6175 7365 2069 7420 6361 6c6c   because it call
+00013650: 7320 6d61 6b65 5f74 7261 6365 642c 2077  s make_traced, w
+00013660: 6869 6368 2064 6f65 7320 6e6f 7420 6578  hich does not ex
+00013670: 6973 740a 2320 6465 6620 6a76 705f 6561  ist.# def jvp_ea
+00013680: 6765 7228 6675 6e63 2c20 7072 696d 616c  ger(func, primal
+00013690: 732c 2074 616e 6765 6e74 732c 2065 7865  s, tangents, exe
+000136a0: 6375 746f 723d 2274 6f72 6368 2229 3a0a  cutor="torch"):.
+000136b0: 2320 2020 2020 2222 2243 6f6d 7075 7465  #     """Compute
+000136c0: 7320 7468 6520 4a61 636f 6269 616e 2d76  s the Jacobian-v
+000136d0: 6563 746f 7220 7072 6f64 7563 7420 6f66  ector product of
+000136e0: 2061 2054 6875 6e64 6572 2066 756e 6374   a Thunder funct
+000136f0: 696f 6e2e 0a0a 2320 2020 2020 4172 6773  ion...#     Args
+00013700: 3a0a 2320 2020 2020 2020 2020 6675 6e63  :.#         func
+00013710: 2028 4361 6c6c 6162 6c65 293a 2041 2054   (Callable): A T
+00013720: 6875 6e64 6572 2066 756e 6374 696f 6e20  hunder function 
+00013730: 746f 2062 6520 7472 616e 7366 6f72 6d65  to be transforme
+00013740: 642e 0a23 2020 2020 2020 2020 2070 7269  d..#         pri
+00013750: 6d61 6c73 2028 5f74 7970 655f 293a 2050  mals (_type_): P
+00013760: 7269 6d61 6c73 206f 6620 7468 6520 6675  rimals of the fu
+00013770: 6e63 7469 6f6e 2e0a 2320 2020 2020 2020  nction..#       
+00013780: 2020 7461 6e67 656e 7473 2028 5f74 7970    tangents (_typ
+00013790: 655f 293a 2054 616e 6765 6e74 7320 6f66  e_): Tangents of
+000137a0: 2074 6865 2066 756e 6374 696f 6e2e 0a23   the function..#
+000137b0: 2020 2020 2020 2020 2065 7865 6375 746f           executo
+000137c0: 7220 2873 7472 2c20 6f70 7469 6f6e 616c  r (str, optional
+000137d0: 293a 2045 7865 6375 746f 7220 746f 2075  ): Executor to u
+000137e0: 7365 2e20 4465 6661 756c 7473 2074 6f20  se. Defaults to 
+000137f0: 2274 6f72 6368 222e 0a0a 2320 2020 2020  "torch"...#     
+00013800: 5265 7475 726e 733a 0a23 2020 2020 2020  Returns:.#      
+00013810: 2020 2054 6865 2072 6573 756c 7420 6f66     The result of
+00013820: 2074 6865 204a 6163 6f62 6961 6e2d 7665   the Jacobian-ve
+00013830: 6374 6f72 2070 726f 6475 6374 2e0a 2320  ctor product..# 
+00013840: 2020 2020 2222 220a 2320 2020 2020 7472      """.#     tr
+00013850: 6163 6520 3d20 6d61 6b65 5f74 7261 6365  ace = make_trace
+00013860: 2866 756e 632c 2065 7865 6375 746f 723d  (func, executor=
+00013870: 6578 6563 7574 6f72 2c20 2a70 7269 6d61  executor, *prima
+00013880: 6c73 290a 0a23 2020 2020 2064 6566 206a  ls)..#     def j
+00013890: 7670 5f66 756e 6328 2a70 7269 6d61 6c73  vp_func(*primals
+000138a0: 5f61 6e64 5f74 616e 6765 6e74 7329 3a0a  _and_tangents):.
+000138b0: 2320 2020 2020 2020 2020 5f70 7269 6d61  #         _prima
+000138c0: 6c73 2c20 5f74 616e 6765 6e74 7320 3d20  ls, _tangents = 
+000138d0: 7072 696d 616c 735f 616e 645f 7461 6e67  primals_and_tang
+000138e0: 656e 7473 5b3a 206c 656e 2870 7269 6d61  ents[: len(prima
+000138f0: 6c73 295d 2c20 7072 696d 616c 735f 616e  ls)], primals_an
+00013900: 645f 7461 6e67 656e 7473 5b6c 656e 2870  d_tangents[len(p
+00013910: 7269 6d61 6c73 2920 3a5d 0a23 2020 2020  rimals) :].#    
+00013920: 2020 2020 2072 6574 7572 6e20 5f6a 7670       return _jvp
+00013930: 5f63 616c 6c5f 6d65 7461 6675 6e63 285f  _call_metafunc(_
+00013940: 7072 696d 616c 732c 205f 7461 6e67 656e  primals, _tangen
+00013950: 7473 2c20 7472 6163 652c 2064 6574 6163  ts, trace, detac
+00013960: 6865 643d 4661 6c73 6529 0a0a 2320 2020  hed=False)..#   
+00013970: 2020 6a76 705f 7472 6163 6520 3d20 6d61    jvp_trace = ma
+00013980: 6b65 5f74 7261 6365 286a 7670 5f66 756e  ke_trace(jvp_fun
+00013990: 632c 2065 7865 6375 746f 723d 6578 6563  c, executor=exec
+000139a0: 7574 6f72 2928 2a70 7269 6d61 6c73 2c20  utor)(*primals, 
+000139b0: 2a74 616e 6765 6e74 7329 0a23 2020 2020  *tangents).#    
+000139c0: 206a 7670 5f74 7261 6365 6420 3d20 6d61   jvp_traced = ma
+000139d0: 6b65 5f74 7261 6365 6428 7061 7274 6961  ke_traced(partia
+000139e0: 6c28 6576 616c 5f74 7261 6365 2c20 6a76  l(eval_trace, jv
+000139f0: 705f 7472 6163 6529 2c20 6578 6563 7574  p_trace), execut
+00013a00: 6f72 3d65 7865 6375 746f 7229 0a23 2020  or=executor).#  
+00013a10: 2020 2072 6574 7572 6e20 6a76 705f 7472     return jvp_tr
+00013a20: 6163 6564 282a 7072 696d 616c 732c 202a  aced(*primals, *
+00013a30: 7461 6e67 656e 7473 290a 0a0a 2320 564a  tangents)...# VJ
+00013a40: 5020 7472 616e 7366 6f72 6d0a 2320 3d3d  P transform.# ==
+00013a50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 4064 6174  ===========.@dat
+00013a60: 6163 6c61 7373 2866 726f 7a65 6e3d 5472  aclass(frozen=Tr
+00013a70: 7565 290a 636c 6173 7320 564a 5044 7561  ue).class VJPDua
+00013a80: 6c3a 0a20 2020 2022 2222 4120 7061 6972  l:.    """A pair
+00013a90: 206f 6620 7072 696d 616c 2061 6e64 2073   of primal and s
+00013aa0: 6176 6564 2069 6e66 6f72 6d61 7469 6f6e  aved information
+00013ab0: 2066 6f72 2062 6163 6b77 6172 6420 2872   for backward (r
+00013ac0: 6573 6964 7561 6c73 292e 0a0a 2020 2020  esiduals)...    
+00013ad0: 4172 6773 3a0a 2020 2020 2020 2020 7072  Args:.        pr
+00013ae0: 696d 616c 2028 556e 696f 6e5b 5072 6f78  imal (Union[Prox
+00013af0: 792c 204e 756d 6265 725d 293a 2050 7269  y, Number]): Pri
+00013b00: 6d61 6c20 7661 6c75 652c 2069 2e65 2e2c  mal value, i.e.,
+00013b10: 2074 6865 2076 616c 7565 2062 6569 6e67   the value being
+00013b20: 2064 6966 6665 7265 6e74 6961 7465 642e   differentiated.
+00013b30: 0a20 2020 2020 2020 2072 6573 6964 7561  .        residua
+00013b40: 6c73 2028 5475 706c 655b 5072 6f78 792c  ls (Tuple[Proxy,
+00013b50: 202e 2e2e 5d29 3a20 5265 7369 6475 616c   ...]): Residual
+00013b60: 732c 2069 2e65 2e2c 2074 6865 2076 616c  s, i.e., the val
+00013b70: 7565 7320 7468 6174 2061 7265 0a20 2020  ues that are.   
+00013b80: 2020 2020 2020 2020 2073 6176 6564 2066           saved f
+00013b90: 6f72 2074 6865 2062 6163 6b77 6172 642e  or the backward.
+00013ba0: 0a0a 2020 2020 5969 656c 6473 3a0a 2020  ..    Yields:.  
+00013bb0: 2020 2020 2020 5475 706c 655b 5661 7269        Tuple[Vari
+00013bc0: 6162 6c65 2c20 5475 706c 655b 5661 7269  able, Tuple[Vari
+00013bd0: 6162 6c65 2c20 2e2e 2e5d 2c20 4361 6c6c  able, ...], Call
+00013be0: 6162 6c65 5d3a 2050 7269 6d61 6c20 616e  able]: Primal an
+00013bf0: 6420 7265 7369 6475 616c 730a 2020 2020  d residuals.    
+00013c00: 2222 220a 0a20 2020 2070 7269 6d61 6c3a  """..    primal:
+00013c10: 2050 726f 7879 207c 204e 756d 6265 720a   Proxy | Number.
+00013c20: 2020 2020 7265 7369 6475 616c 733a 2074      residuals: t
+00013c30: 7570 6c65 5b50 726f 7879 2c20 2e2e 2e5d  uple[Proxy, ...]
+00013c40: 0a0a 2020 2020 6465 6620 5f5f 6974 6572  ..    def __iter
+00013c50: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
+00013c60: 2020 7969 656c 6420 7365 6c66 2e70 7269    yield self.pri
+00013c70: 6d61 6c0a 2020 2020 2020 2020 7969 656c  mal.        yiel
+00013c80: 6420 7365 6c66 2e72 6573 6964 7561 6c73  d self.residuals
+00013c90: 0a0a 0a63 6c61 7373 204e 6f50 756c 6c62  ...class NoPullb
+00013ca0: 6163 6b3a 0a20 2020 2022 2222 4120 6475  ack:.    """A du
+00013cb0: 6d6d 7920 7075 6c6c 6261 636b 2066 756e  mmy pullback fun
+00013cc0: 6374 696f 6e20 7468 6174 2072 6574 7572  ction that retur
+00013cd0: 6e73 204e 6f6e 6520 6f72 2072 6169 7365  ns None or raise
+00013ce0: 7320 616e 2065 7272 6f72 2e22 2222 0a0a  s an error."""..
+00013cf0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00013d00: 2873 656c 662c 206e 756d 5f61 7267 733d  (self, num_args=
+00013d10: 3029 3a0a 2020 2020 2020 2020 7365 6c66  0):.        self
+00013d20: 2e6e 756d 5f61 7267 7320 3d20 6e75 6d5f  .num_args = num_
+00013d30: 6172 6773 0a0a 2020 2020 6465 6620 5f5f  args..    def __
+00013d40: 6361 6c6c 5f5f 2873 656c 662c 202a 6172  call__(self, *ar
+00013d50: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+00013d60: 2020 2020 2020 2069 6620 7365 6c66 2e6e         if self.n
+00013d70: 756d 5f61 7267 7320 3e20 303a 0a20 2020  um_args > 0:.   
+00013d80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00013d90: 284e 6f6e 652c 2920 2a20 7365 6c66 2e6e  (None,) * self.n
+00013da0: 756d 5f61 7267 730a 2020 2020 2020 2020  um_args.        
+00013db0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
+00013dc0: 6f72 2822 5075 6c6c 6261 636b 2063 616c  or("Pullback cal
+00013dd0: 6c65 6420 6f6e 2061 206e 6f6e 2d64 6966  led on a non-dif
+00013de0: 6665 7265 6e74 6961 626c 6520 7379 6d62  ferentiable symb
+00013df0: 6f6c 206f 7220 6120 636f 6e73 7461 6e74  ol or a constant
+00013e00: 2e22 290a 0a0a 636c 6173 7320 5a65 726f  .")...class Zero
+00013e10: 4261 636b 7761 7264 3a0a 2020 2020 2222  Backward:.    ""
+00013e20: 2241 2068 656c 7065 7220 6261 636b 7761  "A helper backwa
+00013e30: 7264 2066 756e 6374 696f 6e20 7468 6174  rd function that
+00013e40: 2072 6574 7572 6e73 207a 6572 6f73 2e22   returns zeros."
+00013e50: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
+00013e60: 6974 5f5f 2873 656c 662c 206e 756d 5f61  it__(self, num_a
+00013e70: 7267 7329 3a0a 2020 2020 2020 2020 7365  rgs):.        se
+00013e80: 6c66 2e6e 756d 5f61 7267 7320 3d20 6e75  lf.num_args = nu
+00013e90: 6d5f 6172 6773 0a0a 2020 2020 6465 6620  m_args..    def 
+00013ea0: 5f5f 6361 6c6c 5f5f 2873 656c 662c 202a  __call__(self, *
+00013eb0: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
+00013ec0: 0a20 2020 2020 2020 2023 2041 7373 756d  .        # Assum
+00013ed0: 696e 6720 7468 6174 2074 6865 2066 6972  ing that the fir
+00013ee0: 7374 2061 7267 756d 656e 7473 2061 7265  st arguments are
+00013ef0: 2074 6865 2066 6f72 7761 7264 2061 7267   the forward arg
+00013f00: 756d 656e 7473 0a20 2020 2020 2020 2066  uments.        f
+00013f10: 6f72 7761 7264 5f61 7267 7320 3d20 6172  orward_args = ar
+00013f20: 6773 5b3a 2073 656c 662e 6e75 6d5f 6172  gs[: self.num_ar
+00013f30: 6773 5d0a 0a20 2020 2020 2020 2064 6566  gs]..        def
+00013f40: 207a 6572 6f73 5f6c 696b 6528 7829 3a0a   zeros_like(x):.
+00013f50: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00013f60: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
+00013f70: 736f 7250 726f 7879 293a 0a20 2020 2020  sorProxy):.     
+00013f80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00013f90: 6e20 6675 6c6c 5f6c 696b 6528 782c 2066  n full_like(x, f
+00013fa0: 696c 6c5f 7661 6c75 653d 3029 0a20 2020  ill_value=0).   
+00013fb0: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
+00013fc0: 696e 7374 616e 6365 2878 2c20 4e75 6d62  instance(x, Numb
+00013fd0: 6572 5072 6f78 7929 3a0a 2020 2020 2020  erProxy):.      
+00013fe0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00013ff0: 2074 7970 6528 782e 7661 6c75 6529 2830   type(x.value)(0
+00014000: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00014010: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+00014020: 204e 756d 6265 7229 3a0a 2020 2020 2020   Number):.      
+00014030: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00014040: 2074 7970 6528 7829 2830 290a 2020 2020   type(x)(0).    
+00014050: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00014060: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00014070: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00014080: 227a 6572 6f73 5f6c 696b 6520 696e 7369  "zeros_like insi
+00014090: 6465 205a 6572 6f42 6163 6b77 6172 6420  de ZeroBackward 
+000140a0: 676f 7420 616e 2075 6e73 7570 706f 7274  got an unsupport
+000140b0: 6564 2074 7970 6520 7b74 7970 6528 7829  ed type {type(x)
+000140c0: 7d22 290a 0a20 2020 2020 2020 2072 6574  }")..        ret
+000140d0: 7572 6e20 7475 706c 6528 7a65 726f 735f  urn tuple(zeros_
+000140e0: 6c69 6b65 2861 7267 2920 666f 7220 6172  like(arg) for ar
+000140f0: 6720 696e 2066 6f72 7761 7264 5f61 7267  g in forward_arg
+00014100: 7329 0a0a 0a23 204d 6170 7069 6e67 2066  s)...# Mapping f
+00014110: 726f 6d20 7379 6d62 6f6c 7320 746f 2061  rom symbols to a
+00014120: 7567 6d65 6e74 6564 2070 7269 6d61 6c20  ugmented primal 
+00014130: 2866 6f72 7761 7264 2920 6675 6e63 7469  (forward) functi
+00014140: 6f6e 7320 7573 6564 2069 6e20 564a 500a  ons used in VJP.
+00014150: 2320 5468 6520 6175 676d 656e 7465 645f  # The augmented_
+00014160: 7072 696d 616c 2066 756e 6374 696f 6e20  primal function 
+00014170: 7461 6b65 7320 7468 6520 7072 696d 616c  takes the primal
+00014180: 2076 616c 7565 7320 616e 6420 7265 7475   values and retu
+00014190: 726e 7320 7468 6520 7072 696d 616c 0a23  rns the primal.#
+000141a0: 2072 6573 756c 7420 616e 6420 7468 6520   result and the 
+000141b0: 7265 7369 6475 616c 7320 2873 6176 6564  residuals (saved
+000141c0: 2076 616c 7565 7320 666f 7220 7468 6520   values for the 
+000141d0: 6261 636b 7761 7264 292e 0a61 7567 6d65  backward)..augme
+000141e0: 6e74 6564 5f66 6f72 7761 7264 5f69 6d70  nted_forward_imp
+000141f0: 6c73 203d 207b 0a20 2020 2070 7269 6d73  ls = {.    prims
+00014200: 2e50 7269 6d49 4473 2e41 434f 533a 206c  .PrimIDs.ACOS: l
+00014210: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
+00014220: 6163 6f73 2878 292c 2028 782c 2929 2c0a  acos(x), (x,)),.
+00014230: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014240: 732e 4143 4f53 483a 206c 616d 6264 6120  s.ACOSH: lambda 
+00014250: 783a 2028 7072 696d 732e 6163 6f73 6828  x: (prims.acosh(
+00014260: 7829 2c20 2878 2c29 292c 0a20 2020 2070  x), (x,)),.    p
+00014270: 7269 6d73 2e50 7269 6d49 4473 2e41 5349  rims.PrimIDs.ASI
+00014280: 4e3a 206c 616d 6264 6120 783a 2028 7072  N: lambda x: (pr
+00014290: 696d 732e 6173 696e 2878 292c 2028 782c  ims.asin(x), (x,
+000142a0: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+000142b0: 696d 4944 732e 4153 494e 483a 206c 616d  imIDs.ASINH: lam
+000142c0: 6264 6120 783a 2028 7072 696d 732e 6173  bda x: (prims.as
+000142d0: 696e 6828 7829 2c20 2878 2c29 292c 0a20  inh(x), (x,)),. 
+000142e0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+000142f0: 2e41 5441 4e3a 206c 616d 6264 6120 783a  .ATAN: lambda x:
+00014300: 2028 7072 696d 732e 6174 616e 2878 292c   (prims.atan(x),
+00014310: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
+00014320: 732e 5072 696d 4944 732e 4154 414e 483a  s.PrimIDs.ATANH:
+00014330: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
+00014340: 732e 6174 616e 6828 7829 2c20 2878 2c29  s.atanh(x), (x,)
+00014350: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014360: 6d49 4473 2e41 5441 4e32 3a20 6c61 6d62  mIDs.ATAN2: lamb
+00014370: 6461 2078 2c20 793a 2028 7072 696d 732e  da x, y: (prims.
+00014380: 6174 616e 3228 782c 2079 292c 2028 782c  atan2(x, y), (x,
+00014390: 2079 2929 2c0a 2020 2020 7072 696d 732e   y)),.    prims.
+000143a0: 5072 696d 4944 732e 434f 5348 3a20 6c61  PrimIDs.COSH: la
+000143b0: 6d62 6461 2078 3a20 2870 7269 6d73 2e63  mbda x: (prims.c
+000143c0: 6f73 6828 7829 2c20 2878 2c29 292c 0a20  osh(x), (x,)),. 
+000143d0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+000143e0: 2e44 4947 414d 4d41 3a20 6c61 6d62 6461  .DIGAMMA: lambda
+000143f0: 2078 3a20 2870 7269 6d73 2e64 6967 616d   x: (prims.digam
+00014400: 6d61 2878 292c 2028 782c 2929 2c0a 2020  ma(x), (x,)),.  
+00014410: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014420: 4552 4643 3a20 6c61 6d62 6461 2078 3a20  ERFC: lambda x: 
+00014430: 2870 7269 6d73 2e65 7266 6328 7829 2c20  (prims.erfc(x), 
+00014440: 2878 2c29 292c 0a20 2020 2070 7269 6d73  (x,)),.    prims
+00014450: 2e50 7269 6d49 4473 2e45 5246 494e 563a  .PrimIDs.ERFINV:
+00014460: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
+00014470: 732e 6572 6669 6e76 2878 292c 2028 7072  s.erfinv(x), (pr
+00014480: 696d 732e 6572 6669 6e76 2878 292c 2929  ims.erfinv(x),))
+00014490: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+000144a0: 4944 732e 4552 4643 494e 563a 206c 616d  IDs.ERFCINV: lam
+000144b0: 6264 6120 783a 2028 7072 696d 732e 6572  bda x: (prims.er
+000144c0: 6663 696e 7628 7829 2c20 2870 7269 6d73  fcinv(x), (prims
+000144d0: 2e65 7266 6369 6e76 2878 292c 2929 2c0a  .erfcinv(x),)),.
+000144e0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+000144f0: 732e 4558 5032 3a20 6c61 6d62 6461 2078  s.EXP2: lambda x
+00014500: 3a20 2870 7269 6d73 2e65 7870 3228 7829  : (prims.exp2(x)
+00014510: 2c20 2870 7269 6d73 2e65 7870 3228 7829  , (prims.exp2(x)
+00014520: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
+00014530: 7269 6d49 4473 2e45 5850 4d31 3a20 6c61  rimIDs.EXPM1: la
+00014540: 6d62 6461 2078 3a20 2870 7269 6d73 2e65  mbda x: (prims.e
+00014550: 7870 6d31 2878 292c 2028 7072 696d 732e  xpm1(x), (prims.
+00014560: 6578 706d 3128 7829 2c29 292c 0a20 2020  expm1(x),)),.   
+00014570: 2070 7269 6d73 2e50 7269 6d49 4473 2e4c   prims.PrimIDs.L
+00014580: 4741 4d4d 413a 206c 616d 6264 6120 783a  GAMMA: lambda x:
+00014590: 2028 7072 696d 732e 6c67 616d 6d61 2878   (prims.lgamma(x
+000145a0: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
+000145b0: 696d 732e 5072 696d 4944 732e 4e44 5452  ims.PrimIDs.NDTR
+000145c0: 493a 206c 616d 6264 6120 783a 2028 7072  I: lambda x: (pr
+000145d0: 696d 732e 6e64 7472 6928 7829 2c20 2870  ims.ndtri(x), (p
+000145e0: 7269 6d73 2e6e 6474 7269 2878 292c 2929  rims.ndtri(x),))
+000145f0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014600: 4944 732e 5349 4e48 3a20 6c61 6d62 6461  IDs.SINH: lambda
+00014610: 2078 3a20 2870 7269 6d73 2e73 696e 6828   x: (prims.sinh(
+00014620: 7829 2c20 2878 2c29 292c 0a20 2020 2070  x), (x,)),.    p
+00014630: 7269 6d73 2e50 7269 6d49 4473 2e53 5152  rims.PrimIDs.SQR
+00014640: 543a 206c 616d 6264 6120 783a 2028 7072  T: lambda x: (pr
+00014650: 696d 732e 7371 7274 2878 292c 2028 7072  ims.sqrt(x), (pr
+00014660: 696d 732e 7371 7274 2878 292c 2929 2c0a  ims.sqrt(x),)),.
+00014670: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014680: 732e 4e45 3a20 6c61 6d62 6461 2078 2c20  s.NE: lambda x, 
+00014690: 793a 2028 7072 696d 732e 6e65 2878 2c20  y: (prims.ne(x, 
+000146a0: 7929 2c20 2878 2c20 7929 292c 0a20 2020  y), (x, y)),.   
+000146b0: 2070 7269 6d73 2e50 7269 6d49 4473 2e47   prims.PrimIDs.G
+000146c0: 543a 206c 616d 6264 6120 782c 2079 3a20  T: lambda x, y: 
+000146d0: 2870 7269 6d73 2e67 7428 782c 2079 292c  (prims.gt(x, y),
+000146e0: 2028 782c 2079 2929 2c0a 2020 2020 7072   (x, y)),.    pr
+000146f0: 696d 732e 5072 696d 4944 732e 4c45 3a20  ims.PrimIDs.LE: 
+00014700: 6c61 6d62 6461 2078 2c20 793a 2028 7072  lambda x, y: (pr
+00014710: 696d 732e 6c65 2878 2c20 7929 2c20 2878  ims.le(x, y), (x
+00014720: 2c20 7929 292c 0a20 2020 2070 7269 6d73  , y)),.    prims
+00014730: 2e50 7269 6d49 4473 2e4c 4f47 3130 3a20  .PrimIDs.LOG10: 
+00014740: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
+00014750: 2e6c 6f67 3130 2878 292c 2028 782c 2929  .log10(x), (x,))
+00014760: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014770: 4944 732e 4c4f 4731 503a 206c 616d 6264  IDs.LOG1P: lambd
+00014780: 6120 783a 2028 7072 696d 732e 6c6f 6731  a x: (prims.log1
+00014790: 7028 7829 2c20 2878 2c29 292c 0a20 2020  p(x), (x,)),.   
+000147a0: 2070 7269 6d73 2e50 7269 6d49 4473 2e4c   prims.PrimIDs.L
+000147b0: 4f47 323a 206c 616d 6264 6120 783a 2028  OG2: lambda x: (
+000147c0: 7072 696d 732e 6c6f 6732 2878 292c 2028  prims.log2(x), (
+000147d0: 782c 2929 2c0a 2020 2020 7072 696d 732e  x,)),.    prims.
+000147e0: 5072 696d 4944 732e 5a45 5441 3a20 6c61  PrimIDs.ZETA: la
+000147f0: 6d62 6461 2078 2c20 793a 2028 7072 696d  mbda x, y: (prim
+00014800: 732e 7a65 7461 2878 2c20 7929 2c20 2878  s.zeta(x, y), (x
+00014810: 2c20 7929 292c 0a20 2020 2070 7269 6d73  , y)),.    prims
+00014820: 2e50 7269 6d49 4473 2e46 4d4f 443a 206c  .PrimIDs.FMOD: l
+00014830: 616d 6264 6120 782c 2079 3a20 2870 7269  ambda x, y: (pri
+00014840: 6d73 2e66 6d6f 6428 782c 2079 292c 2028  ms.fmod(x, y), (
+00014850: 782c 2079 2929 2c0a 2020 2020 7072 696d  x, y)),.    prim
+00014860: 732e 5072 696d 4944 732e 434f 5059 5f3a  s.PrimIDs.COPY_:
+00014870: 206c 616d 6264 6120 782c 2079 3a20 2870   lambda x, y: (p
+00014880: 7269 6d73 2e63 6f70 795f 2878 2c20 7929  rims.copy_(x, y)
+00014890: 2c20 7475 706c 6528 2929 2c0a 7d0a 0a0a  , tuple()),.}...
+000148a0: 2320 4d61 7070 696e 6720 6672 6f6d 2073  # Mapping from s
+000148b0: 796d 626f 6c73 2074 6f20 6261 636b 7761  ymbols to backwa
+000148c0: 7264 2066 756e 6374 696f 6e73 2075 7365  rd functions use
+000148d0: 6420 696e 2056 4a50 0a23 2054 6865 2062  d in VJP.# The b
+000148e0: 6163 6b77 6172 6420 6675 6e63 7469 6f6e  ackward function
+000148f0: 2074 616b 6573 2074 6865 2072 6573 6964   takes the resid
+00014900: 7561 6c73 2061 6e64 2063 6f74 616e 6765  uals and cotange
+00014910: 6e74 7320 616e 6420 7265 7475 726e 7320  nts and returns 
+00014920: 7468 650a 2320 7665 6374 6f72 2d4a 6163  the.# vector-Jac
+00014930: 6f62 6961 6e20 7072 6f64 7563 7473 2066  obian products f
+00014940: 6f72 2065 6163 6820 6172 6775 6d65 6e74  or each argument
+00014950: 2e0a 6261 636b 7761 7264 5f69 6d70 6c73  ..backward_impls
+00014960: 203d 207b 0a20 2020 2070 7269 6d73 2e50   = {.    prims.P
+00014970: 7269 6d49 4473 2e41 434f 533a 206c 616d  rimIDs.ACOS: lam
+00014980: 6264 6120 782c 2067 3a20 2d67 202f 2070  bda x, g: -g / p
+00014990: 7269 6d73 2e73 7172 7428 312e 3020 2d20  rims.sqrt(1.0 - 
+000149a0: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
+000149b0: 732e 5072 696d 4944 732e 4143 4f53 483a  s.PrimIDs.ACOSH:
+000149c0: 206c 616d 6264 6120 782c 2067 3a20 6720   lambda x, g: g 
+000149d0: 2a20 7072 696d 732e 7273 7172 7428 7820  * prims.rsqrt(x 
+000149e0: 2a20 7820 2d20 312e 3029 2c0a 2020 2020  * x - 1.0),.    
+000149f0: 7072 696d 732e 5072 696d 4944 732e 4153  prims.PrimIDs.AS
+00014a00: 494e 3a20 6c61 6d62 6461 2078 2c20 673a  IN: lambda x, g:
+00014a10: 2067 202f 2070 7269 6d73 2e73 7172 7428   g / prims.sqrt(
+00014a20: 312e 3020 2d20 7820 2a20 7829 2c0a 2020  1.0 - x * x),.  
+00014a30: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014a40: 4153 494e 483a 206c 616d 6264 6120 782c  ASINH: lambda x,
+00014a50: 2067 3a20 6720 2a20 7072 696d 732e 7273   g: g * prims.rs
+00014a60: 7172 7428 312e 3020 2b20 7820 2a20 7829  qrt(1.0 + x * x)
+00014a70: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014a80: 4944 732e 4154 414e 3a20 6c61 6d62 6461  IDs.ATAN: lambda
+00014a90: 2078 2c20 673a 2067 202f 2028 312e 3020   x, g: g / (1.0 
+00014aa0: 2b20 7820 2a20 7829 2c0a 2020 2020 7072  + x * x),.    pr
+00014ab0: 696d 732e 5072 696d 4944 732e 4154 414e  ims.PrimIDs.ATAN
+00014ac0: 483a 206c 616d 6264 6120 782c 2067 3a20  H: lambda x, g: 
+00014ad0: 6720 2f20 2831 2e30 202d 2078 202a 2078  g / (1.0 - x * x
+00014ae0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014af0: 6d49 4473 2e43 4f53 483a 206c 616d 6264  mIDs.COSH: lambd
+00014b00: 6120 782c 2067 3a20 7072 696d 732e 6d75  a x, g: prims.mu
+00014b10: 6c28 672c 2070 7269 6d73 2e73 696e 6828  l(g, prims.sinh(
+00014b20: 7829 292c 0a20 2020 2070 7269 6d73 2e50  x)),.    prims.P
+00014b30: 7269 6d49 4473 2e45 5246 433a 206c 616d  rimIDs.ERFC: lam
+00014b40: 6264 6120 782c 2067 3a20 2d67 202a 2032  bda x, g: -g * 2
+00014b50: 2e30 202f 206d 6174 682e 7371 7274 286d  .0 / math.sqrt(m
+00014b60: 6174 682e 7069 2920 2a20 7072 696d 732e  ath.pi) * prims.
+00014b70: 6578 7028 2d78 202a 2078 292c 0a20 2020  exp(-x * x),.   
+00014b80: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
+00014b90: 5246 494e 563a 206c 616d 6264 6120 7265  RFINV: lambda re
+00014ba0: 7375 6c74 2c20 673a 2067 202a 2030 2e35  sult, g: g * 0.5
+00014bb0: 202a 206d 6174 682e 7371 7274 286d 6174   * math.sqrt(mat
+00014bc0: 682e 7069 2920 2a20 7072 696d 732e 6578  h.pi) * prims.ex
+00014bd0: 7028 7265 7375 6c74 2a2a 3229 2c0a 2020  p(result**2),.  
+00014be0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014bf0: 4552 4643 494e 563a 206c 616d 6264 6120  ERFCINV: lambda 
+00014c00: 7265 7375 6c74 2c20 673a 202d 6720 2a20  result, g: -g * 
+00014c10: 302e 3520 2a20 6d61 7468 2e73 7172 7428  0.5 * math.sqrt(
+00014c20: 6d61 7468 2e70 6929 202a 2070 7269 6d73  math.pi) * prims
+00014c30: 2e65 7870 2872 6573 756c 742a 2a32 292c  .exp(result**2),
+00014c40: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00014c50: 4473 2e45 5850 323a 206c 616d 6264 6120  Ds.EXP2: lambda 
+00014c60: 7265 7375 6c74 2c20 673a 2067 202a 2072  result, g: g * r
+00014c70: 6573 756c 7420 2a20 6d61 7468 2e6c 6f67  esult * math.log
+00014c80: 2832 2e30 292c 0a20 2020 2070 7269 6d73  (2.0),.    prims
+00014c90: 2e50 7269 6d49 4473 2e45 5850 4d31 3a20  .PrimIDs.EXPM1: 
+00014ca0: 6c61 6d62 6461 2072 6573 756c 742c 2067  lambda result, g
+00014cb0: 3a20 6720 2a20 2872 6573 756c 7420 2b20  : g * (result + 
+00014cc0: 312e 3029 2c0a 2020 2020 7072 696d 732e  1.0),.    prims.
+00014cd0: 5072 696d 4944 732e 4c47 414d 4d41 3a20  PrimIDs.LGAMMA: 
+00014ce0: 6c61 6d62 6461 2078 2c20 673a 2067 202a  lambda x, g: g *
+00014cf0: 2070 7269 6d73 2e64 6967 616d 6d61 2878   prims.digamma(x
+00014d00: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014d10: 6d49 4473 2e4e 4454 5249 3a20 6c61 6d62  mIDs.NDTRI: lamb
+00014d20: 6461 2072 6573 756c 742c 2067 3a20 6720  da result, g: g 
+00014d30: 2a20 7072 696d 732e 6578 7028 302e 3520  * prims.exp(0.5 
+00014d40: 2a20 7265 7375 6c74 2a2a 3229 202a 206d  * result**2) * m
+00014d50: 6174 682e 7371 7274 2832 2e30 202a 206d  ath.sqrt(2.0 * m
+00014d60: 6174 682e 7069 292c 0a20 2020 2070 7269  ath.pi),.    pri
+00014d70: 6d73 2e50 7269 6d49 4473 2e53 494e 483a  ms.PrimIDs.SINH:
+00014d80: 206c 616d 6264 6120 782c 2067 3a20 7072   lambda x, g: pr
+00014d90: 696d 732e 6d75 6c28 672c 2070 7269 6d73  ims.mul(g, prims
+00014da0: 2e63 6f73 6828 7829 292c 0a20 2020 2070  .cosh(x)),.    p
+00014db0: 7269 6d73 2e50 7269 6d49 4473 2e53 5152  rims.PrimIDs.SQR
+00014dc0: 543a 206c 616d 6264 6120 7265 7375 6c74  T: lambda result
+00014dd0: 2c20 673a 2067 202f 2028 322e 3020 2a20  , g: g / (2.0 * 
+00014de0: 7265 7375 6c74 292c 0a20 2020 2070 7269  result),.    pri
+00014df0: 6d73 2e50 7269 6d49 4473 2e4e 453a 205a  ms.PrimIDs.NE: Z
+00014e00: 6572 6f42 6163 6b77 6172 6428 6e75 6d5f  eroBackward(num_
+00014e10: 6172 6773 3d32 292c 0a20 2020 2070 7269  args=2),.    pri
+00014e20: 6d73 2e50 7269 6d49 4473 2e47 543a 205a  ms.PrimIDs.GT: Z
+00014e30: 6572 6f42 6163 6b77 6172 6428 6e75 6d5f  eroBackward(num_
+00014e40: 6172 6773 3d32 292c 0a20 2020 2070 7269  args=2),.    pri
+00014e50: 6d73 2e50 7269 6d49 4473 2e4c 453a 205a  ms.PrimIDs.LE: Z
+00014e60: 6572 6f42 6163 6b77 6172 6428 6e75 6d5f  eroBackward(num_
+00014e70: 6172 6773 3d32 292c 0a20 2020 2070 7269  args=2),.    pri
+00014e80: 6d73 2e50 7269 6d49 4473 2e4c 4f47 3130  ms.PrimIDs.LOG10
+00014e90: 3a20 6c61 6d62 6461 2078 2c20 673a 2067  : lambda x, g: g
+00014ea0: 202f 2028 7820 2a20 322e 3330 3235 3835   / (x * 2.302585
+00014eb0: 3039 3239 3934 3034 3629 2c0a 2020 2020  092994046),.    
+00014ec0: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
+00014ed0: 4731 503a 206c 616d 6264 6120 782c 2067  G1P: lambda x, g
+00014ee0: 3a20 6720 2f20 2878 202b 2031 292c 0a20  : g / (x + 1),. 
+00014ef0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014f00: 2e4c 4f47 323a 206c 616d 6264 6120 782c  .LOG2: lambda x,
+00014f10: 2067 3a20 6720 2f20 2878 202a 2030 2e36   g: g / (x * 0.6
+00014f20: 3933 3134 3731 3830 3535 3939 3435 3329  931471805599453)
+00014f30: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014f40: 4944 732e 464d 4f44 3a20 6c61 6d62 6461  IDs.FMOD: lambda
+00014f50: 2078 2c20 792c 2067 3a20 2867 2c20 2d67   x, y, g: (g, -g
+00014f60: 202a 2070 7269 6d73 2e74 7275 6e63 2878   * prims.trunc(x
+00014f70: 202f 2079 2929 2c0a 2020 2020 2320 5468   / y)),.    # Th
+00014f80: 6520 636f 7079 2073 686f 756c 6420 6e6f  e copy should no
+00014f90: 7420 6265 2064 6966 6665 7265 6e74 6961  t be differentia
+00014fa0: 626c 652e 2057 6520 7265 7475 726e 204e  ble. We return N
+00014fb0: 6f6e 6520 746f 2065 6e61 626c 6520 7468  one to enable th
+00014fc0: 6520 6765 6e65 7261 7469 6f6e 206f 6620  e generation of 
+00014fd0: 7468 6520 6261 636b 7761 7264 2067 7261  the backward gra
+00014fe0: 7068 2074 6872 6f75 6768 2074 6865 6d2e  ph through them.
+00014ff0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00015000: 4473 2e43 4f50 595f 3a20 6c61 6d62 6461  Ds.COPY_: lambda
+00015010: 2067 3a20 284e 6f6e 652c 204e 6f6e 6529   g: (None, None)
+00015020: 2c0a 7d0a 0a0a 6465 6620 7265 6769 7374  ,.}...def regist
+00015030: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
+00015040: 7761 7264 286f 7029 3a0a 2020 2020 2222  ward(op):.    ""
+00015050: 2244 6563 6f72 6174 6f72 2074 6f20 7265  "Decorator to re
+00015060: 6769 7374 6572 2061 6e20 6175 676d 656e  gister an augmen
+00015070: 7465 6420 666f 7277 6172 6420 696d 706c  ted forward impl
+00015080: 656d 656e 7461 7469 6f6e 2066 6f72 2061  ementation for a
+00015090: 2073 796d 626f 6c2e 0a0a 2020 2020 4172   symbol...    Ar
+000150a0: 6773 3a0a 2020 2020 2020 2020 6f70 2028  gs:.        op (
+000150b0: 4f70 7329 3a20 5379 6d62 6f6c 2066 6f72  Ops): Symbol for
+000150c0: 2077 6869 6368 2074 6f20 7265 6769 7374   which to regist
+000150d0: 6572 2074 6865 2061 7567 6d65 6e74 6564  er the augmented
+000150e0: 2066 6f72 7761 7264 2069 6d70 6c65 6d65   forward impleme
+000150f0: 6e74 6174 696f 6e2e 0a0a 2020 2020 5265  ntation...    Re
+00015100: 7475 726e 733a 0a20 2020 2020 2020 2043  turns:.        C
+00015110: 616c 6c61 626c 653a 2044 6563 6f72 6174  allable: Decorat
+00015120: 6f72 2066 756e 6374 696f 6e2e 0a20 2020  or function..   
+00015130: 2022 2222 0a0a 2020 2020 6465 6620 6465   """..    def de
+00015140: 636f 7261 746f 7228 6675 6e63 293a 0a20  corator(func):. 
+00015150: 2020 2020 2020 2061 7567 6d65 6e74 6564         augmented
+00015160: 5f66 6f72 7761 7264 5f69 6d70 6c73 5b6f  _forward_impls[o
+00015170: 705d 203d 2066 756e 630a 2020 2020 2020  p] = func.      
+00015180: 2020 7265 7475 726e 2066 756e 630a 0a20    return func.. 
+00015190: 2020 2072 6574 7572 6e20 6465 636f 7261     return decora
+000151a0: 746f 720a 0a0a 6465 6620 7265 6769 7374  tor...def regist
+000151b0: 6572 5f62 6163 6b77 6172 6428 6f70 293a  er_backward(op):
+000151c0: 0a20 2020 2022 2222 4465 636f 7261 746f  .    """Decorato
+000151d0: 7220 746f 2072 6567 6973 7465 7220 6120  r to register a 
+000151e0: 6261 636b 7761 7264 2069 6d70 6c65 6d65  backward impleme
+000151f0: 6e74 6174 696f 6e20 666f 7220 6120 7379  ntation for a sy
+00015200: 6d62 6f6c 2e0a 0a20 2020 2041 7267 733a  mbol...    Args:
+00015210: 0a20 2020 2020 2020 206f 7020 284f 7073  .        op (Ops
+00015220: 293a 2053 796d 626f 6c20 666f 7220 7768  ): Symbol for wh
+00015230: 6963 6820 746f 2072 6567 6973 7465 7220  ich to register 
+00015240: 7468 6520 6261 636b 7761 7264 2069 6d70  the backward imp
+00015250: 6c65 6d65 6e74 6174 696f 6e2e 0a0a 2020  lementation...  
+00015260: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+00015270: 2020 2043 616c 6c61 626c 653a 2044 6563     Callable: Dec
+00015280: 6f72 6174 6f72 2066 756e 6374 696f 6e2e  orator function.
+00015290: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+000152a0: 6620 6465 636f 7261 746f 7228 6675 6e63  f decorator(func
+000152b0: 293a 0a20 2020 2020 2020 2062 6163 6b77  ):.        backw
+000152c0: 6172 645f 696d 706c 735b 6f70 5d20 3d20  ard_impls[op] = 
+000152d0: 6675 6e63 0a20 2020 2020 2020 2072 6574  func.        ret
+000152e0: 7572 6e20 6675 6e63 0a0a 2020 2020 7265  urn func..    re
+000152f0: 7475 726e 2064 6563 6f72 6174 6f72 0a0a  turn decorator..
+00015300: 0a64 6566 2072 6573 746f 7265 5f72 6564  .def restore_red
+00015310: 7563 6564 5f64 696d 7328 782c 2072 6564  uced_dims(x, red
+00015320: 7563 6564 5f64 696d 732c 206f 7269 6769  uced_dims, origi
+00015330: 6e61 6c5f 7368 6170 6529 3a0a 2020 2020  nal_shape):.    
+00015340: 2222 2252 6573 746f 7265 7320 7468 6520  """Restores the 
+00015350: 7265 6475 6365 6420 6469 6d65 6e73 696f  reduced dimensio
+00015360: 6e73 206f 6620 6120 7465 6e73 6f72 2e0a  ns of a tensor..
+00015370: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00015380: 2020 2078 2028 5661 7269 6162 6c65 293a     x (Variable):
+00015390: 2054 656e 736f 7220 746f 2062 6520 7265   Tensor to be re
+000153a0: 7368 6170 6564 2e0a 2020 2020 2020 2020  shaped..        
+000153b0: 7265 6475 6365 645f 6469 6d73 2028 5475  reduced_dims (Tu
+000153c0: 706c 655b 696e 742c 202e 2e2e 5d29 3a20  ple[int, ...]): 
+000153d0: 5475 706c 6520 6f66 2072 6564 7563 6564  Tuple of reduced
+000153e0: 2064 696d 656e 7369 6f6e 732e 0a20 2020   dimensions..   
+000153f0: 2020 2020 206f 7269 6769 6e61 6c5f 7368       original_sh
+00015400: 6170 6520 2854 7570 6c65 5b69 6e74 2c20  ape (Tuple[int, 
+00015410: 2e2e 2e5d 293a 204f 7269 6769 6e61 6c20  ...]): Original 
+00015420: 7368 6170 6520 6f66 2074 6865 2074 656e  shape of the ten
+00015430: 736f 722e 0a0a 2020 2020 5265 7475 726e  sor...    Return
+00015440: 733a 0a20 2020 2020 2020 2056 6172 6961  s:.        Varia
+00015450: 626c 653a 2054 656e 736f 7220 7769 7468  ble: Tensor with
+00015460: 2074 6865 2072 6564 7563 6564 2064 696d   the reduced dim
+00015470: 656e 7369 6f6e 7320 7265 7374 6f72 6564  ensions restored
+00015480: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+00015490: 206f 7269 6769 6e61 6c5f 7368 6170 6520   original_shape 
+000154a0: 3d3d 2028 293a 2020 2320 7363 616c 6172  == ():  # scalar
+000154b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000154c0: 780a 0a20 2020 2075 6e73 7175 6565 7a65  x..    unsqueeze
+000154d0: 6420 3d20 636c 616e 672e 756e 7371 7565  d = clang.unsque
+000154e0: 657a 6528 782c 2072 6564 7563 6564 5f64  eze(x, reduced_d
+000154f0: 696d 7329 0a20 2020 2072 6574 7572 6e20  ims).    return 
+00015500: 636c 616e 672e 6578 7061 6e64 2875 6e73  clang.expand(uns
+00015510: 7175 6565 7a65 642c 206f 7269 6769 6e61  queezed, origina
+00015520: 6c5f 7368 6170 6529 0a0a 0a40 7265 6769  l_shape)...@regi
+00015530: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
+00015540: 696d 732e 5072 696d 4944 732e 5a45 5441  ims.PrimIDs.ZETA
+00015550: 290a 6465 6620 7a65 7461 5f62 6163 6b77  ).def zeta_backw
+00015560: 6172 6428 782c 2079 2c20 6729 3a0a 2020  ard(x, y, g):.  
+00015570: 2020 2320 5468 6520 6465 7269 7661 7469    # The derivati
+00015580: 7665 2077 7274 2074 6865 2066 6972 7374  ve wrt the first
+00015590: 2061 7267 756d 656e 7420 6973 206e 6f74   argument is not
+000155a0: 2065 7870 7265 7373 6962 6c65 2069 6e20   expressible in 
+000155b0: 7465 726d 7320 6f66 207a 6574 6120 6f72  terms of zeta or
+000155c0: 0a20 2020 2023 206f 7468 6572 2073 7065  .    # other spe
+000155d0: 6369 616c 2066 756e 6374 696f 6e73 0a20  cial functions. 
+000155e0: 2020 2023 2054 6865 7265 666f 7265 2c20     # Therefore, 
+000155f0: 7765 2063 6f6d 7075 7465 206f 6e6c 7920  we compute only 
+00015600: 7468 6520 6465 7269 7661 7469 7665 2077  the derivative w
+00015610: 7274 2074 6865 2073 6563 6f6e 6420 6172  rt the second ar
+00015620: 6775 6d65 6e74 0a20 2020 2067 7920 3d20  gument.    gy = 
+00015630: 6720 2a20 2d78 202a 2070 7269 6d73 2e7a  g * -x * prims.z
+00015640: 6574 6128 7820 2b20 312e 302c 2079 290a  eta(x + 1.0, y).
+00015650: 0a20 2020 2023 2052 6574 7572 6e20 6120  .    # Return a 
+00015660: 6d61 7070 7069 6e67 2066 726f 6d20 7468  mappping from th
+00015670: 6520 666f 7277 6172 6420 6172 6775 6d65  e forward argume
+00015680: 6e74 7320 746f 2074 6865 2067 7261 6469  nts to the gradi
+00015690: 656e 7473 0a20 2020 2072 6574 7572 6e20  ents.    return 
+000156a0: 7b22 7922 3a20 6779 7d0a 0a0a 4072 6567  {"y": gy}...@reg
+000156b0: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
+000156c0: 7269 6d73 2e50 7269 6d49 4473 2e44 4947  rims.PrimIDs.DIG
+000156d0: 414d 4d41 290a 6465 6620 6469 6761 6d6d  AMMA).def digamm
+000156e0: 615f 6261 636b 7761 7264 2861 3a20 5072  a_backward(a: Pr
+000156f0: 6f78 792c 2067 293a 0a20 2020 2066 726f  oxy, g):.    fro
+00015700: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
+00015710: 696d 706f 7274 2070 6f6c 7967 616d 6d61  import polygamma
+00015720: 0a0a 2020 2020 7265 7475 726e 2067 202a  ..    return g *
+00015730: 2070 6f6c 7967 616d 6d61 2831 2c20 6129   polygamma(1, a)
+00015740: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
+00015750: 6d65 6e74 6564 5f66 6f72 7761 7264 2822  mented_forward("
+00015760: 746f 7263 682e 706f 6c79 6761 6d6d 6122  torch.polygamma"
+00015770: 290a 6465 6620 706f 6c79 6761 6d6d 615f  ).def polygamma_
+00015780: 6175 675f 6677 6428 6e3a 2069 6e74 2c20  aug_fwd(n: int, 
+00015790: 613a 2050 726f 7879 293a 0a20 2020 2066  a: Proxy):.    f
+000157a0: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
+000157b0: 6820 696d 706f 7274 2070 6f6c 7967 616d  h import polygam
+000157c0: 6d61 0a0a 2020 2020 7072 696d 616c 203d  ma..    primal =
+000157d0: 2070 6f6c 7967 616d 6d61 286e 2c20 6129   polygamma(n, a)
+000157e0: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
+000157f0: 2028 6e2c 2061 290a 2020 2020 7265 7475   (n, a).    retu
+00015800: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
+00015810: 6c2c 2072 6573 6964 7561 6c73 290a 0a0a  l, residuals)...
+00015820: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
+00015830: 7264 2822 746f 7263 682e 706f 6c79 6761  rd("torch.polyga
+00015840: 6d6d 6122 290a 6465 6620 706f 6c79 6761  mma").def polyga
+00015850: 6d6d 615f 6261 636b 7761 7264 286e 3a20  mma_backward(n: 
+00015860: 696e 742c 2061 3a20 5072 6f78 792c 2067  int, a: Proxy, g
+00015870: 293a 0a20 2020 2066 726f 6d20 7468 756e  ):.    from thun
+00015880: 6465 722e 746f 7263 6820 696d 706f 7274  der.torch import
+00015890: 2070 6f6c 7967 616d 6d61 0a0a 2020 2020   polygamma..    
+000158a0: 7265 7475 726e 204e 6f6e 652c 2067 202a  return None, g *
+000158b0: 2070 6f6c 7967 616d 6d61 286e 202b 2031   polygamma(n + 1
+000158c0: 2c20 6129 0a0a 0a40 7265 6769 7374 6572  , a)...@register
+000158d0: 5f62 6163 6b77 6172 6428 7072 696d 732e  _backward(prims.
+000158e0: 5072 696d 4944 732e 4154 414e 3229 0a64  PrimIDs.ATAN2).d
+000158f0: 6566 2061 7461 6e32 5f62 6163 6b77 6172  ef atan2_backwar
+00015900: 6428 782c 2079 2c20 6729 3a0a 2020 2020  d(x, y, g):.    
+00015910: 616c 7068 6120 3d20 312e 3020 2f20 2878  alpha = 1.0 / (x
+00015920: 202a 2078 202b 2079 202a 2079 290a 2020   * x + y * y).  
+00015930: 2020 6772 6164 5f78 203d 2067 202a 2079    grad_x = g * y
+00015940: 202a 2061 6c70 6861 0a20 2020 2067 7261   * alpha.    gra
+00015950: 645f 7920 3d20 6720 2a20 2d78 202a 2061  d_y = g * -x * a
+00015960: 6c70 6861 0a20 2020 2072 6574 7572 6e20  lpha.    return 
+00015970: 6772 6164 5f78 2c20 6772 6164 5f79 0a0a  grad_x, grad_y..
+00015980: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
+00015990: 6e74 6564 5f66 6f72 7761 7264 2870 7269  nted_forward(pri
+000159a0: 6d73 2e50 7269 6d49 4473 2e56 4152 290a  ms.PrimIDs.VAR).
+000159b0: 6465 6620 7661 725f 6175 675f 6677 6428  def var_aug_fwd(
+000159c0: 612c 2064 696d 2c20 2a2c 2063 6f72 7265  a, dim, *, corre
+000159d0: 6374 696f 6e29 3a0a 2020 2020 7620 3d20  ction):.    v = 
+000159e0: 7072 696d 732e 7661 7228 612c 2064 696d  prims.var(a, dim
+000159f0: 2c20 636f 7272 6563 7469 6f6e 3d63 6f72  , correction=cor
+00015a00: 7265 6374 696f 6e29 0a20 2020 2072 6574  rection).    ret
+00015a10: 7572 6e20 564a 5044 7561 6c28 2876 2c29  urn VJPDual((v,)
+00015a20: 2c20 2861 2c20 6469 6d2c 2063 6f72 7265  , (a, dim, corre
+00015a30: 6374 696f 6e2c 2076 2929 0a0a 0a23 2054  ction, v))...# T
+00015a40: 4f44 4f3a 2066 6978 2064 6976 6973 696f  ODO: fix divisio
+00015a50: 6e20 6279 207a 6572 6f20 7768 656e 206e  n by zero when n
+00015a60: 5f65 6c65 6d5f 7265 6475 6365 6420 3d3d  _elem_reduced ==
+00015a70: 2030 206f 7220 7768 656e 2076 2e6e 756d   0 or when v.num
+00015a80: 656c 203d 3d20 300a 2320 6279 2072 6574  el == 0.# by ret
+00015a90: 7572 6e69 6e67 207a 6572 6f73 5f6c 696b  urning zeros_lik
+00015aa0: 6528 6129 206f 7220 7369 6d69 6c61 722e  e(a) or similar.
+00015ab0: 0a23 2054 4f44 4f3a 2066 6978 2067 7261  .# TODO: fix gra
+00015ac0: 6420 7768 656e 2063 6f72 7265 6374 696f  d when correctio
+00015ad0: 6e20 3e20 6e5f 656c 656d 5f72 6564 7563  n > n_elem_reduc
+00015ae0: 6564 2e0a 4072 6567 6973 7465 725f 6261  ed..@register_ba
+00015af0: 636b 7761 7264 2870 7269 6d73 2e50 7269  ckward(prims.Pri
+00015b00: 6d49 4473 2e56 4152 290a 6465 6620 7661  mIDs.VAR).def va
+00015b10: 725f 6261 636b 7761 7264 2861 2c20 6469  r_backward(a, di
+00015b20: 6d2c 2063 6f72 7265 6374 696f 6e2c 2076  m, correction, v
+00015b30: 2c20 6729 3a0a 2020 2020 6e5f 656c 656d  , g):.    n_elem
+00015b40: 5f72 6564 7563 6564 203d 2061 2e6e 756d  _reduced = a.num
+00015b50: 656c 202f 2f20 762e 6e75 6d65 6c20 6966  el // v.numel if
+00015b60: 2061 2e6e 756d 656c 2021 3d20 3020 656c   a.numel != 0 el
+00015b70: 7365 2031 0a20 2020 206e 6f72 6d61 6c69  se 1.    normali
+00015b80: 7a61 7469 6f6e 5f73 6361 6c61 7220 3d20  zation_scalar = 
+00015b90: 6e5f 656c 656d 5f72 6564 7563 6564 202d  n_elem_reduced -
+00015ba0: 2063 6f72 7265 6374 696f 6e0a 2020 2020   correction.    
+00015bb0: 6720 3d20 7265 7374 6f72 655f 7265 6475  g = restore_redu
+00015bc0: 6365 645f 6469 6d73 2867 2c20 6469 6d2c  ced_dims(g, dim,
+00015bd0: 2061 2e73 6861 7065 290a 2020 2020 6966   a.shape).    if
+00015be0: 2061 2e64 7479 7065 2021 3d20 762e 6474   a.dtype != v.dt
+00015bf0: 7970 653a 0a20 2020 2020 2020 2061 203d  ype:.        a =
+00015c00: 2070 7269 6d73 2e63 6f6e 7665 7274 5f65   prims.convert_e
+00015c10: 6c65 6d65 6e74 5f74 7970 6528 612c 2076  lement_type(a, v
+00015c20: 2e64 7479 7065 290a 2020 2020 6d65 616e  .dtype).    mean
+00015c30: 203d 2070 7269 6d73 2e73 756d 2861 2c20   = prims.sum(a, 
+00015c40: 6469 6d29 202f 206e 5f65 6c65 6d5f 7265  dim) / n_elem_re
+00015c50: 6475 6365 640a 2020 2020 6d65 616e 203d  duced.    mean =
+00015c60: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
+00015c70: 5f64 696d 7328 6d65 616e 2c20 6469 6d2c  _dims(mean, dim,
+00015c80: 2061 2e73 6861 7065 290a 2020 2020 7265   a.shape).    re
+00015c90: 7475 726e 2028 3220 2a20 6720 2a20 2861  turn (2 * g * (a
+00015ca0: 202d 206d 6561 6e29 2920 2f20 6e6f 726d   - mean)) / norm
+00015cb0: 616c 697a 6174 696f 6e5f 7363 616c 6172  alization_scalar
+00015cc0: 0a0a 0a64 6566 206e 5f65 6c65 6d5f 7265  ...def n_elem_re
+00015cd0: 6475 6365 6428 615f 6e64 696d 2c20 615f  duced(a_ndim, a_
+00015ce0: 7368 6170 652c 2064 696d 7329 3a0a 2020  shape, dims):.  
+00015cf0: 2020 6469 6d73 203d 2075 7469 6c73 2e63    dims = utils.c
+00015d00: 616e 6f6e 6963 616c 697a 655f 6469 6d73  anonicalize_dims
+00015d10: 2861 5f6e 6469 6d2c 2064 696d 7329 0a20  (a_ndim, dims). 
+00015d20: 2020 2072 6564 7563 7469 6f6e 5f73 697a     reduction_siz
+00015d30: 6520 3d20 310a 2020 2020 666f 7220 6964  e = 1.    for id
+00015d40: 782c 2073 697a 6520 696e 2065 6e75 6d65  x, size in enume
+00015d50: 7261 7465 2861 5f73 6861 7065 293a 0a20  rate(a_shape):. 
+00015d60: 2020 2020 2020 2069 6620 6964 7820 696e         if idx in
+00015d70: 2064 696d 733a 0a20 2020 2020 2020 2020   dims:.         
+00015d80: 2020 2072 6564 7563 7469 6f6e 5f73 697a     reduction_siz
+00015d90: 6520 2a3d 2073 697a 650a 2020 2020 7265  e *= size.    re
+00015da0: 7475 726e 2072 6564 7563 7469 6f6e 5f73  turn reduction_s
+00015db0: 697a 650a 0a0a 6465 6620 6d65 616e 5f62  ize...def mean_b
+00015dc0: 6163 6b77 6172 6428 615f 6e64 696d 2c20  ackward(a_ndim, 
+00015dd0: 615f 7368 6170 652c 2064 696d 732c 2067  a_shape, dims, g
+00015de0: 7261 6429 3a0a 2020 2020 6d65 616e 5f6c  rad):.    mean_l
+00015df0: 6f63 616c 5f67 7261 6420 3d20 312e 3020  ocal_grad = 1.0 
+00015e00: 2f20 6e5f 656c 656d 5f72 6564 7563 6564  / n_elem_reduced
+00015e10: 2861 5f6e 6469 6d2c 2061 5f73 6861 7065  (a_ndim, a_shape
+00015e20: 2c20 6469 6d73 290a 2020 2020 7265 7475  , dims).    retu
+00015e30: 726e 2072 6573 746f 7265 5f72 6564 7563  rn restore_reduc
+00015e40: 6564 5f64 696d 7328 6772 6164 2c20 6469  ed_dims(grad, di
+00015e50: 6d73 2c20 615f 7368 6170 6529 202a 206d  ms, a_shape) * m
+00015e60: 6561 6e5f 6c6f 6361 6c5f 6772 6164 0a0a  ean_local_grad..
+00015e70: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
+00015e80: 6e74 6564 5f66 6f72 7761 7264 2870 7269  nted_forward(pri
+00015e90: 6d73 2e50 7269 6d49 4473 2e50 4144 290a  ms.PrimIDs.PAD).
+00015ea0: 6465 6620 7061 645f 6175 675f 6677 6428  def pad_aug_fwd(
+00015eb0: 612c 2070 6164 6469 6e67 5f76 616c 7565  a, padding_value
+00015ec0: 2c20 7061 6464 696e 675f 636f 6e66 6967  , padding_config
+00015ed0: 293a 0a20 2020 2072 6574 7572 6e20 564a  ):.    return VJ
+00015ee0: 5044 7561 6c28 2870 7269 6d73 2e70 6164  PDual((prims.pad
+00015ef0: 2861 2c20 7061 6464 696e 675f 7661 6c75  (a, padding_valu
+00015f00: 652c 2070 6164 6469 6e67 5f63 6f6e 6669  e, padding_confi
+00015f10: 6729 2c29 2c20 2861 2c20 7061 6464 696e  g),), (a, paddin
+00015f20: 675f 636f 6e66 6967 2929 0a0a 0a40 7265  g_config))...@re
+00015f30: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00015f40: 7072 696d 732e 5072 696d 4944 732e 5041  prims.PrimIDs.PA
+00015f50: 4429 0a64 6566 2070 6164 5f62 6163 6b77  D).def pad_backw
+00015f60: 6172 6428 612c 2070 6164 6469 6e67 5f63  ard(a, padding_c
+00015f70: 6f6e 6669 672c 2067 293a 0a20 2020 2023  onfig, g):.    #
+00015f80: 2053 686f 7274 2063 6972 6375 6974 206f   Short circuit o
+00015f90: 6e20 656d 7074 7920 696e 7075 742e 0a20  n empty input.. 
+00015fa0: 2020 2069 6620 616e 7928 6469 6d20 3d3d     if any(dim ==
+00015fb0: 2030 2066 6f72 2064 696d 2069 6e20 612e   0 for dim in a.
+00015fc0: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
+00015fd0: 7265 7475 726e 2066 756c 6c5f 6c69 6b65  return full_like
+00015fe0: 2861 2c20 6669 6c6c 5f76 616c 7565 3d30  (a, fill_value=0
+00015ff0: 290a 0a20 2020 2023 2055 6e2d 7061 6420  )..    # Un-pad 
+00016000: 6279 2070 6164 6469 6e67 2077 6974 6820  by padding with 
+00016010: 7a65 726f 2076 616c 7565 730a 2020 2020  zero values.    
+00016020: 7a65 726f 5f70 6164 6469 6e67 5f63 6f6e  zero_padding_con
+00016030: 6669 6720 3d20 5b28 2d6c 6f2c 202d 6869  fig = [(-lo, -hi
+00016040: 2c20 3029 2066 6f72 206c 6f2c 2068 692c  , 0) for lo, hi,
+00016050: 205f 2069 6e20 7061 6464 696e 675f 636f   _ in padding_co
+00016060: 6e66 6967 5d0a 0a20 2020 2067 203d 2070  nfig]..    g = p
+00016070: 7269 6d73 2e70 6164 2867 2c20 302e 302c  rims.pad(g, 0.0,
+00016080: 207a 6572 6f5f 7061 6464 696e 675f 636f   zero_padding_co
+00016090: 6e66 6967 290a 0a20 2020 2023 2055 6e2d  nfig)..    # Un-
+000160a0: 736c 6963 6520 6279 2073 6c69 6369 6e67  slice by slicing
+000160b0: 2077 6974 6820 6120 7374 7269 6465 206f   with a stride o
+000160c0: 6620 7661 6c75 6520 2864 696c 6174 696f  f value (dilatio
+000160d0: 6e20 2b20 3129 0a20 2020 2066 6f72 2064  n + 1).    for d
+000160e0: 696d 2c20 285f 2c20 5f2c 2064 2920 696e  im, (_, _, d) in
+000160f0: 2065 6e75 6d65 7261 7465 2870 6164 6469   enumerate(paddi
+00016100: 6e67 5f63 6f6e 6669 6729 3a0a 2020 2020  ng_config):.    
+00016110: 2020 2020 6720 3d20 736c 6963 655f 696e      g = slice_in
+00016120: 5f64 696d 2867 2c20 302c 2067 2e73 6861  _dim(g, 0, g.sha
+00016130: 7065 5b64 696d 5d2c 2073 7472 6964 653d  pe[dim], stride=
+00016140: 6420 2b20 312c 2064 696d 3d64 696d 290a  d + 1, dim=dim).
+00016150: 0a20 2020 2072 6574 7572 6e20 670a 0a0a  .    return g...
+00016160: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
+00016170: 7465 645f 666f 7277 6172 6428 7072 696d  ted_forward(prim
+00016180: 732e 5072 696d 4944 732e 5052 4f44 290a  s.PrimIDs.PROD).
+00016190: 6465 6620 7072 6f64 5f61 7567 5f66 7764  def prod_aug_fwd
+000161a0: 2878 2c20 6469 6d73 293a 0a20 2020 2022  (x, dims):.    "
+000161b0: 2222 4175 676d 656e 7465 6420 7072 6f64  ""Augmented prod
+000161c0: 206f 7065 7261 7469 6f6e 2e0a 0a20 2020   operation...   
+000161d0: 2041 7267 733a 0a20 2020 2020 2020 2078   Args:.        x
+000161e0: 2028 5661 7269 6162 6c65 293a 2054 656e   (Variable): Ten
+000161f0: 736f 7220 746f 2062 6520 6d75 6c74 6970  sor to be multip
+00016200: 6c69 6564 2e0a 2020 2020 2020 2020 6469  lied..        di
+00016210: 6d73 2028 5475 706c 655b 696e 742c 202e  ms (Tuple[int, .
+00016220: 2e2e 5d29 3a20 4469 6d65 6e73 696f 6e73  ..]): Dimensions
+00016230: 2074 6f20 6265 206d 756c 7469 706c 6965   to be multiplie
+00016240: 642e 0a0a 2020 2020 5265 7475 726e 733a  d...    Returns:
+00016250: 0a20 2020 2020 2020 2056 4a50 4475 616c  .        VJPDual
+00016260: 3a20 5072 696d 616c 2061 6e64 2072 6573  : Primal and res
+00016270: 6964 7561 6c73 2e0a 2020 2020 2222 220a  iduals..    """.
+00016280: 2020 2020 7072 696d 616c 203d 2070 7269      primal = pri
+00016290: 6d73 2e70 726f 6428 782c 2064 696d 7329  ms.prod(x, dims)
+000162a0: 0a0a 2020 2020 7265 7369 6475 616c 7320  ..    residuals 
+000162b0: 3d20 280a 2020 2020 2020 2020 7072 696d  = (.        prim
+000162c0: 616c 2c0a 2020 2020 2020 2020 782c 0a20  al,.        x,. 
+000162d0: 2020 2020 2020 2078 2e73 6861 7065 2c0a         x.shape,.
+000162e0: 2020 2020 2020 2020 6469 6d73 2c0a 2020          dims,.  
+000162f0: 2020 290a 2020 2020 7265 7475 726e 2056    ).    return V
+00016300: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
+00016310: 6573 6964 7561 6c73 290a 0a0a 4072 6567  esiduals)...@reg
+00016320: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
+00016330: 7269 6d73 2e50 7269 6d49 4473 2e50 524f  rims.PrimIDs.PRO
+00016340: 4429 0a64 6566 2070 726f 645f 7075 6c6c  D).def prod_pull
+00016350: 6261 636b 2870 7269 6d61 6c2c 2078 2c20  back(primal, x, 
+00016360: 785f 7368 6170 652c 2072 6564 7563 6564  x_shape, reduced
+00016370: 5f64 696d 732c 2067 293a 0a20 2020 2072  _dims, g):.    r
+00016380: 6574 7572 6e20 7072 696d 732e 6469 7628  eturn prims.div(
+00016390: 7265 7374 6f72 655f 7265 6475 6365 645f  restore_reduced_
+000163a0: 6469 6d73 2870 7269 6d61 6c20 2a20 672c  dims(primal * g,
+000163b0: 2072 6564 7563 6564 5f64 696d 732c 2078   reduced_dims, x
+000163c0: 5f73 6861 7065 292c 2078 290a 0a0a 6465  _shape), x)...de
+000163d0: 6620 6b65 6570 6469 6d5f 7265 6475 6374  f keepdim_reduct
+000163e0: 696f 6e28 7265 6475 6374 696f 6e5f 666e  ion(reduction_fn
+000163f0: 2c20 782c 2064 696d 7329 3a0a 2020 2020  , x, dims):.    
+00016400: 2222 2241 7070 6c69 6573 2072 6564 7563  """Applies reduc
+00016410: 7469 6f6e 2061 6e64 2066 6978 6573 206f  tion and fixes o
+00016420: 7574 7075 7420 746f 2063 6f6e 666f 726d  utput to conform
+00016430: 2074 6f20 6b65 6570 6469 6d3d 5472 7565   to keepdim=True
+00016440: 2222 220a 2020 2020 6f75 7420 3d20 7265  """.    out = re
+00016450: 6475 6374 696f 6e5f 666e 2878 2c20 6469  duction_fn(x, di
+00016460: 6d73 290a 2020 2020 6172 676d 6178 5f73  ms).    argmax_s
+00016470: 756d 5f6f 7574 5f73 6861 7065 203d 205b  um_out_shape = [
+00016480: 782e 7368 6170 655b 695d 2069 6620 6920  x.shape[i] if i 
+00016490: 6e6f 7420 696e 2064 696d 7320 656c 7365  not in dims else
+000164a0: 2031 2066 6f72 2069 2069 6e20 7261 6e67   1 for i in rang
+000164b0: 6528 782e 6e64 696d 295d 0a20 2020 2062  e(x.ndim)].    b
+000164c0: 726f 6164 6361 7374 5f64 696d 7320 3d20  roadcast_dims = 
+000164d0: 5b69 2066 6f72 2069 2069 6e20 7261 6e67  [i for i in rang
+000164e0: 6528 782e 6e64 696d 2920 6966 2069 206e  e(x.ndim) if i n
+000164f0: 6f74 2069 6e20 6469 6d73 5d0a 2020 2020  ot in dims].    
+00016500: 7265 7475 726e 2070 7269 6d73 2e62 726f  return prims.bro
+00016510: 6164 6361 7374 5f69 6e5f 6469 6d28 6f75  adcast_in_dim(ou
+00016520: 742c 2061 7267 6d61 785f 7375 6d5f 6f75  t, argmax_sum_ou
+00016530: 745f 7368 6170 652c 2062 726f 6164 6361  t_shape, broadca
+00016540: 7374 5f64 696d 7329 0a0a 0a23 2049 6e73  st_dims)...# Ins
+00016550: 7069 7265 6420 6672 6f6d 2068 7474 7073  pired from https
+00016560: 3a2f 2f67 6974 6875 622e 636f 6d2f 4849  ://github.com/HI
+00016570: 5053 2f61 7574 6f67 7261 642f 626c 6f62  PS/autograd/blob
+00016580: 2f6d 6173 7465 722f 6175 746f 6772 6164  /master/autograd
+00016590: 2f6e 756d 7079 2f6e 756d 7079 5f76 6a70  /numpy/numpy_vjp
+000165a0: 732e 7079 234c 3335 330a 6465 6620 6772  s.py#L353.def gr
+000165b0: 6164 5f63 686f 6f73 6572 5f62 6163 6b77  ad_chooser_backw
+000165c0: 6172 6428 7072 696d 616c 2c20 782c 2078  ard(primal, x, x
+000165d0: 5f73 6861 7065 2c20 7265 6475 6365 645f  _shape, reduced_
+000165e0: 6469 6d73 2c20 6729 3a0a 2020 2020 2222  dims, g):.    ""
+000165f0: 2242 7569 6c64 7320 6772 6164 6965 6e74  "Builds gradient
+00016600: 206f 6620 6675 6e63 7469 6f6e 7320 7468   of functions th
+00016610: 6174 2063 686f 6f73 6520 6120 7369 6e67  at choose a sing
+00016620: 6c65 2069 7465 6d2c 2073 7563 6820 6173  le item, such as
+00016630: 206d 696e 206f 7220 6d61 782e 2222 220a   min or max.""".
+00016640: 2020 2020 675f 7265 7065 6174 6564 203d      g_repeated =
+00016650: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
+00016660: 5f64 696d 7328 672c 2072 6564 7563 6564  _dims(g, reduced
+00016670: 5f64 696d 732c 2078 5f73 6861 7065 290a  _dims, x_shape).
+00016680: 2020 2020 7072 696d 616c 5f72 6570 6561      primal_repea
+00016690: 7465 6420 3d20 7265 7374 6f72 655f 7265  ted = restore_re
+000166a0: 6475 6365 645f 6469 6d73 2870 7269 6d61  duced_dims(prima
+000166b0: 6c2c 2072 6564 7563 6564 5f64 696d 732c  l, reduced_dims,
+000166c0: 2078 5f73 6861 7065 290a 2020 2020 6172   x_shape).    ar
+000166d0: 676d 6178 5f6c 6f63 6174 696f 6e73 203d  gmax_locations =
+000166e0: 2078 203d 3d20 7072 696d 616c 5f72 6570   x == primal_rep
+000166f0: 6561 7465 640a 2020 2020 6172 676d 6178  eated.    argmax
+00016700: 5f73 756d 203d 206b 6565 7064 696d 5f72  _sum = keepdim_r
+00016710: 6564 7563 7469 6f6e 2870 7269 6d73 2e73  eduction(prims.s
+00016720: 756d 2c20 6172 676d 6178 5f6c 6f63 6174  um, argmax_locat
+00016730: 696f 6e73 2c20 7265 6475 6365 645f 6469  ions, reduced_di
+00016740: 6d73 290a 2020 2020 6f75 7420 3d20 675f  ms).    out = g_
+00016750: 7265 7065 6174 6564 202a 2061 7267 6d61  repeated * argma
+00016760: 785f 6c6f 6361 7469 6f6e 7320 2f20 6172  x_locations / ar
+00016770: 676d 6178 5f73 756d 0a20 2020 2072 6574  gmax_sum.    ret
+00016780: 7572 6e20 6f75 740a 0a0a 7265 6769 7374  urn out...regist
+00016790: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
+000167a0: 732e 5072 696d 4944 732e 414d 494e 2928  s.PrimIDs.AMIN)(
+000167b0: 6772 6164 5f63 686f 6f73 6572 5f62 6163  grad_chooser_bac
+000167c0: 6b77 6172 6429 0a0a 0a40 7265 6769 7374  kward)...@regist
+000167d0: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
+000167e0: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
+000167f0: 4473 2e41 4d49 4e29 0a64 6566 2061 6d69  Ds.AMIN).def ami
+00016800: 6e5f 6175 675f 6677 6428 782c 2064 696d  n_aug_fwd(x, dim
+00016810: 7329 3a0a 2020 2020 2222 2241 7567 6d65  s):.    """Augme
+00016820: 6e74 6564 2061 6d69 6e20 6f70 6572 6174  nted amin operat
+00016830: 696f 6e2e 0a20 2020 2041 7267 733a 0a20  ion..    Args:. 
+00016840: 2020 2020 2020 2078 2028 5661 7269 6162         x (Variab
+00016850: 6c65 293a 2054 656e 736f 7220 746f 2063  le): Tensor to c
+00016860: 6f6d 7075 7465 2061 6d69 6e20 6f6e 2e0a  ompute amin on..
+00016870: 2020 2020 2020 2020 6469 6d73 2028 5475          dims (Tu
+00016880: 706c 655b 696e 742c 202e 2e2e 5d29 3a20  ple[int, ...]): 
+00016890: 4469 6d65 6e73 696f 6e73 2074 6f20 636f  Dimensions to co
+000168a0: 6d70 7574 6520 616d 696e 206f 7665 722e  mpute amin over.
+000168b0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+000168c0: 2020 2020 2020 564a 5044 7561 6c3a 2050        VJPDual: P
+000168d0: 7269 6d61 6c20 616e 6420 7265 7369 6475  rimal and residu
+000168e0: 616c 732e 0a20 2020 2022 2222 0a20 2020  als..    """.   
+000168f0: 2070 7269 6d61 6c20 3d20 7072 696d 732e   primal = prims.
+00016900: 616d 696e 2878 2c20 6469 6d73 290a 0a20  amin(x, dims).. 
+00016910: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
+00016920: 0a20 2020 2020 2020 2070 7269 6d61 6c2c  .        primal,
+00016930: 0a20 2020 2020 2020 2078 2c0a 2020 2020  .        x,.    
+00016940: 2020 2020 782e 7368 6170 652c 0a20 2020      x.shape,.   
+00016950: 2020 2020 2064 696d 732c 0a20 2020 2029       dims,.    )
+00016960: 0a0a 2020 2020 7265 7475 726e 2056 4a50  ..    return VJP
+00016970: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
+00016980: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
+00016990: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+000169a0: 7277 6172 6428 7072 696d 732e 5072 696d  rward(prims.Prim
+000169b0: 4944 732e 504f 5729 0a64 6566 2070 6f77  IDs.POW).def pow
+000169c0: 5f61 7567 5f66 6564 2878 2c20 7929 3a0a  _aug_fed(x, y):.
+000169d0: 2020 2020 2222 2241 7567 6d65 6e74 6564      """Augmented
+000169e0: 2074 6865 2070 6f77 206f 7065 7261 7469   the pow operati
+000169f0: 6f6e 2e0a 0a20 2020 2041 7267 733a 0a20  on...    Args:. 
+00016a00: 2020 2020 2020 2078 2028 5661 7269 6162         x (Variab
+00016a10: 6c65 293a 2054 656e 736f 7220 7769 7468  le): Tensor with
+00016a20: 2074 6865 2062 6173 6520 746f 2062 6520   the base to be 
+00016a30: 6578 706f 6e65 6e74 6961 7465 642e 0a20  exponentiated.. 
+00016a40: 2020 2020 2020 2079 2028 5661 7269 6162         y (Variab
+00016a50: 6c65 293a 2054 656e 736f 7220 7769 7468  le): Tensor with
+00016a60: 2070 6f77 6572 2074 6f20 7261 6973 6520   power to raise 
+00016a70: 746f 2e0a 0a20 2020 2052 6574 7572 6e73  to...    Returns
+00016a80: 3a0a 2020 2020 2020 2020 564a 5044 7561  :.        VJPDua
+00016a90: 6c3a 2050 7269 6d61 6c20 616e 6420 7265  l: Primal and re
+00016aa0: 7369 6475 616c 732e 0a20 2020 2022 2222  siduals..    """
+00016ab0: 0a20 2020 2070 7269 6d61 6c20 3d20 7072  .    primal = pr
+00016ac0: 696d 732e 706f 7728 782c 2079 290a 2020  ims.pow(x, y).  
+00016ad0: 2020 7265 7369 6475 616c 7320 3d20 2870    residuals = (p
+00016ae0: 7269 6d61 6c2c 2078 2c20 7929 0a20 2020  rimal, x, y).   
+00016af0: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+00016b00: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
+00016b10: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
+00016b20: 6163 6b77 6172 6428 7072 696d 732e 5072  ackward(prims.Pr
+00016b30: 696d 4944 732e 504f 5729 0a64 6566 2070  imIDs.POW).def p
+00016b40: 6f77 5f62 6163 6b77 6172 6428 7265 7375  ow_backward(resu
+00016b50: 6c74 2c20 782c 2079 2c20 6729 3a0a 2020  lt, x, y, g):.  
+00016b60: 2020 696d 706f 7274 2074 6875 6e64 6572    import thunder
+00016b70: 2e63 6c61 6e67 2061 7320 746c 616e 670a  .clang as tlang.
+00016b80: 0a20 2020 2067 7265 7375 6c74 203d 2067  .    gresult = g
+00016b90: 202a 2072 6573 756c 7420 2023 2072 6575   * result  # reu
+00016ba0: 7365 2063 6f6d 6d6f 6e20 6661 6374 6f72  se common factor
+00016bb0: 0a20 2020 2064 7820 3d20 6720 2a20 7920  .    dx = g * y 
+00016bc0: 2a20 7820 2a2a 2028 7920 2d20 3129 0a20  * x ** (y - 1). 
+00016bd0: 2020 2064 7920 3d20 6772 6573 756c 7420     dy = gresult 
+00016be0: 2a20 746c 616e 672e 6c6f 6728 7829 0a20  * tlang.log(x). 
+00016bf0: 2020 2072 6574 7572 6e20 6478 2c20 6479     return dx, dy
+00016c00: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
+00016c10: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
+00016c20: 7269 6d73 2e50 7269 6d49 4473 2e54 414e  rims.PrimIDs.TAN
+00016c30: 290a 6465 6620 7461 6e5f 6175 675f 6677  ).def tan_aug_fw
+00016c40: 6428 7829 3a0a 2020 2020 2222 2241 7567  d(x):.    """Aug
+00016c50: 6d65 6e74 6564 2074 616e 206f 7065 7261  mented tan opera
+00016c60: 7469 6f6e 2e0a 0a20 2020 2041 7267 733a  tion...    Args:
+00016c70: 0a20 2020 2020 2020 2078 2028 5661 7269  .        x (Vari
+00016c80: 6162 6c65 293a 2054 656e 736f 7220 746f  able): Tensor to
+00016c90: 2062 6520 7061 7373 6564 2074 6f20 7461   be passed to ta
+00016ca0: 6e2e 0a20 2020 2022 2222 0a0a 2020 2020  n..    """..    
+00016cb0: 7072 696d 616c 203d 2070 7269 6d73 2e74  primal = prims.t
+00016cc0: 616e 2878 290a 2020 2020 7265 7369 6475  an(x).    residu
+00016cd0: 616c 7320 3d20 2870 7269 6d61 6c2c 290a  als = (primal,).
+00016ce0: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00016cf0: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00016d00: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00016d10: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
+00016d20: 2e50 7269 6d49 4473 2e54 414e 290a 6465  .PrimIDs.TAN).de
+00016d30: 6620 7461 6e5f 6261 636b 7761 7264 2872  f tan_backward(r
+00016d40: 6573 756c 742c 2067 293a 0a20 2020 2072  esult, g):.    r
+00016d50: 6574 7572 6e20 6720 2a20 2831 202b 2072  eturn g * (1 + r
+00016d60: 6573 756c 7420 2a20 7265 7375 6c74 290a  esult * result).
+00016d70: 0a0a 2320 4e4f 5445 3a20 4a61 7820 7573  ..# NOTE: Jax us
+00016d80: 6573 206e 702e 6172 6773 6f72 7420 696e  es np.argsort in
+00016d90: 2069 7473 2074 7261 6e73 706f 7365 2076   its transpose v
+00016da0: 6a70 2063 6f6d 7075 7461 7469 6f6e 0a64  jp computation.d
+00016db0: 6566 205f 6172 6773 6f72 7428 7365 7129  ef _argsort(seq)
+00016dc0: 3a0a 2020 2020 7265 7475 726e 2073 6f72  :.    return sor
+00016dd0: 7465 6428 7261 6e67 6528 6c65 6e28 7365  ted(range(len(se
+00016de0: 7129 292c 206b 6579 3d73 6571 2e5f 5f67  q)), key=seq.__g
+00016df0: 6574 6974 656d 5f5f 290a 0a0a 4072 6567  etitem__)...@reg
+00016e00: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+00016e10: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
+00016e20: 696d 4944 732e 4445 5649 4345 5f50 5554  imIDs.DEVICE_PUT
+00016e30: 290a 6465 6620 6465 7669 6365 5f70 7574  ).def device_put
+00016e40: 5f61 7567 5f66 7764 2861 3a20 5465 6e73  _aug_fwd(a: Tens
+00016e50: 6f72 5072 6f78 792c 2064 6576 6963 653a  orProxy, device:
+00016e60: 2044 6576 6963 6529 202d 3e20 5465 6e73   Device) -> Tens
+00016e70: 6f72 5072 6f78 793a 0a20 2020 2070 7269  orProxy:.    pri
+00016e80: 6d61 6c20 3d20 7072 696d 732e 6465 7669  mal = prims.devi
+00016e90: 6365 5f70 7574 2861 2c20 6465 7669 6365  ce_put(a, device
+00016ea0: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
+00016eb0: 3d20 2861 2e64 6576 6963 652c 290a 2020  = (a.device,).  
+00016ec0: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
+00016ed0: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
+00016ee0: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
+00016ef0: 6261 636b 7761 7264 2870 7269 6d73 2e50  backward(prims.P
+00016f00: 7269 6d49 4473 2e44 4556 4943 455f 5055  rimIDs.DEVICE_PU
+00016f10: 5429 0a64 6566 2064 6576 6963 655f 7075  T).def device_pu
+00016f20: 745f 6261 636b 7761 7264 286f 7269 675f  t_backward(orig_
+00016f30: 6465 7669 6365 2c20 6729 3a0a 2020 2020  device, g):.    
+00016f40: 7265 7475 726e 2070 7269 6d73 2e64 6576  return prims.dev
+00016f50: 6963 655f 7075 7428 672c 206f 7269 675f  ice_put(g, orig_
+00016f60: 6465 7669 6365 292c 204e 6f6e 650a 0a0a  device), None...
+00016f70: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
+00016f80: 7465 645f 666f 7277 6172 6428 7072 696d  ted_forward(prim
+00016f90: 732e 5072 696d 4944 732e 434f 4e56 4f4c  s.PrimIDs.CONVOL
+00016fa0: 5554 494f 4e29 0a64 6566 2063 6f6e 766f  UTION).def convo
+00016fb0: 6c75 7469 6f6e 5f61 7567 5f66 7764 280a  lution_aug_fwd(.
+00016fc0: 2020 2020 613a 2050 726f 7879 2c0a 2020      a: Proxy,.  
+00016fd0: 2020 7765 6967 6874 2c0a 2020 2020 6269    weight,.    bi
+00016fe0: 6173 2c0a 2020 2020 7374 7269 6465 2c0a  as,.    stride,.
+00016ff0: 2020 2020 7061 6464 696e 672c 0a20 2020      padding,.   
+00017000: 2064 696c 6174 696f 6e2c 0a20 2020 2074   dilation,.    t
+00017010: 7261 6e73 706f 7365 642c 0a20 2020 206f  ransposed,.    o
+00017020: 7574 7075 745f 7061 6464 696e 672c 0a20  utput_padding,. 
+00017030: 2020 2067 726f 7570 732c 0a29 3a0a 2020     groups,.):.  
+00017040: 2020 7072 696d 616c 203d 2063 6f6e 766f    primal = convo
+00017050: 6c75 7469 6f6e 2861 2c20 7765 6967 6874  lution(a, weight
+00017060: 2c20 6269 6173 2c20 7374 7269 6465 2c20  , bias, stride, 
+00017070: 7061 6464 696e 672c 2064 696c 6174 696f  padding, dilatio
+00017080: 6e2c 2074 7261 6e73 706f 7365 642c 206f  n, transposed, o
+00017090: 7574 7075 745f 7061 6464 696e 672c 2067  utput_padding, g
+000170a0: 726f 7570 7329 0a20 2020 2072 6573 6964  roups).    resid
+000170b0: 7561 6c73 203d 2028 7072 696d 616c 2c20  uals = (primal, 
+000170c0: 612c 2077 6569 6768 742c 2062 6961 732c  a, weight, bias,
+000170d0: 2073 7472 6964 652c 2070 6164 6469 6e67   stride, padding
+000170e0: 2c20 6469 6c61 7469 6f6e 2c20 7472 616e  , dilation, tran
+000170f0: 7370 6f73 6564 2c20 6f75 7470 7574 5f70  sposed, output_p
+00017100: 6164 6469 6e67 2c20 6772 6f75 7073 290a  adding, groups).
+00017110: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00017120: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00017130: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00017140: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
+00017150: 2e50 7269 6d49 4473 2e43 4f4e 564f 4c55  .PrimIDs.CONVOLU
+00017160: 5449 4f4e 290a 6465 6620 636f 6e76 6f6c  TION).def convol
+00017170: 7574 696f 6e5f 6261 636b 7761 7264 280a  ution_backward(.
+00017180: 2020 2020 6f75 7470 7574 3a20 5072 6f78      output: Prox
+00017190: 792c 0a20 2020 2069 6e70 7574 3a20 5072  y,.    input: Pr
+000171a0: 6f78 792c 0a20 2020 2077 6569 6768 742c  oxy,.    weight,
+000171b0: 0a20 2020 2062 6961 732c 0a20 2020 2073  .    bias,.    s
+000171c0: 7472 6964 652c 0a20 2020 2070 6164 6469  tride,.    paddi
+000171d0: 6e67 2c0a 2020 2020 6469 6c61 7469 6f6e  ng,.    dilation
+000171e0: 2c0a 2020 2020 7472 616e 7370 6f73 6564  ,.    transposed
+000171f0: 2c0a 2020 2020 6f75 7470 7574 5f70 6164  ,.    output_pad
+00017200: 6469 6e67 2c0a 2020 2020 6772 6f75 7073  ding,.    groups
+00017210: 2c0a 2020 2020 6772 6164 2c0a 293a 0a20  ,.    grad,.):. 
+00017220: 2020 2023 2054 7261 6e73 706f 7365 6420     # Transposed 
+00017230: 636f 6e76 6f6c 7574 696f 6e20 6973 206e  convolution is n
+00017240: 6f74 2073 7570 706f 7274 6564 210a 2020  ot supported!.  
+00017250: 2020 6173 7365 7274 2074 7261 6e73 706f    assert transpo
+00017260: 7365 6420 3d3d 2030 0a0a 2020 2020 696e  sed == 0..    in
+00017270: 7075 745f 6772 6164 203d 204e 6f6e 650a  put_grad = None.
+00017280: 2020 2020 7765 6967 6874 5f67 7261 6420      weight_grad 
+00017290: 3d20 4e6f 6e65 0a20 2020 2062 6961 735f  = None.    bias_
+000172a0: 6772 6164 203d 204e 6f6e 650a 0a20 2020  grad = None..   
+000172b0: 2023 2053 686f 7274 2063 6972 6375 6974   # Short circuit
+000172c0: 206f 6e20 7a65 726f 2d64 696d 2067 7261   on zero-dim gra
+000172d0: 640a 2020 2020 6966 2061 6e79 2873 203d  d.    if any(s =
+000172e0: 3d20 3020 666f 7220 7320 696e 2067 7261  = 0 for s in gra
+000172f0: 642e 7368 6170 6529 3a0a 2020 2020 2020  d.shape):.      
+00017300: 2020 696e 7075 745f 6772 6164 203d 2066    input_grad = f
+00017310: 756c 6c5f 6c69 6b65 2869 6e70 7574 2c20  ull_like(input, 
+00017320: 6669 6c6c 5f76 616c 7565 3d30 290a 2020  fill_value=0).  
+00017330: 2020 2020 2020 7765 6967 6874 5f67 7261        weight_gra
+00017340: 6420 3d20 6675 6c6c 5f6c 696b 6528 7765  d = full_like(we
+00017350: 6967 6874 2c20 6669 6c6c 5f76 616c 7565  ight, fill_value
+00017360: 3d30 290a 2020 2020 2020 2020 6966 2062  =0).        if b
+00017370: 6961 7320 6973 206e 6f74 204e 6f6e 653a  ias is not None:
+00017380: 0a20 2020 2020 2020 2020 2020 2062 6961  .            bia
+00017390: 735f 6772 6164 203d 2066 756c 6c5f 6c69  s_grad = full_li
+000173a0: 6b65 2862 6961 732c 2066 696c 6c5f 7661  ke(bias, fill_va
+000173b0: 6c75 653d 3029 0a20 2020 2020 2020 2072  lue=0).        r
+000173c0: 6574 7572 6e20 2869 6e70 7574 5f67 7261  eturn (input_gra
+000173d0: 642c 2077 6569 6768 745f 6772 6164 2c20  d, weight_grad, 
+000173e0: 6269 6173 5f67 7261 6429 202b 2028 284e  bias_grad) + ((N
+000173f0: 6f6e 652c 2920 2a20 3629 0a0a 2020 2020  one,) * 6)..    
+00017400: 6261 7463 682c 2069 6e5f 6368 616e 6e65  batch, in_channe
+00017410: 6c73 2c20 2a73 7061 7469 616c 5f64 696d  ls, *spatial_dim
+00017420: 7320 3d20 696e 7075 742e 7368 6170 650a  s = input.shape.
+00017430: 2020 2020 6f75 745f 6368 616e 6e65 6c73      out_channels
+00017440: 2c20 6769 6e5f 6368 616e 6e65 6c73 2c20  , gin_channels, 
+00017450: 2a6b 6572 6e65 6c5f 6469 6d73 203d 2077  *kernel_dims = w
+00017460: 6569 6768 742e 7368 6170 650a 2020 2020  eight.shape.    
+00017470: 6469 6d20 3d20 6c65 6e28 7370 6174 6961  dim = len(spatia
+00017480: 6c5f 6469 6d73 290a 0a20 2020 2064 6566  l_dims)..    def
+00017490: 206d 6179 6265 5f65 7870 616e 645f 7365   maybe_expand_se
+000174a0: 7128 732c 2064 696d 293a 0a20 2020 2020  q(s, dim):.     
+000174b0: 2020 2069 6620 6c65 6e28 7329 203d 3d20     if len(s) == 
+000174c0: 313a 0a20 2020 2020 2020 2020 2020 2072  1:.            r
+000174d0: 6574 7572 6e20 2873 5b30 5d2c 2920 2a20  eturn (s[0],) * 
+000174e0: 6469 6d0a 2020 2020 2020 2020 656c 7365  dim.        else
+000174f0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00017500: 7475 726e 2073 0a0a 2020 2020 7374 7269  turn s..    stri
+00017510: 6465 203d 206d 6179 6265 5f65 7870 616e  de = maybe_expan
+00017520: 645f 7365 7128 7374 7269 6465 2c20 6469  d_seq(stride, di
+00017530: 6d29 0a20 2020 2070 6164 6469 6e67 203d  m).    padding =
+00017540: 206d 6179 6265 5f65 7870 616e 645f 7365   maybe_expand_se
+00017550: 7128 7061 6464 696e 672c 2064 696d 290a  q(padding, dim).
+00017560: 2020 2020 6469 6c61 7469 6f6e 203d 206d      dilation = m
+00017570: 6179 6265 5f65 7870 616e 645f 7365 7128  aybe_expand_seq(
+00017580: 6469 6c61 7469 6f6e 2c20 6469 6d29 0a0a  dilation, dim)..
+00017590: 2020 2020 6465 6620 636f 6e76 5f74 7261      def conv_tra
+000175a0: 6e73 706f 7365 2874 293a 0a20 2020 2020  nspose(t):.     
+000175b0: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
+000175c0: 7472 616e 7370 6f73 6528 742c 2028 312c  transpose(t, (1,
+000175d0: 2030 2920 2b20 7475 706c 6528 7261 6e67   0) + tuple(rang
+000175e0: 6528 322c 2074 2e6e 6469 6d29 2929 0a0a  e(2, t.ndim)))..
+000175f0: 2020 2020 2320 696e 7075 745f 6772 6164      # input_grad
+00017600: 203d 207b 0a20 2020 2064 6566 2074 7261   = {.    def tra
+00017610: 6e73 706f 7365 5f61 6e64 5f66 6c69 705f  nspose_and_flip_
+00017620: 7765 6967 6874 2877 6569 6768 7429 3a0a  weight(weight):.
+00017630: 2020 2020 2020 2020 2320 5468 6520 6c69          # The li
+00017640: 6e65 7320 6265 6c6f 7720 6172 6520 7472  nes below are tr
+00017650: 616e 7370 6f73 696e 6720 7468 6520 6368  ansposing the ch
+00017660: 616e 6e65 6c73 2064 696d 732e 0a20 2020  annels dims..   
+00017670: 2020 2020 2023 2057 6520 616c 736f 206e       # We also n
+00017680: 6565 6420 746f 2065 7874 7261 6374 2074  eed to extract t
+00017690: 6865 2067 726f 7570 2069 6e66 6f72 6d61  he group informa
+000176a0: 7469 6f6e 2061 6e64 206d 6572 6765 2069  tion and merge i
+000176b0: 740a 2020 2020 2020 2020 2320 7769 7468  t.        # with
+000176c0: 2074 6865 2064 696d 656e 7369 6f6e 2063   the dimension c
+000176d0: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
+000176e0: 7468 6520 226f 7574 5f63 6861 6e6e 656c  the "out_channel
+000176f0: 7322 2064 696d 2e0a 2020 2020 2020 2020  s" dim..        
+00017700: 2320 286f 7574 5f63 6861 6e6e 656c 732c  # (out_channels,
+00017710: 2067 696e 5f63 6861 6e6e 656c 7329 202d   gin_channels) -
+00017720: 3e20 2867 696e 5f63 6861 6e6e 656c 732c  > (gin_channels,
+00017730: 206f 7574 5f63 6861 6e6e 656c 7329 0a20   out_channels). 
+00017740: 2020 2020 2020 2077 6569 6768 7420 3d20         weight = 
+00017750: 636f 6e76 5f74 7261 6e73 706f 7365 2877  conv_transpose(w
+00017760: 6569 6768 7429 0a20 2020 2020 2020 2023  eight).        #
+00017770: 2053 706c 6974 2028 6f75 745f 6368 616e   Split (out_chan
+00017780: 6e65 6c73 2c29 202d 3e20 2867 726f 7570  nels,) -> (group
+00017790: 732c 206f 7574 5f63 6861 6e6e 656c 7320  s, out_channels 
+000177a0: 2f2f 2067 726f 7570 7329 0a20 2020 2020  // groups).     
+000177b0: 2020 2077 6569 6768 7420 3d20 7765 6967     weight = weig
+000177c0: 6874 2e72 6573 6861 7065 285b 6769 6e5f  ht.reshape([gin_
+000177d0: 6368 616e 6e65 6c73 2c20 6772 6f75 7073  channels, groups
+000177e0: 2c20 6f75 745f 6368 616e 6e65 6c73 202f  , out_channels /
+000177f0: 2f20 6772 6f75 7073 5d20 2b20 6b65 726e  / groups] + kern
+00017800: 656c 5f64 696d 7329 0a20 2020 2020 2020  el_dims).       
+00017810: 2023 204d 6f76 696e 6720 6772 6f75 7073   # Moving groups
+00017820: 2074 6f20 7468 6520 6c65 6674 2d6d 6f73   to the left-mos
+00017830: 7420 706f 7369 7469 6f6e 2e0a 2020 2020  t position..    
+00017840: 2020 2020 2320 2867 696e 5f63 6861 6e6e      # (gin_chann
+00017850: 656c 732c 2067 726f 7570 732c 206f 7574  els, groups, out
+00017860: 5f63 6861 6e6e 656c 7320 2f2f 2067 726f  _channels // gro
+00017870: 7570 7329 202d 3e20 2867 726f 7570 732c  ups) -> (groups,
+00017880: 2067 696e 5f63 6861 6e6e 656c 732c 206f   gin_channels, o
+00017890: 7574 5f63 6861 6e6e 656c 7320 2f2f 2067  ut_channels // g
+000178a0: 726f 7570 7329 0a20 2020 2020 2020 2077  roups).        w
+000178b0: 6569 6768 7420 3d20 636f 6e76 5f74 7261  eight = conv_tra
+000178c0: 6e73 706f 7365 2877 6569 6768 7429 0a20  nspose(weight). 
+000178d0: 2020 2020 2020 2023 2053 7175 6173 6820         # Squash 
+000178e0: 2867 726f 7570 732c 2067 696e 5f63 6861  (groups, gin_cha
+000178f0: 6e6e 656c 7329 202d 3e20 2869 6e5f 6368  nnels) -> (in_ch
+00017900: 616e 6e65 6c73 290a 2020 2020 2020 2020  annels).        
+00017910: 7765 6967 6874 203d 2077 6569 6768 742e  weight = weight.
+00017920: 7265 7368 6170 6528 5b69 6e5f 6368 616e  reshape([in_chan
+00017930: 6e65 6c73 2c20 6f75 745f 6368 616e 6e65  nels, out_channe
+00017940: 6c73 202f 2f20 6772 6f75 7073 5d20 2b20  ls // groups] + 
+00017950: 6b65 726e 656c 5f64 696d 7329 0a0a 2020  kernel_dims)..  
+00017960: 2020 2020 2020 2320 466c 6970 2073 7061        # Flip spa
+00017970: 7469 616c 2064 696d 656e 7369 6f6e 730a  tial dimensions.
+00017980: 2020 2020 2020 2020 7765 6967 6874 203d          weight =
+00017990: 2070 7269 6d73 2e66 6c69 7028 7765 6967   prims.flip(weig
+000179a0: 6874 2c20 7475 706c 6528 7261 6e67 6528  ht, tuple(range(
+000179b0: 322c 2077 6569 6768 742e 6e64 696d 2929  2, weight.ndim))
+000179c0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000179d0: 2077 6569 6768 740a 0a20 2020 2023 2057   weight..    # W
+000179e0: 6520 6e65 6564 2074 6f20 7061 6420 7468  e need to pad th
+000179f0: 6520 6772 6164 6965 6e74 2074 6f20 6265  e gradient to be
+00017a00: 2061 626c 6520 746f 2066 6974 206b 6572   able to fit ker
+00017a10: 6e65 6c20 7769 6e64 6f77 732e 0a20 2020  nel windows..   
+00017a20: 2069 6e69 7469 616c 5f67 7261 645f 7061   initial_grad_pa
+00017a30: 6464 696e 6720 3d20 5b64 202a 2028 6b20  dding = [d * (k 
+00017a40: 2d20 3129 2066 6f72 2064 2c20 6b20 696e  - 1) for d, k in
+00017a50: 207a 6970 2864 696c 6174 696f 6e2c 206b   zip(dilation, k
+00017a60: 6572 6e65 6c5f 6469 6d73 295d 0a0a 2020  ernel_dims)]..  
+00017a70: 2020 696e 7075 745f 6772 6164 203d 2063    input_grad = c
+00017a80: 6f6e 766f 6c75 7469 6f6e 280a 2020 2020  onvolution(.    
+00017a90: 2020 2020 7072 696d 732e 7061 6428 0a20      prims.pad(. 
+00017aa0: 2020 2020 2020 2020 2020 2067 7261 642c             grad,
+00017ab0: 0a20 2020 2020 2020 2020 2020 2030 2e30  .            0.0
+00017ac0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00017ad0: 5468 6520 7069 7865 7320 6172 6520 7374  The pixes are st
+00017ae0: 7269 6465 2061 7761 7920 6672 6f6d 2065  ride away from e
+00017af0: 6163 6820 6f74 6865 7220 696e 2074 6865  ach other in the
+00017b00: 206f 7269 6769 6e61 6c20 696e 7075 742e   original input.
+00017b10: 0a20 2020 2020 2020 2020 2020 2023 2048  .            # H
+00017b20: 656e 6365 2077 6520 6e65 6564 2074 6f20  ence we need to 
+00017b30: 6469 6c61 7465 2074 6865 2067 7261 6469  dilate the gradi
+00017b40: 656e 7420 6279 2064 696c 6174 696f 6e3d  ent by dilation=
+00017b50: 7374 7269 6465 202d 2031 0a20 2020 2020  stride - 1.     
+00017b60: 2020 2020 2020 2023 2073 6f20 7468 6174         # so that
+00017b70: 2074 6865 7265 2061 7265 2073 7472 6964   there are strid
+00017b80: 6520 2d20 3120 7a65 726f 7320 6265 7477  e - 1 zeros betw
+00017b90: 6565 6e20 7468 6520 7069 7865 6c73 2e0a  een the pixels..
+00017ba0: 2020 2020 2020 2020 2020 2020 5b28 302c              [(0,
+00017bb0: 2030 2c20 3029 2c20 2830 2c20 302c 2030   0, 0), (0, 0, 0
+00017bc0: 295d 202b 205b 2830 2c20 302c 2073 202d  )] + [(0, 0, s -
+00017bd0: 2031 2920 666f 7220 7320 696e 2073 7472   1) for s in str
+00017be0: 6964 655d 2c0a 2020 2020 2020 2020 292c  ide],.        ),
+00017bf0: 0a20 2020 2020 2020 2074 7261 6e73 706f  .        transpo
+00017c00: 7365 5f61 6e64 5f66 6c69 705f 7765 6967  se_and_flip_weig
+00017c10: 6874 2877 6569 6768 7429 2c0a 2020 2020  ht(weight),.    
+00017c20: 2020 2020 4e6f 6e65 2c0a 2020 2020 2020      None,.      
+00017c30: 2020 2320 5365 7474 696e 6720 7374 7269    # Setting stri
+00017c40: 6465 2074 6f20 3120 6173 2074 6865 2064  de to 1 as the d
+00017c50: 6973 7461 6e63 6520 6265 7477 6565 6e20  istance between 
+00017c60: 7069 7865 6c73 2069 7320 7461 6b65 6e0a  pixels is taken.
+00017c70: 2020 2020 2020 2020 2320 6361 7265 2062          # care b
+00017c80: 7920 7468 6520 7061 6420 7269 6768 7420  y the pad right 
+00017c90: 6162 6f76 652e 0a20 2020 2020 2020 2028  above..        (
+00017ca0: 312c 292c 0a20 2020 2020 2020 2069 6e69  1,),.        ini
+00017cb0: 7469 616c 5f67 7261 645f 7061 6464 696e  tial_grad_paddin
+00017cc0: 672c 0a20 2020 2020 2020 2064 696c 6174  g,.        dilat
+00017cd0: 696f 6e2c 0a20 2020 2020 2020 2074 7261  ion,.        tra
+00017ce0: 6e73 706f 7365 642c 0a20 2020 2020 2020  nsposed,.       
+00017cf0: 206f 7574 7075 745f 7061 6464 696e 672c   output_padding,
+00017d00: 0a20 2020 2020 2020 2067 726f 7570 732c  .        groups,
+00017d10: 0a20 2020 2029 0a0a 2020 2020 6465 6620  .    )..    def 
+00017d20: 7061 645f 746f 5f69 6e70 7574 2867 7261  pad_to_input(gra
+00017d30: 6429 3a0a 2020 2020 2020 2020 2320 5765  d):.        # We
+00017d40: 206e 6565 6420 746f 2075 6e70 6164 2074   need to unpad t
+00017d50: 6865 2070 6164 6469 6e67 2064 6f6e 6520  he padding done 
+00017d60: 746f 2074 6865 2069 6e70 7574 2070 7269  to the input pri
+00017d70: 6f72 2074 6f20 7468 6520 636f 6e76 6f6c  or to the convol
+00017d80: 7574 696f 6e2e 0a20 2020 2020 2020 2023  ution..        #
+00017d90: 204e 6f74 6520 7468 6174 206c 6f77 2061   Note that low a
+00017da0: 6e64 2068 6967 6820 7061 6464 696e 6720  nd high padding 
+00017db0: 6172 6520 6e6f 7420 6e65 6365 7373 6172  are not necessar
+00017dc0: 696c 7920 6571 7561 6c2c 2073 6f20 7765  ily equal, so we
+00017dd0: 2063 616e 6e6f 740a 2020 2020 2020 2020   cannot.        
+00017de0: 2320 6162 736f 7262 2069 7420 696e 746f  # absorb it into
+00017df0: 2074 6865 2063 6f6e 766f 6c75 7469 6f6e   the convolution
+00017e00: 206a 7573 7420 7965 742c 2075 6e6c 6573   just yet, unles
+00017e10: 7320 7468 6520 4150 4920 6973 206d 6f64  s the API is mod
+00017e20: 6966 6965 642e 0a20 2020 2020 2020 2070  ified..        p
+00017e30: 6164 5f63 6f6e 6669 6720 3d20 5b28 302c  ad_config = [(0,
+00017e40: 2030 2c20 3029 2c20 2830 2c20 302c 2030   0, 0), (0, 0, 0
+00017e50: 295d 0a20 2020 2020 2020 2066 6f72 206f  )].        for o
+00017e60: 2c20 692c 2067 2c20 7020 696e 207a 6970  , i, g, p in zip
+00017e70: 2867 7261 642e 7368 6170 655b 323a 5d2c  (grad.shape[2:],
+00017e80: 2073 7061 7469 616c 5f64 696d 732c 2069   spatial_dims, i
+00017e90: 6e70 7574 5f67 7261 642e 7368 6170 655b  nput_grad.shape[
+00017ea0: 323a 5d2c 2070 6164 6469 6e67 293a 0a20  2:], padding):. 
+00017eb0: 2020 2020 2020 2020 2020 206c 6f20 3d20             lo = 
+00017ec0: 2d70 0a20 2020 2020 2020 2020 2020 2023  -p.            #
+00017ed0: 204e 6f74 6520 7468 6174 2028 6920 2b20   Note that (i + 
+00017ee0: 3220 2a20 7029 2069 7320 7468 6520 7369  2 * p) is the si
+00017ef0: 7a65 206f 6620 7468 6520 7061 6464 6564  ze of the padded
+00017f00: 2069 6e70 7574 2c0a 2020 2020 2020 2020   input,.        
+00017f10: 2020 2020 2320 736f 2074 6865 2071 7561      # so the qua
+00017f20: 6e74 6974 7920 2869 202b 2032 202a 2070  ntity (i + 2 * p
+00017f30: 2920 2d20 6720 7465 6c6c 7320 7573 2062  ) - g tells us b
+00017f40: 7920 686f 7720 6d75 6368 0a20 2020 2020  y how much.     
+00017f50: 2020 2020 2020 2023 2077 6520 6e65 6564         # we need
+00017f60: 2074 6f20 7061 6420 7468 6520 6772 6164   to pad the grad
+00017f70: 6965 6e74 2073 6f20 7468 6174 2074 6865  ient so that the
+00017f80: 2065 6c65 6d65 6e74 7320 6f75 7473 6964   elements outsid
+00017f90: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+00017fa0: 6f66 2074 6865 2063 6f6e 766f 6c75 7469  of the convoluti
+00017fb0: 6f6e 2072 6563 6569 7665 207a 6572 6f20  on receive zero 
+00017fc0: 6772 6164 6965 6e74 2e0a 2020 2020 2020  gradient..      
+00017fd0: 2020 2020 2020 2320 7020 6973 2061 6464        # p is add
+00017fe0: 6974 696f 6e61 6c6c 7920 7375 6274 7261  itionally subtra
+00017ff0: 6374 6564 2074 6f20 6e65 6761 7465 2074  cted to negate t
+00018000: 6865 2069 6e70 7574 2773 2070 6164 0a20  he input's pad. 
+00018010: 2020 2020 2020 2020 2020 2023 2069 6e20             # in 
+00018020: 666f 7277 6172 642e 0a20 2020 2020 2020  forward..       
+00018030: 2020 2020 2068 6920 3d20 2869 202b 2032       hi = (i + 2
+00018040: 202a 2070 2920 2d20 6720 2d20 700a 2020   * p) - g - p.  
+00018050: 2020 2020 2020 2020 2020 7061 645f 636f            pad_co
+00018060: 6e66 6967 2e61 7070 656e 6428 286c 6f2c  nfig.append((lo,
+00018070: 2068 692c 2030 2929 0a20 2020 2020 2020   hi, 0)).       
+00018080: 2072 6574 7572 6e20 7072 696d 732e 7061   return prims.pa
+00018090: 6428 6772 6164 2c20 302e 302c 2070 6164  d(grad, 0.0, pad
+000180a0: 5f63 6f6e 6669 6729 0a0a 2020 2020 696e  _config)..    in
+000180b0: 7075 745f 6772 6164 203d 2070 6164 5f74  put_grad = pad_t
+000180c0: 6f5f 696e 7075 7428 696e 7075 745f 6772  o_input(input_gr
+000180d0: 6164 290a 2020 2020 2320 7d0a 0a20 2020  ad).    # }..   
+000180e0: 2023 2062 6961 735f 6772 6164 203d 207b   # bias_grad = {
+000180f0: 0a20 2020 2069 6620 6269 6173 2069 7320  .    if bias is 
+00018100: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00018110: 2020 696d 706f 7274 2074 6875 6e64 6572    import thunder
+00018120: 2e74 6f72 6368 2061 7320 6c74 6f72 6368  .torch as ltorch
+00018130: 0a0a 2020 2020 2020 2020 6269 6173 5f67  ..        bias_g
+00018140: 7261 6420 3d20 6c74 6f72 6368 2e73 756d  rad = ltorch.sum
+00018150: 2867 7261 642c 205b 6420 666f 7220 6420  (grad, [d for d 
+00018160: 696e 2072 616e 6765 2867 7261 642e 6e64  in range(grad.nd
+00018170: 696d 2920 6966 2064 2021 3d20 315d 290a  im) if d != 1]).
+00018180: 2020 2020 2320 7d0a 0a20 2020 2023 2077      # }..    # w
+00018190: 6569 6768 7420 6772 6164 203d 207b 0a20  eight grad = {. 
+000181a0: 2020 2064 6566 2070 6164 5f74 7261 6e73     def pad_trans
+000181b0: 706f 7365 5f61 6e64 5f70 7573 685f 6772  pose_and_push_gr
+000181c0: 6f75 7073 5f69 6e74 6f5f 6261 7463 6865  oups_into_batche
+000181d0: 7328 7429 3a0a 2020 2020 2020 2020 2320  s(t):.        # 
+000181e0: 4669 7273 7420 7061 642c 2e2e 2e0a 2020  First pad,....  
+000181f0: 2020 2020 2020 2320 5061 6420 6173 206e        # Pad as n
+00018200: 6563 6573 7361 7279 2073 6f20 7468 6174  ecessary so that
+00018210: 2069 6e20 636f 6e76 6f6c 7574 696f 6e73   in convolutions
+00018220: 2077 6520 6e65 7665 7220 6164 7661 6e63   we never advanc
+00018230: 650a 2020 2020 2020 2020 2320 7061 7374  e.        # past
+00018240: 2072 656c 6576 616e 7420 696e 7075 7473   relevant inputs
+00018250: 2e0a 2020 2020 2020 2020 7061 645f 636f  ..        pad_co
+00018260: 6e66 6967 203d 205b 2830 2c20 302c 2030  nfig = [(0, 0, 0
+00018270: 292c 2028 302c 2030 2c20 3029 5d0a 2020  ), (0, 0, 0)].  
+00018280: 2020 2020 2020 666f 7220 6f2c 2069 2c20        for o, i, 
+00018290: 6b2c 2070 2c20 732c 2064 2069 6e20 7a69  k, p, s, d in zi
+000182a0: 7028 6772 6164 2e73 6861 7065 5b32 3a5d  p(grad.shape[2:]
+000182b0: 2c20 7370 6174 6961 6c5f 6469 6d73 2c20  , spatial_dims, 
+000182c0: 6b65 726e 656c 5f64 696d 732c 2070 6164  kernel_dims, pad
+000182d0: 6469 6e67 2c20 7374 7269 6465 2c20 6469  ding, stride, di
+000182e0: 6c61 7469 6f6e 293a 0a20 2020 2020 2020  lation):.       
+000182f0: 2020 2020 2023 2050 6164 6469 6e67 2066       # Padding f
+00018300: 726f 6d20 6265 6c6f 7720 6973 2074 6865  rom below is the
+00018310: 2073 616d 652e 0a20 2020 2020 2020 2020   same..         
+00018320: 2020 206c 6f20 3d20 700a 2020 2020 2020     lo = p.      
+00018330: 2020 2020 2020 2320 5468 6572 6520 6973        # There is
+00018340: 2061 6c77 6179 7320 7468 6520 6d61 7820   always the max 
+00018350: 696e 6465 7820 6964 7820 696e 2074 6865  index idx in the
+00018360: 2069 6e70 7574 0a20 2020 2020 2020 2020   input.         
+00018370: 2020 2023 2074 6865 2076 616c 7565 206f     # the value o
+00018380: 6620 7768 6963 682c 2069 6e70 7574 5b69  f which, input[i
+00018390: 6478 5d2c 2074 6865 206b 6572 6e65 6c20  dx], the kernel 
+000183a0: 746f 7563 6865 732e 0a20 2020 2020 2020  touches..       
+000183b0: 2020 2020 2023 2054 6865 206b 6572 6e65       # The kerne
+000183c0: 6c20 7265 6163 682c 206f 7220 6b5f 7265  l reach, or k_re
+000183d0: 6163 682c 2069 7320 6578 6163 746c 7920  ach, is exactly 
+000183e0: 6964 7820 2b20 312e 0a20 2020 2020 2020  idx + 1..       
+000183f0: 2020 2020 2023 2057 6520 7573 6520 6974       # We use it
+00018400: 2074 6f20 6465 6369 6465 2062 7920 686f   to decide by ho
+00018410: 7720 6d75 6368 2077 6520 6e65 6564 2074  w much we need t
+00018420: 6f20 7061 6420 6672 6f6d 2061 626f 7665  o pad from above
+00018430: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+00018440: 7320 746f 206e 6f74 206d 6f76 6520 7061  s to not move pa
+00018450: 7374 2072 656c 6576 616e 7420 7661 6c75  st relevant valu
+00018460: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
+00018470: 6b5f 7265 6163 6820 3d20 286f 202d 2031  k_reach = (o - 1
+00018480: 2920 2a20 7320 2b20 6420 2a20 286b 202d  ) * s + d * (k -
+00018490: 2031 2920 2b20 310a 2020 2020 2020 2020   1) + 1.        
+000184a0: 2020 2020 2320 5468 6520 7061 6420 6672      # The pad fr
+000184b0: 6f6d 2061 626f 7665 2065 7175 616c 7320  om above equals 
+000184c0: 6b5f 7265 6163 6820 6d69 6e75 7320 7468  k_reach minus th
+000184d0: 6520 6c65 6e67 7468 0a20 2020 2020 2020  e length.       
+000184e0: 2020 2020 2023 206f 6620 7468 6520 696e       # of the in
+000184f0: 7075 7420 7061 6464 6564 2066 726f 6d20  put padded from 
+00018500: 6265 6c6f 772e 0a20 2020 2020 2020 2020  below..         
+00018510: 2020 2068 6920 3d20 6b5f 7265 6163 6820     hi = k_reach 
+00018520: 2d20 2869 202b 2070 290a 2020 2020 2020  - (i + p).      
+00018530: 2020 2020 2020 7061 645f 636f 6e66 6967        pad_config
+00018540: 2e61 7070 656e 6428 286c 6f2c 2068 692c  .append((lo, hi,
+00018550: 2030 2929 0a20 2020 2020 2020 2074 203d   0)).        t =
+00018560: 2070 7269 6d73 2e70 6164 2874 2c20 302e   prims.pad(t, 0.
+00018570: 302c 2070 6164 5f63 6f6e 6669 6729 0a0a  0, pad_config)..
+00018580: 2020 2020 2020 2020 5f2c 205f 2c20 2a74          _, _, *t
+00018590: 5f73 7061 7469 616c 5f64 696d 7320 3d20  _spatial_dims = 
+000185a0: 742e 7368 6170 650a 0a20 2020 2020 2020  t.shape..       
+000185b0: 2023 202e 2e2e 2074 6865 6e20 646f 2074   # ... then do t
+000185c0: 6865 2072 6573 742e 0a20 2020 2020 2020  he rest..       
+000185d0: 2023 2074 2e73 6861 7065 203d 3d20 2862   # t.shape == (b
+000185e0: 6174 6368 2c20 696e 5f63 6861 6e6e 656c  atch, in_channel
+000185f0: 732c 202e 2e2e 290a 2020 2020 2020 2020  s, ...).        
+00018600: 2320 5468 6520 7265 7375 6c74 206f 6620  # The result of 
+00018610: 7468 6973 2066 756e 6374 696f 6e20 6861  this function ha
+00018620: 7320 7368 6170 650a 2020 2020 2020 2020  s shape.        
+00018630: 2320 2869 6e5f 6368 616e 6e65 6c73 2c20  # (in_channels, 
+00018640: 6261 7463 6820 2a20 6772 6f75 7073 290a  batch * groups).
+00018650: 2020 2020 2020 2020 2320 2862 6174 6368          # (batch
+00018660: 2c20 696e 5f63 6861 6e6e 656c 7329 202d  , in_channels) -
+00018670: 3e20 2869 6e5f 6368 616e 6e65 6c73 2c20  > (in_channels, 
+00018680: 6261 7463 6829 0a20 2020 2020 2020 2074  batch).        t
+00018690: 203d 2063 6f6e 765f 7472 616e 7370 6f73   = conv_transpos
+000186a0: 6528 7429 0a20 2020 2020 2020 2023 2053  e(t).        # S
+000186b0: 706c 6974 2028 696e 5f63 6861 6e6e 656c  plit (in_channel
+000186c0: 732c 2920 2d3e 2028 6772 6f75 7073 2c20  s,) -> (groups, 
+000186d0: 6769 6e5f 6368 616e 6e65 6c73 290a 2020  gin_channels).  
+000186e0: 2020 2020 2020 7420 3d20 742e 7265 7368        t = t.resh
+000186f0: 6170 6528 5b67 726f 7570 732c 2067 696e  ape([groups, gin
+00018700: 5f63 6861 6e6e 656c 732c 2062 6174 6368  _channels, batch
+00018710: 5d20 2b20 745f 7370 6174 6961 6c5f 6469  ] + t_spatial_di
+00018720: 6d73 290a 2020 2020 2020 2020 2320 5472  ms).        # Tr
+00018730: 616e 7370 6f73 6520 2867 726f 7570 732c  anspose (groups,
+00018740: 2067 696e 5f63 6861 6e6e 656c 732c 2062   gin_channels, b
+00018750: 6174 6368 2920 2d3e 2028 6769 6e5f 6368  atch) -> (gin_ch
+00018760: 616e 6e65 6c73 2c20 6772 6f75 7073 2c20  annels, groups, 
+00018770: 6261 7463 6829 0a20 2020 2020 2020 2074  batch).        t
+00018780: 203d 2063 6f6e 765f 7472 616e 7370 6f73   = conv_transpos
+00018790: 6528 7429 0a20 2020 2020 2020 2023 2046  e(t).        # F
+000187a0: 6c61 7474 656e 2028 6772 6f75 7073 2c20  latten (groups, 
+000187b0: 6261 7463 6829 202d 3e20 2867 726f 7570  batch) -> (group
+000187c0: 7320 2a20 6261 7463 682c 290a 2020 2020  s * batch,).    
+000187d0: 2020 2020 7420 3d20 742e 7265 7368 6170      t = t.reshap
+000187e0: 6528 5b67 696e 5f63 6861 6e6e 656c 732c  e([gin_channels,
+000187f0: 2067 726f 7570 7320 2a20 6261 7463 685d   groups * batch]
+00018800: 202b 2074 5f73 7061 7469 616c 5f64 696d   + t_spatial_dim
+00018810: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+00018820: 6e20 740a 0a20 2020 2023 2069 6e70 7574  n t..    # input
+00018830: 2077 696c 6c20 6861 7665 2073 6861 7065   will have shape
+00018840: 2028 6769 6e5f 6368 616e 6e65 6c73 2c20   (gin_channels, 
+00018850: 6772 6f75 7073 202a 2062 6174 6368 290a  groups * batch).
+00018860: 2020 2020 696e 7075 7420 3d20 7061 645f      input = pad_
+00018870: 7472 616e 7370 6f73 655f 616e 645f 7075  transpose_and_pu
+00018880: 7368 5f67 726f 7570 735f 696e 746f 5f62  sh_groups_into_b
+00018890: 6174 6368 6573 2869 6e70 7574 290a 2020  atches(input).  
+000188a0: 2020 2320 6772 6164 2077 696c 6c20 6861    # grad will ha
+000188b0: 7665 2073 6861 7065 2028 6f75 745f 6368  ve shape (out_ch
+000188c0: 616e 6e65 6c73 2c20 6261 7463 6829 0a20  annels, batch). 
+000188d0: 2020 2023 204e 6f74 6520 7468 6174 2074     # Note that t
+000188e0: 6865 7365 2073 6861 7065 7320 6172 6520  hese shapes are 
+000188f0: 636f 6d70 6174 6962 6c65 2066 6f72 2061  compatible for a
+00018900: 2067 726f 7570 2063 6f6e 766f 6c75 7469   group convoluti
+00018910: 6f6e 2e0a 2020 2020 6772 6164 203d 2063  on..    grad = c
+00018920: 6f6e 765f 7472 616e 7370 6f73 6528 6772  onv_transpose(gr
+00018930: 6164 290a 0a20 2020 2023 2057 6879 2064  ad)..    # Why d
+00018940: 6f20 7765 2066 6c69 7020 7374 7269 6465  o we flip stride
+00018950: 2061 6e64 2064 696c 6174 696f 6e3f 0a20   and dilation?. 
+00018960: 2020 2023 206b 6572 6e65 6c5b 695d 2061     # kernel[i] a
+00018970: 6e64 206b 6572 6e65 6c5b 6920 2b20 315d  nd kernel[i + 1]
+00018980: 2061 7265 2064 696c 6174 696f 6e20 6170   are dilation ap
+00018990: 6172 7420 6672 6f6d 2065 6163 6820 6f74  art from each ot
+000189a0: 6865 722c 0a20 2020 2023 2073 6f20 6469  her,.    # so di
+000189b0: 6c61 7469 6f6e 2062 6563 6f6d 6573 2074  lation becomes t
+000189c0: 6865 206e 6577 2073 7472 6964 652e 0a20  he new stride.. 
+000189d0: 2020 2023 2041 6c6c 2074 6865 2065 6c65     # All the ele
+000189e0: 6d65 6e74 7320 7468 6174 206b 6572 6e65  ments that kerne
+000189f0: 6c5b 695d 2074 6f75 6368 6573 2061 7265  l[i] touches are
+00018a00: 2073 7472 6964 6520 6177 6179 2066 726f   stride away fro
+00018a10: 6d20 6561 6368 206f 7468 6572 2c0a 2020  m each other,.  
+00018a20: 2020 2320 6865 6e63 6520 7374 7269 6465    # hence stride
+00018a30: 2062 6563 6f6d 6573 2074 6865 206e 6577   becomes the new
+00018a40: 2064 696c 6174 696f 6e2e 0a20 2020 2077   dilation..    w
+00018a50: 6569 6768 745f 6772 6164 203d 2063 6f6e  eight_grad = con
+00018a60: 766f 6c75 7469 6f6e 280a 2020 2020 2020  volution(.      
+00018a70: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
+00018a80: 2067 7261 642c 0a20 2020 2020 2020 204e   grad,.        N
+00018a90: 6f6e 652c 0a20 2020 2020 2020 2064 696c  one,.        dil
+00018aa0: 6174 696f 6e2c 2020 2320 7365 7420 7374  ation,  # set st
+00018ab0: 7269 6465 3d64 696c 6174 696f 6e0a 2020  ride=dilation.  
+00018ac0: 2020 2020 2020 2830 2c29 2c0a 2020 2020        (0,),.    
+00018ad0: 2020 2020 7374 7269 6465 2c20 2023 2073      stride,  # s
+00018ae0: 6574 2064 696c 6174 696f 6e3d 7374 7269  et dilation=stri
+00018af0: 6465 0a20 2020 2020 2020 2074 7261 6e73  de.        trans
+00018b00: 706f 7365 642c 0a20 2020 2020 2020 206f  posed,.        o
+00018b10: 7574 7075 745f 7061 6464 696e 672c 0a20  utput_padding,. 
+00018b20: 2020 2020 2020 2067 726f 7570 732c 0a20         groups,. 
+00018b30: 2020 2029 0a0a 2020 2020 2320 5468 6520     )..    # The 
+00018b40: 7265 7375 6c74 206f 6620 7468 6520 636f  result of the co
+00018b50: 6e76 6f6c 7574 696f 6e20 6861 7320 7368  nvolution has sh
+00018b60: 6170 6520 2867 696e 5f63 6861 6e6e 656c  ape (gin_channel
+00018b70: 732c 206f 7574 5f63 6861 6e6e 656c 7329  s, out_channels)
+00018b80: 2c0a 2020 2020 2320 736f 2074 7261 6e73  ,.    # so trans
+00018b90: 706f 7369 7469 6f6e 2069 7320 7265 7175  position is requ
+00018ba0: 6972 6564 2e0a 2020 2020 7765 6967 6874  ired..    weight
+00018bb0: 5f67 7261 6420 3d20 636f 6e76 5f74 7261  _grad = conv_tra
+00018bc0: 6e73 706f 7365 2877 6569 6768 745f 6772  nspose(weight_gr
+00018bd0: 6164 290a 2020 2020 2320 7d0a 0a20 2020  ad).    # }..   
+00018be0: 2072 6574 7572 6e20 2869 6e70 7574 5f67   return (input_g
+00018bf0: 7261 642c 2077 6569 6768 745f 6772 6164  rad, weight_grad
+00018c00: 2c20 6269 6173 5f67 7261 6429 0a0a 0a40  , bias_grad)...@
+00018c10: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+00018c20: 6564 5f66 6f72 7761 7264 2822 746f 7263  ed_forward("torc
+00018c30: 682e 6c6f 675f 736f 6674 6d61 7822 290a  h.log_softmax").
+00018c40: 6465 6620 6c6f 675f 736f 6674 6d61 785f  def log_softmax_
+00018c50: 6175 675f 6677 6428 696e 7075 743a 2054  aug_fwd(input: T
+00018c60: 656e 736f 7250 726f 7879 2c20 6469 6d3a  ensorProxy, dim:
+00018c70: 2069 6e74 2c20 2a2c 2064 7479 7065 3d4e   int, *, dtype=N
+00018c80: 6f6e 6529 202d 3e20 564a 5044 7561 6c3a  one) -> VJPDual:
+00018c90: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00018ca0: 722e 746f 7263 6820 696d 706f 7274 206c  r.torch import l
+00018cb0: 6f67 5f73 6f66 746d 6178 0a0a 2020 2020  og_softmax..    
+00018cc0: 7072 696d 616c 203d 206c 6f67 5f73 6f66  primal = log_sof
+00018cd0: 746d 6178 2869 6e70 7574 2c20 6469 6d3d  tmax(input, dim=
+00018ce0: 6469 6d2c 2064 7479 7065 3d64 7479 7065  dim, dtype=dtype
+00018cf0: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
+00018d00: 3d20 2870 7269 6d61 6c2c 2064 696d 2c20  = (primal, dim, 
+00018d10: 696e 7075 742e 6474 7970 6529 0a20 2020  input.dtype).   
+00018d20: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+00018d30: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
+00018d40: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
+00018d50: 6163 6b77 6172 6428 2274 6f72 6368 2e6c  ackward("torch.l
+00018d60: 6f67 5f73 6f66 746d 6178 2229 0a64 6566  og_softmax").def
+00018d70: 206c 6f67 5f73 6f66 746d 6178 5f62 6163   log_softmax_bac
+00018d80: 6b77 6172 6428 7072 696d 616c 2c20 6469  kward(primal, di
+00018d90: 6d2c 2064 7479 7065 2c20 6729 3a0a 2020  m, dtype, g):.  
+00018da0: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
+00018db0: 6f72 6368 2069 6d70 6f72 7420 6c6f 675f  orch import log_
+00018dc0: 736f 6674 6d61 785f 6261 636b 7761 7264  softmax_backward
+00018dd0: 0a0a 2020 2020 7265 7475 726e 206c 6f67  ..    return log
+00018de0: 5f73 6f66 746d 6178 5f62 6163 6b77 6172  _softmax_backwar
+00018df0: 6428 672c 2070 7269 6d61 6c2c 2064 696d  d(g, primal, dim
+00018e00: 2c20 6474 7970 6529 0a0a 0a40 7265 6769  , dtype)...@regi
+00018e10: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
+00018e20: 6f72 7761 7264 2822 746f 7263 682e 6e6e  orward("torch.nn
+00018e30: 2e66 756e 6374 696f 6e61 6c2e 6e6c 6c5f  .functional.nll_
+00018e40: 6c6f 7373 2229 0a64 6566 206e 6c6c 5f6c  loss").def nll_l
+00018e50: 6f73 735f 6175 675f 6677 6428 0a20 2020  oss_aug_fwd(.   
+00018e60: 2069 6e70 7574 3a20 5072 6f78 792c 0a20   input: Proxy,. 
+00018e70: 2020 2074 6172 6765 743a 2050 726f 7879     target: Proxy
+00018e80: 2c0a 2020 2020 7765 6967 6874 3a20 4e6f  ,.    weight: No
+00018e90: 6e65 207c 2050 726f 7879 2c0a 2020 2020  ne | Proxy,.    
+00018ea0: 6967 6e6f 7265 5f69 6e64 6578 3a20 696e  ignore_index: in
+00018eb0: 742c 0a20 2020 2072 6564 7563 7469 6f6e  t,.    reduction
+00018ec0: 3a20 7374 722c 0a29 202d 3e20 564a 5044  : str,.) -> VJPD
+00018ed0: 7561 6c3a 0a20 2020 2066 726f 6d20 7468  ual:.    from th
+00018ee0: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
+00018ef0: 7274 205f 6e6c 6c5f 6c6f 7373 5f68 656c  rt _nll_loss_hel
+00018f00: 7065 720a 0a20 2020 2070 7269 6d61 6c2c  per..    primal,
+00018f10: 2074 6f74 616c 5f77 6569 6768 7420 3d20   total_weight = 
+00018f20: 5f6e 6c6c 5f6c 6f73 735f 6865 6c70 6572  _nll_loss_helper
+00018f30: 280a 2020 2020 2020 2020 696e 7075 742c  (.        input,
+00018f40: 0a20 2020 2020 2020 2074 6172 6765 742c  .        target,
+00018f50: 0a20 2020 2020 2020 2077 6569 6768 742c  .        weight,
+00018f60: 0a20 2020 2020 2020 2069 676e 6f72 655f  .        ignore_
+00018f70: 696e 6465 782c 0a20 2020 2020 2020 2072  index,.        r
+00018f80: 6564 7563 7469 6f6e 2c0a 2020 2020 290a  eduction,.    ).
+00018f90: 2020 2020 7265 7369 6475 616c 7320 3d20      residuals = 
+00018fa0: 2869 6e70 7574 2c20 7461 7267 6574 2c20  (input, target, 
+00018fb0: 7765 6967 6874 2c20 7265 6475 6374 696f  weight, reductio
+00018fc0: 6e2c 2069 676e 6f72 655f 696e 6465 782c  n, ignore_index,
+00018fd0: 2074 6f74 616c 5f77 6569 6768 7429 0a20   total_weight). 
+00018fe0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+00018ff0: 6c28 7072 696d 616c 2c20 7265 7369 6475  l(primal, residu
+00019000: 616c 7329 0a0a 0a40 7265 6769 7374 6572  als)...@register
+00019010: 5f62 6163 6b77 6172 6428 2274 6f72 6368  _backward("torch
+00019020: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e6e  .nn.functional.n
+00019030: 6c6c 5f6c 6f73 7322 290a 6465 6620 6e6c  ll_loss").def nl
+00019040: 6c5f 6c6f 7373 5f62 6163 6b77 6172 6428  l_loss_backward(
+00019050: 696e 7075 742c 2074 6172 6765 742c 2077  input, target, w
+00019060: 6569 6768 742c 2072 6564 7563 7469 6f6e  eight, reduction
+00019070: 2c20 6967 6e6f 7265 5f69 6e64 6578 2c20  , ignore_index, 
+00019080: 746f 7461 6c5f 7765 6967 6874 2c20 6729  total_weight, g)
+00019090: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
+000190a0: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
+000190b0: 6e6c 6c5f 6c6f 7373 5f62 6163 6b77 6172  nll_loss_backwar
+000190c0: 640a 0a20 2020 2067 696e 7075 7420 3d20  d..    ginput = 
+000190d0: 6e6c 6c5f 6c6f 7373 5f62 6163 6b77 6172  nll_loss_backwar
+000190e0: 6428 672c 2069 6e70 7574 2c20 7461 7267  d(g, input, targ
+000190f0: 6574 2c20 7765 6967 6874 2c20 7265 6475  et, weight, redu
+00019100: 6374 696f 6e2c 2069 676e 6f72 655f 696e  ction, ignore_in
+00019110: 6465 782c 2074 6f74 616c 5f77 6569 6768  dex, total_weigh
+00019120: 7429 0a20 2020 2072 6574 7572 6e20 6769  t).    return gi
+00019130: 6e70 7574 2c20 2a28 284e 6f6e 652c 2920  nput, *((None,) 
+00019140: 2a20 3429 0a0a 0a40 7265 6769 7374 6572  * 4)...@register
+00019150: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
+00019160: 7264 2822 746f 7263 682e 7370 6c69 7422  rd("torch.split"
+00019170: 290a 6465 6620 7370 6c69 745f 6175 675f  ).def split_aug_
+00019180: 6677 6428 613a 2054 656e 736f 7250 726f  fwd(a: TensorPro
+00019190: 7879 2c20 7370 6c69 745f 7369 7a65 5f6f  xy, split_size_o
+000191a0: 725f 7365 6374 696f 6e73 3a20 696e 7420  r_sections: int 
+000191b0: 7c20 5365 7175 656e 6365 5b69 6e74 5d2c  | Sequence[int],
+000191c0: 2064 696d 3a20 696e 7420 3d20 3029 202d   dim: int = 0) -
+000191d0: 3e20 564a 5044 7561 6c3a 0a20 2020 2066  > VJPDual:.    f
+000191e0: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
+000191f0: 6820 696d 706f 7274 2073 706c 6974 0a0a  h import split..
+00019200: 2020 2020 7072 696d 616c 203d 2073 706c      primal = spl
+00019210: 6974 2861 2c20 7370 6c69 745f 7369 7a65  it(a, split_size
+00019220: 5f6f 725f 7365 6374 696f 6e73 2c20 6469  _or_sections, di
+00019230: 6d29 0a20 2020 2072 6573 6964 7561 6c73  m).    residuals
+00019240: 203d 2028 6469 6d2c 290a 2020 2020 7265   = (dim,).    re
+00019250: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
+00019260: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
+00019270: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
+00019280: 7761 7264 2822 746f 7263 682e 7370 6c69  ward("torch.spli
+00019290: 7422 290a 6465 6620 7370 6c69 745f 6261  t").def split_ba
+000192a0: 636b 7761 7264 2864 696d 2c20 2a67 7261  ckward(dim, *gra
+000192b0: 6473 293a 0a20 2020 2066 726f 6d20 7468  ds):.    from th
+000192c0: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
+000192d0: 7274 2063 6174 0a0a 2020 2020 7265 7475  rt cat..    retu
+000192e0: 726e 2063 6174 2867 7261 6473 2c20 6469  rn cat(grads, di
+000192f0: 6d29 0a0a 0a40 7265 6769 7374 6572 5f61  m)...@register_a
+00019300: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+00019310: 2822 746f 7263 682e 6e6e 2e66 756e 6374  ("torch.nn.funct
+00019320: 696f 6e61 6c2e 656d 6265 6464 696e 6722  ional.embedding"
+00019330: 290a 6465 6620 656d 6265 6464 696e 675f  ).def embedding_
+00019340: 6175 675f 6677 6428 0a20 2020 2061 3a20  aug_fwd(.    a: 
+00019350: 5072 6f78 792c 0a20 2020 2077 6569 6768  Proxy,.    weigh
+00019360: 743a 2050 726f 7879 2c0a 2020 2020 7061  t: Proxy,.    pa
+00019370: 6464 696e 675f 6964 783a 2069 6e74 207c  dding_idx: int |
+00019380: 204e 6f6e 652c 0a20 2020 206d 6178 5f6e   None,.    max_n
+00019390: 6f72 6d3a 2066 6c6f 6174 207c 204e 6f6e  orm: float | Non
+000193a0: 652c 0a20 2020 206e 6f72 6d5f 7479 7065  e,.    norm_type
+000193b0: 3a20 666c 6f61 742c 0a20 2020 2073 6361  : float,.    sca
+000193c0: 6c65 5f67 7261 645f 6279 5f66 7265 713a  le_grad_by_freq:
+000193d0: 2062 6f6f 6c2c 0a20 2020 2073 7061 7273   bool,.    spars
+000193e0: 653a 2062 6f6f 6c2c 0a29 202d 3e20 564a  e: bool,.) -> VJ
+000193f0: 5044 7561 6c3a 0a20 2020 2066 726f 6d20  PDual:.    from 
+00019400: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
+00019410: 706f 7274 2065 6d62 6564 6469 6e67 0a0a  port embedding..
+00019420: 2020 2020 7072 696d 616c 203d 2065 6d62      primal = emb
+00019430: 6564 6469 6e67 280a 2020 2020 2020 2020  edding(.        
+00019440: 612c 0a20 2020 2020 2020 2077 6569 6768  a,.        weigh
+00019450: 742c 0a20 2020 2020 2020 2070 6164 6469  t,.        paddi
+00019460: 6e67 5f69 6478 3d70 6164 6469 6e67 5f69  ng_idx=padding_i
+00019470: 6478 2c0a 2020 2020 2020 2020 6d61 785f  dx,.        max_
+00019480: 6e6f 726d 3d6d 6178 5f6e 6f72 6d2c 0a20  norm=max_norm,. 
+00019490: 2020 2020 2020 206e 6f72 6d5f 7479 7065         norm_type
+000194a0: 3d6e 6f72 6d5f 7479 7065 2c0a 2020 2020  =norm_type,.    
+000194b0: 2020 2020 7363 616c 655f 6772 6164 5f62      scale_grad_b
+000194c0: 795f 6672 6571 3d73 6361 6c65 5f67 7261  y_freq=scale_gra
+000194d0: 645f 6279 5f66 7265 712c 0a20 2020 2020  d_by_freq,.     
+000194e0: 2020 2073 7061 7273 653d 7370 6172 7365     sparse=sparse
+000194f0: 2c0a 2020 2020 290a 2020 2020 7265 7369  ,.    ).    resi
+00019500: 6475 616c 7320 3d20 2861 2c20 7765 6967  duals = (a, weig
+00019510: 6874 2e73 6861 7065 5b30 5d2c 2070 6164  ht.shape[0], pad
+00019520: 6469 6e67 5f69 6478 2c20 7363 616c 655f  ding_idx, scale_
+00019530: 6772 6164 5f62 795f 6672 6571 2c20 7370  grad_by_freq, sp
+00019540: 6172 7365 290a 2020 2020 7265 7475 726e  arse).    return
+00019550: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
+00019560: 2072 6573 6964 7561 6c73 290a 0a0a 4072   residuals)...@r
+00019570: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+00019580: 2822 746f 7263 682e 6e6e 2e66 756e 6374  ("torch.nn.funct
+00019590: 696f 6e61 6c2e 656d 6265 6464 696e 6722  ional.embedding"
+000195a0: 290a 6465 6620 656d 6265 6464 696e 675f  ).def embedding_
+000195b0: 6261 636b 7761 7264 2861 2c20 6e75 6d5f  backward(a, num_
+000195c0: 7765 6967 6874 732c 2070 6164 6469 6e67  weights, padding
+000195d0: 5f69 6478 2c20 7363 616c 655f 6772 6164  _idx, scale_grad
+000195e0: 5f62 795f 6672 6571 2c20 7370 6172 7365  _by_freq, sparse
+000195f0: 2c20 6729 3a0a 2020 2020 6672 6f6d 2074  , g):.    from t
+00019600: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
+00019610: 6f72 7420 656d 6265 6464 696e 675f 6261  ort embedding_ba
+00019620: 636b 7761 7264 0a0a 2020 2020 7061 6464  ckward..    padd
+00019630: 696e 675f 6964 7820 3d20 2d31 2069 6620  ing_idx = -1 if 
+00019640: 7061 6464 696e 675f 6964 7820 6973 204e  padding_idx is N
+00019650: 6f6e 6520 656c 7365 2070 6164 6469 6e67  one else padding
+00019660: 5f69 6478 0a20 2020 2067 7765 6967 6874  _idx.    gweight
+00019670: 203d 2065 6d62 6564 6469 6e67 5f62 6163   = embedding_bac
+00019680: 6b77 6172 6428 672c 2061 2c20 6e75 6d5f  kward(g, a, num_
+00019690: 7765 6967 6874 732c 2070 6164 6469 6e67  weights, padding
+000196a0: 5f69 6478 2c20 7363 616c 655f 6772 6164  _idx, scale_grad
+000196b0: 5f62 795f 6672 6571 2c20 7370 6172 7365  _by_freq, sparse
+000196c0: 290a 2020 2020 7265 7475 726e 2067 7765  ).    return gwe
+000196d0: 6967 6874 0a0a 0a40 7265 6769 7374 6572  ight...@register
+000196e0: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
+000196f0: 7264 2822 746f 7263 682e 6375 6d73 756d  rd("torch.cumsum
+00019700: 2229 0a64 6566 2063 756d 7375 6d5f 6175  ").def cumsum_au
+00019710: 675f 6677 6428 613a 2050 726f 7879 2c20  g_fwd(a: Proxy, 
+00019720: 6469 6d3a 2069 6e74 2c20 2a2c 2064 7479  dim: int, *, dty
+00019730: 7065 3a20 4e6f 6e65 207c 2064 7479 7065  pe: None | dtype
+00019740: 732e 6474 7970 6520 3d20 4e6f 6e65 2920  s.dtype = None) 
+00019750: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
+00019760: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
+00019770: 6368 2069 6d70 6f72 7420 6375 6d73 756d  ch import cumsum
+00019780: 0a0a 2020 2020 7072 696d 616c 203d 2063  ..    primal = c
+00019790: 756d 7375 6d28 612c 2064 696d 2c20 6474  umsum(a, dim, dt
+000197a0: 7970 653d 6474 7970 6529 0a20 2020 2072  ype=dtype).    r
+000197b0: 6573 6964 7561 6c73 203d 2028 0a20 2020  esiduals = (.   
+000197c0: 2020 2020 2061 2e64 7479 7065 2c0a 2020       a.dtype,.  
+000197d0: 2020 2020 2020 6469 6d2c 0a20 2020 2029        dim,.    )
+000197e0: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
+000197f0: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
+00019800: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
+00019810: 6572 5f62 6163 6b77 6172 6428 2274 6f72  er_backward("tor
+00019820: 6368 2e63 756d 7375 6d22 290a 6465 6620  ch.cumsum").def 
+00019830: 6375 6d73 756d 5f62 6163 6b77 6172 6428  cumsum_backward(
+00019840: 615f 6474 7970 652c 2064 696d 2c20 6729  a_dtype, dim, g)
+00019850: 3a0a 2020 2020 6720 3d20 672e 746f 2861  :.    g = g.to(a
+00019860: 5f64 7479 7065 290a 2020 2020 6966 2067  _dtype).    if g
+00019870: 2e6e 756d 656c 203c 3d20 3120 6f72 2067  .numel <= 1 or g
+00019880: 2e73 6861 7065 5b64 696d 5d20 3d3d 2031  .shape[dim] == 1
+00019890: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000198a0: 2067 0a20 2020 2072 6574 7572 6e20 672e   g.    return g.
+000198b0: 666c 6970 2864 696d 292e 6375 6d73 756d  flip(dim).cumsum
+000198c0: 2864 696d 292e 666c 6970 2864 696d 290a  (dim).flip(dim).
+000198d0: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
+000198e0: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
+000198f0: 6f72 6368 2e73 6f66 746d 6178 2229 0a64  orch.softmax").d
+00019900: 6566 2073 6f66 746d 6178 5f61 7567 5f66  ef softmax_aug_f
+00019910: 7764 2861 3a20 5072 6f78 792c 2064 696d  wd(a: Proxy, dim
+00019920: 3a20 696e 742c 2064 7479 7065 3a20 6474  : int, dtype: dt
+00019930: 7970 6573 2e64 7479 7065 207c 204e 6f6e  ypes.dtype | Non
+00019940: 6520 3d20 4e6f 6e65 2920 2d3e 2056 4a50  e = None) -> VJP
+00019950: 4475 616c 3a0a 2020 2020 6672 6f6d 2074  Dual:.    from t
+00019960: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
+00019970: 6f72 7420 736f 6674 6d61 780a 0a20 2020  ort softmax..   
+00019980: 2070 7269 6d61 6c20 3d20 736f 6674 6d61   primal = softma
+00019990: 7828 612c 2064 696d 2c20 6474 7970 653d  x(a, dim, dtype=
+000199a0: 6474 7970 6529 0a20 2020 2072 6573 6964  dtype).    resid
+000199b0: 7561 6c73 203d 2028 7072 696d 616c 2c20  uals = (primal, 
+000199c0: 6469 6d29 0a20 2020 2072 6574 7572 6e20  dim).    return 
+000199d0: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+000199e0: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+000199f0: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00019a00: 2274 6f72 6368 2e73 6f66 746d 6178 2229  "torch.softmax")
+00019a10: 0a64 6566 2073 6f66 746d 6178 5f62 6163  .def softmax_bac
+00019a20: 6b77 6172 6428 7072 696d 616c 2c20 6469  kward(primal, di
+00019a30: 6d2c 2067 293a 0a20 2020 2072 6574 7572  m, g):.    retur
+00019a40: 6e20 7072 696d 616c 202a 2028 6720 2d20  n primal * (g - 
+00019a50: 2870 7269 6d61 6c20 2a20 6729 2e73 756d  (primal * g).sum
+00019a60: 2864 696d 2c20 6b65 6570 6469 6d3d 5472  (dim, keepdim=Tr
+00019a70: 7565 2929 0a0a 0a64 6566 2069 7465 725f  ue))...def iter_
+00019a80: 626f 756e 645f 7379 6d62 6f6c 7328 626f  bound_symbols(bo
+00019a90: 756e 645f 7379 6d62 6f6c 7329 3a0a 2020  und_symbols):.  
+00019aa0: 2020 2222 2249 7465 7261 7465 206f 7665    """Iterate ove
+00019ab0: 7220 626f 756e 6420 7379 6d62 6f6c 732c  r bound symbols,
+00019ac0: 2073 6b69 7070 696e 6720 7379 6d62 6f6c   skipping symbol
+00019ad0: 7320 7468 6174 2061 7265 206e 6f74 2073  s that are not s
+00019ae0: 7570 706f 7274 6564 2062 790a 2020 2020  upported by.    
+00019af0: 7468 6520 7472 616e 7366 6f72 6d73 2069  the transforms i
+00019b00: 6e66 7261 7374 7275 6374 7572 652e 0a0a  nfrastructure...
+00019b10: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00019b20: 2020 626f 756e 645f 7379 6d62 6f6c 7320    bound_symbols 
+00019b30: 284c 6973 745b 426f 756e 6453 796d 626f  (List[BoundSymbo
+00019b40: 6c5d 293a 204c 6973 7420 6f66 2062 6f75  l]): List of bou
+00019b50: 6e64 2073 796d 626f 6c73 0a0a 2020 2020  nd symbols..    
+00019b60: 5969 656c 6473 3a0a 2020 2020 2020 2020  Yields:.        
+00019b70: 426f 756e 6453 796d 626f 6c3a 2042 6f75  BoundSymbol: Bou
+00019b80: 6e64 2073 796d 626f 6c73 2074 6861 7420  nd symbols that 
+00019b90: 6172 6520 7375 7070 6f72 7465 6420 6279  are supported by
+00019ba0: 2074 6865 2074 7261 6e73 666f 726d 730a   the transforms.
+00019bb0: 2020 2020 2020 2020 696e 6672 6173 7472          infrastr
+00019bc0: 7563 7475 7265 0a20 2020 2022 2222 0a20  ucture.    """. 
+00019bd0: 2020 2066 6f72 2073 796d 626f 6c20 696e     for symbol in
+00019be0: 2062 6f75 6e64 5f73 796d 626f 6c73 3a0a   bound_symbols:.
+00019bf0: 2020 2020 2020 2020 6966 2073 796d 626f          if symbo
+00019c00: 6c2e 7379 6d2e 6964 2069 6e20 7472 616e  l.sym.id in tran
+00019c10: 7366 6f72 6d5f 736b 6970 5f6c 6973 743a  sform_skip_list:
+00019c20: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00019c30: 7469 6e75 650a 2020 2020 2020 2020 656c  tinue.        el
+00019c40: 6966 2073 796d 626f 6c2e 6f75 7470 7574  if symbol.output
+00019c50: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00019c60: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00019c70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00019c80: 2020 2020 2020 2020 2079 6965 6c64 2073           yield s
+00019c90: 796d 626f 6c0a 0a0a 6465 6620 6465 636f  ymbol...def deco
+00019ca0: 6e73 7472 7563 745f 666f 7277 6172 645f  nstruct_forward_
+00019cb0: 656e 765f 666f 725f 6261 636b 7761 7264  env_for_backward
+00019cc0: 2874 7261 6365 2c20 656e 7629 3a0a 2020  (trace, env):.  
+00019cd0: 2020 2320 4e6f 7465 205b 5361 7669 6e67    # Note [Saving
+00019ce0: 2074 6865 2066 6f72 7761 7264 2065 6e76   the forward env
+00019cf0: 6972 6f6e 6d65 6e74 2069 6e20 7468 6520  ironment in the 
+00019d00: 6261 636b 7761 7264 2072 756c 655d 0a20  backward rule]. 
+00019d10: 2020 2023 2057 6520 6361 6e6e 6f74 2073     # We cannot s
+00019d20: 6176 6520 7468 6520 7472 6163 6520 6f62  ave the trace ob
+00019d30: 6a65 6374 2069 6e20 7468 6520 7265 7369  ject in the resi
+00019d40: 6475 616c 7320 6265 6361 7573 6520 6578  duals because ex
+00019d50: 6563 7574 6f72 7320 6d61 7920 6e6f 740a  ecutors may not.
+00019d60: 2020 2020 2320 6265 2061 626c 6520 746f      # be able to
+00019d70: 2072 6574 7572 6e20 6974 2066 6f72 2074   return it for t
+00019d80: 6865 2073 706c 6974 7465 6420 666f 7277  he splitted forw
+00019d90: 6172 642f 6261 636b 7761 7264 2070 6173  ard/backward pas
+00019da0: 7365 732e 2049 6e73 7465 6164 2c20 7765  ses. Instead, we
+00019db0: 0a20 2020 2023 2073 6176 6520 6172 6773  .    # save args
+00019dc0: 2061 6e64 206b 7761 7267 7320 6f66 2074   and kwargs of t
+00019dd0: 6865 206f 7269 6769 6e61 6c20 6675 6e63  he original func
+00019de0: 7469 6f6e 2063 616c 6c20 616e 6420 7265  tion call and re
+00019df0: 636f 6e73 7472 7563 7420 7468 650a 2020  construct the.  
+00019e00: 2020 2320 7472 6163 6520 6f62 6a65 6374    # trace object
+00019e10: 2061 6e64 2069 7473 2065 6e76 6972 6f6e   and its environ
+00019e20: 6d65 6e74 2064 6963 7420 696e 2074 6865  ment dict in the
+00019e30: 2062 6163 6b77 6172 6420 7275 6c65 2e20   backward rule. 
+00019e40: 4865 7265 2077 6520 7265 6c79 0a20 2020  Here we rely.   
+00019e50: 2023 206f 6e20 7468 6520 6661 6374 2074   # on the fact t
+00019e60: 6861 7420 7468 6520 6f72 6465 7220 6f66  hat the order of
+00019e70: 2074 6865 2073 796d 626f 6c73 2069 6e20   the symbols in 
+00019e80: 7468 6520 7472 6163 6520 6973 2064 6574  the trace is det
+00019e90: 6572 6d69 6e69 7374 6963 0a20 2020 2023  erministic.    #
+00019ea0: 2061 6e64 2061 6c77 6179 7320 7468 6520   and always the 
+00019eb0: 7361 6d65 2066 6f72 2074 6865 2073 616d  same for the sam
+00019ec0: 6520 6675 6e63 7469 6f6e 2063 616c 6c20  e function call 
+00019ed0: 616e 6420 7468 6520 7361 6d65 2073 6574  and the same set
+00019ee0: 206f 660a 2020 2020 2320 6172 6775 6d65   of.    # argume
+00019ef0: 6e74 732e 2053 6565 2074 6573 745f 6772  nts. See test_gr
+00019f00: 6164 2e70 793a 7465 7374 5f74 6f72 6368  ad.py:test_torch
+00019f10: 5f61 7574 6f67 7261 645f 6675 6e63 7469  _autograd_functi
+00019f20: 6f6e 2066 6f72 2061 6e20 6578 616d 706c  on for an exampl
+00019f30: 650a 2020 2020 2320 7768 6572 6520 7468  e.    # where th
+00019f40: 6973 2069 7320 7465 7374 6564 2e0a 2020  is is tested..  
+00019f50: 2020 626f 756e 645f 7379 6d62 6f6c 7320    bound_symbols 
+00019f60: 3d20 6974 6572 5f62 6f75 6e64 5f73 796d  = iter_bound_sym
+00019f70: 626f 6c73 2874 7261 6365 2e62 6f75 6e64  bols(trace.bound
+00019f80: 5f73 796d 626f 6c73 290a 2020 2020 7361  _symbols).    sa
+00019f90: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+00019fa0: 203d 2074 7570 6c65 2865 6e76 5b73 6571   = tuple(env[seq
+00019fb0: 7565 6e63 6966 7928 7379 6d62 6f6c 2e6f  uencify(symbol.o
+00019fc0: 7574 7075 7429 5b30 5d2e 6e61 6d65 5d2e  utput)[0].name].
+00019fd0: 7265 7369 6475 616c 7320 666f 7220 7379  residuals for sy
+00019fe0: 6d62 6f6c 2069 6e20 626f 756e 645f 7379  mbol in bound_sy
+00019ff0: 6d62 6f6c 7329 0a20 2020 2072 6574 7572  mbols).    retur
+0001a000: 6e20 7361 7665 645f 666f 725f 6261 636b  n saved_for_back
+0001a010: 7761 7264 0a0a 0a64 6566 2072 6563 6f6e  ward...def recon
+0001a020: 7374 7275 6374 5f66 6f72 7761 7264 5f65  struct_forward_e
+0001a030: 6e76 5f66 6f72 5f62 6163 6b77 6172 6428  nv_for_backward(
+0001a040: 7472 6163 652c 2073 6176 6564 5f66 6f72  trace, saved_for
+0001a050: 5f62 6163 6b77 6172 6429 3a0a 2020 2020  _backward):.    
+0001a060: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
+0001a070: 6974 6572 5f62 6f75 6e64 5f73 796d 626f  iter_bound_symbo
+0001a080: 6c73 2874 7261 6365 2e62 6f75 6e64 5f73  ls(trace.bound_s
+0001a090: 796d 626f 6c73 290a 0a20 2020 2072 6563  ymbols)..    rec
+0001a0a0: 6f6e 7374 7275 6374 6564 5f65 6e76 203d  onstructed_env =
+0001a0b0: 207b 7d0a 0a20 2020 2066 6f72 2069 6478   {}..    for idx
+0001a0c0: 2c20 7379 6d20 696e 2065 6e75 6d65 7261  , sym in enumera
+0001a0d0: 7465 2862 6f75 6e64 5f73 796d 626f 6c73  te(bound_symbols
+0001a0e0: 293a 0a20 2020 2020 2020 206b 203d 2073  ):.        k = s
+0001a0f0: 6571 7565 6e63 6966 7928 7379 6d2e 6f75  equencify(sym.ou
+0001a100: 7470 7574 295b 305d 2e6e 616d 650a 2020  tput)[0].name.  
+0001a110: 2020 2020 2020 7620 3d20 564a 5044 7561        v = VJPDua
+0001a120: 6c28 4e6f 6e65 2c20 7361 7665 645f 666f  l(None, saved_fo
+0001a130: 725f 6261 636b 7761 7264 5b69 6478 5d29  r_backward[idx])
+0001a140: 0a20 2020 2020 2020 2072 6563 6f6e 7374  .        reconst
+0001a150: 7275 6374 6564 5f65 6e76 5b6b 5d20 3d20  ructed_env[k] = 
+0001a160: 760a 0a20 2020 2072 6574 7572 6e20 7265  v..    return re
+0001a170: 636f 6e73 7472 7563 7465 645f 656e 760a  constructed_env.
+0001a180: 0a0a 6465 6620 6465 636f 6d70 6f73 6564  ..def decomposed
+0001a190: 5f66 6e5f 6175 675f 6677 645f 7275 6c65  _fn_aug_fwd_rule
+0001a1a0: 282a 6172 6773 2c20 6465 636f 6d70 6f73  (*args, decompos
+0001a1b0: 6564 5f66 6e2c 202a 2a6b 7761 7267 7329  ed_fn, **kwargs)
+0001a1c0: 3a0a 2020 2020 2222 2241 7567 6d65 6e74  :.    """Augment
+0001a1d0: 6564 2066 6f72 7761 7264 2072 756c 6520  ed forward rule 
+0001a1e0: 666f 7220 636f 6d70 6f73 6974 6520 6675  for composite fu
+0001a1f0: 6e63 7469 6f6e 7320 696d 706c 656d 656e  nctions implemen
+0001a200: 7465 6420 696e 2074 6572 6d73 206f 6620  ted in terms of 
+0001a210: 6f74 6865 7220 6675 6e63 7469 6f6e 7320  other functions 
+0001a220: 7468 6174 2061 7265 0a20 2020 2073 7570  that are.    sup
+0001a230: 706f 7365 6420 746f 2062 6520 7375 7070  posed to be supp
+0001a240: 6f72 7465 6420 6279 2074 6865 2056 4a50  orted by the VJP
+0001a250: 2069 6e66 7261 7374 7275 6374 7572 652e   infrastructure.
+0001a260: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0001a270: 2020 2020 6465 636f 6d70 6f73 6564 5f66      decomposed_f
+0001a280: 6e20 2843 616c 6c61 626c 6529 3a20 6465  n (Callable): de
+0001a290: 636f 6d70 6f73 6564 2076 6572 7369 6f6e  composed version
+0001a2a0: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
+0001a2b0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0001a2c0: 2020 2020 2020 2043 616c 6c61 626c 653a         Callable:
+0001a2d0: 2041 7567 6d65 6e74 6564 2066 6f72 7761   Augmented forwa
+0001a2e0: 7264 2072 756c 6520 666f 7220 7468 6520  rd rule for the 
+0001a2f0: 636f 6d70 6f73 6974 6520 6675 6e63 7469  composite functi
+0001a300: 6f6e 0a20 2020 2022 2222 0a20 2020 2074  on.    """.    t
+0001a310: 7261 6365 203d 2063 6f6e 7374 7275 6374  race = construct
+0001a320: 5f74 7261 6365 2829 2864 6563 6f6d 706f  _trace()(decompo
+0001a330: 7365 645f 666e 2c20 2a61 7267 732c 202a  sed_fn, *args, *
+0001a340: 2a6b 7761 7267 7329 0a20 2020 2074 7261  *kwargs).    tra
+0001a350: 6365 203d 2075 6e77 7261 705f 6f6e 655f  ce = unwrap_one_
+0001a360: 6c65 7665 6c5f 6f66 5f73 7562 7379 6d62  level_of_subsymb
+0001a370: 6f6c 7328 7472 6163 6529 0a20 2020 2023  ols(trace).    #
+0001a380: 2054 6865 7265 206d 6179 2062 6520 6120   There may be a 
+0001a390: 6465 6164 206e 6f64 6520 6c69 6b65 2022  dead node like "
+0001a3a0: 5f20 3d20 7072 696d 732e 636f 6e76 6572  _ = prims.conver
+0001a3b0: 745f 656c 656d 656e 745f 7479 7065 2830  t_element_type(0
+0001a3c0: 2c20 666c 6f61 7429 220a 2020 2020 2320  , float)".    # 
+0001a3d0: 696e 2074 6865 2074 7261 6365 2e20 5765  in the trace. We
+0001a3e0: 206e 6565 6420 746f 2072 656d 6f76 6520   need to remove 
+0001a3f0: 6974 2062 6566 6f72 6520 7765 2063 616e  it before we can
+0001a400: 2075 7365 2074 6865 2074 7261 6365 2066   use the trace f
+0001a410: 6f72 0a20 2020 2023 2061 7567 6d65 6e74  or.    # augment
+0001a420: 6564 5f66 6f72 7761 7264 5f70 6173 732e  ed_forward_pass.
+0001a430: 0a20 2020 2074 7261 6365 203d 2064 6365  .    trace = dce
+0001a440: 2874 7261 6365 290a 2020 2020 7265 7375  (trace).    resu
+0001a450: 6c74 2c20 656e 7620 3d20 6175 676d 656e  lt, env = augmen
+0001a460: 7465 645f 666f 7277 6172 645f 7061 7373  ted_forward_pass
+0001a470: 282a 6172 6773 2c20 7472 6163 653d 7472  (*args, trace=tr
+0001a480: 6163 652c 202a 2a6b 7761 7267 7329 0a20  ace, **kwargs). 
+0001a490: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
+0001a4a0: 6b77 6172 6420 3d20 6465 636f 6e73 7472  kward = deconstr
+0001a4b0: 7563 745f 666f 7277 6172 645f 656e 765f  uct_forward_env_
+0001a4c0: 666f 725f 6261 636b 7761 7264 2874 7261  for_backward(tra
+0001a4d0: 6365 2c20 656e 7629 0a20 2020 2023 2053  ce, env).    # S
+0001a4e0: 7461 7469 6320 6361 6368 696e 6720 646f  tatic caching do
+0001a4f0: 6573 206e 6f74 2077 6974 6820 7769 7468  es not with with
+0001a500: 206b 7761 7267 7320 6469 6374 732c 2073   kwargs dicts, s
+0001a510: 6f20 7765 2772 6520 636f 6e76 6572 7469  o we're converti
+0001a520: 6e67 2074 6865 6d0a 2020 2020 2320 746f  ng them.    # to
+0001a530: 204e 6f6e 6520 666f 7220 6e6f 7720 7768   None for now wh
+0001a540: 656e 2070 6f73 7369 626c 652e 0a20 2020  en possible..   
+0001a550: 206b 7761 7267 7320 3d20 4e6f 6e65 2069   kwargs = None i
+0001a560: 6620 6e6f 7420 6b77 6172 6773 2065 6c73  f not kwargs els
+0001a570: 6520 6b77 6172 6773 0a20 2020 2072 6573  e kwargs.    res
+0001a580: 6964 7561 6c73 203d 2028 6172 6773 2c20  iduals = (args, 
+0001a590: 6b77 6172 6773 2c20 7361 7665 645f 666f  kwargs, saved_fo
+0001a5a0: 725f 6261 636b 7761 7264 290a 2020 2020  r_backward).    
+0001a5b0: 7265 7475 726e 2056 4a50 4475 616c 2872  return VJPDual(r
+0001a5c0: 6573 756c 742c 2072 6573 6964 7561 6c73  esult, residuals
+0001a5d0: 290a 0a0a 6465 6620 6465 636f 6d70 6f73  )...def decompos
+0001a5e0: 6564 5f66 6e5f 6261 636b 7761 7264 5f72  ed_fn_backward_r
+0001a5f0: 756c 6528 6465 636f 6d70 6f73 6564 5f66  ule(decomposed_f
+0001a600: 6e2c 2061 7267 732c 206b 7761 7267 732c  n, args, kwargs,
+0001a610: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001a620: 6172 642c 202a 6772 6164 7329 3a0a 2020  ard, *grads):.  
+0001a630: 2020 6b77 6172 6773 203d 207b 7d20 6966    kwargs = {} if
+0001a640: 206b 7761 7267 7320 6973 204e 6f6e 6520   kwargs is None 
+0001a650: 656c 7365 206b 7761 7267 730a 2020 2020  else kwargs.    
+0001a660: 7472 6163 6520 3d20 636f 6e73 7472 7563  trace = construc
+0001a670: 745f 7472 6163 6528 2928 6465 636f 6d70  t_trace()(decomp
+0001a680: 6f73 6564 5f66 6e2c 202a 6172 6773 2c20  osed_fn, *args, 
+0001a690: 2a2a 6b77 6172 6773 290a 2020 2020 7472  **kwargs).    tr
+0001a6a0: 6163 6520 3d20 756e 7772 6170 5f6f 6e65  ace = unwrap_one
+0001a6b0: 5f6c 6576 656c 5f6f 665f 7375 6273 796d  _level_of_subsym
+0001a6c0: 626f 6c73 2874 7261 6365 290a 2020 2020  bols(trace).    
+0001a6d0: 7472 6163 6520 3d20 6463 6528 7472 6163  trace = dce(trac
+0001a6e0: 6529 0a20 2020 2023 2062 6f75 6e64 5f73  e).    # bound_s
+0001a6f0: 796d 626f 6c73 203d 2069 7465 725f 626f  ymbols = iter_bo
+0001a700: 756e 645f 7379 6d62 6f6c 7328 7472 6163  und_symbols(trac
+0001a710: 652e 626f 756e 645f 7379 6d62 6f6c 7329  e.bound_symbols)
+0001a720: 0a20 2020 2023 2072 6563 6f6e 7374 7275  .    # reconstru
+0001a730: 6374 6564 5f65 6e76 203d 207b 0a20 2020  cted_env = {.   
+0001a740: 2023 2020 2020 2073 6571 7565 6e63 6966   #     sequencif
+0001a750: 7928 7379 6d62 6f6c 2e6f 7574 7075 7429  y(symbol.output)
+0001a760: 5b30 5d2e 6e61 6d65 3a20 564a 5044 7561  [0].name: VJPDua
+0001a770: 6c28 4e6f 6e65 2c20 7361 7665 645f 666f  l(None, saved_fo
+0001a780: 725f 6261 636b 7761 7264 5b69 5d29 0a20  r_backward[i]). 
+0001a790: 2020 2023 2020 2020 2066 6f72 2069 2c20     #     for i, 
+0001a7a0: 7379 6d62 6f6c 2069 6e20 656e 756d 6572  symbol in enumer
+0001a7b0: 6174 6528 626f 756e 645f 7379 6d62 6f6c  ate(bound_symbol
+0001a7c0: 7329 0a20 2020 2023 207d 0a20 2020 2072  s).    # }.    r
+0001a7d0: 6563 6f6e 7374 7275 6374 6564 5f65 6e76  econstructed_env
+0001a7e0: 203d 2072 6563 6f6e 7374 7275 6374 5f66   = reconstruct_f
+0001a7f0: 6f72 7761 7264 5f65 6e76 5f66 6f72 5f62  orward_env_for_b
+0001a800: 6163 6b77 6172 6428 7472 6163 652c 2073  ackward(trace, s
+0001a810: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001a820: 6429 0a20 2020 2072 6573 756c 7420 3d20  d).    result = 
+0001a830: 6261 636b 7761 7264 5f70 6173 7328 7265  backward_pass(re
+0001a840: 636f 6e73 7472 7563 7465 645f 656e 762c  constructed_env,
+0001a850: 2074 7261 6365 2c20 6772 6164 7329 0a20   trace, grads). 
+0001a860: 2020 2069 6620 6c65 6e28 6172 6773 2920     if len(args) 
+0001a870: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
+0001a880: 7475 726e 2072 6573 756c 745b 305d 0a20  turn result[0]. 
+0001a890: 2020 2023 2042 6163 6b77 6172 6420 7061     # Backward pa
+0001a8a0: 7373 206d 6967 6874 2072 6574 7572 6e20  ss might return 
+0001a8b0: 6120 6469 6374 2077 6974 6820 6772 6164  a dict with grad
+0001a8c0: 7320 6275 7420 6375 7272 656e 7420 696e  s but current in
+0001a8d0: 7465 7266 6163 6520 6f66 0a20 2020 2023  terface of.    #
+0001a8e0: 2062 6163 6b77 6172 6420 7275 6c65 2064   backward rule d
+0001a8f0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001a900: 6974 2e20 536f 2077 6520 6a75 7374 2064  it. So we just d
+0001a910: 726f 7020 6974 2066 6f72 206e 6f77 2e0a  rop it for now..
+0001a920: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+0001a930: 6e63 6528 7265 7375 6c74 5b2d 315d 2c20  nce(result[-1], 
+0001a940: 6469 6374 293a 0a20 2020 2020 2020 2072  dict):.        r
+0001a950: 6574 7572 6e20 7265 7375 6c74 5b3a 2d31  eturn result[:-1
+0001a960: 5d0a 2020 2020 7265 7475 726e 2072 6573  ].    return res
+0001a970: 756c 740a 0a0a 4072 6567 6973 7465 725f  ult...@register_
+0001a980: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+0001a990: 6428 2274 6f72 6368 2e54 656e 736f 722e  d("torch.Tensor.
+0001a9a0: 636f 6e74 6967 756f 7573 2229 0a40 7265  contiguous").@re
+0001a9b0: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
+0001a9c0: 5f66 6f72 7761 7264 2822 746f 7263 682e  _forward("torch.
+0001a9d0: 636f 6e74 6967 756f 7573 2229 0a64 6566  contiguous").def
+0001a9e0: 2063 6f6e 7469 6775 6f75 735f 6175 675f   contiguous_aug_
+0001a9f0: 6677 6428 783a 2054 656e 736f 7250 726f  fwd(x: TensorPro
+0001aa00: 7879 2c20 2f2c 202a 2c20 6d65 6d6f 7279  xy, /, *, memory
+0001aa10: 5f66 6f72 6d61 743a 2074 6f72 6368 2e6d  _format: torch.m
+0001aa20: 656d 6f72 795f 666f 726d 6174 203d 2074  emory_format = t
+0001aa30: 6f72 6368 2e63 6f6e 7469 6775 6f75 735f  orch.contiguous_
+0001aa40: 666f 726d 6174 2920 2d3e 2056 4a50 4475  format) -> VJPDu
+0001aa50: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
+0001aa60: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
+0001aa70: 7420 636f 6e74 6967 756f 7573 0a0a 2020  t contiguous..  
+0001aa80: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
+0001aa90: 2863 6f6e 7469 6775 6f75 7328 782c 206d  (contiguous(x, m
+0001aaa0: 656d 6f72 795f 666f 726d 6174 3d6d 656d  emory_format=mem
+0001aab0: 6f72 795f 666f 726d 6174 292c 2074 7570  ory_format), tup
+0001aac0: 6c65 2829 290a 0a0a 4072 6567 6973 7465  le())...@registe
+0001aad0: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
+0001aae0: 682e 5465 6e73 6f72 2e63 6f6e 7469 6775  h.Tensor.contigu
+0001aaf0: 6f75 7322 290a 4072 6567 6973 7465 725f  ous").@register_
+0001ab00: 6261 636b 7761 7264 2822 746f 7263 682e  backward("torch.
+0001ab10: 636f 6e74 6967 756f 7573 2229 0a64 6566  contiguous").def
+0001ab20: 2063 6f6e 7469 6775 6f75 735f 6261 636b   contiguous_back
+0001ab30: 7761 7264 282a 7265 7369 6475 616c 735f  ward(*residuals_
+0001ab40: 616e 645f 6772 6164 2920 2d3e 2054 656e  and_grad) -> Ten
+0001ab50: 736f 7250 726f 7879 3a0a 2020 2020 2320  sorProxy:.    # 
+0001ab60: 5265 7369 6475 616c 7320 6973 206e 6f74  Residuals is not
+0001ab70: 2065 6d70 7479 2062 6563 6175 7365 2063   empty because c
+0001ab80: 6f6e 7469 6775 6f75 7320 7379 6d62 6f6c  ontiguous symbol
+0001ab90: 2068 6173 2074 6865 2073 616d 6520 6f75   has the same ou
+0001aba0: 7470 7574 2061 7320 6974 7320 696e 7075  tput as its inpu
+0001abb0: 740a 2020 2020 6720 3d20 7265 7369 6475  t.    g = residu
+0001abc0: 616c 735f 616e 645f 6772 6164 5b2d 315d  als_and_grad[-1]
+0001abd0: 0a20 2020 2072 6574 7572 6e20 670a 0a0a  .    return g...
+0001abe0: 6465 6620 7265 6369 7072 6f63 616c 5f61  def reciprocal_a
+0001abf0: 7567 5f66 7764 2861 3a20 5465 6e73 6f72  ug_fwd(a: Tensor
+0001ac00: 5072 6f78 7929 202d 3e20 564a 5044 7561  Proxy) -> VJPDua
+0001ac10: 6c3a 0a20 2020 2070 7269 6d61 6c20 3d20  l:.    primal = 
+0001ac20: 7265 6369 7072 6f63 616c 2861 290a 2020  reciprocal(a).  
+0001ac30: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
+0001ac40: 2870 7269 6d61 6c2c 2028 7072 696d 616c  (primal, (primal
+0001ac50: 2c29 290a 0a0a 6465 6620 7265 6369 7072  ,))...def recipr
+0001ac60: 6f63 616c 5f62 6163 6b77 6172 6428 7072  ocal_backward(pr
+0001ac70: 696d 616c 2c20 6729 3a0a 2020 2020 7265  imal, g):.    re
+0001ac80: 7475 726e 202d 6720 2a20 7072 696d 616c  turn -g * primal
+0001ac90: 202a 2070 7269 6d61 6c0a 0a0a 4070 6172   * primal...@par
+0001aca0: 7469 616c 2872 6567 6973 7465 725f 6772  tial(register_gr
+0001acb0: 6164 2c20 7072 696d 732e 5072 696d 4944  ad, prims.PrimID
+0001acc0: 732e 5245 4349 5052 4f43 414c 290a 6465  s.RECIPROCAL).de
+0001acd0: 6620 7265 6369 7072 6f63 616c 5f6a 6f69  f reciprocal_joi
+0001ace0: 6e74 5f66 6f72 7761 7264 5f62 6163 6b77  nt_forward_backw
+0001acf0: 6172 645f 7275 6c65 2861 3a20 5465 6e73  ard_rule(a: Tens
+0001ad00: 6f72 5072 6f78 7929 202d 3e20 5465 6e73  orProxy) -> Tens
+0001ad10: 6f72 5072 6f78 793a 0a20 2020 2072 6573  orProxy:.    res
+0001ad20: 756c 742c 2073 6176 6564 203d 2072 6563  ult, saved = rec
+0001ad30: 6970 726f 6361 6c5f 6175 675f 6677 6428  iprocal_aug_fwd(
+0001ad40: 6129 0a20 2020 2067 203d 2067 6574 5f67  a).    g = get_g
+0001ad50: 7261 6428 7265 7375 6c74 290a 2020 2020  rad(result).    
+0001ad60: 6761 203d 2072 6563 6970 726f 6361 6c5f  ga = reciprocal_
+0001ad70: 6261 636b 7761 7264 282a 7361 7665 642c  backward(*saved,
+0001ad80: 2067 290a 2020 2020 7075 745f 6772 6164   g).    put_grad
+0001ad90: 2861 2c20 6761 290a 2020 2020 7265 7475  (a, ga).    retu
+0001ada0: 726e 2072 6573 756c 740a 0a0a 4072 6567  rn result...@reg
+0001adb0: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+0001adc0: 666f 7277 6172 6428 2274 6f72 6368 2e69  forward("torch.i
+0001add0: 6e64 6578 5f70 7574 2229 0a64 6566 2069  ndex_put").def i
+0001ade0: 6e64 6578 5f70 7574 5f61 7567 5f66 7764  ndex_put_aug_fwd
+0001adf0: 280a 2020 2020 613a 2054 656e 736f 7250  (.    a: TensorP
+0001ae00: 726f 7879 2c20 2f2c 2069 6e64 6963 6573  roxy, /, indices
+0001ae10: 3a20 5365 7175 656e 6365 5b54 656e 736f  : Sequence[Tenso
+0001ae20: 7250 726f 7879 5d2c 2076 616c 7565 733a  rProxy], values:
+0001ae30: 2054 656e 736f 7250 726f 7879 2c20 6163   TensorProxy, ac
+0001ae40: 6375 6d75 6c61 7465 3a20 626f 6f6c 203d  cumulate: bool =
+0001ae50: 2046 616c 7365 0a29 202d 3e20 564a 5044   False.) -> VJPD
+0001ae60: 7561 6c3a 0a20 2020 2070 7269 6d61 6c20  ual:.    primal 
+0001ae70: 3d20 636c 616e 672e 696e 6465 785f 7075  = clang.index_pu
+0001ae80: 7428 612c 2069 6e64 6963 6573 2c20 7661  t(a, indices, va
+0001ae90: 6c75 6573 2c20 6163 6375 6d75 6c61 7465  lues, accumulate
+0001aea0: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
+0001aeb0: 3d20 280a 2020 2020 2020 2020 696e 6469  = (.        indi
+0001aec0: 6365 732c 0a20 2020 2020 2020 2076 616c  ces,.        val
+0001aed0: 7565 732c 0a20 2020 2020 2020 2061 6363  ues,.        acc
+0001aee0: 756d 756c 6174 652c 0a20 2020 2029 0a20  umulate,.    ). 
+0001aef0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+0001af00: 6c28 7072 696d 616c 2c20 7265 7369 6475  l(primal, residu
+0001af10: 616c 7329 0a0a 0a64 6566 2073 756d 5f74  als)...def sum_t
+0001af20: 6f28 613a 2054 656e 736f 7250 726f 7879  o(a: TensorProxy
+0001af30: 2c20 7368 6170 653a 2053 6571 7565 6e63  , shape: Sequenc
+0001af40: 655b 696e 745d 2920 2d3e 2054 656e 736f  e[int]) -> Tenso
+0001af50: 7250 726f 7879 3a0a 2020 2020 6966 206e  rProxy:.    if n
+0001af60: 6f74 2073 6861 7065 3a0a 2020 2020 2020  ot shape:.      
+0001af70: 2020 7265 7475 726e 2061 2e73 756d 2829    return a.sum()
+0001af80: 0a20 2020 206c 6561 6469 6e67 5f64 696d  .    leading_dim
+0001af90: 7320 3d20 612e 6e64 696d 202d 206c 656e  s = a.ndim - len
+0001afa0: 2873 6861 7065 290a 2020 2020 7265 6475  (shape).    redu
+0001afb0: 6365 5f64 696d 7320 3d20 7475 706c 6528  ce_dims = tuple(
+0001afc0: 7261 6e67 6528 6c65 6164 696e 675f 6469  range(leading_di
+0001afd0: 6d73 2929 202b 2074 7570 6c65 280a 2020  ms)) + tuple(.  
+0001afe0: 2020 2020 2020 6920 666f 7220 6920 696e        i for i in
+0001aff0: 2072 616e 6765 286c 6561 6469 6e67 5f64   range(leading_d
+0001b000: 696d 732c 2061 2e6e 6469 6d29 2069 6620  ims, a.ndim) if 
+0001b010: 7368 6170 655b 6920 2d20 6c65 6164 696e  shape[i - leadin
+0001b020: 675f 6469 6d73 5d20 3d3d 2031 2061 6e64  g_dims] == 1 and
+0001b030: 2061 2e73 6861 7065 5b69 5d20 213d 2031   a.shape[i] != 1
+0001b040: 0a20 2020 2029 0a20 2020 2061 203d 206c  .    ).    a = l
+0001b050: 746f 7263 682e 7375 6d28 612c 2064 696d  torch.sum(a, dim
+0001b060: 3d72 6564 7563 655f 6469 6d73 2c20 6b65  =reduce_dims, ke
+0001b070: 6570 6469 6d3d 5472 7565 290a 2020 2020  epdim=True).    
+0001b080: 6966 206c 6561 6469 6e67 5f64 696d 7320  if leading_dims 
+0001b090: 3e20 303a 0a20 2020 2020 2020 2072 6574  > 0:.        ret
+0001b0a0: 7572 6e20 6c74 6f72 6368 2e76 6965 7728  urn ltorch.view(
+0001b0b0: 612c 2073 6861 7065 290a 2020 2020 7265  a, shape).    re
+0001b0c0: 7475 726e 2061 0a0a 0a40 7265 6769 7374  turn a...@regist
+0001b0d0: 6572 5f62 6163 6b77 6172 6428 2274 6f72  er_backward("tor
+0001b0e0: 6368 2e69 6e64 6578 5f70 7574 2229 0a64  ch.index_put").d
+0001b0f0: 6566 2069 6e64 6578 5f70 7574 5f62 6163  ef index_put_bac
+0001b100: 6b77 6172 6428 696e 6469 6365 733a 2053  kward(indices: S
+0001b110: 6571 7565 6e63 655b 5465 6e73 6f72 5072  equence[TensorPr
+0001b120: 6f78 795d 2c20 7661 6c75 6573 3a20 5465  oxy], values: Te
+0001b130: 6e73 6f72 5072 6f78 792c 2061 6363 756d  nsorProxy, accum
+0001b140: 756c 6174 653a 2062 6f6f 6c2c 2067 3a20  ulate: bool, g: 
+0001b150: 5465 6e73 6f72 5072 6f78 7929 3a0a 2020  TensorProxy):.  
+0001b160: 2020 675f 7661 6c75 6573 203d 2067 5b69    g_values = g[i
+0001b170: 6e64 6963 6573 5d0a 2020 2020 2320 746f  ndices].    # to
+0001b180: 7263 6820 6861 7320 6578 7472 6120 6c6f  rch has extra lo
+0001b190: 6769 6320 746f 2068 616e 646c 6520 7468  gic to handle th
+0001b1a0: 6520 6578 7061 6e64 6564 2076 616c 7565  e expanded value
+0001b1b0: 730a 2020 2020 6966 206e 6f74 2075 7469  s.    if not uti
+0001b1c0: 6c73 2e73 616d 655f 7368 6170 6528 675f  ls.same_shape(g_
+0001b1d0: 7661 6c75 6573 2e73 6861 7065 2c20 7661  values.shape, va
+0001b1e0: 6c75 6573 2e73 6861 7065 293a 0a20 2020  lues.shape):.   
+0001b1f0: 2020 2020 2069 6620 636c 616e 672e 636f       if clang.co
+0001b200: 6d70 7574 655f 6272 6f61 6463 6173 745f  mpute_broadcast_
+0001b210: 7368 6170 6528 675f 7661 6c75 6573 2e73  shape(g_values.s
+0001b220: 6861 7065 2c20 7661 6c75 6573 2e73 6861  hape, values.sha
+0001b230: 7065 293a 0a20 2020 2020 2020 2020 2020  pe):.           
+0001b240: 2067 5f76 616c 7565 7320 3d20 7375 6d5f   g_values = sum_
+0001b250: 746f 2867 5f76 616c 7565 732c 2076 616c  to(g_values, val
+0001b260: 7565 732e 7368 6170 6529 0a20 2020 2069  ues.shape).    i
+0001b270: 6620 6163 6375 6d75 6c61 7465 3a0a 2020  f accumulate:.  
+0001b280: 2020 2020 2020 7265 7475 726e 2067 2c20        return g, 
+0001b290: 675f 7661 6c75 6573 0a20 2020 2072 6574  g_values.    ret
+0001b2a0: 7572 6e20 636c 616e 672e 696e 6465 785f  urn clang.index_
+0001b2b0: 7075 7428 672c 2069 6e64 6963 6573 2c20  put(g, indices, 
+0001b2c0: 6c74 6f72 6368 2e7a 6572 6f73 5f6c 696b  ltorch.zeros_lik
+0001b2d0: 6528 7661 6c75 6573 292c 2046 616c 7365  e(values), False
+0001b2e0: 292c 2067 5f76 616c 7565 730a 0a0a 6465  ), g_values...de
+0001b2f0: 6620 756e 6966 6f72 6d5f 6175 675f 6677  f uniform_aug_fw
+0001b300: 6428 7368 6170 652c 206d 696e 7661 6c2c  d(shape, minval,
+0001b310: 206d 6178 7661 6c2c 202a 2c20 6465 7669   maxval, *, devi
+0001b320: 6365 2c20 6474 7970 6529 3a0a 2020 2020  ce, dtype):.    
+0001b330: 7072 696d 616c 203d 2070 7269 6d73 2e75  primal = prims.u
+0001b340: 6e69 666f 726d 2873 6861 7065 2c20 6d69  niform(shape, mi
+0001b350: 6e76 616c 2c20 6d61 7876 616c 2c20 6465  nval, maxval, de
+0001b360: 7669 6365 3d64 6576 6963 652c 2064 7479  vice=device, dty
+0001b370: 7065 3d64 7479 7065 290a 2020 2020 7265  pe=dtype).    re
+0001b380: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
+0001b390: 6d61 6c2c 2028 7072 696d 616c 2c20 6d69  mal, (primal, mi
+0001b3a0: 6e76 616c 2c20 6d61 7876 616c 2929 0a0a  nval, maxval))..
+0001b3b0: 0a64 6566 2075 6e69 666f 726d 5f62 6163  .def uniform_bac
+0001b3c0: 6b77 6172 6428 7072 696d 616c 2c20 6d69  kward(primal, mi
+0001b3d0: 6e76 616c 2c20 6d61 7876 616c 2c20 6729  nval, maxval, g)
+0001b3e0: 3a0a 2020 2020 2320 756e 6966 6f72 6d20  :.    # uniform 
+0001b3f0: 6973 2069 6d70 6c65 6d65 6e74 6564 2061  is implemented a
+0001b400: 7320 286d 6178 7661 6c20 2d20 6d69 6e76  s (maxval - minv
+0001b410: 616c 2920 2a20 756e 6966 6f72 6d28 7368  al) * uniform(sh
+0001b420: 6170 652c 2030 2c20 3129 202b 206d 696e  ape, 0, 1) + min
+0001b430: 7661 6c0a 2020 2020 756e 7363 616c 6564  val.    unscaled
+0001b440: 5f70 7269 6d61 6c20 3d20 2870 7269 6d61  _primal = (prima
+0001b450: 6c20 2d20 6d69 6e76 616c 2920 2f20 286d  l - minval) / (m
+0001b460: 6178 7661 6c20 2d20 6d69 6e76 616c 290a  axval - minval).
+0001b470: 2020 2020 7265 6475 6365 5f61 6c6c 5f64      reduce_all_d
+0001b480: 696d 7320 3d20 7475 706c 6528 7261 6e67  ims = tuple(rang
+0001b490: 6528 672e 6e64 696d 2929 0a20 2020 2073  e(g.ndim)).    s
+0001b4a0: 756d 203d 2070 6172 7469 616c 2870 7269  um = partial(pri
+0001b4b0: 6d73 2e73 756d 2c20 6469 6d73 3d72 6564  ms.sum, dims=red
+0001b4c0: 7563 655f 616c 6c5f 6469 6d73 290a 2020  uce_all_dims).  
+0001b4d0: 2020 7265 7475 726e 204e 6f6e 652c 2073    return None, s
+0001b4e0: 756d 2867 202a 2028 3120 2d20 756e 7363  um(g * (1 - unsc
+0001b4f0: 616c 6564 5f70 7269 6d61 6c29 292c 2073  aled_primal)), s
+0001b500: 756d 2867 202a 2075 6e73 6361 6c65 645f  um(g * unscaled_
+0001b510: 7072 696d 616c 290a 0a0a 6e6f 6e64 6966  primal)...nondif
+0001b520: 6665 7265 6e74 6961 626c 655f 766a 705f  ferentiable_vjp_
+0001b530: 7379 6d62 6f6c 7320 3d20 2870 7269 6d73  symbols = (prims
+0001b540: 2e50 7269 6d49 4473 2e42 4954 5749 5345  .PrimIDs.BITWISE
+0001b550: 5f41 4e44 2c20 7072 696d 732e 5072 696d  _AND, prims.Prim
+0001b560: 4944 732e 5349 474e 4249 542c 2070 7269  IDs.SIGNBIT, pri
+0001b570: 6d73 2e50 7269 6d49 4473 2e46 554c 4c29  ms.PrimIDs.FULL)
+0001b580: 0a0a 0a64 6566 2069 735f 636f 6e73 7461  ...def is_consta
+0001b590: 6e74 5f66 6f72 5f76 6a70 2873 796d 626f  nt_for_vjp(symbo
+0001b5a0: 6c3a 2070 7269 6d73 2e53 796d 626f 6c29  l: prims.Symbol)
+0001b5b0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2222   -> bool:.    ""
+0001b5c0: 2243 6865 636b 2069 6620 6120 7379 6d62  "Check if a symb
+0001b5d0: 6f6c 2069 7320 636f 6e73 7461 6e74 2066  ol is constant f
+0001b5e0: 6f72 2074 6865 2056 4a50 2074 7261 6e73  or the VJP trans
+0001b5f0: 666f 726d 2e0a 0a20 2020 2041 7267 733a  form...    Args:
+0001b600: 0a20 2020 2020 2020 2073 796d 626f 6c20  .        symbol 
+0001b610: 2870 7269 6d73 2e53 796d 626f 6c29 3a20  (prims.Symbol): 
+0001b620: 5379 6d62 6f6c 2074 6f20 6368 6563 6b2e  Symbol to check.
+0001b630: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0001b640: 2020 2020 2020 2062 6f6f 6c3a 2054 7275         bool: Tru
+0001b650: 6520 6966 2074 6865 2073 796d 626f 6c20  e if the symbol 
+0001b660: 6973 2063 6f6e 7374 616e 742c 2046 616c  is constant, Fal
+0001b670: 7365 206f 7468 6572 7769 7365 2e0a 2020  se otherwise..  
+0001b680: 2020 2222 220a 2020 2020 6172 655f 616c    """.    are_al
+0001b690: 6c5f 6172 6773 5f6e 6f6e 5f64 6966 6665  l_args_non_diffe
+0001b6a0: 7265 6e74 6961 626c 6520 3d20 6e6f 7420  rentiable = not 
+0001b6b0: 616e 7928 6973 696e 7374 616e 6365 2861  any(isinstance(a
+0001b6c0: 7267 2c20 2846 6c6f 6174 5072 6f78 792c  rg, (FloatProxy,
+0001b6d0: 2054 656e 736f 7250 726f 7879 2929 2066   TensorProxy)) f
+0001b6e0: 6f72 2061 7267 2069 6e20 7379 6d62 6f6c  or arg in symbol
+0001b6f0: 2e66 6c61 745f 6172 6773 290a 2020 2020  .flat_args).    
+0001b700: 7265 7475 726e 2028 0a20 2020 2020 2020  return (.       
+0001b710: 2061 7265 5f61 6c6c 5f61 7267 735f 6e6f   are_all_args_no
+0001b720: 6e5f 6469 6666 6572 656e 7469 6162 6c65  n_differentiable
+0001b730: 0a20 2020 2020 2020 206f 7220 7379 6d62  .        or symb
+0001b740: 6f6c 2e61 7265 5f61 6c6c 5f61 7267 735f  ol.are_all_args_
+0001b750: 636f 6e73 7461 6e74 0a20 2020 2020 2020  constant.       
+0001b760: 206f 7220 7379 6d62 6f6c 2e73 796d 2e69   or symbol.sym.i
+0001b770: 6420 696e 206e 6f6e 6469 6666 6572 656e  d in nondifferen
+0001b780: 7469 6162 6c65 5f76 6a70 5f73 796d 626f  tiable_vjp_symbo
+0001b790: 6c73 0a20 2020 2029 0a0a 0a64 6566 2076  ls.    )...def v
+0001b7a0: 6a70 5f73 796d 626f 6c5f 6d61 7070 6572  jp_symbol_mapper
+0001b7b0: 2873 796d 626f 6c3a 2070 7269 6d73 2e53  (symbol: prims.S
+0001b7c0: 796d 626f 6c2c 202a 6172 6773 2c20 2a2a  ymbol, *args, **
+0001b7d0: 6b77 6172 6773 293a 0a20 2020 2022 2222  kwargs):.    """
+0001b7e0: 5379 6d62 6f6c 206d 6170 7065 7220 666f  Symbol mapper fo
+0001b7f0: 7220 7468 6520 564a 5020 7472 616e 7366  r the VJP transf
+0001b800: 6f72 6d2e 0a0a 2020 2020 4172 6773 3a0a  orm...    Args:.
+0001b810: 2020 2020 2020 2020 7379 6d62 6f6c 2028          symbol (
+0001b820: 7072 696d 732e 5379 6d62 6f6c 293a 2053  prims.Symbol): S
+0001b830: 796d 626f 6c20 746f 2062 6520 6d61 7070  ymbol to be mapp
+0001b840: 6564 2e0a 2020 2020 2020 2020 6172 6773  ed..        args
+0001b850: 2028 5475 706c 655b 5661 7269 6162 6c65   (Tuple[Variable
+0001b860: 5d29 3a20 4172 6775 6d65 6e74 7320 746f  ]): Arguments to
+0001b870: 2074 6865 2073 796d 626f 6c2e 0a20 2020   the symbol..   
+0001b880: 2020 2020 206b 7761 7267 7320 2844 6963       kwargs (Dic
+0001b890: 745b 7374 722c 2056 6172 6961 626c 655d  t[str, Variable]
+0001b8a0: 293a 204b 6579 776f 7264 2061 7267 756d  ): Keyword argum
+0001b8b0: 656e 7473 2074 6f20 7468 6520 7379 6d62  ents to the symb
+0001b8c0: 6f6c 2e0a 0a20 2020 2052 6574 7572 6e73  ol...    Returns
+0001b8d0: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
+0001b8e0: 6c65 3a20 4120 6675 6e63 7469 6f6e 2074  le: A function t
+0001b8f0: 6861 7420 636f 6d70 7574 6573 2074 6865  hat computes the
+0001b900: 2056 4a50 206f 6620 7468 6520 7379 6d62   VJP of the symb
+0001b910: 6f6c 2e0a 2020 2020 2222 220a 2020 2020  ol..    """.    
+0001b920: 2320 436f 6e73 7461 6e74 2063 6173 650a  # Constant case.
+0001b930: 2020 2020 6966 2069 735f 636f 6e73 7461      if is_consta
+0001b940: 6e74 5f66 6f72 5f76 6a70 2873 796d 626f  nt_for_vjp(symbo
+0001b950: 6c29 3a0a 0a20 2020 2020 2020 2064 6566  l):..        def
+0001b960: 2076 6a70 5f69 6d70 6c5f 636f 6e73 7428   vjp_impl_const(
+0001b970: 7379 6d62 6f6c 2c20 2a61 7267 732c 202a  symbol, *args, *
+0001b980: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+0001b990: 2020 2020 2020 6172 6773 2c20 6b77 6172        args, kwar
+0001b9a0: 6773 203d 2074 7265 655f 6d61 7028 6c61  gs = tree_map(la
+0001b9b0: 6d62 6461 2078 3a20 782e 7072 696d 616c  mbda x: x.primal
+0001b9c0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
+0001b9d0: 2c20 564a 5044 7561 6c29 2065 6c73 6520  , VJPDual) else 
+0001b9e0: 782c 2028 6172 6773 2c20 6b77 6172 6773  x, (args, kwargs
+0001b9f0: 2929 0a20 2020 2020 2020 2020 2020 2070  )).            p
+0001ba00: 7269 6d61 6c73 203d 2073 796d 626f 6c5f  rimals = symbol_
+0001ba10: 746f 5f65 7661 6c28 7379 6d62 6f6c 2928  to_eval(symbol)(
+0001ba20: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+0001ba30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001ba40: 6973 696e 7374 616e 6365 2870 7269 6d61  isinstance(prima
+0001ba50: 6c73 2c20 5365 7175 656e 6365 293a 0a20  ls, Sequence):. 
+0001ba60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001ba70: 6574 7572 6e20 7472 6565 5f6d 6170 286c  eturn tree_map(l
+0001ba80: 616d 6264 6120 783a 2056 4a50 4475 616c  ambda x: VJPDual
+0001ba90: 2878 2c20 7475 706c 6528 2929 2c20 7072  (x, tuple()), pr
+0001baa0: 696d 616c 7329 0a20 2020 2020 2020 2020  imals).         
+0001bab0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+0001bac0: 6c28 7072 696d 616c 732c 2074 7570 6c65  l(primals, tuple
+0001bad0: 2829 290a 0a20 2020 2020 2020 2072 6574  ())..        ret
+0001bae0: 7572 6e20 7061 7274 6961 6c28 766a 705f  urn partial(vjp_
+0001baf0: 696d 706c 5f63 6f6e 7374 2c20 7379 6d62  impl_const, symb
+0001bb00: 6f6c 290a 0a20 2020 2023 204e 6f72 6d61  ol)..    # Norma
+0001bb10: 6c20 6361 7365 2c20 7765 2068 6176 6520  l case, we have 
+0001bb20: 6120 7072 6f78 7920 7461 6e67 656e 740a  a proxy tangent.
+0001bb30: 2020 2020 766a 705f 696d 706c 203d 2061      vjp_impl = a
+0001bb40: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+0001bb50: 5f69 6d70 6c73 2e67 6574 2873 796d 626f  _impls.get(symbo
+0001bb60: 6c2e 7379 6d2e 6964 290a 0a20 2020 2069  l.sym.id)..    i
+0001bb70: 6620 5f67 6574 5f67 7261 6466 6e5f 616e  f _get_gradfn_an
+0001bb80: 645f 6578 6563 7574 6f72 2873 796d 626f  d_executor(symbo
+0001bb90: 6c29 5b30 5d20 6973 206e 6f74 204e 6f6e  l)[0] is not Non
+0001bba0: 653a 0a20 2020 2020 2020 2076 6a70 5f69  e:.        vjp_i
+0001bbb0: 6d70 6c2c 2062 6163 6b77 6172 645f 666e  mpl, backward_fn
+0001bbc0: 203d 206d 616b 655f 6175 675f 666f 7277   = make_aug_forw
+0001bbd0: 6172 645f 616e 645f 6261 636b 7761 7264  ard_and_backward
+0001bbe0: 2873 796d 626f 6c29 0a0a 2020 2020 6966  (symbol)..    if
+0001bbf0: 2076 6a70 5f69 6d70 6c20 6973 204e 6f6e   vjp_impl is Non
+0001bc00: 653a 0a20 2020 2020 2020 2023 2057 6520  e:.        # We 
+0001bc10: 636f 756c 6420 6e6f 7420 6669 6e64 2061  could not find a
+0001bc20: 2056 4a50 2066 6f72 2074 6869 7320 7379   VJP for this sy
+0001bc30: 6d62 6f6c 2c20 736f 2077 6520 7472 7920  mbol, so we try 
+0001bc40: 746f 2064 6563 6f6d 706f 7365 2069 740a  to decompose it.
+0001bc50: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
+0001bc60: 796d 626f 6c2e 7375 6273 796d 626f 6c73  ymbol.subsymbols
+0001bc70: 2920 3e20 3020 616e 6420 6e6f 7420 6973  ) > 0 and not is
+0001bc80: 696e 7374 616e 6365 2873 796d 626f 6c2e  instance(symbol.
+0001bc90: 7379 6d2e 6964 2c20 7072 696d 732e 5072  sym.id, prims.Pr
+0001bca0: 696d 4944 7329 3a0a 2020 2020 2020 2020  imIDs):.        
+0001bcb0: 2020 2020 766a 705f 696d 706c 203d 2070      vjp_impl = p
+0001bcc0: 6172 7469 616c 2864 6563 6f6d 706f 7365  artial(decompose
+0001bcd0: 645f 666e 5f61 7567 5f66 7764 5f72 756c  d_fn_aug_fwd_rul
+0001bce0: 652c 2064 6563 6f6d 706f 7365 645f 666e  e, decomposed_fn
+0001bcf0: 3d73 796d 626f 6c2e 7379 6d29 0a20 2020  =symbol.sym).   
+0001bd00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001bd10: 2020 2020 2020 2023 2057 6520 636f 756c         # We coul
+0001bd20: 6420 6e6f 7420 6669 6e64 2061 2056 4a50  d not find a VJP
+0001bd30: 2066 6f72 2074 6869 7320 7379 6d62 6f6c   for this symbol
+0001bd40: 2061 6e64 2077 6520 636f 756c 6420 6e6f   and we could no
+0001bd50: 7420 6465 636f 6d70 6f73 6520 6974 0a20  t decompose it. 
+0001bd60: 2020 2020 2020 2020 2020 2023 2049 7420             # It 
+0001bd70: 636f 756c 6420 6265 2061 2074 6f72 6368  could be a torch
+0001bd80: 2e64 726f 706f 7574 2077 6974 6820 302e  .dropout with 0.
+0001bd90: 3020 7072 6f62 6162 696c 6974 792c 2073  0 probability, s
+0001bda0: 6f20 7765 2073 6b69 7020 6974 0a20 2020  o we skip it.   
+0001bdb0: 2020 2020 2020 2020 2069 6620 7379 6d62           if symb
+0001bdc0: 6f6c 2e73 796d 2e69 6420 3d3d 2022 746f  ol.sym.id == "to
+0001bdd0: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
+0001bde0: 6c2e 6472 6f70 6f75 7422 3a0a 2020 2020  l.dropout":.    
+0001bdf0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001be00: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
+0001be10: 2020 2020 7072 696e 7428 6622 564a 5020      print(f"VJP 
+0001be20: 666f 7220 7b73 796d 626f 6c7d 2069 7320  for {symbol} is 
+0001be30: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
+0001be40: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
+0001be50: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
+0001be60: 6564 4572 726f 7228 6622 564a 5020 666f  edError(f"VJP fo
+0001be70: 7220 7b73 796d 626f 6c2e 7379 6d2e 6964  r {symbol.sym.id
+0001be80: 7d20 6973 206e 6f74 2069 6d70 6c65 6d65  } is not impleme
+0001be90: 6e74 6564 2229 0a0a 2020 2020 6465 6620  nted")..    def 
+0001bea0: 5f76 6a70 5f69 6d70 6c28 2a61 7267 732c  _vjp_impl(*args,
+0001beb0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+0001bec0: 2020 2020 7072 696d 616c 732c 206b 7761      primals, kwa
+0001bed0: 7267 7320 3d20 7472 6565 5f6d 6170 286c  rgs = tree_map(l
+0001bee0: 616d 6264 6120 783a 2078 2e70 7269 6d61  ambda x: x.prima
+0001bef0: 6c20 6966 2069 7369 6e73 7461 6e63 6528  l if isinstance(
+0001bf00: 782c 2056 4a50 4475 616c 2920 656c 7365  x, VJPDual) else
+0001bf10: 2078 2c20 2861 7267 732c 206b 7761 7267   x, (args, kwarg
+0001bf20: 7329 290a 2020 2020 2020 2020 6f75 745f  s)).        out_
+0001bf30: 7072 696d 616c 2c20 6f75 745f 7265 7369  primal, out_resi
+0001bf40: 6475 616c 7320 3d20 766a 705f 696d 706c  duals = vjp_impl
+0001bf50: 282a 7072 696d 616c 732c 202a 2a6b 7761  (*primals, **kwa
+0001bf60: 7267 7329 0a0a 2020 2020 2020 2020 2320  rgs)..        # 
+0001bf70: 5765 2061 7265 2073 6176 696e 6720 7468  We are saving th
+0001bf80: 6520 7265 7369 6475 616c 7320 616e 6420  e residuals and 
+0001bf90: 7075 6c6c 6261 636b 206f 6e6c 7920 696e  pullback only in
+0001bfa0: 2074 6865 2066 6972 7374 206f 7574 7075   the first outpu
+0001bfb0: 740a 2020 2020 2020 2020 2320 6261 636b  t.        # back
+0001bfc0: 7761 7264 5f70 6173 7320 7468 656e 2072  ward_pass then r
+0001bfd0: 6574 7269 6576 6573 2074 6865 2072 6573  etrieves the res
+0001bfe0: 6964 7561 6c73 2061 6e64 2070 756c 6c62  iduals and pullb
+0001bff0: 6163 6b20 6672 6f6d 2074 6865 2066 6972  ack from the fir
+0001c000: 7374 206f 7574 7075 740a 2020 2020 2020  st output.      
+0001c010: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001c020: 6f75 745f 7072 696d 616c 2c20 5365 7175  out_primal, Sequ
+0001c030: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
+0001c040: 2020 2072 6574 7572 6e20 2856 4a50 4475     return (VJPDu
+0001c050: 616c 286f 7574 5f70 7269 6d61 6c5b 305d  al(out_primal[0]
+0001c060: 2c20 6f75 745f 7265 7369 6475 616c 7329  , out_residuals)
+0001c070: 2c20 2a28 564a 5044 7561 6c28 6f2c 2074  , *(VJPDual(o, t
+0001c080: 7570 6c65 2829 2920 666f 7220 6f20 696e  uple()) for o in
+0001c090: 206f 7574 5f70 7269 6d61 6c5b 313a 5d29   out_primal[1:])
+0001c0a0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0001c0b0: 6e20 2856 4a50 4475 616c 286f 7574 5f70  n (VJPDual(out_p
+0001c0c0: 7269 6d61 6c2c 206f 7574 5f72 6573 6964  rimal, out_resid
+0001c0d0: 7561 6c73 292c 290a 0a20 2020 2072 6574  uals),)..    ret
+0001c0e0: 7572 6e20 5f76 6a70 5f69 6d70 6c0a 0a0a  urn _vjp_impl...
+0001c0f0: 6465 6620 6368 6563 6b5f 6273 796d 5f66  def check_bsym_f
+0001c100: 6f72 5f76 6a70 2862 7379 6d29 3a0a 2020  or_vjp(bsym):.  
+0001c110: 2020 2222 220a 2020 2020 4368 6563 6b20    """.    Check 
+0001c120: 6966 2061 2062 6f75 6e64 2073 796d 626f  if a bound symbo
+0001c130: 6c20 6973 2073 7570 706f 7274 6564 2062  l is supported b
+0001c140: 7920 766a 702e 0a0a 2020 2020 4172 6773  y vjp...    Args
+0001c150: 3a0a 2020 2020 2020 2020 6273 796d 2028  :.        bsym (
+0001c160: 426f 756e 6453 796d 626f 6c29 3a20 5468  BoundSymbol): Th
+0001c170: 6520 626f 756e 6420 7379 6d62 6f6c 2074  e bound symbol t
+0001c180: 6f20 6368 6563 6b2e 0a0a 2020 2020 5265  o check...    Re
+0001c190: 7475 726e 733a 0a20 2020 2020 2020 2062  turns:.        b
+0001c1a0: 6f6f 6c3a 2054 7275 6520 6966 2074 6865  ool: True if the
+0001c1b0: 2062 6f75 6e64 2073 796d 626f 6c20 6973   bound symbol is
+0001c1c0: 2073 7570 706f 7274 6564 2062 7920 766a   supported by vj
+0001c1d0: 702c 2046 616c 7365 206f 7468 6572 7769  p, False otherwi
+0001c1e0: 7365 2e0a 2020 2020 2222 220a 0a20 2020  se..    """..   
+0001c1f0: 2069 6620 6273 796d 2e73 796d 2e69 6420   if bsym.sym.id 
+0001c200: 696e 2074 7261 6e73 666f 726d 5f73 6b69  in transform_ski
+0001c210: 705f 6c69 7374 3a0a 2020 2020 2020 2020  p_list:.        
+0001c220: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+0001c230: 2069 6620 6273 796d 2e73 796d 2e69 6420   if bsym.sym.id 
+0001c240: 696e 2062 6163 6b77 6172 645f 696d 706c  in backward_impl
+0001c250: 7320 616e 6420 6273 796d 2e73 796d 2e69  s and bsym.sym.i
+0001c260: 6420 696e 2061 7567 6d65 6e74 6564 5f66  d in augmented_f
+0001c270: 6f72 7761 7264 5f69 6d70 6c73 3a0a 2020  orward_impls:.  
+0001c280: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+0001c290: 650a 0a20 2020 2069 6620 6273 796d 2e73  e..    if bsym.s
+0001c2a0: 796d 2e69 6420 696e 205f 6772 6164 5f66  ym.id in _grad_f
+0001c2b0: 6e5f 6d61 703a 0a20 2020 2020 2020 2072  n_map:.        r
+0001c2c0: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+0001c2d0: 2320 5765 2063 6f75 6c64 206e 6f74 2066  # We could not f
+0001c2e0: 696e 6420 6120 564a 5020 666f 7220 7468  ind a VJP for th
+0001c2f0: 6973 2073 796d 626f 6c2c 2073 6f20 7765  is symbol, so we
+0001c300: 2074 7279 2074 6f20 6465 636f 6d70 6f73   try to decompos
+0001c310: 6520 6974 0a20 2020 2023 2069 6e74 6f20  e it.    # into 
+0001c320: 7375 622d 7379 6d62 6f6c 7320 616e 6420  sub-symbols and 
+0001c330: 6368 6563 6b20 6966 2074 6865 7920 6172  check if they ar
+0001c340: 6520 7375 7070 6f72 7465 640a 2020 2020  e supported.    
+0001c350: 6966 206c 656e 2862 7379 6d2e 7375 6273  if len(bsym.subs
+0001c360: 796d 626f 6c73 2920 3e20 3020 616e 6420  ymbols) > 0 and 
+0001c370: 6e6f 7420 6273 796d 2e73 796d 2e69 735f  not bsym.sym.is_
+0001c380: 7072 696d 3a0a 2020 2020 2020 2020 7375  prim:.        su
+0001c390: 6274 7261 6365 203d 2063 6f6e 7374 7275  btrace = constru
+0001c3a0: 6374 5f74 7261 6365 2829 2862 7379 6d2e  ct_trace()(bsym.
+0001c3b0: 7379 6d2c 202a 6273 796d 2e61 7267 732c  sym, *bsym.args,
+0001c3c0: 202a 2a62 7379 6d2e 6b77 6172 6773 290a   **bsym.kwargs).
+0001c3d0: 2020 2020 2020 2020 7375 6274 7261 6365          subtrace
+0001c3e0: 203d 2075 6e77 7261 705f 6f6e 655f 6c65   = unwrap_one_le
+0001c3f0: 7665 6c5f 6f66 5f73 7562 7379 6d62 6f6c  vel_of_subsymbol
+0001c400: 7328 7375 6274 7261 6365 290a 2020 2020  s(subtrace).    
+0001c410: 2020 2020 616c 6c5f 7375 7070 6f72 7465      all_supporte
+0001c420: 6420 3d20 616c 6c28 6368 6563 6b5f 6273  d = all(check_bs
+0001c430: 796d 5f66 6f72 5f76 6a70 2873 7562 6273  ym_for_vjp(subbs
+0001c440: 796d 2920 666f 7220 7375 6262 7379 6d20  ym) for subbsym 
+0001c450: 696e 2073 7562 7472 6163 652e 626f 756e  in subtrace.boun
+0001c460: 645f 7379 6d62 6f6c 7329 0a20 2020 2020  d_symbols).     
+0001c470: 2020 2072 6574 7572 6e20 616c 6c5f 7375     return all_su
+0001c480: 7070 6f72 7465 640a 0a20 2020 2072 6574  pported..    ret
+0001c490: 7572 6e20 4661 6c73 650a 0a0a 6465 6620  urn False...def 
+0001c4a0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+0001c4b0: 645f 7061 7373 282a 6172 6773 2c20 7472  d_pass(*args, tr
+0001c4c0: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
+0001c4d0: 6172 6773 293a 0a20 2020 2022 2222 4175  args):.    """Au
+0001c4e0: 676d 656e 7465 6420 666f 7277 6172 6420  gmented forward 
+0001c4f0: 7061 7373 2066 6f72 2074 6865 2056 4a50  pass for the VJP
+0001c500: 2074 7261 6e73 666f 726d 2e0a 0a20 2020   transform...   
+0001c510: 2054 6865 2061 7567 6d65 6e74 6564 2066   The augmented f
+0001c520: 6f72 7761 7264 2070 6173 7320 6973 2061  orward pass is a
+0001c530: 2066 6f72 7761 7264 2070 6173 7320 7468   forward pass th
+0001c540: 6174 2072 6574 7572 6e73 2074 6865 2072  at returns the r
+0001c550: 6573 6964 7561 6c73 0a20 2020 206f 6620  esiduals.    of 
+0001c560: 7468 6520 666f 7277 6172 6420 7061 7373  the forward pass
+0001c570: 2e0a 2020 2020 5468 6573 6520 7265 7369  ..    These resi
+0001c580: 6475 616c 7320 6172 6520 7573 6564 2069  duals are used i
+0001c590: 6e20 7468 6520 6261 636b 7761 7264 2070  n the backward p
+0001c5a0: 6173 7320 746f 2063 6f6d 7075 7465 2074  ass to compute t
+0001c5b0: 6865 2056 4a50 2061 6e64 2074 6865 790a  he VJP and they.
+0001c5c0: 2020 2020 6172 6520 7265 636f 7264 6564      are recorded
+0001c5d0: 2069 6e20 7468 6520 656e 7669 726f 6e6d   in the environm
+0001c5e0: 656e 7420 6469 6374 696f 6e61 7279 2066  ent dictionary f
+0001c5f0: 6f72 2065 6163 6820 7661 7269 6162 6c65  or each variable
+0001c600: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+0001c610: 2020 2020 2061 7267 7320 2854 7570 6c65       args (Tuple
+0001c620: 5b56 6172 6961 626c 655d 293a 2041 7267  [Variable]): Arg
+0001c630: 756d 656e 7473 2074 6f20 7468 6520 6675  uments to the fu
+0001c640: 6e63 7469 6f6e 2e0a 2020 2020 2020 2020  nction..        
+0001c650: 7472 6163 6520 2854 7261 6365 293a 2054  trace (Trace): T
+0001c660: 7261 6365 206f 6620 7468 6520 6675 6e63  race of the func
+0001c670: 7469 6f6e 2e0a 2020 2020 2020 2020 6b77  tion..        kw
+0001c680: 6172 6773 2028 4469 6374 5b73 7472 2c20  args (Dict[str, 
+0001c690: 5661 7269 6162 6c65 5d29 3a20 4b65 7977  Variable]): Keyw
+0001c6a0: 6f72 6420 6172 6775 6d65 6e74 7320 746f  ord arguments to
+0001c6b0: 2074 6865 2066 756e 6374 696f 6e2e 0a0a   the function...
+0001c6c0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0001c6d0: 2020 2020 2054 7570 6c65 5b41 6e79 2c20       Tuple[Any, 
+0001c6e0: 4469 6374 5b73 7472 2c20 416e 795d 5d3a  Dict[str, Any]]:
+0001c6f0: 2054 7570 6c65 206f 6620 7468 6520 7072   Tuple of the pr
+0001c700: 696d 616c 206f 7574 7075 7473 2061 6e64  imal outputs and
+0001c710: 2074 6865 2065 6e76 6972 6f6e 6d65 6e74   the environment
+0001c720: 2e0a 2020 2020 2222 220a 2020 2020 6172  ..    """.    ar
+0001c730: 6773 2c20 6b77 6172 6773 203d 2074 7265  gs, kwargs = tre
+0001c740: 655f 6d61 7028 6c61 6d62 6461 2078 3a20  e_map(lambda x: 
+0001c750: 564a 5044 7561 6c28 782c 2074 7570 6c65  VJPDual(x, tuple
+0001c760: 2829 292c 2028 6172 6773 2c20 6b77 6172  ()), (args, kwar
+0001c770: 6773 2929 0a20 2020 2072 6573 756c 742c  gs)).    result,
+0001c780: 2065 6e76 203d 2065 7661 6c5f 7472 6163   env = eval_trac
+0001c790: 6528 0a20 2020 2020 2020 2074 7261 6365  e(.        trace
+0001c7a0: 2c0a 2020 2020 2020 2020 2a61 7267 732c  ,.        *args,
+0001c7b0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+0001c7c0: 732c 0a20 2020 2020 2020 2077 6974 685f  s,.        with_
+0001c7d0: 656e 763d 5472 7565 2c0a 2020 2020 2020  env=True,.      
+0001c7e0: 2020 7379 6d62 6f6c 5f6d 6170 7065 723d    symbol_mapper=
+0001c7f0: 766a 705f 7379 6d62 6f6c 5f6d 6170 7065  vjp_symbol_mappe
+0001c800: 722c 0a20 2020 2029 0a20 2020 2072 6573  r,.    ).    res
+0001c810: 756c 7420 3d20 7472 6565 5f6d 6170 286c  ult = tree_map(l
+0001c820: 616d 6264 6120 783a 2078 2e70 7269 6d61  ambda x: x.prima
+0001c830: 6c20 6966 2069 7369 6e73 7461 6e63 6528  l if isinstance(
+0001c840: 782c 2056 4a50 4475 616c 2920 656c 7365  x, VJPDual) else
+0001c850: 2078 2c20 7265 7375 6c74 290a 2020 2020   x, result).    
+0001c860: 7265 7475 726e 2072 6573 756c 742c 2065  return result, e
+0001c870: 6e76 0a0a 0a23 2054 4f44 4f3a 2049 6e73  nv...# TODO: Ins
+0001c880: 7465 6164 206f 6620 7573 696e 6720 7468  tead of using th
+0001c890: 6520 656e 7669 726f 6e6d 656e 7420 6469  e environment di
+0001c8a0: 6374 696f 6e61 7279 2c20 7765 2063 6f75  ctionary, we cou
+0001c8b0: 6c64 2075 7365 2074 6865 2074 7261 6365  ld use the trace
+0001c8c0: 0a23 2073 796d 626f 6c73 206f 7264 6572  .# symbols order
+0001c8d0: 2028 7468 6174 2073 686f 756c 6420 6265   (that should be
+0001c8e0: 2064 6574 6572 6d69 6e69 7374 6963 2920   deterministic) 
+0001c8f0: 746f 2072 6574 7269 6576 6520 7468 6520  to retrieve the 
+0001c900: 7265 7369 6475 616c 7320 6e65 6564 6564  residuals needed
+0001c910: 0a23 2066 6f72 2074 6865 2062 6163 6b77  .# for the backw
+0001c920: 6172 6420 7061 7373 2e0a 6465 6620 6261  ard pass..def ba
+0001c930: 636b 7761 7264 5f70 6173 7328 666f 7277  ckward_pass(forw
+0001c940: 6172 645f 656e 762c 2074 7261 6365 2c20  ard_env, trace, 
+0001c950: 696e 6974 5f63 6f74 616e 6765 6e74 7329  init_cotangents)
+0001c960: 3a0a 2020 2020 2222 2242 6163 6b77 6172  :.    """Backwar
+0001c970: 6420 7061 7373 2066 6f72 2074 6865 2056  d pass for the V
+0001c980: 4a50 2074 7261 6e73 666f 726d 2e0a 0a20  JP transform... 
+0001c990: 2020 2054 6865 2062 6163 6b77 6172 6420     The backward 
+0001c9a0: 7061 7373 2069 7320 6120 7265 7665 7273  pass is a revers
+0001c9b0: 6520 6d6f 6465 2061 7574 6f6d 6174 6963  e mode automatic
+0001c9c0: 2064 6966 6665 7265 6e74 6961 7469 6f6e   differentiation
+0001c9d0: 2070 6173 7320 7468 6174 0a20 2020 2063   pass that.    c
+0001c9e0: 6f6d 7075 7465 7320 7468 6520 7665 6374  omputes the vect
+0001c9f0: 6f72 2d4a 6163 6f62 6961 6e20 7072 6f64  or-Jacobian prod
+0001ca00: 7563 7420 2856 4a50 2920 6f66 2074 6865  uct (VJP) of the
+0001ca10: 2066 756e 6374 696f 6e2e 0a0a 2020 2020   function...    
+0001ca20: 4172 6773 3a0a 2020 2020 2020 2020 666f  Args:.        fo
+0001ca30: 7277 6172 645f 656e 7620 2844 6963 745b  rward_env (Dict[
+0001ca40: 7374 722c 2041 6e79 5d29 3a20 456e 7669  str, Any]): Envi
+0001ca50: 726f 6e6d 656e 7420 6f66 2074 6865 2066  ronment of the f
+0001ca60: 6f72 7761 7264 2070 6173 732e 0a20 2020  orward pass..   
+0001ca70: 2020 2020 2074 7261 6365 2028 5472 6163       trace (Trac
+0001ca80: 6529 3a20 5472 6163 6520 6f66 2074 6865  e): Trace of the
+0001ca90: 2066 756e 6374 696f 6e2e 0a20 2020 2020   function..     
+0001caa0: 2020 2069 6e69 745f 636f 7461 6e67 656e     init_cotangen
+0001cab0: 7473 2028 5475 706c 655b 5661 7269 6162  ts (Tuple[Variab
+0001cac0: 6c65 5d29 3a20 496e 6974 6961 6c20 636f  le]): Initial co
+0001cad0: 7461 6e67 656e 7473 2e0a 0a20 2020 2052  tangents...    R
+0001cae0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0001caf0: 5475 706c 655b 5072 6f78 792c 202e 2e2e  Tuple[Proxy, ...
+0001cb00: 5d3a 2054 7570 6c65 206f 6620 7468 6520  ]: Tuple of the 
+0001cb10: 7265 7375 6c74 7320 6f66 2074 6865 2062  results of the b
+0001cb20: 6163 6b77 6172 6420 7061 7373 2066 6f72  ackward pass for
+0001cb30: 2065 6163 6820 696e 7075 742e 0a20 2020   each input..   
+0001cb40: 2022 2222 0a20 2020 2065 6e76 203d 207b   """.    env = {
+0001cb50: 7d0a 0a20 2020 2064 6566 2067 6574 5f67  }..    def get_g
+0001cb60: 7261 6428 783a 2056 6172 6961 626c 6529  rad(x: Variable)
+0001cb70: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
+0001cb80: 6e73 7461 6e63 6528 782c 2056 6172 6961  nstance(x, Varia
+0001cb90: 626c 6529 3a0a 2020 2020 2020 2020 2020  ble):.          
+0001cba0: 2020 2320 5265 7475 726e 204e 6f6e 6520    # Return None 
+0001cbb0: 6966 2074 6865 2076 6172 6961 626c 6520  if the variable 
+0001cbc0: 7761 7320 6e6f 7420 7573 6564 2069 6e20  was not used in 
+0001cbd0: 7468 6520 636f 6d70 7574 6174 696f 6e20  the computation 
+0001cbe0: 616e 640a 2020 2020 2020 2020 2020 2020  and.            
+0001cbf0: 2320 6865 6e63 6520 6e6f 7420 696e 2074  # hence not in t
+0001cc00: 6865 2065 6e76 0a20 2020 2020 2020 2020  he env.         
+0001cc10: 2020 2072 6574 7572 6e20 656e 762e 6765     return env.ge
+0001cc20: 7428 782e 6e61 6d65 2c20 4e6f 6e65 290a  t(x.name, None).
+0001cc30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001cc40: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001cc50: 2078 0a0a 2020 2020 6465 6620 7075 745f   x..    def put_
+0001cc60: 6772 6164 2876 3a20 5661 7269 6162 6c65  grad(v: Variable
+0001cc70: 2c20 7661 6c3a 2041 6e79 2920 2d3e 204e  , val: Any) -> N
+0001cc80: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
+0001cc90: 6973 696e 7374 616e 6365 2876 2c20 5661  isinstance(v, Va
+0001cca0: 7269 6162 6c65 293a 0a20 2020 2020 2020  riable):.       
+0001ccb0: 2020 2020 2069 6620 762e 6e61 6d65 2069       if v.name i
+0001ccc0: 6e20 656e 763a 0a20 2020 2020 2020 2020  n env:.         
+0001ccd0: 2020 2020 2020 2069 6620 7661 6c20 6973         if val is
+0001cce0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001ccf0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001cd00: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0001cd10: 2020 2320 4163 6375 6d75 6c61 7465 2063    # Accumulate c
+0001cd20: 6f74 616e 6765 6e74 730a 2020 2020 2020  otangents.      
+0001cd30: 2020 2020 2020 2020 2020 656e 765b 762e            env[v.
+0001cd40: 6e61 6d65 5d20 3d20 636c 616e 672e 6164  name] = clang.ad
+0001cd50: 6428 656e 765b 762e 6e61 6d65 5d2c 2076  d(env[v.name], v
+0001cd60: 616c 2920 6966 2065 6e76 5b76 2e6e 616d  al) if env[v.nam
+0001cd70: 655d 2069 7320 6e6f 7420 4e6f 6e65 2065  e] is not None e
+0001cd80: 6c73 6520 7661 6c0a 2020 2020 2020 2020  lse val.        
+0001cd90: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0001cda0: 2020 2020 2020 2020 2020 2065 6e76 5b76             env[v
+0001cdb0: 2e6e 616d 655d 203d 2076 616c 0a20 2020  .name] = val.   
+0001cdc0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+0001cdd0: 616e 6365 2876 2c20 5365 7175 656e 6365  ance(v, Sequence
+0001cde0: 2920 616e 6420 616c 6c28 6973 696e 7374  ) and all(isinst
+0001cdf0: 616e 6365 2878 2c20 696e 7429 2066 6f72  ance(x, int) for
+0001ce00: 2078 2069 6e20 7629 3a0a 2020 2020 2020   x in v):.      
+0001ce10: 2020 2020 2020 2320 544f 444f 3a20 7265        # TODO: re
+0001ce20: 6d6f 7665 2077 6865 6e20 7765 206d 6f76  move when we mov
+0001ce30: 6520 6469 6d73 2074 6f20 6b77 6172 6773  e dims to kwargs
+0001ce40: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+0001ce50: 730a 2020 2020 2020 2020 656c 6966 2069  s.        elif i
+0001ce60: 7369 6e73 7461 6e63 6528 762c 2073 7472  sinstance(v, str
+0001ce70: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
+0001ce80: 6e76 5b76 5d20 3d20 7661 6c0a 2020 2020  nv[v] = val.    
+0001ce90: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+0001cea0: 6e63 6528 762c 2053 6571 7565 6e63 6529  nce(v, Sequence)
+0001ceb0: 2061 6e64 2076 616c 2069 7320 4e6f 6e65   and val is None
+0001cec0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001ced0: 6272 6f61 6463 6173 7420 4e6f 6e65 2074  broadcast None t
+0001cee0: 6f20 7468 6520 7269 6768 7420 7368 6170  o the right shap
+0001cef0: 650a 2020 2020 2020 2020 2020 2020 7361  e.            sa
+0001cf00: 6665 5f6d 6170 2870 7574 5f67 7261 642c  fe_map(put_grad,
+0001cf10: 2076 2c20 5b4e 6f6e 655d 202a 206c 656e   v, [None] * len
+0001cf20: 2876 2929 0a20 2020 2020 2020 2065 6c69  (v)).        eli
+0001cf30: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
+0001cf40: 5365 7175 656e 6365 2920 616e 6420 6973  Sequence) and is
+0001cf50: 696e 7374 616e 6365 2876 616c 2c20 5365  instance(val, Se
+0001cf60: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
+0001cf70: 2020 2020 2073 6166 655f 6d61 705f 666c       safe_map_fl
+0001cf80: 6174 2870 7574 5f67 7261 642c 2076 2c20  at(put_grad, v, 
+0001cf90: 7661 6c29 0a20 2020 2020 2020 2065 6c73  val).        els
+0001cfa0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0001cfb0: 2053 6b69 7020 7772 6974 696e 6720 746f   Skip writing to
+0001cfc0: 2063 6f6e 7374 616e 7473 0a20 2020 2020   constants.     
+0001cfd0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+0001cfe0: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
+0001cff0: 6e69 745f 636f 7461 6e67 656e 7473 2c20  nit_cotangents, 
+0001d000: 5365 7175 656e 6365 2920 616e 6420 6c65  Sequence) and le
+0001d010: 6e28 696e 6974 5f63 6f74 616e 6765 6e74  n(init_cotangent
+0001d020: 7329 203d 3d20 3120 616e 6420 6e6f 7420  s) == 1 and not 
+0001d030: 6973 696e 7374 616e 6365 2874 7261 6365  isinstance(trace
+0001d040: 2e6f 7574 7075 742c 2053 6571 7565 6e63  .output, Sequenc
+0001d050: 6529 3a0a 2020 2020 2020 2020 696e 6974  e):.        init
+0001d060: 5f63 6f74 616e 6765 6e74 7320 3d20 696e  _cotangents = in
+0001d070: 6974 5f63 6f74 616e 6765 6e74 735b 305d  it_cotangents[0]
+0001d080: 0a20 2020 2073 6166 655f 6d61 705f 666c  .    safe_map_fl
+0001d090: 6174 2870 7574 5f67 7261 642c 2074 7261  at(put_grad, tra
+0001d0a0: 6365 2e6f 7574 7075 742c 2069 6e69 745f  ce.output, init_
+0001d0b0: 636f 7461 6e67 656e 7473 290a 0a20 2020  cotangents)..   
+0001d0c0: 2066 6f72 2073 796d 626f 6c20 696e 2072   for symbol in r
+0001d0d0: 6576 6572 7365 6428 6c69 7374 2869 7465  eversed(list(ite
+0001d0e0: 725f 626f 756e 645f 7379 6d62 6f6c 7328  r_bound_symbols(
+0001d0f0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
+0001d100: 6f6c 7329 2929 3a0a 2020 2020 2020 2020  ols))):.        
+0001d110: 7379 6d62 6f6c 5f6f 7574 7075 7420 3d20  symbol_output = 
+0001d120: 7365 7175 656e 6369 6679 2873 796d 626f  sequencify(symbo
+0001d130: 6c2e 6f75 7470 7574 290a 0a20 2020 2020  l.output)..     
+0001d140: 2020 2063 6f74 616e 6765 6e74 7320 3d20     cotangents = 
+0001d150: 7472 6565 5f6d 6170 2867 6574 5f67 7261  tree_map(get_gra
+0001d160: 642c 2073 796d 626f 6c5f 6f75 7470 7574  d, symbol_output
+0001d170: 290a 2020 2020 2020 2020 2320 4861 7669  ).        # Havi
+0001d180: 6e67 2061 2073 696e 676c 6520 636f 7461  ng a single cota
+0001d190: 6e67 656e 7420 6973 2061 2063 6f6d 6d6f  ngent is a commo
+0001d1a0: 6e20 6361 7365 2c20 736f 2077 6520 666c  n case, so we fl
+0001d1b0: 6174 7465 6e20 6974 0a20 2020 2020 2020  atten it.       
+0001d1c0: 2023 204f 7468 6572 7769 7365 2c20 7765   # Otherwise, we
+0001d1d0: 2077 696c 6c20 6e65 6564 2074 6f20 7265   will need to re
+0001d1e0: 7772 6974 6520 7468 6520 7075 6c6c 6261  write the pullba
+0001d1f0: 636b 2066 756e 6374 696f 6e73 0a20 2020  ck functions.   
+0001d200: 2020 2020 2063 6f74 616e 6765 6e74 7320       cotangents 
+0001d210: 3d20 7472 6565 5f66 6c61 7474 656e 2863  = tree_flatten(c
+0001d220: 6f74 616e 6765 6e74 7329 5b30 5d0a 2020  otangents)[0].  
+0001d230: 2020 2020 2020 7265 7369 6475 616c 7320        residuals 
+0001d240: 3d20 666f 7277 6172 645f 656e 765b 7379  = forward_env[sy
+0001d250: 6d62 6f6c 5f6f 7574 7075 745b 305d 2e6e  mbol_output[0].n
+0001d260: 616d 655d 2e72 6573 6964 7561 6c73 0a20  ame].residuals. 
+0001d270: 2020 2020 2020 2069 6620 6973 5f63 6f6e         if is_con
+0001d280: 7374 616e 745f 666f 725f 766a 7028 7379  stant_for_vjp(sy
+0001d290: 6d62 6f6c 293a 0a20 2020 2020 2020 2020  mbol):.         
+0001d2a0: 2020 2023 2057 6520 6361 6e20 736b 6970     # We can skip
+0001d2b0: 2074 6865 2070 756c 6c62 6163 6b20 6966   the pullback if
+0001d2c0: 2061 6c6c 2074 6865 2061 7267 756d 656e   all the argumen
+0001d2d0: 7473 2061 7265 2063 6f6e 7374 616e 740a  ts are constant.
+0001d2e0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0001d2f0: 696e 7565 0a0a 2020 2020 2020 2020 6966  inue..        if
+0001d300: 2061 6c6c 2863 6f74 616e 6765 6e74 2069   all(cotangent i
+0001d310: 7320 4e6f 6e65 2066 6f72 2063 6f74 616e  s None for cotan
+0001d320: 6765 6e74 2069 6e20 636f 7461 6e67 656e  gent in cotangen
+0001d330: 7473 293a 0a20 2020 2020 2020 2020 2020  ts):.           
+0001d340: 2023 2057 6520 6361 6e20 736b 6970 2074   # We can skip t
+0001d350: 6865 2070 756c 6c62 6163 6b20 6966 2074  he pullback if t
+0001d360: 6865 2063 6f74 616e 6765 6e74 2069 7320  he cotangent is 
+0001d370: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0001d380: 2073 6166 655f 6d61 7028 7075 745f 6772   safe_map(put_gr
+0001d390: 6164 2c20 7379 6d62 6f6c 2e61 7267 732c  ad, symbol.args,
+0001d3a0: 2028 4e6f 6e65 2c29 202a 206c 656e 2873   (None,) * len(s
+0001d3b0: 796d 626f 6c2e 6172 6773 2929 0a20 2020  ymbol.args)).   
+0001d3c0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+0001d3d0: 650a 0a20 2020 2020 2020 2069 6620 7379  e..        if sy
+0001d3e0: 6d62 6f6c 2e73 796d 2e69 6420 3d3d 2022  mbol.sym.id == "
+0001d3f0: 746f 7263 682e 6e6e 2e66 756e 6374 696f  torch.nn.functio
+0001d400: 6e61 6c2e 6472 6f70 6f75 7422 2061 6e64  nal.dropout" and
+0001d410: 206e 6f74 2073 796d 626f 6c2e 7375 6273   not symbol.subs
+0001d420: 796d 626f 6c73 3a0a 2020 2020 2020 2020  ymbols:.        
+0001d430: 2020 2020 2320 5765 2063 616e 2073 6b69      # We can ski
+0001d440: 7020 7468 6520 7075 6c6c 6261 636b 2069  p the pullback i
+0001d450: 6620 7468 6520 6472 6f70 6f75 7420 7072  f the dropout pr
+0001d460: 6f62 6162 696c 6974 7920 6973 2030 2e30  obability is 0.0
+0001d470: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
+0001d480: 7373 756d 696e 6720 7468 6174 2074 6865  ssuming that the
+0001d490: 2064 726f 706f 7574 2073 796d 626f 6c20   dropout symbol 
+0001d4a0: 6861 7320 7468 6520 7361 6d65 206f 7574  has the same out
+0001d4b0: 7075 7420 616e 6420 6172 6775 6d65 6e74  put and argument
+0001d4c0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001d4d0: 6572 7420 7379 6d62 6f6c 2e6f 7574 7075  ert symbol.outpu
+0001d4e0: 742e 6e61 6d65 203d 3d20 7379 6d62 6f6c  t.name == symbol
+0001d4f0: 2e61 7267 735b 305d 2e6e 616d 652c 2022  .args[0].name, "
+0001d500: 4472 6f70 6f75 7420 7379 6d62 6f6c 2068  Dropout symbol h
+0001d510: 6173 2061 2064 6966 6665 7265 6e74 206f  as a different o
+0001d520: 7574 7075 7420 616e 6420 6172 6775 6d65  utput and argume
+0001d530: 6e74 220a 2020 2020 2020 2020 2020 2020  nt".            
+0001d540: 6966 2073 796d 626f 6c2e 6172 6773 5b31  if symbol.args[1
+0001d550: 5d20 3d3d 2030 2e30 206f 7220 7379 6d62  ] == 0.0 or symb
+0001d560: 6f6c 2e61 7267 735b 325d 2069 7320 4661  ol.args[2] is Fa
+0001d570: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001d580: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
+0001d590: 2020 2020 2020 2062 6163 6b77 6172 6420         backward 
+0001d5a0: 3d20 6261 636b 7761 7264 5f69 6d70 6c73  = backward_impls
+0001d5b0: 2e67 6574 2873 796d 626f 6c2e 7379 6d2e  .get(symbol.sym.
+0001d5c0: 6964 290a 2020 2020 2020 2020 6175 675f  id).        aug_
+0001d5d0: 666f 7277 6172 6420 3d20 6175 676d 656e  forward = augmen
+0001d5e0: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
+0001d5f0: 732e 6765 7428 7379 6d62 6f6c 2e73 796d  s.get(symbol.sym
+0001d600: 2e69 6429 0a0a 2020 2020 2020 2020 6966  .id)..        if
+0001d610: 205f 6765 745f 6772 6164 666e 5f61 6e64   _get_gradfn_and
+0001d620: 5f65 7865 6375 746f 7228 7379 6d62 6f6c  _executor(symbol
+0001d630: 295b 305d 2069 7320 6e6f 7420 4e6f 6e65  )[0] is not None
+0001d640: 3a0a 2020 2020 2020 2020 2020 2020 6175  :.            au
+0001d650: 675f 666f 7277 6172 642c 2062 6163 6b77  g_forward, backw
+0001d660: 6172 6420 3d20 6d61 6b65 5f61 7567 5f66  ard = make_aug_f
+0001d670: 6f72 7761 7264 5f61 6e64 5f62 6163 6b77  orward_and_backw
+0001d680: 6172 6428 7379 6d62 6f6c 290a 0a20 2020  ard(symbol)..   
+0001d690: 2020 2020 2069 6620 6261 636b 7761 7264       if backward
+0001d6a0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001d6b0: 2020 2020 2020 6966 206c 656e 2873 796d        if len(sym
+0001d6c0: 626f 6c2e 7375 6273 796d 626f 6c73 2920  bol.subsymbols) 
+0001d6d0: 3e20 3020 616e 6420 6e6f 7420 6973 696e  > 0 and not isin
+0001d6e0: 7374 616e 6365 2873 796d 626f 6c2e 7379  stance(symbol.sy
+0001d6f0: 6d2e 6964 2c20 7072 696d 732e 5072 696d  m.id, prims.Prim
+0001d700: 4944 7329 3a0a 2020 2020 2020 2020 2020  IDs):.          
+0001d710: 2020 2020 2020 2320 5765 2063 6f75 6c64        # We could
+0001d720: 206e 6f74 2066 696e 6420 6120 6261 636b   not find a back
+0001d730: 7761 7264 2066 6f72 2074 6869 7320 7379  ward for this sy
+0001d740: 6d62 6f6c 2c20 736f 2077 6520 7472 7920  mbol, so we try 
+0001d750: 746f 2064 6563 6f6d 706f 7365 2069 740a  to decompose it.
+0001d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d770: 6261 636b 7761 7264 203d 2070 6172 7469  backward = parti
+0001d780: 616c 2864 6563 6f6d 706f 7365 645f 666e  al(decomposed_fn
+0001d790: 5f62 6163 6b77 6172 645f 7275 6c65 2c20  _backward_rule, 
+0001d7a0: 7379 6d62 6f6c 2e73 796d 290a 2020 2020  symbol.sym).    
+0001d7b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001d7c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001d7d0: 5765 2063 6f75 6c64 206e 6f74 2066 696e  We could not fin
+0001d7e0: 6420 6120 6261 636b 7761 7264 2066 6f72  d a backward for
+0001d7f0: 2074 6869 7320 7379 6d62 6f6c 2061 6e64   this symbol and
+0001d800: 2077 6520 636f 756c 6420 6e6f 7420 6465   we could not de
+0001d810: 636f 6d70 6f73 6520 6974 0a20 2020 2020  compose it.     
+0001d820: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0001d830: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
+0001d840: 7272 6f72 2866 2242 6163 6b77 6172 6420  rror(f"Backward 
+0001d850: 666f 7220 7b73 796d 626f 6c2e 7379 6d2e  for {symbol.sym.
+0001d860: 6964 7d20 6973 206e 6f74 2069 6d70 6c65  id} is not imple
+0001d870: 6d65 6e74 6564 2229 0a0a 2020 2020 2020  mented")..      
+0001d880: 2020 7265 7375 6c74 203d 2062 6163 6b77    result = backw
+0001d890: 6172 6428 2a72 6573 6964 7561 6c73 2c20  ard(*residuals, 
+0001d8a0: 2a63 6f74 616e 6765 6e74 7329 0a20 2020  *cotangents).   
+0001d8b0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0001d8c0: 6365 2872 6573 756c 742c 2064 6963 7429  ce(result, dict)
+0001d8d0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001d8e0: 4966 2074 6865 2062 6163 6b77 6172 6420  If the backward 
+0001d8f0: 7265 7475 726e 7320 6120 6469 6374 2c20  returns a dict, 
+0001d900: 7765 2061 7373 756d 6520 7468 6174 2069  we assume that i
+0001d910: 7420 6973 2061 2064 6963 7420 6f66 0a20  t is a dict of. 
+0001d920: 2020 2020 2020 2020 2020 2023 2066 6f72             # for
+0001d930: 7761 7264 2061 7267 756d 656e 7473 2074  ward arguments t
+0001d940: 6f20 7468 6520 636f 7272 6573 706f 6e64  o the correspond
+0001d950: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+0001d960: 2320 6772 6164 6965 6e74 732f 636f 7461  # gradients/cota
+0001d970: 6e67 656e 7473 2f61 646a 6f69 6e74 732f  ngents/adjoints/
+0001d980: 7365 6e73 6974 6976 6974 6965 732e 0a20  sensitivities.. 
+0001d990: 2020 2020 2020 2020 2020 2075 7365 645f             used_
+0001d9a0: 6e61 6d65 7320 3d20 7365 7428 290a 2020  names = set().  
+0001d9b0: 2020 2020 2020 2020 2020 666f 7220 692c            for i,
+0001d9c0: 2028 6b2c 2076 2920 696e 2065 6e75 6d65   (k, v) in enume
+0001d9d0: 7261 7465 2869 6e73 7065 6374 2e73 6967  rate(inspect.sig
+0001d9e0: 6e61 7475 7265 2861 7567 5f66 6f72 7761  nature(aug_forwa
+0001d9f0: 7264 292e 7061 7261 6d65 7465 7273 2e69  rd).parameters.i
+0001da00: 7465 6d73 2829 293a 0a20 2020 2020 2020  tems()):.       
+0001da10: 2020 2020 2020 2020 2069 6620 762e 6b69           if v.ki
+0001da20: 6e64 2069 6e20 2869 6e73 7065 6374 2e50  nd in (inspect.P
+0001da30: 6172 616d 6574 6572 2e50 4f53 4954 494f  arameter.POSITIO
+0001da40: 4e41 4c5f 4f4e 4c59 2c20 696e 7370 6563  NAL_ONLY, inspec
+0001da50: 742e 5061 7261 6d65 7465 722e 504f 5349  t.Parameter.POSI
+0001da60: 5449 4f4e 414c 5f4f 525f 4b45 5957 4f52  TIONAL_OR_KEYWOR
+0001da70: 4429 3a0a 2020 2020 2020 2020 2020 2020  D):.            
+0001da80: 2020 2020 2020 2020 7075 745f 6772 6164          put_grad
+0001da90: 2873 796d 626f 6c2e 6172 6773 5b69 5d2c  (symbol.args[i],
+0001daa0: 2072 6573 756c 742e 6765 7428 6b2c 204e   result.get(k, N
+0001dab0: 6f6e 6529 290a 2020 2020 2020 2020 2020  one)).          
+0001dac0: 2020 2020 2020 2020 2020 7573 6564 5f6e            used_n
+0001dad0: 616d 6573 2e61 6464 286b 290a 0a20 2020  ames.add(k)..   
+0001dae0: 2020 2020 2020 2020 2023 2046 6f72 2064           # For d
+0001daf0: 6576 656c 6f70 6572 2063 6f6e 7665 6e69  eveloper conveni
+0001db00: 656e 6365 2c20 7765 2061 6c6c 6f77 2075  ence, we allow u
+0001db10: 7369 6e67 2074 6865 206e 616d 6520 6672  sing the name fr
+0001db20: 6f6d 2074 6865 0a20 2020 2020 2020 2020  om the.         
+0001db30: 2020 2023 2066 6f72 7761 7264 206d 6574     # forward met
+0001db40: 6120 696e 2061 6464 6974 696f 6e20 746f  a in addition to
+0001db50: 2074 6865 206e 616d 6520 6672 6f6d 2074   the name from t
+0001db60: 6865 2061 7567 6d65 6e74 6564 2066 6f72  he augmented for
+0001db70: 7761 7264 0a20 2020 2020 2020 2020 2020  ward.           
+0001db80: 2023 2073 6967 6e61 7475 7265 2e0a 2020   # signature..  
+0001db90: 2020 2020 2020 2020 2020 2320 4966 2062            # If b
+0001dba0: 6f74 6820 6e61 6d65 7320 6172 6520 7573  oth names are us
+0001dbb0: 6564 2c20 7468 6520 6f6e 6520 6672 6f6d  ed, the one from
+0001dbc0: 2074 6865 2066 6f72 7761 7264 206d 6574   the forward met
+0001dbd0: 6120 7461 6b65 730a 2020 2020 2020 2020  a takes.        
+0001dbe0: 2020 2020 2320 7072 6563 6564 656e 6365      # precedence
+0001dbf0: 2e0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0001dc00: 7220 692c 2028 6b2c 2076 2920 696e 2065  r i, (k, v) in e
+0001dc10: 6e75 6d65 7261 7465 2869 6e73 7065 6374  numerate(inspect
+0001dc20: 2e73 6967 6e61 7475 7265 2873 796d 626f  .signature(symbo
+0001dc30: 6c2e 7379 6d2e 6d65 7461 292e 7061 7261  l.sym.meta).para
+0001dc40: 6d65 7465 7273 2e69 7465 6d73 2829 293a  meters.items()):
+0001dc50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dc60: 2069 6620 762e 6b69 6e64 2069 6e20 2869   if v.kind in (i
+0001dc70: 6e73 7065 6374 2e50 6172 616d 6574 6572  nspect.Parameter
+0001dc80: 2e50 4f53 4954 494f 4e41 4c5f 4f4e 4c59  .POSITIONAL_ONLY
+0001dc90: 2c20 696e 7370 6563 742e 5061 7261 6d65  , inspect.Parame
+0001dca0: 7465 722e 504f 5349 5449 4f4e 414c 5f4f  ter.POSITIONAL_O
+0001dcb0: 525f 4b45 5957 4f52 4429 3a0a 2020 2020  R_KEYWORD):.    
+0001dcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dcd0: 6966 206b 206e 6f74 2069 6e20 7573 6564  if k not in used
+0001dce0: 5f6e 616d 6573 3a0a 2020 2020 2020 2020  _names:.        
+0001dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd00: 7075 745f 6772 6164 2873 796d 626f 6c2e  put_grad(symbol.
+0001dd10: 6172 6773 5b69 5d2c 2072 6573 756c 742e  args[i], result.
+0001dd20: 6765 7428 6b2c 204e 6f6e 6529 290a 2020  get(k, None)).  
+0001dd30: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0001dd40: 7565 0a0a 2020 2020 2020 2020 6966 206e  ue..        if n
+0001dd50: 6f74 2069 7369 6e73 7461 6e63 6528 7265  ot isinstance(re
+0001dd60: 7375 6c74 2c20 5365 7175 656e 6365 293a  sult, Sequence):
+0001dd70: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0001dd80: 756c 7420 3d20 2872 6573 756c 742c 290a  ult = (result,).
+0001dd90: 0a20 2020 2020 2020 2064 6566 2069 735f  .        def is_
+0001dda0: 6469 6666 6572 656e 7469 6162 6c65 2861  differentiable(a
+0001ddb0: 7267 293a 0a20 2020 2020 2020 2020 2020  rg):.           
+0001ddc0: 206d 6174 6368 2061 7267 3a0a 2020 2020   match arg:.    
+0001ddd0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+0001dde0: 2054 656e 736f 7250 726f 7879 2829 3a0a   TensorProxy():.
+0001ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de00: 2020 2020 7265 7475 726e 2064 7479 7065      return dtype
+0001de10: 732e 6973 5f69 6e65 7861 6374 5f64 7479  s.is_inexact_dty
+0001de20: 7065 2861 7267 2e64 7479 7065 290a 2020  pe(arg.dtype).  
+0001de30: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+0001de40: 7365 2053 6571 7565 6e63 6528 293a 0a20  se Sequence():. 
+0001de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de60: 2020 2072 6574 7572 6e20 6172 6720 616e     return arg an
+0001de70: 6420 616c 6c28 6973 696e 7374 616e 6365  d all(isinstance
+0001de80: 2878 2c20 5465 6e73 6f72 5072 6f78 7929  (x, TensorProxy)
+0001de90: 2061 6e64 2064 7479 7065 732e 6973 5f69   and dtypes.is_i
+0001dea0: 6e65 7861 6374 5f64 7479 7065 2878 2e64  nexact_dtype(x.d
+0001deb0: 7479 7065 2920 666f 7220 7820 696e 2061  type) for x in a
+0001dec0: 7267 290a 2020 2020 2020 2020 2020 2020  rg).            
+0001ded0: 2020 2020 6361 7365 205f 3a0a 2020 2020      case _:.    
+0001dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001def0: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
+0001df00: 2020 2020 2020 6966 206c 656e 2873 796d        if len(sym
+0001df10: 626f 6c2e 6172 6773 2920 213d 2028 6f72  bol.args) != (or
+0001df20: 6967 5f72 6573 5f6c 656e 203a 3d20 6c65  ig_res_len := le
+0001df30: 6e28 7265 7375 6c74 2929 3a0a 2020 2020  n(result)):.    
+0001df40: 2020 2020 2020 2020 6368 6563 6b28 0a20          check(. 
+0001df50: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0001df60: 7269 675f 7265 735f 6c65 6e20 3c3d 206c  rig_res_len <= l
+0001df70: 656e 2873 796d 626f 6c2e 6172 6773 292c  en(symbol.args),
+0001df80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001df90: 206c 616d 6264 613a 2066 2242 6163 6b77   lambda: f"Backw
+0001dfa0: 6172 6420 666f 7220 7b73 796d 626f 6c2e  ard for {symbol.
+0001dfb0: 7379 6d2e 6964 7d20 7265 7475 726e 6564  sym.id} returned
+0001dfc0: 207b 6f72 6967 5f72 6573 5f6c 656e 7d20   {orig_res_len} 
+0001dfd0: 7661 6c75 6573 2c20 220a 2020 2020 2020  values, ".      
+0001dfe0: 2020 2020 2020 2020 2020 2b20 6622 6275            + f"bu
+0001dff0: 7420 6578 7065 6374 6564 2061 7420 6d6f  t expected at mo
+0001e000: 7374 207b 6c65 6e28 7379 6d62 6f6c 2e61  st {len(symbol.a
+0001e010: 7267 7329 7d22 2c0a 2020 2020 2020 2020  rgs)}",.        
+0001e020: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0001e030: 2020 2320 4173 7375 6d69 6e67 2074 6861    # Assuming tha
+0001e040: 7420 7468 6520 6e6f 6e2d 6469 6666 6572  t the non-differ
+0001e050: 656e 7469 6162 6c65 2061 7267 756d 656e  entiable argumen
+0001e060: 7473 2077 6572 6520 6472 6f70 7065 6420  ts were dropped 
+0001e070: 6672 6f6d 0a20 2020 2020 2020 2020 2020  from.           
+0001e080: 2023 2074 6865 2062 6163 6b77 6172 6420   # the backward 
+0001e090: 6675 6e63 7469 6f6e 2c20 7765 2061 7265  function, we are
+0001e0a0: 2067 6f69 6e67 2074 6f20 6170 7065 6e64   going to append
+0001e0b0: 204e 6f6e 6520 746f 2074 6865 2072 6573   None to the res
+0001e0c0: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
+0001e0d0: 2320 746f 206d 6174 6368 2074 6865 206e  # to match the n
+0001e0e0: 756d 6265 7220 6f66 2061 7267 756d 656e  umber of argumen
+0001e0f0: 7473 2e20 416c 7465 726e 6174 6976 656c  ts. Alternativel
+0001e100: 792c 2077 6520 636f 756c 6420 6a75 7374  y, we could just
+0001e110: 0a20 2020 2020 2020 2020 2020 2023 2068  .            # h
+0001e120: 6176 6520 6120 666f 722d 6c6f 6f70 2077  ave a for-loop w
+0001e130: 6974 6820 6120 636f 6e64 6974 696f 6e61  ith a conditiona
+0001e140: 6c20 7768 656e 2077 7269 7469 6e67 2074  l when writing t
+0001e150: 6f20 7468 650a 2020 2020 2020 2020 2020  o the.          
+0001e160: 2020 2320 656e 7669 726f 6e6d 656e 742e    # environment.
+0001e170: 0a0a 2020 2020 2020 2020 2020 2020 6974  ..            it
+0001e180: 6572 5f72 6573 756c 7420 3d20 6974 6572  er_result = iter
+0001e190: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
+0001e1a0: 2020 2020 206e 5f64 6966 6665 7265 6e74       n_different
+0001e1b0: 6961 626c 655f 6172 6773 203d 2073 756d  iable_args = sum
+0001e1c0: 2862 6f6f 6c28 6973 5f64 6966 6665 7265  (bool(is_differe
+0001e1d0: 6e74 6961 626c 6528 6172 6729 2920 666f  ntiable(arg)) fo
+0001e1e0: 7220 6172 6720 696e 2073 796d 626f 6c2e  r arg in symbol.
+0001e1f0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
+0001e200: 2020 6368 6563 6b28 0a20 2020 2020 2020    check(.       
+0001e210: 2020 2020 2020 2020 206e 5f64 6966 6665           n_diffe
+0001e220: 7265 6e74 6961 626c 655f 6172 6773 203c  rentiable_args <
+0001e230: 3d20 6f72 6967 5f72 6573 5f6c 656e 2c0a  = orig_res_len,.
+0001e240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e250: 6c61 6d62 6461 3a20 6622 4261 636b 7761  lambda: f"Backwa
+0001e260: 7264 2066 6f72 207b 7379 6d62 6f6c 2e73  rd for {symbol.s
+0001e270: 796d 2e69 647d 2072 6574 7572 6e65 6420  ym.id} returned 
+0001e280: 7b6f 7269 675f 7265 735f 6c65 6e7d 2076  {orig_res_len} v
+0001e290: 616c 7565 2873 292c 2022 0a20 2020 2020  alue(s), ".     
+0001e2a0: 2020 2020 2020 2020 2020 202b 2066 2262             + f"b
+0001e2b0: 7574 2065 7870 6563 7465 6420 7b6e 5f64  ut expected {n_d
+0001e2c0: 6966 6665 7265 6e74 6961 626c 655f 6172  ifferentiable_ar
+0001e2d0: 6773 7d22 2c0a 2020 2020 2020 2020 2020  gs}",.          
+0001e2e0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0001e2f0: 2072 6573 756c 7420 3d20 7475 706c 6528   result = tuple(
+0001e300: 6e65 7874 2869 7465 725f 7265 7375 6c74  next(iter_result
+0001e310: 2920 6966 2069 735f 6469 6666 6572 656e  ) if is_differen
+0001e320: 7469 6162 6c65 2861 7267 2920 656c 7365  tiable(arg) else
+0001e330: 204e 6f6e 6520 666f 7220 6172 6720 696e   None for arg in
+0001e340: 2073 796d 626f 6c2e 6172 6773 290a 0a20   symbol.args).. 
+0001e350: 2020 2020 2020 2023 2053 6565 2022 4261         # See "Ba
+0001e360: 636b 7761 7264 2069 6d70 6c20 666f 7220  ckward impl for 
+0001e370: 6f70 7320 6f66 2074 6865 2074 7970 6520  ops of the type 
+0001e380: 5365 7175 656e 6365 5b54 656e 736f 7250  Sequence[TensorP
+0001e390: 726f 7879 5d2c 202e 2e2e 202d 3e20 2e2e  roxy], ... -> ..
+0001e3a0: 2e20 7265 7375 6c74 7320 696e 204e 6f6e  . results in Non
+0001e3b0: 6520 6772 6164 732e 220a 2020 2020 2020  e grads.".      
+0001e3c0: 2020 2320 5468 6973 2069 7320 6120 7465    # This is a te
+0001e3d0: 6d70 6f72 6172 7920 776f 726b 6172 6f75  mporary workarou
+0001e3e0: 6e64 2e0a 2020 2020 2020 2020 6966 2073  nd..        if s
+0001e3f0: 796d 626f 6c2e 7379 6d2e 6964 2069 6e20  ymbol.sym.id in 
+0001e400: 2870 7269 6d73 2e50 7269 6d49 4473 2e43  (prims.PrimIDs.C
+0001e410: 4154 2c20 2274 6f72 6368 2e63 6174 222c  AT, "torch.cat",
+0001e420: 2022 746f 7263 682e 7374 6163 6b22 293a   "torch.stack"):
+0001e430: 0a20 2020 2020 2020 2020 2020 2073 6166  .            saf
+0001e440: 655f 6d61 705f 666c 6174 2870 7574 5f67  e_map_flat(put_g
+0001e450: 7261 642c 2073 796d 626f 6c2e 6172 6773  rad, symbol.args
+0001e460: 2c20 7265 7375 6c74 290a 2020 2020 2020  , result).      
+0001e470: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001e480: 2020 2020 7361 6665 5f6d 6170 2870 7574      safe_map(put
+0001e490: 5f67 7261 642c 2073 796d 626f 6c2e 6172  _grad, symbol.ar
+0001e4a0: 6773 2c20 7265 7375 6c74 290a 0a20 2020  gs, result)..   
+0001e4b0: 2064 6566 2067 6574 5f69 6e65 7861 6374   def get_inexact
+0001e4c0: 5f64 7479 7065 5f6f 725f 6e6f 6e65 2878  _dtype_or_none(x
+0001e4d0: 293a 0a20 2020 2020 2020 2069 6620 6973  ):.        if is
+0001e4e0: 696e 7374 616e 6365 2878 2c20 2854 656e  instance(x, (Ten
+0001e4f0: 736f 7250 726f 7879 2c20 4675 7475 7265  sorProxy, Future
+0001e500: 5465 6e73 6f72 5072 6f78 7929 2920 616e  TensorProxy)) an
+0001e510: 6420 6474 7970 6573 2e69 735f 696e 6578  d dtypes.is_inex
+0001e520: 6163 745f 6474 7970 6528 782e 6474 7970  act_dtype(x.dtyp
+0001e530: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001e540: 7265 7475 726e 2078 0a20 2020 2020 2020  return x.       
+0001e550: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001e560: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+0001e570: 2020 2020 6761 7267 7320 3d20 7472 6565      gargs = tree
+0001e580: 5f6d 6170 2867 6574 5f67 7261 642c 2074  _map(get_grad, t
+0001e590: 7570 6c65 2874 7261 6365 2e61 7267 7329  uple(trace.args)
+0001e5a0: 290a 2020 2020 676b 7761 7267 7320 3d20  ).    gkwargs = 
+0001e5b0: 7472 6565 5f6d 6170 2867 6574 5f67 7261  tree_map(get_gra
+0001e5c0: 642c 2074 7261 6365 2e6b 7761 7267 7329  d, trace.kwargs)
+0001e5d0: 0a20 2020 2067 6b77 6172 6773 203d 207b  .    gkwargs = {
+0001e5e0: 6b3a 2076 2066 6f72 206b 2c20 7620 696e  k: v for k, v in
+0001e5f0: 2067 6b77 6172 6773 2e69 7465 6d73 2829   gkwargs.items()
+0001e600: 2069 6620 7620 6973 206e 6f74 204e 6f6e   if v is not Non
+0001e610: 657d 0a20 2020 2067 6172 6773 2c20 676b  e}.    gargs, gk
+0001e620: 7761 7267 7320 3d20 7472 6565 5f6d 6170  wargs = tree_map
+0001e630: 2867 6574 5f69 6e65 7861 6374 5f64 7479  (get_inexact_dty
+0001e640: 7065 5f6f 725f 6e6f 6e65 2c20 2867 6172  pe_or_none, (gar
+0001e650: 6773 2c20 676b 7761 7267 7329 290a 2020  gs, gkwargs)).  
+0001e660: 2020 7265 7475 726e 2067 6172 6773 202b    return gargs +
+0001e670: 2028 676b 7761 7267 732c 2920 6966 206c   (gkwargs,) if l
+0001e680: 656e 2867 6b77 6172 6773 2920 213d 2030  en(gkwargs) != 0
+0001e690: 2065 6c73 6520 6761 7267 730a 0a0a 6465   else gargs...de
+0001e6a0: 6620 766a 705f 6361 6c6c 5f6d 6574 6166  f vjp_call_metaf
+0001e6b0: 756e 6328 6465 7461 6368 6564 3a20 626f  unc(detached: bo
+0001e6c0: 6f6c 2c20 7072 696d 616c 732c 2063 6f74  ol, primals, cot
+0001e6d0: 616e 6765 6e74 732c 2074 7261 6365 3a20  angents, trace: 
+0001e6e0: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
+0001e6f0: 3a0a 2020 2020 2320 4173 7375 6d69 6e67  :.    # Assuming
+0001e700: 2070 7269 6d61 6c73 2069 7320 666c 6174   primals is flat
+0001e710: 0a0a 2020 2020 6966 206e 6f74 2069 7369  ..    if not isi
+0001e720: 6e73 7461 6e63 6528 7072 696d 616c 732c  nstance(primals,
+0001e730: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
+0001e740: 2020 2020 7072 696d 616c 7320 3d20 2870      primals = (p
+0001e750: 7269 6d61 6c73 2c29 0a0a 2020 2020 6374  rimals,)..    ct
+0001e760: 7820 3d20 6465 7461 6368 6564 5f74 7261  x = detached_tra
+0001e770: 6365 2829 2069 6620 6465 7461 6368 6564  ce() if detached
+0001e780: 2065 6c73 6520 6e75 6c6c 636f 6e74 6578   else nullcontex
+0001e790: 7428 290a 2020 2020 7769 7468 2063 7478  t().    with ctx
+0001e7a0: 3a0a 2020 2020 2020 2020 7265 7375 6c74  :.        result
+0001e7b0: 2c20 656e 7620 3d20 6175 676d 656e 7465  , env = augmente
+0001e7c0: 645f 666f 7277 6172 645f 7061 7373 282a  d_forward_pass(*
+0001e7d0: 7072 696d 616c 732c 2074 7261 6365 3d74  primals, trace=t
+0001e7e0: 7261 6365 2c20 2a2a 6b77 6172 6773 290a  race, **kwargs).
+0001e7f0: 2020 2020 2020 2020 6368 6563 6b28 0a20          check(. 
+0001e800: 2020 2020 2020 2020 2020 206c 656e 2872             len(r
+0001e810: 6573 756c 7429 203d 3d20 6c65 6e28 636f  esult) == len(co
+0001e820: 7461 6e67 656e 7473 2920 6966 2069 7369  tangents) if isi
+0001e830: 6e73 7461 6e63 6528 7265 7375 6c74 2c20  nstance(result, 
+0001e840: 5365 7175 656e 6365 2920 656c 7365 2054  Sequence) else T
+0001e850: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0001e860: 206c 616d 6264 613a 2066 2245 7870 6563   lambda: f"Expec
+0001e870: 7465 6420 636f 7461 6e67 656e 7473 2074  ted cotangents t
+0001e880: 6f20 6265 2061 2073 6571 7565 6e63 6520  o be a sequence 
+0001e890: 6f66 206c 656e 6774 6820 7b6c 656e 2872  of length {len(r
+0001e8a0: 6573 756c 7429 7d2c 2067 6f74 2061 2073  esult)}, got a s
+0001e8b0: 6571 7565 6e63 6520 6f66 206c 656e 6774  equence of lengt
+0001e8c0: 6820 7b6c 656e 2863 6f74 616e 6765 6e74  h {len(cotangent
+0001e8d0: 7329 7d22 2c0a 2020 2020 2020 2020 290a  s)}",.        ).
+0001e8e0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+0001e8f0: 6573 756c 742c 2062 6163 6b77 6172 645f  esult, backward_
+0001e900: 7061 7373 2865 6e76 2c20 7472 6163 652c  pass(env, trace,
+0001e910: 2063 6f74 616e 6765 6e74 7329 0a0a 0a23   cotangents)...#
+0001e920: 2054 4f44 4f3a 2043 616e 2774 2075 7365   TODO: Can't use
+0001e930: 2061 2053 796d 626f 6c20 6865 7265 2062   a Symbol here b
+0001e940: 6563 6175 7365 206d 6978 6564 2065 7865  ecause mixed exe
+0001e950: 6375 746f 7220 7379 6273 796d 626f 6c73  cutor sybsymbols
+0001e960: 2073 6565 6d20 746f 2062 650a 2320 756e   seem to be.# un
+0001e970: 7375 7070 6f72 7465 642e 2053 6565 2069  supported. See i
+0001e980: 7373 7565 2022 436f 756c 6420 6e6f 7420  ssue "Could not 
+0001e990: 6669 6e64 2061 6e20 6578 6563 7574 6f72  find an executor
+0001e9a0: 2066 6f72 2062 6f75 6e64 2073 796d 626f   for bound symbo
+0001e9b0: 6c20 7768 656e 2069 7473 2073 7562 7379  l when its subsy
+0001e9c0: 6d62 6f6c 730a 2320 6172 6520 6e6f 7420  mbols.# are not 
+0001e9d0: 6675 6c6c 7920 7375 7070 6f72 7465 6420  fully supported 
+0001e9e0: 6279 2061 2073 696e 676c 6520 6578 6563  by a single exec
+0001e9f0: 7574 6f72 220a 766a 705f 6361 6c6c 203d  utor".vjp_call =
+0001ea00: 2070 6172 7469 616c 280a 2020 2020 766a   partial(.    vj
+0001ea10: 705f 6361 6c6c 5f6d 6574 6166 756e 632c  p_call_metafunc,
+0001ea20: 2046 616c 7365 0a29 2020 2320 5379 6d62   False.)  # Symb
+0001ea30: 6f6c 2869 643d 5472 616e 7366 6f72 6d73  ol(id=Transforms
+0001ea40: 2e56 6a70 4f70 2c20 6e61 6d65 3d22 766a  .VjpOp, name="vj
+0001ea50: 705f 6361 6c6c 222c 206d 6574 613d 7061  p_call", meta=pa
+0001ea60: 7274 6961 6c28 766a 705f 6361 6c6c 5f6d  rtial(vjp_call_m
+0001ea70: 6574 6166 756e 632c 2046 616c 7365 2929  etafunc, False))
+0001ea80: 0a0a 0a64 6566 2076 6a70 2866 756e 6329  ...def vjp(func)
+0001ea90: 3a0a 2020 2020 2222 2243 6f6d 7075 7465  :.    """Compute
+0001eaa0: 7320 7468 6520 564a 5020 6f66 2061 2066  s the VJP of a f
+0001eab0: 756e 6374 696f 6e2e 0a0a 2020 2020 4172  unction...    Ar
+0001eac0: 6773 3a0a 2020 2020 2020 2020 6675 6e63  gs:.        func
+0001ead0: 2028 4361 6c6c 6162 6c65 293a 2046 756e   (Callable): Fun
+0001eae0: 6374 696f 6e20 746f 2062 6520 6469 6666  ction to be diff
+0001eaf0: 6572 656e 7469 6174 6564 2e0a 2020 2020  erentiated..    
+0001eb00: 2222 220a 0a20 2020 2064 6566 205f 766a  """..    def _vj
+0001eb10: 7028 7072 696d 616c 732c 2063 6f74 616e  p(primals, cotan
+0001eb20: 6765 6e74 732c 202a 2a6b 7761 7267 7329  gents, **kwargs)
+0001eb30: 3a0a 2020 2020 2020 2020 666c 6174 5f66  :.        flat_f
+0001eb40: 756e 632c 2066 6c61 745f 6172 6773 2c20  unc, flat_args, 
+0001eb50: 7370 6563 203d 2066 6c61 7474 656e 5f66  spec = flatten_f
+0001eb60: 756e 6328 6675 6e63 2c20 7072 696d 616c  unc(func, primal
+0001eb70: 732c 206b 7761 7267 7329 0a20 2020 2020  s, kwargs).     
+0001eb80: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
+0001eb90: 7275 6374 5f74 7261 6365 2829 2866 6c61  ruct_trace()(fla
+0001eba0: 745f 6675 6e63 2c20 2a66 6c61 745f 6172  t_func, *flat_ar
+0001ebb0: 6773 290a 2020 2020 2020 2020 7265 7375  gs).        resu
+0001ebc0: 6c74 2c20 766a 705f 7265 7375 6c74 203d  lt, vjp_result =
+0001ebd0: 2076 6a70 5f63 616c 6c28 666c 6174 5f61   vjp_call(flat_a
+0001ebe0: 7267 732c 2063 6f74 616e 6765 6e74 732c  rgs, cotangents,
+0001ebf0: 2074 7261 6365 3d74 7261 6365 290a 2020   trace=trace).  
+0001ec00: 2020 2020 2020 6770 7269 6d61 6c73 2c20        gprimals, 
+0001ec10: 676b 7761 7267 7320 3d20 7472 6565 5f75  gkwargs = tree_u
+0001ec20: 6e66 6c61 7474 656e 2876 6a70 5f72 6573  nflatten(vjp_res
+0001ec30: 756c 742c 2073 7065 6329 0a20 2020 2020  ult, spec).     
+0001ec40: 2020 2067 7261 6473 203d 2067 7072 696d     grads = gprim
+0001ec50: 616c 7320 2b20 2867 6b77 6172 6773 2c29  als + (gkwargs,)
+0001ec60: 2069 6620 6c65 6e28 676b 7761 7267 7329   if len(gkwargs)
+0001ec70: 2021 3d20 3020 656c 7365 2067 7072 696d   != 0 else gprim
+0001ec80: 616c 730a 2020 2020 2020 2020 7265 7475  als.        retu
+0001ec90: 726e 2072 6573 756c 742c 2067 7261 6473  rn result, grads
+0001eca0: 0a0a 2020 2020 7265 7475 726e 205f 766a  ..    return _vj
+0001ecb0: 700a 0a0a 6465 6620 7661 6c75 655f 616e  p...def value_an
+0001ecc0: 645f 6772 6164 2866 756e 6329 3a0a 2020  d_grad(func):.  
+0001ecd0: 2020 2222 2243 6f6d 7075 7465 7320 7468    """Computes th
+0001ece0: 6520 7661 6c75 6520 616e 6420 6772 6164  e value and grad
+0001ecf0: 6965 6e74 206f 6620 6120 6675 6e63 7469  ient of a functi
+0001ed00: 6f6e 2e0a 0a20 2020 2054 6869 7320 6973  on...    This is
+0001ed10: 2061 2063 6f6e 7665 6e69 656e 6365 2066   a convenience f
+0001ed20: 756e 6374 696f 6e20 7468 6174 2063 6f6d  unction that com
+0001ed30: 6269 6e65 7320 7468 6520 6675 6e63 7469  bines the functi
+0001ed40: 6f6e 616c 6974 7920 6f66 0a20 2020 2060  onality of.    `
+0001ed50: 766a 705f 6361 6c6c 6020 7769 7468 2069  vjp_call` with i
+0001ed60: 6d70 6c69 6369 7420 696e 6974 6961 6c69  mplicit initiali
+0001ed70: 7a61 7469 6f6e 206f 6620 7468 6520 636f  zation of the co
+0001ed80: 7461 6e67 656e 7420 746f 2031 2e0a 0a20  tangent to 1... 
+0001ed90: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0001eda0: 2066 756e 6320 2843 616c 6c61 626c 6529   func (Callable)
+0001edb0: 3a20 4675 6e63 7469 6f6e 2074 6f20 6265  : Function to be
+0001edc0: 2064 6966 6665 7265 6e74 6961 7465 642e   differentiated.
+0001edd0: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+0001ede0: 6620 6f6e 6573 5f6c 696b 6528 7829 3a0a  f ones_like(x):.
+0001edf0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001ee00: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
+0001ee10: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
+0001ee20: 2020 2072 6574 7572 6e20 6675 6c6c 5f6c     return full_l
+0001ee30: 696b 6528 782c 2066 696c 6c5f 7661 6c75  ike(x, fill_valu
+0001ee40: 653d 3129 0a20 2020 2020 2020 2065 6c69  e=1).        eli
+0001ee50: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+0001ee60: 4e75 6d62 6572 5072 6f78 7929 3a0a 2020  NumberProxy):.  
+0001ee70: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001ee80: 2074 7970 6528 782e 7661 6c75 6529 2831   type(x.value)(1
+0001ee90: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0001eea0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001eeb0: 6520 5661 6c75 6545 7272 6f72 2866 226f  e ValueError(f"o
+0001eec0: 6e65 735f 6c69 6b65 2069 6e73 6964 6520  nes_like inside 
+0001eed0: 7661 6c75 655f 616e 645f 6772 6164 2067  value_and_grad g
+0001eee0: 6f74 2061 6e20 756e 7375 7070 6f72 7465  ot an unsupporte
+0001eef0: 6420 7479 7065 207b 7479 7065 2878 297d  d type {type(x)}
+0001ef00: 2229 0a0a 2020 2020 6465 6620 5f76 616c  ")..    def _val
+0001ef10: 7565 5f61 6e64 5f67 7261 6428 2a61 7267  ue_and_grad(*arg
+0001ef20: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+0001ef30: 2020 2020 2020 7472 6163 6520 3d20 636f        trace = co
+0001ef40: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
+0001ef50: 6675 6e63 2c20 2a61 7267 732c 202a 2a6b  func, *args, **k
+0001ef60: 7761 7267 7329 0a20 2020 2020 2020 2063  wargs).        c
+0001ef70: 6f74 616e 6765 6e74 7320 3d20 7472 6565  otangents = tree
+0001ef80: 5f6d 6170 286c 616d 6264 6120 763a 206f  _map(lambda v: o
+0001ef90: 6e65 735f 6c69 6b65 2876 292c 2074 7261  nes_like(v), tra
+0001efa0: 6365 2e6f 7574 7075 7429 0a20 2020 2020  ce.output).     
+0001efb0: 2020 2072 6574 7572 6e20 766a 7028 6675     return vjp(fu
+0001efc0: 6e63 2928 6172 6773 2c20 636f 7461 6e67  nc)(args, cotang
+0001efd0: 656e 7473 2c20 2a2a 6b77 6172 6773 290a  ents, **kwargs).
+0001efe0: 0a20 2020 2072 6574 7572 6e20 5f76 616c  .    return _val
+0001eff0: 7565 5f61 6e64 5f67 7261 640a 0a0a 466f  ue_and_grad...Fo
+0001f000: 7277 6172 6442 6163 6b77 6172 6454 7261  rwardBackwardTra
+0001f010: 6365 7320 3d20 6e61 6d65 6474 7570 6c65  ces = namedtuple
+0001f020: 2822 466f 7277 6172 6442 6163 6b77 6172  ("ForwardBackwar
+0001f030: 6454 7261 6365 7322 2c20 5b22 666f 7277  dTraces", ["forw
+0001f040: 6172 645f 7472 6163 6522 2c20 2262 6163  ard_trace", "bac
+0001f050: 6b77 6172 645f 7472 6163 6522 5d29 0a0a  kward_trace"])..
+0001f060: 0a64 6566 205f 7370 6c69 745f 7361 7665  .def _split_save
+0001f070: 645f 666f 725f 6261 636b 7761 7264 5f69  d_for_backward_i
+0001f080: 6e74 6f5f 7465 6e73 6f72 735f 616e 645f  nto_tensors_and_
+0001f090: 6f74 6865 7228 0a20 2020 2073 6176 6564  other(.    saved
+0001f0a0: 5f66 6f72 5f62 6163 6b77 6172 643a 2053  _for_backward: S
+0001f0b0: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
+0001f0c0: 5d2c 0a29 202d 3e20 7475 706c 655b 5365  ],.) -> tuple[Se
+0001f0d0: 7175 656e 6365 5b56 6172 6961 626c 655d  quence[Variable]
+0001f0e0: 2c20 5365 7175 656e 6365 5b56 6172 6961  , Sequence[Varia
+0001f0f0: 626c 655d 5d3a 0a20 2020 2022 2222 5370  ble]]:.    """Sp
+0001f100: 6c69 7473 2073 6176 6564 5f66 6f72 5f62  lits saved_for_b
+0001f110: 6163 6b77 6172 6420 696e 746f 2074 656e  ackward into ten
+0001f120: 736f 7273 2061 6e64 206f 7468 6572 2e0a  sors and other..
+0001f130: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+0001f140: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
+0001f150: 6b77 6172 6420 2853 6571 7565 6e63 655b  kward (Sequence[
+0001f160: 5661 7269 6162 6c65 5d29 3a20 5361 7665  Variable]): Save
+0001f170: 645f 666f 725f 6261 636b 7761 7264 2074  d_for_backward t
+0001f180: 6f20 7370 6c69 742e 0a0a 2020 2020 5265  o split...    Re
+0001f190: 7475 726e 733a 0a20 2020 2020 2020 2074  turns:.        t
+0001f1a0: 7570 6c65 5b53 6571 7565 6e63 655b 5661  uple[Sequence[Va
+0001f1b0: 7269 6162 6c65 5d2c 2053 6571 7565 6e63  riable], Sequenc
+0001f1c0: 655b 5661 7269 6162 6c65 5d5d 3a20 5475  e[Variable]]: Tu
+0001f1d0: 706c 6520 6f66 2074 656e 736f 7273 2061  ple of tensors a
+0001f1e0: 6e64 206f 7468 6572 2e0a 2020 2020 2222  nd other..    ""
+0001f1f0: 220a 2020 2020 6973 5f74 656e 736f 7220  ".    is_tensor 
+0001f200: 3d20 6c61 6d62 6461 2078 3a20 6973 696e  = lambda x: isin
+0001f210: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
+0001f220: 5072 6f78 7929 0a20 2020 206f 7468 6572  Proxy).    other
+0001f230: 2c20 7465 6e73 6f72 7320 3d20 7574 696c  , tensors = util
+0001f240: 732e 7061 7274 6974 696f 6e28 6973 5f74  s.partition(is_t
+0001f250: 656e 736f 722c 2073 6176 6564 5f66 6f72  ensor, saved_for
+0001f260: 5f62 6163 6b77 6172 6429 0a20 2020 2072  _backward).    r
+0001f270: 6574 7572 6e20 7475 706c 6528 7465 6e73  eturn tuple(tens
+0001f280: 6f72 7329 2c20 7475 706c 6528 6f74 6865  ors), tuple(othe
+0001f290: 7229 0a0a 0a64 6566 205f 7570 6461 7465  r)...def _update
+0001f2a0: 5f66 6f72 7761 7264 5f77 6974 685f 6e65  _forward_with_ne
+0001f2b0: 775f 7361 7665 645f 666f 725f 6261 636b  w_saved_for_back
+0001f2c0: 7761 7264 2866 6f72 7761 7264 5f74 7261  ward(forward_tra
+0001f2d0: 6365 3a20 5472 6163 652c 2073 6176 6564  ce: Trace, saved
+0001f2e0: 5f66 6f72 5f62 6163 6b77 6172 643a 2053  _for_backward: S
+0001f2f0: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
+0001f300: 5d29 202d 3e20 4e6f 6e65 3a0a 2020 2020  ]) -> None:.    
+0001f310: 2222 2255 7064 6174 6573 2074 6865 2066  """Updates the f
+0001f320: 6f72 7761 7264 2074 7261 6365 2077 6974  orward trace wit
+0001f330: 6820 6e65 7720 7361 7665 645f 666f 725f  h new saved_for_
+0001f340: 6261 636b 7761 7264 2e0a 0a20 2020 2054  backward...    T
+0001f350: 6869 7320 6973 206e 6563 6573 7361 7279  his is necessary
+0001f360: 2062 6563 6175 7365 2074 6865 2075 7064   because the upd
+0001f370: 6174 6564 2073 6176 6564 5f66 6f72 5f62  ated saved_for_b
+0001f380: 6163 6b77 6172 6420 6973 206e 6f74 2061  ackward is not a
+0001f390: 7661 696c 6162 6c65 0a20 2020 2077 6865  vailable.    whe
+0001f3a0: 6e20 7468 6520 666f 7277 6172 6420 616e  n the forward an
+0001f3b0: 6420 6261 636b 7761 7264 2074 7261 6365  d backward trace
+0001f3c0: 7320 6172 6520 636f 6e73 7472 7563 7465  s are constructe
+0001f3d0: 642e 0a0a 2020 2020 4172 6773 3a0a 2020  d...    Args:.  
+0001f3e0: 2020 2020 2020 666f 7277 6172 645f 7472        forward_tr
+0001f3f0: 6163 6520 2854 7261 6365 293a 2046 6f72  ace (Trace): For
+0001f400: 7761 7264 2074 7261 6365 2074 6f20 7570  ward trace to up
+0001f410: 6461 7465 2e0a 2020 2020 2020 2020 7361  date..        sa
+0001f420: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f430: 2028 5365 7175 656e 6365 5b56 6172 6961   (Sequence[Varia
+0001f440: 626c 655d 293a 2053 6176 6564 5f66 6f72  ble]): Saved_for
+0001f450: 5f62 6163 6b77 6172 6420 746f 2075 7365  _backward to use
+0001f460: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
+0001f470: 7570 6461 7465 2074 6865 2066 6f72 7761  update the forwa
+0001f480: 7264 2074 7261 6365 2e0a 2020 2020 2222  rd trace..    ""
+0001f490: 220a 2020 2020 7361 7665 645f 666f 725f  ".    saved_for_
+0001f4a0: 6261 636b 7761 7264 203d 2074 7265 655f  backward = tree_
+0001f4b0: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
+0001f4c0: 7661 6c75 6520 6966 2069 7369 6e73 7461  value if isinsta
+0001f4d0: 6e63 6528 782c 204e 756d 6265 7250 726f  nce(x, NumberPro
+0001f4e0: 7879 2920 656c 7365 2078 2c20 7361 7665  xy) else x, save
+0001f4f0: 645f 666f 725f 6261 636b 7761 7264 290a  d_for_backward).
+0001f500: 2020 2020 7361 7665 645f 7465 6e73 6f72      saved_tensor
+0001f510: 732c 2073 6176 6564 5f6f 7468 6572 203d  s, saved_other =
+0001f520: 205f 7370 6c69 745f 7361 7665 645f 666f   _split_saved_fo
+0001f530: 725f 6261 636b 7761 7264 5f69 6e74 6f5f  r_backward_into_
+0001f540: 7465 6e73 6f72 735f 616e 645f 6f74 6865  tensors_and_othe
+0001f550: 7228 7361 7665 645f 666f 725f 6261 636b  r(saved_for_back
+0001f560: 7761 7264 290a 2020 2020 6173 7365 7274  ward).    assert
+0001f570: 2066 6f72 7761 7264 5f74 7261 6365 2e62   forward_trace.b
+0001f580: 6f75 6e64 5f73 796d 626f 6c73 5b2d 315d  ound_symbols[-1]
+0001f590: 2e73 796d 2e69 6420 3d3d 2070 7269 6d73  .sym.id == prims
+0001f5a0: 2e50 7269 6d49 4473 2e52 4554 5552 4e0a  .PrimIDs.RETURN.
+0001f5b0: 2020 2020 6e65 775f 7265 7475 726e 203d      new_return =
+0001f5c0: 2028 666f 7277 6172 645f 7472 6163 652e   (forward_trace.
+0001f5d0: 6f75 7470 7574 5b30 5d2c 2028 7361 7665  output[0], (save
+0001f5e0: 645f 7465 6e73 6f72 732c 2073 6176 6564  d_tensors, saved
+0001f5f0: 5f6f 7468 6572 2929 0a20 2020 2066 6f72  _other)).    for
+0001f600: 7761 7264 5f74 7261 6365 2e62 6f75 6e64  ward_trace.bound
+0001f610: 5f73 796d 626f 6c73 5b2d 315d 203d 2072  _symbols[-1] = r
+0001f620: 6570 6c61 6365 2866 6f72 7761 7264 5f74  eplace(forward_t
+0001f630: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+0001f640: 6c73 5b2d 315d 2c20 6172 6773 3d6e 6577  ls[-1], args=new
+0001f650: 5f72 6574 7572 6e29 0a0a 0a64 6566 205f  _return)...def _
+0001f660: 7570 6461 7465 5f62 6163 6b77 6172 645f  update_backward_
+0001f670: 7769 7468 5f6e 6577 5f73 6176 6564 5f66  with_new_saved_f
+0001f680: 6f72 5f62 6163 6b77 6172 6428 6261 636b  or_backward(back
+0001f690: 7761 7264 5f74 7261 6365 3a20 5472 6163  ward_trace: Trac
+0001f6a0: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
+0001f6b0: 6b77 6172 643a 2053 6571 7565 6e63 655b  kward: Sequence[
+0001f6c0: 5661 7269 6162 6c65 5d29 202d 3e20 4e6f  Variable]) -> No
+0001f6d0: 6e65 3a0a 2020 2020 2222 2255 7064 6174  ne:.    """Updat
+0001f6e0: 6573 2074 6865 2062 6163 6b77 6172 6420  es the backward 
+0001f6f0: 7472 6163 6520 7769 7468 206e 6577 2073  trace with new s
+0001f700: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001f710: 642e 0a0a 2020 2020 5468 6973 2069 7320  d...    This is 
+0001f720: 6e65 6365 7373 6172 7920 6265 6361 7573  necessary becaus
+0001f730: 6520 7468 6520 7570 6461 7465 6420 7361  e the updated sa
+0001f740: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f750: 2069 730a 2020 2020 6e6f 7420 6176 6169   is.    not avai
+0001f760: 6c61 626c 6520 7768 656e 2074 6865 2062  lable when the b
+0001f770: 6163 6b77 6172 6420 7472 6163 6520 6973  ackward trace is
+0001f780: 2063 6f6e 7374 7275 6374 6564 2e0a 0a20   constructed... 
+0001f790: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0001f7a0: 2062 6163 6b77 6172 645f 7472 6163 6520   backward_trace 
+0001f7b0: 2854 7261 6365 293a 2042 6163 6b77 6172  (Trace): Backwar
+0001f7c0: 6420 7472 6163 6520 746f 2075 7064 6174  d trace to updat
+0001f7d0: 652e 0a20 2020 2020 2020 2073 6176 6564  e..        saved
+0001f7e0: 5f66 6f72 5f62 6163 6b77 6172 6420 2853  _for_backward (S
+0001f7f0: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
+0001f800: 5d29 3a20 5361 7665 645f 666f 725f 6261  ]): Saved_for_ba
+0001f810: 636b 7761 7264 2074 6f20 7573 6520 746f  ckward to use to
+0001f820: 0a20 2020 2020 2020 2020 2020 2075 7064  .            upd
+0001f830: 6174 6520 7468 6520 6261 636b 7761 7264  ate the backward
+0001f840: 2074 7261 6365 2e0a 2020 2020 2222 220a   trace..    """.
+0001f850: 0a20 2020 2064 6566 2075 6e70 6163 6b69  .    def unpacki
+0001f860: 6e67 5f66 6e28 7361 7665 645f 666f 725f  ng_fn(saved_for_
+0001f870: 6261 636b 7761 7264 2c20 636f 7461 6e67  backward, cotang
+0001f880: 656e 7473 293a 0a20 2020 2020 2020 2070  ents):.        p
+0001f890: 6173 730a 0a20 2020 2063 6f74 616e 6765  ass..    cotange
+0001f8a0: 6e74 7320 3d20 6261 636b 7761 7264 5f74  nts = backward_t
+0001f8b0: 7261 6365 2e61 7267 735b 315d 0a20 2020  race.args[1].   
+0001f8c0: 2073 6176 6564 5f74 656e 736f 7273 2c20   saved_tensors, 
+0001f8d0: 7361 7665 645f 6f74 6865 7220 3d20 5f73  saved_other = _s
+0001f8e0: 706c 6974 5f73 6176 6564 5f66 6f72 5f62  plit_saved_for_b
+0001f8f0: 6163 6b77 6172 645f 696e 746f 5f74 656e  ackward_into_ten
+0001f900: 736f 7273 5f61 6e64 5f6f 7468 6572 2873  sors_and_other(s
+0001f910: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001f920: 6429 0a20 2020 2075 6e70 6163 6b69 6e67  d).    unpacking
+0001f930: 5f74 7261 6365 203d 2063 6f6e 7374 7275  _trace = constru
+0001f940: 6374 5f74 7261 6365 2872 656e 616d 655f  ct_trace(rename_
+0001f950: 7072 6f78 6965 733d 4661 6c73 652c 2075  proxies=False, u
+0001f960: 7365 5f64 6365 3d46 616c 7365 2928 0a20  se_dce=False)(. 
+0001f970: 2020 2020 2020 2075 6e70 6163 6b69 6e67         unpacking
+0001f980: 5f66 6e2c 2028 7361 7665 645f 7465 6e73  _fn, (saved_tens
+0001f990: 6f72 732c 2073 6176 6564 5f6f 7468 6572  ors, saved_other
+0001f9a0: 292c 2063 6f74 616e 6765 6e74 730a 2020  ), cotangents.  
+0001f9b0: 2020 290a 2020 2020 6173 7365 7274 2075    ).    assert u
+0001f9c0: 6e70 6163 6b69 6e67 5f74 7261 6365 2e62  npacking_trace.b
+0001f9d0: 6f75 6e64 5f73 796d 626f 6c73 5b2d 315d  ound_symbols[-1]
+0001f9e0: 2e73 796d 2e69 6420 3d3d 2070 7269 6d73  .sym.id == prims
+0001f9f0: 2e50 7269 6d49 4473 2e52 4554 5552 4e0a  .PrimIDs.RETURN.
+0001fa00: 0a20 2020 2062 6163 6b77 6172 645f 7472  .    backward_tr
+0001fa10: 6163 652e 6172 6773 203d 2075 6e70 6163  ace.args = unpac
+0001fa20: 6b69 6e67 5f74 7261 6365 2e61 7267 730a  king_trace.args.
+0001fa30: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
+0001fa40: 6365 5f62 7379 6d73 5f77 6974 686f 7574  ce_bsyms_without
+0001fa50: 5f75 6e70 6163 6b69 6e67 203d 2028 0a20  _unpacking = (. 
+0001fa60: 2020 2020 2020 2062 7379 6d0a 2020 2020         bsym.    
+0001fa70: 2020 2020 666f 7220 6273 796d 2069 6e20      for bsym in 
+0001fa80: 6261 636b 7761 7264 5f74 7261 6365 2e62  backward_trace.b
+0001fa90: 6f75 6e64 5f73 796d 626f 6c73 0a20 2020  ound_symbols.   
+0001faa0: 2020 2020 2069 6620 6273 796d 2e73 796d       if bsym.sym
+0001fab0: 2e69 640a 2020 2020 2020 2020 6e6f 7420  .id.        not 
+0001fac0: 696e 2028 0a20 2020 2020 2020 2020 2020  in (.           
+0001fad0: 2070 7269 6d73 2e50 7269 6d49 4473 2e55   prims.PrimIDs.U
+0001fae0: 4e50 4143 4b5f 454d 5054 595f 4449 4354  NPACK_EMPTY_DICT
+0001faf0: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
+0001fb00: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
+0001fb10: 434b 5f4b 4559 2c0a 2020 2020 2020 2020  CK_KEY,.        
+0001fb20: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+0001fb30: 732e 554e 5041 434b 5f53 4551 5545 4e43  s.UNPACK_SEQUENC
+0001fb40: 452c 0a20 2020 2020 2020 2020 2020 2070  E,.            p
+0001fb50: 7269 6d73 2e50 7269 6d49 4473 2e55 4e50  rims.PrimIDs.UNP
+0001fb60: 4143 4b5f 5452 4956 4941 4c2c 0a20 2020  ACK_TRIVIAL,.   
+0001fb70: 2020 2020 2029 0a20 2020 2029 0a20 2020       ).    ).   
+0001fb80: 2062 6163 6b77 6172 645f 7472 6163 652e   backward_trace.
+0001fb90: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
+0001fba0: 6c69 7374 2828 2a75 6e70 6163 6b69 6e67  list((*unpacking
+0001fbb0: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
+0001fbc0: 626f 6c73 5b3a 2d31 5d2c 202a 6261 636b  bols[:-1], *back
+0001fbd0: 7761 7264 5f74 7261 6365 5f62 7379 6d73  ward_trace_bsyms
+0001fbe0: 5f77 6974 686f 7574 5f75 6e70 6163 6b69  _without_unpacki
+0001fbf0: 6e67 2929 0a0a 0a23 204e 4f54 453a 2052  ng))...# NOTE: R
+0001fc00: 6574 7572 6e69 6e67 206e 616d 6564 7475  eturning namedtu
+0001fc10: 706c 6573 2066 726f 6d20 636f 6d70 696c  ples from compil
+0001fc20: 6564 2066 756e 6374 696f 6e73 2064 6f65  ed functions doe
+0001fc30: 736e 2774 2077 6f72 6b2e 2053 6565 3a0a  sn't work. See:.
+0001fc40: 2320 2241 6c6c 6f77 2072 6574 7572 6e69  # "Allow returni
+0001fc50: 6e67 206e 616d 6564 7475 706c 6573 2066  ng namedtuples f
+0001fc60: 726f 6d20 636f 6d70 696c 6564 2066 756e  rom compiled fun
+0001fc70: 6374 696f 6e73 220a 2320 4e6f 7465 205b  ctions".# Note [
+0001fc80: 4772 6164 2066 6f72 7761 7264 206f 7574  Grad forward out
+0001fc90: 7075 7420 7370 6563 5d0a 2320 4966 2069  put spec].# If i
+0001fca0: 7420 6469 6420 776f 726b 2069 7420 776f  t did work it wo
+0001fcb0: 756c 6420 6265 206e 6963 6520 746f 2075  uld be nice to u
+0001fcc0: 7365 2074 6869 7320 6e61 6d65 6474 7570  se this namedtup
+0001fcd0: 6c65 0a23 2069 6e73 7465 6164 206f 6620  le.# instead of 
+0001fce0: 7468 6520 706c 6169 6e20 7475 706c 6520  the plain tuple 
+0001fcf0: 6f72 2064 6963 7420 7468 6174 2077 6527  or dict that we'
+0001fd00: 7265 2075 7369 6e67 206e 6f77 2e0a 546f  re using now..To
+0001fd10: 7263 6841 7574 6f67 7261 6446 6f72 7761  rchAutogradForwa
+0001fd20: 7264 4461 7461 203d 206e 616d 6564 7475  rdData = namedtu
+0001fd30: 706c 6528 0a20 2020 2022 546f 7263 6841  ple(.    "TorchA
+0001fd40: 7574 6f67 7261 6446 6f72 7761 7264 4461  utogradForwardDa
+0001fd50: 7461 222c 0a20 2020 205b 226f 7574 7075  ta",.    ["outpu
+0001fd60: 7422 2c20 2266 6c61 745f 6172 6773 222c  t", "flat_args",
+0001fd70: 2022 666c 6174 5f6f 7574 7075 7422 5d2c   "flat_output"],
+0001fd80: 0a29 0a0a 0a64 6566 2066 6f72 7761 7264  .)...def forward
+0001fd90: 5f61 6e64 5f62 6163 6b77 6172 645f 6672  _and_backward_fr
+0001fda0: 6f6d 5f74 7261 6365 2874 7261 6365 3a20  om_trace(trace: 
+0001fdb0: 5472 6163 652c 2074 6f72 6368 5f61 7574  Trace, torch_aut
+0001fdc0: 6f67 7261 643d 4661 6c73 6529 202d 3e20  ograd=False) -> 
+0001fdd0: 466f 7277 6172 6442 6163 6b77 6172 6454  ForwardBackwardT
+0001fde0: 7261 6365 733a 0a20 2020 2022 2222 4765  races:.    """Ge
+0001fdf0: 6e65 7261 7465 7320 7468 6520 666f 7277  nerates the forw
+0001fe00: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
+0001fe10: 2070 6173 7365 7320 6672 6f6d 2061 2074   passes from a t
+0001fe20: 7261 6365 2e0a 0a20 2020 2054 6869 7320  race...    This 
+0001fe30: 6973 2061 2063 6f6e 7665 6e69 656e 6365  is a convenience
+0001fe40: 2066 756e 6374 696f 6e20 7468 6174 2063   function that c
+0001fe50: 6f6d 6269 6e65 7320 7468 6520 6675 6e63  ombines the func
+0001fe60: 7469 6f6e 616c 6974 7920 6f66 0a20 2020  tionality of.   
+0001fe70: 2060 6175 676d 656e 7465 645f 666f 7277   `augmented_forw
+0001fe80: 6172 645f 7061 7373 6020 616e 6420 6062  ard_pass` and `b
+0001fe90: 6163 6b77 6172 645f 7061 7373 602e 2054  ackward_pass`. T
+0001fea0: 6865 206d 6169 6e20 6469 6666 6572 656e  he main differen
+0001feb0: 6365 2069 7320 7468 6174 0a20 2020 2074  ce is that.    t
+0001fec0: 6869 7320 6675 6e63 7469 6f6e 2064 6f65  his function doe
+0001fed0: 7320 6e6f 7420 7265 7175 6972 6520 7468  s not require th
+0001fee0: 6520 7573 6572 2074 6f20 7072 6f76 6964  e user to provid
+0001fef0: 6520 6e65 7720 696e 7075 7473 2066 6f72  e new inputs for
+0001ff00: 2074 6865 0a20 2020 2074 7261 6365 2065   the.    trace e
+0001ff10: 7661 6c75 6174 696f 6e2e 2049 6e73 7465  valuation. Inste
+0001ff20: 6164 2069 7420 7573 6573 2074 6865 2069  ad it uses the i
+0001ff30: 6e70 7574 7320 7468 6174 2077 6572 6520  nputs that were 
+0001ff40: 7573 6564 2074 6f20 636f 6e73 7472 7563  used to construc
+0001ff50: 740a 2020 2020 7468 6520 7472 6163 652e  t.    the trace.
+0001ff60: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0001ff70: 2020 2020 7472 6163 6520 2854 7261 6365      trace (Trace
+0001ff80: 293a 2054 7261 6365 2074 6f20 6765 6e65  ): Trace to gene
+0001ff90: 7261 7465 2074 6865 2066 6f72 7761 7264  rate the forward
+0001ffa0: 2061 6e64 2062 6163 6b77 6172 6420 7061   and backward pa
+0001ffb0: 7373 6573 2066 726f 6d2e 0a0a 2020 2020  sses from...    
+0001ffc0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+0001ffd0: 2046 6f72 7761 7264 4261 636b 7761 7264   ForwardBackward
+0001ffe0: 5472 6163 6573 3a20 4120 6e61 6d65 6420  Traces: A named 
+0001fff0: 7475 706c 6520 636f 6e74 6169 6e69 6e67  tuple containing
+00020000: 2074 6865 2066 6f72 7761 7264 2061 6e64   the forward and
+00020010: 2062 6163 6b77 6172 640a 2020 2020 2020   backward.      
+00020020: 2020 2020 2020 7472 6163 6573 2e0a 0a20        traces... 
+00020030: 2020 2045 7861 6d70 6c65 3a0a 2020 2020     Example:.    
+00020040: 2020 2020 3e3e 3e20 696d 706f 7274 2074      >>> import t
+00020050: 6f72 6368 0a20 2020 2020 2020 203e 3e3e  orch.        >>>
+00020060: 2066 726f 6d20 7468 756e 6465 7220 696d   from thunder im
+00020070: 706f 7274 2063 6f6d 7069 6c65 2c20 6c61  port compile, la
+00020080: 7374 5f74 7261 6365 730a 2020 2020 2020  st_traces.      
+00020090: 2020 3e3e 3e20 6672 6f6d 2074 6875 6e64    >>> from thund
+000200a0: 6572 2e63 6f72 652e 7472 616e 7366 6f72  er.core.transfor
+000200b0: 6d73 2069 6d70 6f72 7420 666f 7277 6172  ms import forwar
+000200c0: 645f 616e 645f 6261 636b 7761 7264 5f66  d_and_backward_f
+000200d0: 726f 6d5f 7472 6163 650a 2020 2020 2020  rom_trace.      
+000200e0: 2020 3e3e 3e20 6465 6620 6628 7829 3a0a    >>> def f(x):.
+000200f0: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
+00020100: 7265 7475 726e 2074 6f72 6368 2e73 696e  return torch.sin
+00020110: 2878 290a 2020 2020 2020 2020 3e3e 3e20  (x).        >>> 
+00020120: 7820 3d20 746f 7263 682e 7465 6e73 6f72  x = torch.tensor
+00020130: 2833 2e30 290a 2020 2020 2020 2020 3e3e  (3.0).        >>
+00020140: 3e20 6366 203d 2063 6f6d 7069 6c65 2866  > cf = compile(f
+00020150: 290a 2020 2020 2020 2020 3e3e 3e20 6f75  ).        >>> ou
+00020160: 7420 3d20 6366 2878 290a 2020 2020 2020  t = cf(x).      
+00020170: 2020 3e3e 3e20 7472 6163 6520 3d20 6c61    >>> trace = la
+00020180: 7374 5f74 7261 6365 7328 6366 295b 305d  st_traces(cf)[0]
+00020190: 0a20 2020 2020 2020 203e 3e3e 2066 6f72  .        >>> for
+000201a0: 7761 7264 5f61 6e64 5f62 6163 6b77 6172  ward_and_backwar
+000201b0: 645f 6672 6f6d 5f74 7261 6365 2874 7261  d_from_trace(tra
+000201c0: 6365 290a 2020 2020 2020 2020 2e2e 2e20  ce).        ... 
+000201d0: 466f 7277 6172 6442 6163 6b77 6172 6454  ForwardBackwardT
+000201e0: 7261 6365 7328 0a20 2020 2020 2020 202e  races(.        .
+000201f0: 2e2e 2066 6f72 7761 7264 5f74 7261 6365  .. forward_trace
+00020200: 3d23 2069 6d70 6f72 7420 7468 756e 6465  =# import thunde
+00020210: 7220 6173 2074 6875 6e64 6572 0a20 2020  r as thunder.   
+00020220: 2020 2020 202e 2e2e 2023 2069 6d70 6f72       ... # impor
+00020230: 7420 7468 756e 6465 722e 636f 7265 2e70  t thunder.core.p
+00020240: 7269 6d73 2061 7320 7072 696d 730a 2020  rims as prims.  
+00020250: 2020 2020 2020 2e2e 2e20 696d 706f 7274        ... import
+00020260: 2074 6f72 6368 0a20 2020 2020 2020 202e   torch.        .
+00020270: 2e2e 0a20 2020 2020 2020 202e 2e2e 2040  ...        ... @
+00020280: 746f 7263 682e 6e6f 5f67 7261 6428 290a  torch.no_grad().
+00020290: 2020 2020 2020 2020 2e2e 2e20 6465 6620          ... def 
+000202a0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+000202b0: 645f 666e 282a 6172 6773 293a 0a20 2020  d_fn(*args):.   
+000202c0: 2020 2020 202e 2e2e 2020 2023 2061 7267       ...   # arg
+000202d0: 733a 2022 436f 6c6c 6563 7469 6f6e 2220  s: "Collection" 
+000202e0: 3d20 2028 7430 2c29 2020 2874 7269 7669  =  (t0,)  (trivi
+000202f0: 616c 2075 6e70 6163 6b29 0a20 2020 2020  al unpack).     
+00020300: 2020 202e 2e2e 2020 2074 302c 205c 0a20     ...   t0, \. 
+00020310: 2020 2020 2020 202e 2e2e 2020 203d 2061         ...   = a
+00020320: 7267 730a 2020 2020 2020 2020 2e2e 2e20  rgs.        ... 
+00020330: 2020 7431 203d 2070 7269 6d73 2e73 696e    t1 = prims.sin
+00020340: 2874 3029 2020 2320 7431 3a20 2263 7075  (t0)  # t1: "cpu
+00020350: 2066 3332 5b5d 220a 2020 2020 2020 2020   f32[]".        
+00020360: 2e2e 2e20 2020 7265 7475 726e 2074 312c  ...   return t1,
+00020370: 2028 7430 2c29 2c0a 2020 2020 2020 2020   (t0,),.        
+00020380: 2e2e 2e20 6261 636b 7761 7264 5f74 7261  ... backward_tra
+00020390: 6365 3d23 2069 6d70 6f72 7420 7468 756e  ce=# import thun
+000203a0: 6465 7220 6173 2074 6875 6e64 6572 0a20  der as thunder. 
+000203b0: 2020 2020 2020 202e 2e2e 2023 2069 6d70         ... # imp
+000203c0: 6f72 7420 7468 756e 6465 722e 636f 7265  ort thunder.core
+000203d0: 2e70 7269 6d73 2061 7320 7072 696d 730a  .prims as prims.
+000203e0: 2020 2020 2020 2020 2e2e 2e20 696d 706f          ... impo
+000203f0: 7274 2074 6f72 6368 0a20 2020 2020 2020  rt torch.       
+00020400: 202e 2e2e 0a20 2020 2020 2020 202e 2e2e   ....        ...
+00020410: 2040 746f 7263 682e 6e6f 5f67 7261 6428   @torch.no_grad(
+00020420: 290a 2020 2020 2020 2020 2e2e 2e20 6465  ).        ... de
+00020430: 6620 6261 636b 7761 7264 5f66 6e28 7361  f backward_fn(sa
+00020440: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+00020450: 2c20 636f 7461 6e67 656e 7473 293a 0a20  , cotangents):. 
+00020460: 2020 2020 2020 202e 2e2e 2020 2023 2073         ...   # s
+00020470: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+00020480: 643a 2022 436f 6c6c 6563 7469 6f6e 2220  d: "Collection" 
+00020490: 3d20 2028 7430 2c29 2020 2874 7269 7669  =  (t0,)  (trivi
+000204a0: 616c 2075 6e70 6163 6b29 0a20 2020 2020  al unpack).     
+000204b0: 2020 202e 2e2e 2020 2023 2063 6f74 616e     ...   # cotan
+000204c0: 6765 6e74 733a 2022 6370 7520 6633 325b  gents: "cpu f32[
+000204d0: 5d22 203d 2020 636f 7461 6e67 656e 7473  ]" =  cotangents
+000204e0: 2020 2874 7269 7669 616c 2075 6e70 6163    (trivial unpac
+000204f0: 6b29 0a20 2020 2020 2020 202e 2e2e 2020  k).        ...  
+00020500: 2074 302c 205c 0a20 2020 2020 2020 202e   t0, \.        .
+00020510: 2e2e 2020 203d 2073 6176 6564 5f66 6f72  ..   = saved_for
+00020520: 5f62 6163 6b77 6172 640a 2020 2020 2020  _backward.      
+00020530: 2020 2e2e 2e20 2020 7431 203d 2070 7269    ...   t1 = pri
+00020540: 6d73 2e63 6f73 2874 3029 2020 2320 7431  ms.cos(t0)  # t1
+00020550: 3a20 2263 7075 2066 3332 5b5d 220a 2020  : "cpu f32[]".  
+00020560: 2020 2020 2020 2e2e 2e20 2020 7432 203d        ...   t2 =
+00020570: 2070 7269 6d73 2e6d 756c 2863 6f74 616e   prims.mul(cotan
+00020580: 6765 6e74 732c 2074 3129 2020 2320 7432  gents, t1)  # t2
+00020590: 3a20 2263 7075 2066 3332 5b5d 220a 2020  : "cpu f32[]".  
+000205a0: 2020 2020 2020 2e2e 2e20 2020 7265 7475        ...   retu
+000205b0: 726e 2028 7432 2c29 290a 2020 2020 2222  rn (t2,)).    ""
+000205c0: 220a 0a20 2020 206f 7574 7075 745f 7370  "..    output_sp
+000205d0: 6563 203d 204e 6f6e 650a 0a20 2020 2064  ec = None..    d
+000205e0: 6566 2061 7567 6d65 6e74 6564 5f66 6f72  ef augmented_for
+000205f0: 7761 7264 5f66 6e28 2a61 7267 732c 202a  ward_fn(*args, *
+00020600: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00020610: 2020 7265 7375 6c74 2c20 656e 7620 3d20    result, env = 
+00020620: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00020630: 645f 7061 7373 282a 6172 6773 2c20 7472  d_pass(*args, tr
+00020640: 6163 653d 7472 6163 652c 202a 2a6b 7761  ace=trace, **kwa
+00020650: 7267 7329 0a20 2020 2020 2020 2073 6176  rgs).        sav
+00020660: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
+00020670: 3d20 6465 636f 6e73 7472 7563 745f 666f  = deconstruct_fo
+00020680: 7277 6172 645f 656e 765f 666f 725f 6261  rward_env_for_ba
+00020690: 636b 7761 7264 2874 7261 6365 2c20 656e  ckward(trace, en
+000206a0: 7629 0a20 2020 2020 2020 2069 6620 746f  v).        if to
+000206b0: 7263 685f 6175 746f 6772 6164 3a0a 2020  rch_autograd:.  
+000206c0: 2020 2020 2020 2020 2020 6e6f 6e6c 6f63            nonloc
+000206d0: 616c 206f 7574 7075 745f 7370 6563 0a20  al output_spec. 
+000206e0: 2020 2020 2020 2020 2020 2066 6c61 745f             flat_
+000206f0: 6172 6773 2c20 5f20 3d20 7472 6565 5f66  args, _ = tree_f
+00020700: 6c61 7474 656e 2828 6172 6773 2c20 6b77  latten((args, kw
+00020710: 6172 6773 2929 0a20 2020 2020 2020 2020  args)).         
+00020720: 2020 2066 6c61 745f 6f75 7470 7574 2c20     flat_output, 
+00020730: 6f75 7470 7574 5f73 7065 6320 3d20 7472  output_spec = tr
+00020740: 6565 5f66 6c61 7474 656e 2872 6573 756c  ee_flatten(resul
+00020750: 7429 0a20 2020 2020 2020 2020 2020 2066  t).            f
+00020760: 6c61 745f 6f75 7470 7574 203d 2074 7570  lat_output = tup
+00020770: 6c65 2866 6c61 745f 6f75 7470 7574 290a  le(flat_output).
+00020780: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
+00020790: 6520 4e6f 7465 205b 4772 6164 2066 6f72  e Note [Grad for
+000207a0: 7761 7264 206f 7574 7075 7420 7370 6563  ward output spec
+000207b0: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
+000207c0: 725f 6175 746f 6772 6164 203d 2054 6f72  r_autograd = Tor
+000207d0: 6368 4175 746f 6772 6164 466f 7277 6172  chAutogradForwar
+000207e0: 6444 6174 6128 0a20 2020 2020 2020 2020  dData(.         
+000207f0: 2020 2020 2020 2072 6573 756c 742c 0a20         result,. 
+00020800: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020810: 6c61 745f 6172 6773 2c0a 2020 2020 2020  lat_args,.      
+00020820: 2020 2020 2020 2020 2020 666c 6174 5f6f            flat_o
+00020830: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
+00020840: 2020 2029 2e5f 6173 6469 6374 2829 0a20     )._asdict(). 
+00020850: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00020860: 6e20 2866 6f72 5f61 7574 6f67 7261 642c  n (for_autograd,
+00020870: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+00020880: 6172 6429 0a20 2020 2020 2020 2072 6574  ard).        ret
+00020890: 7572 6e20 7265 7375 6c74 2c20 7361 7665  urn result, save
+000208a0: 645f 666f 725f 6261 636b 7761 7264 0a0a  d_for_backward..
+000208b0: 2020 2020 2320 436f 7079 2074 6865 2073      # Copy the s
+000208c0: 6967 6e61 7475 7265 206f 6620 7468 6520  ignature of the 
+000208d0: 6f72 6967 696e 616c 2066 756e 6374 696f  original functio
+000208e0: 6e20 736f 2074 6861 7420 7468 6520 6172  n so that the ar
+000208f0: 6775 6d65 6e74 7320 6172 650a 2020 2020  guments are.    
+00020900: 2320 6e61 6d65 6420 636f 7272 6563 746c  # named correctl
+00020910: 7920 696e 2074 6865 2061 7567 6d65 6e74  y in the augment
+00020920: 6564 2066 6f72 7761 7264 2070 6173 7320  ed forward pass 
+00020930: 696e 7374 6561 6420 6f66 2062 6569 6e67  instead of being
+00020940: 206e 616d 6564 0a20 2020 2023 2022 6172   named.    # "ar
+00020950: 6773 2220 616e 6420 226b 7761 7267 7322  gs" and "kwargs"
+00020960: 2e0a 2020 2020 6175 676d 656e 7465 645f  ..    augmented_
+00020970: 666f 7277 6172 645f 666e 2e5f 5f73 6967  forward_fn.__sig
+00020980: 6e61 7475 7265 5f5f 203d 2069 6e73 7065  nature__ = inspe
+00020990: 6374 2e73 6967 6e61 7475 7265 2874 7261  ct.signature(tra
+000209a0: 6365 2e66 6e20 6f72 2074 7261 6365 2e70  ce.fn or trace.p
+000209b0: 7974 686f 6e5f 6361 6c6c 6162 6c65 2829  ython_callable()
+000209c0: 290a 0a20 2020 2064 6566 206f 6e65 735f  )..    def ones_
+000209d0: 6c69 6b65 2878 293a 0a20 2020 2020 2020  like(x):.       
+000209e0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
+000209f0: 2c20 5465 6e73 6f72 5072 6f78 7929 3a0a  , TensorProxy):.
+00020a00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00020a10: 726e 2066 756c 6c5f 6c69 6b65 2878 2c20  rn full_like(x, 
+00020a20: 6669 6c6c 5f76 616c 7565 3d31 290a 2020  fill_value=1).  
+00020a30: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+00020a40: 7461 6e63 6528 782c 204e 756d 6265 7250  tance(x, NumberP
+00020a50: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
+00020a60: 2020 2072 6574 7572 6e20 7479 7065 2878     return type(x
+00020a70: 2e76 616c 7565 2928 3129 0a20 2020 2020  .value)(1).     
+00020a80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00020a90: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+00020aa0: 0a0a 2020 2020 666f 7277 6172 645f 7472  ..    forward_tr
+00020ab0: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
+00020ac0: 7472 6163 6528 2928 6175 676d 656e 7465  trace()(augmente
+00020ad0: 645f 666f 7277 6172 645f 666e 2c20 2a74  d_forward_fn, *t
+00020ae0: 7261 6365 2e61 7267 732c 202a 2a74 7261  race.args, **tra
+00020af0: 6365 2e6b 7761 7267 7329 0a20 2020 2023  ce.kwargs).    #
+00020b00: 2057 6520 7365 7420 666f 7277 6172 6420   We set forward 
+00020b10: 7472 6163 6520 746f 2063 6f6e 7374 7275  trace to constru
+00020b20: 6374 2070 726f 7869 6573 2062 6563 6175  ct proxies becau
+00020b30: 7365 2077 6520 6e65 6564 2074 6865 7365  se we need these
+00020b40: 2070 726f 7869 6573 2074 6f0a 2020 2020   proxies to.    
+00020b50: 2320 6861 7665 2064 6966 6665 7265 6e74  # have different
+00020b60: 206e 616d 6573 2074 6861 6e20 7468 6520   names than the 
+00020b70: 6f6e 6573 2069 6e20 7468 6520 666f 7277  ones in the forw
+00020b80: 6172 6420 7472 6163 652e 0a20 2020 2074  ard trace..    t
+00020b90: 7279 3a0a 2020 2020 2020 2020 7472 6163  ry:.        trac
+00020ba0: 6563 7478 5f74 6f6b 656e 203d 2073 6574  ectx_token = set
+00020bb0: 5f74 7261 6365 6374 7828 666f 7277 6172  _tracectx(forwar
+00020bc0: 645f 7472 6163 6529 0a20 2020 2020 2020  d_trace).       
+00020bd0: 2023 2057 6520 646f 6e27 7420 7761 6e74   # We don't want
+00020be0: 2074 6f20 7265 636f 7264 2074 686f 7365   to record those
+00020bf0: 206f 6e65 735f 6c69 6b65 2063 616c 6c73   ones_like calls
+00020c00: 2069 6e20 7468 6520 666f 7277 6172 6420   in the forward 
+00020c10: 7472 6163 652e 0a20 2020 2020 2020 2077  trace..        w
+00020c20: 6974 6820 6465 7461 6368 6564 5f74 7261  ith detached_tra
+00020c30: 6365 2829 3a0a 2020 2020 2020 2020 2020  ce():.          
+00020c40: 2020 6966 2074 6f72 6368 5f61 7574 6f67    if torch_autog
+00020c50: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
+00020c60: 2020 2020 2023 2049 7427 7320 6173 7375       # It's assu
+00020c70: 6d65 6420 7468 6174 2066 6f72 7761 7264  med that forward
+00020c80: 5f74 7261 6365 2e6f 7574 7075 745b 305d  _trace.output[0]
+00020c90: 2069 7320 6120 6469 6374 2066 726f 6d20   is a dict from 
+00020ca0: 546f 7263 6841 7574 6f67 7261 6446 6f72  TorchAutogradFor
+00020cb0: 7761 7264 4461 7461 0a20 2020 2020 2020  wardData.       
+00020cc0: 2020 2020 2020 2020 2066 6c61 745f 6f75           flat_ou
+00020cd0: 7470 7574 203d 2066 6f72 7761 7264 5f74  tput = forward_t
+00020ce0: 7261 6365 2e6f 7574 7075 745b 305d 5b22  race.output[0]["
+00020cf0: 666c 6174 5f6f 7574 7075 7422 5d0a 2020  flat_output"].  
+00020d00: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00020d10: 7461 6e67 656e 7473 203d 2075 7469 6c73  tangents = utils
+00020d20: 2e73 6571 7565 6e63 6966 7928 7472 6565  .sequencify(tree
+00020d30: 5f6d 6170 286c 616d 6264 6120 763a 206f  _map(lambda v: o
+00020d40: 6e65 735f 6c69 6b65 2876 292c 2066 6c61  nes_like(v), fla
+00020d50: 745f 6f75 7470 7574 2929 0a20 2020 2020  t_output)).     
+00020d60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00020d70: 2020 2020 2020 2020 2020 2020 2063 6f74               cot
+00020d80: 616e 6765 6e74 7320 3d20 7574 696c 732e  angents = utils.
+00020d90: 7365 7175 656e 6369 6679 2874 7265 655f  sequencify(tree_
+00020da0: 6d61 7028 6c61 6d62 6461 2076 3a20 6f6e  map(lambda v: on
+00020db0: 6573 5f6c 696b 6528 7629 2c20 7472 6163  es_like(v), trac
+00020dc0: 652e 6f75 7470 7574 2929 0a20 2020 2066  e.output)).    f
+00020dd0: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
+00020de0: 7265 7365 745f 7472 6163 6563 7478 2874  reset_tracectx(t
+00020df0: 7261 6365 6374 785f 746f 6b65 6e29 0a0a  racectx_token)..
+00020e00: 2020 2020 6465 6620 6261 636b 7761 7264      def backward
+00020e10: 5f66 6e28 7361 7665 645f 666f 725f 6261  _fn(saved_for_ba
+00020e20: 636b 7761 7264 2c20 636f 7461 6e67 656e  ckward, cotangen
+00020e30: 7473 293a 0a20 2020 2020 2020 2065 6e76  ts):.        env
+00020e40: 203d 2072 6563 6f6e 7374 7275 6374 5f66   = reconstruct_f
+00020e50: 6f72 7761 7264 5f65 6e76 5f66 6f72 5f62  orward_env_for_b
+00020e60: 6163 6b77 6172 6428 7472 6163 652c 2073  ackward(trace, s
+00020e70: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+00020e80: 6429 0a20 2020 2020 2020 2069 6620 746f  d).        if to
+00020e90: 7263 685f 6175 746f 6772 6164 3a0a 2020  rch_autograd:.  
+00020ea0: 2020 2020 2020 2020 2020 636f 7461 6e67            cotang
+00020eb0: 656e 7473 203d 2074 7265 655f 756e 666c  ents = tree_unfl
+00020ec0: 6174 7465 6e28 636f 7461 6e67 656e 7473  atten(cotangents
+00020ed0: 2c20 6f75 7470 7574 5f73 7065 6329 0a20  , output_spec). 
+00020ee0: 2020 2020 2020 206f 7574 203d 2062 6163         out = bac
+00020ef0: 6b77 6172 645f 7061 7373 2865 6e76 2c20  kward_pass(env, 
+00020f00: 7472 6163 652c 2063 6f74 616e 6765 6e74  trace, cotangent
+00020f10: 7329 0a20 2020 2020 2020 2069 6620 746f  s).        if to
+00020f20: 7263 685f 6175 746f 6772 6164 3a0a 2020  rch_autograd:.  
+00020f30: 2020 2020 2020 2020 2020 676b 7761 7267            gkwarg
+00020f40: 7320 3d20 6f75 745b 2d31 5d20 6966 2069  s = out[-1] if i
+00020f50: 7369 6e73 7461 6e63 6528 6f75 745b 2d31  sinstance(out[-1
+00020f60: 5d2c 2064 6963 7429 2065 6c73 6520 7b7d  ], dict) else {}
+00020f70: 0a20 2020 2020 2020 2020 2020 2067 6172  .            gar
+00020f80: 6773 203d 206f 7574 5b3a 2d31 5d20 6966  gs = out[:-1] if
+00020f90: 2069 7369 6e73 7461 6e63 6528 6f75 745b   isinstance(out[
+00020fa0: 2d31 5d2c 2064 6963 7429 2065 6c73 6520  -1], dict) else 
+00020fb0: 6f75 740a 2020 2020 2020 2020 2020 2020  out.            
+00020fc0: 676b 7761 7267 7320 3d20 7b6b 3a20 676b  gkwargs = {k: gk
+00020fd0: 7761 7267 732e 6765 7428 6b2c 204e 6f6e  wargs.get(k, Non
+00020fe0: 6529 2066 6f72 206b 2069 6e20 7472 6163  e) for k in trac
+00020ff0: 652e 6b77 6172 6773 7d0a 2020 2020 2020  e.kwargs}.      
+00021000: 2020 2020 2020 6f75 7420 3d20 282a 6761        out = (*ga
+00021010: 7267 732c 2067 6b77 6172 6773 290a 2020  rgs, gkwargs).  
+00021020: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
+00021030: 7472 6565 5f66 6c61 7474 656e 286f 7574  tree_flatten(out
+00021040: 295b 305d 0a20 2020 2020 2020 2072 6574  )[0].        ret
+00021050: 7572 6e20 6f75 740a 0a20 2020 2073 6176  urn out..    sav
+00021060: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
+00021070: 3d20 666f 7277 6172 645f 7472 6163 652e  = forward_trace.
+00021080: 6f75 7470 7574 5b31 5d0a 2020 2020 6261  output[1].    ba
+00021090: 636b 7761 7264 5f74 7261 6365 203d 2063  ckward_trace = c
+000210a0: 6f6e 7374 7275 6374 5f74 7261 6365 2872  onstruct_trace(r
+000210b0: 656e 616d 655f 7072 6f78 6965 733d 4661  ename_proxies=Fa
+000210c0: 6c73 6529 2862 6163 6b77 6172 645f 666e  lse)(backward_fn
+000210d0: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
+000210e0: 7761 7264 2c20 636f 7461 6e67 656e 7473  ward, cotangents
+000210f0: 290a 0a20 2020 2023 2057 6520 6172 6520  )..    # We are 
+00021100: 646f 6e65 2077 6974 6820 636f 6e73 7472  done with constr
+00021110: 7563 7469 6e67 2074 6865 2066 6f72 7761  ucting the forwa
+00021120: 7264 2061 6e64 2062 6163 6b77 6172 6420  rd and backward 
+00021130: 7061 7373 6573 2061 7420 7468 6973 0a20  passes at this. 
+00021140: 2020 2023 2073 7461 6765 2e20 5468 6520     # stage. The 
+00021150: 666f 6c6c 6f77 696e 6720 6973 206e 6f74  following is not
+00021160: 2073 7472 6963 746c 7920 6e65 6365 7373   strictly necess
+00021170: 6172 792c 2062 7574 2069 7427 7320 676f  ary, but it's go
+00021180: 6f64 2074 6f20 6669 6c74 6572 0a20 2020  od to filter.   
+00021190: 2023 206f 7574 2074 6865 2075 6e75 7365   # out the unuse
+000211a0: 6420 656c 656d 656e 7473 206f 6620 7468  d elements of th
+000211b0: 6520 7361 7665 645f 666f 725f 6261 636b  e saved_for_back
+000211c0: 7761 7264 2061 6e64 2066 6c61 7474 656e  ward and flatten
+000211d0: 2069 7420 666f 7220 6d6f 7265 0a20 2020   it for more.   
+000211e0: 2023 2063 6f6d 7061 6374 2062 6163 6b77   # compact backw
+000211f0: 6172 6420 7472 6163 652e 0a0a 2020 2020  ard trace...    
+00021200: 2320 4e6f 7720 7765 2063 616e 2064 6574  # Now we can det
+00021210: 6572 6d69 6e65 2065 7861 6374 6c79 2077  ermine exactly w
+00021220: 6861 7427 7320 7573 6564 2069 6e20 7468  hat's used in th
+00021230: 6520 6261 636b 7761 7264 2070 6173 7320  e backward pass 
+00021240: 6672 6f6d 2074 6865 0a20 2020 2023 2073  from the.    # s
+00021250: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+00021260: 642e 2057 6520 6361 6e20 666c 6174 7465  d. We can flatte
+00021270: 6e20 616e 6420 6669 6c74 6572 2074 6865  n and filter the
+00021280: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+00021290: 6172 640a 2020 2020 636f 6e73 756d 6572  ard.    consumer
+000212a0: 7320 3d20 7574 696c 732e 636f 6e73 756d  s = utils.consum
+000212b0: 6572 7328 6261 636b 7761 7264 5f74 7261  ers(backward_tra
+000212c0: 6365 290a 0a20 2020 2023 2046 6f72 7761  ce)..    # Forwa
+000212d0: 7264 2773 2061 6e64 2062 6163 6b77 6172  rd's and backwar
+000212e0: 6427 7320 2273 6176 6564 5f66 6f72 5f62  d's "saved_for_b
+000212f0: 6163 6b77 6172 6422 2061 7265 206e 6f74  ackward" are not
+00021300: 206e 6563 6573 7361 7269 6c79 2074 6865   necessarily the
+00021310: 2073 616d 650a 2020 2020 2320 6173 2074   same.    # as t
+00021320: 6865 2073 6176 6564 5f66 6f72 5f62 6163  he saved_for_bac
+00021330: 6b77 6172 642c 2062 6563 6175 7365 2073  kward, because s
+00021340: 6f6d 6520 6f72 2061 6c6c 2065 6c65 6d65  ome or all eleme
+00021350: 6e74 7320 6f66 2074 6865 0a20 2020 2023  nts of the.    #
+00021360: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+00021370: 6172 6420 7265 7375 6c74 7320 6d69 6768  ard results migh
+00021380: 7420 6265 2072 652d 7072 6f78 6966 6965  t be re-proxifie
+00021390: 642e 0a20 2020 2062 775f 666c 6174 5f73  d..    bw_flat_s
+000213a0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+000213b0: 642c 2073 7065 6320 3d20 7472 6565 5f66  d, spec = tree_f
+000213c0: 6c61 7474 656e 2862 6163 6b77 6172 645f  latten(backward_
+000213d0: 7472 6163 652e 6172 6773 5b30 5d29 0a20  trace.args[0]). 
+000213e0: 2020 2066 775f 666c 6174 5f73 6176 6564     fw_flat_saved
+000213f0: 5f66 6f72 5f62 6163 6b77 6172 642c 205f  _for_backward, _
+00021400: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
+00021410: 666f 7277 6172 645f 7472 6163 652e 6f75  forward_trace.ou
+00021420: 7470 7574 5b31 5d29 0a20 2020 2075 7365  tput[1]).    use
+00021430: 645f 6d61 736b 203d 206c 6973 7428 6c65  d_mask = list(le
+00021440: 6e28 636f 6e73 756d 6572 732e 6765 7428  n(consumers.get(
+00021450: 782c 2028 2929 2920 3e20 3020 666f 7220  x, ())) > 0 for 
+00021460: 7820 696e 2062 775f 666c 6174 5f73 6176  x in bw_flat_sav
+00021470: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
+00021480: 0a0a 2020 2020 2320 446f 6e27 7420 7573  ..    # Don't us
+00021490: 6520 7468 6520 7361 6d65 2076 6172 6961  e the same varia
+000214a0: 626c 6520 7477 6963 6520 696e 2074 6865  ble twice in the
+000214b0: 2062 6163 6b77 6172 6420 7061 7373 0a20   backward pass. 
+000214c0: 2020 2073 6565 6e20 3d20 7365 7428 290a     seen = set().
+000214d0: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
+000214e0: 2e63 6f72 652e 7072 6f78 6965 7320 696d  .core.proxies im
+000214f0: 706f 7274 2056 6172 6961 626c 650a 0a20  port Variable.. 
+00021500: 2020 2066 6f72 2069 2c20 7820 696e 2065     for i, x in e
+00021510: 6e75 6d65 7261 7465 2866 775f 666c 6174  numerate(fw_flat
+00021520: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
+00021530: 6172 6429 3a0a 2020 2020 2020 2020 7820  ard):.        x 
+00021540: 3d20 7661 7269 6162 6c65 6966 7928 7829  = variableify(x)
+00021550: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00021560: 6973 696e 7374 616e 6365 2878 2c20 5661  isinstance(x, Va
+00021570: 7269 6162 6c65 293a 0a20 2020 2020 2020  riable):.       
+00021580: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00021590: 2020 2020 2020 6966 2078 2069 6e20 7365        if x in se
+000215a0: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
+000215b0: 7573 6564 5f6d 6173 6b5b 695d 203d 2046  used_mask[i] = F
+000215c0: 616c 7365 0a20 2020 2020 2020 2065 6c73  alse.        els
+000215d0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000215e0: 6565 6e2e 6164 6428 7829 0a0a 2020 2020  een.add(x)..    
+000215f0: 6f6e 6c79 5f75 7365 645f 6677 5f73 6176  only_used_fw_sav
+00021600: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
+00021610: 3d20 7475 706c 6528 636f 6d70 7265 7373  = tuple(compress
+00021620: 2866 775f 666c 6174 5f73 6176 6564 5f66  (fw_flat_saved_f
+00021630: 6f72 5f62 6163 6b77 6172 642c 2075 7365  or_backward, use
+00021640: 645f 6d61 736b 2929 0a20 2020 206f 6e6c  d_mask)).    onl
+00021650: 795f 7573 6564 5f62 775f 7361 7665 645f  y_used_bw_saved_
+00021660: 666f 725f 6261 636b 7761 7264 203d 2074  for_backward = t
+00021670: 7570 6c65 2863 6f6d 7072 6573 7328 6277  uple(compress(bw
+00021680: 5f66 6c61 745f 7361 7665 645f 666f 725f  _flat_saved_for_
+00021690: 6261 636b 7761 7264 2c20 7573 6564 5f6d  backward, used_m
+000216a0: 6173 6b29 290a 0a20 2020 2023 2057 6520  ask))..    # We 
+000216b0: 6e65 6564 2074 6f20 7570 6461 7465 2074  need to update t
+000216c0: 6865 2074 7261 6365 7320 7769 7468 2074  he traces with t
+000216d0: 6865 206e 6577 2073 6176 6564 5f66 6f72  he new saved_for
+000216e0: 5f62 6163 6b77 6172 640a 2020 2020 5f75  _backward.    _u
+000216f0: 7064 6174 655f 666f 7277 6172 645f 7769  pdate_forward_wi
+00021700: 7468 5f6e 6577 5f73 6176 6564 5f66 6f72  th_new_saved_for
+00021710: 5f62 6163 6b77 6172 6428 666f 7277 6172  _backward(forwar
+00021720: 645f 7472 6163 652c 206f 6e6c 795f 7573  d_trace, only_us
+00021730: 6564 5f66 775f 7361 7665 645f 666f 725f  ed_fw_saved_for_
+00021740: 6261 636b 7761 7264 290a 2020 2020 5f75  backward).    _u
+00021750: 7064 6174 655f 6261 636b 7761 7264 5f77  pdate_backward_w
+00021760: 6974 685f 6e65 775f 7361 7665 645f 666f  ith_new_saved_fo
+00021770: 725f 6261 636b 7761 7264 2862 6163 6b77  r_backward(backw
+00021780: 6172 645f 7472 6163 652c 206f 6e6c 795f  ard_trace, only_
+00021790: 7573 6564 5f62 775f 7361 7665 645f 666f  used_bw_saved_fo
+000217a0: 725f 6261 636b 7761 7264 290a 2020 2020  r_backward).    
+000217b0: 666f 7277 6172 645f 7472 6163 652e 7365  forward_trace.se
+000217c0: 745f 7072 6f76 656e 616e 6365 2854 7261  t_provenance(Tra
+000217d0: 6365 5072 6f76 656e 616e 6365 2822 4175  ceProvenance("Au
+000217e0: 676d 656e 7465 6420 666f 7277 6172 6420  gmented forward 
+000217f0: 7061 7373 2229 290a 2020 2020 6261 636b  pass")).    back
+00021800: 7761 7264 5f74 7261 6365 2e73 6574 5f70  ward_trace.set_p
+00021810: 726f 7665 6e61 6e63 6528 5472 6163 6550  rovenance(TraceP
+00021820: 726f 7665 6e61 6e63 6528 2242 6163 6b77  rovenance("Backw
+00021830: 6172 6420 7061 7373 2229 290a 2020 2020  ard pass")).    
+00021840: 7265 7475 726e 2046 6f72 7761 7264 4261  return ForwardBa
+00021850: 636b 7761 7264 5472 6163 6573 2866 6f72  ckwardTraces(for
+00021860: 7761 7264 5f74 7261 6365 2c20 6261 636b  ward_trace, back
+00021870: 7761 7264 5f74 7261 6365 290a 0a0a 2320  ward_trace)...# 
+00021880: 646f 2077 6520 6861 7070 656e 2074 6f20  do we happen to 
+00021890: 7761 6e74 2074 6f20 7265 6769 7374 6572  want to register
+000218a0: 2060 6c74 6f72 6368 6020 6f70 7320 7375   `ltorch` ops su
+000218b0: 6368 2061 7320 606c 746f 7263 682e 6c61  ch as `ltorch.la
+000218c0: 7965 725f 6e6f 726d 6020 6173 2077 656c  yer_norm` as wel
+000218d0: 6c3f 0a61 7574 6f63 6173 745f 696d 706c  l?.autocast_impl
+000218e0: 733a 2064 6963 745b 7072 696d 732e 5072  s: dict[prims.Pr
+000218f0: 696d 4944 732c 2043 616c 6c61 626c 655d  imIDs, Callable]
+00021900: 203d 207b 7d0a 0a0a 6465 6620 7265 6769   = {}...def regi
+00021910: 7374 6572 5f61 7574 6f63 6173 745f 7275  ster_autocast_ru
+00021920: 6c65 286f 7029 3a0a 2020 2020 6465 6620  le(op):.    def 
+00021930: 6465 636f 7261 746f 7228 6675 6e63 293a  decorator(func):
+00021940: 0a20 2020 2020 2020 2061 7574 6f63 6173  .        autocas
+00021950: 745f 696d 706c 735b 6f70 5d20 3d20 6675  t_impls[op] = fu
+00021960: 6e63 0a20 2020 2020 2020 2072 6574 7572  nc.        retur
+00021970: 6e20 6675 6e63 0a0a 2020 2020 7265 7475  n func..    retu
+00021980: 726e 2064 6563 6f72 6174 6f72 0a0a 0a64  rn decorator...d
+00021990: 6566 206d 6179 6265 5f64 6f77 6e63 6173  ef maybe_downcas
+000219a0: 745f 746f 2864 7479 7065 2c20 6172 6773  t_to(dtype, args
+000219b0: 293a 0a20 2020 2061 6c6c 6f77 6564 5f64  ):.    allowed_d
+000219c0: 6f77 6e63 6173 745f 7479 7065 7320 3d20  owncast_types = 
+000219d0: 2864 7479 7065 732e 666c 6f61 7431 362c  (dtypes.float16,
+000219e0: 2064 7479 7065 732e 6266 6c6f 6174 3136   dtypes.bfloat16
+000219f0: 2c20 6474 7970 6573 2e66 6c6f 6174 3332  , dtypes.float32
+00021a00: 290a 0a20 2020 2064 6566 206d 6170 5f66  )..    def map_f
+00021a10: 6e28 6129 3a0a 2020 2020 2020 2020 6966  n(a):.        if
+00021a20: 2069 7369 6e73 7461 6e63 6528 612c 2054   isinstance(a, T
+00021a30: 656e 736f 7250 726f 7879 2920 616e 6420  ensorProxy) and 
+00021a40: 612e 6474 7970 6520 696e 2061 6c6c 6f77  a.dtype in allow
+00021a50: 6564 5f64 6f77 6e63 6173 745f 7479 7065  ed_downcast_type
+00021a60: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00021a70: 6574 7572 6e20 6d61 7962 655f 636f 6e76  eturn maybe_conv
+00021a80: 6572 745f 746f 5f64 7479 7065 2861 2c20  ert_to_dtype(a, 
+00021a90: 6474 7970 6529 0a20 2020 2020 2020 2072  dtype).        r
+00021aa0: 6574 7572 6e20 610a 0a20 2020 2072 6574  eturn a..    ret
+00021ab0: 7572 6e20 7472 6565 5f6d 6170 286d 6170  urn tree_map(map
+00021ac0: 5f66 6e2c 2061 7267 7329 0a0a 0a40 7265  _fn, args)...@re
+00021ad0: 6769 7374 6572 5f61 7574 6f63 6173 745f  gister_autocast_
+00021ae0: 7275 6c65 2822 746f 7263 682e 6d61 746d  rule("torch.matm
+00021af0: 756c 2229 0a40 7265 6769 7374 6572 5f61  ul").@register_a
+00021b00: 7574 6f63 6173 745f 7275 6c65 2870 7269  utocast_rule(pri
+00021b10: 6d73 2e50 7269 6d49 4473 2e4d 4154 4d55  ms.PrimIDs.MATMU
+00021b20: 4c29 0a64 6566 2061 7574 6f63 6173 745f  L).def autocast_
+00021b30: 6d61 746d 756c 5f72 756c 6528 612c 2062  matmul_rule(a, b
+00021b40: 2c20 6474 7970 6529 3a0a 2020 2020 2222  , dtype):.    ""
+00021b50: 2241 7574 6f63 6173 7420 7275 6c65 2066  "Autocast rule f
+00021b60: 6f72 206d 6174 6d75 6c22 2222 0a20 2020  or matmul""".   
+00021b70: 2072 6574 7572 6e20 7072 696d 732e 6d61   return prims.ma
+00021b80: 746d 756c 282a 286d 6179 6265 5f64 6f77  tmul(*(maybe_dow
+00021b90: 6e63 6173 745f 746f 2864 7479 7065 2c20  ncast_to(dtype, 
+00021ba0: 2861 2c20 6229 2929 290a 0a0a 4072 6567  (a, b))))...@reg
+00021bb0: 6973 7465 725f 6175 746f 6361 7374 5f72  ister_autocast_r
+00021bc0: 756c 6528 2274 6f72 6368 2e6e 6e2e 6675  ule("torch.nn.fu
+00021bd0: 6e63 7469 6f6e 616c 2e6c 696e 6561 7222  nctional.linear"
+00021be0: 290a 4072 6567 6973 7465 725f 6175 746f  ).@register_auto
+00021bf0: 6361 7374 5f72 756c 6528 7072 696d 732e  cast_rule(prims.
+00021c00: 5072 696d 4944 732e 4c49 4e45 4152 290a  PrimIDs.LINEAR).
+00021c10: 6465 6620 6175 746f 6361 7374 5f6c 696e  def autocast_lin
+00021c20: 6561 725f 7275 6c65 2861 2c20 772c 2062  ear_rule(a, w, b
+00021c30: 6961 732c 2064 7479 7065 293a 0a20 2020  ias, dtype):.   
+00021c40: 2069 6620 6269 6173 2069 7320 4e6f 6e65   if bias is None
+00021c50: 3a0a 2020 2020 2020 2020 2320 446f 6e27  :.        # Don'
+00021c60: 7420 7061 7373 2060 6269 6173 6020 746f  t pass `bias` to
+00021c70: 206d 6179 6265 5f64 6f77 6e63 6173 745f   maybe_downcast_
+00021c80: 746f 2e0a 2020 2020 2020 2020 646f 776e  to..        down
+00021c90: 6361 7374 5f61 7267 7320 3d20 6d61 7962  cast_args = mayb
+00021ca0: 655f 646f 776e 6361 7374 5f74 6f28 6474  e_downcast_to(dt
+00021cb0: 7970 652c 2028 612c 2077 2929 202b 2028  ype, (a, w)) + (
+00021cc0: 6269 6173 2c29 0a20 2020 2065 6c73 653a  bias,).    else:
+00021cd0: 0a20 2020 2020 2020 2064 6f77 6e63 6173  .        downcas
+00021ce0: 745f 6172 6773 203d 206d 6179 6265 5f64  t_args = maybe_d
+00021cf0: 6f77 6e63 6173 745f 746f 2864 7479 7065  owncast_to(dtype
+00021d00: 2c20 2861 2c20 772c 2062 6961 7329 290a  , (a, w, bias)).
+00021d10: 0a20 2020 2072 6574 7572 6e20 7072 696d  .    return prim
+00021d20: 732e 6c69 6e65 6172 282a 646f 776e 6361  s.linear(*downca
+00021d30: 7374 5f61 7267 7329 0a0a 0a40 7265 6769  st_args)...@regi
+00021d40: 7374 6572 5f61 7574 6f63 6173 745f 7275  ster_autocast_ru
+00021d50: 6c65 2822 746f 7263 682e 6e6e 2e66 756e  le("torch.nn.fun
+00021d60: 6374 696f 6e61 6c2e 7363 616c 6564 5f64  ctional.scaled_d
+00021d70: 6f74 5f70 726f 6475 6374 5f61 7474 656e  ot_product_atten
+00021d80: 7469 6f6e 2229 0a64 6566 2061 7574 6f63  tion").def autoc
+00021d90: 6173 745f 7363 616c 6564 5f64 6f74 5f70  ast_scaled_dot_p
+00021da0: 726f 6475 6374 5f61 7474 656e 7469 6f6e  roduct_attention
+00021db0: 280a 2020 2020 7175 6572 792c 0a20 2020  (.    query,.   
+00021dc0: 206b 6579 2c0a 2020 2020 7661 6c75 652c   key,.    value,
+00021dd0: 0a20 2020 2061 7474 6e5f 6d61 736b 2c0a  .    attn_mask,.
+00021de0: 2020 2020 6472 6f70 6f75 745f 702c 0a20      dropout_p,. 
+00021df0: 2020 2069 735f 6361 7573 616c 2c0a 2020     is_causal,.  
+00021e00: 2020 2a2c 0a20 2020 2064 7479 7065 2c0a    *,.    dtype,.
+00021e10: 2020 2020 7363 616c 652c 0a29 3a0a 2020      scale,.):.  
+00021e20: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
+00021e30: 6f72 6368 2069 6d70 6f72 7420 7363 616c  orch import scal
+00021e40: 6564 5f64 6f74 5f70 726f 6475 6374 5f61  ed_dot_product_a
+00021e50: 7474 656e 7469 6f6e 0a0a 2020 2020 712c  ttention..    q,
+00021e60: 206b 2c20 7620 3d20 6d61 7962 655f 646f   k, v = maybe_do
+00021e70: 776e 6361 7374 5f74 6f28 6474 7970 652c  wncast_to(dtype,
+00021e80: 2028 7175 6572 792c 206b 6579 2c20 7661   (query, key, va
+00021e90: 6c75 6529 290a 2020 2020 7265 7475 726e  lue)).    return
+00021ea0: 2073 6361 6c65 645f 646f 745f 7072 6f64   scaled_dot_prod
+00021eb0: 7563 745f 6174 7465 6e74 696f 6e28 712c  uct_attention(q,
+00021ec0: 206b 2c20 762c 2061 7474 6e5f 6d61 736b   k, v, attn_mask
+00021ed0: 2c20 6472 6f70 6f75 745f 702c 2069 735f  , dropout_p, is_
+00021ee0: 6361 7573 616c 2c20 7363 616c 653d 7363  causal, scale=sc
+00021ef0: 616c 6529 0a0a 0a64 6566 2061 7574 6f63  ale)...def autoc
+00021f00: 6173 745f 7379 6d62 6f6c 5f6d 6170 7065  ast_symbol_mappe
+00021f10: 7228 626f 756e 645f 7379 6d62 6f6c 3a20  r(bound_symbol: 
+00021f20: 426f 756e 6453 796d 626f 6c49 6e74 6572  BoundSymbolInter
+00021f30: 6661 6365 2c20 6474 7970 653a 2064 7479  face, dtype: dty
+00021f40: 7065 732e 6474 7970 6529 3a0a 2020 2020  pes.dtype):.    
+00021f50: 2222 2252 6574 7572 6e20 7468 6520 6361  """Return the ca
+00021f60: 6c6c 6162 6c65 2069 6d70 6c65 6d65 6e74  llable implement
+00021f70: 696e 6720 7468 6520 6175 746f 6361 7374  ing the autocast
+00021f80: 2072 756c 6520 666f 7220 7468 6520 7379   rule for the sy
+00021f90: 6d62 6f6c 2e0a 0a20 2020 2041 7267 733a  mbol...    Args:
+00021fa0: 0a20 2020 2020 2020 2062 6f75 6e64 5f73  .        bound_s
+00021fb0: 796d 626f 6c3a 204d 6170 7065 6420 746f  ymbol: Mapped to
+00021fc0: 2069 7473 2061 7574 6f63 6173 7420 7275   its autocast ru
+00021fd0: 6c65 2e0a 0a20 2020 2052 6574 7572 6e73  le...    Returns
+00021fe0: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
+00021ff0: 6c65 3a20 5468 6520 6361 6c6c 6162 6c65  le: The callable
+00022000: 2069 6d70 6c65 6d65 6e74 696e 6720 7468   implementing th
+00022010: 6520 6175 746f 6361 7374 2072 756c 6520  e autocast rule 
+00022020: 666f 7220 7468 6520 7379 6d62 6f6c 2e0a  for the symbol..
+00022030: 2020 2020 2222 220a 2020 2020 6175 746f      """.    auto
+00022040: 6361 7374 5f69 6d70 6c3a 2043 616c 6c61  cast_impl: Calla
+00022050: 626c 6520 7c20 4e6f 6e65 203d 2061 7574  ble | None = aut
+00022060: 6f63 6173 745f 696d 706c 732e 6765 7428  ocast_impls.get(
+00022070: 626f 756e 645f 7379 6d62 6f6c 2e73 796d  bound_symbol.sym
+00022080: 2e69 6429 0a20 2020 2072 6574 7572 6e20  .id).    return 
+00022090: 626f 756e 645f 7379 6d62 6f6c 2e73 796d  bound_symbol.sym
+000220a0: 2069 6620 6175 746f 6361 7374 5f69 6d70   if autocast_imp
+000220b0: 6c20 6973 204e 6f6e 6520 656c 7365 2070  l is None else p
+000220c0: 6172 7469 616c 2861 7574 6f63 6173 745f  artial(autocast_
+000220d0: 696d 706c 2c20 6474 7970 653d 6474 7970  impl, dtype=dtyp
+000220e0: 6529 0a0a 0a64 6566 2061 7574 6f63 6173  e)...def autocas
+000220f0: 7428 6675 6e63 3a20 4361 6c6c 6162 6c65  t(func: Callable
+00022100: 2c20 6474 7970 653a 2064 7479 7065 732e  , dtype: dtypes.
+00022110: 6474 7970 6529 3a0a 2020 2020 2222 2254  dtype):.    """T
+00022120: 7261 6e73 666f 726d 7320 6120 6675 6e63  ransforms a func
+00022130: 7469 6f6e 2074 6f20 6175 746f 6361 7374  tion to autocast
+00022140: 2063 6572 7461 696e 206f 7065 7261 7469   certain operati
+00022150: 6f6e 732e 0a0a 2020 2020 4172 6773 3a0a  ons...    Args:.
+00022160: 2020 2020 2020 2020 6675 6e63 3a20 5468          func: Th
+00022170: 6520 6675 6e63 7469 6f6e 2074 6f20 6265  e function to be
+00022180: 2074 7261 6e73 666f 726d 6564 2e0a 2020   transformed..  
+00022190: 2020 2020 2020 6474 7970 653a 2054 6865        dtype: The
+000221a0: 2064 6174 6120 7479 7065 2074 6f20 7768   data type to wh
+000221b0: 6963 6820 6172 6775 6d65 6e74 7320 6f66  ich arguments of
+000221c0: 2074 6865 2066 756e 6374 696f 6e20 6f72   the function or
+000221d0: 2073 7562 2066 756e 6374 696f 6e73 2063   sub functions c
+000221e0: 6f75 6c64 2067 6574 2063 6173 7420 6966  ould get cast if
+000221f0: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
+00022200: 7920 6172 6520 6064 7479 7065 732e 666c  y are `dtypes.fl
+00022210: 6f61 7433 3260 2e0a 0a20 2020 2052 6574  oat32`...    Ret
+00022220: 7572 6e73 3a0a 2020 2020 2020 2020 4361  urns:.        Ca
+00022230: 6c6c 6162 6c65 3a20 5468 6520 7472 616e  llable: The tran
+00022240: 7366 6f72 6d65 6420 6675 6e63 7469 6f6e  sformed function
+00022250: 0a20 2020 2022 2222 0a0a 2020 2020 6966  .    """..    if
+00022260: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+00022270: 6474 7970 652c 2064 7479 7065 732e 6474  dtype, dtypes.dt
+00022280: 7970 6529 3a0a 2020 2020 2020 2020 7261  ype):.        ra
+00022290: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+000222a0: 2260 6474 7970 6560 2069 7320 6578 7065  "`dtype` is expe
+000222b0: 6374 6564 2074 6f20 6265 2060 7468 756e  cted to be `thun
+000222c0: 6465 722e 6474 7970 652e 6474 7970 6560  der.dtype.dtype`
+000222d0: 2062 7574 207b 7479 7065 2864 7479 7065   but {type(dtype
+000222e0: 297d 2229 0a20 2020 2069 6620 6474 7970  )}").    if dtyp
+000222f0: 6520 6e6f 7420 696e 207b 6474 7970 6573  e not in {dtypes
+00022300: 2e66 6c6f 6174 3136 2c20 6474 7970 6573  .float16, dtypes
+00022310: 2e62 666c 6f61 7431 367d 3a0a 2020 2020  .bfloat16}:.    
+00022320: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00022330: 7272 6f72 2866 2260 6474 7970 6560 2069  rror(f"`dtype` i
+00022340: 7320 6578 7065 6374 6564 2074 6f20 6265  s expected to be
+00022350: 2065 6974 6865 7220 6074 6875 6e64 6572   either `thunder
+00022360: 2e66 6c6f 6174 3136 6020 6f72 2060 7468  .float16` or `th
+00022370: 756e 6465 722e 6266 6c6f 6174 3136 602c  under.bfloat16`,
+00022380: 2062 7574 207b 6474 7970 657d 2229 0a0a   but {dtype}")..
+00022390: 2020 2020 4077 7261 7073 2866 756e 6329      @wraps(func)
+000223a0: 0a20 2020 2064 6566 2077 7261 7070 6572  .    def wrapper
+000223b0: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+000223c0: 293a 0a20 2020 2020 2020 2074 7261 6365  ):.        trace
+000223d0: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
+000223e0: 6365 2829 2866 756e 632c 202a 6172 6773  ce()(func, *args
+000223f0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+00022400: 2020 2020 7265 7475 726e 2065 7661 6c5f      return eval_
+00022410: 7472 6163 6528 7472 6163 652c 202a 6172  trace(trace, *ar
+00022420: 6773 2c20 2a2a 6b77 6172 6773 2c20 7379  gs, **kwargs, sy
+00022430: 6d62 6f6c 5f6d 6170 7065 723d 7061 7274  mbol_mapper=part
+00022440: 6961 6c28 6175 746f 6361 7374 5f73 796d  ial(autocast_sym
+00022450: 626f 6c5f 6d61 7070 6572 2c20 6474 7970  bol_mapper, dtyp
+00022460: 653d 6474 7970 6529 290a 0a20 2020 2072  e=dtype))..    r
+00022470: 6574 7572 6e20 7772 6170 7065 720a       eturn wrapper.
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/utils.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/core/vjp_utils.py` & `lightning_thunder-0.2.0.dev20240428/thunder/core/vjp_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -43,23 +43,22 @@
         bsym: The bound symbol to split into forward and backward functions.
 
     Returns:
         A pair of forward and backward functions.
     """
     import thunder
     from thunder.common import _make_cache_key
-    from thunder.core.transforms import _get_gradfn, eval_trace
+    from thunder.core.transforms import _get_gradfn_and_executor, eval_trace
 
-    joint_forward_backward = _get_gradfn(bsym)
+    joint_forward_backward, executor = _get_gradfn_and_executor(bsym)
     utils.check(
         joint_forward_backward is not None,
         lambda: f"Cannot generate forward and backward functions for {bsym.sym.name}",
     )
-
-    key = (bsym.sym, subkey := _make_cache_key(bsym.args, bsym.kwargs))
+    key = (bsym.sym, executor, subkey := _make_cache_key(bsym.args, bsym.kwargs))
     cached_result = _cache.get(key, None) if subkey is not None else None
     if cached_result is not None and not getattr(joint_forward_backward, "_disable_caching", False):
         return cached_result
 
     joint_trace = thunder.trace(inline_trace=False, use_dce=False)(joint_forward_backward, *bsym.args, **bsym.kwargs)
     consumers = utils.consumers(joint_trace)
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/cudagraphs/__init__.py` & `lightning_thunder-0.2.0.dev20240428/thunder/cudagraphs/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/distributed/__init__.py` & `lightning_thunder-0.2.0.dev20240428/thunder/distributed/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/distributed/bucketing.py` & `lightning_thunder-0.2.0.dev20240428/thunder/distributed/bucketing.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/distributed/checkpoint.py` & `lightning_thunder-0.2.0.dev20240428/thunder/distributed/checkpoint.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/distributed/prims.py` & `lightning_thunder-0.2.0.dev20240428/thunder/distributed/prims.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/ddp.py` & `lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/ddp.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/fsdp.py` & `lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/fsdp.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/distributed/utils.py` & `lightning_thunder-0.2.0.dev20240428/thunder/distributed/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/examine/__init__.py` & `lightning_thunder-0.2.0.dev20240428/thunder/examine/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/examine/memory_caculation.py` & `lightning_thunder-0.2.0.dev20240428/thunder/examine/memory_caculation.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/__init__.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/apex_entropyex.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/apex_entropyex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/cudnn_layernormex.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/cudnn_layernormex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/cudnnex.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/cudnnex.py`

 * *Files 2% similar despite different names*

```diff
@@ -159,25 +159,18 @@
 
     dim_o = (b, h, s_q, d_v)
     stride_o = (h * s_q * d_v, s_q * d_v, d_v, 1)
     O.set_output(True).set_data_type(torch_to_cudnn_dtype(value.dtype)).set_dim(dim_o).set_stride(stride_o)
 
     softmax_stats.set_output(True).set_data_type(torch_to_cudnn_dtype(torch.float32))
 
-    # Validate the graph before querying the cache key
-    # Validation makes sure all missing properties are inferred and filled, as they affect cache key.
-    graph.validate()
     cache_key = graph.key()
-
     # If a built graph does not exist in cache already, make one and place it in
     if cache_key not in _cudnnex_cache:
-        graph.build_operation_graph()
-        graph.create_execution_plans([cudnn.heur_mode.A])
-        graph.check_support()
-        graph.build_plans(cudnn.build_plan_policy.HEURISTICS_CHOICE)
+        graph.build([cudnn.heur_mode.A])
 
         _cudnnex_cache[cache_key] = (
             Q,
             K,
             V,
             Attn_scale,
             Bias,
@@ -460,25 +453,18 @@
         torch_to_cudnn_dtype(query.dtype)
     )
     dK.set_output(True).set_dim(key.size).set_stride(grad_key_stride).set_data_type(torch_to_cudnn_dtype(key.dtype))
     dV.set_output(True).set_dim(value.size).set_stride(grad_value_stride).set_data_type(
         torch_to_cudnn_dtype(value.dtype)
     )
 
-    # Validate the graph before querying the cache key
-    # Validation makes sure all missing properties are inferred and filled, as they affect cache key.
-    graph.validate()
     cache_key = graph.key()
-
     # If a built graph does not exist in cache already, make one and place it in
     if cache_key not in _cudnnex_cache:
-        graph.build_operation_graph()
-        graph.create_execution_plans([cudnn.heur_mode.A])
-        graph.check_support()
-        graph.build_plans(cudnn.build_plan_policy.HEURISTICS_CHOICE)
+        graph.build([cudnn.heur_mode.A])
 
         _cudnnex_cache[cache_key] = (
             Q,
             K,
             V,
             O,
             dO,
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/data_dependent_partition.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/data_dependent_partition.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/nvfuserex.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/nvfuserex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/nvfuserex_impl.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/nvfuserex_impl.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/passes.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/passes.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/pythonex.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/pythonex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/sdpaex.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/sdpaex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/torch_autograd.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/torch_autograd.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,24 +1,25 @@
 from dataclasses import dataclass, replace
-from functools import wraps, partial
+from functools import partial, wraps
 from inspect import signature
 from typing import Any, TYPE_CHECKING
 
 import torch
 
-from thunder.core.proxies import TensorProxy, FutureTensorProxy, variableify
-from thunder.core.prims import PrimIDs
+import thunder
 import thunder.core.utils as utils
-from thunder.core.pytree import tree_flatten, tree_unflatten
-from thunder.core.transform_common import replace_redundant_inputs
-from thunder.core.trace import TraceCtx
-from thunder.core.symbol import Symbol, BoundSymbol, BoundSymbolRHS
 import thunder.distributed.prims as dist_prims
 import thunder.torch as ltorch
-import thunder
+from thunder.core.prims import PrimIDs
+
+from thunder.core.proxies import FutureTensorProxy, TensorProxy, variableify
+from thunder.core.pytree import tree_flatten, tree_unflatten
+from thunder.core.symbol import BoundSymbol, BoundSymbolRHS, Symbol
+from thunder.core.trace import TraceCtx
+from thunder.core.transform_common import replace_redundant_inputs
 
 
 class ThunderFunction(torch.autograd.Function):
     @staticmethod
     def forward(ctx, compiled_backward, saved_tensors, saved_other, flat_output, *flat_args):
         # Here we just propagate the tensors through the autograd graph
         ctx.saved_other = saved_other
@@ -50,56 +51,31 @@
         grads = ctx.compiled_backward([saved_tensors_list, ctx.saved_other], args)
 
         # Inside the compiled backward we must clear the saved_tensors_list
         assert not saved_tensors_list, "saved_tensors_list must be empty after calling compiled_backward"
         return (None, None, None, None, *grads)
 
 
-def split_forward_backward(computation_trc, compile_data, compile_stats, /, *args, **kwargs):
-    from thunder import trace
-    from thunder.executors.passes import transform_for_execution
-    from thunder.executors.passes import del_last_used
-    from thunder.core.rematerialization import rematerialize_forward_and_backward, rematerialize_all_gather
+def split_forward_backward(computation_trc: TraceCtx, compile_data, compile_stats, /, *flat_args):
+    from thunder.core.rematerialization import rematerialize_all_gather, rematerialize_forward_and_backward
     from thunder.core.transforms import forward_and_backward_from_trace
-    from thunder.cudagraphs import CUDAGraphExecutor
-    from thunder.distributed.utils import sort_waits, sort_data_parallel_syncs, sort_waits_for_zero3
     from thunder.distributed.transforms import FSDPCommBucketing
-    from thunder.core.transforms import eval_trace
-
-    # TODO: the trace->func->trace could likely be simplified (and look nicer)
-    #       we cannot use python_callable() here, see the old repos 2458
-    if not isinstance(computation_trc, TraceCtx):
-        # for the legacy codepath
-        func = computation_trc
-    else:
-
-        def func(*args):
-            return eval_trace(computation_trc, *args)
+    from thunder.distributed.utils import sort_data_parallel_syncs, sort_waits, sort_waits_for_zero3
+    from thunder.executors.passes import del_last_used, transform_for_execution
 
     utils.check(compile_data is not None, lambda: "`compile_data` is required")
-
-    def make_trace(func):
-        return partial(
-            trace(compile_data=compile_data, inline_trace=False, insert_ddp_syncs=not compile_data.using_jit), func
-        )
-
-    computation_trc.kwargs = {}
     # NOTE: This function is rather slow, so it's intended to be used
     # behind a cache.
-    ba = signature(func).bind(*args, **kwargs)
-    ba.apply_defaults()
-    args, kwargs = ba.args, ba.kwargs
-    flat_args, _ = tree_flatten((args, kwargs))
     tensor_cls = (torch.Tensor, TensorProxy)
     requires_grad_mask = tuple(isinstance(arg, tensor_cls) and arg.requires_grad for arg in flat_args)
     # If none of the inputs require gradients, raise an error
     if not any(requires_grad_mask):
         raise RuntimeError("PyTorch's Autograd interface requires at least one tensor input with requires_grad=True")
 
-    primal_trace = make_trace(func)(*args, **kwargs) if not compile_data.using_jit else computation_trc
+    primal_trace = computation_trc
     primal_trace = sort_data_parallel_syncs(primal_trace)
 
     if compile_stats is not None:
         compile_stats.last_traces.append(primal_trace)
 
     # torch.autograd.Function doesn't support non-flat outputs, the
     # grads wouldn't be propagated and backward receives None for each
@@ -193,16 +169,16 @@
     # computation with communication
     # For performance we need the wait_prim_impl nodes in the execution trace to be as far from the
     # communication ops as possible. But it causes the all_gather_prim_impl nodes gathered at the start of
     # backward trace and increases the peak allocated memory
     if getattr(compile_data.fn, "use_fsdp", False):
         assert hasattr(compile_data.fn, "sharding_strategy")
         if getattr(compile_data.fn, "sharding_strategy") == FSDPType.ZERO3:
-            from thunder.distributed.utils import limit_in_flight_allgathers
             from thunder.distributed import FSDPBucketingStrategy
+            from thunder.distributed.utils import limit_in_flight_allgathers
 
             fw_extrace = sort_waits_for_zero3(fw_extrace)
             fw_extrace = limit_in_flight_allgathers(
                 fw_extrace,
                 3,
                 compile_data.fn.bucketing_strategy != FSDPBucketingStrategy.NONE,
             )
@@ -215,15 +191,15 @@
         if getattr(compile_data.fn, "sharding_strategy") == FSDPType.ZERO2:
             fw_extrace = sort_waits(fw_extrace)
             bw_extrace = sort_waits(bw_extrace)
     if getattr(compile_data.fn, "use_ddp", False):
         bw_extrace = sort_waits(bw_extrace)
 
     # Importing here to avoid cyclical dependencies in future.
-    from thunder.executors.transformer_engineex import transformer_engine_ex, _rearrange_transformer_engine_linear
+    from thunder.executors.transformer_engineex import _rearrange_transformer_engine_linear, transformer_engine_ex
 
     if transformer_engine_ex in compile_data.executors_list:
         # NOTE: `_rearrange_transformer_engine_linear` mutates `fw_extrace`.
         _rearrange_transformer_engine_linear(fw_extrace, bw_extrace)
 
     fw_extrace = del_last_used(fw_extrace)
     fw_traces.append(fw_extrace)
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/torch_compile.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/torch_compile.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,21 +1,25 @@
+import operator
 import time
 from collections.abc import Callable, Hashable
 from typing import Any
 
 import torch
+from lightning_utilities import compare_version
 
 from thunder.core import prims, utils
 from thunder.core.proxies import Proxy, unvariableify, Variable
 from thunder.core.symbol import BoundSymbol, Symbol
 from thunder.core.trace import from_trace, TraceCtx, TraceProvenance
 
 from thunder.executors.utils import Region
 from thunder.extend import FusionExecutor, register_executor
 
+_TORCH_GREATER_EQUAL_2_3 = compare_version("torch", operator.ge, "2.3.0", use_base_version=True)
+
 
 def to_torch_translator(bsym: BoundSymbol) -> Callable:
     """Translates a BoundSymbol to a corresponding traceable by Thunder and
     executable by PyTorch callable.
 
     Args:
         bsym: The BoundSymbol to translate.
@@ -42,14 +46,15 @@
 
 
 def make_compiled(
     bsyms: list[BoundSymbol], sorted_unique_inputs: list[Proxy], sorted_unique_outputs: list[Proxy]
 ) -> Callable:
     from thunder import trace
     from thunder.core.transforms import eval_trace
+    from thunder.executors.torchex import no_autocast
 
     # Here we construct a trace that will be used to compile the function
     region_trace = TraceCtx(None)
     region_trace.bound_symbols = list(bsyms)
     region_trace.args = sorted_unique_inputs
     region_trace.kwargs = {}
     region_trace.bound_symbols.append(prims.python_return.bind(sorted_unique_outputs, output=()))
@@ -71,31 +76,33 @@
     # But there are some issues with the
     # _transform_for_operator_executor_execution implementation that need to be
     # fixed first. One issue is that it doesn't maintain the ssa form of the
     # trace, which is needed for all the passes to work correctly.
     # TODO: issue "Try using _transform_for_operator_executor_execution for
     # torch.compile executor"
     torch_trace = trace(inline_trace=False)(torch_interpreted_func, *sorted_unique_inputs)
-    compiled_func = torch.compile(torch_trace.python_callable())
+    trace_callable = torch_trace.python_callable(include_decorators=False)
+    compiled_func = torch.compile(trace_callable, fullgraph=True)
+    # For each of `@torch.no_grad(), and `torch.autocast(device_type="cpu"|"cuda")` torch.compile
+    # create caches with a guard for the wrapped function. Since the torch.compile caches are per code object, not
+    # frame, all the dynamic copies of these context managers share the same code cache.
+    # Since Thunder generates many traces, all of them annotated with these context managers, we must put these context
+    # managers outside the `torch.compile` region
+    compiled_func = no_autocast(compiled_func)
+    compiled_func = torch.no_grad()(compiled_func)
 
     def compiled_func_wrapper(*args):
-        # PyTorch 2.1 doesn't have this attribute
-        if getattr(torch._dynamo.eval_frame, "guarded_backend_cache", None) is None:
+        if _TORCH_GREATER_EQUAL_2_3:
             return compiled_func(*args)
 
         orig = getattr(torch._dynamo.eval_frame.guarded_backend_cache, "skip_backend_check_for_run_only_mode", None)
         try:
-            # TODO: Remove this hack
-            # Dynamo doesn't recreate a guard for the compiled function called
-            # from the backward thread. This is a problem because the guard is
-            # created with the forward thread ID, and the guard is not valid
-            # for the backward thread.
-            # Issue filed: https://github.com/pytorch/pytorch/issues/114674
-            # We should be able to remove this hack once we're sure that the
-            # above fix has propagated to all supported PyTorch releases.
+            # Dynamo doesn't recreate a guard for the compiled function called from the backward thread. This is a
+            # problem because the guard is created with the forward thread ID, and the guard is not valid
+            # for the backward thread. Issue filed: https://github.com/pytorch/pytorch/issues/114674
             torch._dynamo.eval_frame.guarded_backend_cache.skip_backend_check_for_run_only_mode = True
             return compiled_func(*args)
         finally:
             if orig is not None:
                 torch._dynamo.eval_frame.guarded_backend_cache.skip_backend_check_for_run_only_mode = orig
 
     return compiled_func_wrapper
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/torchex.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/torchex.py`

 * *Files 1% similar despite different names*

```diff
@@ -141,24 +141,18 @@
 _register_implementation(ltorch.to, checker=_always_executable, execution_transform=_to_transform)
 
 #
 # Disable torch.autocast operations
 #
 
 
-class no_autocast(ContextDecorator):
-    def __enter__(self, *args, **kwargs):
-        self.was_cuda_enabled = torch.is_autocast_enabled()
-        self.was_cpu_enabled = torch.is_autocast_cpu_enabled()
-        torch.set_autocast_enabled(False)
-        torch.set_autocast_cpu_enabled(False)
-
-    def __exit__(self, exc_type, exc_value, exc_traceback):
-        torch.set_autocast_enabled(self.was_cuda_enabled)
-        torch.set_autocast_cpu_enabled(self.was_cpu_enabled)
+def no_autocast(fn):
+    fn = torch.autocast(device_type="cpu", enabled=False, cache_enabled=False)(fn)
+    fn = torch.autocast(device_type="cuda", enabled=False, cache_enabled=False)(fn)
+    return fn
 
 
 #
 # Tensor creation operations
 #
 arange = _register_torch_operation("arange")
 full = _register_torch_operation("full")
@@ -1101,14 +1095,15 @@
 _register_implementation(ltorch.argmin, argmin, checker=_always_executable)
 _register_implementation(ltorch.topk, topk, checker=_always_executable, execution_transform=_topk_transform)
 
 #
 # Scatter and gather operations
 #
 
+gather = _register_torch_operation("gather")
 index_add = _register_torch_operation("index_add")
 index_put = _register_torch_operation("index_put")
 scatter_add = _register_torch_operation("scatter_add")
 index_select = _register_torch_operation("index_select")
 take_along_dim = _register_torch_operation("take_along_dim")
 
 
@@ -1119,14 +1114,24 @@
 
 def _index_put_prim_transform(
     a: TensorLike, /, indices: Sequence[TensorLike], values: TensorLike, accumulate: bool = False
 ) -> TensorLike:
     return index_put(a, indices, values, accumulate)
 
 
+@langctx(Languages.TORCH)
+def _gather_prim_transform(a: TensorProxy, /, index: TensorProxy, dim: int) -> TensorProxy:
+    return gather(a, dim, index)
+
+
+@langctx(Languages.TORCH)
+def _gather_transform(a: TensorLike, /, dim: int, index: TensorLike) -> TensorLike:
+    return gather(a, dim, index)
+
+
 # NOTE torch.compile has a compilation issue with scatter add in bfloat16,
 #      hence the special case here.
 # NOTE The scatter add transforms must set the torch language context explicitly so the .to() method
 #   on tensors is resolved (alternatively they could explicitly call thunder.torch.to)
 @langctx(Languages.TORCH)
 def _scatter_add_prim_transform(a: TensorProxy, /, index: TensorProxy, value: TensorProxy, dim: int) -> TensorProxy:
     if a.dtype == dtypes.bfloat16:
@@ -1154,22 +1159,24 @@
     return index_select(a, dim, index)
 
 
 def _take_along_axis_prim_transform(a: TensorProxy, /, index: TensorProxy, dim: int) -> TensorProxy:
     return take_along_dim(a, index, dim)
 
 
+_register_implementation(prims.gather, checker=_always_executable, execution_transform=_gather_prim_transform)
 _register_implementation(prims.index_add, checker=_always_executable, execution_transform=_index_add_prim_transform)
 _register_implementation(prims.index_put, checker=_always_executable, execution_transform=_index_put_prim_transform)
 _register_implementation(prims.scatter_add, checker=_always_executable, execution_transform=_scatter_add_prim_transform)
 _register_implementation(prims.take, checker=_always_executable, execution_transform=_take_prim_transform)
 _register_implementation(
     prims.take_along_axis, checker=_always_executable, execution_transform=_take_along_axis_prim_transform
 )
 
+_register_implementation(ltorch.gather, checker=_always_executable, execution_transform=_gather_transform)
 _register_implementation(ltorch.index_add, index_add, checker=_always_executable)
 _register_implementation(ltorch.index_put, index_put, checker=_always_executable)
 _register_implementation(ltorch.index_select, index_select, checker=_always_executable)
 _register_implementation(ltorch.scatter_add, checker=_always_executable, execution_transform=_scatter_add_transform)
 _register_implementation(ltorch.take_along_dim, take_along_dim, checker=_always_executable)
 
 
@@ -1200,14 +1207,15 @@
 #
 
 bmm = _register_torch_operation("bmm")
 convolution = _register_torch_operation("convolution")
 conv1d = _register_torch_operation("conv1d", module=torch.nn.functional)
 conv2d = _register_torch_operation("conv2d", module=torch.nn.functional)
 conv3d = _register_torch_operation("conv3d", module=torch.nn.functional)
+mse_loss = _register_torch_operation("mse_loss", module=torch.nn.functional)
 cross_entropy = _register_torch_operation("cross_entropy", module=torch.nn.functional)
 dropout = _register_torch_operation("dropout", module=torch.nn.functional)
 embedding = _register_torch_operation("embedding", module=torch.nn.functional)
 embedding_backward = _register_torch_operation("torch.ops.aten.embedding_backward", like=ltorch.embedding_backward)
 one_hot = _register_torch_operation("one_hot", module=torch.nn.functional)
 group_norm = _register_torch_operation("group_norm", module=torch.nn.functional)
 interpolate = _register_torch_operation("interpolate", module=torch.nn.functional)
@@ -1536,14 +1544,15 @@
 _register_implementation(prims.linear, linear, checker=_always_executable)
 
 _register_implementation(ltorch.bmm, bmm, checker=_always_executable)
 _register_implementation(ltorch.convolution, checker=_always_executable, execution_transform=_convolution_transform)
 _register_implementation(ltorch.conv1d, conv1d, checker=_always_executable)
 _register_implementation(ltorch.conv2d, conv2d, checker=_always_executable)
 _register_implementation(ltorch.conv3d, conv3d, checker=_always_executable)
+_register_implementation(ltorch.mse_loss, mse_loss, checker=_always_executable)
 _register_implementation(ltorch.cross_entropy, cross_entropy, checker=_always_executable)
 cross_entropy_backward = ex.register_operator(
     "torch_cross_entropy_backward_impl", meta=ltorch.cross_entropy_backward, fn=_cross_entropy_backward_impl
 )
 _register_implementation(ltorch.cross_entropy_backward, cross_entropy_backward, checker=_always_executable)
 _register_implementation(ltorch.dropout, dropout, checker=_always_executable)
 _register_implementation(ltorch.embedding, embedding, checker=_always_executable)
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/transformer_engineex.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/transformer_engineex.py`

 * *Files 9% similar despite different names*

```diff
@@ -33,14 +33,15 @@
 
 # We rely on internal details of TransformerEngine like `_Linear` autograd.Function.
 # As these details are not public, they can change
 # Ex. addition of a positional argument for cpu_offloading (not as the last argument)
 # between version 1.2 and 1.3.
 # Hence, we have these guards based on version.
 TE_VERSION_1_3_PLUS: bool = False
+TE_VERSION_1_6_PLUS: bool = False
 
 te: None | Any = None
 if TE_AVAILABLE:
     try:
         import transformer_engine.pytorch as te
         from transformer_engine.common import recipe
         from transformer_engine.pytorch.module.linear import _Linear
@@ -48,14 +49,15 @@
         from transformer_engine.pytorch.fp8 import FP8GlobalStateManager
         from transformer_engine.pytorch.utils import check_dim_for_fp8_exec
     except Exception as ex:
         warnings.warn(f"transformer_engine failed to import with exception {ex}")
         TE_AVAILABLE = False
 
     TE_VERSION_1_3_PLUS = LooseVersion(version("transformer_engine")) >= LooseVersion("1.3")
+    TE_VERSION_1_6_PLUS = LooseVersion(version("transformer_engine")) > LooseVersion("1.6")
 if not TE_AVAILABLE:
     TransformerEngineBaseModule = object
 
 # [NOTE] IMPLEMENTATION DETAILS
 #
 # We try to re-use TransformerEngine implementation of `Linear` and `_Linear` as much as possible.
 # As `thunder` expects operator to be passed all of its inputs, we have `TELinear` module which doesn't
@@ -76,15 +78,15 @@
 #   out = torch.nn.functional.linear(a, b)
 #   out = torch.nn.functional.linear(out, d)
 #   return out
 #
 # Traced Program:
 #
 # @torch.no_grad()
-# @no_autocast()
+# @no_autocast
 # @transformer_engine.fp8_autocast(fp8_recipe=te_fp8_recipe)
 # def func(a, b, d):
 #   # a: "cuda:0 bf16[16, 32]"
 #   # b: "cuda:0 bf16[64, 32]"
 #   # d: "cuda:0 bf16[32, 64]"
 #   (t0, _) = te_linear_0(a, b, None, is_grad_enabled=False)  # Backed by it's own instance of TELinear
 #   del a, b
@@ -127,23 +129,33 @@
             "is_first_microbatch": self.is_first_microbatch,
             "use_bias": self.use_bias,
             "sequence_parallel": self.sequence_parallel,
             "tensor_parallel": self.tensor_parallel,
             "inp_shape": self.inp_shape,
             "parallel_mode": self.parallel_mode,
             "tp_group": self.tp_group,
-            "ub_split_ag": self.ub_split_ag,
-            "ub_atomic_gemm_ag": self.ub_atomic_gemm_ag,
             "ub_name": self.ub_name,
             "tp_size": self.tp_size,
             "requires_dgrad": self.requires_dgrad,
         }
 
         if TE_VERSION_1_3_PLUS:
             ctx_dict["cpu_offloading"] = self.cpu_offloading
+        if TE_VERSION_1_6_PLUS:
+            ctx_dict["primary_weights_in_fp8"] = self.primary_weights_in_fp8
+            ctx_dict["is_input_fp8"] = self.is_input_fp8
+            ctx_dict["reduce_and_update_bwd_fp8_tensors"] = self.reduce_and_update_bwd_fp8_tensors
+            ctx_dict["ub_overlap_ag"] = self.ub_overlap_ag
+        else:
+            ctx_dict.update(
+                {
+                    "ub_split_ag": self.ub_split_ag,
+                    "ub_atomic_gemm_ag": self.ub_atomic_gemm_ag,
+                }
+            )
         return ctx_dict
 
     @staticmethod
     def from_dict(d):
         ctx = Context()
         ctx.saved_tensors = d["saved_tensors"]
         ctx.activation_dtype = d["activation_dtype"]
@@ -153,21 +165,27 @@
         ctx.is_first_microbatch = d["is_first_microbatch"]
         ctx.use_bias = d["use_bias"]
         ctx.sequence_parallel = d["sequence_parallel"]
         ctx.tensor_parallel = d["tensor_parallel"]
         ctx.inp_shape = d["inp_shape"]
         ctx.parallel_mode = d["parallel_mode"]
         ctx.tp_group = d["tp_group"]
-        ctx.ub_split_ag = d["ub_split_ag"]
-        ctx.ub_atomic_gemm_ag = d["ub_atomic_gemm_ag"]
         ctx.ub_name = d["ub_name"]
         ctx.tp_size = d["tp_size"]
         ctx.requires_dgrad = d["requires_dgrad"]
         if TE_VERSION_1_3_PLUS:
             ctx.cpu_offloading = d["cpu_offloading"]
+        if TE_VERSION_1_6_PLUS:
+            ctx.primary_weights_in_fp8 = d["primary_weights_in_fp8"]
+            ctx.is_input_fp8 = d["is_input_fp8"]
+            ctx.reduce_and_update_bwd_fp8_tensors = d["reduce_and_update_bwd_fp8_tensors"]
+            ctx.ub_overlap_ag = d["ub_overlap_ag"]
+        else:
+            ctx.ub_split_ag = d["ub_split_ag"]
+            ctx.ub_atomic_gemm_ag = d["ub_atomic_gemm_ag"]
         return ctx
 
 
 # Eagerly apply map without
 # storing the output.
 def eager_map(*args):
     return deque(map(*args), maxlen=0)
@@ -217,46 +235,76 @@
 
             ctx = Context() if is_grad_enabled else None
 
             CPUOffloadEnabled: None | bool = None
             if TE_VERSION_1_3_PLUS:
                 from transformer_engine.pytorch.cpu_offload import CPUOffloadEnabled
 
-            # Currently we support only non-distributed case.
+            import inspect
+
+            params = inspect.signature(_Linear.forward).parameters
+
+            # Currently we do not support `tp` meaning tensor model parallel case.
             # We hard-code the arguments related to distributed for now.
-            args = (
-                ctx,
-                weight,
-                weight1_fp8,
-                weight1_t_fp8,
-                inp,
-                torch.Tensor() if bias is None else bias,  # bias_tensor
-                bias is not None,
-                None,  # is_first_microbatch
-                self.fp8,
-                self.fp8_calibration,
-                self.fp8_meta,
-                *((CPUOffloadEnabled,) if TE_VERSION_1_3_PLUS else ()),
-                False,  # fuse_wgrad_accumulation
-                None,  # tp_group
-                1,  # tp_size
-                self.sequence_parallel,
-                False,  # tp_size > 1
-                inp.dtype,
-                None,  # parallel_mode
-                is_grad_enabled,
-                False,  # primary_weights_in_fp8
-                False,  # ub_split_rs
-                False,  # ub_split_ag
-                False,  # ub_atomic_gemm_rs
-                False,  # ub_atomic_gemm_ag
-                None,  # ub_name
-            )
+            use_bias = bias is not None
+            kwargs = {
+                "ctx": ctx,
+                "weight": weight,
+                "weight_fp8": weight1_fp8,
+                "weight_t_fp8": weight1_t_fp8,
+                "inp": inp,
+                "bias": torch.tensor([]) if not use_bias else bias,
+                "use_bias": bias is not None,
+                "is_first_microbatch": None,
+                "fp8": self.fp8,
+                "fp8_calibration": self.fp8_calibration,
+                "fp8_meta": self.fp8_meta,
+                "fuse_wgrad_accumulation": False,
+                "tp_group": None,
+                "tp_size": 1,
+                "sequence_parallel": self.sequence_parallel,
+                "tensor_parallel": False,
+                "activation_dtype": inp.dtype,
+                "parallel_mode": None,
+                "is_grad_enabled": is_grad_enabled,
+                "primary_weights_in_fp8": False,
+                "ub_name": None,
+            }
+            if TE_VERSION_1_3_PLUS:
+                kwargs["cpu_offloading"] = CPUOffloadEnabled
+            if TE_VERSION_1_6_PLUS:
+                kwargs.update(
+                    {
+                        # ref: https://github.com/NVIDIA/TransformerEngine/blame/7c1828f80edc1405d4ef1a7780c9e0046beab5c7/transformer_engine/pytorch/module/linear.py#L70
+                        "skip_fp8_weight_update": None,
+                        # ref: https://github.com/NVIDIA/TransformerEngine/blame/7c1828f80edc1405d4ef1a7780c9e0046beab5c7/transformer_engine/pytorch/module/linear.py#L84-L85
+                        "ub_overlap_rs": False,
+                        "ub_overlap_ag": False,
+                    }
+                )
+            else:
+                kwargs.update(
+                    {
+                        "ub_split_rs": False,
+                        "ub_split_ag": False,
+                        "ub_atomic_gemm_rs": False,
+                        "ub_atomic_gemm_ag": False,
+                    }
+                )
+
+            # Optimistic key value insertion for the sake of compatibility with main branch
+            for param_name in params:
+                if param_name not in kwargs:
+                    param = params[param_name]
+                    if param.default is not param.empty:
+                        kwargs[param_name] = param.default
+                    else:
+                        kwargs[param_name] = None
 
-            out = _Linear.forward(*args)
+            out = _Linear.forward(**kwargs)
             ctx_dict = ctx.to_dict() if is_grad_enabled else None
             return out, ctx_dict
 
     def get_fp8_weights_scratchpad(
         self,
         is_first_microbatch: bool | None,
     ) -> list["Float8Tensor"]:
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/triton_crossentropy_impl.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/triton_crossentropy_impl.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/executors/utils.py` & `lightning_thunder-0.2.0.dev20240428/thunder/executors/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/extend/__init__.py` & `lightning_thunder-0.2.0.dev20240428/thunder/extend/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/functional.py` & `lightning_thunder-0.2.0.dev20240428/thunder/functional.py`

 * *Files 1% similar despite different names*

```diff
@@ -415,33 +415,35 @@
     computation_trc._siginfo = csi
     computation_trc.args = computation_args
 
     return TraceResults(prologue_trc, computation_trc, None, interpreter_log)
 
 
 # Translates the Python function a thunder program using the Python interpreter
-def _python_interpreter(fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS) -> TraceResults:
+def _python_interpreter(
+    fn: Callable, args, kwargs, /, *, record_history: bool = False, sharp_edges: SHARP_EDGES_OPTIONS
+) -> TraceResults:
     if sharp_edges is not SHARP_EDGES_OPTIONS.ALLOW:
         raise ValueError(
-            f"Detecting sharp edges is not supported when using the Python interpreter. To detect sharp edges use another interpretation option."
+            "Detecting sharp edges is not supported when using the Python interpreter. To detect sharp edges use another interpretation option."
         )
 
     def _interpreter(fn_):
         return fn_
 
     return _eager_unpacking_interpreter(_interpreter, fn, args, kwargs, interpreter_name="Python")
 
 
 # Translates the Python function to a thunder program using the thunder interpreter
 def _translate_functions_interpreter(
-    fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS
+    fn: Callable, args, kwargs, /, *, record_history: bool = False, sharp_edges: SHARP_EDGES_OPTIONS
 ) -> TraceResults:
     from thunder.core.jit_ext import minimal_thunder_jit
 
-    pjit = partial(minimal_thunder_jit, sharp_edges=sharp_edges)
+    pjit = partial(minimal_thunder_jit, sharp_edges=sharp_edges, record_history=record_history)
     return _eager_unpacking_interpreter(pjit, fn, args, kwargs, interpreter_name="translate functions")
 
 
 # note: keep this roughly in sync with thunder.jit
 def jit(
     fn: Callable,
     /,
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/numpy/__init__.py` & `lightning_thunder-0.2.0.dev20240428/thunder/numpy/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/numpy/langctx.py` & `lightning_thunder-0.2.0.dev20240428/thunder/numpy/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/torch/__init__.py` & `lightning_thunder-0.2.0.dev20240428/thunder/torch/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -1585,14 +1585,79 @@
         isinstance(a, (Number, TensorProxy)) and isinstance(b, (Number, TensorProxy)),
         lambda: f"torch.where() does not support only specifying a condition",
         exception_type=NotImplementedError,
     )
     return clang.where(pred, a, b)
 
 
+@torchsymbol(torch.nan_to_num, is_method=True)
+def nan_to_num(
+    a: TensorLike,
+    nan: None | Number = 0.0,
+    posinf: None | Number = None,
+    neginf: None | Number = None,
+    /,
+    out: None | TensorLike = None,
+) -> TensorLike:
+    """Replaces NaN, positive infinity, and negative infinity values in input tensor with values specified by nan, posinf, and neginf.
+        When nan, posinf, and neginf values are greater than the a.dtype's max value, it is replaced with float("inf").
+        If they are smaller than the a.dtype's min value, it is replaced with -float("inf").
+        Otherwise, they are replaced with the exact values specified by nan, posinf, and neginf.
+
+    Args:
+        a (Tensor): input tensor
+        nan (Number): value to replace NaNs with. Default is zero
+        posinf (Number): value to replace positive infinity. If None, positive infinity values are replaced with the greatest finite value represented by a's type
+        neginf (Number): value to replace negative infinity. If None, negative infinity values are replaced with the lowest finite value represented by a's type
+        out (Tensor): output tensor which is not supported yet
+
+    Returns:
+        result (Tensor): tensor with replaced values
+
+    Examples:
+        >>> a = torch.tensor((float("nan"), float("inf"), -float("inf"))) # a.dtype is torch.float32
+        >>> nan = torch.finfo(torch.float64).max
+        >>> result = torch.nan_to_num(a, nan=nan, posinf=1, neginf=0)
+        >>> result
+        tensor([inf, 1., 0.])
+    """
+
+    utils.check(out is None, lambda: "out is not None which is currently unsupported", NotImplementedError)
+
+    if dtypes.is_boolean_dtype(a.dtype):
+        # NOTE PyTorch returns a.clone()
+        return a | a
+
+    if dtypes.is_integer_dtype(a.dtype):
+        # NOTE PyTorch returns a.clone()
+        return a - 0
+
+    a_dtype_max = torch.finfo(to_torch_dtype(a.dtype)).max
+    a_dtype_min = torch.finfo(to_torch_dtype(a.dtype)).min
+    inf = float("inf")
+
+    def convert(x, if_none):
+        if x is None:
+            return if_none
+        if x > a_dtype_max:
+            return inf
+        if x < a_dtype_min:
+            return -inf
+        return x
+
+    nan = convert(nan, 0)
+    posinf = convert(posinf, a_dtype_max)
+    neginf = convert(neginf, a_dtype_min)
+
+    result = where(a != a, nan, a)
+    result = where(a == -inf, neginf, result)
+    result = where(a == inf, posinf, result)
+    return result
+
+
 #
 # Reduction operations
 #
 
 
 class REDUCTION_OUTPUT_TYPE_KIND(Enum):
     SAME = (0,)
@@ -1896,14 +1961,19 @@
 
 
 @torchsymbol(torch.index_select, is_method=True)
 def index_select(a: TensorLike, /, dim: int, index: TensorLike) -> TensorLike:
     return clang.take(a, index, dim)
 
 
+@torchsymbol(torch.gather)
+def gather(a: TensorLike, /, dim: int, index: TensorLike) -> TensorLike:
+    return clang.gather(a, indices=index, dim=dim)
+
+
 # NOTE PyTorch's scatter_add has a parameter named 'src', not 'source'
 @torchsymbol(torch.scatter_add)
 def scatter_add(a: TensorLike, /, dim: int, index: TensorLike, src: TensorLike) -> TensorLike:
     return clang.scatter_add(a, indices=index, value=src, dim=dim)
 
 
 @torchsymbol(torch.take_along_dim)
@@ -3903,14 +3973,55 @@
     reduction: str,
     ignore_index: int,
     total_weight: TensorLike,
 ) -> TensorLike:
     return TensorProxy(like=g, shape=a.shape)
 
 
+@torchsymbol(torch.nn.functional.mse_loss)
+def mse_loss(
+    a: TensorLike,
+    /,
+    target: TensorLike,
+    size_average: None | Any = None,
+    reduce: None | Any = None,
+    reduction: str = "mean",
+) -> TensorLike:
+    utils.check(
+        size_average is None and reduce is None,
+        lambda: f"Deprecated size_average={size_average} and reduce={reduce} is not supported!",
+    )
+    utils.check(
+        reduction in ("none", "sum", "mean"),
+        lambda: f'Expected reduction string to be "none", "sum", or "mean", but it is {reduction}.',
+        exception_type=ValueError,
+    )
+
+    # warn broadcasting
+    if a.size() != target.size():
+        warnings.warn(
+            f"Using a target size {target.size()} that is different to the input size {a.size()}"
+            "This will likely lead to incorrect results due to broadcasting."
+            "Please ensure they have the same size."
+        )
+    out = (a - target) ** 2
+
+    # maybe add _apply_loss_reduction
+    # (like https://github.com/pytorch/pytorch/blob/df5829d0babaefc6e271897d6fffd40073d8b723/torch/_refs/nn/functional/__init__.py#L490)
+    # not sure if this would be useful
+    if reduction == "none":
+        return out
+    elif reduction == "sum":
+        return sum(out)
+    elif reduction == "mean":
+        return mean(out)
+    else:
+        raise ValueError(f"Reduction argument {reduction} to mse_loss is not supported")
+
+
 # TODO Add annotations
 # NOTE The scale parameter is kwarg-only in PyTorch
 @torchsymbol(torch.nn.functional.scaled_dot_product_attention)
 def scaled_dot_product_attention(query, key, value, attn_mask=None, dropout_p=0.0, is_causal=False, *, scale=None):
     for arg_name, arg in zip(("query", "key", "value"), (query, key, value)):
         utils.check(
             dtypes.is_float_dtype(arg.dtype),
```

### Comparing `lightning_thunder-0.2.0.dev20240421/thunder/torch/langctx.py` & `lightning_thunder-0.2.0.dev20240428/thunder/torch/langctx.py`

 * *Files identical despite different names*

